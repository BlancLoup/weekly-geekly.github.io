<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross-domain queries in Opera UserJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unlike the Greasemonkey extension in Mozilla, Opera does not provide an analogue of the GM_xmlhttpRequest function for cross-domain requests (XDR). Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross-domain queries in Opera UserJS</h1><div class="post__text post__text-html js-mediator-article">  Unlike the Greasemonkey extension in Mozilla, Opera does not provide an analogue of the GM_xmlhttpRequest function for cross-domain requests (XDR).  This, of course, severely limits the capabilities and scope of UserJS.  Using XDR, for example, you can implement an Last.fm scrobbler for various online music players (such as vkontakte.ru or MySpace). <br><br>  However, cross-domain queries can be made to work in Opera with tricks with iframes and window.name transport.  Under the cut, I'll show you how to do it and present a simple library that implements all witchcraft. <br><a name="habracut"></a><br>  Generally speaking, the following techniques are used for cross-domain queries: <br><ul><li>  Proxy requests.  If we own a server whose pages want to access a remote web service, you can implement a script on our server that proxies requests to it.  Thus, on the client side, the requests will look like an appeal to your domain, and in fact, the results of the query on the remote server will be returned. <br>  The disadvantages of this approach, in addition to the need to control the server on the requesting domain, include the load on the incoming channel of our server and the possibility of banning our proxy by IP.  In addition, user data passes through our server, so the end user must trust us. </li><li>  Requests via Flash.  In the case when we own a server that provides a web service, we can place an XML policy file on it, allowing their XDR from some domains.  Cons: control of the web service is required, Flash is required. </li><li> The use of various kinds of substitutes for asynchronous requests, such as the dynamic generation of <code>script</code> elements.  Required control over the web service.  In addition, a more or less serious change in its code is required to return the correct javascript. </li><li>  Use <a href="http://www.w3.org/TR/access-control/">Cross-Origin Resource Sharing</a> .  Again, control of the web service is required, and in addition this specification, as far as I know, is not supported anywhere else. </li></ul><br><br>  If anyone is interested, someday I will write in detail about these classical approaches.  But they are already written in many places. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When writing UserJS, in general, we do not have access to either the server, on the page of which the script is launched, or to the web service.  Therefore, we cannot use any of the above techniques in their pure form.  But there is a way to overcome these limitations. <br><br><h4>  The essence of the method </h4><br>  It would seem that everything is simple: the request is made from iframe from the domain of the web service, and the main page with the frame communicates using the window.name transport.  Recall that the window.name property, once set, retains its value when traveling through a window across a domain. <br><br>  Now more.  So, suppose we write UserJS for <code>domain.ru</code> , which wants to make an asynchronous request to a web service on the <code>ws.org</code> domain.  Requests to the web service will be sent to the UserJS running in the iframe for a document from the <code>ws.org</code> domain (say, <code>ws.org/dummy.gif</code> : which particular URL is not important).  And in order to pass the request arguments, it is necessary in advance, before the page opens from the remote domain, to set <code>window.name</code> on the frame in the string containing these parameters.  Thus, the UserJS on ws.org will receive the request arguments from its window.name and send the necessary XMLHttpRequest to <code>ws.org</code> .  It is already possible for him: a request within the ws.org domain.  Then the result of execution is thrust again into the <code>window.name</code> frame, and the frame will be redirected to any page on <code>domain.ru</code> (for example, <code>domain.ru/dummy2.gif</code> ), where UserJS is running again, which starts the result result handler in the main window. <br>  Of course, you need to choose <code>dummy.gif</code> documents and <code>dummy2.gif</code> , which have the correct caching headers, because every request passes through them. <br><br>  On the diagram, it looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/b68/c05/d57/b68c05d57de21de51d07ecb7f78265c0.png" alt="uml"><br><br>  By the way, it is necessary to remember that each browser window (and iframe is a window) executes a separate javascript stream.  To run the handler in the context of the main window's thread, you can use something like the <code>window.parent.setTimeout(parent.handler, 0)</code> construct.  The point, I think, is clear. <br><br><h4>  Application </h4><br>  I implemented this method as a self-made library to make <a href="http://nichtverstehen.de/vkontakte-scrobbler/">last.fm scrobbler for vkontakte.ru</a> . <br><br>  Implementation can be viewed <a href="http://pastebin.com/f1d71b18b">on pastebin</a> .  On line 58 was a pastebin's glitch glitch, so I commented out it.  It, of course, must be uncommented when used. <br><br>  All the work is done by the object <code>Requester</code> .  <code>Requester.request</code> sends the request.  He needs to pass the address of the web service page, on which the request will subsequently be executed, and the address on his domain (that is, <code>dummy.gif</code> and <code>dummy2.gif</code> from the example).  The <code>request</code> method creates an iframe, passes the parameters, and translates the iframe to <code>dummy.gif</code> .  It returns the Deferred-object, on which you can attach callback and errback (errback will be called upon timeout).  UserJS at <code>ws.org/dummy.gif</code> can get passed parameters from <code>Requester.getArguments()</code> and return data using <code>Requester.returnData()</code> .  With token, <code>Requester</code> verifies that the data is meant for it.  That is, if there is a possibility of several scripts on one web service, you should change the token to any other. <br><br>  A working script using <code>Requester</code> is <a href="http://nichtverstehen.de/vkontakte-scrobbler/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/55825/">https://habr.com/ru/post/55825/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../55820/index.html">Validation email</a></li>
<li><a href="../55821/index.html">SSD driver, or Acer Aspire One no longer brake</a></li>
<li><a href="../55822/index.html">Is PEAR a current development tool?</a></li>
<li><a href="../55823/index.html">‚ÄúNew version of QIP‚Äù - what to do when it is very itchy and there is a good base for spam?</a></li>
<li><a href="../55824/index.html">Interesting social services</a></li>
<li><a href="../55826/index.html">Students practical training</a></li>
<li><a href="../55828/index.html">Time broke in Safari</a></li>
<li><a href="../55830/index.html">Railways: Pleasant surprises ...</a></li>
<li><a href="../55831/index.html">New service for notification of your personal status-Tag For Me</a></li>
<li><a href="../55832/index.html">Do they steal passwords from google mail?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>