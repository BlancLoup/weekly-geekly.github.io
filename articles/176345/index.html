<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Globals MUMPS: Extreme Database Programming. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Start see part 1 , part 2 . 

 Secondary indexes 

 In relational databases, secondary indexes are usually set when defining tables, or after using AL...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Globals MUMPS: Extreme Database Programming. Part 3</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/44f/b25/36d/44fb2536d87f7a03e14c4db90a008a21.jpg" alt="  (Rob Tweed)" title="Rob Tweed (Rob Tweed)" align="left"><br>  Start see <a href="https://habr.com/post/175659/">part 1</a> , <a href="https://habr.com/post/176305/">part 2</a> . <br><br>  <b>Secondary indexes</b> <br><br>  In relational databases, secondary indexes are usually set when defining tables, or after using ALTER TABLE.  If an index is defined, then it is automatically created, and then maintained and recalculated by the database when the data changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In MUMPS, indexes are served explicitly by the programmer, for example, in the table update function. <br><a name="habracut"></a><br>  Due to the hierarchical nature of the MUMPS storage, the primary index field is used as a key. <br><br>  For example, consider the MUMPS function for adding a new line to the ORDER: <br><pre><code class="bash hljs">setOrder(orderNo,data) ; new rec,itemNo,ok <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 ;     <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-variable"><span class="hljs-variable">$Order</span></span>(^ITEM(orderNo,itemNo)) Quit:itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$getItem</span></span>(orderNo,itemNo,.itemData) . Set data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)+itemData(<span class="hljs-string"><span class="hljs-string">"price"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"orderDate"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=rec_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDER(orderNo)=rec Quit 1</code> </pre> <br><br>  Note the code to calculate the total cost of the order.  We go through all the records from ITEM for a specific order number orderNo and use the $$ getItem () function to get the cost of each item.  The $$ getItem () function code is: <br><br><pre> <code class="bash hljs">getItem(orderNo,itemNo,itemData) <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> itemData s itemData(<span class="hljs-string"><span class="hljs-string">"price"</span></span>)=0 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'$data(^ITEM(orderNo,itemNo)) Quit 0 set itemData("price")=^ITEM(orderNo,itemNo) Quit 1</span></span></code> </pre><br><br>  Look at the deadline that checks for the existence of an item in the global for a specific order number and item number.  It uses the MUMPS function $ data and the negation operator single quote `. <br><br>  Let's add an index for quick access to each customer's purchases. <br><br>  To store the index, create a new global ^ ORDERX1.  We will keep a pair of keys in the global: customer number (custNo) and order number (orderNo). <br><br>  To make the index (custNo, orderNo) expand the function setOrder as follows: <br><br><pre> <code class="bash hljs">setOrder(orderNo,data) ; new rec,itemNo,ok <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 ;    <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-variable"><span class="hljs-variable">$Order</span></span>(^ITEM(orderNo,itemNo)) Quit:itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$getItem</span></span>(orderNo,itemNo,.itemData) . Set data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)+itemData(<span class="hljs-string"><span class="hljs-string">"price"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"orderDate"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=rec_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDER(orderNo)=rec <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)`=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDERX1(data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>),orderNo)=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 1</code> </pre><br><br>  To create an order, we will use this function as follows: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=21 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> data <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)=101 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"orderDate"</span></span>)=<span class="hljs-string"><span class="hljs-string">"4/5/2003"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>)=<span class="hljs-string"><span class="hljs-string">"4/7/2003"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$setOrder</span></span>(orderNo,.data)</code> </pre><br><br>  <b>Referential integrity</b> <br><br>  Maintaining referential integrity seems to be the most well-known thing of all referential actions in databases. <br>  Reference actions include all actions that need to be performed on the same tables due to the fact that some other tables have changed. <br><br>  The process of maintaining referential integrity is responsible for maintaining the semantic (in the original - semantic) integrity between related tables.  In particular, this is related to maintaining relationships between tables based on NATURAL JOIN (different tables have columns that store values ‚Äã‚Äãof the same type, according to which the relationship between tables is built) or primary / foreign keys. <br><br>  For example, when the customer number CUSTOMER.custNo is changed or deleted, in order to maintain the semantic integrity between the customer table and the order table, the corresponding change of the ORDER.custNo field should be made. <br><br>  Similarly, when the order number ORDER.orderNo changes (or is deleted), in order to maintain the semantic integrity between the order table and the things table (of which the orders consist), the corresponding change must be made with the ITEM.orderNo field. <br><br>  In relational databases (RDBMS), integrity rules are specified when creating tables using primary and foreign keys.  In MUMPS, these rules can be implemented right inside our functions. <br><br>  Bearing in mind the relationship between customer tables and their orders, the update operation CUSTOMER will be: <br><br>  <b>SQL</b> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> CUSTOMER A <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> custNo = :newCustNo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> A.custNo = :oldCustNo</code> </pre><br>  As a result of the query, the corresponding entries in the ORDER table will be updated (by the link CUSTOMER.custNo = ORDER.custNo), if the corresponding foreign keys were correctly specified when defining the database structure. <br><br>  <b>MUMPS</b> <br><br><pre> <code class="bash hljs">updateCustomer(oldCustNo,newCustNo,newData) ; new result,orderData,orderNo <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldCustNo=<span class="hljs-string"><span class="hljs-string">""</span></span>)!(newCustNo=<span class="hljs-string"><span class="hljs-string">""</span></span>) Quit 0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=<span class="hljs-variable"><span class="hljs-variable">$order</span></span>(^ORDERX1(oldCustNo,orderNo)) Quit:orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> result=$<span class="hljs-variable"><span class="hljs-variable">$getOrder</span></span>(orderNo,.orderData) . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderData(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)=newCustNo . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$setOrder</span></span>(orderNo,.orderData) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$setCustomer</span></span>(newCustNo,.newData) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> newCustNo`=oldCustNo <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$deleteCustomer</span></span>(oldCustNo) Quit 1</code> </pre><br><br>  Note that this code mostly consists of the functions we have already created for servicing the CUSTOMER and ORDER tables.  In MUMPS, just reuse the code. <br><br>  Now create the $$ getOrder function: <br><br><pre> <code class="bash hljs">getOrder(orderNo,orderData) ; new record <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span>) Quit 0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> record=<span class="hljs-variable"><span class="hljs-variable">$g</span></span>(^ORDER(orderNo)) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderData(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)=<span class="hljs-variable"><span class="hljs-variable">$piece</span></span>(record,<span class="hljs-string"><span class="hljs-string">"~"</span></span>,1) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderData(<span class="hljs-string"><span class="hljs-string">"orderDate"</span></span>)=<span class="hljs-variable"><span class="hljs-variable">$piece</span></span>(record,<span class="hljs-string"><span class="hljs-string">"~"</span></span>,2) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderData(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>)=<span class="hljs-variable"><span class="hljs-variable">$piece</span></span>(record,<span class="hljs-string"><span class="hljs-string">"~"</span></span>,3) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderData(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=<span class="hljs-variable"><span class="hljs-variable">$piece</span></span>(record,<span class="hljs-string"><span class="hljs-string">"~"</span></span>,4) Quit 1</code> </pre><br>  We also need to extend our original simple $$ deleteCustomer () function.  Similar considerations apply to deleting rows from a client table. <br><br>  The SQL query and its equivalent in M ‚Äã‚Äãare shown below: <br><br>  <b>SQL</b> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> CUSTOMER A <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> A.custNo = :custNo</code> </pre><br>  As a result of this query, the corresponding order records will be deleted from the ORDER table (according to the relationship CUSTOMER.custNo = ORDER.custNo and the integrity rules defined when creating the database schema).  Integrity rules can be set using foreign keys, for example. <br><br>  <b>MUMPS</b> <br><br><pre> <code class="bash hljs">deleteCustomer(custNo) ; new orderNo <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> custNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=<span class="hljs-variable"><span class="hljs-variable">$order</span></span>(^ORDERX1(custNo,orderNo)) Quit:orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> result=$<span class="hljs-variable"><span class="hljs-variable">$deleteOrder</span></span>(custNo,orderNo) <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> ^CUSTOMER(custNo) Quit 1</code> </pre><br><br>  The code above requires the $$ deleteOrder () function.  Here she is: <br><br><pre> <code class="bash hljs">deleteOrder(custNo,orderNo) ; <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> ^ITEM(orderNo) ;       <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> ^ORDER(orderNo) ;   <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> ^ORDERX1(custNo,orderNo) ;       ,     Quit 1</code> </pre><br>  Note that the records of all things included in a particular order are deleted with just one KILL command on the index with the order number.  This is because there is a cascade connection (in SQL terms) between the tables with customers and their order numbers. <br><br>  If, when you delete a customer, you need to save information about his orders, breaking the link between the customer and his orders, then the deleteCustomer function will look like this: <br><br><pre> <code class="bash hljs">deleteCustomer(custNo) ; new orderNo,result,orderData <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> custNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderNo=<span class="hljs-variable"><span class="hljs-variable">$order</span></span>(^ORDERX1(custNo,orderNo)) Quit:orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> result=$<span class="hljs-variable"><span class="hljs-variable">$getOrder</span></span>(orderNo,.orderData) . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> orderData(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)=<span class="hljs-string"><span class="hljs-string">""</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> result=$<span class="hljs-variable"><span class="hljs-variable">$setOrder</span></span>(orderNo,.orderData) <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> ^CUSTOMER(custNo) Quit 1</code> </pre><br>  Similar logic should be applied to the data stored in the ITEM table when the order number ORDER.orderNo is changed or deleted in the ORDER table. <br><br>  <b>Triggers</b> <br><br>  Triggers are an easy way to call a certain predefined code when certain conditions inside the database are met.  Usually triggers are triggered by changing some information in the database. <br><br>  In relational databases, triggers are defined at the level of the database schema.  In MUMPS, we can place any trigger code in functions that serve the database. <br><br>  Take, for example, the number of orders of a particular customer CUSTOMER.totalOrders.  We must define a trigger to automatically update this field when adding or removing an order from the ORDER table. <br><br>  <b>SQL</b> <br><br>  This SQL statement must be included in the trigger code for the ORDER table in order to provide the correct value in CUSTOMER.totalOrders: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(A.orderNo) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> A.ORDER <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> A.custNo = :custNo</code> </pre><br><br>  This query will be triggered by inserting and deleting rows in the ORDER table (according to the link CUSTOMER.custNo = ORDER.custNo) <br><br>  <b>MUMPS</b> <br><br>  We simply add the following (trigger) code to the insert function for the ORDER table: <br><br><pre> <code class="bash hljs">setOrder(orderNo,data) ; new rec,itemNo,ok <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 ;       <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-variable"><span class="hljs-variable">$Order</span></span>(^ITEM(orderNo,itemNo)) Quit:itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$getItem</span></span>(orderNo,itemNo,.itemData) . Set data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)+itemData(<span class="hljs-string"><span class="hljs-string">"price"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"orderDate"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=rec_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDER(orderNo)=rec ;       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)`=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDERX1(data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>),orderNo)=<span class="hljs-string"><span class="hljs-string">""</span></span> ; ;    CUSTOMER.totalOrders new custData Set ok=$<span class="hljs-variable"><span class="hljs-variable">$getCustomer</span></span>(data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>),.custData) ;       CUSTOMER.totalOrders. .   setCustomer     Set ok=$<span class="hljs-variable"><span class="hljs-variable">$setCustomer</span></span>(data(<span class="hljs-string"><span class="hljs-string">"CustNo"</span></span>),.custData) ; Quit 1</code> </pre><br>  The same considerations apply when deleting rows from the ORDER table.  Such a scheme can be used to automatically update the cost of the order ORDER.totalValue when adding things to the order. <br><br>  <b>SQL</b> <br><br>  The following SQL must be placed inside a trigger for the ITEM table to calculate the new order value ORDER.Value: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(A.price) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> A.ITEM <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> A.orderNo = :orderNo</code> </pre><br>  The query will be triggered for all insert and delete operations on the ITEM table (according to the ORDER.orderNo = ITEM.orderNo connection). <br><br>  <b>MUMPS</b> <br><br>  Add the following (trigger) code to the insert function of rows with the ITEM table: <br><br><pre> <code class="bash hljs">setItem(orderNo,itemNo,data) ; new ok <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span>)!(itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span>) Quit 0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ITEM(orderNo,itemNo)=data(<span class="hljs-string"><span class="hljs-string">"price"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>^ORDERX1(custNo,orderNo)=<span class="hljs-string"><span class="hljs-string">""</span></span> ;    ORDER.totalValue <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$getOrder</span></span>(orderNo,.orderData) ;     ORDER.totalValue   <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$setOrder</span></span>(orderNo,.orderData) Quit 1</code> </pre><br>  The same considerations apply to operations to remove rows from the ITEM table. <br>  The next example of using triggers in our database will be the automatic generation of an invoice for a client as soon as its creation date is saved in the ORDER.invoiceDate field.  We can very simply add this functionality to our procedure for updating the ORDER table: <br><br><pre> <code class="bash hljs">setOrder(orderNo,data) ; new rec,itemNo,ok <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> orderNo=<span class="hljs-string"><span class="hljs-string">""</span></span> Quit 0 ;    <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> itemNo=<span class="hljs-variable"><span class="hljs-variable">$Order</span></span>(^ITEM(orderNo,itemNo)) Quit:itemNo=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> . <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ok=$<span class="hljs-variable"><span class="hljs-variable">$getItem</span></span>(orderNo,itemNo,.itemData) . Set data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)=data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>)+itemData(<span class="hljs-string"><span class="hljs-string">"price"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"orderDate"</span></span>)_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rec=rec_<span class="hljs-string"><span class="hljs-string">"~"</span></span>_data(<span class="hljs-string"><span class="hljs-string">"totalValue"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDER(orderNo)=rec <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>)`=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ^ORDERX1(data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>),orderNo)=<span class="hljs-string"><span class="hljs-string">""</span></span> ; ;   CUSTOMER.totalOrders new custData Set ok=$<span class="hljs-variable"><span class="hljs-variable">$getCustomer</span></span>(data(<span class="hljs-string"><span class="hljs-string">"custNo"</span></span>),.custData) Set ok=$<span class="hljs-variable"><span class="hljs-variable">$setCustomer</span></span>(data(<span class="hljs-string"><span class="hljs-string">"CustNo"</span></span>),.custData) ; ;  -,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Data(<span class="hljs-string"><span class="hljs-string">"invoiceDate"</span></span>)`=<span class="hljs-string"><span class="hljs-string">""</span></span> Set Result=$<span class="hljs-variable"><span class="hljs-variable">$invoiceOrder</span></span>(orderNo) ; Quit 1</code> </pre><br>  Of course, the $$ invoiceOrder () function must be written to take all the necessary steps to generate an invoice. <br><br>  <b>Transactions</b> <br><br>  A complete database update often consists of many updates to a number of tables.  All these related updates must be guaranteed to be completed before the main update (or transaction) can be considered complete. <br><br>  As a rule, in relational databases, transactions are enabled by default.  In other words, changes to the database are not recorded until the modifying process issues a COMMIT command, after which all changes are confirmed and a new transaction begins. <br><br>  MUMPS is very similar in this respect, except for the fact that transactions must be explicitly included.  The program must execute the start command of the TSTART transaction, and not just confirm its completion with TCOMMIT. <br><br>  <b>SQL</b> <br><br>  We confirm the current transaction and (implicitly) start a new one: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span></code> </pre><br>  <b>MUMPS</b> <br><br>  Start a new transaction: <br><br><pre> <code class="bash hljs">TSTART</code> </pre><br>  Confirm transaction: <br><br><pre> <code class="bash hljs">TCOMMIT</code> </pre><br>  If transaction management is not explicitly enabled in the MUMPS system, then all updates will be immediately applied to the current repository.  In other words, any SET or KILL command on the global or its element can be considered as a completed transaction. <br><br>  <b>findings</b> <br><br>  There are many key advantages to using MUMPS over traditional relational databases. <br><br><ul><li>  Code reuse and ease of maintenance.  With careful programming, you can achieve an extreme high level of code reuse.  The above examples show how you can encapsulate all database actions within the set, get, and delete functions for each table.  Write these functions once, and then use them as you like. </li><li>  Portability  Data structure definitions are contained within functions that work with them.  There is no difference between the definition of data and its implementation. </li><li>  Flexibility.  The code that updates the data can be changed to trigger on any action or event within the system. </li><li>  Performance and optimization.  Experienced MUMPS analysts will see opportunities to optimize the functions we used to work with the database.  This is possible because the definition of data and the implementation of operations on it are contained together within specific functions.  An analyst using SQL does not have precise control over how triggers, referential integrity actions, and transactions are handled. </li><li>  The advantages of using SQL to work or extract data (you can use special utilities for this) are not lost, because the data definition layer can be transparently superimposed on existing MUMPS tables (globals).  This can be done later.  For example, <a href="https://developer.intersystems.com/devconnection/articles/117-17/setting-up-cach%25C3%25A9-sql">Cach√© SQL</a> and the third-party utility <a href="http://www.kbsystems.com/">KB_SQL</a> implement a complete SQL environment on top of the MUMPS globals. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/176345/">https://habr.com/ru/post/176345/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176329/index.html">Speed ‚Äã‚Äãorientation: an overview of the "elite" corporate SSD and HDD</a></li>
<li><a href="../176331/index.html">Overclocking for everyone. "Home" overclocking processor with an open multiplier</a></li>
<li><a href="../176335/index.html">Lithuanian authorities use Google Street View to search tax evaders for homeowners</a></li>
<li><a href="../176341/index.html">Russian Post has again distinguished itself: A ban on receiving international mail has been introduced in Sheremetyevo</a></li>
<li><a href="../176343/index.html">To the events in Cyprus. April theses</a></li>
<li><a href="../176347/index.html">Google Babel messenger is becoming more real</a></li>
<li><a href="../176355/index.html">Balance in the games of the genre of Tower Defense (part 2)</a></li>
<li><a href="../176357/index.html">Wiren Board - embedded computer with Wi-Fi, GPRS, GPS, NFC and Ethernet out of the box</a></li>
<li><a href="../176363/index.html">Processing and classification of requests. Part Two: Navigation Queries</a></li>
<li><a href="../176365/index.html">CamTouch project will take part in the final of Microsoft Imagine Cup 2013 from Ukraine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>