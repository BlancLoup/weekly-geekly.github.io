<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Javapocalypse in a single system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is focused on ABAP developers in SAP ERP systems. It contains many platform-specific points that are of little interest or even controver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Javapocalypse in a single system</h1><div class="post__text post__text-html js-mediator-article">  <i>This article is focused on ABAP developers in SAP ERP systems.</i>  <i>It contains many platform-specific points that are of little interest or even controversial for developers using other platforms.</i> <br><br>  There is such a euphemism: "historically". <br><br>  So, in my main system historically it happened that: <ul><li>  many users work through SAP GUI for HTML; </li><li>  almost all reporting is downloaded to Excel via ZWWW. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And this means that without a properly configured link, Browser + Java is not easy to live. <br><br>  Java is needed to work with files (upload, download).  In principle, a web application should work only inside its window and it should not be allowed to access the user's file system even for a cannon shot.  Files should be handled by the browser personally in a convenient way, but this is contrary to the SAP GUI approach, which wants to control everything: showing the open dialog, the title of the dialog box, the list of available file extensions, allow multiple selections, select the directory, read the directory, read the contents of the file or write .  Since SAP GUI for HTML should repeat the functionality of a big brother, so they decided not to change the approach there, but to introduce an additional layer in the form of a Java applet that would perform these actions on the client side.  The ABAP part with this approach remains virtually unchanged. <br><br>  In addition, ZWWW works through OLE technology, without options.  A web application cannot be allowed to the OLE interfaces of the client machine even within the radius of destruction of ground-to-air missiles.  Consequently, we need another layer in the form of a Java applet that will proxy OLE calls and perform related manipulations. <br><br>  Since the SAP GUI for HTML itself is a layer between the ABAP instance and the ITS server, this whole structure begins to resemble the game of Genga. <br><img src="https://habrastorage.org/files/a47/9d7/de7/a479d7de724b4b9bb0b72c6d56dfc51a.jpg"><br><br>  This game goes on all the time.  Then the browsers start to disable the old Java, the Java applets lose their authority, something happens with the applet's signature verification, some black / white exclusion lists appear, then the applet suddenly begins to slow down on some version of the JRE, then it goes A new version of the office, then update ITS / ABAP, then users at the other end of the country can not set up a security policy, then suddenly it seems to someone that it is easier to set a low level of security in the browser ... <br><br>  If you follow the chronology, you can see: <ul><li>  Firefox - will <a href="https://blog.mozilla.org/futurereleases/2015/10/08/npapi-plugins-in-firefox/">stop supporting Java applets in a year</a> </li><li>  Chrome - even if it was once supported, it was all over </li><li>  Edge - did not support java applets, and will not support </li><li>  Oracle - <a href="https://blogs.oracle.com/java-platform-group/entry/moving_to_a_plugin_free">refuses Java plugin support since Java 9</a> </li></ul><br>  Soon there will be only old and not so kind IE.  Even though the developer has promised to support IE11 in Windows 10, we all know ... <br><br>  What happens if an accountant suddenly takes away the opportunity to upload any report to Excel?  Apocalypse! <br>  And Javapocalypse is approaching. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/E3418SeWZfQ%3Ffeature%3Doembed&amp;xid=17259,1500003,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhc6T882SkN4MWd5nPUh0WLWXA0sA" frameborder="0" allowfullscreen=""></iframe><br><br><a name="habracut"></a><br>  Consider the options. <br><br>  * * * <br>  Change browser (SAP GUI for HTML) to a full SAP GUI.  Disappears for administrative reasons. <br><br>  Change browser (SAP GUI for HTML) to NWBC.  But NWBC is only a shell around the same IE, so this approach does not solve the underlying problems.  It disappears. <br>  * * * <br>  Make ZWWW work on the server and dump the result to the client.  Impossible. <br>  * * * <br>  If the <s>mountain does not go to the</s> platform does not resemble the engine, then you can change ZWWW to another engine: <ol><li>  PDF Forms </li><li>  Reports BI (BObj / BW / other) </li><li>  Alternative engine Abap2xlsx </li></ol><br><br>  All three scenarios are laborious, but there are indications: <br><br>  1. PDF is generated on the server side.  The user can not correct the content.  Some forms are only needed for printing (‚Äúwithout leaving the checkout‚Äù) and are not needed as working documents in the file form.  The most simple examples are cash vouchers, cash vouchers, invoices for payment and other small forms per page. <br><br>  2. Some reports are needed not only to users within the system, but also to external users, and these external users have access to the BI system.  Reports do not require relevance in real time.  If the report has non-trivial calculations, then you can upload the final calculations to the BI system and not force the BI system to repeat this complicated logic.  Reducing the load on the ERP-system.  Possible savings on the number of licenses.  Work reports can remain in the system, but without uploading to beautiful Excel. <br><br>  3. Any remaining can be rewritten from ZWWW to Abap2xlsx.  This library allows you to generate an Excel file directly on the server.  The approaches of these two libraries are radically different, it is simply impossible to replace one call with another.  The speed will increase significantly, especially for complex documents.  The need to support old xls formats is no longer relevant. <br><br>  This is all the background, but for the sake of what I started to write something ... Suppose we rewrote the generation of the file on Abap2xlsx, but also somehow need to be thrown onto the client beautifully! <br><br>  Discarding a file to a client by the browser approach can be performed using the functional method ALEWEB_DOWNLOAD.  It does something, but it's not very beautiful.  For example, you cannot control the file name in it, and the temporary names of random letters only like the system, and people just get sick of it.  If you twist around in that area, then you can punch, finish, copy to the Z-area.  Boredom! <br><br>  And you can make a feint through the service and HTTP-handler.  It is very interesting! <br><br>  First, create a table, for example: <br><img src="https://habrastorage.org/files/1da/dec/812/1dadec8120a74ace9d4bad3cc2c63d7f.png"><br><br>  In this table we will add binary files that must be given to the client.  The file itself is stored in the XDATA field. <br><br>  HTTP handlers in the system are implemented as classes.  For example, take the class CL_HTTP_EXT_PING. <br><br>  Create the ZCL_WWW_FILE_DOWNLOAD class and implement the HANDLE_REQUEST method in it: <br><br><pre><code class="hljs pgsql">data lt_query_string <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> tihttpnvp, ls_query_string <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ihttpnvp. data ls_zwww_content <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> zwww_content. data lv_mimetype <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string. data lv_filename <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string. <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-&gt;request-&gt;get_form_fields( changing fields = lt_query_string ). <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> lt_query_string <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ls_query_string <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> key <span class="hljs-type"><span class="hljs-type">name</span></span> = <span class="hljs-string"><span class="hljs-string">'file_uid'</span></span>. ls_zwww_content-file_uid = ls_query_string-<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> single * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zwww_content <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ls_zwww_content <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> file_uid = ls_zwww_content-file_uid. lv_mimetype = ls_zwww_content-mimetype. concatenate <span class="hljs-string"><span class="hljs-string">'attachment; filename="'</span></span> ls_zwww_content-filename <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> lv_filename. <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-&gt;response-&gt;set_header_field( <span class="hljs-type"><span class="hljs-type">name</span></span> = <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = lv_mimetype ). <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-&gt;response-&gt;set_header_field( <span class="hljs-type"><span class="hljs-type">name</span></span> = <span class="hljs-string"><span class="hljs-string">'Content-Disposition'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = lv_filename ). <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-&gt;response-&gt;set_data( ls_zwww_content-xdata ).</code> </pre> <br>  Everything is trivial: <ol><li>  Read the file_uid parameter from the HTTP request </li><li>  We get the contents of the table </li><li>  We set the HTTP response headers </li><li>  We drop the contents of the file into the body of the HTTP response </li></ol><br><br>  Then we register a new service in the SICF transaction, and assign the newly created handler to it: <br><img src="https://habrastorage.org/files/0fc/638/9ca/0fc6389ca2da4210ab6c10c074244690.png"><br><br>  After this, the service will be available on the link of the form <br>  <a href="http://host:8000/sap/bc/ZFILE_DL%3Ffile_uid%3D5A2D5067C04D1ED5AFB71835DF981A07">http: // host: 8000 / sap / bc / ZFILE_DL? file_uid = 5A2D5067C04D1ED5AFB71835DF981A07</a> <br><br>  Fine!  It remains the case for small: do unloading. <br><br>  First, in any way we get the binary file XLSX.  For example: by converting from ALV: <br><pre> <code class="hljs pgsql"> data lo_converter <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> zcl_excel_converter. <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> lo_converter. lo_converter-&gt;convert( exporting io_alv = gr_table it_table = gt_report[] i_row_int = <span class="hljs-number"><span class="hljs-number">2</span></span> i_column_int = <span class="hljs-number"><span class="hljs-number">2</span></span> ).</code> </pre><br><br>  Then add the file to the table: <br><pre> <code class="hljs pgsql"> data ls_zwww_content <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> zwww_content. clear ls_zwww_content. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'GUID_CREATE'</span></span> importing ev_guid_32 = ls_zwww_content-file_uid. ls_zwww_content-filename = sy-repid &amp;&amp; <span class="hljs-string"><span class="hljs-string">'.xlsx'</span></span>. ls_zwww_content-mimetype = <span class="hljs-string"><span class="hljs-string">'application/msexcel'</span></span>. ls_zwww_content-uname = sy-uname. <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> stamp field ls_zwww_content-<span class="hljs-type"><span class="hljs-type">timestamp</span></span>. lo_converter-&gt;get_file( importing e_file = ls_zwww_content-xdata ). <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zwww_content <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ls_zwww_content. <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> wait.</code> </pre><br><br>  Then we kick the bootloader: <br><pre> <code class="hljs pgsql"> data lv_url <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string. concatenate <span class="hljs-string"><span class="hljs-string">'http://host:8000/sap/bc/ZFILE_DL?file_uid='</span></span> ls_zwww_content-file_uid <span class="hljs-string"><span class="hljs-string">'&amp;sap-client=100&amp;sap-language=RU'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> lv_url. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'ITS_BROWSER_WINDOW_OPEN'</span></span> exporting url = lv_url window_name = <span class="hljs-string"><span class="hljs-string">'_top'</span></span> exceptions its_not_available = <span class="hljs-number"><span class="hljs-number">1</span></span> others = <span class="hljs-number"><span class="hljs-number">2.</span></span></code> </pre><br><br>  Try, draft works! <br><br>  But how can the ZWWW approach apply to Abap2xlsx? <br><br>  And then there is a dialogue: <ul><li>  And let's redo all the reports ... </li><li>  Everything? </li><li>  They are a hundred!  Do we have time for this? </li><li>  There are groupings, dynamic columns and macros! </li><li>  Macros on BASIC, Karl! </li></ul><br><div class="spoiler">  <b class="spoiler_title">Same thing but in pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e1d/658/d0d/e1d658d0dfe4489da615f8b8ed0a7aa8.jpg"></div></div><br><br>  On this optimistic note, I bow out.  Thank you for your attention and see you soon! </div><p>Source: <a href="https://habr.com/ru/post/275477/">https://habr.com/ru/post/275477/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275463/index.html">Using Chakra and JavaScript in Azure DocumentDB</a></li>
<li><a href="../275469/index.html">The most "New Year" messenger for Yota users is WhatsApp</a></li>
<li><a href="../275471/index.html">Eleven important ONLYOFFICE features that are not found in MS Office Online or in Google Docs</a></li>
<li><a href="../275473/index.html">Remote debugging javascript with VS2015. Part 1</a></li>
<li><a href="../275475/index.html">Azure Machine Learning: Developing machine learning services and using them in a mobile application</a></li>
<li><a href="../275479/index.html">Advanced Yandex (and Google) search using the installed script or in the interface</a></li>
<li><a href="../275481/index.html">Cloud Experience: How We Translated the KPI Suite to the Azure Platform</a></li>
<li><a href="../275483/index.html">The first game for iOS and the first difficulties. How not to give up and bring it to release</a></li>
<li><a href="../275485/index.html">How to add a library to the project?</a></li>
<li><a href="../275487/index.html">Statistical analysis in PostgreSQL using PL / R</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>