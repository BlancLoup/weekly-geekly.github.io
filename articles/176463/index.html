<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solving the problem with the encoding of data from MySQL to Symfony</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Immediately I want to say that I am new to Symfony and Doctrine and faced this kind of problem for the first time when using Symfony, but I also think...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solving the problem with the encoding of data from MySQL to Symfony</h1><div class="post__text post__text-html js-mediator-article">  Immediately I want to say that I am new to Symfony and Doctrine and faced this kind of problem for the first time when using Symfony, but I also think that my experience can be useful to someone when solving similar or similar problems. <br><br><h4>  Background: </h4><br>  I had the opportunity not so long ago to upload a project on Symfony2 to the host site, but, as is often the case, the application refused to work on a live server, and having enabled debug, I saw a notification similar to the following: <br><br><blockquote>  Twig_Error_Runtime: An exception has been thrown during the rendering of a template. <br>  ("Warning: htmlspecialchars () [function.htmlspecialchars]: Invalid multibyte sequence in argument in <br>  /.../app/cache/prod/classes.php line ... ") in" ... "at line ... </blockquote><br><a name="habracut"></a><br>  The reason for this error lies in the fact that Twig, by default, escapes any output, including using the <i>htmlspecialchars ()</i> function, which in this case stumbles over some kind of <i>Invalid multibyte sequence</i> .  And having decided that it would be nice to see this very <i>Invalid multibyte sequence</i> , I missed the output of the corresponding variables through the raw filter in the template, like this: <br> <code>{{ sometext|raw }}</code> <br>  It turned out that the Cyrillic text data from the database for some reason comes in the cp1251 encoding, although the encoding of the imported database, tables and acc.  The fields from which the values ‚Äã‚Äãwere taken were utf8.  In phpMyAdmin, which was provided to me by the hoster, on the ‚ÄúVariables‚Äù tab, my attention was attracted by the following values ‚Äã‚Äãof the mysql server configuration parameters: <br><pre> init connect SET NAMES cp1251
 collation database cp1251_general_ci
 collation servercp1251_general_ci
 ...
</pre><br><h4>  Problem: </h4><br>  Obviously, the reason was exactly in init connect, which when connected performed SET NAMES cp1251, because all values ‚Äã‚Äãwere transferred to the application as cp1251. <br><div class="spoiler">  <b class="spoiler_title">SET NAMES</b> <div class="spoiler_text">  Let me remind you that SET NAMES defines the encoding in which the client sends data to the server and also the encoding in which the server sends the return response to the client. </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Problems of this kind are usually solved quite simply - immediately after connecting to the database in our application, we execute a query or a group of queries of the type: <br> <code>SET CHARACTER SET UTF8; <br> SET NAMES UTF8;</code> <br>  But, as for me, any extra query to the database is not comme il faut at all, and the crutches in the framework code too.  Therefore, at first I tried to resolve the issue through technical support. <br>  The guys from technical support of the host company told me that they cannot transfer the base to the server configured under utf8, since  all the servers they work with the same configuration on cp1251, and no one will change the server settings due to one project, because <br>  changes affect all databases on this server (I understand them perfectly).  But the problem had to be solved somehow ... <br><br><h4>  Decision: </h4><br>  However, the Symfony solution turned out to be quite elegant, which was the reason for writing this article. <br>  I came to the aid of a tiny EventListener, which I hung on the postConnect event. <br><br>  To create it, you need to make an entry in the app / config / config.yml file (if you use YAML) in the ‚Äúservices‚Äù section: <br><pre>  services:
     onconnect.listener:
         class: Dev \ SomeBundle \ EventListener \ OnConnect
         tags:
              - {name: doctrine.event_listener, event: postConnect} </pre><br><br>  Now in our Bundle, you need to create a listener file that corresponds to the namespace specified in the configuration above ( <i>Dev \ SomeBundle \ EventListener \ OnConnect</i> ). <br>  those.  We <i>put the</i> <i>OnConnect.php</i> file in the <i>Dev / SomeBundle / EventListener</i> folder as follows: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//file src/Dev/SomeBundle/EventListener/OnConnect.php namespace Dev\SomeBundle\EventListener; use Doctrine\Common\Persistence\Event\LifecycleEventArgs; use Doctrine\ORM\EntityManager; class OnConnect { public function postConnect( $event ) { $conn = $event-&gt;getConnection(); $conn-&gt;executeQuery("SET NAMES UTF8"); } }</span></span></code> </pre><br><br>  In my case, the problem with the encoding was completely eliminated, and besides, I did not have to insert any ‚Äúhacks‚Äù into the doctrine or framework code.  The event listening mechanism is widely used in symfony for solving various tasks.  In the example described above, <b>Symfony 2.2.0 (Standard Edition) was used</b> . <br><br><h4>  Findings: </h4><br><ol><li>  Pay attention to the settings of the MySQL server settings, some servers by default can work with a different encoding. </li><li>  If you do not have the ability to configure MySQL server properly, you can use the technique described above. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/176463/">https://habr.com/ru/post/176463/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176449/index.html">Open data, Rosstat, Prosecutor's Office and all-all-all</a></li>
<li><a href="../176455/index.html">Setting up a cluster with several regions for cloud storage of objects with OpenStack Swift</a></li>
<li><a href="../176457/index.html">Twitter Bootstrap 3: Unofficial First Look</a></li>
<li><a href="../176459/index.html">Two-factor authentication on Citrix NetScaler</a></li>
<li><a href="../176461/index.html">Probabilistic models: Bayesian networks</a></li>
<li><a href="../176467/index.html">Dynamic Access Control: Reshaping Resource Management</a></li>
<li><a href="../176469/index.html">New Brief: Samsung Launches 128-Gbps 3-Bit MLC NAND Memory Based on 10-nm Process Technology</a></li>
<li><a href="../176473/index.html">Javascript Interface Abstract Notation</a></li>
<li><a href="../176477/index.html">How to make the best landing page: checklist of 50 points</a></li>
<li><a href="../176481/index.html">Vulnerability on Habrahabr or how to steal an invite</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>