<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Thermometer reading - via the web interface on the router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! I want to tell you about a small tuning of the router, more precisely, about adding a digital thermometer and displaying data from it using ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Thermometer reading - via the web interface on the router</h1><div class="post__text post__text-html js-mediator-article"> Good day!  I want to tell you about a small tuning of the router, more precisely, about adding a digital thermometer and displaying data from it using the router itself. <br><a name="habracut"></a><br>  When working on my diploma, the DS18B20 sensor came into my hands. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/63d/6c8/f49/63d6c8f490cab2f809ab28d32558b967.jpg"><br><br>  This is a digital output thermometer that transmits data using the 1-wire protocol.  After some reflection, it was decided to teach my long-suffering router to display the external temperature, for statistics and just out of curiosity.  I have a Linksys E3000 with an alternative firmware DD-WRT v24-sp2 (04/13/11) big.  The usual firmware for such cases is not suitable, it does not give access to the necessary functions of the router in the future.  My personal opinion is that DD-WRT is the best and most feature-rich alternative firmware.  Well, how can you not fall in love with the firmware that supports BGP on a home router with 64 MB of RAM) Below is the DD-WRT firmware web interface. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://img339.imageshack.us/img339/6582/webgui.jpg"><br><br>  Usually for data transmission over 1-wire use COM or LPT port, but, unfortunately, on this router there is only one USB connector.  More precisely, it has wiring for UART on the board itself, but then you have to put up with the missing lid on the router, which ruins the design talent of the company Linksys.  In this case, to work with the sensor, you can use USB converters - RS-232 like pl2303.  But for the correct operation of this converter you need drivers.  I‚Äôll say right away that you shouldn‚Äôt do as I do and compile them from source, because the drivers for pl2303 are already included in the DD-WRT firmware and are not loaded) To download them, you will have to connect to the router via authorization by ssh or telnet protocols ( root, the password is the same as the one you specified in the web interface) If everything went well, then you see something like this: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/a4b/e11/8da/a4be118da4cf355f43cc604288623213.jpg"><br><br>  As you already understood, this is a unix system (not IOS, unfortunately, Linksys is not Cisco), so there shouldn't be any difficulties with adapting to the shell. <br><br>  The drivers are located in the /lib/modules/2.6.24.111/kernel/drivers/usb/serial directory and are called usbserial.ko and pl2303.ko.  2.6.24.111 is the version of the kernel and then it may well change in the future) they are loaded with the commands insmod usbserial.ko and insmod pl2303.ko from the directory where they are kept.  If the USB-RS-232 adapter is connected, then after these commands the device should appear at the address / dev / usb / tts / &lt;device number&gt;, in my case number 0. You can check the driver loading via dmesg, it should show something like : <br><br>  registered new interface driver usbserial <br>  drivers / usb / serial / usb-serial.c: USB Serial Driver core <br>  drivers / usb / serial / usb-serial.c: USB Serial support registered for pl2303 <br>  pl2303 1-1.3: 1.0: pl2303 converter detected <br>  usb 1-1.3: pl2303 converter now attached to ttyUSB0 <br>  usbcore: registered new interface driver pl2303 <br>  drivers / usb / serial / pl2303.c: Prolific PL2303 USB to serial adapter driver driver <br><br>  The next thing to do is add a program that can work with 1-wire. <br><br>  It is called digitemp and distributed under the GNU General Public License.  You can compile it for your router or search the Internet for a compiled program for your firmware.  But there is a small underwater stone here - it will not be possible to write the program directly into the ROM due to the hardware features of the router.  You can either write to / tmp, in other words, to RAM, where it will be safely erased after a reboot, or to a USB flash drive that will be connected via a usb hub.  It is highly desirable that the hub be active, otherwise when loading the router, there may not be enough power at the same time on the USB flash drive and pl2303 and one / both devices are recognized in the system incorrectly. <br><br>  In order for the flash drive to work, it is necessary that the Core USB Support, Automatic Drive Mount items be selected in the web interface of the router and the mount point be specified in Disk Mount Point.  All this is in the web interface under <strong>Services&gt; USB</strong> .  My flash drive was mounted in / opt. <br><br>  The next thing to check is how the digitemp works.  This is checked with the commands ./digitemp -s / dev / usb / tts / 0 ‚Äìi (initialization of the device) and ./digitemp -a (read the temperature from all the sensors, of which there is only one piece).  As written in the manual, it is necessary to initialize once, but when reading the data on a schedule it turned out that it is necessary to initialize each time.  If everything went well, the output of the commands should be something like this: <br><br>  DigiTemp v3.3.2 Copyright 1996-2004 by Brian C. Lane <br>  GNU Public License v2.0 - http: # www.brianlane.com <br>  Turning off all DS2409 Couplers <br>  . <br>  Searching the 1-Wire LAN <br>  28B6ACDA020000EC: DS18B20 Temperature Sensor <br>  ROM # 0: 28B6ACDA020000EC <br>  Wrote .digitemprc <br>  Nov 01 16:40:13 Sensor 0 C: 20.88 F: 69.57 <br><br>  All hardware assembly: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/1f5/485/a87/1f5485a87640b27a36c76e6c93ec9501.jpg"><br><br>  The case remains for the small - the creation of a web interface to display the temperature. <br><br>  There were quite a few options for its creation, but I stopped at creating a dynamic web page based on cgi-bin.  It receives data from text files, which are essentially just the result of running the digitemp on the crown.  For the krone to work correctly, you need to configure the NTP client on the router so that the time taken to remove the data is accurate.  This is done in the <strong>Setup -&gt; Basic Setup - Time Settings</strong> section of the DD-WRT web interface.  There you must first start it (select enable), then set the Time zone (Summer time (DST)), and specify the name or address of the NTP server in the Server IP / Name setting, say, VNIIFTRI addresses (ntp1.vniiftri.ru).  After saving the changes and rebooting, the router synchronizes the time with the State standard of time and frequency. <br><br>  Unfortunately, due to the vulnerability in the latest versions of DD-WRT, cgi-bin scripts from the user directory are disabled, so for the dynamic page you need to install a separate web server, which I chose lighttpd.  The page itself is written in perl, microperl is selected as the processor, respectively, in the lighttpd configuration, mod_cgi is uncommented, it is needed for the web page to work.  Below are the changes to the standard lighttpd configuration. <br><br>  server.document-root = "/ opt / share / www /" <br>  # Directory in which files of web pages will be located. <br>  index-file.names = ("index.cgi") <br>  # Default page. <br>  server.event-handler = "poll" <br>  # Type of event handling. <br>  server.tag = "lighttpd" <br>  # sign the web server, be polite <br>  static-file.exclude-extensions = (".fcgi", ".php", ".pl", ".py", ".rb", ".cgi") <br>  # Prohibit the processing of the following pages as static. <br>  server.port = 8081 <br>  # Port on which the web server will work. <br>  server.username = "nobody" <br>  # The username under which the web server will run. <br>  server.groupname = "65534" <br>  # User group under which the web server will run. <br>  cgi.assign = (".pl" =&gt; "/ opt / bin / microperl", <br>  ".cgi" =&gt; "/ opt / bin / microperl") <br>  # specifies which handler to use for cgi-bin based web pages. <br><br>  To display the temperature graph, the Raphael library is used.  I will not give the listings themselves, because of their large volume and low information content. <br><br>  And the final touch - so that everything works even after a reboot, an edit was added to the startup script configuration in the DD-WRT web interface. <br><br>  insmod /lib/modules/2.6.24.111/kernel/drivers/usb/serial/usbserial.ko <br>  insmod /lib/modules/2.6.24.111/kernel/drivers/usb/serial/pl2303.ko <br>  // load drivers for thermometer operation <br>  chmod 666 / dev / usb / tts / 0 <br>  chmod 666 /opt/var/log/lighttpd/error.log <br>  chmod 666 /opt/var/log/lighttpd/access.log <br>  // Change file permissions, although with such numbers only daemons run. <br>  grep -q nobody / etc / passwd ||  echo "nobody: *: 65534: 65534: nobody: / ‚Äã‚Äãvar: / bin / false" &gt;&gt; / etc / passwd <br>  // Creating a user under which lighttpd will work (A little paranoia has never hurt anyone!) <br>  lighttpd -f /opt/etc/lighttpd/lighttpd.conf <br>  // Run the lighttpd itself in daemon mode (the operating system is this, not me ...). <br><br>  Another line has been added to cron, and it is responsible for the removal of data on a schedule. <br>  0 * * * * root sh /opt/input.sh <br><br>  The contents of the script input.sh (which reads data from the sensor every hour) <br><br>  #! / bin / <br>  /opt/share/./digitemp -s / dev / usb / tts / 0 -i; <br>  /opt/share/./digitemp -a -o% .2C |  tail -n 1 &gt;&gt; /opt/share/www/temp1.txt <br>  # Writes the temp.txt temperature from the sensor, in degrees Celsius, two decimal places. <br>  tail -n 24 /opt/share/www/temp1.txt&gt; /opt/share/www/temp.txt <br>  # Cuts the last 24 temperature values ‚Äã‚Äãfrom a file. <br>  date +% R &gt;&gt; /opt/share/www/time1.txt <br>  # Records the hour at which the data was taken. <br>  tail -n 24 /opt/share/www/time1.txt&gt; /opt/share/www/time.txt <br>  # Cuts the last 24 temperature values ‚Äã‚Äãfrom a file. <br><br>  Thus, we get the temperature in the last 24 hours. <br>  After all the settings, when you go to page 192.168.1.1:8081 this will be displayed: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/184/26f/34f/18426f34f071e54e68ec47730fe96713.jpg"><br><br>  Although the 1-wire standard itself works on a common bus, it allows a line length of up to 300 meters, which allows measuring the temperature throughout the house and beyond.  In addition, not only sensors work with 1-wire, but also actuators, so that on the basis of this protocol and your home router, you can build a small smart house with control via the Internet. </div><p>Source: <a href="https://habr.com/ru/post/147259/">https://habr.com/ru/post/147259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147253/index.html">Testing Digium phones with AsteriskNow distribution</a></li>
<li><a href="../147254/index.html">Evolution of the Analytical Infrastructure (continued)</a></li>
<li><a href="../147255/index.html">Keyboard Shortcuts with Javascript</a></li>
<li><a href="../147257/index.html">PHP is much better than you think.</a></li>
<li><a href="../147258/index.html">Bitcoin and Futures Trading Basics</a></li>
<li><a href="../147261/index.html">Amazon plans to release a smartphone?</a></li>
<li><a href="../147262/index.html">Upload and submit an AJAX form to Drupal 7</a></li>
<li><a href="../147263/index.html">Unity 3D. Create a 3D menu</a></li>
<li><a href="../147264/index.html">Speech, language and music</a></li>
<li><a href="../147266/index.html">Mining and processing of gaming traffic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>