<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using git capabilities in the modular project build system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our blog, we already talked about the principles of organizing the repository of a large project as a set of independent modules, which allows you ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using git capabilities in the modular project build system</h1><div class="post__text post__text-html js-mediator-article">  In our blog, we already talked <a href="http://habrahabr.ru/company/relex/blog/258505/">about the principles of organizing the repository of a large project</a> as a set of independent modules, which allows you to organize the extraction of source codes into an arbitrary file structure of the working copy.  Of course, such an approach could not but affect the project build system, since it demanded the creation of a mechanism for tracking dependencies between modules, taking into account their actual placement.  This article focuses on how git can be used to solve not only this problem, but also to extract a project fragment with automatic consideration of internal intermodule dependencies. <br><br><img src="https://habrastorage.org/files/0fd/92c/e56/0fd92ce56fbe41bb99f37adf10282bb0.png"><br><a name="habracut"></a><br><h1>  Some words about examples </h1><br>  It was originally intended to provide this publication with fragments of the build system as implemented in <a href="https://linter.ru/ru/">Linter</a> , however, we do not use native git modules in this project and use make our own development utility.  Therefore, in order not to hurt the practical value of the material for readers, <a href="https://github.com/pechenkin/make">all examples are</a> adapted for use in the bundle git submodules and gnu make, which led to certain difficulties, which will be indicated below. <br><br><h1>  Demo Description </h1><br>  In order to simplify, we will consider the integration of the build system with git on the example of a conditional product called project, which consists of the following functional modules: <br>  applications - the application itself; <br>  demo - demo examples; <br>  libfoo and libbar are the libraries on which applications depend. <br>  The project dependency graph is as follows: <br><img src="https://habrastorage.org/files/c8d/578/02a/c8d57802a6544c8db8fc57ac90cac595.png"><br>  <i>Figure 1: Project dependency graph</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Storage organization </h1><br>  From the point of view of the version storage system, the project is divided into five separate repositories ‚Äî four for modules and a fifth, project.git, which serves as a container and contains an assembly system.  This method of organization has several advantages in comparison with the mono-repository: <br><ul><li>  each submodule has a separate revision history; </li><li>  the ability to clone only part of the project; </li><li>  each repository can have individual rules and access policies; </li><li>  the ability to extract the project into an arbitrary structure of the working copy. </li></ul><br><br><h1>  Submodules and dependencies </h1><br>  Despite the fact that the recursive approach to the organization of the assembly system is <a href="http://habrahabr.ru/post/144127/">justifiably criticized</a> , it still allows you to significantly reduce the cost of supporting the project, so in our example we will use it.  At the same time, the root makefile of the project should not only ‚Äúknow‚Äù the position of the modules within the project, but also ensure that the child make-processes are invoked in order in the right order: from the branches of the dependency tree to the roots.  To do this, you should explicitly describe these inter-module dependencies; in our example, this is done <a href="https://github.com/pechenkin/make/blob/master/make/examples/tree/Makefile">as follows</a> : <br><pre><code class="hljs cmake">MODS = <span class="hljs-keyword"><span class="hljs-keyword">project</span></span> application libfoo libbar demo submodule.<span class="hljs-keyword"><span class="hljs-keyword">project</span></span>.deps = application demo submodule.demo.deps = application submodule.application.deps = libfoo libbar submodule.libfoo.deps = submodule.libbar.deps =</code> </pre> <br>  A correct traversal of this tree can be provided by means of make, creating dynamic targets with explicit dependencies, for which we will declare a function gen-dep of the following form: <br><pre> <code class="hljs mel">define gen-dep $(<span class="hljs-number"><span class="hljs-number">1</span></span>):$(foreach dep,$(submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).deps),$(dep)) ; endef</code> </pre> <br>  Now, if in the body of the root Makefile call gen-dep for all modules <br><pre> <code class="hljs mel">$(foreach mod,$(MODS),$(<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span> $(call gen-dep,$(mod))))</code> </pre> <br>  then it will generate the following dynamic targets at runtime (this can be checked by running make with the -p key) <br><pre> <code class="hljs cmake"><span class="hljs-keyword"><span class="hljs-keyword">project</span></span>: application demo demo: application application: libfoo libbar libbar: libfoo:</code> </pre> <br>  that allows when referring to them to ensure the call dependencies in the right order.  At the same time, if the name of the target matches the existing file or directory, then this can disrupt execution, since make ‚Äúdoes not know‚Äù that these our goals are actions, and not files, in order to avoid this we will explicitly indicate: <br><pre> <code class="hljs mel">$(<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span> .PHONY: $(foreach mod,$(MODS), $(mod)))</code> </pre> <br>  Suppose that the developer has the task of making changes to the application, for which he needs to get only the submodules application, libbar, libfoo.  For this, the build system should, based on the dependencies declared above, form a description of the modules and their placement for later use by git, which, <a href="http://git-scm.com/docs/gitmodules">as you know</a> , describes the registered submodules in the file named .gitmodules located in the root of the cloned repository. <br><br>  We make the <a href="https://github.com/pechenkin/make/blob/master/make/examples/register/Makefile">following changes</a> to our example to ensure the generation of .gitmodules of the minimum required composition: <br><pre> <code class="hljs ruby">‚Ä¶ MODURLPREFIX ?= git@git-common.relex.ru/ MODFILE ?= .gitmodules ‚Ä¶ define tmpl.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span> <span class="hljs-string"><span class="hljs-string">"[submodule \"$(1)\"]"</span></span> endef define tmpl.path <span class="hljs-string"><span class="hljs-string">"\tpath = $(1)"</span></span> endef define tmpl.url <span class="hljs-string"><span class="hljs-string">"\turl = $(1)"</span></span> endef ‚Ä¶ define submodule-set submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).name <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(<span class="hljs-number"><span class="hljs-number">2</span></span>) submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).path <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(<span class="hljs-number"><span class="hljs-number">3</span></span>) submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).url <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(<span class="hljs-number"><span class="hljs-number">4</span></span>) endef define set-default $(call submodule-set,$(<span class="hljs-number"><span class="hljs-number">1</span></span>),$(<span class="hljs-number"><span class="hljs-number">1</span></span>),$(<span class="hljs-number"><span class="hljs-number">1</span></span>),$(MODURLPREFIX)$(<span class="hljs-number"><span class="hljs-number">1</span></span>).git) endef define gen-dep $(<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-symbol"><span class="hljs-symbol">:</span></span>$(foreach dep,$(submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).deps),$(dep)) @echo <span class="hljs-string"><span class="hljs-string">"Register module $(1)"</span></span> @echo $(call tmpl.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>,$(submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).name)) <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>$(MODFILE) @echo $(call tmpl.path,$(submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).path)) &gt;&gt; $(MODFILE) @echo $(call tmpl.url,$(submodule.$(<span class="hljs-number"><span class="hljs-number">1</span></span>).url)) &gt;&gt; $(MODFILE) endef ‚Ä¶ $(foreach mod,$(MODS),$(eval $(call set-default,$(mod))))</code> </pre> <br>  Now our conditional developer, having called make application, can create the following file: <br><pre> <code class="hljs pgsql">[submodule "libfoo"] <span class="hljs-type"><span class="hljs-type">path</span></span> = libfoo url = git@git-common.relex.ru/libfoo.git [submodule "libbar"] <span class="hljs-type"><span class="hljs-type">path</span></span> = libbar url = git@git-common.relex.ru/libbar.git [submodule "application"] <span class="hljs-type"><span class="hljs-type">path</span></span> = application url = git@git-common.relex.ru/application.git</code> </pre> <br>  which can already be modified and parsed <a href="http://git-scm.com/docs/git-config">by git-a</a> , for example in the following way: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">git</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-f</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.gitmodules</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--get</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">submodule</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.path</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span></code> </pre> <br>  By itself, the presence of the .gitmodules file in the root of the repository does not register the modules in the index, so until the moment of initialization and cloning of the submodules, all necessary corrections can be made to the file. <br><br>  As for the initialization of submodules directly, the first serious inconvenience in the implementation of native modules in git is manifested here: this version control system stores metadata about modules both in the index and in the .gitmodules file.  Looking into the <a href="">source code</a> it becomes clear that we have two not the best alternatives. <br>  The first is to add the information about the modules to the index <a href="http://stackoverflow.com/questions/11258737/restore-git-submodules-from-gitmodules">as follows</a> : <br><pre> <code class="hljs mel">#!/bin/sh git config -f .gitmodules --get-regexp <span class="hljs-string"><span class="hljs-string">'^submodule\..*\.path$'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> read path_key path <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> url_key=$(echo $path_key | sed <span class="hljs-string"><span class="hljs-string">'s/\.path/.url/'</span></span>) url=$(git config -f .gitmodules --get <span class="hljs-string"><span class="hljs-string">"$url_key"</span></span>) git submodule add --force $url $path done</code> </pre> <br>  in this case, it is possible to work with submodules using the standard git-submodule (iterators, group operations, etc.), however, moving / deleting modules, as well as their branching, will require additional auxiliary operations.  This situation was one of the reasons why we refused to use git-submodules in the <a href="https://linter.ru/">Linter</a> repository.  An alternative to submodule add is cloning modules without registering with the index, which can be done as follows: <br><pre> <code class="hljs mel">#!/bin/sh git config -f .gitmodules --get-regexp <span class="hljs-string"><span class="hljs-string">'^submodule\..*\.path$'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> read path_key path <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> url_key=$(echo $path_key | sed <span class="hljs-string"><span class="hljs-string">'s/\.path/.url/'</span></span>) url=$(git config -f .gitmodules --get <span class="hljs-string"><span class="hljs-string">"$url_key"</span></span>) git clone $url $path done</code> </pre> <br>  in this case, it is necessary to explicitly specify all $ path in .gitignore, otherwise git will take the cloned submodules as regular directories and process them and contents as untraceable files. <br><br>  Anyway, after cloning by any of the above methods, the working copy will correspond to the situation of extracting the selected tree fragment. <br><br><img src="https://habrastorage.org/files/ff7/582/473/ff75824731a2410bb8f31df1b335a900.png"><br>  <i>Figure 2: Project dependency graph.</i>  <i>A selectable module tree is highlighted by a fill.</i> <br><br>  and, provided that the intermodular dependencies are correctly declared, it contains everything necessary for compiling the application. <br><br><h1>  Positioning modules </h1><br>  Another task that the assembly system solves is to determine the current position of the modules.  For this, we will use the file descriptor generated by us earlier.  As in the case of initialization, there are several options.  The simplest thing is to take advantage of git config features: <br><pre> <code class="hljs swift">define <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-path $(shell git config -f .gitmodules --<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-string"><span class="hljs-string">"submodule.$(1).path"</span></span>) endef define <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-url $(shell git config -f .gitmodules --<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-string"><span class="hljs-string">"submodule.$(1).url"</span></span>) endef</code> </pre> <br>  This solution is not ideal from the point of view of portability, but another option is available only if you use GNU make version 4 or higher ‚Äî in this case, parsing the .gitmodules file can be implemented using the <a href="https://www.gnu.org/software/make/manual/html_node/Extending-make.html">GNU make</a> extensions. <br><br><h1>  Conclusion </h1><br>  Let us remind ourselves once again that the example available on <a href="https://github.com/pechenkin/make">github</a> is an adaptation of our linmodules + linflow bundle-based solutions for gitmodules + GNU make, so some of the drawbacks of pairing these tools are not solved in the most elegant way, and the calls of child make files in modules are replaced with ‚Äúdummy‚Äù ". <br><br><img src="https://habrastorage.org/files/a9b/a62/014/a9ba620142dc4459a08b5f8b192e8133.png"><br><br>  Nevertheless, the mechanism proved itself quite well when working with a large project and successfully ‚Äúcopes‚Äù with the repository of 102 git submodules, between which there are 308 intermodule connections (both logical and assembly) with a bond graph diameter of 5 units (see illustration above). </div><p>Source: <a href="https://habr.com/ru/post/260311/">https://habr.com/ru/post/260311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260295/index.html">Jii: Full Query Builder for Node.js with API from Yii 2</a></li>
<li><a href="../260297/index.html">Accelerate MySQL insert / update 5-10 times</a></li>
<li><a href="../260301/index.html">Buying in the online store: work on the bugs</a></li>
<li><a href="../260303/index.html">The hijacking of Telecom Malaysia trunk provider noticeably worsened global routing last Friday.</a></li>
<li><a href="../260309/index.html">New panels and connections for Kubotronika</a></li>
<li><a href="../260315/index.html">Bitbucket has announced a plugin system: a new round of wrestling cloud VCS</a></li>
<li><a href="../260317/index.html">Quick start Data Binding in Android</a></li>
<li><a href="../260319/index.html">JavaScript immutability</a></li>
<li><a href="../260323/index.html">"Magic quadrant" IaaS providers from Gartner</a></li>
<li><a href="../260325/index.html">How to get an invite to Dribbble with a 100% guarantee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>