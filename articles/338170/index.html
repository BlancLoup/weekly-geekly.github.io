<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Timing attack on Node.js - when time works against you</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine a service (or a web application) that gives you a message like ‚Äúthe fifth character of the password you entered is incorrect‚Äù in response to y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Timing attack on Node.js - when time works against you</h1><div class="post__text post__text-html js-mediator-article">  Imagine a service (or a web application) that gives you a message like ‚Äúthe fifth character of the password you entered is incorrect‚Äù in response to your authentication attempt.  Looks absurd, right?  By providing a potential attacker with this kind of information, we simply give him a chance to ‚Äúpull off‚Äù (pick up, by brute force) the password from the service. <br><br>  At the same time, this is practically the very event that occurs when, for example, we use the simplest mechanism for comparing the string data type during the verification of passwords or tokens for authentication. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/cb6/40b/8cf/cb640b8cf9c34d10859c3244f637b4ee.png"></div><br>  By itself, a ‚Äútiming attack‚Äù or ‚Äútime attack‚Äù is an attack on a system over an open access channel, when an attacker tries to compromise a system by analyzing the time spent on executing algorithms.  Each operation (especially mathematical, be it addition, subtraction, exponentiation, etc.) requires a certain time for execution, and this time may vary depending on the input data.  With accurate measurements of the time spent on these operations, an attacker can recover the data needed to log on to the system. <br><a name="habracut"></a><br><h2>  Something about JavaScript </h2><br>  Returning to the introduction, the string comparison engine in JavaScript, based on the <b>===</b> operator, works like a normal iteration for strings of the same length, comparing strings with each other by the simplest enumeration of characters, going forward at the same time if the compared pair of characters is identical, and unexpectedly stopping if one of the characters in the pair is different. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAuthenticated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, token</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> correctToken = FetchUserTokenFromDB(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token === correctToken; }</code> </pre> <br>  <i>Sample unwanted code</i> <br><br>  This operation is fast, but at the same time unsafe.  Studies show that it is easy for an attacker to measure time intervals from 15 to 100 microseconds via the Internet and 100 nanoseconds through a local network.  In other words, the attackers are able to use the technique of such tiny time delays, like a hint - which character came up and which one did not.  To prevent the development of such scenarios, we should implement a string processing mechanism so that its processing takes the same period of time, regardless of the given password. <br><br>  For example, applying the logical operation <b>xor</b> for two passwords, while receiving the output 0. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mismatch = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;a.lenght; ++i) { mismatch | = (a.charCodeat(i)) ^ b.charCodeAt(i)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mistmatch;</code> </pre> <br><h2>  As for Node.js </h2><br>  <a href="https://ru.wikipedia.org/wiki/Node.js">Node.js</a> itself was designed as a scalable and asynchronous framework.  When any part of the Node.js code wants to make a call to a blocking action (for example, opening a file or writing to a network socket), it registers a callback function (callback), starts the corresponding action, and then exits.  Callback itself is invoked using a mechanism called the event loop. <br><br>  <b><a href="https://medium.com/devschacht/event-loop-timers-and-nexttick-18579cd122e0">The event loop</a></b> is what allows Node.js to perform non-blocking I / O operations (even though JavaScript is single-threaded) by uploading operations to the system kernel (when possible).  Since most modern kernels are multi-threaded, they can handle several operations performed in the background.  When one of these operations completes, the kernel tells Node.js that the corresponding callback function can be added to the polling queue to eventually be executed. <br><br>  The model built on event management is in itself very super-scalable, since the threads (threads) represented in it are never in a waiting state.  But at the same time, this is stated as a problem, since this or that function has to be taken for execution for a long period of time before it is completed. <br><br>  Since initially a server based on Node.js runs one thread per core (by default) - any one ‚Äúlong-playing‚Äù function can occupy the entire core of the processor, causing other functions to idle in standby mode.  It is for the above reason that in the browser we can sometimes see a message with an error - ‚Äúscript taking too long to run‚Äù.  On the server, at this time, ‚Äúsimple‚Äù incoming requests occur. <br><br><h2>  Parse the example </h2><br>  Suppose we have a small service <a href="http://example.com/">example.com</a> that provides us with a couple of endpoints: <br><br>  <a href="http://example.com/info">example.com/info</a> <br><br>  <a href="http://example.com/check">example.com/check</a> <br><br>  The source code of the service, which you can use for local launch, you can download by <a href="https://gist.github.com/grnd/d5b22e8bcd9942fb7c7b">reference</a> . <br><br>  Request for endpoint / info will display us information about our ip-address and the number of our requests. <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"you are 172.25.20.157 request count on your IOLoop: 1"</span></span></code> </pre> <br>  A request for / check in the appropriate form will show us whether we could find the right combination of characters or not. <br><br><pre> <code class="javascript hljs">curl <span class="hljs-string"><span class="hljs-string">"http://example.com/check?val0=1&amp;val1=1&amp;val2=1&amp;val3=1&amp;val4=1"</span></span> <span class="hljs-string"><span class="hljs-string">"you are 172.25.20.157 - At least one value is wrong!"</span></span></code> </pre> <br>  What do we know in advance about the system that we will ‚Äúattack‚Äù? <br><br><ol><li>  To access the system, we need to provide the correct sequence of characters: <b>val0 = 1 &amp; val1 = 1 &amp; val2 = 1 &amp; val3 = 1 &amp; val4 = 1</b> </li><li>  The sequence of numbers is presumably in the range from 1 to 100. </li><li>  The execution time of the algorithm most likely varies from the input data it takes. </li><li>  The server constantly waits at least 3 seconds before giving a response to prevent a timing attack. </li></ol><br>  What we do not know is that the correct login data looks like this: <br><br>  <b>Val0 = 4 &amp; val1 = 12 &amp; val2 = 77 &amp; val3 = 98 &amp; val4 = 35</b> <b><br></b> <br>  So, since we know that a server spends about 3 seconds processing a single request, it can take thousands of years to select a combination of <b>100 ^ 5</b> using a trivial search.  The event cycle counter increases in any case, but we can get information about the state of the counter only by calling endpoint <b>/ info</b> . <br><br><pre> <code class="javascript hljs">$ curl <span class="hljs-string"><span class="hljs-string">"http://example.com/info"</span></span> you are <span class="hljs-number"><span class="hljs-number">172.25</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.175</span></span> request count on your IOLoop: <span class="hljs-number"><span class="hljs-number">1</span></span> $ curl <span class="hljs-string"><span class="hljs-string">"http://example.com/info"</span></span> you are <span class="hljs-number"><span class="hljs-number">172.25</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.175</span></span> request count on your IOLoop: <span class="hljs-number"><span class="hljs-number">2</span></span> $ curl <span class="hljs-string"><span class="hljs-string">"http://example.com/check?val0=1&amp;val1=1&amp;val2=1&amp;val3=1&amp;val4=1"</span></span> you are <span class="hljs-number"><span class="hljs-number">172.25</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.157</span></span> - At least one value is wrong! $ curl <span class="hljs-string"><span class="hljs-string">"http://example.com/info"</span></span> you are <span class="hljs-number"><span class="hljs-number">172.25</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.175</span></span> request count on your IOLoop: <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Sending requests for <b>/ check</b> with different combinations of numbers will not give us any significant differences in execution time.  The algorithm seems to take less than 3 seconds to complete.  We also noticed that sending a request to <b>/ info</b> while it is processing a request to <b>/ check</b> provides us with a clue to which we have devoted this study.  Here we just come to the aid of the concept of a cycle of events, which we described above. <br><br>  While the endpoint call is being processed <b>/ check</b> , the event loop does not take control, forcing the endpoint <b>/ info</b> call to hang.  In contrast, the setTimeout function simply logs the scheduled event and gives control, allowing requests to the <b>/ info</b> controller to be processed very quickly.  How do we apply timing now?  Very simple.  We will send a request for <b>/ check</b> and, without waiting for an answer, we will immediately send a request for <b>/ info</b> , measuring the response time. <br><br><pre> <code class="javascript hljs">$ curl <span class="hljs-string"><span class="hljs-string">"http://example.com/check?val0=1&amp;val1=1&amp;val2=1&amp;val3=1&amp;val4=1"</span></span> you are <span class="hljs-number"><span class="hljs-number">172.25</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.157</span></span> - At least one value is wrong! $ curl <span class="hljs-string"><span class="hljs-string">"http://example.com/info"</span></span> you are <span class="hljs-number"><span class="hljs-number">172.25</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.175</span></span> request count on your IOLoop: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  In fact, during such requests the following happens: <br><br><img src="https://habrastorage.org/web/08d/b27/1f9/08db271f9d7d4103a38a34a06731394f.jpg"><br><br>  As we can see, measurement will show us that when setting <b>val0 = 4</b> , the system will respond to us with a slight delay.  Thus, based on such delays, we can eventually recover all the necessary code sequence. <br><br>  Ways of protection: <br><br><ul><li>  Maintenance of constant time during execution of risky requests (for example, authentication); </li><li>  More thorough testing of systems for vulnerabilities (for example, Nanown or Time_trial); </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BB%25D0%25B5%25D0%25BF%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">Technologies for creating blind signatures</a> (if we are talking about the protection of cryptographic systems); </li><li>  Algorithms based primarily on logical operations, and not on arithmetic. </li></ul><br><h2>  Conclusion </h2><br>  Timing attacks today can be a real threat for both small applications and large ones.  Practice shows that even from small differences in the execution time of queries to the system, you can gather enough information that can be used by attackers.  In particular, from the point of view of Node.js, a cycle of events can be used. <br><br>  <b>Links</b> <br><br>  When writing a post, I used <a href="https://snyk.io/blog/node-js-timing-attack-ccc-ctf/">this</a> material. <br>  Plus some Wikipedia content. </div><p>Source: <a href="https://habr.com/ru/post/338170/">https://habr.com/ru/post/338170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338158/index.html">kubernetes, playground, microservices and a bit of magic</a></li>
<li><a href="../338160/index.html">3CX technical support responds: how to replace or update the SSL certificate on the server</a></li>
<li><a href="../338164/index.html">Do not touch the logs with your hands! How to reduce the time for analysis using autotests</a></li>
<li><a href="../338166/index.html">Use PowerShell for IT security. Part III: Budget Classification</a></li>
<li><a href="../338168/index.html">Do-it-yourself Windows server file backup</a></li>
<li><a href="../338172/index.html">Work with smart contracts through Ethereum RPC API</a></li>
<li><a href="../338174/index.html">Infographics: all 42 spacecraft buried on other planets in the solar system</a></li>
<li><a href="../338176/index.html">Create a GTK video player using Haskell</a></li>
<li><a href="../338178/index.html">Sotsinzhiniring in military propaganda</a></li>
<li><a href="../338180/index.html">Materials from VLDB, conferences about the future of databases</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>