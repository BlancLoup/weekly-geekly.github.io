<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Audit Active Directory: goals, shortcomings of the staff audit system and ways to overcome them</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear habrovchane, 
 We offer you a translation of the book by Don Jones, MVP, an award-winning specialist and simply a very popular author in the Unit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Audit Active Directory: goals, shortcomings of the staff audit system and ways to overcome them</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/dae/960/443/dae960443c1d3ca1d8ebdf380a899fd6.jpg"><br>  <i>Dear habrovchane,</i> <i><br></i>  <i>We offer you a translation of the book by Don Jones, MVP, an award-winning specialist and simply a very popular author in the United States.</i> <br><br>  There are three ‚ÄúA‚Äù security Active Directory (AD) - authentication, authorization, auditing.  In this post, we present a fragment of the translation from the book Don Jones ‚ÄúActive Directory Troubleshooting, Auditing, and Best Practices‚Äù dedicated to AD auditing. <br><br><h4>  The objectives of the standard audit instruments </h4><br>  The purpose of the audit is quite trivial: to track everything that someone does.  In the context of AD, this means keeping track of the use of all privileges, such as changing group memberships or unlocking user accounts.  It also means that it is necessary to record user actions, such as successful and unsuccessful logins.  Let's look more broadly - and for Windows, this means that auditing also includes access to files and folders, as well as changes to file access permissions. <br><a name="habracut"></a><br>  Your goal in auditing may differ from those achieved within the framework of the operating system audit architecture.  Remember that the audit system used in Windows - including AD, which is a copy of the file system architecture, came to us from the early 90s, when Windows NT appeared.  At the same time, Microsoft could not have imagined that there would be organizations with thousands of file servers, hundreds of domain controllers and thousands of other servers running Exchange, SQL Server, SharePoint and other business platforms.  We will consider below that the standard Windows audit tools are not always scalable in large infrastructures or even for medium-sized companies.  Maybe you would like every event in the IT infrastructure to be fixed by the audit system, but this can create problems in performance, management and even logistics.  Therefore, let's assume that your goal is to audit everything that happens in the IT infrastructure, and see what can be achieved by regular means. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Established audit system </h4><br>  Permissions apply to the discretionary access control list (DACL).  Each DACL consists of one or more access control elements (ACEs).  Each such element contains the permission or prohibition of a specific set of permissions with respect to a user or group.  DACL is a part of ‚Äúauthorization‚Äù in the three A model: AD authenticates you and gives you a security token containing a unique security identifier (SID).  This SID is compared with the ACE in the granular access control list (DACL) to determine what permissions you have when accessing these resources. <br>  Audit works in a similar way.  An object access control list (SACL) consists of one or more entries.  Each entry indicates a specific action for a particular activity, performed by a user or group.  A SACL is bound to a specific resource, such as a file or directory object, and when a particular action is performed on a resource, it is recorded in a log.  By default, it is possible to record ‚Äúsuccess‚Äù and / or ‚Äúfailure‚Äù actions in the log.  This means that you can choose to have a record in the journal when someone successfully used their permissions or when he tried to do it and was denied it.  Figure 1 shows the SACL configuration for AD.  As you can see, this resource - the domain controllers of the division - is set up so that some types of successful actions of the members of the ‚ÄúEveryone‚Äù group are recorded.  That is, when someone successfully performs these actions, a journal entry is created. <br><br><img src="https://habrastorage.org/storage2/ed0/cc6/b60/ed0cc6b60c16b4edb4457f05575fa367.jpg"><br>  <b>Figure 1: SACL in AD.</b> <br><br>  What actions are subject to audit depends on what resources you work with.  For example, Figure 2 shows the file system SACL, and you can see that various types of actions are available. <br><br><img src="https://habrastorage.org/storage2/3de/ab0/eb8/3deab0eb80ffb7f82f3191b90b9de506.jpg"><br>  <b>Figure 2: File System SACL.</b> <br><br>  Here you can choose what is to be audited, for example, creating folders, reading attributes, deleting files and the like.  Thus, each resource can have its own SACL.  In practice, most of us assign SACLs at a fairly high level of the hierarchy and thus allow these settings to spread to lower level objects through inheritance.  Therefore, SACL is managed in a relatively small number of places.  But we still need to configure them at least one for each server and for the main system.  What does this mean: each server will need its own list of management of access to objects at least in the root of each logical drive, we will need a separate list in the root of AD and so on. <br>  Other products may fall under this scheme.  And they may not fall.  For example, Exchange Server uses a similar structure for auditing, but SQL Server and SharePoint do not.  However, here we consider only AD. <br>  When an action for which an audit is configured occurs, Windows generates an audit record.  All such records are stored in the security event log, which is shown in Figure 3. The problem with such a log is that every event gets there.  Although it seems to be a good idea to keep all events in one place, the problem is that when it is necessary to extract separate records from it, it becomes problematic.  Once again, this is due to the fact that Microsoft has a rather narrow view of the Active Directory audit system. <br><br><img src="https://habrastorage.org/storage2/0d3/b4d/355/0d3b4d355f23e9797874f6b95686e48f.jpg"><br>  <b>Fig.</b>  <b>3: Security event log.</b> <br><br>  Each Windows server has its own security event logs, including domain controllers.  Although the access control lists for objects in AD can be configured on any domain controller and subsequently replicated to the others, only the domain controller that processes this action will create a log entry about it.  The result: there is a centrally configured audit policy, but audit logs are highly dispersed. <br>  Figure 4 shows how these audit records look like.  They often include ‚Äúraw‚Äù security identifiers and other non-obvious information.  This example shows successful domain connections processed using the standard Kerberos protocol.  The username and domain are empty in this example, but they are usually filled in. <br><br><img src="https://habrastorage.org/storage2/674/c80/a78/674c80a78c0cb8f03a96ad4ee329b53e.jpg"><br>  <b>Figure 4: Example of an audit record.</b> <br><br>  Over time, Microsoft began to solve problems associated with the presence of only one magazine, which contains so much information.  In Windows Vista and Windows Server 2008, the parallel event log architecture was introduced, which made it easier to keep your own log for each product or technology.  It was always possible - application, system, and security logs were supplemented, for example, with directory service logs.  But this new architecture has become more integrated for several reasons.  Figure 5 shows the old and new journals. <br><br><img src="https://habrastorage.org/storage2/5b8/826/6b4/5b88266b4bc4f456f7d83a6d318d2ac8.jpg"><br>  <b>Fig.5: New and old magazines.</b> <br><br>  Unlike the Access Control List (DACL), the Object Access Control List (SACL) is not immediately used by the operating system.  SACL simply indicates which actions are to be audited;  The audit system itself must also be enabled in order for events to be recorded in logs.  Figure 6 shows where this is typically configured in a group policy object. <br>  Most organizations will configure auditing in high-level group policy objects, such as those that apply to all domain controllers or even all servers in a domain.  The designated group policy object refers to configuring an audit policy, which includes enabling auditing for a login / connection event, account management actions, access to AD, and so on.  The audit policy, as well as the SACL resources, must be configured in order to generate the desired audit events. <br><br><img src="https://habrastorage.org/storage2/6a5/bcd/eaf/6a5bcdeaf25c473d6b794749bf626b21.png"><br>  <b>Fig.</b>  <b>6: Configure auditing in a group policy object.</b> <br><br>  Here you need to be attentive.  I do not think that you want to include an audit of all events, not taking into account the consequences.  A domain controller can generate thousands of connection events every minute (for example, when everyone logs on to their computers in the morning), and creating such a number of events requires processing power.  If audit of all these events is really needed, then you will need to increase the size of the domain controller in order to cope with the load.  The same should be done for file servers: if all events about successful access to files are logged, you need to increase the processing power to cope with the load. <br>  Creating such a number of events can ‚Äúlog‚Äù the event log pretty seriously.  As shown in Figure 7, you probably want to combine an audit policy with a well-planned event log policy, adjusting the size of the event logs, rollback actions, and other settings to ensure consistency in the workload of the system. <br><br><img src="https://habrastorage.org/storage2/9c7/a19/645/9c7a196457ca1473a0ac67d297a61d46.png"><br>  <b>Figure 7: Configuring the event log in a group policy object.</b> <br><br>  Unlike the application log, with which you can be calm when it is overwritten as it is filled, this cannot be allowed in the security log, since important information may be lost.  Therefore, you must set a suitable log size and set up procedures for regular archiving and clearing the log, depending on the load on the log. <br>  What the regular Windows event logs are usually criticized for is that they are heavily dispersed.  For example, an administrator can change group memberships on one domain controller, connect to a second domain controller to use an account in this group, and connect to a third controller to reset this group membership.  All three events will be recorded in three different security event logs, which complicates the process of establishing the relationship between these events. <br>  The solution that Microsoft offered to this problem in Windows Server 2008 was event log forwarding.  Figure 8 shows how individual servers forward events to a central server, which collects all events in its own log. <br><br><img src="https://habrastorage.org/storage2/d3e/71c/5b2/d3e71c5b2694aa7749a97e2004490714.png"><br>  <b>Fig.</b>  <b>8: Event Log Forwarding.</b> <br><br>  As indicated, this feature can be configured in group policies, which makes it centrally controlled.  This approach still has significant drawbacks, which we will discuss further. <br>  This is how the staff audit system is built.  Let's now talk about how organizations want to use this system, and where they need advanced features. <br><br><h4>  General business objectives for auditing change </h4><br><br>  Unlike the 90s, when Windows NT was developed, most companies today are subject to certain security policies.  In many cases, when the security policy also implies compliance with the requirements of regulations and legislation.  These requirements may include the obligation to audit all successful and unsuccessful actions occurring in the IT infrastructure, and generate a significant amount of traffic. <br>  It is also important that those users (including administrators) whose actions are recorded in audit records cannot delete records from the event log.  Organizations also want the ability to search, filter, and report on the entries in the event log.  For example, the auditor wanted to see an audit record that corresponds to a change in the AD audit policy configuration, and then correlate these events with approved actions.  What allows him to see that in AD only those changes that have been agreed and documented.  Organizations also need to use in-house audit tools to resolve problems.  When something went wrong in the IT infrastructure, the answer to the question: ‚ÄúWhat has changed?‚Äù Allows you to quickly solve the problem - and audit logs should help in finding the answer to this question quickly and efficiently.  So what are the drawbacks of in-house audit tools? <br><br><h4>  Disadvantages of in-house audit tools </h4><br><br>  Unfortunately, the standard audit system has not proved itself very well.  Ultimately, this is not Microsoft‚Äôs fault ‚Äî after all, their job is not to anticipate any business need, but rather to provide a platform on which other companies can develop software that can meet specific business needs.  That is what they did.  A full-time audit system is a basic solution that is suitable for the smallest organizations that can hardly afford to purchase additional programs. <br>  Objective number 1 - the audit of all events - is definitely feasible with the help of Windows, although it is necessary to take into account the size of the logs and the performance of the server.  The standard architecture of the event log is not transparent, as we would like to see it, and the recording of tens of thousands of events per hour will definitely have an impact on the server. <br>  Objective number 2 - the ability to make changes to the log - the bottleneck of the system.  Unfortunately, it is almost impossible to exclude the possibility of administrators clearing the log.  You can do this by fine-tuning privileges, creating special accounts for working with journals, and so on, but this is difficult and impractical for many organizations. <br>  Suppose you did this.  You are faced with the goal number 3 - the centralized generation of reports, alerts and event filtering.  Forwarding event logs, even if it occurs, is not carried out in real time, significant delays are possible.  But even if you are redirecting the event log, all the information is dumped into one place from where it can be pulled out using the primitive Event Viewer.  Figure 9 shows the filtering capabilities of standard tools, and they are, of course, primitive. <br><br><img src="https://habrastorage.org/storage2/797/f73/d8f/797f73d8f01b91b4c5539b67c43342a3.png"><br>  <b>Fig.9: In-house event log filtering tools.</b> <br><br>  As shown in the figure, you can filter by event types or by special text in the event description, as well as by other criteria.  But the possibility of establishing the relationship between the various related events is missing. <br>  As for using these events to solve problems - well, good luck!  This, of course, is possible, but it usually looks like this: ‚Äúlook at the log, look at what the event identifier means, and determine if this is relevant to the real problem‚Äù.  It is quite difficult for the regular Event Viewer to answer the question ‚ÄúAll changes in AD in the last 4 hours‚Äù.  Although the log will display the events associated with these changes ‚Äî you configured an audit policy to capture them ‚Äî the event log is not intended to perform the task of managing changes or auditing them.  This is not an audit of changes in the proper meaning of this term, but an audit of the fact that someone made a change. <br>  As shown in Figure 10, the values ‚Äã‚Äãof ‚Äúbefore‚Äù and ‚Äúafter‚Äù of each change began to be recorded in AD Windows Server 2008, which makes it more suitable for auditing changes.  However, this function is not very common in AD and it is still problematic to find the necessary events in a large journal. <br><br><img src="https://habrastorage.org/storage2/def/226/85f/def22685fcac04257459bb2ccbde4b7e.png"><br>  <b>Figure 10: Improved view of events in Windows Server 2008.</b> <br><br>  In most infrastructures, an effective audit policy involves the use of third-party solutions. <br><br><h4>  Third Party Opportunities </h4><br>  Tools for third-party auditing have several advantages. <br>  First, they are better (and faster) collecting information from various server logs in a centralized repository.  Often, such centralized storage is a SQL server database, although individual tools can send real-time events to an external logging mechanism, such as a syslog server, as shown in Figure 11. <br><br><img src="https://habrastorage.org/storage2/6b9/5a3/3be/6b95a33be3edd430b759873a0193f712.png"><br>  <b>Figure 11: Event forwarding to syslog server</b> <br><br>  The bottom line is that events from Windows should be retrieved and moved to a separate system as quickly as possible, where they would be protected in a way different from the event log.  Databases in this case are quite a popular choice, because they can be protected and can be accessed with complex queries.  And of course, with their help, you can generate reports.  Therefore, most Active Directory auditing solutions collect events in SQL Server database in order to use report generation capabilities through SQL Server Reporting Services. <br>  Third-party solutions can also use APIs to collect audit information - in addition to (or instead of) regular event logs.  These APIs often provide more detailed information, including ‚Äúbefore‚Äù and ‚Äúafter‚Äù values.  In some cases, using the API can even reduce the server load. <br>  Using centralized data storage, third-party tools can generate alerts in real time, generate reports, archive event records, analyze data and compare them. </div><p>Source: <a href="https://habr.com/ru/post/144447/">https://habr.com/ru/post/144447/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144442/index.html">Comparison of approaches to site creation: design, brief and agile</a></li>
<li><a href="../144443/index.html">The second day of the broadcast with DevCon'12! More reports</a></li>
<li><a href="../144444/index.html">Yahoo! released its browser Axis</a></li>
<li><a href="../144445/index.html">Dynamic display of logs in the browser on Node.js & WebSocket</a></li>
<li><a href="../144446/index.html">Usability-torture in ITMO UX-laboratories</a></li>
<li><a href="../144450/index.html">We learn SQLite to work with the localized calendar</a></li>
<li><a href="../144451/index.html">IBM banned Siri</a></li>
<li><a href="../144453/index.html">WarCraft III / Dota in brief about creating a cheat</a></li>
<li><a href="../144454/index.html">Sleep inside a dream: mix virtual and real networks in the "cloud"</a></li>
<li><a href="../144455/index.html">Database Hacking due to LFI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>