<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft's long arithmetic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 It is known that a computer can operate with numbers, the number of bits of which is limited. As a rule, we are used to working with 32...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft's long arithmetic</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  It is known that a computer can operate with numbers, the number of bits of which is limited.  As a rule, we are used to working with 32-bit and 64-bit integer numbers, which correspond to the types Int32 (int) and Int64 (long) on ‚Äã‚Äãthe .NET platform, respectively. <br><br>  And what to do if you need to submit a number, such as, for example, 29!  = 8841761993739701954543616000000?  This number does not fit in the 64-bit, or even more so 32-bit data type.  To work with such large numbers there is a <i>long arithmetic.</i> <br><br>  <i>Long arithmetic</i> - in computing, operations (addition, multiplication, subtraction, division, exponentiation, etc.) over numbers whose width exceeds the length of the machine word of the given computer.  These operations are not implemented in hardware, but in software, using basic hardware to work with numbers of smaller orders. <br><a name="habracut"></a><br>  Long arithmetic can also be considered as one of the sections of olympiad programming, since very often when solving problems, the capacity of standard types is not enough to represent the final result.  When choosing a programming language for Olympiad needs, a set of tools built in it (ready-made libraries, implemented classes) is not unimportant.  Many languages ‚Äã‚Äã(Java, Ruby, Python) have built-in support for long arithmetic, which can significantly reduce the time to write a program. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The .NET platform up to version 4.0 did not have built-in support for working with long numbers.  In the 4th version of .NET, it acquired not only long, but also complex numbers.  This functionality is available through the <i><b>System.Numerics</b></i> assembly and the <i><b>BigInteger</b></i> and <i><b>Complex</b></i> types defined in the namespace with the assembly name of the same name. <br><br>  It should be said that the <i><b>BigInteger</b></i> structure should have <a href="http://blogs.msdn.com/b/bclteam/archive/2008/01/04/where-did-biginteger-go-melitta-andersen.aspx">appeared in .NET 3.5</a> , but at that time it was not fully ready, its implementation did not meet all needs (this may also include performance problems), so it was decided to postpone its output to .NET 4.0 <br><br>  In this article I would like to consider the details of the implementation of long arithmetic from Microsoft. <br><br><h4>  General concepts </h4><br>  The idea of ‚Äã‚Äãrepresenting long numbers in computer memory is quite simple.  Consider the number 123456789 in the decimal number system.  Obviously, it can be represented as follows: <br><br>  123456789 <sub>10</sub> = 1 * 10 <sup>8</sup> + 2 * 10 <sup>7</sup> + 3 * 10 <sup>6</sup> + 4 * 10 <sup>5</sup> + 5 * 10 <sup>4</sup> + 6 * 10 <sup>3</sup> + 7 * 10 <sup>2</sup> + 8 * 10 <sup>1</sup> + 9 * 10 <sup>0</sup> <br><br>  In general, any number can be represented as: <br><br>  <b>A = a <sub>n-1</sub> Œ≤ <sup>n-1</sup> + a <sub>n-2</sub> Œ≤ <sup>n-2</sup> +‚Ä¶ + a <sub>1</sub> Œ≤ + a <sub>0</sub></b> <br>  where Œ≤ is the base of the number system in which we represent a number, and the coefficients a <sub>i</sub> satisfy the double inequality 0 ‚â§ a <sub>i</sub> &lt;Œ≤. <br><br>  The representation of a number resembles the representation of a polynomial, only instead of x to the appropriate degree we have the base Œ≤ to the necessary degree.  As you know, the polynomial a <sub>0</sub> + a <sub>1</sub> x + a <sub>2</sub> x <sup>2</sup> + ... + a <sub>n</sub> x <sup>n is</sup> conveniently represented as an array, whose elements represent the coefficients a <sub>i</sub> , and the subscript i defines the corresponding degree x.  A long number is stored similarly, it remains to determine the choice of the base Œ≤. <br><br>  For example, the same number 123456789 can be represented in the ten thousandth (Œ≤ = 10 <sup>4</sup> ) number system as follows: <br><br>  123456789 <sub>10</sub> = 1 * (10 <sup>4</sup> ) <sup>2</sup> + 2345 * (10 <sup>4</sup> ) <sup>1</sup> + 6789 * (10 <sup>4</sup> ) <sup>0</sup> <br><br>  Representing the number 123456789 in the ten thousandth number system, we get two advantages at once: first, we reduce the amount of memory consumed, because instead of an array of 9 numbers we only need to store an array of 3 numbers (1, 2345 and 6789), secondly, significantly We reduce the time for performing standard operations on long numbers, since we process 4 digits of a number at a time.  In general, a computer equally quickly adds single-digit and 32-bit numbers, so this should be used. <br><br>  The base of the number system Œ≤ usually depends on the maximum size of the base data type on the computer, and is selected on the basis of the following considerations: <br><br><ol><li>  the base must fit one of the basic data types; </li><li>  The base should be as large as possible to reduce the size of the representation of a long number and increase the speed of operations with them, but small enough so that all operations with coefficients use the basic data type; <br></li><li>  for convenience of output and debugging, you can choose Œ≤ as a degree 10, Œ≤ - a power of two allows you to perform fast operations at a low level. </li></ol><br>  It should also be noted that the sign of the number is taken into account in a separate variable, that is, the array contains the modulus of a long number, as well as the number is stored backwards.  This is done primarily for convenience: you do not need to process in a special way the zero / last element of the array in which the sign of a number could be stored, as well as all operations are performed from the low order to the high order. <br><br><h4>  Microsoft BigInteger </h4><br>  If you look at the <i><b>BigInteger</b></i> structure through the <i>Reflector</i> decompiler or <i>dotPeek</i> , you will see the following fields: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> BigInteger s_bnMinInt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]{ (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MinValue }); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> BigInteger s_bnOneInt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> BigInteger s_bnZeroInt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> BigInteger s_bnMinusOneInt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _sign; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[] _bits; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> knMaskHighBit = <span class="hljs-number"><span class="hljs-number">-2147483648</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> kuMaskHighBit = <span class="hljs-number"><span class="hljs-number">2147483648U</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kcbitUint = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kcbitUlong = <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DecimalScaleFactorMask = <span class="hljs-number"><span class="hljs-number">16711680</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DecimalSignMask = <span class="hljs-number"><span class="hljs-number">-2147483648</span></span>;</code> </pre> <br>  The structure contains only two instance fields (_sign and _bits), the remaining fields are constants and static fields for reading representing the structure values ‚Äã‚Äãfor the numbers -1, 0 and 1. <br><br>  It can be assumed that the _sign variable holds the sign of the number, and the _bits array contains the coefficients a <sub>i</sub> .  Given that the _bits array is of the type uint [], it can also be assumed that the power of Œ≤ is taken to be a 2-level 2 <sup>32</sup> (since uint is a 32-bit unsigned number). <br><br>  So, we will try to confirm or refute our assumptions. <br><br>  A constructor that takes an int as an argument looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">Constructor accepting int</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BigInteger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MinValue) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = BigInteger.s_bnMinInt; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._sign = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[]) <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre></div></div><br>  Its implementation can tell a little more about assigning the _sign variable.  As you can see, if a long number is placed in the int range (from -2 <sup>31</sup> to 2 <sup>31</sup> -1), then it is stored in the _sign variable, and the _bits array is not used, it is null.  This optimization should speed up work like <i><b>BigInteger</b></i> , as well as reduce the size of memory consumed when the number is not really large. <br><br>  Go ahead. <br><br>  A constructor that takes a uint as an argument looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">Constructor accepting uint</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BigInteger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._sign = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[]) <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._sign = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre></div></div><br>  Depending on whether the number fits in the int range, it is written either in the _sign variable or in the _bits array. <br><br>  The following constructor accepting a 64-bit number with a (long) sign will help answer the question about choosing the base of the number system: <br><br><div class="spoiler">  <b class="spoiler_title">Constructor accepting long</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BigInteger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MinValue &lt;= <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MinValue) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = BigInteger.s_bnMinInt; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._sign = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[]) <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> num; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0L</span></span>) { num = (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._sign = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { num = (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._sign = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) num; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (num &gt;&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>); } }</code> </pre></div></div><br>  If the number does not fit into the int range, then, as we see, the _sign variable contains the sign of the number (-1 for negative and 1 for positive), and the _bits array contains those same coefficients a <sub>i</sub> and is populated as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) num; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._bits[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (num &gt;&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>);</code> </pre><br>  In this case, the 64-bit number num is divided into two 32-bit: (uint) num and (uint) (num &gt;&gt; 32).  The first number is the last 32 bits of the number num, while the second is the first 32 bits (shifting to the right by n bits is equivalent to integer dividing by 2 <sup>n</sup> ). <br><br>  Let's define how the number will be stored long.MaxValue = 2 <sup>63</sup> -1 = 9223372036854775807 in the structure <i><b>BigInteger</b></i> .  To do this, divide it by 2 <sup>32</sup> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f11/479/91d/f1147991d1bb167466aeab41fec2d23e.png"><br>  In fact, (uint) long.MaxValue = 4294967295, (uint) (long.MaxValue &gt;&gt; 32) = 2147483647. <br><br>  This means 9223372036854775807 = 2147483647 * (2 <sup>32</sup> ) <sup>1</sup> + 4294967295 * (2 <sup>32</sup> ) <sup>0</sup> , and <i><b>BigInteger</b></i> <i><b><br></b></i>  will be represented by a pair: <br><br>  <b>_sign = 1</b> <b><br></b>  <b>_bits = {4294967295, 2147483647} // remember that the number is stored backwards</b> <br><br>  For the long number -1234567891011121314151617181920 we have: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c69/6d3/a09/c696d3a094823e37df4ff7272d002925.png"><br><br>  That is, the number is decomposed in powers of 2 <sup>32</sup> as follows: <br>  1234567891011121314151617181920 = 15 * (2 <sup>32</sup> ) <sup>3</sup> + 2501550035 * (2 <sup>32</sup> ) <sup>2</sup> + 3243814879 * (2 <sup>32</sup> ) <sup>1</sup> + 4035623136 * (2 <sup>32</sup> ) <sup>0</sup> <br><br>  So, <i><b>BigInteger</b></i> will be represented by a pair: <br><br>  <b>_sign = -1 // number sign</b> <b><br></b>  <b>_bits = {4035623136, 3243814879, 2501550035, 15}</b> <br><br>  A number that fits in the int range, say, 17 will be stored as follows: <br><br>  <b>_sign = 17</b> <b><br></b>  <b>_bits = null</b> <br><br>  Examining the constructors of the structure <i><b>BigInteger</b></i> can be concluded: <br><br><ol><li>  if the number is placed in the int range, then it is stored in the _sign variable; </li><li>  if the number does not fit into the int range, then its sign is stored in the _sign variable (-1 for negative and 1 for positive), and the _bits array contains the coefficients a <sub>i of the</sub> long number decomposition with base 2 <sup>32</sup> . </li></ol>  The base Œ≤ = 2 <sup>32</sup> is a good choice, since it is easier to work at a low level with a power of two (multiplying and dividing by a power of two corresponds to bit shifts left and right), and as many as 32 digits of the number will be processed at a time, which allows you to quickly perform operations on them. <br><br>  In general, the <i><b>BigInteger</b></i> structure is a complete implementation of long arithmetic on the .NET platform.  At the same time, Microsoft tried to bring it as close as possible to primitive numeric types: the <i><b>BigInteger</b></i> instance can be used just like any other integer type.  <i><b>BigInteger</b></i> overloads standard numeric operators to perform basic mathematical operations, such as addition, subtraction, division, multiplication, subtraction, negation, and unary negation.  You can also use standard numeric operators to compare two BigInteger values ‚Äã‚Äãwith each other.  Like other integer types, <i><b>BigInteger</b></i> supports the bit operators And, Or, XOR, left shift and right shift. <br><br>  For languages ‚Äã‚Äãthat do not support custom operators, the <i><b>BigInteger</b></i> structure also provides equivalent methods for performing mathematical operations.  This applies to the methods Add, Divide, Multiply, Negate, Subtract and some others.  Similarly, Microsoft has arrived in the implementation of the <i><b>Decimal</b></i> structure. <br><br>  Many members of the <i><b>BigInteger</b></i> structure directly correspond to members of other integer types.  In addition, <i><b>BigInteger</b></i> adds such elements as: <br><br><ul><li>  IsEven - determines if the number is even; </li><li>  IsPowerOfTwo - determines whether the number is a power of two; </li><li>  Sign - returns a value indicating the sign of the BigInteger number; </li><li>  Abs - returns the absolute value of the number BigInteger; </li><li>  DivRem - returns the quotient and the remainder of the division operation; </li><li>  GreatestCommonDivisor - returns the greatest common factor for two numbers; </li><li>  Log - returns the logarithm of the specified number in the number system with the specified base; </li><li>  Max / Min - returns the largest / smallest of two numbers; </li><li>  ModPow - performs modular division of a number raised to the power of another number; </li><li>  Pow - raises the value of BigInteger to the specified degree. </li></ul><br><h4>  A few words about BigInteger in Mono and Java </h4><br>  It should be noted that Mono also has the support of long arithmetic.  The implementation of the <i><b>BigInteger</b></i> structure in Mono is practically no different from the Microsoft implementation, except that there is no optimization for the numbers represented by the int type. <br><br>  That is, the number 17 in Mono will be represented by a pair: <br><br>  <b>_sign = 1 // number sign</b> <b><br></b>  <b>_bits = {17}</b> <br><br>  A similar implementation of <i><b>BigInteger</b></i> is presented in Java: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigInteger</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Number</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigInteger</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> signum; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] mag; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bitCount = -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bitLength = -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lowestSetBit = -<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstNonzeroByteNum = -<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstNonzeroIntNum = -<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> LONG_MASK = <span class="hljs-number"><span class="hljs-number">0xffffffffL</span></span>; }</code> </pre><br>  Since Java lacks unsigned types, the mag array is of type int [].  Accordingly, the representation of a long number in Java and .NET will be different.  In .NET, the presentation will be slightly more efficient, since the uint type covers a larger range: <br><br><div class="spoiler">  <b class="spoiler_title">Constructor accepting long</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BigInteger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { signum = -<span class="hljs-number"><span class="hljs-number">1</span></span>; val = -val; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { signum = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> highWord = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(val &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (highWord == <span class="hljs-number"><span class="hljs-number">0</span></span>) { mag = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]; mag[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)val; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mag = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; mag[<span class="hljs-number"><span class="hljs-number">0</span></span>] = highWord; mag[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)val; } }</code> </pre></div></div><br>  In Java, as well as in Mono, there is no optimization for numbers represented by the type int. <br><br><h4>  BigInteger performance </h4><br>  When working with a long number of <i><b>BigInteger</b></i> , you need to remember about the potential problems associated with performance.  For example, the seemingly innocuous ++ operator can have a significant impact on performance: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; BigInteger num = BigInteger.Parse(<span class="hljs-string"><span class="hljs-string">"12345678910111213141516171819"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>; i &lt; length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsPrime(i)) num++; } Console.WriteLine(num);</code> </pre><br>  Although it seems that in this example the value of an existing object changes, it is not.  <i><b>BigInteger</b></i> objects are immutable, that is, internally, the common language runtime actually creates a new <i><b>BigInteger</b></i> object and assigns it a value one greater than the previous one. <br><br>  In this example, you can do the following: perform intermediate operations using ordinary numeric types, and then use <i><b>BigInteger</b></i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; BigInteger num = BigInteger.Parse(<span class="hljs-string"><span class="hljs-string">"12345678910111213141516171819"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> temp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>; i &lt; length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsPrime(i)) temp++; } num += temp; Console.WriteLine(num);</code> </pre><br>  Other .NET Framework numeric types are also immutable.  However, since the <i><b>BigInteger</b></i> type does not have an upper or lower limit, its values ‚Äã‚Äãcan grow to very large values ‚Äã‚Äãand have a measurable impact on performance. <br><br><h4>  Instead of conclusion </h4><br>  Summarizing, we can say that the .NET platform, starting with version 4, has acquired a full-fledged implementation of <i>integer</i> long arithmetic.  Perhaps, for complete happiness, it remains to implement the structure of <a href="http://bcl.codeplex.com/wikipage%3Ftitle%3DBigRational%26referringTitle%3DDocumentation"><i><b>BigRational</b></i></a> , which has long been present in beta status in .NET BCL. <br><br>  <i><b>BigRational</b></i> structure <i><b>description</b></i> : The <i><b>BigRational</b></i> structure <i><b>is</b></i> based on the <i><b>BigInteger</b></i> type that was introduced in the .NET Framework 4 and allows you to create rational numbers of arbitrary precision.  A rational number is a ratio of two integers, and in this implementation of the <i><b>BigRational</b></i> structure, the <i><b>BigInteger</b></i> type is used as the dividend (numerator) and divisor (denominator) type. <br><br>  Thanks for the remark users: <a href="https://habrahabr.ru/users/gouranga/" class="user_link">gouranga</a> </div><p>Source: <a href="https://habr.com/ru/post/207754/">https://habr.com/ru/post/207754/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207744/index.html">HD video from a private satellite SkySat</a></li>
<li><a href="../207746/index.html">0day * vulnerability to the New Year: ICQ, Ebay, Forbes, PayPal and AVG</a></li>
<li><a href="../207748/index.html">FaceRig - character animation in real time</a></li>
<li><a href="../207750/index.html">Let's fix NAs</a></li>
<li><a href="../207752/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 89 (December 22 - 28, 2013)</a></li>
<li><a href="../207756/index.html">Elections OS</a></li>
<li><a href="../207758/index.html">NSA does not cope with traffic volumes</a></li>
<li><a href="../207760/index.html">How freshman Cauchy's definition has reduced</a></li>
<li><a href="../207762/index.html">January 2, 2014 the Blender project will be 20 years old</a></li>
<li><a href="../207764/index.html">Melange - DSL for Network Protocols</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>