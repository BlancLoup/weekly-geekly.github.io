<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MikroTik and blocking unwanted sites (for example, youtube and facebook)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was encouraged to write this article by the fact that the older child, at night, instead of going to bed, looking at your smartphone on any videos o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MikroTik and blocking unwanted sites (for example, youtube and facebook)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/kp/33/te/kp33tesmmhj-ac_l0r5e89h3maw.jpeg"><br><br>  I was encouraged to write this article by the fact that the older child, at night, instead of going to bed, looking at your smartphone on any videos on youtube until late at night, as well as replacing the home router with TP-Link TL-WR1043ND on MikroTik RB951G -2HnD. <br><a name="habracut"></a><br>  Having studied the Internet, I stumbled upon a presentation from 2017 on the microtic channel in YouTube.  It described how not to do and how to do it correctly.  Perhaps for many advanced users of MikroTik and RouterOS this will not be a revelation, but I hope that it will help novice users, like me, not to get lost in the wilds of the options offered on the Internet. <br><br>  Let's start with the often proposed option on the Internet ( <b>so do not do it !!!</b> ): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">‚óè /ip firewall layer7-protocol add name=youtube regexp=<span class="hljs-string"><span class="hljs-string">"^.+(youtube).*$"</span></span> add name=facebook regexp=<span class="hljs-string"><span class="hljs-string">"^.+(facebook).*$"</span></span> ‚óè /ip firewall filter add action=drop chain=forward layer7-protocol=facebook add action=drop chain=forward layer7-protocol=youtube</code> </pre> <br>  This solution has the following disadvantages: high load on cpu, increased latency, packet loss, youtube and facebook are not blocked. <br><br>  Why it happens?  Each connection is checked again and again, Layer7 is checked in the wrong place, which leads to checking all the traffic. <br><br><h3>  Correct solution </h3><br>  Create a regular expression rule for Layer7: <br><br><pre> <code class="bash hljs">‚óè /ip firewall layer7-protocol add name=youtube regexp=<span class="hljs-string"><span class="hljs-string">"^.+(youtube).*$"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/ws/oc/qi/wsocqi2uofaxdzpyzopaljhlsxo.png"><br><br>  I have only blocked YouTube, if you need a facebook or something else, it creates separate rules <br><br><pre> <code class="bash hljs">add name=facebook regexp=<span class="hljs-string"><span class="hljs-string">"^.+(facebook).*$"</span></span></code> </pre> <br>  You can create rules for other video streaming services, here is one of the options: <br><br><pre> <code class="bash hljs">regexp=‚Äù^.*youtube.com|youtu.be|netflix.com|vimeo.com|screen.yahoo.com|dailyMotion.com|hulu.com|twitch.tv|liveleak.com|vine.co|break.com|tv.com|metacafe.com|viewster.com).*$‚Äù</code> </pre> <br>  Next, create rules for labeling connections and packages: <br><br><pre> <code class="bash hljs">‚óè /ip firewall mangle add action=mark-connection chain=prerouting protocol=udp dst-port=53 connection-mark=no-mark layer7-protocol=youtube new-connection-mark=youtube_conn passthrough=yes add action=mark-packet chain=prerouting connection-mark=youtube_conn new-packet-mark=youtube_packet</code> </pre> <br><img src="https://habrastorage.org/webt/dr/6t/ao/dr6taoteeod_glxk856fzz3kxgq.png"><br><br><img src="https://habrastorage.org/webt/mm/ic/_i/mmic_is7mesjcb6m-d32rknjmjo.png"><br><br>  and rules for firewall filter: <br><br><pre> <code class="bash hljs">‚óè /ip firewall filter add action=drop chain=forward packet-mark=youtube_packet add action=drop chain=input packet-mark=youtube_packet</code> </pre> <br><img src="https://habrastorage.org/webt/kc/ev/_1/kcev_1fvonj161k8ril5xz8hmf8.png"><br><br><img src="https://habrastorage.org/webt/cr/gy/ns/crgynsgkswduttbf2vrp9pk62ac.png"><br><br>  In my home network, static ip-addresses are distributed via dhcp, so I applied the filter to the child's ip-address of the smartphone, you can create a group of addresses and apply to it.  Go to the menu <b>IP&gt; Firewall&gt; AddressList,</b> click the <b>Add</b> button, enter the name of the group and do not forget to fill in the list of addresses to block. <br><br>  Next, go to the <b>IP&gt; Firewall&gt; Mangle</b> menu, select our <i>mark_connection</i> and <i>mark_packet</i> and in the <i>Src</i> field <i>.</i>  <i>Address we</i> drive in blocked ip or group. <br><br><img src="https://habrastorage.org/webt/qg/cr/xx/qgcrxx6tzlwxknramhoh6kfbxf4.png"><br><br>  Everything, the device was left without YouTube, tough, but necessary for educational purposes. <br><br>  You can also apply these rules on a schedule. <br><br>  I would be happy for comments and corrections if you notice any inaccuracies, because  This is my first article on Habr√©.  According to the materials channel MikroTik on Youtube.  <b>Attention, this article is not about how to limit access to the child to the Internet, restricting access to YouTube is just an example.</b>  <b>An article about one of the ways to restrict access to unwanted resources.</b> <br><br>  <b>Updt1,</b> from <a href="https://habrahabr.ru/users/avelor/" class="user_link">avelor</a> , block by mac: <br><pre> <code class="bash hljs"> ‚óè /ip firewall filter add chain=input src-mac-address=aa:bb:cc:dd:ee:ff action=drop add chain=forward src-mac-address=aa:bb:cc:dd:ee:ff action=drop</code> </pre> <br>  You can block in dhcp - make a lease and click block access </div><p>Source: <a href="https://habr.com/ru/post/346052/">https://habr.com/ru/post/346052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346036/index.html">The first set of "network" software bots from Juniper Networks</a></li>
<li><a href="../346038/index.html">Parsing with ANTLR 4 T-SQL snapshots to get connections between tables</a></li>
<li><a href="../346042/index.html">5-minute guide to esoteric programming languages: why they are needed</a></li>
<li><a href="../346048/index.html">[Translation] IOHIDeous - New Year's zero-day vulnerability from macOS</a></li>
<li><a href="../346050/index.html">Wake up, and your application is on the main in the App Store</a></li>
<li><a href="../346054/index.html">Performance consoles and shells</a></li>
<li><a href="../346058/index.html">Outputting tabular data to the console, file or MS Excel in the style of C ++ threads</a></li>
<li><a href="../346062/index.html">IaaS for non-IT companies: 10 answers to director's questions</a></li>
<li><a href="../346064/index.html">How to build a community. Translation of the book "Social Architecture": Preface. Crowd wisdom</a></li>
<li><a href="../346066/index.html">Github flow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>