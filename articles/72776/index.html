<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a live usb for backup / restore system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every time when I had to make a backup of the system, I looked for an unused USB flash drive, which I downloaded to the ArchLinux installation image a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a live usb for backup / restore system</h1><div class="post__text post__text-html js-mediator-article">  Every time when I had to <a href="http://welinux.ru/post/762/">make a backup of the system,</a> I looked for an unused USB flash drive, which I downloaded to the ArchLinux installation image and loaded into it.  This method was a very unpleasant moment - I had to look for an unused <strong>USB flash drive with a size of&gt; 512 MiB</strong> , despite the fact that a 64 MB SD card was always at hand, which would be enough for backup and recovery needs.  But there was one problem with the SD card - a rare distribution could boot from it on my Eee PC 900. After trying with a dozen different small distributions, none of which came up to me completely, I decided to make my live system. <a name="habracut"></a><br><br><h2>  Training </h2><br><h3>  What you need: </h3><br><ul><li>  USB Flash Drive or SD / MMC / CF / ... memory card </li><li>  A working Linux system, preferably with a complete set for compilation or with any package manager </li><li>  Linux kernel that does not require additional modules to work </li></ul>  The size of the carrier does not matter - the smallest memory card I could find was 64 megabytes in size, which is more than enough to create a full-fledged backup / restore system. <br>  As for the kernel, I use my own kernel, in which the necessary modules are compiled, and the initrd support is disabled.  If you already have a kernel that does not require additional modules for working with disks, you can use it.  If you don‚Äôt have such a kernel, download the kernel source code from <a href="">kernel.org</a> and <a href="">build</a> it manually.  In this article I will not describe how to build the kernel. <br>  We agree that the flash drive device is / dev / sdc. <br><br><h4>  Busybox </h4><br>  I just want to say that I used BusyBox, a utility that replaces a very large set of other utilities, albeit with a slightly reduced functionality.  Its focus is that, depending on how you launch it, this is how it will behave.  For example, if you make a symbolic link to busybox with the name ln, then we get ln.  If the link is called dd, we get dd.  With a weight of 1.5 megabytes and no dependencies - this is just a miracle. <br>  If you run busybox without parameters, you will see a list of utilities available in your version, whose functions can be replaced by busybox.  If the size is very important to you, then you can compile BusyBox from source, disabling unnecessary functionality and thereby reducing the size of the binary file.  I used a ready package from repositories. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Device preparation: </h3><br>  Using fdisk, create one partition on the flash drive device and make it bootable. <br> <code>fdisk /dev/sdc</code> <br>  <strong>First delete all partitions on this device</strong> .  Most likely there is only one partition, so type d once.  <strong>Then create a new primary partition</strong> .  Press <strong>n</strong> , <i>[Enter]</i> , <strong>p</strong> , <i>[Enter]</i> , <strong>1</strong> , <i>[Enter]</i> , <i>[Enter]</i> , <i>[Enter]</i> .  Make this partition bootable - enter <strong>a</strong> .  To write a new partition table to the device - press <strong>w</strong> . <br>  Now create a new file system on the first partition of the flash drive.  I chose Ext2 as a file system - its support has been around for a long time, and journaling in this kind of system does not make much sense.  To format a partition in Ext2, run the following command: <br> <code>mke2fs -m 0 -N 2000 /dev/sdc1</code> <br>  <strong>-m 0</strong> will disable space reservations (whatever that means) <br>  <strong>-N 2000</strong> will provide enough <a href="http://ru.wikipedia.org/wiki/Inode">inods</a> . <br><br><h2>  We collect system </h2><br>  Mount the new partition in a separate directory (for example, / newroot): <br> <code>mkdir /newroot <br> mount /dev/sdc1 /newroot</code> <br>  Every Linux distribution has a set of required directories.  Create the following directories: <br> <code>/bin <br> /boot <br> /dev <br> /etc <br> /proc <br> /sbin <br> /var</code> <br>  Optional are / sys, / lib, / var, / mnt, / usr and / home - you can create them later if they become necessary. <br><br><h3>  / dev </h3><br>  First, fill in the / dev directory with the necessary devices.  These are console, kmem, mem, null, ram0 and tty1.  Copy them directly from your working system using <code>cp -dpR /dev/DEVICE /newroot/dev</code> where DEVICE is each of the above devices.  The -dpR options ensure that the files themselves are copied, not their contents, and also retain all access rights to them.  If you don‚Äôt like this way - you can make it more time consuming, but perhaps a more correct way - with the help of <strong>ls -l,</strong> find out the main and smaller numbers of each device and create them with the help of <strong>mknod</strong> . <br>  In addition to the above-mentioned mandatory devices, also copy your hard disk devices ( <i>hd *</i> and <i>sd *</i> ), as well as a dozen terminal devices ( <i>tty *</i> ).  You may also need <i>loop *</i> .  Copy the rest of the device files as needed. <br><br><h3>  / etc </h3><br>  System settings should be stored in this directory.  The required files here will be rc (in different systems called differently), inittab, fstab, passwd, group and shadow.  Although, the group may not be mandatory, but I did not try to verify this. <br>  After you copy these files to your new system, you will need to edit the following files: <br><br>  <strong>inittab</strong> - runs it / bin / init.  It determines the behavior of the system at different levels of performance.  You can read more about the format of entries in the inittab file in <code>man inittab</code> However, there is a very important point: unlike the standard inittab, the version for busybox should not contain the <em>id</em> and <em>runlevel</em> fields.  My primitive inittab looks like this: <blockquote>  # / etc / inittab <br><br>  :: sysinit: / etc / rc <br><br>  # Spawn some gettys <br>  :: respawn: / sbin / getty -L 115200 tty1 vt100 <br>  :: respawn: / sbin / getty -L 115200 tty2 vt100 <br>  :: respawn: / sbin / getty -L 115200 tty3 vt100 <br>  :: respawn: / sbin / getty -L 115200 tty4 vt100 <br><br>  # Stuff to restarting the init process <br>  :: restart: / sbin / init <br><br>  # Stuff to do before rebooting <br>  :: ctrlaltdel: / sbin / reboot </blockquote><br><br>  <strong>fstab</strong> - everything is as usual here.  Just specify as a root system not your hard disk, but a flash drive. <br><br>  <strong>passwd</strong> and <strong>shadow</strong> - in these files, leave only an entry for root.  The rest you do not need.  In addition, you may want to change the default home directory and shell.  Usually / bin / bash or / bin / zsh is registered as a shell, but in busybox there is only primitive sh.  Of course, no one bothers to make a symbolic link bash -&gt; sh. <br><br>  <strong>rc</strong> is a boot script written in your inittab.  It can be super complex and include other rc scripts, but for simple systems it can be greatly simplified (example of my rc): <blockquote>  #! / bin / sh <br><br>  # Uncomment next line, if you have <br>  # / etc / rc.conf <br><br>  PS1 = [rescue-system]: <br>  PATH = / sbin: / bin: / usr / bin <br><br>  / bin / mount -av <br>  / bin / hostname localhost </blockquote><br><br><h3>  / bin </h3><br>  Busybox is installed in this directory.  This can be achieved in different ways.  For example, if you build it manually, then add the parameter --prefix = / newroot during configuration.  If you are using the package manager, then read the help for it - there should be an option that allows you to specify the root directory for the package being installed.  For example, in ArchLinux, in pacman this is the key -r: <br>  <code>pacman -S busybox -r /newroot -b /var/lib/pacman</code> The -b parameter is required because pacman cannot find the package base inside / newroot. <br>  After installation, go to the / newroot / bin directory.  Run busybox and decide which built-in utilities you need and which ones don't.  For each of the utilities, make a symbolic link to the busybox with the corresponding utility name.  For example: <blockquote>  ln -s ./busybox ./cd </blockquote>  Be sure to make links with the names sh, login and mount! <br><br><h3>  / sbin </h3><br>  Go to this directory and create the necessary links to ../bin/busybox.  In general, the division into two directories - / bin and / sbin - in this system does not make much sense, since the user is only one, and that root. <br>  Be sure to make links with the names init, getty, poweroff, shutfown, reboot, halt! <br><br><h3>  / boot </h3><br>  In this directory, copy only your kernel and name it vmlinuz. <br><h2>  Install GRUB </h2><br>  Installing the GRUB bootloader is done with the grub-install command: <br> <code>grub-install --root-directory=/newroot /dev/sdc1</code> <br>  After the installation is complete, create a simple GRUB menu file (/boot/grub/menu.lst): <br><blockquote>  title boot rescue blob <br>  root (hd0,0) <br>  kernel / boot / vmlinuz rootdelay = 6 root = / dev / sdc1 rw </blockquote><br>  In the root line, you may have to change the device, but on my Eee PC 900, when selecting the boot from the memory card in the BIOS, GRUB identified it that way. <br>  In addition, an important parameter is rootdelay - without it, the kernel did not have time to find the device of the card reader and I received: <br><blockquote>  Kernel Panic: VFS: Unable to mount root fs on / dev / sdc </blockquote><br><br><h2>  Conclusion </h2><br>  That's all.  Now you can reboot and try out the new system.  Of course, with BusyBox you are unlikely to get a super functional system, but the system will be capable of much in terms of operating system maintenance.  In addition, since this version of live-OS does not use compressed images of the file system, then all the changes that you make to it will remain after the reboot, so you can safely supplement the functionality with scripts right during use and not be afraid to lose your work. <br>  Of course, there is a lot more that can be optimized, and I will gradually deal with this, however, the system is quite ready for basic backup disk creation and restoration. <br><br>  Reference materials: <br>  <a href="http://www.kernel.org/pub/linux/kernel/people/gregkh/lkn/lkn_pdf/ch09.pdf">Documentation of the kernel boot command line options</a> , <a href="http://www.tldp.org/HOWTO/Bootdisk-HOWTO/buildroot.html">Old Linux boot disk creation instructions</a> . <br><br>  This is a cross-post with <a href="http://welinux.ru/post/1716/">welinux.ru</a> </div><p>Source: <a href="https://habr.com/ru/post/72776/">https://habr.com/ru/post/72776/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72768/index.html">Obder.ru - Accounting for the payment of meals and any common expenses</a></li>
<li><a href="../72769/index.html">Every man to his own taste</a></li>
<li><a href="../72773/index.html">Empty text nodes in Internet Explorer</a></li>
<li><a href="../72774/index.html">The first photos of the Android-smartphone HTC Dragon</a></li>
<li><a href="../72775/index.html">RIA Platform Overview</a></li>
<li><a href="../72778/index.html">Augmented reality is closer than it seems</a></li>
<li><a href="../72779/index.html">Acer 5738ZG</a></li>
<li><a href="../72780/index.html">Programming for AVR in Ubuntu</a></li>
<li><a href="../72781/index.html">Start of the 2nd stage of the National vote Runet Award 2009</a></li>
<li><a href="../72784/index.html">How to come up with an algorithm?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>