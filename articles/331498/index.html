<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fighting spam on hosting. Setup EFA Project Free Spam / antivirus filter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, as promised , we want to share our experience in dealing with spam. It is known that any cause has a consequence. This phrase express...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fighting spam on hosting. Setup EFA Project Free Spam / antivirus filter</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://trello-attachments.s3.amazonaws.com/58d3ccb0d0b0255bd1b81750/59147b2e3723806bab861dff/36ad405f3790208d93ef17da94a1ccd1/Hab-2.jpg" alt="image"></p><br><p>  In this article, <a href="https://habrahabr.ru/post/327588/">as promised</a> , we want to share our experience in dealing with spam.  It is known that any cause has a consequence.  This phrase expresses one of the philosophical forms of communication phenomena. </p><br><p>  Our reason was repeated complaints about spam emanating from our hosting and VPS clients.  It is not always possible to say with certainty whether it was the deliberate actions of customers or they themselves did not suspect that they were the victim of spam bots.  Whatever it was, the problem had to be solved. <a name="habracut"></a></p><br><p>  Spam do not like.  Spam leaves a ‚Äúblack spot‚Äù on the provider‚Äôs face when his IP addresses are added to blacklists, which all clients suffer from.  Removing IP from blacklist is a special conversation.  But this is one side of the coin.  If it is possible to return the reputation to an IP address, then it is much more difficult to return the company's reputation and trust. </p><br><p>  We decided to find a solution and implement the Unihost complex to protect and prevent unwanted mailings.  After brainstorming and discussions, they began to check and compare what the SPAM / AV community can offer. </p><br><p>  There are many options on the market.  However, the majority of quality solutions are paid with a tariff of 1 license for 1 server or even for the number of outgoing / incoming emails, which would increase the cost of tariffs.  Therefore, choose only among opensource. </p><br><h2 id="populyarnye-opensource-resheniya-protiv-spama">  Popular opensource anti-spam solutions </h2><br><h3 id="rspamd">  Rspamd </h3><br><p>  It is suitable for systems of various sizes.  It can integrate into various MTAs (Exim, Postfix, Sendmail and Haraka are described in the documentation) or work in the SMTP proxy mode. </p><br><p>  The message rating system is the same as in SpamAssassin, in particular, based on various factors: regular expressions, DNS block lists, white, gray, blacklists, SPF, DKIM, statistics, hashes (fuzzy hashes) and other things - they are used only other algorithms. </p><br><p>  Rspamd supports plugin extensions. </p><br><h3 id="apache-spamassassin">  Apache SpamAssassin </h3><br><p>  Fame SA gained through the use of Bayesian filtering technology.  Each message when passing tests receives a certain score and is placed in spam when the threshold is reached. </p><br><p>  Easily integrates with almost any email service.  In SA, popular technologies are available that connect as plugins: DNSBL, SPF, DKIM, URIBL, SURBL, PSBL, Razor, RelayCountry, automatic white list (AWL) and others. </p><br><p>  Installation is generally not complicated.  After installing SpamAssassin requires fine-tuning parameters and training on spam letters. </p><br><h3 id="assp">  ASSP </h3><br><p>  A platform-dependent SMTP proxy server that accepts messages prior to the MTA and analyzes it for spam. </p><br><p>  All popular technologies are supported: white and gray lists, Bayesian filter, DNSBL, DNSWL, URIBL, SPF, DKIM, SRS, virus scan (with ClamAV), blocking or replacing attachments and much more.  Detected encoded MIME spam and images (using Tesseract).  The possibilities are expanded with the help of modules. </p><br><p>  Project documentation is not always intelligible, and the instructions are often outdated, but with some experience you can figure it out. </p><br><h3 id="mailscanner">  Mailscanner </h3><br><p>  MailScanner is an all-inclusive solution for dealing with phishing emails and checking mail for viruses and spam.  It analyzes the content of the letter, blocking attacks aimed at email clients and HTML tags, checks attachments (forbidden extensions, double extensions, encrypted archives, etc.), controls the substitution of the address in the letter and much more. </p><br><p>  MailScanner easily integrates with any MTA, there are ready-made configuration files in the delivery.  In addition to his own work, he can use third-party solutions.  SpamAssassin can be used to check for spam. </p><br><h3 id="efa-project">  EFA-project </h3><br><p>  There is another open source project - ‚ÄúeFa-project‚Äù - Email Filter Appliance.  EFA was originally designed as a virtual device to work on VMware or HyperV.  The program uses ready-made MailScanner, Postfix, SpamAssasin packages (the entire list below) to stop spam and viruses, and they are already installed and configured to work properly in vm.  This means that crutches are not needed - everything works out of the box. </p><br><p>  <strong>EFA includes the following components:</strong> </p><br><p>  <a href="http://www.postfix.org/">Postfix</a> is a MTA (mail transfer agent) - reliable, fast, proven over the years; <br>  Kernel spam filter - <a href="https://www.mailscanner.info/">MailScanner</a> - shoulder to shoulder with antivirus take the whole blow; <br>  Spam filter - <a href="http://spamassassin.apache.org/">SpamAssassin</a> - identifies spam emails.  The basis includes a variety of evaluation systems, MTA and sets of regular expressions; <br>  <a href="http://www.clamav.net/">ClamAV</a> - antivirus that works with MailScanner; <br>  <a href="http://mailwatch.org/">MailWatch</a> - a convenient web interface for working with MailScanner and other applications; <br>  Content <a href="http://www.rhyolite.com/dcc/">Filtering</a> - <a href="http://www.rhyolite.com/dcc/">DCC</a> - determines the mass mailing by sending the hash sums of the body of letters to a special server, which in turn provides the answer in the form of the number of hashes received.  If the number exceeds the threshold score = 6, the letter is considered spam; <br>  <a href="https://pyzor.readthedocs.io/en/release-1-0-0/index.html">Pyzor</a> and <a href="http://razor.sourceforge.net/">Razor</a> - help SpamAssassin more accurately recognize spam using spam detection networks; <br>  <a href="http://sqlgrey.sourceforge.net/">SQLgrey</a> is used for gray-listing - postfix policy service, which allows reducing the amount of spam that can be received by recipients; <br>  For image recognition, the <a href="http://pralab.diee.unica.it/imageCerberus">ImageCeberus</a> module is <a href="http://pralab.diee.unica.it/imageCerberus">used</a> ‚Äî identifies porn images, etc. <br>  We chose EFA, because the project includes all the best features of the above.  In addition, our administrators have already had some experience with it, so the choice was stopped on the EFA.  We proceed to the description of the installation. </p><br><h2 id="ustanovka-i-posleduyuschaya-nastroyka-efa">  Install and configure EFA </h2><br><p>  They decided to install on a VPS with pure CentOS 6.8 x64, which acts as a relay-server.  First of all, you need to update all system utilities and components to the latest versions that are available in the repositories.  To do this, use the command: </p><br><pre><code class="bash hljs">yum -y update</code> </pre> <br><p>  Then install the wget and screen utilities if they have not been installed: </p><br><pre> <code class="bash hljs">yum -y install wget screen</code> </pre> <br><p>  After that, download the script that installs the EFA: </p><br><pre> <code class="bash hljs">wget https://raw.githubusercontent.com/EFA/v3/master/build/prepare-build-without-ks.bash</code> </pre> <br><p>  We give the script the right to execute: </p><br><pre> <code class="bash hljs">chmod +x ./prepare-build-without-ks.bash</code> </pre> <br><p>  Run the screen: </p><br><pre> <code class="bash hljs">screen</code> </pre> <br><p>  And run the script: </p><br><pre> <code class="bash hljs">./prepare-build-without-ks.bash</code> </pre> <br><p>  Now you can minimize our screen using the Ctrl + A + D combination. </p><br><p>  After installation, you need to re-enter the server via ssh, using the data for the first login.  This is needed to run the initialization script and initial configuration of the EFA. </p><br><p>  After logging in, the system prompts you to answer a few questions in order to configure the EFA. </p><br><p>  The list of questions is as follows: </p><br><table><thead><tr><th>  Function </th><th>  Property </th></tr></thead><tbody><tr><td>  Hostname </td><td>  Specified by the hostname of the machine </td></tr><tr><td>  Domainname </td><td>  Domain to which the machine belongs.  In total with a hostname, the full FQDN of the server will turn out </td></tr><tr><td>  Adminemail </td><td>  Administrator's box that will receive letters from the system itself (available updates, various reports, etc.) </td></tr><tr><td>  Postmasteremail </td><td>  The mailbox of the person who will receive emails that are related to the MTA </td></tr><tr><td>  IP address </td><td>  IP address of the machine </td></tr><tr><td>  Netmask </td><td>  Mask </td></tr><tr><td>  Default gateway </td><td>  Gateway </td></tr><tr><td>  Primary DNS </td><td>  Primary DNS server </td></tr><tr><td>  Secondary DNS </td><td>  Secondary DNS server </td></tr><tr><td>  Local user </td><td>  Login local administrator.  Used to log in to the MailWatch web interface. </td></tr><tr><td>  Local User Password </td><td>  Password </td></tr><tr><td>  Root password </td><td>  Root password </td></tr><tr><td>  VMware tools </td><td>  It will be displayed only if the installation takes place on a virtual machine running VMware.  It is required to install VMware tools. </td></tr><tr><td>  UTC Time </td><td>  If your machine is in the UTC time zone, you must select Yes </td></tr><tr><td>  Timezone </td><td>  Here you can select a different time zone that is different from UTC. </td></tr><tr><td>  Keyboard Layout </td><td>  Keyboard layout to be used in the system </td></tr><tr><td>  IANA Code </td><td>  Here the code of the country in which the machine is located.  This is necessary in order to determine from which mirrors updates will be downloaded in the future. </td></tr><tr><td>  Your mailserver </td><td>  Individual parameter.  Used if EFA is working and receiving letters </td></tr><tr><td>  Your organization name </td><td>  Name of the organization.  Used for headings in letters </td></tr><tr><td>  Auto Updates </td><td>  Sets the auto-update policy.  The default is disabled.  In this case, there will be no auto-updates, but notifications about available updates will be sent to the admin email. </td></tr></tbody></table><br><p>  After such a questionnaire, the entire list of answers is displayed.  If you need to change something, dial the question number and enter new data.  When we are ready to move on, type OK and press Enter.  The system will start the autotune process. </p><br><p><img src="https://i.imgur.com/gXryxeh.png" alt="image"></p><br><p>  Upon completion of the configuration, the system will reboot and be fully operational. </p><br><p>  Next time, logging in via ssh, the EFA configuration menu is displayed immediately.  There are many useful actions in this menu: </p><br><ul><li>  System reboot / shutdown; </li><li>  Change network settings; </li><li>  MailScanner setup; </li><li>  Turn on / off gray-listing; </li><li>  Enable / disable auto-update; </li><li>  Setting up the system as an outgoing relay-server; </li><li>  Change Adminemail box; </li><li>  Add / remove mail domains; </li><li>  Change spam filter settings; </li><li>  Recover mysql database in case of damage due to emergency shutdown. </li></ul><br><p>  This is a list of the main EFA options that cannot be edited through the MailWatch web interface.  Therefore, it is good to know where to find them. </p><br><h2 id="ruchnaya-nastroyka-efa">  Manual EFA Setup </h2><br><p>  We went a difficult way, but more flexible.  Customization of EFA for themselves was done not through an interactive menu, but the configuration files ruled.  We wanted not just to set everything up, but also to understand all the components and understand what worked and how. </p><br><p>  First of all, in the main.cf file of postfix settings, added mynetworks, from which SMTP connections were received.  Then they wrote down restrictions on helo requests, senders, recipients, and indicated the paths to maps with ACCEPT or REJECT policies, subject to certain conditions.  Also, inet_protocols was changed to ipv4 to eliminate ipv6 connections. </p><br><p>  Then changed the Spam Actions policy to Store in the configuration file /etc/MailScanner/MailScanner.conf.  This means that if the letter is identified as spam, it will go to quarantine.  This helps to further train SpamAssassin. </p><br><p>  After these settings, we encountered the first problem.  Thousands of emails from you@example.com, fail2ban@example.com, root@localhost.localdomain, etc. have fallen upon us.  Recipients were similar.  We also received letters sent by MAILER-DAEMON, that is, in fact, without a sender. </p><br><p>  As a result, we received a clogged queue without the possibility of finding normal, non-spam letters among the ‚Äúred canvas‚Äù.  We decided to make a REJECT of such letters using standard Postfix card functionality: helo_access, recipient_access, sender_access.  Now the harmful recipients and the like have become successfully REJECT'itsya.  And those letters that were sent to MAILER-DAEMON are filtered by helo requests. </p><br><p>  When the queue was cleared, and our nerves calmed down, we began to set up SpamAssassin. </p><br><h3 id="obuchenie-spamassassin">  SpamAssassin Training </h3><br><p>  Learning SpamAssassin is done on emails that have already fallen into spam.  There are two ways to do this. </p><br><h4 id="cherez-veb-interfeys">  Via web interface </h4><br><p>  The first method is via the MailWatch web interface.  In each letter, you can see the headlines, the body, as well as evaluation by the Bayes algorithm and other indicators.  It looks like this: </p><br><table><thead><tr><th>  Score </th><th>  Matching rule </th><th>  Description </th></tr></thead><tbody><tr><td>  -0.02 </td><td>  Awl </td><td>  Adjusted score from AWL reputation of From: address </td></tr><tr><td>  0.80 </td><td>  BAYES_50 </td><td>  Bayes spam probability is 40 to 60% </td></tr><tr><td>  0.90 </td><td>  DKIM_ADSP_NXDOMAIN </td><td>  No valid authorization signature and domain not in DNS </td></tr><tr><td>  0.00 </td><td>  HTML_MESSAGE </td><td>  HTML included in message </td></tr><tr><td>  1.00 </td><td>  KAM_LAZY_DOMAIN_SECURITY </td><td>  Sending domain doesn‚Äôt have any anti-forgery methods </td></tr><tr><td>  0.00 </td><td>  NO_DNS_FOR_FROM </td><td>  Envelope sender has no MX or A DNS records </td></tr><tr><td>  0.79 </td><td>  RDNS_NONE </td><td>  Delivered to internal network rDNS </td></tr><tr><td>  2.00 </td><td>  TO_NO_BRKTS_HTML_IMG </td><td>  To: lacks brackets and HTML and one image </td></tr><tr><td>  0.00 </td><td>  WEIRD_PORT </td><td>  Uses non-standard port number for HTTP </td></tr></tbody></table><br><p>  Having opened the letter, you can put a check in the SA Learn checkbox and choose one of several actions: </p><br><ul><li>  As Ham - mark the letter as clean (training the Bayes algorithm); </li><li>  As Spam - mark the message as spam (Bayes algorithm training); </li><li>  Forget - skip the letter; </li><li>  As Spam + Report - mark the message as spam and send information about it in the network for spam detection (razor + pyzor); </li><li>  As Ham + Revoke - mark a message as clean and send information about it online to detect spam (razor + pyzor). </li></ul><br><h4 id="cherez-konsol">  Via console </h4><br><p>  This is done simply.  The command is as follows: </p><br><pre> <code class="bash hljs">sa-learn --ham /20170224/spam/0DC5B48D4.A739D</code> </pre> <br><p>  In this command, a letter with ID: 0DC5B48D4.A739D, which is in the archive of spam emails for a specific date / 20170224 / spam /, is marked as clean (not spam) <code>bash--ham</code> . </p><br><p>  There is an opinion that it is enough to train SpamAssassin only for effective mail filtering.  We decided to train SpamAssassin, feeding him absolutely all letters, both clean and spam.  In addition, we found a base of spam letters and gave SA to be torn apart. </p><br><p>  Such training helped to more accurately calibrate the Bayesian algorithm.  As a result, filtering is much more efficient.  We carry out such trainings when the mail traffic is not very high in order to have time to analyze and capture the maximum number of letters. </p><br><p>  In order for SpamAssassin to start working at full capacity, it needs to feed about 1000 different letters at the start.  So have patience and start training. </p><br><hr><br><p>  It is too early to talk about a complete victory over spam.  However, now the number of complaints about spam from our servers is zero.  Now we will not talk in more detail about the learning process itself ‚Äî I don‚Äôt want to disclose all the chips.  Although, if you dig deeper in the settings, it is not difficult to understand. </p><br><p>  PS: This article is not a panacea.  We just decided to share with you one of our methods of dealing with spam. </p><br><p>  All good and may the ham be with you!  :) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/331498/">https://habr.com/ru/post/331498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331486/index.html">Webinar: How will targeted cyber attacks develop?</a></li>
<li><a href="../331488/index.html">Thirteenth Developer Economics Survey</a></li>
<li><a href="../331490/index.html">How to stop looking for a good data center and start living</a></li>
<li><a href="../331494/index.html">Tables! Tables? Tables ...</a></li>
<li><a href="../331496/index.html">Milestones in the history of encryption and combat</a></li>
<li><a href="../331500/index.html">Autoencoders in Keras, Part 2: Manifold learning and latent variables</a></li>
<li><a href="../331502/index.html">Registration using telegram bot</a></li>
<li><a href="../331506/index.html">ECS (Elastic Cloud Storage) - Dell EMC Cloud Storage Platform</a></li>
<li><a href="../331508/index.html">What did Avito.iOS talk about? Report, Guest Reviews and Videos</a></li>
<li><a href="../331510/index.html">13 questions to find out if you are ready to hire a mobile development team</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>