<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pandasql vs Pandas for solving data analysis tasks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is it about? 
 In this article I would like to talk about the use of the python library Pandasql . 

 Many people confronted with data analysis t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pandasql vs Pandas for solving data analysis tasks</h1><div class="post__text post__text-html js-mediator-article"><h1>  What is it about? </h1><br>  In this article I would like to talk about the use of the python library <a href="https://pypi.python.org/pypi/pandasql">Pandasql</a> . <br><br>  Many people confronted with data analysis tasks are likely to be familiar with the <a href="http://pandas.pydata.org/">Pandas</a> library.  Pandas allows you to quickly and conveniently work with tabular data: filter, group, join on the data;  build pivot tables and even draw charts (for simple visualizations, the <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.plot.html">plot ()</a> function is sufficient, and if you want something more interesting, the <a href="http://pandas.pydata.org/pandas-docs/version/0.13.1/visualization.html">matplotlib</a> library will help).  On Habr√© more than once told about the use of this library to work with data: <a href="https://habrahabr.ru/post/266289/">one</a> , <a href="https://habrahabr.ru/post/196980/">two</a> , <a href="https://habrahabr.ru/post/202090/">three</a> . <br><br>  But in my experience, not everyone knows about the Pandasql library, which allows you to work with Pandas DataFrames as tables and access them using the SQL language.  In some tasks it is easier to express what you want with the help of the declarative SQL language, so I think that it is useful for people working with data to know about the presence of such functionality.  If we talk about real problems, then I used this library to solve the join problem of tables by fuzzy conditions (it was necessary to combine records of events from different systems at approximately the same time, a gap of about 5 seconds). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider the use of this library with specific examples. <br><a name="habracut"></a><br><h1>  Data for analysis </h1><br>  For illustration, I took data on the involvement of students of the Data Analyst Nanodegree specialization at Udacity.  This data is published in the <a href="https://www.udacity.com/course/intro-to-data-analysis--ud170">Intro to Data Analysis</a> course (I can recommend this course to anyone who wants to get acquainted with the use of the Pandas and Numpy libraries for data analysis, although the Pandasql library has not been reviewed at all). <br><br>  In the examples I will use 2 tables (for more information about the data, you can read <a href="">here</a> ): <br><br><ul><li>  <strong>enrollments</strong> : data on the entry to the "Data Analyst Nanodegree" specialization of a random subset of students; <br><ul><li>  <em>account key</em> : student ID; </li><li>  <em>join date</em> : the day the student enrolled in the specialization; </li><li>  <em>status</em> : student status at the time of data collection: "current" if the student is active, and "canceled" if he left the course; </li><li>  <em>cancel date</em> : the day the student left the course, None for active students; </li><li>  <em>is udacity</em> : takes True for test accounts in Udacity, for live users - False; </li></ul></li><li>  <strong>daily engagements</strong> : data on the activity of students from the table of <strong>enrollments</strong> for each day when they were recorded for specialization; <br><ul><li>  <em>acct</em> : student ID; </li><li>  <em>utc date</em> : date of activity; </li><li>  <em>total minutes visited</em> : the total number of minutes the student spent on the Data Analyst Nanodegree courses. </li></ul></li></ul><br><h1>  Examples </h1><br>  Now we can proceed to the consideration of examples.  It seems to me that it will be most vivid to show how to solve each of the tasks using the standard functionality of Pandas and Pandasql. <br><br>  First we need to do all the necessary imports and load the data from the csv files into DataFrames.  The full code of examples and source data can be found in the <a href="https://github.com/miptgirl/udacity_engagement_analysis/blob/master/pandasql_example.ipynb">repository</a> . <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandasql <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ps <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> seaborn daily_engagements = pd.read_csv(<span class="hljs-string"><span class="hljs-string">'./data/daily_engagement.csv'</span></span>) enrollments = pd.read_csv(<span class="hljs-string"><span class="hljs-string">'./data/enrollments.csv'</span></span>)</code> </pre> <br>  Import of the seaborn library is used only to make the graphics more beautiful, no special library functionality will be used. <br><br><h2>  Simple request </h2><br>  <strong>Task</strong> : to find the top 10 maximum student activities on a particular day. <br><br>  This example describes how to use filtering, sorting, and getting the first N objects.  To execute the SQL query, the <code>sqldf</code> function of the <code>sqldf</code> module is used, and the dictionary of local names <code>locals()</code> must also be passed to this function (for more information on using the functions of <code>locals()</code> and <code>globals()</code> in Pandasql, you can read on <a href="http://stackoverflow.com/questions/32032534/about-pandasql-locals-and-globals-method-issue">Stackoverflow</a> ). <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># pandas code top10_engagements_pandas = daily_engagements[['acct', 'total_minutes_visited', 'utc_date']] .sort('total_minutes_visited', ascending = False)[:10] # pandasql code simple_query = ''' SELECT acct, total_minutes_visited, utc_date FROM daily_engagements ORDER BY total_minutes_visited desc LIMIT 10 ''' top10_engagements_pandas = ps.sqldf(simple_query, locals())</span></span></code> </pre> <br>  <strong>Conclusion:</strong> The most diligent student spent more than 17 hours studying in one day. <br><br><img src="https://habrastorage.org/files/c62/d6d/c13/c62d6dc13e9e4d22839c3eaa4f10f502.png" alt="image"><br><br><h2>  Using aggregate functions </h2><br>  <strong>Task</strong> : I wonder if there is a weekly seasonality in students' activity (if judged by oneself, then usually there is not enough time for online courses on weekdays, but you can spend more time on weekends). <br><br>  First, add the "weekday" column to the original DataFrame, converting the date to the day of the week. <br><br><pre> <code class="python hljs">daily_engagements[<span class="hljs-string"><span class="hljs-string">'weekday'</span></span>] = map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: datetime.strptime(x, <span class="hljs-string"><span class="hljs-string">'%Y-%m-%d'</span></span>).strftime(<span class="hljs-string"><span class="hljs-string">'%A'</span></span>), daily_engagements.utc_date) daily_engagements.head()</code> </pre> <br><img src="https://habrastorage.org/files/64f/7bd/af5/64f7bdaf533b42ce8bfd913c81c6a8d0.png" alt="image"><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># pandas code weekday_engagement_pandas = pd.DataFrame(daily_engagements.groupby('weekday').total_minutes_visited.mean()) # pandasql code aggr_query = ''' SELECT avg(total_minutes_visited) as total_minutes_visited, weekday FROM daily_engagements GROUP BY weekday ''' weekday_engagement_pandasql = ps.sqldf(aggr_query, locals()).set_index('weekday') week_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] weekday_engagement_pandasql.loc[week_order].plot(kind = 'bar', rot = 45, title = 'Total time spent on Udacity by weekday')</span></span></code> </pre> <br>  <strong>Conclusion:</strong> It is curious, but on average, students spend most of their time on courses on Tuesday, and least of all on Saturday.  On average, students spend more time on MOOC on weekdays than on weekends.  Another proof that I am unrepresentative. <br><br><img src="https://habrastorage.org/files/7d7/26f/847/7d726f8475b941aeb2e948e16dcc92d6.png" alt="image"><br><br><h2>  JOIN tables </h2><br>  <strong>Objective</strong> : consider students who have not passed the specialization (with the canceled status) and those who successfully study / studied and compare their average activity per day for the first week after they enrolled in the specialization.  There is a hypothesis that those who remained and study successfully spent more time on training. <br><br>  To answer this question, we need data from both the <strong>enrollments</strong> and <strong>daily engagements</strong> tables, so we will use join by student ID. <br>  Also in this problem there are several pitfalls that need to be considered: <br><br><ul><li>  not all users are living people, there are also Udacity test accounts, they need to be filtered <code>is_udacity = 0</code> ; </li><li>  A student can register for a specialization several times, including at intervals of less than one week, so you need to check that the activity <em>date of the utc date</em> is between <em>join date</em> and <em>cancel date</em> (only for students with the canceled status). </li></ul><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># pandas code join_df = pd.merge(daily_engagements, enrollments[enrollments.is_udacity == 0], how = 'inner', right_on ='account_key', left_on = 'acct') join_df = join_df[['account_key', 'status', 'total_minutes_visited', 'utc_date', 'join_date', 'cancel_date']] join_df['days_since_joining'] = map(lambda x: x.days, pd.to_datetime(join_df.utc_date) - pd.to_datetime(join_df.join_date)) join_df['before_cancel'] = (pd.to_datetime(join_df.utc_date) &lt;= pd.to_datetime(join_df.cancel_date)) join_df = join_df[join_df.before_cancel | (join_df.status == 'current')] join_df = join_df[(join_df.days_since_joining &lt; 7) &amp; (join_df.days_since_joining &gt;= 0)] avg_account_total_minutes = pd.DataFrame(join_df.groupby(['account_key', 'status'], as_index = False) .total_minutes_visited.mean()) avg_engagement_pandas = pd.DataFrame(avg_account_total_minutes.groupby('status').total_minutes_visited.mean()) avg_engagement_pandas.columns = [] # pandasql code join_query = ''' SELECT avg(avg_acct_total_minutes) as avg_total_minutes, status FROM (SELECT avg(total_minutes_visited) as avg_acct_total_minutes, status, account_key FROM (SELECT e.account_key, e.status, de.total_minutes_visited, (cast(strftime('%s',de.utc_date) as interger) - cast(strftime('%s',e.join_date) as interger))/(24*60*60) as days_since_joining, (cast(strftime('%s',e.cancel_date) as interger) - cast(strftime('%s', de.utc_date) as interger))/(24*60*60) as days_before_cancel FROM enrollments as e JOIN daily_engagements as de ON (e.account_key = de.acct) WHERE (is_udacity = 0) AND (days_since_joining &lt; 7) AND (days_since_joining &gt;= 0) AND ((days_before_cancel &gt;= 0) OR (status = 'current')) ) GROUP BY status, account_key) GROUP BY status ''' avg_engagement_pandasql = ps.sqldf(join_query, locals()).set_index('status')</span></span></code> </pre> <br>  It is worth noting that in the SQL query, the <code>cast</code> and <code>strftime</code> functions were used to bring the dates from the rows into the timestamp (the number of seconds since the beginning of the epoch), and then calculate the difference between these dates in days. <br><br>  <strong>Conclusion:</strong> On average, students who did not abandon their specialization spent the first week on Udacity 53% more time than those who decided to stop studying. <br><br><img src="https://habrastorage.org/files/478/9f0/01d/4789f001d38141559f510140ec519c7b.png" alt="image"><br><br><h1>  Summarizing </h1><br>  In this article, we looked at examples of using the Pandasql library for data analysis and compared it using Pandas functionality.  We applied filtering, sorting, aggregate functions and joines to work with DataFrames in Pandasql. <br><br>  Pandas is a very convenient library that allows you to quickly and easily convert data, but it seems to me that in some tasks it is easier to express your thoughts using a declarative language and then Pandasql comes to the rescue.  In addition, Pandasql can be useful for those who are just starting to get to know Pandas, but already have good knowledge of SQL. <br><br>  The full code of examples and source data are also given in the repository on <a href="https://github.com/miptgirl/udacity_engagement_analysis">github</a> . <br><br>  For those interested, there is also a good tutorial by Pandasql on <a href="http://blog.yhat.com/posts/pandasql-sql-for-pandas-dataframes.html">The Yhat Blog</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/279213/">https://habr.com/ru/post/279213/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279203/index.html">SonataAdminBundle: Creating an Object from a List View (Part 2)</a></li>
<li><a href="../279205/index.html">Militiamen took up whatsapp</a></li>
<li><a href="../279207/index.html">Installing applications in Cach√© using projections</a></li>
<li><a href="../279209/index.html">Big survey on algorithms</a></li>
<li><a href="../279211/index.html">9 secrets of online payments. Part 3: Payment Method Selection Page</a></li>
<li><a href="../279215/index.html">We study the source tree of Windows 10: from telemetry to open source</a></li>
<li><a href="../279219/index.html">Information Security Risks for Web Applications</a></li>
<li><a href="../279221/index.html">One interesting bug in Lucene.Net</a></li>
<li><a href="../279223/index.html">Disaster-resistant IaaS, as well as replication and backups</a></li>
<li><a href="../279225/index.html">VCloud Tools: IT GRAD Experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>