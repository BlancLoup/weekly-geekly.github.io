<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributing files from Google Drive via nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 


 It just so happened that I needed somewhere to store more than 1.5TB of data, and even provide the ability to download them by regular ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributing files from Google Drive via nginx</h1><div class="post__text post__text-html js-mediator-article"><h3>  Prehistory </h3><br><p>  It just so happened that I needed somewhere to store more than 1.5TB of data, and even provide the ability to download them by regular users via a direct link.  Since traditionally, such amounts of memory go already to VDS, the rental cost of which is not too much invested in the project budget from the ‚Äúhave nothing to do‚Äù category, and from the source data I had a VPS 400GB SSD, where I couldn‚Äôt put 1.5tb pictures without loseless compression will succeed. </p><a name="habracut"></a><br><p>  And then I remembered that if you remove trash from a Google disk, such as programs that run only on Windows XP, and other things that move from my carrier to media since the Internet was not so fast at all not unlimited (for example, those 10-20 versions of a virtual box hardly had any value other than nostalgic), then everything should fit very well.  No sooner said than done.  And so, breaking through the limit on the number of requests to api (by the way, technical support increased the request quota per user for 100 seconds to 10,000 without any problems) to the place of its further deployment. </p><br><p>  Everything seems to be good, but now it needs to be conveyed to the end user.  Moreover, without any redirects to other resources, but so that the person simply pressed the ‚ÄúDownload‚Äù button and became the happy owner of the coveted file. </p><br><p>  Then I, by golly, went into all serious things.  At first it was a script on AmPHP, but the load created by it did not suit me (a sharp jump at the start to 100% of the kernel consumption).  Then the curl for ReactPHP wrapper went into the business, which fit into my wishes for the CPU clock consumption, but it didn‚Äôt give me the speed I wanted (it turned out that you can just reduce the curl_multi_select call interval, but then we have the same type of gluttony ).  I even tried to write a small service on Rust, and it worked quite briskly (it is surprising even that it worked, with my knowledge), but I wanted more, and it was somehow difficult to customize it.  In addition, all these solutions somehow strangely buffered the answer, but I wanted to track the moment when the file loading ended with the greatest accuracy. </p><br><p>  In general, for a while it was crooked, but it worked.  Until one day I came up with a great idea for my delusion: nginx in theory can do what I want, it works briskly, and it also allows any distortions with configuration.  Need to try - what happens?  And after half a day of persistent searches, a solution that has been stable for several months and met all my requirements was born. </p><br><h3>  Customize NGINX </h3><br><pre><code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#         . location ~* ^/google_drive/(.+)$ { #       (,     ). internal; #       (  ). limit_rate 1m; #   nginx    google drive    . resolver 8.8.8.8; # C     (    ). set $download_url https://www.googleapis.com/drive/v3/files/$upstream_http_file_id?alt=media; #    Content-Disposition ,        . set $content_disposition 'attachment; filename="$upstream_http_filename"'; #     . proxy_max_temp_file_size 0; # ,  ,     (  ,     $http_upstream    .   ,     -  ,      ). proxy_set_header Authorization 'Bearer $1'; #  ,         . proxy_pass $download_url; #              . add_header Content-Disposition $content_disposition; #        . proxy_hide_header Content-Disposition; proxy_hide_header Alt-Svc; proxy_hide_header Expires; proxy_hide_header Cache-Control; proxy_hide_header Vary; proxy_hide_header X-Goog-Hash; proxy_hide_header X-GUploader-UploadID; }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">A short version without comments can be seen under the spoiler.</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* ^/google_drive/(.+)$</span></span> { internal; <span class="hljs-attribute"><span class="hljs-attribute">limit_rate</span></span> <span class="hljs-number"><span class="hljs-number">1m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">resolver</span></span> <span class="hljs-number"><span class="hljs-number">8.8.8.8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$download_url</span></span> https://www.googleapis.com/drive/v3/files/<span class="hljs-variable"><span class="hljs-variable">$upstream_http_file_id</span></span>?alt=media; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$content_disposition</span></span> <span class="hljs-string"><span class="hljs-string">'attachment; filename="</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$upstream_http_filename</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_max_temp_file_size</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Authorization <span class="hljs-string"><span class="hljs-string">'Bearer </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$download_url</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Disposition <span class="hljs-variable"><span class="hljs-variable">$content_disposition</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Content-Disposition; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Alt-Svc; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Expires; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Cache-Control; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Vary; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> X-Goog-Hash; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> X-GUploader-UploadID; }</code> </pre> <br></div></div><br><br><h3>  We write a script to manage all this happiness. </h3><br><p>  The example will be in PHP and purposely written with a minimum body kit.  I think everyone who has experience with any other language will be able to integrate this part with the help of my example. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">#   Google Drive Api. define('TOKEN', '*****'); # ID     $fileId = 'abcdefghijklmnopqrstuvwxyz1234567890'; # ,         -    ? http_response_code(204); #   c ID  (  nginx      $upstream_http_file_id). header('File-Id: ' . $fileId); #      ( $upstream_http_filename). header('Filename: ' . 'test.zip'); #  .       ,  ,     $1  nginx. header('X-Accel-Redirect: ' . rawurlencode('/google_drive/' . TOKEN));</span></span></code> </pre> <br><h3>  Results </h3><br><p>  In general, this method makes it quite easy to organize the distribution of files to users from any cloud storage.  Yes, even from a telegram or VK, (provided that the file size does not exceed the allowable size of this storage).  I had an idea like <a href="https://habr.com/ru/company/vds/blog/456290/">this</a> , but unfortunately I‚Äôve come across files up to 2GB, and I haven‚Äôt yet found a way or module for pasting answers from upstream, but writing some wrappers for this project is too costly. </p><br><p>  Thanks for attention.  I hope my story was at least a little interesting or useful. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460685/">https://habr.com/ru/post/460685/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460669/index.html">How to ensure the safety of development, saving time and nerves</a></li>
<li><a href="../460671/index.html">Ownership and borrowing in D</a></li>
<li><a href="../460675/index.html">Retrieving machine learning data</a></li>
<li><a href="../46068/index.html">Formatting Long SQL Queries</a></li>
<li><a href="../460683/index.html">Laravel Event Projector and Event Generation Concept</a></li>
<li><a href="../460687/index.html">How do the banks from the inside</a></li>
<li><a href="../460695/index.html">What is DAA, and how does this system help drones?</a></li>
<li><a href="../460697/index.html">Minimum possible font</a></li>
<li><a href="../460699/index.html">Habr Weekly # 10 / Superservices and e-passport, smartphones and Russians, ‚Äúspy gadgets‚Äù, life without satellites</a></li>
<li><a href="../4607/index.html">"Thousands of" leave social networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>