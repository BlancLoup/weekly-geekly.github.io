<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Antihucking theory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently, I was puzzled by the protection of applications from intercepting system api, I decided to share and discuss what I came to. Many of yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Antihucking theory</h1><div class="post__text post__text-html js-mediator-article">  Most recently, I was puzzled by the protection of applications from intercepting system api, I decided to share and discuss what I came to.  Many of you know that intercepting system api comes down to redirecting the original function to the right place, thanks to which you can modify the parameters of the function, return a result different from the original, store the original call with parameters and much more.  Since this is the theoretical part, the examples in the article will be accompanied by pseudocode. <br><a name="habracut"></a><br>  The following interception methods are commonly used: <br><ol><li>  Inserting an unconditional jump in place of a function (x86 - 5 bytes jmp addr, x64 - 12 bytes, mov rax addr, jmp rax) </li><li>  Inserting a call instruction at the place where the original function was called (hooked_function_entry: call my_function) </li><li>  Modification of the application import table, the introduction of a proxy DLL. </li><li>  Interception without modification of the code by means of hardware breakpoints (hardware breakpoints). </li><li>  Interception through the kernel driver Zw / Nt functions. </li></ol><br>  You can list the following methods for detecting interception from usermode: <br>  1. Comparison of the beginning of a function before calling it with the opcodes of machine instructions: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//0x90 - nop //0xE9 - jmp //0xE8 - call if (*mainFunc == 0xE9 || *mainFunc == 0x90 || *mainFunc == 0xE8 ...) printf("Hook detected");</span></span></code> </pre> <br>  The method is static and easily bypassed, with smarter transitions. <br>  2. The listed interception methods are a modification of memory, and they can be detected by crc checksum checks, but api for reading memory can also be intercepted and then a false result will be returned. <br>  3. Generate a controlled process (with active debugging of oneself), with the restoration of important api. <br>  4. Searching the api, which are important for us, using the export table in the system libraries, compare the disassembled length of the function with the original one. <br>  5. Restoration of modified api by copying bytes from the library, an approximate scheme is as follows: <br>  - getting the base of a specific module <br>  - export iteration <br>  - obtaining RVA necessary function. <br>  - RVA-&gt; FileOffset conversion. <br>  - reading the original and writing to memory. <br>  - in some cases, do not forget about relocs. <br>  6. View the library import table and for each imported function from another system library, make a check for consistency, if it does not match, we also read from the disk and write to memory. <br>  7. Simulating the Nt / Zw system functions using syscalls, int2e in (older windows versions), syscalls table for all systems, is easily located in google. <br><br>  Let us dwell on the 7th method, since the Nt / Zw functions can also be intercepted, this method is also far from perfect, but in my opinion it is better from all of the above. <br>  Let's look at the implementation of the NtCreateFile function in windows 7 sp1 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/73f/3c3/bd9/73f3c3bd9d1f697fb90ba56a3bea3362.png" alt="image"><br><br>  the following happens: <br>  - in eah is the number of syscall-a. <br>  - reset to ecx, (wow64 index?). <br>  - edx contains a pointer to the parameters. <br>  - further call, the adjustment of the stack and return. <br><br>  x64 call in win7 and win8 <br><img src="https://habrastorage.org/storage2/6c0/697/fc8/6c0697fc834fb1ebc712f06bc19d01d1.png" alt="image"><br><br>  Using the following x86 pseudo-code "you can create a file on disk." <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  NtCreateFile typedef NTSTATUS (NTAPI * NTCREATEFILE) (OUT PHANDLE FileHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES ObjectAttributes, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PLARGE_INTEGER AllocationSize OPTIONAL, IN ULONG FileAttributes, IN ULONG ShareAccess, IN ULONG CreateDisposition, IN ULONG CreateOptions, IN PVOID EaBuffer OPTIONAL, IN ULONG EaLength); #define InitializeObjectAttributes( p, n, a, r, s ) { \ (p)-&gt;Length = sizeof( OBJECT_ATTRIBUTES ); \ (p)-&gt;RootDirectory = r; \ (p)-&gt;Attributes = a; \ (p)-&gt;ObjectName = n; \ (p)-&gt;SecurityDescriptor = s; \ (p)-&gt;SecurityQualityOfService = NULL; \ } typedef VOID (NTAPI * RTLINITUNICODESTRING)(IN OUT PUNICODE_STRING, IN PCWSTR); unsigned char dNtCreateFile[] = {0xb8,0x52,0x00,0x00,0x00,0x33,0xc9,0x8d,0x54,0x24,0x04,0x64, 0xff,0x15,0xc0,0x00,0x00,0x00,0x83,0xc4,0x04,0xc2,0x2c,0x00}; ... RtlInitUnicodeString InitializeObjectAttributes ... DWORD oldp; VirtualProtect(&amp;dNtCreateFile, sizeof(dNtCreateFile), PAGE_EXECUTE_READ, &amp;oldp); auto func = (NTCREATEFILE) ((void*)dNtCreateFile); Ntstatus = (func)(&amp;fileHandle, DesiredAccess, ObjectAttritubes, ioStatusBlock, 0, FileAttributes, ShareAccess, CreateDisposition ,CreateOptions, Optional_Buffer, 0);</span></span></code> </pre><br>  This pseudocode will only work on windows 7 sp1, however dNtCreateFile can be formed ‚Äúdynamically‚Äù using the method from clause 5, and then the code with minor edits will work on all systems starting with winxp.  Any thoughts in the comments are welcome, the kernelmode is an extreme case. </div><p>Source: <a href="https://habr.com/ru/post/186334/">https://habr.com/ru/post/186334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186324/index.html">The way to return offline maps in the new version of Google Maps</a></li>
<li><a href="../186326/index.html">Layout of MIR station at a scale of 1: 3 inside a giant pyramid</a></li>
<li><a href="../186328/index.html">Cyber ‚Äã‚ÄãSecurity. Weekly Review July 1 - July 7, 2013</a></li>
<li><a href="../186330/index.html">Comic Hack Quest</a></li>
<li><a href="../186332/index.html">Save time on connecting fonts. One year later</a></li>
<li><a href="../186336/index.html">JQuery World Conference comes to Russia</a></li>
<li><a href="../186338/index.html">Quartz disc can store information for a million years</a></li>
<li><a href="../186342/index.html">Javascript cms</a></li>
<li><a href="../186344/index.html">Chocolate electronics</a></li>
<li><a href="../186346/index.html">The theoretical minimum for the mail administrator. Configuring mail on the Communigate Pro server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>