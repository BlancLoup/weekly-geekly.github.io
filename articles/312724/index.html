<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect Docker container with http server using Gradle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! 

 There was such a task: Make a simple web - server with a minimum number of dependencies. At the same time it will be deployed in the form ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect Docker container with http server using Gradle</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7fc/d0c/e85/7fcd0ce858a84a6e895f99b132f0c5d2.png" alt="image" align="right">  Hi Habr! <br><br>  There was such a task: Make a simple web - server with a minimum number of dependencies.  At the same time it will be deployed in the form of a docker container.  To implement the server itself, I will use <a href="https://grizzly.java.net/">GrizzlyWebServer</a> .  To build Gradle with a plugin for docker from Benjamin Muschko (bmuschko). <br><br>  This choice of tools is not accidental, I am developing for android and Java is closer to me and Gradle than something else.  In this article I want to describe in detail the process from writing an application to running in docker, possible problems and their solutions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so, let's start: the server. <br><a name="habracut"></a><br>  Create a <a href="https://www.jetbrains.com/help/idea/2016.2/creating-a-gradle-project.html">new Gradle project</a> in IntelliJ IDEA. <br><br><img src="https://habrastorage.org/files/f6a/c4e/dae/f6ac4edaedb74c8297d225f3b95a40ee.png" alt="image"><br><br><img src="https://habrastorage.org/files/8a8/9b5/e50/8a89b5e50b414fd09e81480bfeea3cdb.png" alt="image"><br><br>  An empty project has been created; we will add the HabrWebServer class with the main () method.  Add the line to build.gradle in dependencies. <br><br><pre><code class="java hljs">compile group: <span class="hljs-string"><span class="hljs-string">'org.glassfish.grizzly'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'grizzly-http-server'</span></span>, version: <span class="hljs-string"><span class="hljs-string">'2.3.28'</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The code of our simplest server</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HabrWebServer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Grizzly.logger(HabrWebServer.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// create a basic server that listens 0.0.0.0:8080 final HttpServer server = HttpServer.createSimpleServer(); final ServerConfiguration config = server.getServerConfiguration(); // Map the path, '/', to the Handler config.addHttpHandler(new HabrHandler(), "/"); try { server.start(); System.out.println("The server is running. \nPress enter to stop..."); System.in.read(); } catch (IOException ioe) { LOGGER.log(Level.SEVERE, ioe.toString(), ioe); } finally { server.shutdownNow(); } } private static class HabrHandler extends HttpHandler { @Override public void service(Request request, Response response) throws Exception { response.setContentType("text/plain"); response.getWriter().write("Hello Habrahabr!"); } } }</span></span></code> </pre><br></div></div><br>  Open the console in the project directory type ./gradlew assemble - BUILD SUCCESSFUL. <br>  Something we have already gathered. <br><br>  But there is one unpleasant thing, in ide, imports do not work and server classics are highlighted in red. <br><br><img src="https://habrastorage.org/files/961/ae7/e25/961ae7e25bc84546bb5c2d787262a911.png" alt="image"><br><br>  It is treated this way - you need to find the magic refresh button and press it - <a href="https://www.jetbrains.com/help/idea/2016.2/synchronizing-changes-in-gradle-project-and-intellij-idea-project.html">Synchronizing Changes in Gradle Project and IntelliJ IDEA Project</a> <br><br>  Now we will launch the application locally, for this we use the <a href="https://docs.gradle.org/current/userguide/application_plugin.html">'application' plugin for Gradle</a> . <br><br>  Add the following lines to build.gradle: <br><br><pre> <code class="java hljs">apply plugin: <span class="hljs-string"><span class="hljs-string">'application'</span></span> mainClassName = <span class="hljs-string"><span class="hljs-string">'ru.test.HabrWebServer'</span></span></code> </pre><br>  Assemble and install the application: <br><br><pre> <code class="bash hljs"> ./gradlew installDist</code> </pre><br>  Go to the folder / habrServer / build / install / habrServer / bin.  Run the application: <br><br><pre> <code class="bash hljs">./habrServer</code> </pre><br>  We open the browser, the server responds, but not by what we are waiting for. <br><br><img src="https://habrastorage.org/files/897/19c/6b8/89719c6b812e4954b01eb428ffac958a.png" alt="image"><br><br>  It turns out that when creating a server, the createSimpleServer () method sets up first a handler that gives away static content of which we don‚Äôt have, and it doesn‚Äôt get to our handler.  Change the server creation code. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HttpServer server = createServer(<span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>); ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HttpServer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span></span>{ HttpServer server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpServer(); NetworkListener listener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NetworkListener(<span class="hljs-string"><span class="hljs-string">"grizzly"</span></span>, host, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PortRange(port)); server.addListener(listener); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> server; }</code> </pre><br>  It remains to build the application in the form of a docker container. <br>  Let's start with the local <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/">docker installation</a> . <br>  After installing docker, the server listens only on a unix socket.  Let's allow local access on tcp. <br><br>  In the /lib/systemd/system/docker.service file we find and edit the line: <br><br><pre> <code class="bash hljs">ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375</code> </pre> <br>  It is not entirely correct to change this file, since it changes the settings for all users, but in my case it is suitable for tests on my machine. <br><br>  To collect the container we use <a href="https://github.com/bmuschko/gradle-docker-plugin">bmuschko Gradle Docker plugin</a> <br><br><div class="spoiler">  <b class="spoiler_title">Final build.gradle</b> <div class="spoiler_text"><pre> <code class="bash hljs">group <span class="hljs-string"><span class="hljs-string">'habrServer'</span></span> version <span class="hljs-string"><span class="hljs-string">'1.0-SNAPSHOT'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'java'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'application'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.bmuschko.docker-java-application'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.bmuschko.docker-remote-api'</span></span> import com.bmuschko.gradle.docker.tasks.container.DockerCreateContainer mainClassName = <span class="hljs-string"><span class="hljs-string">'ru.test.HabrWebServer'</span></span> buildscript { repositories { jcenter() } dependencies { classpath <span class="hljs-string"><span class="hljs-string">'com.bmuschko:gradle-docker-plugin:3.0.3'</span></span> } } docker { url = <span class="hljs-string"><span class="hljs-string">'http://127.0.0.1:2375'</span></span> javaApplication { maintainer = <span class="hljs-string"><span class="hljs-string">'Dmitry Barkalov "xxx@xxx.xxx"'</span></span> ports = [8080] tag = <span class="hljs-string"><span class="hljs-string">'habrwebserver'</span></span> } } task createDocker(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: DockerCreateContainer) { dependsOn dockerBuildImage targetImageId { dockerBuildImage.getImageId() } portBindings = [<span class="hljs-string"><span class="hljs-string">'8080:8080'</span></span>] } repositories { mavenCentral() jcenter() } dependencies { testCompile group: <span class="hljs-string"><span class="hljs-string">'junit'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'junit'</span></span>, version: <span class="hljs-string"><span class="hljs-string">'4.11'</span></span> compile group: <span class="hljs-string"><span class="hljs-string">'org.glassfish.grizzly'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'grizzly-http-server'</span></span>, version: <span class="hljs-string"><span class="hljs-string">'2.3.28'</span></span> }</code> </pre><br></div></div><br>  We assemble and install the container: <br><br><pre> <code class="bash hljs"> ./gradlew createDocker</code> </pre><br><img src="https://habrastorage.org/files/cda/278/153/cda278153040462695d923811106d424.png" alt="image"><br><br>  Run! <br><br><img src="https://habrastorage.org/files/7a6/4d7/37b/7a64d737b40e4521a5d7092d20661193.png" alt="image"><br><br>  Open in the browser. <br><br><img src="https://habrastorage.org/files/ca2/8c5/e21/ca28c5e21f5f42bfb6160a1114c62e4b.png" alt="image"><br><br>  Only one unresolved problem remained: the application waits in the main thread on System.in.read ();  Therefore, we run docker with the -i option.  ( <a href="https://docs.docker.com/engine/reference/run/">Keep STDIN open even if not attached.</a> ) Ie  stdin remains attached to the container.  You probably don‚Äôt need to make an application in the form of a demon; the docker can demonize himself.  It is necessary to remove the interaction with stdin, and be able to stop the application.  It remains to be learned.  If someone knows write in the comments, I will be grateful. <br><br>  Thank you for your attention, I hope the article was useful to someone. <br>  <a href="https://github.com/DBarkalov/habrWebServer">Project ID on github.</a> </div><p>Source: <a href="https://habr.com/ru/post/312724/">https://habr.com/ru/post/312724/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312714/index.html">Google Cloud Vision API. Future Computer Vision as a service has arrived?</a></li>
<li><a href="../312716/index.html">Search Yandex from an engineering point of view. Lecture in Yandex</a></li>
<li><a href="../312718/index.html">Functional safety, part 4 of 7. Management and evaluation processes</a></li>
<li><a href="../312720/index.html">How cybersecurity trends affect the theft of money</a></li>
<li><a href="../312722/index.html">Why I no longer click the "Add contact" button in Telegram</a></li>
<li><a href="../312726/index.html">30 sensible books on business, self-development and creativity that changed my life</a></li>
<li><a href="../312728/index.html">Vivaldi development: work on bugs</a></li>
<li><a href="../312730/index.html">Creating scenes from Star Wars to Unreal Engine 4</a></li>
<li><a href="../312732/index.html">Micro DC. What is it?</a></li>
<li><a href="../312734/index.html">Linux kernel hidden inside Windows 10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>