<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimizing Facebook Graph API with Real-Time Updates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Applications for Facebook can have various functions: for example, often the application will have enough information obtained through the API while t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimizing Facebook Graph API with Real-Time Updates</h1><div class="post__text post__text-html js-mediator-article">  Applications for Facebook can have various functions: for example, often the application will have enough information obtained through the API while the user is working with the application.  But what to do if your application should work with the most ‚Äúfresh‚Äù user data, even if they have not opened it for more than a month? <br><br>  There are two ways to receive data not only while the user is working with the application: <br><ol><li>  Get permission from the user offline_access (save the ‚Äúeternal‚Äù user access_token) and get the necessary data ‚Äúaccording to the schedule‚Äù (pull the cron script). </li><li>  Write a script that will receive all data changes from Facebook, set up and subscribe to updates via Real-Time Updates. </li></ol><br>  Under the cat, you will learn a virtual example of how the use of real-time updates helps to reduce the number of requests to the API by more than 100 times per day in some situations.  We will write a subscription script for updates and check its work, having received data on changes in objects from Facebook itself. <br><a name="habracut"></a><br>  The beginning of the article contains a lot of theory, which is similar to the Russian translation of the Facebook page.  If it is easier for you to read in English - you can skip everything in the second method to the section <i>Example of Real-Time Updates</i> .  But for some reason, I failed to set up this functionality after the first reading.  I hope this article will help you quickly understand this. <br><br><h4>  First way </h4><br>  The functionality of some applications may be associated with the need to obtain data on a schedule.  For example, you collect <a href="http://socialmediaclubmoscow.org/facebookpages/statistics.php%3Fuid%3D2">statistics of the number of likes of</a> pages from a particular directory.  To do this, you receive data at intervals of once per hour.  This is the correct example of use, otherwise you simply will not get this data.  But often this method is also used for objects, according to which updates can be received not ‚Äúaccording to the schedule‚Äù but real-time from Facebook itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of the serious shortcomings of the first method are the following: <br><ul><li>  The less frequently the data is checked, the less reliable it is. </li><li>  High resource costs with frequent updates. </li><li>  Users are reluctant to allow offline_access - access to their data at any time. </li></ul><br>  Imagine that you made an application whose functionality is tied to the user's friends, and it is very important for you to have the latest information.  Let's say your application has been installed by 1000 users.  And let an acceptable time of caching data about friends is 1 hour.  As a result, every day you will send 24,000 requests to ensure that your database of user‚Äôs friends is up to date!  And you have only 1000 users, and we can assume that there will be no more than a couple of hundred changes in friends for everyone per day (well, this is a guess based on personal experience). <br><br>  To solve the shortcomings of the first method, Facebook made Real-Time Updates for its Graph API. <br><br><h4>  Second way </h4><br>  Real-time update support allows your app to subscribe to changes in Facebook data.  Your application receives updates from Facebook and saves the data, instead of polling Facebook servers ‚Äúon schedule‚Äù.  Caching data and using this API can improve the reliability of the application and reduce its load time.  Whenever a change happens to which you are subscribed, Facebook makes an HTTP POST request to the update processing script with a list of changes.  The server will send you a notification of the change within a couple of minutes after its appearance. <br><br><h5>  Objects </h5><br>  At this point, you can subscribe to the following types of objects: <br><ul><li>  user (user) - receive notifications about specific fields and user connections with the corresponding Graph API nodes. * </li><li>  permissions ‚Äî Receive notifications when a user changes permissions for your application. </li><li>  page (page) - receive notifications when the pages that have added (installed) your application change their general properties. </li></ul><br>  * Not all properties and associations of the User object you can subscribe.  For example, you can access links: feed, friends, activities, interests, music, books, movies, television, likes, checkins.  But you still cannot subscribe to changes in these links: home, tagged, posts, photos, albums, videos, groups, notes, events, inbox, outbox, updates, accounts <br><br><h5>  Subscription </h5><br>  In order to set up a subscription for updates, you need: <br><ol><li>  Set up a script (URL) that will receive both HTTP GET (for verification of the subscription) and POST (for changing data) requests from Facebook. </li><li>  Make a POST request to the Graph API <pre>  https://graph.facebook.com/&lt;app-id&gt;/subscriptions </pre>  to subscribe, and be ready to process a verification request. </li></ol><br>  By sending a request to <pre>  https://graph.facebook.com/ &lt;app-id&gt; / subscriptions? access_token = ... </pre>  You can do three things, depending on which HTTP POST, GET, or DELETE request you send: <br><ol><li>  Add and edit subscriptions (POST). </li><li>  Get a list of all the objects as well as their subscribed fields (GET) </li><li>  Delete Subscription (DELETE) </li></ol><br>  The request must include the access_token of the application, which can be obtained using your application ID (app-id) and application secret key (app-secret).  Just send an HTTP GET <pre>  https://graph.facebook.com/oauth/access_token?client_id=&lt;app-id&gt;&amp;client_secret=&lt;app-secret&gt;&amp;grant_type=client_credentials </pre>  and the answer will come: access_token = ... <br><br><h6>  Add and edit subscriptions </h6><br><blockquote>  So, you have read above where you need to send a request to add a subscription.  Do not rush to immediately fulfill these requests - the structure of the presentation of the material is not the same as the sequence of necessary steps.  This was done specifically to study the material consistently.  But in the example, you will be the first to perform queries that are described in the last part before the example. </blockquote><br><br>  An application can have only one subscription for each of the possible types of objects.  If you add an object to which you already have a subscription, then the existing subscription will be replaced with a new one.  To add or change a subscription, you must send a POST request containing the fields: <br><ul><li>  object - the type of the object: user, permissions or page.  You will monitor all objects of this type, for example, all users of your application. </li><li>  fields - A list (items separated by commas) of the properties and links of the selected object.  For example, to follow changes in the name, picture, friends of the user, as well as News Feed links, you must specify the value ‚Äúname, picture, friends, feed‚Äù </li><li>  callback_url - the URL to which Facebook will send the changes to which the application is subscribed. </li><li>  verify_token is the ‚Äúsecret code‚Äù that you specify in order to verify the authenticity of the request.  It will be passed to the script that handles the subscription. </li></ul><br>  Getting a list of all the objects as well as their fields to which you subscribe <br>  Making a GET request to subscribe URL <pre>  https://graph.facebook.com/ &lt;app-id&gt; / subscriptions? access_token = ... </pre>  You will receive a response with JSON-encoded content that lists your subscriptions.  I subscribed to the friends connection of the user object, and also to offline_access in permissions.  Here is the answer: <br><pre> {
   "data": [
      {
         "object": "user",
         "callback_url": "http://millione.tv/&lt; Path to the script&gt;",
         "fields": [
            "friends"
         ],
         "active": true
      },
      {
         "object": "permissions",
         "callback_url": "http://millione.tv/&lt; Path to the script&gt;",
         "fields": [
            "offline_access"
         ],
         "active": true
      }
   ]
 }
</pre><br><h6>  Deleting a subscription </h6><br>  To delete the entire subscription to all objects, send a DELETE request.  If you want to remove a subscription to a specific object, specify the object parameter (for example, object = user). <br><br><h4>  Your Callback Server </h4><br>  Facebook servers make an HTTP GET request to your callback_url when you are trying to add or modify a subscription.  After a successful subscription, Facebook servers will send change notifications using HTTP POST to the same URL. <br><br><h5>  Subscription Verification </h5><br>  Before the subscription is finally added or modified, Facebook servers will make an HTTP GET to your callback_url with the following parameters: <br><ul><li>  hub.mode - The string 'subscribe' is passed in this parameter. </li><li>  hub.challenge - Random string. </li><li>  hub.verify_token is the ‚Äúsecret code‚Äù that you set in order to verify the authenticity of the request that you sent to Facebook. </li></ul><br>  The update processing script should first check the value of hub.verify_token - the ‚Äúsecret code‚Äù that you sent to Facebook, and then return the hub.challenge parameter back.  This was done specifically to protect the script as a means of carrying out DDoS attacks on the server. <br>  Note to developers: In PHP, the dot is automatically converted to underscore in the parameters.  Therefore, you should refer to <code>$_GET["hub_mode"]</code> , <code>$_GET["hub_challenge"]</code> and <code>$_GET["hub_verify_token"]</code> . <br><br><h5>  Change Notifications </h5><br>  When the data changes and there is a valid subscription, Facebook servers make an HTTP POST request for the callback_url that you asked.  The content type of the request will be application / json;  the body is a JSON-encoded string containing information about one or more changes.  An example can be seen below in the application code. <br><br>  It should be noted that the line will not contain data on the current value.  Therefore, you will need to make a simple API request to get them (due to security policy).  You can download the necessary data immediately so that the user, having returned to the application, does not experience complications with an increase in download time. <br><br>  Facebook aggregates the changes and sends them in batches every 5 seconds, or if the number of changes that have occurred has exceeded 1000. In the event that the change notification was not delivered to you, Facebook will try again, and then a little later, reducing the frequency of requests in the next 24 hours. <br><br><h4>  Example of Real-Time Updates </h4><br>  Let's apply the theory in practice.  To do this, you will need a hosting, PHP script, which will be located on your domain at the address specified by you callback_url.  You also need an application in Facebook.  You can use the existing one, or create a new one on <a href="https://developers.facebook.com/apps">the</a> developer‚Äôs <a href="https://developers.facebook.com/apps">application page</a> . <br><br><h5>  1. Appendix </h5><br><img src="http://img198.imageshack.us/img198/8886/appwr.jpg"><br><br><h5>  2. The update processing script </h5><br>  Save the script for callback_url <br><blockquote>  <font color="#339933">&lt;?</font>  php <br><br>  <font color="#006600">/ * Note the request must complete within 15 seconds.</font> <font color="#006600"><br></font>  <font color="#006600">Otherwise Facebook server will consider it a timeout and</font> <font color="#006600"><br></font>  <font color="#006600">resend the push notification again.</font>  <font color="#006600">* /</font> <br><br>  define <font color="#009900">(</font> <font color="#3366CC">'VERIFY_TOKEN'</font> <font color="#339933">,</font> <font color="#3366CC">'&lt;secret_code&gt;'</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  $ method <font color="#339933">=</font> $ _SERVER <font color="#009900">[</font> <font color="#3366CC">'REQUEST_METHOD'</font> <font color="#009900">]</font> <font color="#339933">;</font> <br><br>  <font color="#000066">if</font> <font color="#009900">(</font> $ method <font color="#339933">==</font> <font color="#3366CC">'GET'</font> <font color="#339933">&amp;&amp;</font> $ _GET <font color="#009900">[</font> <font color="#3366CC">'hub_mode'</font> <font color="#009900">]</font> <font color="#339933">==</font> <font color="#3366CC">'subscribe'</font> <br>  <font color="#339933">&amp;&amp;</font> $ _GET <font color="#009900">[</font> <font color="#3366CC">'hub_verify_token'</font> <font color="#009900">]</font> <font color="#339933">==</font> VERIFY_TOKEN <font color="#009900">)</font> <font color="#009900">{</font> <br>  echo $ _GET <font color="#009900">[</font> <font color="#3366CC">'hub_challenge'</font> <font color="#009900">]</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000066">else</font> <br>  <font color="#000066">if</font> <font color="#009900">(</font> $ method <font color="#339933">==</font> <font color="#3366CC">'POST'</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  $ data <font color="#339933">=</font> file_get_contents <font color="#009900">(</font> <font color="#3366CC">"php: // input"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  $ fh <font color="#339933">=</font> fopen <font color="#009900">(</font> <font color="#3366CC">'data.txt'</font> <font color="#339933">,</font> <font color="#3366CC">'a'</font> <font color="#009900">)</font> or die <font color="#009900">(</font> <font color="#3366CC">'open file'</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000066">if</font> <font color="#009900">(</font> <font color="#339933">-</font> <font color="#CC0000">1</font> <font color="#339933">==</font> fwrite <font color="#009900">(</font> $ fh <font color="#339933">,</font> $ data <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> die <font color="#009900">(</font> <font color="#3366CC">'write data'</font> <font color="#009900">)</font> <font color="#339933">;</font>  <font color="#009900">}</font> <br>  fclose <font color="#009900">(</font> $ fh <font color="#009900">)</font> or die <font color="#009900">(</font> <font color="#3366CC">'close file'</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#339933">?&gt;</font> </blockquote><br><br><h5>  3. Add a subscription </h5><br>  After that we will use the new tool for developers of Facebook - <a href="https://developers.facebook.com/tools/explorer/">Graph API Explorer</a> . <br><img src="http://img190.imageshack.us/img190/2502/graphapiexplorer.jpg"><br><br>  Select a POST request to add a subscription and fill in all the fields.  To get access_token (applications), open the link in the browser by filling in the app-id and app-secret data of your application. <pre>  https://graph.facebook.com/oauth/access_token?client_id=&lt;app-id&gt;&amp;client_secret=&lt;app-secret&gt;&amp;grant_type=client_credentials </pre><br>  The path to the script can be facebook / callback.php for example.  It is important that you take the app-secret from the application settings, and you invent the secret code in verify_token yourself! <br><br>  So, if after clicking Submit in the gray box below, nothing happened, then you still added a subscription to the friends of the user object's friends, and now as soon as any user of your application adds or deletes one of the friends, Facebook will send you a callback_url .  In my example, I added a subscription to the permissions offline_access object. <br><br><h5>  4. Create user activity </h5><br>  If your application has been installed, do not worry.  If not, too.  The sequence of actions is the same. <br><br>  First you need to add the offline_access permission.  If the application has not been installed, it will happen automatically.  My application is not installed.  I will try to call the authorization window through the browser line.  Open the link by replacing the app-id with the id of your application, and replacing the site-url with http: // &lt;your domain&gt;: <br><pre>  https://www.facebook.com/dialog/oauth?client_id=&lt;app-id&gt;&amp;redirect_uri=&lt;site-url&gt;&amp;scope=offline_access </pre><br><img src="https://habrastorage.org/storage1/c3673e68/a6e673f6/18848307/10f1085b.jpg"><br><br>  After successful authorization Facebook redirects you to http: // &lt;your domain&gt; /? Code = ... <br><br>  According to the logic that is contained in the script ‚Äî when processing an incoming notification, we simply add the transferred JSON-encoded string to the text data.txt file, which will be in the same directory as the script.  Check if this file has been created and what information it contains. <br><br>  My added information looks like this: <br> <code>{"object":"permissions","entry":[{"uid":"100001828786121","id":"100001828786121","time":1310669052,"changed_fields":["connected"]},{"uid":"100001828786121","id":"100001828786121","time":1310669052,"changed_fields":["offline_access"]}]}</code> <br> <br>  As you can see, I installed the application and allowed offline_access permission.  By uid, you can define a user whose data has changed, and by time, the time of addition. <br><br><h5>  5. Actions on deletion </h5><br>  You can go to <a href="http://www.facebook.com/settings/%3Ftab%3Dapplications">the application settings</a> on Facebook, open your application and remove the offline_access resolution.  In the data.txt file you will see that you have again been notified.  You can also add or remove someone from your friends - you will see that these notifications you subscribe to will be sent to callback_url and processed by your script. <br><br><h5>  findings </h5><br>  Now you know about the great Facebook feature Real-Time Updates, which can send you information about changes in user data and permissions.  Unfortunately, for some reason, when the user deletes the application, the data has not changed.  Therefore, as if the new method did not save time and resources - after all, when implementing certain tasks (for example, sending a mailing list to all users of the application), it is worthwhile to bypass the usual API of all users in your database, checking whether your application is installed . </div><p>Source: <a href="https://habr.com/ru/post/124195/">https://habr.com/ru/post/124195/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124183/index.html">A pack of old school pixel icons, soon 4000</a></li>
<li><a href="../124185/index.html">Official apology and movie Lebedev</a></li>
<li><a href="../124189/index.html">Tablet vs netbook</a></li>
<li><a href="../124193/index.html">Update 2.3 for Desire Z breaks the phone</a></li>
<li><a href="../124194/index.html">Corporation dough decided to patent another half dozen things</a></li>
<li><a href="../124196/index.html">Welcome to Debian Day!</a></li>
<li><a href="../124198/index.html">Robot "Inchworm" based on Arduino Nano</a></li>
<li><a href="../124199/index.html">Heroes ABBYY Cup</a></li>
<li><a href="../124202/index.html">Wine Basics for Beginners</a></li>
<li><a href="../124203/index.html">Mobile site speed optimization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>