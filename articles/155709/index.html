<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data transfer via features API to Drupal - add a new component for export</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I needed to transfer the metatag module settings from a local server to a combat server. For this, I wanted to use the features module, but ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data transfer via features API to Drupal - add a new component for export</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/934/a34/492/934a344928d0aa551716347c116bb92a.jpg">  Recently, I needed to transfer the metatag module settings from a local server to a combat server.  For this, I wanted to use the <a href="http://drupal.org/project/features">features</a> module, but I was disappointed - the metatag module does not support the features API.  Googling did nothing, I found only a few crutches, like "dump the metatags_config table and execute the query in combat".  So I decided to figure out how to add a new entity for transferring through features. <br><a name="habracut"></a><br><br>  I will tell how to do this on the example of the metatag module. <br>  First you need to implement the features_api hook, it defines the components for export via features. <br><blockquote>  <font color="#009933">/ **</font> <font color="#009933"><br></font>  <font color="#009933">* Implements hook_features_api ().</font> <font color="#009933"><br></font>  <font color="#009933">* /</font> <br>  <font color="#000000">function</font> metatag_features_api <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ components</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> <br>  <font color="#0000ff">'metatags'</font> <font color="#339933">=&gt;</font> <font color="#990000">array</font> <font color="#009900">(</font> <br>  <font color="#0000ff">'name'</font> <font color="#339933">=&gt;</font> t <font color="#009900">(</font> <font color="#0000ff">'metatags'</font> <font color="#009900">)</font> <font color="#339933">,</font> <br>  <font color="#0000ff">'features_source'</font> <font color="#339933">=&gt;</font> <font color="#009900">TRUE</font> <font color="#339933">,</font> <br>  <font color="#0000ff">'default_hook'</font> <font color="#339933">=&gt;</font> <font color="#0000ff">'metatag_export_default'</font> <font color="#339933">,</font> <br>  <font color="#0000ff">'default_file'</font> <font color="#339933">=&gt;</font> FEATURES_DEFAULTS_INCLUDED <font color="#339933">,</font> <br>  <font color="#0000ff">'file'</font> <font color="#339933">=&gt;</font> drupal_get_path <font color="#009900">(</font> <font color="#0000ff">'module'</font> <font color="#339933">,</font> <font color="#0000ff">'metatag'</font> <font color="#009900">)</font> <font color="#339933">.</font>  <font color="#0000ff">'/metatag.features.inc'</font> <font color="#339933">,</font> <br>  <font color="#009900">)</font> <font color="#339933">,</font> <br>  <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">return</font> <font color="#000088">$ components</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br></blockquote><br>  It is worth paying attention to the key of the default_hook array.  It defines the hook that will be used to get the data from the feature.  I think it is no secret to anyone that the "feature" is a module.  We will implement the metatag_export_default hook in this module and will combine the exported data there.  The rest of the hooks I brought to a separate file metatag.features.inc <br><br>  Another important point is that hook_features_api is a regular hook and works like MODULE_NAME_features_api.  The rest of the hooks to be discussed are formed using the name of the exported component instead of the module name as usual.  For example, features_export_options hook. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this hook, we return an array with items that can be transferred via a feature.  In the case of the metatag module, this is an array of pointers to meta tag options for various types of pages (for example global, node, taxonomy_term). <br><br><blockquote>  <font color="#009933">/ **</font> <font color="#009933"><br></font>  <font color="#009933">* Implements hook_features_export_options ().</font> <font color="#009933"><br></font>  <font color="#009933">* /</font> <br>  <font color="#000000">function</font> metatags_features_export_options <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ instances</font> <font color="#339933">=</font> metatag_config_instance_info <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ instances</font> <font color="#b1b100">as</font> <font color="#000088">$ key</font> <font color="#339933">=&gt;</font> <font color="#000088">$ instance</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ options</font> <font color="#009900">[</font> <font color="#000088">$ key</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ key</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#339933">;</font> <br>  <font color="#b1b100">return</font> <font color="#000088">$ options</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  These items will be available in the corresponding section metatags when creating a new "feature" <br><br><img src="https://habrastorage.org/storage2/03e/29c/12b/03e29c12bfd88999bd2fef9459a92cd3.png"><br><br>  The next features_export_render hook, it generates a code for the features file in which the exported data is stored. <br><br><blockquote>  <font color="#009933">/ **</font> <font color="#009933"><br></font>  <font color="#009933">* Implements hook_features_export_render ().</font> <font color="#009933"><br></font>  <font color="#009933">* /</font> <br>  <font color="#000000">function</font> metatags_features_export_render <font color="#009900">(</font> <font color="#000088">$ module_name</font> <font color="#339933">,</font> <font color="#000088">$ data</font> <font color="#339933">,</font> <font color="#000088">$ export</font> <font color="#339933">=</font> <font color="#009900">NULL</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ code</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ code</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">'$ config = array ();'</font>  <font color="#339933">;</font> <br>  <font color="#000088">$ code</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">''</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ data</font> <font color="#b1b100">as</font> <font color="#000088">$ key</font> <font color="#339933">=&gt;</font> <font color="#000088">$ name</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">is_object</font> <font color="#009900">(</font> <font color="#000088">$ name</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ name</font> <font color="#339933">=</font> <font color="#000088">$ name</font> <font color="#339933">-&gt;</font> <font color="#004000">instance</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ config</font> <font color="#339933">=</font> metatag_config_load <font color="#009900">(</font> <font color="#000088">$ name</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ export</font> <font color="#339933">=</font> <font color="#000000">new</font> stdClass <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ export</font> <font color="#339933">-&gt;</font> <font color="#004000">instance</font> <font color="#339933">=</font> <font color="#000088">$ config</font> <font color="#339933">-&gt;</font> <font color="#004000">instance</font> <font color="#339933">;</font> <br>  <font color="#000088">$ export</font> <font color="#339933">-&gt;</font> <font color="#004000">config</font> <font color="#339933">=</font> <font color="#000088">$ config</font> <font color="#339933">-&gt;</font> <font color="#004000">config</font> <font color="#339933">;</font> <br>  <font color="#000088">$ export</font> <font color="#339933">=</font> features_var_export <font color="#009900">(</font> <font color="#000088">$ export</font> <font color="#339933">,</font> <font color="#0000ff">''</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ key</font> <font color="#339933">=</font> features_var_export <font color="#009900">(</font> <font color="#000088">$ name</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ code</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">"// Exported metatags config instance: <font color="#006699">{$ name}</font> ."</font>  <font color="#339933">;</font> <br>  <font color="#000088">$ code</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">" <font color="#006699">$ config</font> [ <font color="#006699">{$ key}</font> ] = <font color="#006699">{$ export}</font> ;"</font>  <font color="#339933">;</font> <br>  <font color="#000088">$ code</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">""</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#000088">$ code</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#0000ff">'return $ config;'</font>  <font color="#339933">;</font> <br>  <font color="#000088">$ code</font> <font color="#339933">=</font> <font color="#990000">implode</font> <font color="#009900">(</font> <font color="#0000ff">"n"</font> <font color="#339933">,</font> <font color="#000088">$ code</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">return</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#0000ff">'metatag_export_default'</font> <font color="#339933">=&gt;</font> <font color="#000088">$ code</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br>  The $ data array is passed to the hook.  It contains the same items that you selected when creating the ‚Äúfeatures‚Äù in the first screenshot.  On these points, approximately the following code is formed. <br><br><img src="https://habrastorage.org/storage2/865/ef0/796/865ef079655de2534fed786d95e0a85c.png"><br><br>  Please note that in the hook code and in the screenshot there is the same metatag_export_default hook, which we defined at the very beginning in features_api. <br><br>  The features_export hook allows you to write data to the $ export array using the $ data array.  Also here you can complicate the structure of the stored data by dividing them into categories. <br><br><blockquote>  <font color="#009933">/ **</font> <font color="#009933"><br></font>  <font color="#009933">* Implements hook_features_export</font> <font color="#009933"><br></font>  <font color="#009933">* /</font> <br>  <font color="#000000">function</font> metatags_features_export <font color="#009900">(</font> <font color="#000088">$ data</font> <font color="#339933">,</font> <font color="#339933">&amp;</font> <font color="#000088">$ export</font> <font color="#339933">,</font> <font color="#000088">$ module_name</font> <font color="#339933">=</font> <font color="#0000ff">''</font> <font color="#339933">,</font> <font color="#000088">$ type</font> <font color="#339933">=</font> <font color="#0000ff">'metatags'</font> <font color="#009900">)</font> <font color="#009900">{</font> <br><br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ data</font> <font color="#b1b100">as</font> <font color="#000088">$ name</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ export</font> <font color="#009900">[</font> <font color="#0000ff">'features'</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#000088">$ type</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#000088">$ name</font> <font color="#009900">]</font> <font color="#339933">=</font> metatag_config_load <font color="#009900">(</font> <font color="#000088">$ name</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br>  The items that were exported through the feature are transferred to the $ data array.  For these items, the state is loaded which is stored in the database. <br><br>  In order to find the differences between the state of "features" and the state in the database, the "features_export" and "metatag_export_default" hooks are used.  The first one gets the state from the database, the second one returns the state of the data in the "feature".  These states are compared and you can see the differences as in the screenshot. <br><br><img src="https://habrastorage.org/storage2/bde/f17/431/bdef17431f1882b48356b9204ba344d4.png"><br><br>  If there are differences between "features" and the state in the database, two options are possible. <br>  The first is to update the feature, for example, using the drush fu command FITNAME.  In this case, features_export and features_export_render are used.  As a result, the feature code will be updated in accordance with the state in the database. <br><br>  The second option is revert - reset the state in the database to what is stored in the "feature".  In order to revert, you will need features_revert hook. <br><br><blockquote>  <font color="#009933">/ **</font> <font color="#009933"><br></font>  <font color="#009933">* Implements hook_features_revert ().</font> <font color="#009933"><br></font>  <font color="#009933">* /</font> <br>  <font color="#000000">function</font> metatags_features_revert <font color="#009900">(</font> <font color="#000088">$ module</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ function</font> <font color="#339933">=</font> <font color="#0000ff">" <font color="#006699">{$ module}</font> _metatag_export_default"</font> <font color="#339933">;</font> <br>  <font color="#000088">$ feature_conf</font> <font color="#339933">=</font> <font color="#000088">$ function</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ default_config</font> <font color="#339933">=</font> features_get_default <font color="#009900">(</font> <font color="#0000ff">'metatags'</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#990000">array_keys</font> <font color="#009900">(</font> <font color="#000088">$ default_config</font> <font color="#009900">)</font> <font color="#b1b100">as</font> <font color="#000088">$ config</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ conf</font> <font color="#339933">=</font> metatag_config_load <font color="#009900">(</font> <font color="#000088">$ config</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  db_delete <font color="#009900">(</font> <font color="#0000ff">'metatag_config'</font> <font color="#009900">)</font> <font color="#339933">-&gt;</font> <font color="#004000">condition</font> <font color="#009900">(</font> <font color="#0000ff">'instance'</font> <font color="#339933">,</font> <font color="#000088">$ config</font> <font color="#009900">)</font> <font color="#339933">-&gt;</font> <font color="#004000">execute</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#990000">unset</font> <font color="#009900">(</font> <font color="#000088">$ feature_conf</font> <font color="#009900">[</font> <font color="#000088">$ config</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#0000ff">'cid'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ object</font> <font color="#339933">=</font> <font color="#000000">new</font> stdClass <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ object</font> <font color="#339933">-&gt;</font> <font color="#004000">cid</font> <font color="#339933">=</font> <font color="#009900">NULL</font> <font color="#339933">;</font> <br>  <font color="#000088">$ object</font> <font color="#339933">-&gt;</font> <font color="#004000">instance</font> <font color="#339933">=</font> <font color="#000088">$ config</font> <font color="#339933">;</font> <br>  <font color="#000088">$ object</font> <font color="#339933">-&gt;</font> <font color="#004000">config</font> <font color="#339933">=</font> <font color="#000088">$ feature_conf</font> <font color="#009900">[</font> <font color="#000088">$ config</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#0000ff">'config'</font> <font color="#009900">]</font> <font color="#339933">;</font> <br>  metatag_config_save <font color="#009900">(</font> <font color="#000088">$ object</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br>  In the hook itself, you will need to implement a code that updates the data in the database in accordance with the code in the feature. <br>  That's all, I hope this article will be useful. <br><br>  Link to the <a href="http://drupal.org/files/metatag-export-config-through-features-1818300_1.patch">patch for the metatag module</a> </div><p>Source: <a href="https://habr.com/ru/post/155709/">https://habr.com/ru/post/155709/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155697/index.html">Original ZX Spectrum +3, drive repair drive</a></li>
<li><a href="../155699/index.html">Friends, we announce a set of creative ideas!</a></li>
<li><a href="../155701/index.html">At 10:00, watch the online broadcast of Windows 8 Summit right here.</a></li>
<li><a href="../155705/index.html">Coworking "Workstation"</a></li>
<li><a href="../155707/index.html">Domestic author blogs for geeks</a></li>
<li><a href="../155713/index.html">iPad Mini: come see me</a></li>
<li><a href="../155721/index.html">Once again about learning languages ‚Äã‚Äã(part 2)</a></li>
<li><a href="../155723/index.html">Post-travel or rules of work on the road</a></li>
<li><a href="../155725/index.html">Googlebot performs Javascript with a three-day delay.</a></li>
<li><a href="../155735/index.html">How to install 1C Enterprise 8.2 (release 8.2.16.368 from 10/05/12) on CentOS 6.3 (article, HowTo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>