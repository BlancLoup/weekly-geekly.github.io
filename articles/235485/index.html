<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yii2 RBAC setup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task 
 Configure the use of RBAC in Yii2. 

 Conditions 
 List of possible roles: 


- guest - not authorized user; 
- BRAND - an authorized user, inh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yii2 RBAC setup</h1><div class="post__text post__text-html js-mediator-article"><h4>  Task </h4><br>  Configure the use of RBAC in Yii2. <br><br><h4>  Conditions </h4><br>  List of possible roles: <br><ul><li>  <b>guest</b> - not authorized user; </li><li>  <b>BRAND</b> - an authorized user, inherits the permissions of the <b>guest</b> role and has its own unique permissions; </li><li>  <b>TALENT</b> - an authorized user, inherits the permissions of the <b>guest</b> role and has its own unique permissions; </li><li>  <b>admin</b> is an authorized user, inherits the permissions of the <b>guest</b> , <b>BRAND</b> and <b>TALENT roles</b> and has its own unique permissions. </li><li>  The role is determined by the <b>group</b> field in the <b>UserExt</b> model; </li><li>  Roles have a nested structure ‚Äî one role can inherit permissions from another; </li><li>  Used by <b>yii \ rbac \ PhpManager</b> ; </li><li>  Do not use the role assignment to the user by his ID - instead, use several default roles ( <b>defaultRoles</b> ); </li><li>  The generation of the ‚Äúrole-permission‚Äù <b>config</b> will be done by the console command <b>yii</b> ; </li><li>  Extended permissions will be used. </li></ul><br><br><h4>  Presetting </h4><br> <i><code>app/config/console.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'components'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// ... 'authManager' =&gt; [ 'class' =&gt; 'yii\rbac\PhpManager', ], // ... ],</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <i><code>app/config/web.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'components'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// ... 'authManager' =&gt; [ 'class' =&gt; 'yii\rbac\PhpManager', 'defaultRoles' =&gt; ['admin', 'BRAND', 'TALENT'], //    "guest", ..         UserExt ], // ... ],</span></span></code> </pre><br><br>  Create the <i><code>@app/rbac</code></i> - it will contain permissions and rules. <br><a name="habracut"></a><br><h4>  Creating permissions </h4><br>  In the <i><code>@app/commands</code></i> directory create a controller that will generate an array of permissions: <br> <i><code>app/commands/RbacController.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">commands</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">console</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>\<span class="hljs-title"><span class="hljs-title">UserGroupRule</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RbacController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $authManager = \Yii::$app-&gt;authManager; <span class="hljs-comment"><span class="hljs-comment">// Create roles $guest = $authManager-&gt;createRole('guest'); $brand = $authManager-&gt;createRole('BRAND'); $talent = $authManager-&gt;createRole('TALENT'); $admin = $authManager-&gt;createRole('admin'); // Create simple, based on action{$NAME} permissions $login = $authManager-&gt;createPermission('login'); $logout = $authManager-&gt;createPermission('logout'); $error = $authManager-&gt;createPermission('error'); $signUp = $authManager-&gt;createPermission('sign-up'); $index = $authManager-&gt;createPermission('index'); $view = $authManager-&gt;createPermission('view'); $update = $authManager-&gt;createPermission('update'); $delete = $authManager-&gt;createPermission('delete'); // Add permissions in Yii::$app-&gt;authManager $authManager-&gt;add($login); $authManager-&gt;add($logout); $authManager-&gt;add($error); $authManager-&gt;add($signUp); $authManager-&gt;add($index); $authManager-&gt;add($view); $authManager-&gt;add($update); $authManager-&gt;add($delete); // Add rule, based on UserExt-&gt;group === $user-&gt;group $userGroupRule = new UserGroupRule(); $authManager-&gt;add($userGroupRule); // Add rule "UserGroupRule" in roles $guest-&gt;ruleName = $userGroupRule-&gt;name; $brand-&gt;ruleName = $userGroupRule-&gt;name; $talent-&gt;ruleName = $userGroupRule-&gt;name; $admin-&gt;ruleName = $userGroupRule-&gt;name; // Add roles in Yii::$app-&gt;authManager $authManager-&gt;add($guest); $authManager-&gt;add($brand); $authManager-&gt;add($talent); $authManager-&gt;add($admin); // Add permission-per-role in Yii::$app-&gt;authManager // Guest $authManager-&gt;addChild($guest, $login); $authManager-&gt;addChild($guest, $logout); $authManager-&gt;addChild($guest, $error); $authManager-&gt;addChild($guest, $signUp); $authManager-&gt;addChild($guest, $index); $authManager-&gt;addChild($guest, $view); // BRAND $authManager-&gt;addChild($brand, $update); $authManager-&gt;addChild($brand, $guest); // TALENT $authManager-&gt;addChild($talent, $update); $authManager-&gt;addChild($talent, $guest); // Admin $authManager-&gt;addChild($admin, $delete); $authManager-&gt;addChild($admin, $talent); $authManager-&gt;addChild($admin, $brand); } }</span></span></code> </pre><br><br>  The <b>UserGroupRule</b> class is responsible for checking the equality of the role of the current user, the role specified in the array of permissions.  By this we avoid problems with assigning a role to a user by his ID. <br> <i><code>app/rbac/UserGroupRule.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>\<span class="hljs-title"><span class="hljs-title">Rule</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserGroupRule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name = <span class="hljs-string"><span class="hljs-string">'userGroup'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($user, $item, $params)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!\Yii::$app-&gt;user-&gt;isGuest) { $group = \Yii::$app-&gt;user-&gt;identity-&gt;group; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($item-&gt;name === <span class="hljs-string"><span class="hljs-string">'admin'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $group == <span class="hljs-string"><span class="hljs-string">'admin'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($item-&gt;name === <span class="hljs-string"><span class="hljs-string">'BRAND'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $group == <span class="hljs-string"><span class="hljs-string">'admin'</span></span> || $group == <span class="hljs-string"><span class="hljs-string">'BRAND'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($item-&gt;name === <span class="hljs-string"><span class="hljs-string">'TALENT'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $group == <span class="hljs-string"><span class="hljs-string">'admin'</span></span> || $group == <span class="hljs-string"><span class="hljs-string">'TALENT'</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre><br><br>  Now you can remove the <b>access</b> rule in the controller from the <b>behaviors</b> method: <br> <i><code>app/controllers/SiteController.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">behaviors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-comment"><span class="hljs-comment">// ... 'access' =&gt; [ 'class' =&gt; AccessControl::className(), 'only' =&gt; ['logout'], 'rules' =&gt; [ [ 'actions' =&gt; ['logout'], 'allow' =&gt; true, 'roles' =&gt; ['@'], ], ], ], // ... ]; }</span></span></code> </pre><br><br><h4>  Access check </h4><br>  Method 1 - in the controller method: <br> <i><code>app/controllers/SiteController.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionAbout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!\Yii::$app-&gt;user-&gt;can(<span class="hljs-string"><span class="hljs-string">'about'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ForbiddenHttpException(<span class="hljs-string"><span class="hljs-string">'Access denied'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'about'</span></span>); }</code> </pre><br><br>  Method 2 - register <b>beforeAction</b> in order not to write <i><code>"if !\Yii::$app-&gt;user-&gt;can"</code></i> in each method: <br> <i><code>app/controllers/SiteController.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::beforeAction($action)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!\Yii::$app-&gt;user-&gt;can($action-&gt;id)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ForbiddenHttpException(<span class="hljs-string"><span class="hljs-string">'Access denied'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre><br><br><h4>  Generating Permission Files </h4><br>  To generate a file with an array of permissions, run the following command in the project root: <br><blockquote>  <b>Attention!</b> <br>  Before executing this command, you must delete the <i><code>@app/rbac/items.php</code></i> and <i><code>@app/rbac/rules.php</code></i> to avoid merge conflicts <br></blockquote><br><pre> <code class="bash hljs">./yii rbac/init</code> </pre><br><br>  Two files should appear in the <i><code>@app/rbac</code></i> directory: <br> <i><code>app/rbac/items.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'login'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'logout'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'error'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'sign-up'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'index'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'view'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'update'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'delete'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, ], <span class="hljs-string"><span class="hljs-string">'guest'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ruleName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'userGroup'</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'logout'</span></span>, <span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-string"><span class="hljs-string">'sign-up'</span></span>, <span class="hljs-string"><span class="hljs-string">'index'</span></span>, <span class="hljs-string"><span class="hljs-string">'view'</span></span>, ], ], <span class="hljs-string"><span class="hljs-string">'BRAND'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ruleName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'userGroup'</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'update'</span></span>, <span class="hljs-string"><span class="hljs-string">'guest'</span></span>, ], ], <span class="hljs-string"><span class="hljs-string">'TALENT'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'ruleName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'userGroup'</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'update'</span></span>, <span class="hljs-string"><span class="hljs-string">'guest'</span></span>, ], ], <span class="hljs-string"><span class="hljs-string">'admin'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'delete'</span></span>, <span class="hljs-string"><span class="hljs-string">'TALENT'</span></span>, <span class="hljs-string"><span class="hljs-string">'BRAND'</span></span>, ], ], ];</code> </pre><br><br> <i><code>app/rbac/rules.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'userGroup'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'O:22:"app\\rbac\\UserGroupRule":3:{s:4:"name";s:9:"userGroup";s:9:"createdAt";N;s:9:"updatedAt";N;}'</span></span>, ];</code> </pre><br><br><h4>  Extended <b>Rule</b> for Permissions </h4><br>  For example, it is necessary to prohibit users from editing (updating) not their profile.  For this you need an extended rule: <br> <i><code>app/rbac/UserProfileOwnerRule.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>\<span class="hljs-title"><span class="hljs-title">Rule</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>\<span class="hljs-title"><span class="hljs-title">Item</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserProfileOwnerRule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name = <span class="hljs-string"><span class="hljs-string">'isProfileOwner'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string|integer $user the user ID. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Item $item the role or permission that this rule is associated with * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $params parameters passed to ManagerInterface::checkAccess(). * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean a value indicating whether the rule permits the role or permission it is associated with. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($user, $item, $params)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (\Yii::$app-&gt;user-&gt;identity-&gt;group == <span class="hljs-string"><span class="hljs-string">'admin'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($params[<span class="hljs-string"><span class="hljs-string">'profileId'</span></span>]) ? \Yii::$app-&gt;user-&gt;id == $params[<span class="hljs-string"><span class="hljs-string">'profileId'</span></span>] : <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre><br><br>  In the file <i><code>@app/rbac/RbacController.php</code></i> add: <br> <i><code>app/rbac/RbacController.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">rbac</span></span>\<span class="hljs-title"><span class="hljs-title">UserProfileOwnerRule</span></span>; <span class="hljs-comment"><span class="hljs-comment">// add the rule $userProfileOwnerRule = new UserProfileOwnerRule(); $authManager-&gt;add($userProfileOwnerRule); $updateOwnProfile = $authManager-&gt;createPermission('updateOwnProfile'); $updateOwnProfile-&gt;ruleName = $userProfileOwnerRule-&gt;name; $authManager-&gt;add($updateOwnProfile); $authManager-&gt;addChild($brand, $updateOwnProfile); $authManager-&gt;addChild($talent, $updateOwnProfile);</span></span></code> </pre><br><br>  Test access in the controller method: <br> <i><code>app/controllers/UsersController.php</code></i> <br> <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!\Yii::$app-&gt;user-&gt;can(<span class="hljs-string"><span class="hljs-string">'updateOwnProfile'</span></span>, [<span class="hljs-string"><span class="hljs-string">'profileId'</span></span> =&gt; \Yii::$app-&gt;user-&gt;id])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ForbiddenHttpException(<span class="hljs-string"><span class="hljs-string">'Access denied'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/235485/">https://habr.com/ru/post/235485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235467/index.html">The Skip. How the ‚ÄúSkip Track‚Äù button influenced music consumption patterns</a></li>
<li><a href="../235473/index.html">Cach√© Native Access - working with native libraries in Cach√©</a></li>
<li><a href="../235477/index.html">Firefox 32 release</a></li>
<li><a href="../235479/index.html">Another "smart" outlet with your own hands. Part 1</a></li>
<li><a href="../235483/index.html">On the verge of madness</a></li>
<li><a href="../235487/index.html">How we (almost) defeated DirCrypt</a></li>
<li><a href="../235489/index.html">Apple Update Review Guideline, Redget Statistics and All Reports from the Unity Event - Main Mobile News for the Week</a></li>
<li><a href="../235491/index.html">Do you really need the source code?</a></li>
<li><a href="../235493/index.html">Structure attachments to list items in Sharepoint 2010</a></li>
<li><a href="../235495/index.html">How to buy shares of IT companies before, during and after the IPO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>