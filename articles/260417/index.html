<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compile and decompile try-with-resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Compiling and decompiling try-with-resources, or a story about how I fixed a bug and what came of it. 

 Introduction 
 Some time ago, the backlog of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compile and decompile try-with-resources</h1><div class="post__text post__text-html js-mediator-article">  Compiling and decompiling try-with-resources, or a story about how I fixed a bug and what came of it. <br><br><h1>  Introduction </h1><br><img src="https://habrastorage.org/files/889/33d/327/88933d32723e4e5ab03d1b39ac38902a.png" alt="Pitest" align="left">  Some time ago, the backlog of the working draft was almost empty, and various kinds of research tasks surfaced.  One of them sounded quite intriguing: to tie in to the project mutation testing using <a href="http://pitest.org/">PITest</a> .  On Habr√© there is already a very <a href="http://habrahabr.ru/post/139337/">detailed overview of</a> this library (with examples and pictures).  I will not retell this article in my own words, but I still recommend that you first read it. <br><br>  I admit that the idea of ‚Äã‚Äãmutational testing, I fired up.  With almost no extra effort, get a search tool for potentially dangerous code points - it's worth it!  I immediately got down to business.  At that time, the library was relatively young, and as a result, it was very raw: here you need a little mess with the maven configuration, there you can patch the plug-in for Sonar.  However, after a while, I was still able to check the whole project.  Result: hundreds of surviving mutations!  Evolution to scale on our build server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Rolling up my sleeves, I plunged into work.  In some tests, there is not enough verification of stubs, in others, instead of logic, it is generally unclear what is being tested.  Rule, improve, rewrite.  In general, the process has begun, but the number of surviving mutations did not decrease as rapidly as desired.  The reason was simple: PIT gave a huge amount of false positives on the <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a> block.  Short searches have shown that the <a href="https://github.com/hcoles/pitest/issues/48">bug is known</a> , but still not fixed.  Well, the library code is open.  Why not incline it and see what is the matter? <a name="habracut"></a><br><br><h1>  We understand the reasons </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e31/9b6/a55/e319b6a55aa64370a5a27d5260cb86ca.png" alt="TryExample"></div><br>  I threw the <a href="">simplest example</a> , a unit test to it and launched PITest.  The result is in front of you: instead of one, there are eleven surviving mutations, ten of which point to a line with the ‚Äú}‚Äù symbol.  Calls to the <i>close</i> and <i>addSupressed methods</i> suggest that the code generated for the try-with-resources block belongs to this line.  To confirm this guess, I decided to decompile the class file.  For this, I used the <a href="http://jd.benow.ca/">JD-GUI</a> , although now I would recommend the built-in decompiler <a href="https://www.jetbrains.com/idea/">IntelliJ IDEA 14</a> . <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ ByteArrayOutputStream baos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); Throwable var2 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { baos.flush(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable var11) { var2 = var11; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> var11; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (baos != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (var2 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { baos.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable var10) { var2.addSuppressed(var10); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { baos.close(); } } } }</code> </pre> <br>  The guess was confirmed, but the question remained: how did the two lines of try-with-resources turn into a dozen lines of try-catch-finally?  <a href="https://habrahabr.ru/users/gvsmirnov/" class="user_link">gvsmirnov</a> <a href="http://habrahabr.ru/post/143237/">bequeathed us</a> in any incomprehensible situation to download the source code <a href="http://hg.openjdk.java.net/jdk7u/jdk7u/langtools/file/4af9a5de2a39">OpenJDK</a> .  This is what I did. <br><br>  All code related to the try-with-resources compilation task is located between lines 1428 and 1580 of the <a href="">Lower</a> class.  Javadoc tells us that this class is designed to translate syntactic sugar: no magic, only the simplest modifications of the syntax tree.  All in accordance with <a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-14.html">JLS 14.20.3</a> . <br><br>  With the behavior of the compiler figured out.  It remains to understand why the library is trying to mutate the code generated by the compiler and how it works.  Having rummaged in source codes, I clarified the following.  PITest only manipulates bytecode loaded into RAM.  It replaces instructions for specific rules, after which it runs unit tests.  <a href="http://asm.ow2.org/">ASM is</a> used to work with bytecode. <br><br>  The first idea was to intercept the line number from the visitGeneratedTryCatchBlock method's MethodVisitor class, and then just tell the library which line to ignore.  Similar functionality has already <a href="">been implemented</a> for the finally block.  However, I was surprised to learn that the visitGeneratedTryCatchBlock method does not exist.  ASM does not distinguish the code generated by the compiler from the generated by the programmer.  Ambush.  I had to look into bytecode, the output and formatting of which was kindly provided by the <a href="http://asm.ow2.org/asm50/javadoc/user/org/objectweb/asm/util/Textifier.html">Textifier</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Bytecode main method of class TryExample</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// access flags 0x9 public static main([Ljava/lang/String;)V throws java/io/IOException TRYCATCHBLOCK L0 L1 L2 java/lang/Throwable TRYCATCHBLOCK L3 L4 L5 java/lang/Throwable TRYCATCHBLOCK L3 L4 L6 null TRYCATCHBLOCK L7 L8 L9 java/lang/Throwable TRYCATCHBLOCK L5 L10 L6 null L11 LINENUMBER 12 L11 NEW java/io/ByteArrayOutputStream DUP INVOKESPECIAL java/io/ByteArrayOutputStream.&lt;init&gt; ()V ASTORE 1 L12 ACONST_NULL ASTORE 2 L3 LINENUMBER 13 L3 ALOAD 1 INVOKEVIRTUAL java/io/ByteArrayOutputStream.flush ()V L4 LINENUMBER 14 L4 ALOAD 1 IFNULL L13 ALOAD 2 IFNULL L14 L0 ALOAD 1 INVOKEVIRTUAL java/io/ByteArrayOutputStream.close ()V L1 GOTO L13 L2 FRAME FULL [[Ljava/lang/String; java/io/ByteArrayOutputStream java/lang/Throwable] [java/lang/Throwable] ASTORE 3 L15 ALOAD 2 ALOAD 3 INVOKEVIRTUAL java/lang/Throwable.addSuppressed (Ljava/lang/Throwable;)V L16 GOTO L13 L14 FRAME SAME ALOAD 1 INVOKEVIRTUAL java/io/ByteArrayOutputStream.close ()V GOTO L13 L5 LINENUMBER 12 L5 FRAME SAME1 java/lang/Throwable ASTORE 3 ALOAD 3 ASTORE 2 ALOAD 3 ATHROW L6 LINENUMBER 14 L6 FRAME SAME1 java/lang/Throwable ASTORE 4 L10 ALOAD 1 IFNULL L17 ALOAD 2 IFNULL L18 L7 ALOAD 1 INVOKEVIRTUAL java/io/ByteArrayOutputStream.close ()V L8 GOTO L17 L9 FRAME FULL [[Ljava/lang/String; java/io/ByteArrayOutputStream java/lang/Throwable T java/lang/Throwable] [java/lang/Throwable] ASTORE 5 L19 ALOAD 2 ALOAD 5 INVOKEVIRTUAL java/lang/Throwable.addSuppressed (Ljava/lang/Throwable;)V L20 GOTO L17 L18 FRAME SAME ALOAD 1 INVOKEVIRTUAL java/io/ByteArrayOutputStream.close ()V L17 FRAME SAME ALOAD 4 ATHROW L13 LINENUMBER 15 L13 FRAME FULL [[Ljava/lang/String;] [] RETURN L21 LOCALVARIABLE x2 Ljava/lang/Throwable; L15 L16 3 LOCALVARIABLE x2 Ljava/lang/Throwable; L19 L20 5 LOCALVARIABLE baos Ljava/io/ByteArrayOutputStream; L12 L13 1 LOCALVARIABLE args [Ljava/lang/String; L11 L21 0 MAXSTACK = 2 MAXLOCALS = 6</span></span></code> </pre> </div></div><br>  The naive assumption that the try-catch-finally block is implemented at the JVM level has <a href="http://habrahabr.ru/post/212759/">not been confirmed</a> .  There is no special instruction for it, only the exception table and goto between the labels.  It turns out, standard means to recognize the generated block will not work.  We need to look for another solution. <br><br><h1>  What if‚Ä¶ </h1><br>  Before I started guessing at the coffee grounds, I decided to put the bytecode tags on the decompiled class.  That's what came out of it. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ ByteArrayOutputStream baos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); <span class="hljs-comment"><span class="hljs-comment">// L11 Throwable primaryExc = null; // L12 try { baos.flush(); // L3 } catch (Throwable t) { // L5 primaryExc = t; throw t; } finally { // L6 if (baos != null) { // L4 L10 if (primaryExc != null) { try { baos.close(); // L0 L7 } catch (Throwable suppressedExc) { // L2 L9 primaryExc.addSuppressed(suppressedExc); // L15 L19 } // L1 L16 L8 L20 } else { baos.close(); // L14 L18 } } // L17 } // L13 }</span></span></code> </pre> <br>  There are clearly two main ways of executing the program: <br><pre> L11 L12 L3 {L4 [L0 (L2 L15 L16) L1] L14} L13
 L11 L12 L3 [L5 {L6] L10 [L7 (L9 L19 L20) L8] L18 L17}
</pre><br>  There are labels under each other, whose code blocks match or almost match.  In parentheses is the code that will be executed when the <i>close</i> method throws an exception.  Similarly, in square - when the method <i>flush</i> .  Two ways came from the fact that the finally block was substituted by the compiler twice.  And now, to finally break down your visual parser: the labels in curly brackets refer to line 11. The PITest false positives refer to the same line. <br><br>  Here is the solution!  It is necessary to select a minimally repeating set of instructions.  If such a set is found in the checked bytecode, and even on one line - there is a generated code for the try-with-resources block.  It does not sound very ironic, but I decided to try.  Below is a list of instructions that I ended up with. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Integer&gt; JAVAC_CLASS_INS_SEQUENCE = Arrays.asList( ASTORE, <span class="hljs-comment"><span class="hljs-comment">// store throwable ALOAD, IFNULL, // closeable != null ALOAD, IFNULL, // localThrowable2 != null ALOAD, INVOKEVIRTUAL, GOTO, // closeable.close() ASTORE, // Throwable x2 ALOAD, ALOAD, INVOKEVIRTUAL, GOTO, // localThrowable2.addSuppressed(x2) ALOAD, INVOKEVIRTUAL, // closeable.close() ALOAD, ATHROW); // throw throwable</span></span></code> </pre> <br>  Approximately so it can be compared to the code in the finally block. <br><br><pre> <code class="java hljs">} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (closeable != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// IFNULL if (localThrowable2 != null) { // IFNULL try { closeable.close(); // INVOKEVIRTUAL or INVOKEINTERFACE } catch (Throwable x2) { localThrowable2.addSuppressed(x2); // INVOKEVIRTUAL } } else { closeable.close(); // INVOKEVIRTUAL or INVOKEINTERFACE } } } // ATHROW</span></span></code> </pre> <br>  ‚ÄúNot so difficult,‚Äù I thought after several days of hard work.  I threw a <a href="https://github.com/artspb/try-with-resources-examples">few more examples</a> ;  wrote tests that use them.  Everything is fine, everything works.  I tried to build PITest to run it on live code: tests crashed.  Not the ones I wrote;  others. <br><br><h1>  Compilers are different </h1><br>  So, the code has moved from the ‚Äúnot compiled‚Äù stage to the ‚Äúnot working‚Äù stage.  One of the tests that existed before has fallen.  Rolled back - works.  Inside the test, the <i>Java7TryWithResources.class.bin</i> file is <i>checked</i> , which was already in the project.  After printing bytecode, I could not believe my eyes: a completely different order of instructions was used to compile try-with-resources! <br><br>  Trying not to panic, I began to check all the compilers at hand.  I worked with javac from Oracle JDK, javac from OpenJDK was expected to give a similar result.  I tried different versions: to no avail.  It was the turn of the compilers, which were not at hand.  Eclipse Compiler for Java, ECJ.  Compiled, printed baytkod - at first glance it looks like the one I'm looking for. <br><br><div class="spoiler">  <b class="spoiler_title">Bytecode main method of class TryExample by ECJ</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">// access flags 0x9 public static main([Ljava/lang/String;)V throws java/io/IOException TRYCATCHBLOCK L0 L1 L2 null TRYCATCHBLOCK L3 L4 L4 null L5 LINENUMBER 12 L5 ACONST_NULL ASTORE 1 ACONST_NULL ASTORE 2 L3 NEW java/io/ByteArrayOutputStream DUP INVOKESPECIAL java/io/ByteArrayOutputStream.&lt;init&gt; ()V ASTORE 3 L0 LINENUMBER 13 L0 ALOAD 3 INVOKEVIRTUAL java/io/ByteArrayOutputStream.flush ()V L1 LINENUMBER 14 L1 ALOAD 3 IFNULL L6 ALOAD 3 INVOKEVIRTUAL java/io/ByteArrayOutputStream.close ()V GOTO L6 L2 FRAME FULL [[Ljava/lang/String; java/lang/Throwable java/lang/Throwable java/io/ByteArrayOutputStream] [java/lang/Throwable] ASTORE 1 ALOAD 3 IFNULL L7 ALOAD 3 INVOKEVIRTUAL java/io/ByteArrayOutputStream.close ()V L7 FRAME CHOP 1 ALOAD 1 ATHROW L4 FRAME SAME1 java/lang/Throwable ASTORE 2 ALOAD 1 IFNONNULL L8 ALOAD 2 ASTORE 1 GOTO L9 L8 FRAME SAME ALOAD 1 ALOAD 2 IF_ACMPEQ L9 ALOAD 1 ALOAD 2 INVOKEVIRTUAL java/lang/Throwable.addSuppressed (Ljava/lang/Throwable;)V L9 FRAME SAME ALOAD 1 ATHROW L6 LINENUMBER 15 L6 FRAME CHOP 2 RETURN MAXSTACK = 2 MAXLOCALS = 4</span></span></code> </pre> </div></div><br>  After that I decided to decompile the resulting class file.  The result of the work of the decompiler refused to compile.  Well, nothing, you can already work with it.  Having brought the program code into accord with bytecode, I got the following. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] paramArrayOfString)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ Throwable primaryExceptionVariable = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// L5 Throwable caughtThrowableVariable = null; try { ByteArrayOutputStream baos = new ByteArrayOutputStream(); // L3 try { baos.flush(); // L0 } catch (Throwable t) { primaryExceptionVariable = t; // L2 throw primaryExceptionVariable; // L7 } finally { if (baos != null) { // L1 baos.close(); } } } catch (Throwable t) { caughtThrowableVariable = t; // L4 if (primaryExceptionVariable == null) { primaryExceptionVariable = caughtThrowableVariable; } else if (primaryExceptionVariable != caughtThrowableVariable) { // L8 primaryExceptionVariable.addSuppressed(caughtThrowableVariable); } throw primaryExceptionVariable; // L9 } // L6 }</span></span></code> </pre> <br>  ECJ uses a completely different approach to compiling try-with-resources.  Labels are noticeably smaller, code blocks are noticeably larger.  Instead of a bloated table, exceptions are simply thrown up a level.  In the <a href="">examples it is more difficult</a> to notice that it turns out such a doll. <br><br>  What is under the hood?  I went to download the source again, this time <a href="https://github.com/eclipse/eclipse.jdt.core/">ECJ</a> .  The compilation of the <i>try statement is</i> hidden in the <a href="">TryStatement</a> file.  This time no trees, only opcodes, only hardcore.  The bytecode responsible for try-with-resources is generated between lines 500 and 604. It is clear from the history of commits that the body of the <i>try</i> block was simply framed with a chain of calls to create and close resources. <br><br>  Since  there is no finally-block substitution, then there is no duplication of code.  However, due to nesting, the same actions are repeated for different exceptions.  This I took advantage of.  The ECJ instruction set is as follows. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Integer&gt; ECJ_INS_SEQUENCE = Arrays.asList( ASTORE, <span class="hljs-comment"><span class="hljs-comment">// store throwable2 ALOAD, IFNONNULL, // if (throwable1 == null) ALOAD, ASTORE, GOTO, // throwable1 = throwable2; ALOAD, ALOAD, IF_ACMPEQ, // if (throwable1 != throwable2) { ALOAD, ALOAD, INVOKEVIRTUAL, // throwable1.addSuppressed(throwable2) ALOAD, ATHROW); // throw throwable1</span></span></code> </pre> <br>  And this is the corresponding java-code. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (throwable1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// IFNONNULL throwable1 = throwable2; } else { if (throwable1 != throwable2) { // IF_ACMPEQ throwable1.addSuppressed(throwable2); // INVOKEVIRTUAL } } // ATHROW</span></span></code> </pre> <br>  What about the rest of the compilers?  It turned out that AspectJ generates almost the same bytecode as ECJ.  For him there was no need to invent a separate sequence.  I could not download a compiler from IBM (and I didn‚Äôt really want to).  The rest of the compilers were ignored due to the low prevalence. <br><br><h1>  results </h1><br>  The attentive reader has already noticed that the instruction set for javac does not take into account one nuance.  Different methods are actually used to call the class and interface methods: INVOKEVIRTUAL and INVOKEINTERFACE, respectively.  The implementation described above takes into account only the first case and does not take into account the second.  Well, nothing, it is not difficult to fix. <br><br>  So, what happened in the end? <br><br>  Firstly, the main result of the work was a patch correcting the bug mentioned at the beginning of the article.  Almost all the code fit in one class (not counting the tests), which currently looks like this: <a href="">TryWithResourcesMethodVisitor</a> .  I urge everyone to criticize and offer their best solutions to this problem. <br><br>  Secondly, I learned what are the ways to compile the try-with-resources block.  As a result, I figured out how try-catch-finally looks at the bytecode level.  Well, a by-product was the translation of the <a href="http://habrahabr.ru/post/212759/">article</a> , which I mentioned above. <br><br>  Thirdly, I wrote this article, where I told you everything.  Perhaps now one of you will be able to increase the fundamental <a href="http://habrahabr.ru/post/245333/">dragging factor</a> using the knowledge gained. <br><br>  And where is the benefit and morality, you ask?  I leave their search to the reader.  I note only that I enjoyed it while I was writing this article.  Hope you got it from reading.  See you again! <br><br>  PS As a bonus, I propose to look at the early proposals for the implementation of try-with-resources from Joshua Bloch. <br><br><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="609530002170904576"></twitter-widget><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script><br>  It looks funny. <br><br><pre> <code class="java hljs">{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocalVariableDeclaration ; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> #suppressSecondaryException = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">try</span></span></span><span class="hljs-function"> Block </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">catch</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Throwable #t)</span></span></span><span class="hljs-function"> </span></span>{ #suppressSecondaryException = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> #t; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (#suppressSecondaryException) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { localVar.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception #ignore) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> localVar.close(); } }</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/260417/">https://habr.com/ru/post/260417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260407/index.html">Experience using Object Change Notification in Oracle</a></li>
<li><a href="../260409/index.html">Sale of books at a discount of 50% and 30%</a></li>
<li><a href="../260411/index.html">Transformice story: indie game with 60 million users</a></li>
<li><a href="../260413/index.html">Instructions: Setting up the Gateway PD (AltLinux SPT 6.0 + VipNet Coordinator)</a></li>
<li><a href="../260415/index.html">Tale of how we supported the domestic manufacturer</a></li>
<li><a href="../260419/index.html">ECP and process management API</a></li>
<li><a href="../260425/index.html">Tin - the basis of circuitry in your home</a></li>
<li><a href="../260427/index.html">Prototypes are objects (and why this is important)</a></li>
<li><a href="../260429/index.html">Mail server on your own site via sendmail</a></li>
<li><a href="../260431/index.html">Once again about a multithreading in one line</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>