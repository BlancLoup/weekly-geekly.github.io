<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OOP patterns in the examples for iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From translator 
 We were looking for two Russian-speaking developers here - on iOS and on C ++ under Windows. Saw dozens of completed tests. The diff...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OOP patterns in the examples for iOS</h1><div class="post__text post__text-html js-mediator-article"><h3>  From translator </h3><br>  We were looking for two Russian-speaking developers here - on iOS and on C ++ under Windows.  Saw dozens of completed tests.  The difference in OOP knowledge between the representatives of the two platforms is huge.  In C ++, usually beautiful extensible code, as a matter of course.  Objective C picture is depressing.  Almost all iOS candidates did not know OOP beyond <code>NSString</code> 's <s>nose</s> and <code>AppDelegate</code> ' s <s>nose</s> . <br><br>  It is clear that the pros are taught in the Stroustrup and the ‚Äúgang of four‚Äù, and the Objective-C teaches more in the tutorials and the Stack Overflow.  Fast food training leaves no room for fundamental questions ... But I did not expect such a difference. <br><br>  Therefore, I translated the post, which gave initial information about the design patterns with examples on iOS ... "initial"?  Yeah, then there will be a sequel?  No, it will not.  Further information you will receive from experience, from <b>attempts to</b> organize the process of writing code using patterns.  At first it will not be possible, probably, the facade of the building will stick out of the chimney, but then an understanding will come where some techniques really help. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      High-quality software development - a creative process that is unique to each specific head.  Therefore, there is no general instruction: <code>if (A and (B or C)) then use Pattern_N;</code> <a name="habracut"></a><br><br>  <b>Just ask yourself more often: what I wrote is beautiful?</b> <br><br><div class="spoiler">  <b class="spoiler_title">Disclaimer</b> <div class="spoiler_text">  Patterns are not a panacea, no cure for crooked hands, and no substitute for brains.  Here is the stencil: <br><br> <a href="https://developer.apple.com/library/mac/referencelibrary/GettingStarted/RoadMapOSX/chapters/08_DesignPatterns.html"><img src="https://habrastorage.org/getpro/habr/post_images/e4b/c14/5b3/e4bc145b3b8ad30cd9a6b6b94041a544.png"></a> <br><br>  He does not draw!  Draw - you. </div></div><br><h2>  What is a pattern </h2><br>  The idea of ‚Äã‚Äãpatterns came 40 years ago from architect <a href="http://books.google.ru/books/about/A_Pattern_Language.html%3Fid%3DhwAHmktpk5IC%26redir_esc%3Dy">Christopher Alexander</a> : <br><blockquote>  Any pattern describes a task that arises again and again in our work, as well as the principle of its solution, and in such a way that this solution can then be used a million times without reinventing anything. </blockquote><br>  Programmers saw this and <a href="http://www.piter.com/book.phtml%3F978549600389%26barcode%3D978549600389">said</a> : <br><blockquote>  Although Alexander was referring to the patterns that arise in the design of buildings and cities, but his words are true in relation to the patterns of object-oriented design.  Our solutions are expressed in terms of objects and interfaces, not walls and doors, but in both cases the meaning of the pattern is to offer a solution to a specific task in a specific context. </blockquote><br><img src="https://habrastorage.org/getpro/habr/post_images/cd5/dae/71b/cd5dae71bb554825a5c72e98c4e09b1e.png"><br><br>  Unlike <a href="http://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">wikipedia</a> , I will not call a pattern a ‚Äútemplate‚Äù so as not to be confused with <a href="http://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD%25D1%258B_C%252B%252B">C ++ templates</a> , which also have the right to life in Objective C. <br><br>  This concludes the introduction and finally give the floor to the author of the article.  <i>- Approx.</i>  <i>per.</i>  <i>:)</i> <br><br><div class="spoiler">  <b class="spoiler_title">Although not, another lyrical digression about the importance of patterns.</b> <div class="spoiler_text">  ... Travelers went along the lane and found themselves in a quarter that was built up with houses with columns.  There were columns and straight, and curves, and twisted, and twisted, and spiral, and inclined, and flattened, and kosopuzye, and pancake, and even those who can not pick a name.  The eaves of the houses were also straight, and oblique, and curves, and broken, and zigzag.  In some houses the columns were not at the bottom, as it should be, but on the top, on the roofs;  the other houses had columns below, but the houses themselves stood above, above the columns;  the third columns were suspended from the eaves and dangling over the heads of passersby.  There was a house with a cornice at the bottom, and the columns were upside down and, in addition, were slanted to one side.  There was also a house in which the columns stood straight, but the house itself stood aslant, as if it were about to collapse on the heads of passersby.  There was also a house whose columns leaned in one direction, and the house itself leaned in another, so that it seemed as if all this would fall to the ground and crumble to dust. <br><br>  ‚ÄúYou are not looking at these slanting houses,‚Äù said the architect Kubik.  - Once upon a time we had a fashion to get involved in the construction of houses that do not look like anything.  That made such a disgrace that now even look ashamed! <br><br>  <i>N. Nosov.</i>  <i>"Dunno in the Sunny City"</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a1/043/a49/9a1043a49fee38bc3b9ff654480f3b66.png"></div></div><br><hr><br>  Although many developers agree that the theme of patterns is very important - not too many articles are devoted to it, and we often don‚Äôt devote to patterns worthy of attention when writing code. <br><br>  A pattern is an example of a solution to a problem.  A solution that can be repeated in another project.  Patterns make code easier to understand.  They help to write loosely coupled code ‚Äî a code in which you can easily modify components, or replace an entire component with its counterpart, <s>almost</s> without touching the rest of the project. <br><br>  If you are new to the topic of design patterns, then I have good news for you!  First: you already use a huge number of patterns, thanks to the principles on which Cocoa is arranged.  (However, this does not interfere with the bydlokodit in the examples on developer.apple.com - <i>Note. Lane.</i> ) Second: this article will introduce you to the main (and not just the main) design patterns that are commonly used in Cocoa. <br><br>  For each pattern we consider: <br><ul><li>  what is this pattern; <br></li><li>  why is it needed; <br></li><li>  how to use it; <br></li><li>  typical mistakes when using the pattern (if any). <br></li></ul><br>  Since patterns cannot be studied without practice, we will write a test application - a music library that will show your albums and information on them.  During the development process, you will learn about some of the patterns: <br><br>  <b>Creational patterns</b> make the system independent of the way objects are created: <br><ul><li>  Singleton <br></li><li>  Abstract factory <br></li></ul><br>  <b>Structural patterns</b> look for simple ways to visualize the connections between objects: <br><ul><li>  MVC (controversial classification, well, let it be here. <i>- Note. Lane.</i> ) <br></li><li>  Decorator <br></li><li>  Adapter <br></li><li>  Facade <br></li><li>  Linker (composite) <br></li></ul><br>  <b>Behavioral patterns</b> (behavioral) define the process of interaction, ‚Äúcommunication‚Äù between objects: <br><ul><li>  Observer <br></li><li>  Keeper (memento) <br></li><li>  Chain of responsibility <br></li><li>  Command (command) <br></li></ul><br>  By the end of the article, our application will look something like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/716/6ff/54a/7166ff54a2d3c18604fc487b3defede0.png"><br><br><h2>  Getting started </h2><br>  Open the <a href="https://github.com/x128/BlueLibrary">BlueLibrary</a> project in your favorite IDE or in Xcode. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a7/db3/1bf/5a7db31bf0bce757adc8cc8079f647e7.png"><br><br>  There is a common ViewController and a simple HTTP client with an empty implementation. <br><br>  <b>Did you know?</b>  As soon as you create a new project in Xcode or AppCode, your code is already full of patterns!  MVC, ‚Äúdelegate‚Äù, ‚Äúprotocol‚Äù, ‚Äúsingleton‚Äù - you get them for free!  :) <br><br>  Before diving into the first pattern, we need to create two classes for storing and displaying information about albums. <br><br>  <b>Xcode</b> : File&gt; New&gt; File ... or press <b>‚åòN</b> . <br>  <b>AppCode</b> : <b>‚åòN</b> &gt; File from Xcode Template ... <br><br>  In the dialog that opens, select from the list: <b>iOS&gt; Cocoa Touch&gt; Objective C class</b> , click <b>Next</b> .  Let the class be called <code>Album</code> , and it will be a subclass of <code>NSObject</code> . <br><br>  Open <b>Album.h</b> and add several properties and one prototype of the method between <code>@interface</code> and <code>@end</code> : <br><br><pre> <code class="cpp hljs">@property (nonatomic, copy, readonly) NSString * title; @property (nonatomic, copy, readonly) NSString * artist; @property (nonatomic, copy, readonly) NSString * genre; @property (nonatomic, copy, readonly) NSString * coverUrl; @property (nonatomic, copy, readonly) NSString * year; - (id)initWithTitle:(NSString *)title artist:(NSString *)artist coverUrl:(NSString *)coverUrl year:(NSString *)year;</code> </pre><br>  Please note: all properties have a <code>readonly</code> flag, since  we do not need to change them after creating the <code>Album</code> object. <br><br>  This method is an object initializer.  Creating a new album, we pass here the name of the album, artist, cover URL and year of release. <br><br>  Now open <b>Album.m</b> and insert the following code between <code>@implementation</code> and <code>@end</code> : <br><br><pre> <code class="cpp hljs">- (id)initWithTitle:(NSString *)title artist:(NSString *)artist coverUrl:(NSString *)coverUrl year:(NSString *)year { self = [super init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { _title = title; _artist = artist; _coverUrl = coverUrl; _year = year; _genre = @<span class="hljs-string"><span class="hljs-string">"Pop"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }</code> </pre><br>  The most common initialization. <br><br>  Create another <code>AlbumView</code> class - a subclass of <code>UIView</code> . <br><br>  In <b>AlbumView.h,</b> add a prototype of the method between <code>@interface</code> and <code>@end</code> : <br><br><pre> <code class="cpp hljs">- (id)initWithFrame:(CGRect)frame albumCover:(NSString *)albumCover;</code> </pre><br>  And in <b>AlbumView.m,</b> replace the code between <code>@implementation</code> and <code>@end</code> with this one: <br><br><pre> <code class="cpp hljs">@implementation AlbumView { UIImageView * coverImage; UIActivityIndicatorView * indicator; } - (id)initWithFrame:(CGRect)frame albumCover:(NSString *)albumCover { self = [super initWithFrame:frame]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { <span class="hljs-comment"><span class="hljs-comment">//   : self.backgroundColor = [UIColor blackColor]; //      - 5   : coverImage = [[UIImageView alloc] initWithFrame:CGRectMake(5, 5, frame.size.width-10, frame.size.height-10)]; [self addSubview:coverImage]; //   : indicator = [[UIActivityIndicatorView alloc] init]; indicator.center = self.center; indicator.activityIndicatorViewStyle = UIActivityIndicatorViewStyleWhiteLarge; [indicator startAnimating]; [self addSubview:indicator]; } return self; } @end</span></span></code> </pre><br>  The first thing you should notice is that there is an instance variable: <code>coverImage</code> .  This variable is an image from a cover album.  The second variable <code>indicator</code> is an indicator that spins, depicting activity while the cover is loading. <br><br>  Why are these variables declared in the implementation file ( <code>*.m</code> ) and not in the header file ( <code>*.h</code> )?  Because other classes (outside <code>AlbumView</code> ) do not need to know about the existence of these variables, since  they are used only inside the class.  This moment is extremely important if you create a library (or framework) for other developers. <br><br>  Build the project (‚åòB) - just check.  Everything is good?  Then get ready: your first pattern! <br><br><h2>  MVC - the king of patterns </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/092/650/f12/092650f123cc2693c3e0906fbb6df1c2.png"><br><br>  Model ‚Äî View ‚Äî Controller (Model ‚Äî View ‚Äî Controller or simply MVC) is one of the foundations of Cocoa and undoubtedly the most commonly used pattern.  It classifies objects according to their role in the application and helps to clean code separation (what it is, we discuss below). <br><br>  Three roles: <br><br><ul><li>  <b>Model</b> (model) contains the data of the application and defines the mechanisms of manipulation over them.  In our application, the model will be the class <code>Album</code> . <br></li><li>  <b>View</b> (view), sometimes they say "view" - is responsible for the visual representation of the model, as well as controls with which the user can interact.  As a rule, it is UIView and its subclasses.  In our application, the view is an <code>AlbumView</code> . <br></li><li>  <b>The controller</b> (controller) coordinates all the work.  It has access to model data, displays it in views, subscribes to events and manipulates data.  What class will we have controller?  Right, <code>ViewController</code> . <br></li></ul><br>  Proper implementation of the MVC pattern means that in your application, each object falls into only one of these groups. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a2/a5c/fbd/0a2a5cfbd5e289e13e451222731608fd.png"><br><ul><li>  The model notifies the controller of any changes in the data.  In turn, the controller updates the data in the views. <br></li><li>  The view notifies the controller of the user's actions.  The controller, if necessary, updates the model or receives the requested data. <br></li></ul><br>  Why is this all about?  Why not throw out the controller and combine the model with the presentation in one class?  It will be much easier! <br><br>  The question boils down to two (interconnected) things: <br><ol><li>  Code separation; </li><li>  The prospect of code reuse. </li></ol><br>  Ideally, the presentation is completely separate from the model.  If the view does not depend on the specific implementation of the model, it can be used in conjunction with another model to display other data. <br><br>  For example, in the future we may want to add films or books to our library.  We can still use <code>AlbumView</code> to display movie and book objects!  And if we want to create a completely different project that will deal with albums, we can use the <code>Album</code> class in it - a model that does not depend on the presentation.  This is the power of MVC! <br><br><h3>  How to use MVC pattern </h3><br>  1. Ensure that each class in the project is a model, controller, or view.  One class cannot combine two roles!  We have already taken the first step by creating two classes: <code>Album</code> and <code>AlbumView</code> . <br><br>  2. <i>Forget the horror that you saw on developer.apple.com!</i>  <i>Yes, yes, those examples where <code>ViewController</code> 's play two or three roles at the same time.</i>  <i>- Approx.</i>  <i>per.</i> <br><br>  3. Create three groups in the project - <code>Model</code> , <code>View</code> and <code>Controller</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af6/158/4bb/af61584bbabae81220d32d3c2d4866e2.png"><br><br>  How to do it: <br><br><ol><li>  <b>File&gt; New&gt; Group</b> (or keyboard: in Xcode <b>‚åò‚å•N</b> , in AppCode <b>N&gt; Group</b> ), name the group <code>Model</code> .  Do the same for <code>Controller</code> and <code>View</code> . <br></li><li>  Drag <b>Album.h</b> and <b>Album.m</b> to the <code>Model</code> group. <br>  Drag <b>AlbumView.h</b> and <b>AlbumView.m</b> to the <code>View</code> group. <br>  Drag <b>ViewController.h</b> and <b>ViewController.m</b> to the <code>Controller</code> group. <br></li></ol><br>  Now our project looks much better without these ... files floating around.  Of course, you can create other groups and classes, but the main thing is these three categories. <br><br>  Now that your components are organized, we need somewhere to get the data for the albums.  We will create an API class through which it will be possible to access data from anywhere in the project.  To do this, we approach the following design pattern: <br><br><h2>  Single (Singleton) </h2><br>  The loner pattern ensures that there is only one instance of this class in the entire application.  There is a global access point to this instance.  Delayed initialization is usually used: this single instance is created when it is needed for the first time. <br><br>  <i><b>Did you know?</b></i>  <i>Apple makes extensive use of this approach.</i>  <i>For example: <code>[NSUserDefaults standardUserDefaults]</code> , <code>[UIApplication sharedApplication]</code> , <code>[UIScreen mainScreen]</code> , <code>[NSFileManager defaultManager]</code> - each of these methods returns a singleton object.</i> <br><br>  You ask why worry about the fact that somewhere there are two or more instances of a class.  Why not more than one copy?  Memory is cheap now, isn't it? <br><br>  There are cases where you need to have exactly one instance of a class.  For example, you do not need to keep several instances of the class <code>Logger</code> (only if you do not write several different logs at the same time).  Or the global configuration reference class: it is much better to provide thread-safe access to a certain shared resource (for example, to the settings file) than to have many classes that modify the settings file, possibly at the same time. <br><br><h3>  Using the loner pattern </h3><br>  Consider the scheme: <br><img src="https://habrastorage.org/getpro/habr/post_images/851/848/7c1/8518487c1a4b150c4d3105e9f0654f13.png"><br>  The <code>Logger</code> class has one <code>instance</code> property (a pointer to a single instance) and two methods: <code>sharedInstance()</code> and <code>init()</code> . <br><br>  When the client first calls the <code>sharedInstance()</code> method, the <code>instance</code> property has not yet been initialized, then a new instance of the class is created and a pointer to it is returned. <br><br>  The next time we call <code>sharedInstance()</code> , we are immediately returned to the <code>instance</code> without initialization.  Such a scheme guarantees the existence of only one instance for the entire duration of the program. <br><br>  We implement this pattern: create a singleton to manage all the data of the album. <br><br>  Please note that the project has a group called <code>API</code> .  There we will add classes that provide services for our application.  In this group, create a class from the template <b>iOS&gt; Cocoa Touch&gt; Objective-C class</b> , a subclass of <code>NSObject</code> , and name it <code>LibraryAPI</code> . <br><br>  Open <b>LibraryAPI.h</b> and replace its contents with the following: <br><br><pre> <code class="cpp hljs">@interface LibraryAPI : NSObject + (LibraryAPI *)sharedInstance; @end</code> </pre><br>  Go to <b>LibraryAPI.m</b> and insert the following method after the <code>@implentation</code> line: <br><br><pre> <code class="cpp hljs">+ (LibraryAPI *)sharedInstance { <span class="hljs-comment"><span class="hljs-comment">// 1 static LibraryAPI * _sharedInstance = nil; // 2 static dispatch_once_t oncePredicate; // 3 dispatch_once(&amp;oncePredicate, ^{ _sharedInstance = [[LibraryAPI alloc] init]; }); return _sharedInstance; }</span></span></code> </pre><br>  Many interesting things happen in this short method: <br><br><ol><li>  We declare a static variable to store a pointer to a class instance (its value will be available globally from our class). <br></li><li>  We declare a static variable dispatch_once_t, which ensures that the initialization code will be executed only once. <br></li><li>  Using Grand Central Dispatch (GCD), we initialize the <code>LibraryAPI</code> instance.  This is the essence of the ‚Äúloner‚Äù pattern: the initialization block will never be executed again. <br></li></ol><br>  When you call <code>sharedInstance()</code> again, the code inside the <code>dispatch_once</code> block will not be executed (because it has already been executed before), and you will receive a pointer to the previous created instance of the <code>LibraryAPI</code> . <br><br>  <b>Note.</b>  To learn more about <a href="http://ru.wikipedia.org/wiki/Grand_Central_Dispatch">GCD</a> and its application, the author of the article advises tutorials in English: <a href="http://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial">Multithreading and Grand Central Dispatch</a> and <a href="http://www.raywenderlich.com/9328/creating-a-diner-app-using-blocks-part-1">How To Use Blocks</a> . <br><br>  So, we have a singleton - the starting point for managing albums.  Take the next step: create a class to store our data. <br><br>  In the <code>API</code> group, create a new class: <b>iOS&gt; Cocoa Touch&gt; Objective-C class</b> , a subclass of <code>NSObject</code> , and call it <code>PersistencyManager</code> . <br><br>  Open <b>PersistencyManager.h</b> and add a line to the beginning of the file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Album.h"</span></span></span></span></code> </pre><br>  Next, add the following code after <code>@interface</code> : <br><br><pre> <code class="cpp hljs">- (NSArray *)albums; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addAlbum:(Album *)album atIndex:(NSUInteger)index; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)deleteAlbumAtIndex:(NSUInteger)index;</code> </pre><br>  These are prototypes of the three methods that will work with album data. <br><br>  Open <b>PersistencyManager.m</b> and add the code just before the <code>@implementation</code> line: <br><br><pre> <code class="cpp hljs">@<span class="hljs-function"><span class="hljs-function">interface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersistencyManager</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ NSMutableArray * albums; <span class="hljs-comment"><span class="hljs-comment">//    } @end</span></span></code> </pre><br>  This class extension is another way to add private methods and variables to a class so that external classes are not aware of them.  Here we declare an array that will contain the album data.  This array is mutable, so we can easily add and remove albums. <br><br>  Now add the implementation of the <code>PersistencyManager</code> class after the <code>@implementation</code> line: <br><br><pre> <code class="cpp hljs">- (id)init { self = [super init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { albums = [NSMutableArray arrayWithArray: @[[[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"Best of Bowie"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"David Bowie"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_david_bowie_best_of_bowie.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"1992"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"It's My Life"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"No Doubt"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_no_doubt_its_my_life_bathwater.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"2003"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"Nothing Like The Sun"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"Sting"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_sting_nothing_like_the_sun.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"1999"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"Staring at the Sun"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"U2"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_u2_staring_at_the_sun.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"2000"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"American Pie"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"Madonna"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_madonna_american_pie.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"2000"</span></span>]]]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }</code> </pre><br>  In the <code>init</code> method, we collect an array of five albums for example (if you have nothing to do, you can replace them with your favorite music). <br><br>  Now add three methods to <b>PersistencyManager.m</b> : <br><br><pre> <code class="cpp hljs">- (NSArray *)albums { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> albums; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addAlbum:(Album *)album atIndex:(NSUInteger)index { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (albums.count &gt;= index) [albums insertObject:album atIndex:index]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> [albums addObject:album]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)deleteAlbumAtIndex:(NSUInteger)index { [albums removeObjectAtIndex:index]; }</code> </pre><br>  These simple methods allow you to get, add and delete albums. <br><br>  Build the project (‚åòB), just to make sure that it is compiled. <br><br>  You may wonder: what does <code>PersistencyManager</code> do in the singleton chapter?  The relationship between <code>LibraryAPI</code> and <code>PersistencyManager</code> will be shown in the next chapter. <br><br><h2>  Facade </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/642/c8c/a40/642c8ca40d08000990736a2c0182cdfe.png"><br><br>  The ‚ÄúFacade‚Äù pattern provides a single interface to a complex subsystem.  In order not to shock users with a variety of classes with different interfaces, we provide one simple API: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d23/195/3e0/d231953e05d3fed2984e83c20dc0a065.png"><br><br>  The user of this API does not care about the internal complexity of the system.  This pattern is ideal when working with a large number of classes that are difficult to use. <br><br>  The Facade pattern separates the code (API) that accesses the subsystem from the classes that we want to hide.  It reduces the dependence of external code on the internal kitchen of the subsystem.  For example, this is useful when classes hidden behind a facade are highly likely to undergo modification.  The facade will provide all the same API, while everything changes behind the scenes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a7/fe9/72f/3a7fe972ff3522dc394a3152c197e7a8.jpg"><br><br>  <s>If</s> when it comes time to replace your backend, you don‚Äôt have to rewrite code using the API, since  API will not change. <br><br><h3>  Using the pattern "Facade" </h3><br>  Now we have <code>PersistencyManager</code> for local data storage and <code>HTTPClient</code> for network interaction.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other classes in your project should not think about these two things. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To implement this pattern, only one class - </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- must refer to instances </font></font><code>PersistencyManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>HTTPClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is the facade that provides a simple interface for accessing services (storage and transmission of data).</font></font><br><br>  <b>Comment.</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normally, a singleton object exists for the duration of the program. </font><font style="vertical-align: inherit;">There is no need to keep too many ‚Äústrong‚Äù pointers to other objects in singletons, since </font><font style="vertical-align: inherit;">they will not be released from memory until the application closes.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a strong pointer?</font></font></b> <div class="spoiler_text">  Stack Overflow  <a href="http://stackoverflow.com/questions/9262535/explanation-of-strong-and-weak-storage-in-ios5"> </a> : <br><br>     - ,     ¬´¬ª   .    ¬´¬ª  (weak pointer) ‚Äî      ,    ,   ¬´¬ª  . <br><br>  <b>Example</b> <br> ,    ‚Äî  .   ¬´¬ª ( ). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8fc/861/e8e/8fc861e8e56c0a776d5fac3684ae7e5e.jpg"><br><br>   ‚Äî    .     ,   .  5   5     (5   1 ) ‚Äî      ,     5 . <br><br>    ‚Äî  ,       : ¬´ , !¬ª    ,    (¬´  ¬ª)  .     ,   ,   ,      . </div></div><br>    : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/896/326/cb3/896326cb38d71cb0f7c0ed4b1bb9be50.png"><br><br> <code>LibraryAPI</code>    ,     <code>HTTPClient</code>  <code>PersistencyManager</code>    . <br><br>  <b>LibraryAPI.h</b>      : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Album.h"</span></span></span></span></code> </pre><br>      : <br><br><pre> <code class="cpp hljs">- (NSArray *)albums; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addAlbum:(Album *)album atIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)deleteAlbumAtIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index;</code> </pre><br>   ,     . <br><br>   <b>LibraryAPI.m</b>    : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"PersistencyManager.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"HTTPClient.h"</span></span></span></span></code> </pre><br>   ,     !  API       ¬´¬ª . <br><br>         (  <code>@implementation</code> ): <br><br><pre> <code class="cpp hljs">@<span class="hljs-function"><span class="hljs-function">interface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LibraryAPI</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ PersistencyManager * persistencyManager; HTTPClient * httpClient; BOOL isOnline; } @end</code> </pre><br>  <code>isOnline</code> :   ,    (, )   ? <br><br>   .   <b>LibraryAPI.m</b> : <br><br><pre> <code class="cpp hljs">- (id)init { self = [super init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { persistencyManager = [[PersistencyManager alloc] init]; httpClient = [[HTTPClient alloc] init]; isOnline = NO; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }</code> </pre><br> <b>:</b> HTTP-        .        ¬´¬ª. <code>isOnline</code>   <code>NO</code> . <br><br>        <code>LibraryAPI</code> : <br><br><pre> <code class="cpp hljs">- (NSArray *)albums { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [persistencyManager albums]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addAlbum:(Album *)album atIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index { [persistencyManager addAlbum:album atIndex:index]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isOnline) { [httpClient postRequest:@<span class="hljs-string"><span class="hljs-string">"/api/addAlbum"</span></span> body:[album description]]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)deleteAlbumAtIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index { [persistencyManager deleteAlbumAtIndex:index]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isOnline) { [httpClient postRequest:@<span class="hljs-string"><span class="hljs-string">"/api/deleteAlbum"</span></span> body:[@(index) description]]; } }</code> </pre><br>    <code>addAlbum:atIndex:</code> .     ,  ,     ,     .    ¬´¬ª:  -    <s></s>    ,    ‚Äî     ‚Äî   ,   . <br><br> <b>:</b>    ¬´¬ª ,         ¬´¬ª  .      ¬´  ¬ª     ,        . <br><br>    .   : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/543/082/11f/54308211f34b30896af670d3e5ea6c63.png"><br><br>  iOS 6    -  .  iOS 7   .      . <br><br>   -     .      ,  ‚Ä¶ <br><br><h2>  Decorator </h2><br>   ,  ¬´¬ª    (behaviors)   (responsibilities)  ,    .    (     ,    ). <br><br>  Objective-C   <i></i>    :   . <br><br><h3>  Categories </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Category is a very powerful mechanism for adding methods to existing classes without inheritance. </font><font style="vertical-align: inherit;">New methods are added at compilation and can be executed as usual methods of the extended class. </font><font style="vertical-align: inherit;">This is slightly different from the classic definition of "Decorator", because </font><font style="vertical-align: inherit;">"Category" does not contain an instance of the class that it extends. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In addition to extending your own classes, you can also add methods to any Cocoa classes!</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to use categories </font></font></h4><br>  :     <code>Album</code> ,      : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/79b/7d9/8ab/79b7d98ab7da196a3a353315a1762409.png"><br><br>       ? <code>Album</code> ‚Äî   ¬´¬ª,   ,      .     (   <code>Album</code> ) ,       <code>Album</code> ,    <code>Album</code> . <br><br>      ‚Äî   <code>Album</code> .      ,     <code>UITableView</code> . <br><br>     : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43f/dbe/87c/43fdbe87cdefbf1af55a9c0667a25347.png"><br><br>      <b>Album</b> ,      <b>Objective-C category</b> (    Objective-C class!) <br>  : <br> <b>Category</b> : <code>TableRepresentation</code> <br> <b>Category on</b> : <code>Album</code> <br><br>    ? <code>Album+TableRepresentation</code> ,     <code>Album</code> .    ,             (     - ). <br><br>   <b>Album+TableRepresentation.h</b>    : <br><br><pre> <code class="cpp hljs">- (NSDictionary *)tr_tableRepresentation;</code> </pre><br>      : <code>tr_</code> ‚Äî     ( <code>TableRepresentation</code> ).    ,         . <br><br> <b> .</b>   ,   ,       (           ) ‚Äî    <i>  </i> .  Like this.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is not known which method will be executed. </font><font style="vertical-align: inherit;">This is not a problem if you operate categories on your classes. </font><font style="vertical-align: inherit;">But it can be very difficult if you use categories to extend the standard </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cocoa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cocoa Touch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classes </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Album + TableRepresentation.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add the following method:</font></font><br><br><pre> <code class="cpp hljs">- (NSDictionary *)tr_tableRepresentation { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{@<span class="hljs-string"><span class="hljs-string">"titles"</span></span>:@[@<span class="hljs-string"><span class="hljs-string">""</span></span>, @<span class="hljs-string"><span class="hljs-string">""</span></span>, @<span class="hljs-string"><span class="hljs-string">""</span></span>, @<span class="hljs-string"><span class="hljs-string">""</span></span>], @<span class="hljs-string"><span class="hljs-string">"values"</span></span>:@[self.artist, self.title, self.genre, self.year]}; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Just think how powerful the pattern is: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use properties directly from </font></font><code>Album</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We expanded the class functionality </font></font><code>Album</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">without inheritance. </font><font style="vertical-align: inherit;">(If you want to inherit from Album, this can also be done.)</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This simple addition allows us to have a </font></font><code>UITableView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúsmart view </font></font><code>Album</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äù without modifying the code itself </font></font><code>Album</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br></li></ul><br> Apple      Foundation.  ,    ,   <b>NSString.h</b> .  <code>@interface NSString</code> ‚Äî        : <code>NSStringExtensionMethods</code> , <code>NSExtendedStringPropertyListParsing</code> , <code>NSStringDeprecated</code> .    ,    . <br><br><h3>  </h3><br>    ¬´¬ª ‚Äî  . ,          (    ).    ,     . <br><br>  :   <code>UITableView</code>   ,    ,  <code>tableView:numberOfRowsInSection:</code> (    ). <br><br>   ,  <code>UITableView</code>  ,        . ,      .  <code>UITableView</code>   ¬´     ¬ª  .    :   <code>UITableView</code>     . <br><br>   ,     <code>UITableView</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c1/80e/8b4/9c180e8b44eae68ba5a9a511cfe853ca.png"><br><br>  <code>UITableView</code>   ,  .      ,    .      ( ),   . ,       ,   (       ). <br><br>  ,        ?    :       .  Objective C    .        ( )  ,      . <br><br> <b>:</b>   . Apple       UIKit: <code>UITableView</code> , <code>UITextView</code> , <code>UITextField</code> , <code>UIWebView</code> , <code>UIAlert</code> , <code>UIActionSheet</code> , <code>UICollectionView</code> , <code>UIPickerView</code> , <code>UIGestureRecognizer</code> , <code>UIScrollView</code> , ‚Ä¶ ,   . <br><br><h4>    </h4><br>  <b>ViewController.m</b>        ¬´¬ª: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LibraryAPI.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Album+TableRepresentation.h"</span></span></span></span></code> </pre><br>       ,  <code>@interface</code>  <code>@end</code> : <br><br><pre> <code class="cpp hljs">@<span class="hljs-function"><span class="hljs-function">interface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewController</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ UITableView * dataTable; NSArray * allAlbums; NSDictionary * currentAlbumData; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentAlbumIndex; } @end</code> </pre><br>    ‚Äî   ,    .      : <br><br><pre> <code class="cpp hljs">@<span class="hljs-function"><span class="hljs-function">interface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewController</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &lt;UITableViewDataSource, UITableViewDelegate&gt;</span></span></code> </pre><br> <code>UITableViewDataSource</code> , <code>UITableViewDelegate</code> ‚Äî   .    ,       .    ¬´¬ª    . <br><br>  , <code>UITableView</code>  ,     . <br><br>    <code>viewDidLoad</code>   : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidLoad { [super viewDidLoad]; <span class="hljs-comment"><span class="hljs-comment">// 1 self.view.backgroundColor = [UIColor colorWithRed:0.76f green:0.81f blue:0.87f alpha:1.f]; currentAlbumIndex = 0; // 2 allAlbums = [[LibraryAPI sharedInstance] albums]; // 3 // UITableView,     CGRect frame = CGRectMake(0.f, 120.f, self.view.frame.size.width, self.view.frame.size.height - 120.f); dataTable = [[UITableView alloc] initWithFrame:frame style:UITableViewStyleGrouped]; dataTable.delegate = self; dataTable.dataSource = self; dataTable.backgroundView = nil; [self.view addSubview:dataTable]; }</span></span></code> </pre><br>    : <br><ol><li>     -. </li><li>      API.     <code>PersistencyManager</code> ! </li><li>  <code>UITableView</code> .  ,   <code>ViewController</code> ‚Äî     (data source)  <code>UITableView</code> ,   ,   <code>UITableView</code> ,   <code>ViewController</code> '. </li></ol><br>       <b>ViewController.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)showDataForAlbumAtIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)albumIndex { <span class="hljs-comment"><span class="hljs-comment">//   : ,       if (albumIndex &lt; allAlbums.count) { //  : Album * album = allAlbums[albumIndex]; //   ,     TableView: currentAlbumData = [album tr_tableRepresentation]; } else { currentAlbumData = nil; } //    ,   .  TableView [dataTable reloadData]; }</span></span></code> </pre><br> <code>showDataForAlbumAtIndex:</code>        .      ,   <code>reloadData</code> .    , <code>UITableView</code>        , , ,     ,     ,       . <br><br>     <code>viewDidLoad</code> : <br><br><pre> <code class="cpp hljs">[self showDataForAlbumAtIndex:currentAlbumIndex];</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This line loads the current album when the application starts. </font><font style="vertical-align: inherit;">Since the index of the current album </font></font><code>currentAlbumIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was previously set to </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we see the </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zero album in the collection. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Running the application on the simulator, we get ... crash:</font></font><br><br><img src="http://habrastorage.org/storage3/e16/4ba/01b/e164ba01b5c47208352f9da7edd21dc2.png"><br><br>  What's happening?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We declared our </font></font><code>ViewController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delegate and data source </font></font><code>UITableView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font> But!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having done this, we must implement all the required methods (including </font></font><code>tableView:numberOfRowsInSection:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but we have not done it yet. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add these two methods to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ViewController.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , anywhere between </font></font><code>@implementation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>@end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs">- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [currentAlbumData[@<span class="hljs-string"><span class="hljs-string">"titles"</span></span>] count]; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { UITableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:@<span class="hljs-string"><span class="hljs-string">"cell"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cell) { cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:@<span class="hljs-string"><span class="hljs-string">"cell"</span></span>]; } cell.textLabel.text = currentAlbumData[@<span class="hljs-string"><span class="hljs-string">"titles"</span></span>][indexPath.row]; cell.detailTextLabel.text = currentAlbumData[@<span class="hljs-string"><span class="hljs-string">"values"</span></span>][indexPath.row]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell; }</code> </pre><br> <code>tableView:numberOfRowsInSection:</code>   ,     <code>TableView</code> ,       . <br><br> <code>tableView:cellForRowAtIndexPath:</code>         ( <code>title</code> )    ( <code>value</code> ). <br><br>  ,     : <br><br><img src="http://habrastorage.org/storage3/e49/b63/195/e49b63195c791ec8462f65a022278c8a.png"><br><br>    .        ,         . <br><br>    ¬´¬ª ,  ,        , ?            ‚Äî .    ,    .   ,     <code>UITableView</code> .        . <br><br><h2> ¬´¬ª </h2><br>        .  ‚Äî    ,   <i></i>      . <br><br><img src="http://habrastorage.org/storage3/80d/4e2/116/80d4e21169d016fc65d39f9ecda00293.png"><br><br>      ¬´¬ª   ,   ,  Apple    (       MicroUSB).      . ,  ,    <code>UITableViewDelegate</code> , <code>UIScrollViewDelegate</code> , <code>NSCoding</code> , <code>NSCopying</code> .  ,  <code>NSCopying</code>      <code>copy</code> . <br><br><h3>    ¬´¬ª </h3><br>       : <br><br><img src="http://habrastorage.org/storage3/b27/ae2/2d5/b27ae22d5d1c9215861d81d3567569aa.png"><br><br>     ,      ¬´Objective-C class¬ª (  , ?)   View,   <code>HorizontalScroller</code>     <code>UIView</code> . <br><br>  <b>HorizontalScroller.h</b>    <code>@end</code> : <br><br><pre> <code class="cpp hljs">@protocol HorizontalScrollerDelegate &lt;NSObject&gt; <span class="hljs-comment"><span class="hljs-comment">//     @end</span></span></code> </pre><br>     <code>HorizontalScrollerDelegate</code> ‚Äî    <code>NSObject</code> (  ,   ).   ‚Äî     <code>NSObject</code>   ,  /  <code>NSObject</code> .      ,   <code>NSObject</code> ,   <code>HorizontalScroller</code> .  ,   . <br><br>     ,    ,  <code>@protocol</code>  <code>@end</code> : <br><br><pre> <code class="cpp hljs">@required <span class="hljs-comment"><span class="hljs-comment">//  ,        - (NSInteger)numberOfViewsForHorizontalScroller:(HorizontalScroller *)scroller; //       &lt;index&gt; - (UIView *)horizontalScroller:(HorizontalScroller *)scroller viewAtIndex:(int)index; //         &lt;index&gt; - (void)horizontalScroller:(HorizontalScroller *)scroller clickedViewAtIndex:(int)index; @optional //  ,       // ( ,   0,     ) - (NSInteger)initialViewIndexForHorizontalScroller:(HorizontalScroller *)scroller;</span></span></code> </pre><br>        .  ‚Äî    ,     ,    .        (),    ,       . <br><br>   ‚Äî   .    ,  <code>HorizontalScroller</code>    . <br><br>            <code>HorizontalScroller</code> .       , ..       <code>HorizontalScroller</code> .  What to do? <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The solution is a forward declaration of the protocol </font></font><code>HorizontalScrollerDelegate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">So that the compiler knows that we have such a protocol (but will be announced later). </font><font style="vertical-align: inherit;">Add above line </font></font><code>@interface</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs">@protocol HorizontalScrollerDelegate;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the same </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HorizontalScroller.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file, </font><font style="vertical-align: inherit;">add a couple more lines between </font></font><code>@interface</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>@end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs">@property (weak) id&lt;HorizontalScrollerDelegate&gt; delegate; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)reload;</code> </pre><br> ,    <code>weak</code> (¬´¬ª)   ( ) <code>delegate</code> .  ,   ¬´retain-¬ª.       ,         ,      .         . <br><br> ( -       ,         ¬´¬ª  ). <br><br>  <code>id&lt;HorizontalScrollerDelegate&gt;</code> ,       ,    <code>HorizontalScrollerDelegate</code> (     ). <br><br>  <code>reload</code>    <code>reloadData</code>  <code>UITableView</code> :      ,    . <br><br>    <b>HorizontalScroller.m</b>    (    ): <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"HorizontalScroller.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 1 #define VIEW_PADDING 10 #define VIEW_DIMENSIONS 100 #define VIEWS_OFFSET 100 // 2 @interface HorizontalScroller () &lt;UIScrollViewDelegate&gt; @end // 3 @implementation HorizontalScroller { UIScrollView * scroller; } @end</span></span></span></span></code> </pre><br>  ,   : <br><ol><li>          .      100100    10   ,   . <br> <i>( ‚Äî    !  iOS Drawing Concepts   <a href="https://developer.apple.com/library/ios/documentation/2DDrawing/Conceptual/DrawingPrintingiOS/GraphicsDrawingOverview/GraphicsDrawingOverview.html">Points Versus Pixels</a> )</i> . </li><li>  HorizontalScroller   UIScrollViewDelegate.   HorizontalScroller  UIScrollView    ,      , ,    . </li><li> ,  scroll view. </li></ol><br>      : <br><br><pre> <code class="cpp hljs">- (id)initWithFrame:(CGRect)frame { self = [super initWithFrame:frame]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { scroller = [[UIScrollView alloc] initWithFrame:CGRectMake(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, frame.size.width, frame.size.height)]; scroller.delegate = self; [self addSubview:scroller]; UITapGestureRecognizer * tapRecognizer = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(scrollerTapped:)]; [scroller addGestureRecognizer:tapRecognizer]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }</code> </pre><br>   ( <code>scroller</code> )   <code>HorizontalScroller</code> .   <code>UITapGestureRecognizer</code>     ScrollView  ,      .  ,    <code>HorizontalScroller</code> . <br><br>   : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollerTapped:(UITapGestureRecognizer *)gesture { CGPoint location = [gesture locationInView:gesture.view]; <span class="hljs-comment"><span class="hljs-comment">//   enumerator, ..      . //      subviews,   : for (int index = 0; index &lt; [self.delegate numberOfViewsForHorizontalScroller:self]; index++) { UIView * view = scroller.subviews[index]; if (CGRectContainsPoint(view.frame, location)) { [self.delegate horizontalScroller:self clickedViewAtIndex:index]; CGPoint offset = CGPointMake(view.frame.origin.x - self.frame.size.width/2 + view.frame.size.width/2, 0); [scroller setContentOffset:offset animated:YES]; break; } } }</span></span></code> </pre><br>   ¬´¬ª ( <code>gesture</code> ),    ,    ( <code>locationInView:</code> ). <br><br>     <code>numberOfViewsForHorizontalScroller:</code> .  <code>HorizontalScroller</code>      ,  ,        (    <code>HorizontalScrollerDelegate</code> ). <br><br>     scroll view ‚Äî ,     ,   <code>CGRectContainsPoint</code> .    ,    <code>horizontalScroller:clickedViewAtIndex:</code>        . <br><br>       : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)reload { <span class="hljs-comment"><span class="hljs-comment">// 1 -  ,   : if (self.delegate == nil) return; // 2 -   subviews: [scroller.subviews enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL * stop) { [obj removeFromSuperview]; }]; // 3 - xValue -      : CGFloat xValue = VIEWS_OFFSET; for (int i = 0; i &lt; [self.delegate numberOfViewsForHorizontalScroller:self]; i++) { // 4 -     : xValue += VIEW_PADDING; UIView * view = [self.delegate horizontalScroller:self viewAtIndex:i]; view.frame = CGRectMake(xValue, VIEW_PADDING, VIEW_DIMENSIONS, VIEW_DIMENSIONS); [scroller addSubview:view]; xValue += VIEW_DIMENSIONS + VIEW_PADDING; } // 5 [scroller setContentSize:CGSizeMake(xValue + VIEWS_OFFSET, self.frame.size.height)]; // 6 -   initialView,    : if ([self.delegate respondsToSelector:@selector(initialViewIndexForHorizontalScroller:)]) { int initialView = [self.delegate initialViewIndexForHorizontalScroller:self]; CGPoint offset = CGPointMake(initialView * (VIEW_DIMENSIONS + (2 * VIEW_PADDING)), 0); [scroller setContentOffset:offset animated:YES]; } }</span></span></code> </pre><br>    : <br><ol><li>   ,     .   . </li><li>     (subviews),  . <br> <i>(,   ¬´subview¬ª      ?  ¬´¬ª . :) ‚Äî . .)</i> </li><li>        ( <code>VIEWS_OFFSET</code> ).      <code>100</code> ,        <code>#define</code>    . </li><li> <code>HorizontalScroller</code>       ( <code>UIView</code> )   ,           . </li><li>     ,   ,        . </li><li> <code>HorizontalScroller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looks at whether the delegate responds to the message selector </font></font><code>initialViewIndexForHorizontalScroller:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This check is necessary because this protocol method is optional. </font><font style="vertical-align: inherit;">If the delegate does not implement this method, the default value is taken </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This part of the code sets the scrolling view to the center of the view defined by the delegate ( </font></font><code>initialView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We perform </font></font><code>reload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the event that our data has changed. </font><font style="vertical-align: inherit;">Also this method needs to be called when we add </font></font><code>HorizontalScroller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to a new view. </font><font style="vertical-align: inherit;">To do this, add this method to the class </font></font><code>HorizontalScroller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didMoveToSuperview { [self reload]; }</code> </pre><br>   <code>didMoveToSuperview</code> , ,   :    ,     -    .       . <br><br>    <code>HorizontalScroller</code> ‚Äî ,         scroll view.       ,    . <br><br>    (    , , <b>HorizontalScroller.m</b> ): <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)centerCurrentView { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xFinal = scroller.contentOffset.x + (VIEWS_OFFSET / <span class="hljs-number"><span class="hljs-number">2</span></span>) + VIEW_PADDING; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> viewIndex = xFinal / (VIEW_DIMENSIONS + (<span class="hljs-number"><span class="hljs-number">2</span></span> * VIEW_PADDING)); xFinal = viewIndex * (VIEW_DIMENSIONS + (<span class="hljs-number"><span class="hljs-number">2</span></span> * VIEW_PADDING)); [scroller setContentOffset:CGPointMake(xFinal, <span class="hljs-number"><span class="hljs-number">0</span></span>) animated:YES]; [self.delegate horizontalScroller:self clickedViewAtIndex:viewIndex]; }</code> </pre><br>              (content offset),    (dimensions)   (padding).     :      ,   ,   . <br><br>   ,    ,     <code>UIScrollViewDelegate</code> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!decelerate) { [self centerCurrentView]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)scrollViewDidEndDecelerating:(UIScrollView *)scrollView { [self centerCurrentView]; }</code> </pre><br> <code>scrollViewDidEndDragging:willDecelerate:</code>  ,    .  <code>decelerate</code> (¬´¬ª)   <code>true</code> ,         ,    ¬´ ¬ª.    ,     <code>scrollViewDidEndDecelerating</code> .         ( <code>centerCurrentView</code> ),    , ,     . <br><br>  <code>HorizontalScroller</code> !      .      <code>Album</code>  <code>AlbumView</code> .  Excellent!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This means our new scroller has turned out really independent of the content, and it can be reused. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build the project to make sure everything compiles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now that the horizontal scroll is ready, it's time to use it in our application! </font><font style="vertical-align: inherit;">Open </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ViewController.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and include 2 header files:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"HorizontalScroller.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"AlbumView.h"</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Below add </font></font><code>HorizontalScrollerDelegate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the list of protocols that implements </font></font><code>ViewController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs">@<span class="hljs-function"><span class="hljs-function">interface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewController</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &lt;UITableViewDataSource, UITableViewDelegate, HorizontalScrollerDelegate&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add a scroller instance variable to the class extension (between curly braces): </font></font><br><br><pre> <code class="cpp hljs">HorizontalScroller * scroller;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you can implement delegate methods. </font><font style="vertical-align: inherit;">You will be surprised how little code is required for a variety of functions! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add code to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ViewController.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> mark - HorizontalScrollerDelegate methods - (void)horizontalScroller:(HorizontalScroller *)scroller clickedViewAtIndex:(int)index { currentAlbumIndex = index; [self showDataForAlbumAtIndex:index]; }</span></span></code> </pre><br>    ,    ,    showDataForAlbumAtIndex:      . <br><br>  <b>Note.</b>        .     <code>#pragma mark</code> .   ,         IDE ‚Äî     . ,  AppCode   <b>‚åòF12</b> : <br><br><img src="http://habrastorage.org/storage3/4a6/d33/9ce/4a6d339ce448c4b1320df68e1b9b4363.png"><br><br>   , ,     . <br><br>   : <br><br><pre> <code class="cpp hljs">- (NSInteger)numberOfViewsForHorizontalScroller:(HorizontalScroller *)scroller { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allAlbums.count; }</code> </pre><br>  Remember?   ,      scroll view.      ,    ,     . <br><br>   : <br><br><pre> <code class="cpp hljs">- (UIView *)horizontalScroller:(HorizontalScroller *)scroller viewAtIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index { Album * album = allAlbums[index]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [[AlbumView alloc] initWithFrame:CGRectMake(<span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">100.f</span></span>, <span class="hljs-number"><span class="hljs-number">100.f</span></span>) albumCover:album.coverUrl]; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we create a new one </font></font><code>AlbumView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and transfer it to </font></font><code>HorizontalScroller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just! </font><font style="vertical-align: inherit;">Three short methods to display a beautiful horizontal scroller! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, and we still need to create (actually) a scroller and add it to the main view. </font><font style="vertical-align: inherit;">But first, add the following method:</font></font><br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)reloadScroller { allAlbums = [[LibraryAPI sharedInstance] albums]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentAlbumIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) currentAlbumIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentAlbumIndex &gt;= allAlbums.count) currentAlbumIndex = allAlbums.count - <span class="hljs-number"><span class="hljs-number">1</span></span>; [scroller reload]; [self showDataForAlbumAtIndex:currentAlbumIndex]; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This method loads album data through </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then sets the current view. </font><font style="vertical-align: inherit;">Just in case - check for going beyond the array. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we initialize the scroller by adding the following code in the </font></font><code>viewDidLoad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">front of the line</font></font><code>[self showDataForAlbumAtIndex:currentAlbumIndex];</code> <br><br><pre> <code class="cpp hljs">scroller = [[HorizontalScroller alloc] initWithFrame:CGRectMake(<span class="hljs-number"><span class="hljs-number">0.f</span></span>, <span class="hljs-number"><span class="hljs-number">20.f</span></span>, self.view.frame.size.width, <span class="hljs-number"><span class="hljs-number">120.f</span></span>)]; scroller.backgroundColor = [UIColor colorWithRed:<span class="hljs-number"><span class="hljs-number">0.24f</span></span> green:<span class="hljs-number"><span class="hljs-number">0.35f</span></span> blue:<span class="hljs-number"><span class="hljs-number">0.49f</span></span> alpha:<span class="hljs-number"><span class="hljs-number">1</span></span>]; scroller.delegate = self; [self.view addSubview:scroller]; [self reloadScroller];</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code creates a new instance </font></font><code>HorizontalScroller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sets the background color, designates itself as a delegate. </font><font style="vertical-align: inherit;">Then it adds a scroller to the main screen and updates the data in it.</font></font><br><br>  <b>Note.</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the protocol grows heavily, consider breaking it into several smaller ones. For example, </font></font><code>UITableViewDelegate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>UITableViewDataSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Both of them are protocols </font></font><code>UITableView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, i.e. technically could exist in the same protocol, but broken up for convenience. Try to develop protocols so that everyone is responsible for their own functional area. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build and run the project. Wonderful horizontal scroll:</font></font><br><br><img src="http://habrastorage.org/storage3/dff/3a8/57f/dff3a857fb0ff1069510f798f6747552.png"><br><br>  So, stop.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a scroll. </font><font style="vertical-align: inherit;">Where are the covers? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh, right! </font><font style="vertical-align: inherit;">We have not yet written the code for downloading covers. </font><font style="vertical-align: inherit;">We need to figure out how to upload images. </font><font style="vertical-align: inherit;">Since all of our access to services goes through </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the new method will have to go there. </font><font style="vertical-align: inherit;">But first you need to make out a few points: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. </font></font><code>AlbumView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">should not work directly with </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We don't want to mix UI code with network interaction, right? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. For the same reason </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">should not know about </font></font><code>AlbumView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must report </font></font><code>AlbumView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as soon as the covers are loaded so that </font></font><code>AlbumView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they are displayed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looks like a puzzle?</font></font> Do not despair!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We are in a hurry to help the next pattern - </font></font><br><br><h2>  Observer </h2><br>   ¬´¬ª         . ,   ,       ‚Äî    - ( , ) .     ,    ¬´ ¬ª   <i></i>  . <br><br>   ¬´¬ª      .   ,  -    .  push- Apple ‚Äî    . <br><br>      MVC (:  ) ‚Äî         ,  ‚Äî      !       ¬´¬ª. <br><br> Cocoa      :  (Notifications)  Key-Value Observing (KVO). <br><br><h3>  Notifications </h3><br> (    Push     .    .)     ¬´‚Äî¬ª.  ,  ¬´¬ª (publisher)    (subscribers / listeners).       . <br><br>    Apple. ,  iOS    ,   : <code>UIKeyboardWillShowNotification</code>  <code>UIKeyboardWillHideNotification</code> , .       ,    <code>UIApplicationDidEnterBackgroundNotification</code> . <br><br>  <b>Note.</b>  <b>UIApplication.h</b> ,        ,  . <br><div class="spoiler"> <b class="spoiler_title">  ?</b> <div class="spoiler_text"> <b>1 :</b>     : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIApplication.h&gt;</span></span></span></span></code> </pre><br>     <b>‚åò</b>   <code>UIApplication.h</code> . <br><br> <b>2 :</b>     <b>Frameworks</b> (    ),  <b>UIKit.framework</b> (  ,         )     <b>UIApplication.h</b> : <br><br><img src="http://habrastorage.org/storage3/1a3/2f9/6e4/1a32f96e4ed9681b5f7b8f7df8773ab8.png"></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to use notifications </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AlbumView.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and paste the following code in </font></font><code>initWithFrame:albumCover:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after</font></font><code>[self addSubview:indicator];</code> <br><br><pre> <code class="cpp hljs">[[NSNotificationCenter defaultCenter] postNotificationName:@<span class="hljs-string"><span class="hljs-string">"BLDownloadImageNotification"</span></span> object:self userInfo:@{@<span class="hljs-string"><span class="hljs-string">"coverUrl"</span></span>:albumCover, @<span class="hljs-string"><span class="hljs-string">"imageView"</span></span>:coverImage}];</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This line sends the notification via singleton </font></font><code>NSNotificationCenter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The notification contains the URL of the image you want to upload, and </font></font><code>UIImageView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where you want to put this image. </font><font style="vertical-align: inherit;">That's all that our ‚Äúsubscriber‚Äù needs to know, who will receive this notification in order to complete the download task. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add the following line in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LibraryAPI.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the method </font></font><code>init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">immediately after </font></font><code>isOnline = NO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs">[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(downloadImage:) name:@<span class="hljs-string"><span class="hljs-string">"BLDownloadImageNotification"</span></span> object:nil];</code> </pre><br>     ‚Äî  ().  ,   <code>AlbumView</code>   <code>"BLDownloadImageNotification"</code> , .. <code>LibraryAPI</code>       ,   <code>LibraryAPI</code> .   , <code>LibraryAPI</code>  <code>downloadImage:</code> . <br><br>     ¬´BL¬ª =     <code>BlueLibrary</code>   . <br><br>       ,    :     ,      .    ,     ,       (deallocated),      . <br><br><div class="spoiler"> <b class="spoiler_title">       Objective C</b> <div class="spoiler_text">   ,    ,         . </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add the following method to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LibraryAPI.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc { [[NSNotificationCenter defaultCenter] removeObserver:self]; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When a class object is unloaded from memory, it unsubscribes from all notifications to which it was subscribed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And one more thing. </font><font style="vertical-align: inherit;">It would be nice to save the downloaded covers locally so that you don‚Äôt have to download them again and again. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PersistencyManager.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add two prototype methods:</font></font><br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveImage:(UIImage *)image filename:(NSString *)filename; - (UIImage *)getImage:(NSString *)filename;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here is their implementation in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PersistencyManager.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveImage:(UIImage *)image filename:(NSString *)filename { filename = [NSHomeDirectory() stringByAppendingFormat:@<span class="hljs-string"><span class="hljs-string">"/Documents/%@"</span></span>, filename]; NSData * data = UIImagePNGRepresentation(image); [data writeToFile:filename atomically:YES]; } - (UIImage *)getImage:(NSString *)filename { filename = [NSHomeDirectory() stringByAppendingFormat:@<span class="hljs-string"><span class="hljs-string">"/Documents/%@"</span></span>, filename]; NSData * data = [NSData dataWithContentsOfFile:filename]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [UIImage imageWithData:data]; }</code> </pre><br> ,  .      <b>Documents/</b>   . <code>getImage:</code>  <code>nil</code> ,    . (  ,       ,     <code>UIImage</code> ,    . <i>‚Äî . .</i> ) <br><br>       <b>LibraryAPI.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)downloadImage:(NSNotification *)notification { <span class="hljs-comment"><span class="hljs-comment">// 1 NSString * coverUrl = notification.userInfo[@"coverUrl"]; UIImageView * imageView = notification.userInfo[@"imageView"]; // 2 imageView.image = [persistencyManager getImage:[coverUrl lastPathComponent]]; if (imageView.image == nil) { // 3 dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ UIImage * image = [httpClient downloadImage:coverUrl]; // 4 dispatch_sync(dispatch_get_main_queue(), ^{ imageView.image = image; [persistencyManager saveImage:image filename:[coverUrl lastPathComponent]]; }); }); } }</span></span></code> </pre><br>     : <br><br><ol><li> <code>downloadImage</code>        <code>NSNotification</code>   .     URL     <code>UIImageView</code> . </li><li>      <code>PersistencyManager</code> ,     . </li><li>      ,     <code>HTTPClient</code> . </li><li>    ,    <code>UIImageView</code>    . </li></ol><br>     ¬´¬ª,         .   ,   :      . <br><br>    ,       <code>HorizontalScroller</code> : <br><br><img src="http://habrastorage.org/storage3/be0/acf/0c9/be0acf0c9869be77475ab02a5d34f192.png"><br><br><div class="spoiler"> <b class="spoiler_title">  iOS 9  : ,    ?</b> <div class="spoiler_text">    .       HTTPS,     .   <a href="https://forums.developer.apple.com/message/5857"> </a>  <s></s> ,   . </div></div><br>      . ,         , ..    .         . <br><br>    : ¬´¬ª   !   ? <br><br>  :      ,     ,   ,   .       ,   .       : KVO. <br><br><h3> Key-Value Observing (KVO) </h3><br> <i> : -    . :    ¬´-¬ª.</i> <br><br>    KVO   ,        ‚Äî      .      <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">KVO Programming Guide</a>  Apple. <br><br><h4>    KVO </h4><br> KVO      .     KVO,      image   <code>UIImageView</code> . <br><br>  <b>AlbumView.m</b>       <code>initWithFrame:albumCover:</code>    <code>[self addSubview:indicator];</code> <br><br><pre> <code class="cpp hljs">[coverImage addObserver:self forKeyPath:@<span class="hljs-string"><span class="hljs-string">"image"</span></span> options:<span class="hljs-number"><span class="hljs-number">0</span></span> context:nil];</code> </pre><br>   <code>self</code> (   <code>AlbumView</code> )      <code>image</code>  <code>coverImage</code> . <br>   ¬´ ¬ª ,   ,  <b>AlbumView.m</b>  <code>@end</code> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc { [coverImage removeObserver:self forKeyPath:@<span class="hljs-string"><span class="hljs-string">"image"</span></span>]; }</code> </pre><br> ,   : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)context { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([keyPath isEqualToString:@<span class="hljs-string"><span class="hljs-string">"image"</span></span>]) { [indicator stopAnimating]; } }</code> </pre><br>       ,   .    ,  ¬´¬ª  .       ,    <code>image</code> .  ,    ,   . <br><br> (  ,      <code>change</code> ,       .  ,       .    <code>nil</code> ,     =&gt;  . <i>‚Äî . .</i> ) <br><br>  Run the application.   : <br><br><img src="http://habrastorage.org/storage3/7a1/de1/2da/7a1de12da283036e6803be36a7faffb9.png"><br><br>  <b>Note.</b>      <code>dealloc</code> .    ,      ! <br><br>          ,    ,   :   (  )    . ,   ?  :) <br><br>    ¬´¬ª,       : <br><br><h2>  (Memento) </h2><br> ¬´¬ª      ‚Ä¶ -.          , ..  (private)    . <br><br><h3>    Memento </h3><br>      <b>ViewController.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveCurrentState { <span class="hljs-comment"><span class="hljs-comment">//          , //      ,    .   //     .   , //    NSUserDefaults: [[NSUserDefaults standardUserDefaults] setInteger:currentAlbumIndex forKey:@"currentAlbumIndex"]; } - (void)loadPreviousState { currentAlbumIndex = [[NSUserDefaults standardUserDefaults] integerForKey:@"currentAlbumIndex"]; [self showDataForAlbumAtIndex:currentAlbumIndex]; }</span></span></code> </pre><br>  <code>saveCurrentState</code>    . <code>NSUserDefaults</code> ‚Äî      ,  iOS. <br><br> <code>loadPreviousState</code>    ,  .       ¬´¬ª,     . <br><br>      <b>ViewController.m</b>   <code>viewDidLoad</code>   : <br><br><pre> <code class="cpp hljs">[self loadPreviousState];</code> </pre><br>         .      ?     . iOS   <code>UIApplicationDidEnterBackgroundNotification</code> ,     .     ,  <code>saveCurrentState</code> .  Conveniently?  Yes. <br><br>       <code>viewDidLoad</code> : <br><br><pre> <code class="cpp hljs">[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(saveCurrentState) name:UIApplicationDidEnterBackgroundNotification object:nil];</code> </pre><br>       , <code>ViewController</code>    ,  <code>saveCurrentState</code> . <br><br> <i> :</i>     iOS 6,       .  <b></b>   ,   .    Apple    ?    ?     ,     iOS 7.  ,     -,      ,     .  , iOS 7.0   ‚Ä¶DidEnterBackground‚Ä¶,       ,    .  ,        . <br><br>    : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc { [[NSNotificationCenter defaultCenter] removeObserver:self]; }</code> </pre><br>   <code>ViewController</code>   ,      . <br><br>   ,     .   ,    Home (  ‚Äî <b>‚åò‚áßH</b> )     .    ,     ,     : <br><br><img src="http://habrastorage.org/storage3/e6f/099/dd0/e6f099dd0623d6e854e57d429f67f5b5.png"><br><br>     <code>TableView</code> ,      .  Why? <br><br>       <code>initialViewIndexForHorizontalScroller:</code> ‚Äî    .        (   <code>ViewController</code> ).       . <br><br>   ,    <b>ViewController.m</b> : <br><br><pre> <code class="cpp hljs">- (NSInteger)initialViewIndexForHorizontalScroller:(HorizontalScroller *)scroller { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentAlbumIndex; }</code> </pre><br>    ( ,    )    <code>currentAlbumIndex</code> .      . <br><br>   .  Problem solved! <br><br><img src="http://habrastorage.org/storage3/fef/470/9d6/fef4709d6288753e28a9e3a5e8951922.png"><br><br>      <code>PersistencyManager</code>  <code>init</code> ,   ,      <code>Album</code>    .  ,        <code>PersistencyManager</code> .            .       ? <br><br>    ‚Äî     ,     plist,        <code>Album</code>  .    ,  : <br><ol><li>       .      Movie    ,         . </li><li>       ,       . </li></ol><br>   Apple  <sup>[citation needed]</sup>  . <br><br><h2>  </h2><br>     ¬´¬ª  Apple ‚Äî  .     ,         , ..      .          <a href="http://www.raywenderlich.com/store/ios-6-by-tutorials"></a>   Ray Wenderlich     <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Archiving/Archiving.html"> Apple</a> . <br><br><h3>    </h3><br>    ,   <code>Album</code>  .    ,     <code>NSCoding</code> .  <b>Album.h</b>    <code>@interface</code>  : <br><br><pre> <code class="cpp hljs">@interface Album : NSObject &lt;NSCoding&gt;</code> </pre><br>     <b>Album.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)encodeWithCoder:(NSCoder *)aCoder { [aCoder encodeObject:self.year forKey:@<span class="hljs-string"><span class="hljs-string">"year"</span></span>]; [aCoder encodeObject:self.title forKey:@<span class="hljs-string"><span class="hljs-string">"album"</span></span>]; [aCoder encodeObject:self.artist forKey:@<span class="hljs-string"><span class="hljs-string">"artist"</span></span>]; [aCoder encodeObject:self.coverUrl forKey:@<span class="hljs-string"><span class="hljs-string">"cover_url"</span></span>]; [aCoder encodeObject:self.genre forKey:@<span class="hljs-string"><span class="hljs-string">"genre"</span></span>]; } - (id)initWithCoder:(NSCoder *)aDecoder { self = [super init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { _year = [aDecoder decodeObjectForKey:@<span class="hljs-string"><span class="hljs-string">"year"</span></span>]; _title = [aDecoder decodeObjectForKey:@<span class="hljs-string"><span class="hljs-string">"album"</span></span>]; _artist = [aDecoder decodeObjectForKey:@<span class="hljs-string"><span class="hljs-string">"artist"</span></span>]; _coverUrl = [aDecoder decodeObjectForKey:@<span class="hljs-string"><span class="hljs-string">"cover_url"</span></span>]; _genre = [aDecoder decodeObjectForKey:@<span class="hljs-string"><span class="hljs-string">"genre"</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }</code> </pre><br>    ,   <code>encodeWithCoder:</code> .   <code>initWithCoder:</code>     . ,   . <br><br> ,   <code>Album</code>  ,  ,    /  . <br><br>     <b>PersistencyManager.h</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveAlbums;</code> </pre><br>     <b>PersistencyManager.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveAlbums { NSString * filename = [NSHomeDirectory() stringByAppendingString:@<span class="hljs-string"><span class="hljs-string">"/Documents/albums.bin"</span></span>]; NSData * data = [NSKeyedArchiver archivedDataWithRootObject:albums]; [data writeToFile:filename atomically:YES]; }</code> </pre><br> <code>NSKeyedArchiver</code>      " <code>albums.bin</code> ". <br><br>    ,    ,     .      <code>albums</code> (  <code>Album</code> ).     <code>NSArray</code>  <code>Album</code>   <code>NSCoding</code> ,     . <br><br>   <b>PersistencyManager.m</b>   <code>init</code>   : <br><br><pre> <code class="cpp hljs">- (id)init { self = [super init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self) { NSData * data = [NSData dataWithContentsOfFile:[NSHomeDirectory() stringByAppendingString:@<span class="hljs-string"><span class="hljs-string">"/Documents/albums.bin"</span></span>]]; albums = [NSKeyedUnarchiver unarchiveObjectWithData:data]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (albums == nil) { albums = [NSMutableArray arrayWithArray: @[[[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"Best of Bowie"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"David Bowie"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_david_bowie_best_of_bowie.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"1992"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"It's My Life"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"No Doubt"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_no_doubt_its_my_life_bathwater.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"2003"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"Nothing Like The Sun"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"Sting"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_sting_nothing_like_the_sun.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"1999"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"Staring at the Sun"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"U2"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_u2_staring_at_the_sun.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"2000"</span></span>], [[Album alloc] initWithTitle:@<span class="hljs-string"><span class="hljs-string">"American Pie"</span></span> artist:@<span class="hljs-string"><span class="hljs-string">"Madonna"</span></span> coverUrl:@<span class="hljs-string"><span class="hljs-string">"https://s3.amazonaws.com/CoverProject/album/album_madonna_american_pie.png"</span></span> year:@<span class="hljs-string"><span class="hljs-string">"2000"</span></span>]]]; [self saveAlbums]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }</code> </pre><br>  <code>NSKeyedUnarchiver</code>     ,   .   ,       .   ,      . <br><br>        ,     .   ,     ,           ?   ,    . <br><br>      <b>LibraryAPI.h</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveAlbums;</code> </pre><br>   <code>LibraryAPI</code> ,   ,    .     <code>PersistencyManager</code> ',     . <br><br>      <b>LibraryAPI.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)saveAlbums { [persistencyManager saveAlbums]; }</code> </pre><br> ,     <b>ViewController.m</b>    <code>saveCurrentState</code> : <br><br><pre> <code class="cpp hljs">[[LibraryAPI sharedInstance] saveAlbums];</code> </pre><br>      ,  <code>ViewController</code>   . <br><br>    (Build),  ,   . <br><br>  ,       .     <code>Documents</code>     (    iExplorer).   ,    .      ,        . <br><br>             ,   :     <s>  </s> .      ,       . <br><br>           : . <br><br><h2>  Team </h2><br> <i> ‚Äî   ¬´¬ª, Command,   Team.</i> <br><br>  ¬´¬ª      . ,     <b>¬´ ¬ª</b> : <br><br><pre> <code class="cpp hljs">Forrest-&gt;Run(speed, distance);</code> </pre><br>         : <br><ul><li> <code>Forrest</code> ; </li><li> <code>Run</code> ; </li><li> <code>Array(speed, distance).</code> </li> </ul><br>      :     , , ,   ‚Ä¶ ,  . Apple       ¬´-¬ª (Target-Action)   (Invocation). <br><br>  Target-Action   <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/CocoaEncyclopedia/Target-Action/Target-Action.html">  Apple</a> .     <code>NSInvocation</code> ,     (   ),     .       ,  ,   .    ¬´¬ª,      (  =&gt;     ).     ,      . <br><br><h3>    ¬´¬ª </h3><br>  ,     ,     .  <code>UIToolbar</code>  <code>NSMutableArray</code>     (undo stack). <br><br>     <b>ViewController.m</b>    <code>ViewController</code> ,      : <br><br><pre> <code class="cpp hljs">UIToolbar * toolbar; NSMutableArray * undoStack; <span class="hljs-comment"><span class="hljs-comment">//   ,       push  pop</span></span></code> </pre><br>    ,   ‚Äî     .   ,      . <br><br>      <code>viewDidLoad:</code>    " <code>// 2</code> ": <br><br><pre> <code class="cpp hljs">toolbar = [[UIToolbar alloc] init]; UIBarButtonItem * undoItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemUndo target:self action:@selector(undoAction)]; undoItem.enabled = NO; UIBarButtonItem * space = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace target:nil action:nil]; UIBarButtonItem * <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemTrash target:self action:@selector(deleteAlbum)]; [toolbar setItems:@[undoItem, space, <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>]]; [self.view addSubview:toolbar]; undoStack = [[NSMutableArray alloc] init];</code> </pre><br>             ( =    ).  ,     .  Undo  , ..  . <br><br> ,     frame, ..      .   ,    <code>viewDidLoad</code>   .      ,  <code>ViewController</code>  ¬´¬ª.     <b>ViewController.m</b> : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewWillLayoutSubviews { toolbar.frame = CGRectMake(<span class="hljs-number"><span class="hljs-number">0</span></span>, self.view.frame.size.height - <span class="hljs-number"><span class="hljs-number">44</span></span>, self.view.frame.size.width, <span class="hljs-number"><span class="hljs-number">44</span></span>); dataTable.frame = CGRectMake(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">130</span></span>, self.view.frame.size.width, self.view.frame.size.height - <span class="hljs-number"><span class="hljs-number">200</span></span>); }</code> </pre><br>       <b>ViewController.m</b>      : ,     . <br><br>   ‚Äî   : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addAlbum:(Album *)album atIndex:(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)index { [[LibraryAPI sharedInstance] addAlbum:album atIndex:index]; currentAlbumIndex = index; [self reloadScroller]; }</code> </pre><br>    , ¬´¬ª   (  )   . <br><br> , : <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)deleteAlbum { <span class="hljs-comment"><span class="hljs-comment">// 1 Album * deletedAlbum = allAlbums[currentAlbumIndex]; // 2 NSMethodSignature * sig = [self methodSignatureForSelector:@selector(addAlbum:atIndex:)]; NSInvocation * undoDeleteAction = [NSInvocation invocationWithMethodSignature:sig]; [undoDeleteAction setTarget:self]; [undoDeleteAction setSelector:@selector(addAlbum:atIndex:)]; [undoDeleteAction setArgument:&amp;deletedAlbum atIndex:2]; [undoDeleteAction setArgument:&amp;currentAlbumIndex atIndex:3]; [undoDeleteAction retainArguments]; // 3 [undoStack addObject:undoDeleteAction]; // 4 [[LibraryAPI sharedInstance] deleteAlbumAtIndex:currentAlbumIndex]; [self reloadScroller]; // 5 [toolbar.items[0] setEnabled:YES]; }</span></span></code> </pre><br>     ,     : <br><br><ol><li>    ,   . </li><li>    (  <code>NSMethodSignature</code> ).       <code>NSInvocation</code> ,          ‚Äî <code>undoDeleteAction</code> . <br> <code>NSInvocation</code>    : <br><ul><li> <u></u> ‚Äî ,   ; </li><li> <u></u> ‚Äî   ; </li><li> <u></u> . </li></ul>       ,   ¬´¬ª.   ‚Äî ,   . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we have created </font></font><code>undoDeleteAction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, add it to the imaginary "stack" ... </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Never do that! </font><font style="vertical-align: inherit;">The author calls the array a stack. </font><font style="vertical-align: inherit;">Like, "a person reading a code must imagine that an array is a stack" ... Do you want a stack? </font><font style="vertical-align: inherit;">There must be two operations: </font></font><code>push</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>pop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Everything. </font><font style="vertical-align: inherit;">- Approx. </font><font style="vertical-align: inherit;">per.</font></font></i> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remove the album from the data structure using </font></font><code>LibraryAPI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and update the scroller.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have an action that can be undone, so we need to allow the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Undo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button to be pressed </font><font style="vertical-align: inherit;">.</font></font></li></ol><br>  <b>Note.</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the scheme </font></font><code>NSInvocation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you need to keep in mind the following:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arguments must be passed by pointer. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The numbering of the arguments starts with an index </font></font><code>2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Indexes </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and are </font></font><code>1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reserved for the target and selector.</font></font></li><li>       ,   <code>retainArguments</code> . </li></ul><br> ,     ¬´¬ª: <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)undoAction { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (undoStack.count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { NSInvocation * undoAction = [undoStack lastObject]; [undoStack removeLastObject]; [undoAction invoke]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (undoStack.count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { [toolbar.items[<span class="hljs-number"><span class="hljs-number">0</span></span>] setEnabled:NO]; } }</code> </pre><br>           : <code>lastObject</code> + <code>removeLastObject</code> . , <code>ViewController</code>      .    ‚Äî        . <br><br>      ,     <code>NSInvocation</code>        <code>invoke</code> .  ,  ,     (  ) ‚Äî       . <br><br> ,   ,   .   ,    .   ,        .        <b>Undo</b> (  ). <br><br>  ,  ,    ‚Äã‚Äã .  -     Undo,    : <br><br>    ,         .  ,    ,      .    ,       . <br><br><h2>  What's next </h2><br>  Objective C     ,      :   ( <a href="https://developer.apple.com/legacy/library/documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaDesignPatterns/CocoaDesignPatterns.html">Abstract Factory</a> )    ( <a href="https://developer.apple.com/legacy/library/documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaDesignPatterns/CocoaDesignPatterns.html">Chain of Responsibility</a> ).         . <br><br>  ,   :      .  ,   , MVC, , , , ,   . <br><br>    ,   ,   .       ,   ,  ,       . <br><br>    ,        .     ,  ,      ,       ,  ,  .      ,   ‚Äî ! <br><br><hr><br><h2>   ( ) </h2><br>   :        ¬´ ¬ª. <b> ‚Äî  </b> ,    : <br><ol><li>  ; </li><li> ,      . </li></ol><br>  ,   ‚Äî   ,     .       ¬´¬ª,  <i> </i>  ¬´¬ª   .   ‚Äî ? ? ? <br><br> ,    .   ,        ,     ¬´,  <code>NSMutableArray</code> ‚Äî    ¬ª      .       ,    (¬´    ,    ,  ¬ª). <br><br>  ,  ,    ,      ,   ,   ,   . ¬´  ?      ?¬ª ‚Äî      <b></b>   . <br><br>  And further.      IDE. ,    <code>showDataForAlbumAtIndex:</code>    <code>if (albumIndex &lt; allAlbums.count)</code> ,     <code>(albumIndex &gt;= 0)</code> ?      ,    <code>NSArray</code> ,  AppCode  : <br><br><img src="http://habrastorage.org/storage3/114/020/b31/114020b31dc170580ae03154f105ce4f.png"><br><br>  <code>int</code>  <code>NSUInteger</code> ,    ‚Äî    ‚Äî ¬´by design¬ª. <br><br><h2>  PS </h2><br> <b>   <i>dev <code>@</code> x128 <code>.</code> ru</i> ,  - .</b> <br><br>       <a href="https://developer.apple.com/legacy/library/documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaDesignPatterns/CocoaDesignPatterns.html">Cocoa Design Patterns</a>  Apple,       : <br><br><img src="http://habrastorage.org/storage3/0fc/6b9/4a8/0fc6b94a8e03448b48e215b301c500d7.png"><br><br>         <a href="https://developer.apple.com/library/mac/referencelibrary/GettingStarted/RoadMapOSX/books/StreamlineYourAppswithDesignPatterns/StreamlineYourApps/StreamlineYourApps.html">Streamline Your App with Design Patterns</a> ,       ¬´Gang of Four¬ª.  ¬´Start Developing Mac Apps Today¬ª   <i>-</i> .     . <br><br>    .   Objective C       ****Script,         (    -).    ,  . <br><br><h3>  What to read? </h3><br><ul><li> <a href="http://www.piter.com/book.phtml%3F978549600389%26barcode%3D978549600389"> - </a>  ¬´ ¬ª / ¬´Gang of Four¬ª (, , , ).  Classic. </li><li> <a href="http://www.ozon.ru/context/detail/id/6108824/"> </a> (, ). <a href="https://habrahabr.ru/users/agent_smith/" class="user_link">Agent_Smith</a> :      GOF'a . </li><li> <a href="http://www.amazon.com/Pro-Objective-C-Design-Patterns-iOS/dp/1430233303">Pro Objective-C Design Patterns for iOS</a> by Carlo Chung. <a href="https://habrahabr.ru/users/rule/" class="user_link">rule</a> :   . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/202960/">https://habr.com/ru/post/202960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202950/index.html">Melitopol - stratosphere - Tikhonovka</a></li>
<li><a href="../202952/index.html">ScienceHub # 07: Neurointelligence and Neuromorphic Systems</a></li>
<li><a href="../202954/index.html">Creating virtual photo objects</a></li>
<li><a href="../202956/index.html">Clearance of Tesla electric vehicles increased firmware upgrade</a></li>
<li><a href="../202958/index.html">DIY-dimmer: Fees from Itead Studio</a></li>
<li><a href="../202962/index.html">Watch out for fiber</a></li>
<li><a href="../202964/index.html">Winamp player development stopped</a></li>
<li><a href="../202966/index.html">Light and color: the basics of the basics</a></li>
<li><a href="../202968/index.html">DIY dimmer: a guide to the components</a></li>
<li><a href="../202970/index.html">Months search for a bug that was not. And in simple words about high frequency trading.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>