<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refinement of the ventilator or ventilation control from the carbon dioxide sensor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The level of carbon dioxide (CO2) is one of the important indicators of indoor air quality. It is also very convenient to use its level to control the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refinement of the ventilator or ventilation control from the carbon dioxide sensor</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b20/443/39d/b2044339d1c64570f5af78b9b6245d9f.jpg" align="right" alt="image"><br>  The level of carbon dioxide (CO2) is one of the important indicators of indoor air quality.  It is also very convenient to use its level to control the ventilation. <br><br>  In the article I will talk about the refinement of the ventilator and the remote control of the fans by means of microcontrollers and a CO2 sensor. <br>  Also, if desired, after a small revision, the same scheme can be applied to control the intake-exhaust system. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The average apartment is usually designed for natural ventilation.  This is when the air enters through the cracks in the windows and exits through the exhaust hole somewhere in the area of ‚Äã‚Äãthe kitchen, toilet, etc. <br>  In an apartment with plastic windows installed, the cracks, as a rule, do not happen and, in order for the ventilation to work, you have to slightly open the windows or air vents, which improves the situation with air when the hood is working normally. <br>  But in this way we add street noise. <br><br>  To get fresh air in the room without noise can be installed: <br><ol><li>  Supply system </li><li>  Venting air from the street through a hole in the main wall </li></ol><br>  The first option solves all problems, but is expensive and requires space for equipment and ventilation ducts. <br>  The second option is simpler, but since the unit itself is of limited size, noise will depend on its mode of operation. <br>  Here is the option and consider. <br><br>  Here is a table of levels of carbon dioxide and its effects on health, to know what to strive for: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa1/49b/cf0/fa149bcf09dc84ec5fe4597ea7995843.jpg"><br><br>  Thus, we will consider the level of CO2 equal to 450-1000 ppm optimal for the room. <br>  About my experience, I will say that with the windows and doors closed, the ventilator is turned on at the minimum and two people are in the room, by morning it will be about 1200-1500 ppm, which is a bit too much. <br><br><br><h4>  Work algorithm </h4><br><br>  The algorithm used to control the performance of ventilation is quite simple, but if you wish, you can complicate: <br><ul><li>  An average CO2 level taken from the sensor is taken over time. </li><li>  There are 6 thresholds and depending on this, the speed of the fans is selected, which is transmitted via radio to the microcontrollers controlling the fans. </li><li>  When the CO2 level decreases, there is a certain threshold, only after which the speed decreases. </li><li>  At night, the maximum fan speed is limited to reduce noise. </li><li>  By commands from the console, you can increase or decrease the overall performance of the ventilation, and specifically each fan. </li></ul><br><br>  The carbon dioxide monitor used is an inexpensive household CO2 monitor MIC 98130. <br>  Air flows through the Aeropac 90A. <br>  The hood is reinforced with a SystemAir IF 150 duct fan. <br><br>  For control, Atmel AVR ATtiny44A microcontrollers are used. <br>  Data is transmitted from the controller connected to the CO2 monitor to the controllers controlling the fans using modules on the NRF24L01 + transceiver. <br>  Setting the operation mode and setting is possible using any IR remote control, or a magnet or a button. <br><br><br><h4>  CO2 monitor upgrade </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e24/c08/5ae/e24c085ae26932f73da1c0b36f77cd8b.jpg" align="right" alt="image"><br>  The CO2 monitor ordered on ebay, as it turned out, has an SenseAir K22 infrared gas analyzer inside with fairly good accuracy. <br>  And most importantly - it has a special output with a level of CO2 (in the picture there is a white connector with four contacts). <br><br>  On this connector, from left to right: <br><br><ol><li>  power + 9V </li><li>  common </li><li>  CO2 output in PWM from 350 to 2000 ppm </li></ol><br>  There is not a lot of free space inside, so a mini-card with a NRF24L01 + transceiver was used for refinement and the microcontroller is also soldered onto it in an SOP14 casing.  Before sealing, DWEN fusion was enabled for programming and debugging via the debugWIRE protocol. <br><br>  On radio modules there is one remark - the transmission distance is not long enough. <br><img src="https://habrastorage.org/getpro/habr/post_images/327/da6/4d1/327da64d1106226bad9cfad815d01e78.jpg" align="right" alt="image"><br>  Especially if there are walls, doors between the transmitter and the receiver.  So it is better to choose modules with an external antenna or try to keep as few obstacles between the transmitter and receiver as possible. <br><br>  There is an nRF24L01 + compatible Chinese chip with increased transmit power - the SI24R01. <br>  Modules with it usually cost less, so it‚Äôs better to take with it. <br>  True, I did not find imputed mini-modules with this chip and the project still uses modules with the native nRF24L01 + chip. <br>  To enable increased transmit power, the SI24R01 uses bit 0 of the RF_SETUP register. <br><br>  On resistors R1, R2 assembled divider to reduce the voltage received from the sensor. <br><img src="https://habrastorage.org/getpro/habr/post_images/e04/926/7af/e049267afdade4616e4be6ca72274802.jpg" align="right" alt="image"><br>  The value of CO2 is obtained by calculating the time between the change of level on the foot of the controller.  The time is taken from the counter 16 bit timer. <br>  In order to perform fewer calculations, the microcontroller operates at a frequency of 8.192 MHz, and the timer divider is set to 1024. <br>  Thus, the TCNT1 timer counter increases every 0.125 ms. <br>  It turns out to calculate the level of CO2 - you need to divide the timer counter by 4 and subtract 4. <br><br>  PWM signal at the sensor output: <br><img src="https://habrastorage.org/getpro/habr/post_images/24d/abc/86a/24dabc86a3a265368f6d6512a01b232b.jpg"><br><br>  Scheme: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/351/4de/892/3514de892aefa69264bbc6663af04628.jpg" alt="Scheme"></a> <br><br>  The photoresistor LDR1 is used to determine the threshold of darkness, the button - for the initial memorization of IR remote control commands.  The LED informs about transmission errors, and is also used for tuning. <br><br>  To control and configure, I decided to use a conventional IR remote control, the commands of which I need to first register in the microcontroller. <br>  Entering the programming mode - press and hold the button for more than 3 seconds.  Then in order to irradiate the IR receiver, pressing the buttons on the remote. <br>  IR commands: <br><ol><li>  up, </li><li>  way down, </li><li>  choice, </li><li>  setting the adjustment speed of each fan. </li></ol><br>  In normal mode, the ‚Äúup‚Äù and ‚Äúdown‚Äù commands increase or decrease the speeds of all fans by one notch. <br>  The "select" command is a reset. <br>  Using command 4, the speed offset setting of each fan is entered.  First, the fan number is selected, then, after selection, the offset is entered.  The LED in this mode blinks the current selection. <br><br>  Commands are identified by the microcontroller in this way: <br><ul><li>  using timer 0, we get the time from the previous signal edge (interrupt PCINT1) </li><li>  if this is the first impulse, then we check its duration in order to immediately eliminate false positives. </li><li> if there is a change in duration 1.5 times compared with the previous value, then add 1 to the bit array, otherwise 0. </li><li>  calculate the hash (2 bytes) of the bitmap and use it to identify the command </li></ul><br>  A simple hash function is used to reduce the load on the controller. <br><div class="spoiler">  <b class="spoiler_title">with the formula: hash = hash * 17 + x</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(IRSignalTimer &gt; IRSignalTimerLast) <span class="hljs-comment"><span class="hljs-comment">// bit = a / b &gt; 1.5 bit = (uint8_t)(IRSignalTimer - IRSignalTimerLast) &gt; IRSignalTimerLast / 2; else bit = (uint8_t)(IRSignalTimerLast - IRSignalTimer) &gt; IRSignalTimer / 2; IRReadedByte = (IRReadedByte &lt;&lt; 1) | bit; if(++IRArrayBit &gt; 7) { IRArrayBit = 0; IRHash = ((IRHash &lt;&lt; 4) + IRHash) + IRReadedByte; // * 17 IRReadedByte = 0; }</span></span></code> </pre> <br></div></div><br>  Many articles have been written on working with radio modules NRF24L01, I will not go into this topic further. <br>  I can only say that they are set to work at a speed of 1Mbps, CRC is used and each program must be confirmed by an ACK packet. <br>  For communication between the controller and the module, the hardware USI interface is used. <br>  The IRQ output is not used, the verification of the packet transmission confirmation is looped in the NRF24_Transmit function. <br><br>  It is transmitted to each fan - the CO2 level, the fan speed and the sign of the night. <br>  In the current project, the controllers that control the fans, while using only the speed. <br><br><br><h4>  Finalization of the ventilator </h4><br><br>  I have installed Aeropac 90A ventilators from SIEGENIA-AUBI - this is a rather ancient model. <br>  It has been working for more than one year and, as practice has shown, the thing is generally useful. <br>  Air he drives through the 80 mm hole in the wall and has a carbon filter. <br>  Noise isolation from sounds from the street is very good. <br><br>  Inside installed centrifugal fan Ebmpapst R2E133-BH96-19. <br>  With the noise of the fan itself after so many years of work, everything is not going smoothly.  At low revs a low-frequency rumble may occur, and at high rpm a certain howling may occur. <br>  And it manifests itself individually.  One fan buzzes more at low revs, the other whistles at high. <br>  Solved this problem by speed limit. <br><br>  In the ventilator, the engine speed adjustment scheme is implemented very interestingly - from low to medium speeds, smoothly, and then the maximum speed starts immediately. <br>  If at the minimum and average speed it works quietly enough, then at the maximum speed it is not comfortable to be indoors. <br>  In the new model - Aeropac SN, in spite of the digital step adjustment, the principle of adjustment of revolutions remained the same - from 1 to 6 speeds of revolutions are regulated somewhere up to the middle, and then immediately the maximum. <br><br>  In the diagram, the electronic unit of the ventilator is circled by a dotted line: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a52/1bd/f91/a521bdf91e2ea1e3621e7d8b99547036.jpg" alt="Scheme"></a> <br><br>  The refinement consists in cutting the track leading from the average output of the variable resistor RV1 to resistors R6 and R7.  Optocouplers U2 and U3 are connected to the break, which will control the fan speed. <br>  The control PWM signal to the optocouplers supplies the microcontroller through the integrating RC chain. <br>  The LED in the optocoupler begins to conduct current only from a certain voltage, so the program has a setting for the minimum value of the PWM signal. <br>  The variable resistor remains, and they, if desired, can limit the maximum speed. <br><br>  If the performance at medium speed is not enough, then it may be increased by replacing the capacitor C9 with a larger capacitor.  On the board, there are prudently openings for two sizes of capacitors - with a distance of 27.5mm and 22mm between the terminals. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6d5/29a/65d/6d529a65d20cacecb5dd0a529d7a8e5f.jpg"><br><br>  There is enough space inside the ventilator - not one board will fit either. <br>  The only problem may arise with radio modules.  The case is double and made of thick plastic. <br>  With the radio module on the native chip nRF24L01 + there was no connection with the next room. <br>  He unscrewed this way - he soldered the single-core copper wire to the built-in antenna, brought him out through the hole for the LED and placed the end under the twist of the variable resistor.  With the coordination of the antenna did not bother. <br>  The connection has appeared. <br><br>  For setting, instead of a button, a reed switch (SW1) is used, in order not to spoil the appearance and not violate sound insulation. <br>  The magnet from the hard disk is enough. <br><br><br><h4>  Exhaust hood </h4><br><br>  The incoming air must eventually go somewhere.  A natural extract, even if somehow cope in the winter, then in the summer it will most likely not be enough. <br>  In my case, I used a SystemAir IF 150 channel fan with a single-phase motor.  Its outer diameter is 15 cm. <br><br>  Adjusting its speed is stepped and made on capacitors.  Opto-simistors shunt capacitors, thus changing the voltage applied to the fan motor. <br>  With two capacitors, 4 speeds are obtained. <br><br>  Scheme: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/8d9/b36/849/8d9b36849f4a0a2e0a031746d5dadbe4.jpg" alt="Scheme"></a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90a/4bc/475/90a4bc475923156ce5a0c28e6568f814.jpg"><br><br>  Since the hood is installed in the kitchen, I decided at the same time to make additional control of the fan from the console. <br>  To, if something serious is being cooked on the stove, by pressing one button, turn on the hood to the maximum. <br>  The speed received over the radio is ignored. <br><br>  The fan control program is universal and, depending on the settings in the non-volatile memory, can control the fans using either PWM or discrete mode. <br>  Whether the IR receiver is connected to the controller is also set in the EEPROM. <br><br>  The program has the ability to relay the received packet further - to another fan. <br>  In this way, for example, you can increase the distance between the CO2 sensor and the exhaust fan. <br><br>  Source code in C (for Atmel Studio 6.1): <a href="http://yadi.sk/d/cGpSoKqZEceQN">yadi.sk/d/cGpSoKqZEceQN</a> </div><p>Source: <a href="https://habr.com/ru/post/205076/">https://habr.com/ru/post/205076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205064/index.html">Preliminary applications for domains in more than 600 new zones</a></li>
<li><a href="../205066/index.html">uid.me - personal pages service (technical details inside)</a></li>
<li><a href="../205070/index.html">Are you still boiling and comparing this with zero?</a></li>
<li><a href="../205072/index.html">Google returns to court to protect future programming</a></li>
<li><a href="../205074/index.html">We simulate a kettle in wind river simics</a></li>
<li><a href="../205078/index.html">How and why I started going to Management fights in Kiev</a></li>
<li><a href="../205082/index.html">The results of one study: a minute of inactivity of the average data center costs $ 7900</a></li>
<li><a href="../205084/index.html">MacroGroovy - working with AST on Groovy has never been easier</a></li>
<li><a href="../205086/index.html">POKA-YOKE design: from ‚Äúsmell‚Äù to fragrance</a></li>
<li><a href="../205088/index.html">The "smell" of design: an obsession with primitives</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>