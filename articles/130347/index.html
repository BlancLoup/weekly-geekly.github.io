<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application Expressions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 Looking through recently someone else's code, I came across a rather interesting task about IQueryable and Expession trees. I hope the de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application Expressions</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  Looking through recently someone else's code, I came across a rather interesting task about IQueryable and Expession trees.  I hope the decision will be useful to someone. <br><br>  The task is to reuse some Expression inside another Expression, for example, we have some <i>f</i> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs">Expression&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; f = (a, b) =&gt; a + b;</code> </pre> <br><br>  And we would like to use this <i>f</i> inside another expression, like this: <br><br><pre> <code class="cs hljs">Expression&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; g = (a, b, c) =&gt; f(a+b,b)*c;</code> </pre><br><br>  Moreover, it is necessary that the resulting expression be ‚Äúpure‚Äù, i.e.  suitable for use inside IQueryable (without compiled functions, etc.) <br><br><a name="habracut"></a><br><br>  If you try to compile these two lines, it turns out that the definition of g is wrong: <i>'f' is a 'variable' but it is used like a 'method'</i> , which, in general, is understandable, f is the root of the expression tree, and as not a function or functor.  You can try to write like this: <br><pre> <code class="cs hljs">Expression&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; g = (a, b, c) =&gt; f.Compile()(a+b,b)*c;</code> </pre><br><br>  But then our expression will look like this: <br><br> <code>(a, b, c) =&gt; (Invoke(value(ExpressionReducer.Program+&lt;&gt;c__DisplayClass0).f.Compile(), (a + b), b) * c)</code> <br> <br>  Naturally, our IQueryable will not understand this. <br><br>  The simplest and most obvious idea is to simply substitute f for its very body - roughly speaking, to make an ‚Äúapplication‚Äù of the term f to g (Honestly, I‚Äôm not at all strong at lambda refining, but in my opinion it will be the application). <br><br>  For such an ‚Äúapplication,‚Äù we need to rewrite the expression tree for g a little, specifically, replace the Invoke (Compile ()) call with the body of the function f, and in the body of f replace its parameters with the values ‚Äã‚Äãof the Invoke arguments, that is, from: <br><br><pre> <code class="cs hljs">(a, b, c) =&gt; f.Compile()(a+b,b)*c</code> </pre><br>  receive <br><pre> <code class="cs hljs">(a, b, c) =&gt; ((a+b)+b)*c</code> </pre><br><br>  First, let's get rid of the cumbersome Invoke (Compile) and replace it with this extension method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T Apply&lt;T,T1,T2&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Expression&lt;Func&lt;T1,T2,T&gt;&gt; expression, T1 t1, T2 t2) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expression.Compile()(t1, t2); } <span class="hljs-comment"><span class="hljs-comment">//... Expression&lt;Func&lt;int, int, int, int&gt;&gt; g = (a, b, c) =&gt; f.Apply(a + b, b) * c;</span></span></code> </pre><br><br>  In fact, the body of the Apply function is not important - it will never be called when converting, but it is useful to have a valid body if someone uses g without simplification. <br><br>  Now carefully look at the resulting tree: <br><img src="https://habrastorage.org/storage1/3f6fc5e2/67fa1c5d/d5fcb881/6d2e9bbe.png"><br><br>  Actually, here are the steps to be taken: <br><ol><li>  Find a call to the Apply method. </li><li>  Get the lambda function f from the first argument of the Apply function. </li><li>  Replace the arguments in the body of the lambda with the remaining parameters of the Apply function. </li><li>  Replace the .Call tree with a body f. </li></ol><br><br>  The first point is quite easy to do - use the ExpressionVisitor class from the System.Linq.Expressions namespace.  This is a very convenient class that allows you not only to visit all the nodes of the expression tree, but also to rewrite a part of it (for more details, see <a href="http://msdn.microsoft.com/en-us/library/bb546136%2528v%3Dvs.90%2529.aspx">http://msdn.microsoft.com/en-us/library/bb546136%28v=vs.90%29.aspx</a> ) We assume that the Apply method is in the ExpressionReductor class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InvokerVisitor</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMethodCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodCallExpression node</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.Method.DeclaringType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (ExpressionReductor) &amp;&amp; node.Method.Name == <span class="hljs-string"><span class="hljs-string">"Apply"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//     } return base.VisitMethodCall(node); } }</span></span></code> </pre><br>  The second paragraph is somewhat more complicated.  As can be seen from the tree, f became the field of the autogenerated class ExpressionReducer.Program + &lt;&gt; c__DisplayClass0 - this is how C # comes with all functors or expressions declared in the body of methods or which come as method parameters.  Among other possible options, this is a field or a property of a named class or the result of a function call. <br>  For simplicity, we will consider only the first case (the rest can be implemented similarly): f is a field of some class. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FieldLambdaFinder</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMember</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MemberExpression node</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constantExpression = (ConstantExpression) node.Expression; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info = (FieldInfo) node.Member; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldValue = (Expression)info.GetValue(constantExpression.Value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldValue; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Visit(expression); } }</code> </pre><br>  The third point is quite simple - we compose a Dictionary (parameter f -&gt; Apply parameter) and replace all ParameterExpression in the body of f: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Replacer</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;ParameterExpression, Expression&gt; _replacements; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Replacer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEnumerable&lt;ParameterExpression&gt; what, IEnumerable&lt;Expression&gt; with</span></span></span><span class="hljs-function">)</span></span> { _replacements = what.Zip(with, (param, expr) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { param, expr }).ToDictionary(x =&gt; x.param, x =&gt; x.expr); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Replace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression body</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Visit(body); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ParameterExpression node</span></span></span><span class="hljs-function">)</span></span> { Expression replacement; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _replacements.TryGetValue(node, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> replacement) ? replacement : <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitParameter(node); } }</code> </pre><br><br>  The last item will show everything in the collection: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InvokerVisitor</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMethodCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodCallExpression node</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.Method.DeclaringType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (ExpressionReductor) &amp;&amp; node.Method.Name == <span class="hljs-string"><span class="hljs-string">"Apply"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lambda = GetLambda(node.Arguments[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Replace(lambda, node.Arguments.Skip(<span class="hljs-number"><span class="hljs-number">1</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitMethodCall(node); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Replace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LambdaExpression lambda, IEnumerable&lt;Expression&gt; arguments</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> replacer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Replacer(lambda.Parameters, arguments); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> replacer.Replace(lambda.Body); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> LambdaExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> finder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldLambdaFinder(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (LambdaExpression) finder.Find(expression); } }</code> </pre><br><br>  Simplify method itself: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;T&gt; Simplify&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Expression&lt;T&gt; expression) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invoker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvokerVisitor(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Expression&lt;T&gt;) invoker.Visit(expression); }</code> </pre><br><br>  All at once can be found <a href="">here</a> . <br><br>  As a result, we got what we wanted: <br><pre> <code class="cs hljs">Expression&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; f = (a, b) =&gt; a + b; Expression&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; g = (a, b, c) =&gt; f.Apply(a + b, b)*c; g = g.Simplify();</code> </pre><br><br>  Remaining problems: <br><ol><li>  How to get f in other cases. </li><li>  If the Apply parameters are calls to other functions that have side effects, the substitution is incorrect.  In our case, this can not be, since we operate with IQueryable, but it is worth having it in mind. </li><li>  The Simplify function does not minimize the calculation: f.Apply (5, 5) will be simplified to (5 + 5), and not to (10). </li><li>  The Simplify function is not recursive, that is, in such examples - f.Apply (a, f.Apply (b, c)) - it will have to be called several times. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/130347/">https://habr.com/ru/post/130347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130342/index.html">The results of the action with Groupon. Practical experience</a></li>
<li><a href="../130343/index.html">Acer Aspire 7560G: an impressive desktop with a new-generation AMD quad-core processor</a></li>
<li><a href="../130344/index.html">Signed domain zone SU!</a></li>
<li><a href="../130345/index.html">Tactoom.com inside - social blogging platform on NodeJS / NoSQL</a></li>
<li><a href="../130346/index.html">Microsoft supports Hadoop</a></li>
<li><a href="../130348/index.html">Google Maps on the WebGL engine</a></li>
<li><a href="../130351/index.html">Presentation of Apple iPhone 4S - Russian translation</a></li>
<li><a href="../130352/index.html">Creating YouTube Player for Nokia N9 in QML</a></li>
<li><a href="../130355/index.html">Arduino and LiquidCrystal</a></li>
<li><a href="../130357/index.html">Amazon Dynamo: Highly Available Key-Value Data Warehouse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>