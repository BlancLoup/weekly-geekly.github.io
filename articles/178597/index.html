<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hulk hovercraft part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 As promised, I will continue my previous post with a more detailed description of the electronic filling and software. 





 Lun 1.0 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hulk hovercraft part 2</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br><br>  As promised, I will continue my previous <a href="http://habrahabr.ru/post/175017/">post with a</a> more detailed description of the electronic filling and software. <br><br><img src="https://habrastorage.org/storage2/35e/3a6/76d/35e3a676dc63f78243127b368cbfed05.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h1>  Lun 1.0 </h1><br><br>  The first version of the design was very simple: stm32vl-discovery, a console from an ancient radio-controlled car and 2 inverters for engines.  If schematically, it looked something like this: <br><br><img src="https://habrastorage.org/storage2/828/37d/b7c/82837db7c32113d6dfa833236df85c3e.jpg"><br><br>  In the firmware as in the layout, too, nothing complicated.  Everything was controlled by stm32vl-discovery, and the code was written in a couple of hours in CoIDE.  Separately, I would like to express my low bow to the developers of this programming environment, if not its convenience, who knows, maybe I wouldn‚Äôt get over the AVR. <br><br>  The implementation of the control was simple but absolutely inconvenient.  In the SVP, it was necessary to control three engines, and the console made it possible to control only two.  It was necessary to get out somehow, the ‚Äúforward‚Äù button controlled the traction screw, the ‚Äúback‚Äù button stopped the vessel, and the vessel was started by pressing the button on the debug board itself. <br><br><div class="spoiler">  <b class="spoiler_title">Initial firmware</b> <div class="spoiler_text">  #include &lt;stm32f10x.h&gt; <br>  #include &lt;stm32f10x_gpio.h&gt; <br>  #include &lt;stm32f10x_rcc.h&gt; <br>  #include &lt;stm32f10x_tim.h&gt; <br>  #include &lt;misc.h&gt; <br><br>  void init_leds (); <br>  void init_motors (); <br>  void init_timer (); <br>  void init_button (); <br>  void Delay_sig (); <br><br>  int sec = 0; <br>  int sm1 = 1000; <br>  int m1 = 750; <br>  int m2 = 750; <br>  int i, l; <br><br>  uint8_t r1 = 0, r2 = 0, r3 = 0, r4 = 0; <br><br>  #define first_motor GPIO_Pin_10 <br>  #define second_motor GPIO_Pin_12 <br>  #define servo_motor GPIO_Pin_11 <br>  #define blue_led GPIO_Pin_8 <br>  #define green_led GPIO_Pin_9 <br><br>  #define radio4 GPIO_Pin_8 <br>  #define radio3 GPIO_Pin_9 <br>  #define radio2 GPIO_Pin_10 <br>  #define radio1 GPIO_Pin_11 <br><br>  #define BUTTON GPIO_Pin_0 <br><br>  int main () <br><br>  { <br>  init_leds (); <br>  init_button (); <br>  init_motors (); <br>  init_timer (); <br><br>  SysTick_Config (SystemCoreClock / 300); <br><br>  do <br>  { <br><br>  r1 = GPIO_ReadInputDataBit (GPIOA, radio1); <br>  r2 = GPIO_ReadInputDataBit (GPIOA, radio2); <br>  r3 = GPIO_ReadInputDataBit (GPIOA, radio3); <br>  r4 = GPIO_ReadInputDataBit (GPIOA, radio4); <br><br>  } while (1); <br>  } <br><br>  void SysTick_Handler () <br>  { <br>  static uint8_t btn_old_state = 0; <br>  uint8_t btn_state = GPIO_ReadInputDataBit (GPIOA, BUTTON); <br><br>  if (btn_old_state == 0 &amp;&amp; btn_state == 1) <br>  { <br>  if (m1 &lt;1000) m1 = m1 + 50; <br>  } <br><br>  if (r1 == 1) <br>  { <br>  if (sm1 &lt;1600) sm1 = sm1 + 10; <br>  } <br><br>  else <br>  { <br>  if (sm1&gt; 1000) sm1 = sm1-10; <br>  } <br><br>  if (r3 == 1) <br>  { <br>  m2 = 900; <br>  } <br><br>  else <br>  { <br>  m2 = 750; <br>  } <br><br>  if (r2 == 1) <br>  { <br>  if (sm1&gt; 400) sm1 = sm1-10; <br>  } <br><br>  else <br>  { <br>  if (sm1 &lt;1000) sm1 = sm1 + 10; <br>  } <br><br>  if (r4 == 1) <br>  { <br>  m1 = 750; <br>  } <br><br>  btn_old_state = btn_state; <br>  } <br><br>  void init_leds () <br>  { <br>  RCC_APB2PeriphClockCmd (RCC_APB2Periph_GPIOC, ENABLE); <br>  GPIO_InitTypeDef gpio; <br>  GPIO_StructInit (&amp; gpio); <br>  gpio.GPIO_Mode = GPIO_Mode_Out_PP; <br>  gpio.GPIO_Pin = blue_led | green_led; <br>  GPIO_Init (GPIOC, &amp; gpio); <br>  GPIO_ResetBits (GPIOC, blue_led); <br>  GPIO_ResetBits (GPIOC, green_led); <br>  } <br><br>  void init_motors () <br>  { <br>  RCC_APB2PeriphClockCmd (RCC_APB2Periph_GPIOC, ENABLE); <br>  GPIO_InitTypeDef gpio; <br>  GPIO_StructInit (&amp; gpio); <br>  gpio.GPIO_Mode = GPIO_Mode_Out_PP; <br>  gpio.GPIO_Pin = first_motor | second_motor | servo_motor; <br>  GPIO_Init (GPIOC, &amp; gpio); <br>  GPIO_ResetBits (GPIOC, first_motor); <br>  GPIO_ResetBits (GPIOC, second_motor); <br>  GPIO_ResetBits (GPIOC, servo_motor); <br>  } <br><br>  void init_button () <br>  { <br>  RCC_APB2PeriphClockCmd (RCC_APB2Periph_GPIOA, ENABLE); <br>  GPIO_InitTypeDef gpio; <br>  GPIO_StructInit (&amp; gpio); <br>  gpio.GPIO_Mode = GPIO_Mode_IPD; <br>  gpio.GPIO_Pin = BUTTON | radio1 | radio2 | radio3 | radio4 | BT_en; <br>  gpio.GPIO_Speed ‚Äã‚Äã= GPIO_Speed_2MHz; <br>  GPIO_Init (GPIOA, &amp; gpio); <br>  } <br><br>  void init_timer () <br>  { <br>  RCC_APB1PeriphClockCmd (RCC_APB1Periph_TIM6, ENABLE); <br>  TIM_TimeBaseInitTypeDef base_timer; <br>  TIM_TimeBaseStructInit (&amp; base_timer); <br>  base_timer.TIM_Prescaler = 12000 - 1; <br>  base_timer.TIM_Period = 20; <br>  TIM_TimeBaseInit (TIM6, &amp; base_timer); <br>  TIM_ITConfig (TIM6, TIM_IT_Update, ENABLE); <br><br>  TIM_Cmd (TIM6, ENABLE); <br>  NVIC_EnableIRQ (TIM6_DAC_IRQn); <br>  } <br><br>  void Delay_sig () <br>  { <br>  int us = 0; <br>  for (us = 0; us &lt;5000; us ++) <br>  { <br>  if (us == sm1) {GPIO_ResetBits (GPIOC, servo_motor);} <br>  if (us == m1) {GPIO_ResetBits (GPIOC, first_motor);} <br>  if (us == m2) {GPIO_ResetBits (GPIOC, second_motor);} <br>  } <br>  } <br><br>  void TIM6_DAC_IRQHandler () <br>  { <br>  if (TIM_GetITStatus (TIM6, TIM_IT_Update)! = RESET) <br>  { <br>  TIM_ClearITPendingBit (TIM6, TIM_IT_Update); <br>  GPIO_SetBits (GPIOC, first_motor); <br>  GPIO_SetBits (GPIOC, second_motor); <br>  GPIO_SetBits (GPIOC, servo_motor); <br>  Delay_sig (); <br>  } <br>  } <br></div></div><br><br><h1>  Lun 2.0 </h1><br><br>  Having set the crutches in the program as well as in the mechanical part of our robot, we decided to thoroughly redo everything. <br>  First decided to add stability and ease of management.  For this, the MPU-6050 sensor and the HC-04 bluetooth module were purchased. <br>  No problems arose with the bluetooth, but for some reason the accelerometer did not work correctly.  First, after 10 seconds of work, he turned off, and then stopped responding altogether. <br>  After considering the possible options, it was decided to replace the debug board, and with it the whole layout scheme. <br><br>  It turned out this: <br><br><img src="https://habrastorage.org/storage2/045/628/747/045628747f39c65f02e74ecfa225d2ea.jpg"><br><br>  The main disappointment was to find out that CoIDE does not support programming STM32F303 microcontrollers.  Without hesitation, the commercial assembly of the same eclipse - Atollic TrueSTUDIO was installed.  The lite version was limited by the size of the compiled firmware (no more than 32KB), it suited us and the project moved to another environment. <br>  On the ST site, you can download the source code for the examples for this IDE, which also pleased us a lot.  Problems appeared when they began to study the code in depth.  The fact is that you cannot simply copy the code from the previous firmware; in STM32f3 versus STM32f100, the assignments of many registers have changed.  Yes, and at that time we found only examples from the manufacturer, it felt like no one was working on this debug board at all, even though it was already on sale for a year.  Problems were added when we decided to install a humidity sensor.  I honestly borrowed the code for working with the sensor from the article <a href="http://habrahabr.ru/post/160017/">‚ÄùSTM32 + DHT11‚Äù</a> , but the firmware written up to this point completely refused to work with the new code, it simply was not executed.  There were no errors or warnings during the compilation, but the code stubbornly did not want to run correctly, after killing two days and a lot of nerve cells, it turned out that if you turn off optimization in the settings, everything will work.  But there was a problem that I did not expect at all, after turning off the optimization, the size of the firmware began to exceed 32KB, I had to look for a new development environment.  After some time searching, I came across an <a href="http://robocraft.ru/blog/ARM/653.html">article</a> about setting up an Eclipse-based IDE.  It remains to create a project and move again. <br>  Simultaneously with the purchase of the Bluetooth module, the development of an application for Android began.  Before that, I have never written applications for mobile devices, so it was quite difficult to get started.  Especially I was confused by the misunderstanding of how the button moved in the graphic editor caused an error and closed the application. <br>  In addition to software changes, a lot of time was allocated for processing the layout. <br><br><img src="https://habrastorage.org/storage2/ff7/5f1/6f1/ff75f16f1eb4f612d7f0407856ead101.jpg"><br><br>  The fuselage, the skirt and the mast with a guide motor left from the first version.  The engine was installed in a vertical position, and the electronics shifted to one place.  Also, for the convenience of connecting the periphery, the switching card was split: <br><br><img src="https://habrastorage.org/storage2/b55/662/1d5/b556621d54bd48c2d04d9948acc3818d.jpg"><br><br>  I don‚Äôt see any point in citing the entire program code in the article and I think it would be better if I pay more attention to the points that caused the problems. <br><br>  What tasks were set before the program: <br><br>  0. Manage servos and inverters; <br>  1. Read the data from the built-in sensor debug board; <br>  2. According to the testimony to adjust the course; <br>  3. Receive and send data to the phone; <br>  4. Stop or go around obstacles on the way; <br>  5. Search for a suitable route; <br>  6. Read data from peripheral sensors; <br>  7. Do not allow too much battery discharge. <br><br>  Item Zero was organized on PWM with three channels.  As a result, after executing the code, this picture should have been obtained <br><br><img src="https://habrastorage.org/storage2/47f/8cb/f02/47f8cbf02c0ba1b07e91b9cd4efa8bce.jpg"><br>  where vertically one cell is 0.4 volts, and horizontally one cell is 2.5 ms. <br><br><div class="spoiler">  <b class="spoiler_title">PWM Initialization</b> <div class="spoiler_text"><br><br>  void TIM_Init () <br><br>  { <br><br>  uint16_t Channel1Pulse = 139, Channel2Pulse = 104, Channel3Pulse = 104; <br><br>  TIM_Config (); <br><br>  / * TIM1 clock enable * / <br><br>  RCC_APB2PeriphClockCmd (RCC_APB2Periph_TIM1, ENABLE); <br><br>  / * Time Base configuration * / <br><br>  TIM_TimeBaseStructure.TIM_Prescaler = (uint16_t) ((SystemCoreClock / 100000)); <br><br>  TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up; <br><br>  TIM_TimeBaseStructure.TIM_Period = (1000); <br><br>  TIM_TimeBaseStructure.TIM_ClockDivision = 0; <br><br>  TIM_TimeBaseStructure.TIM_RepetitionCounter = 0; <br><br>  TIM_TimeBaseInit (TIM1, &amp; TIM_TimeBaseStructure); <br><br>  / * Channel 1, 2,3 Configuration in PWM mode * / <br><br>  TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; <br><br>  TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable; <br><br>  TIM_OCInitStructure.TIM_OutputNState = TIM_OutputNState_Disable; <br><br>  TIM_OCInitStructure.TIM_Pulse = Channel1Pulse; <br><br>  TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High; <br><br>  TIM_OCInitStructure.TIM_OCNPolarity = TIM_OCNPolarity_High; <br><br>  TIM_OCInitStructure.TIM_OCIdleState = TIM_OCIdleState_Set; <br><br>  TIM_OCInitStructure.TIM_OCNIdleState = TIM_OCIdleState_Reset; <br><br>  TIM_OC1Init (TIM1, &amp; TIM_OCInitStructure); <br><br>  TIM_OCInitStructure.TIM_Pulse = Channel2Pulse; <br><br>  TIM_OC2Init (TIM1, &amp; TIM_OCInitStructure); <br><br>  TIM_OCInitStructure.TIM_Pulse = Channel3Pulse; <br><br>  TIM_OC3Init (TIM1, &amp; TIM_OCInitStructure); <br><br>  / * TIM1 counter enable * / <br><br>  TIM_Cmd (TIM1, ENABLE); <br><br>  / * TIM1 Main Output Enable * / <br><br>  TIM_CtrlPWMOutputs (TIM1, ENABLE); <br><br>  } <br><br></div></div><br><br>  To change the speed, one had only to write: <br><br><blockquote>  TIM_OCInitStructure.TIM_Pulse = n; <br>  TIM_OC1Init (TIM1, &amp; TIM_OCInitStructure); <br></blockquote><br><br>  The first paragraph was completely decided by examples from the manufacturer.  Yes, I could remove the data, but without processing it was difficult to do something with them. <br><br><img src="https://habrastorage.org/storage2/f50/8c5/7c2/f508c57c2ba63ac998ed169c5965e4b2.jpg"><br><br><img src="https://habrastorage.org/storage2/575/778/d38/575778d386198c12d08b518c027ff14f.jpg"><br><br>  Graphs display accelerometer readings without filters.  At first there is a roll, then a pitch, then at the same time both a roll and a pitch. <br><br>  Therefore, it was already more difficult with the second one, if the source codes of the position correction for one sensor were still present in the network, so that the correction took into account all three sensors, it was necessary to search.  After several days of reading Wikipedia ( <a href="http://en.wikipedia.org/wiki/Attitude_and_heading_reference_system">AHRS</a> , <a href="http://en.wikipedia.org/wiki/Inertial_measurement_unit">IMU</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B2%25D0%25B0%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B8%25D0%25BE%25D0%25BD">Quaternion</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25B3%25D0%25BB%25D1%258B_%25D0%25AD%25D0%25B9%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0">Euler Angles</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D0%259A%25D0%25B0%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">Kalman Filter</a> ), googling and viewing sources, reading articles and forums, Rudolf Emil Kalman himself appeared to me in a dream and dictated a link to a <a href="http://www.x-io.co.uk/">British company</a> that dealt in general with same as me.  It was from them that I looked at the open library for processing data from sensors.  There they also have a small description and method of application.  From it I took the formulas for calculating from quaternion heel, pitch and yaw. <br><br><blockquote>  float getPitch () <br>  { <br>  return atan2 (2 * (q2 * q3 + q0 * q1), q0 * q0 - q1 * q1 - q2 * q2 + q3 * q3); <br>  } <br><br>  float getYaw () <br>  { <br>  return asin (-2 * (q1 * q3 - q0 * q2)); <br>  } <br><br>  float getRoll () <br>  { <br>  return atan2 (2 * (q1 * q2 + q0 * q3), q0 * q0 + q1 * q1 - q2 * q2 - q3 * q3); <br>  } <br></blockquote><br><br>  When the SVP enters the course adjustment mode, the current position is taken as the starting point: <br><br><blockquote>  nullkorr = getRoll () * DegToRadIMU; </blockquote><br><br>  Further, the current position is determined in the same way and the angle between the point of reference and the current position is calculated. <br><br><blockquote>  float retangle (float a, float b) <br>  { <br>  a + = 180; <br>  b + = 180; <br>  int r1 = 0; <br>  r1 = ab; <br>  r1 = r1% 360; <br>  if (r1 &lt;0) r1 + = 360; <br>  if (r1&gt; 180) return - (360 - r1); <br>  else return r1; <br>  } <br></blockquote><br><br>  After calculating the angle, the data is transmitted to the servo where the correction angle is subtracted from the current angle of rotation. <br><br>  There were no problems with the third point, it is easy to find examples of working with the UART or with the HC-04. <br>  On the fourth point, there were some troubles, the ultrasonic sensor arrived simultaneously with the humidity sensor and I was in search of a new development environment.  Yes, and sensor testing has destroyed my pink dreams that it hits a straight, narrow beam and is reflected back, regardless of the material and the angle of rotation of the surface.  In order not to load MK with unnecessary tasks, communication with the sensor is organized on interrupts.  An example is taken from this good <a href="https://github.com/andythekid">person</a> in this <a href="">place</a> .  The code had to be altered a little as in STM32f3 the timers were slightly changed. <br><br><div class="spoiler">  <b class="spoiler_title">Modified version</b> <div class="spoiler_text"><br><br>  / ** <br><br>  ** =============================================== =========================== <br><br>  ** <br><br>  ** Abstract: Ultrasonic sensor interrupt handler <br><br>  ** <br><br>  ** =============================================== =========================== <br><br>  * / <br><br>  void EXTI3_IRQHandler (void) <br><br>  { <br><br>  // If you catch a rising front <br><br>  if (! catcher_status) <br><br>  { <br><br>  // Start counting the pulse duration <br><br>  TIM6-&gt; CR1 | = TIM_CR1_CEN; <br><br>  // Switch to catching the falling edge <br><br>  catcher_status = 1; <br><br>  EXTI-&gt; RTSR &amp; = ~ EXTI_RTSR_TR3; <br><br>  EXTI-&gt; FTSR | = EXTI_FTSR_TR3; <br><br>  } <br><br>  // If a falling front is caught <br><br>  else <br><br>  { <br><br>  TIM6-&gt; CR1 &amp; = ~ TIM_CR1_CEN;  // Stop The Timer <br><br>  if (TIM6-&gt; CNT&gt; 58) <br><br>  { <br><br>  duration = TIM6-&gt; CNT;  // Read the duration value in ms <br><br>  if (duration &lt;5800 &amp;&amp; korr &lt;25 &amp;&amp; korr&gt; -25 &amp;&amp; stepmode == 5) <br><br>  { <br><br>  m1 = 0; <br><br>  upper_ctrl (m1);  // motor off <br><br>  bbf = 0; <br><br>  stepmode = 1; <br><br>  } <br><br>  smas [scnum] = TIM6-&gt; CNT; <br><br>  } <br><br>  TIM6-&gt; CNT = 0;  // Reset the register counter <br><br>  // Switch to catching the rising edge <br><br>  catcher_status = 0; <br><br>  EXTI-&gt; FTSR &amp; = ~ EXTI_FTSR_TR3; <br><br>  EXTI-&gt; RTSR | = EXTI_RTSR_TR3; <br><br>  // Run timer 6 on the countdown 50 ms <br><br>  TIM6-&gt; DIER | = TIM_DIER_UIE;  // Enable timer interrupt <br><br>  TIM6-&gt; CR1 | = TIM_CR1_CEN;  // Start the timer <br><br>  } <br><br>  EXTI-&gt; PR | = 0x01;  // clear the flag <br><br>  } <br><br>  / ** <br><br>  ** =============================================== =========================== <br><br>  ** <br><br>  ** Abstract: Ultrasonic sensor interrupt handler <br><br>  ** TIM7 interrupt handler <br><br>  ** Called after timer 7 counts out 10 ¬µs for a signal pulse <br><br>  ** =============================================== =========================== <br><br>  * / <br><br>  void TIM7_IRQHandler (void) <br><br>  { <br><br>  TIM7-&gt; SR &amp; = ~ TIM_SR_UIF;  // reset the UIF flag <br><br>  GPIOD-&gt; ODR &amp; = ~ GPIO_Pin_2;  // Stop the signal pulse <br><br>  TIM7-&gt; DIER &amp; = ~ TIM_DIER_UIE;  // Forbid interrupt from timer 7 <br><br>  } <br><br>  / ** <br><br>  ** =============================================== =========================== <br><br>  ** <br><br>  ** Abstract: Ultrasonic sensor interrupt handler <br><br>  ** TIM6_DAC interrupt handler <br><br>  ** Called after timer 6 counts 50 ¬µs for the cycle period <br><br>  ** =============================================== =========================== <br><br>  * / <br><br>  void TIM6_DAC_IRQHandler (void) <br><br>  { <br><br>  TIM6-&gt; SR &amp; = ~ TIM_SR_UIF;  // reset the UIF flag <br><br>  if (scaning == 2) <br><br>  { <br><br>  if (smas [scnum]&gt; 800) <br><br>  { <br><br>  scnum ++; <br><br>  US_servo_ctrl (scnum); <br><br>  if (scnum&gt; = 160) <br><br>  { <br><br>  scnum = 0; <br><br>  scaning = 3; <br><br>  US_servo_ctrl (80); <br><br>  } <br><br>  } <br><br>  else <br><br>  { <br><br>  scd ++; <br><br>  if (scd&gt; 3) <br><br>  { <br><br>  scd = 0; <br><br>  smas [scnum] = 23200; <br><br>  scnum ++; <br><br>  US_servo_ctrl (scnum); <br><br>  } <br><br>  } <br><br>  } <br><br>  GPIOD-&gt; ODR | = GPIO_Pin_2;  // Turn on the signal pulse <br><br>  // Run timer 7 on the countdown 10 ms <br><br>  TIM7-&gt; DIER | = TIM_DIER_UIE;  // Enable interrupt from timer 7 <br><br>  TIM7-&gt; CR1 | = TIM_CR1_CEN;  // Start the timer <br><br>  } <br><br>  void USsensor_init () <br><br>  { <br><br>  // =============================================== ======================== <br><br>  // Set Timer 6 <br><br>  // Used for 2 purposes: <br><br>  // 1) Calculation of the Echo pulse duration (150 ¬µs - 25 ms) <br><br>  // 2) Calculation with interruption for the report of the cycle period - time, <br><br>  // required for attenuation of residual oscillations in the Echo line <br><br>  // =============================================== ======================== <br><br>  // Enable timer clocking <br><br>  RCC_APB1PeriphClockCmd (RCC_APB1Periph_TIM6, ENABLE); <br><br>  // Set the prescaler to trigger once per ms <br><br>  TIM6-&gt; PSC = 72 - 1; <br><br>  // Operation limit - 50 ms = 50 000 Œºs <br><br>  TIM6-&gt; ARR = 50000; <br><br>  // Enable TIM6_IRQn interrupt - necessary for counting the cycle period <br><br>  NVIC_SetPriority (TIM6_DAC_IRQn, 3); <br><br>  NVIC_EnableIRQ (TIM6_DAC_IRQn); <br><br>  // =============================================== ======================== <br><br>  // Set Timer 7 <br><br>  // =============================================== ======================== <br><br>  // Enable timer clocking <br><br>  RCC_APB1PeriphClockCmd (RCC_APB1Periph_TIM7, ENABLE); <br><br>  // Set the prescaler to trigger once per ms <br><br>  TIM7-&gt; PSC = 72 - 1; <br><br>  // Tripping limit - 10 Œºs <br><br>  TIM7-&gt; ARR = 10; <br><br>  // Enable interrupt TIM7_IRQn - necessary for the signal pulse counting <br><br>  NVIC_SetPriority (TIM7_IRQn, 2); <br><br>  NVIC_EnableIRQ (TIM7_IRQn); <br><br>  // =============================================== ======================== <br><br>  EXTI_InitTypeDef EXTI_InitStructure; <br><br>  GPIO_InitTypeDef GPIO_InitStructure; <br><br>  NVIC_InitTypeDef NVIC_InitStructure; <br><br>  RCC_APB2PeriphClockCmd (RCC_APB2Periph_SYSCFG, ENABLE); <br><br>  RCC_AHBPeriphClockCmd (RCC_AHBPeriph_GPIOD, ENABLE); <br><br>  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT; <br><br>  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP; <br><br>  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_DOWN; <br><br>  GPIO_InitStructure.GPIO_Speed ‚Äã‚Äã= GPIO_Speed_2MHz; <br><br>  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2; <br><br>  GPIO_Init (GPIOD, &amp; GPIO_InitStructure); <br><br>  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN; <br><br>  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP; <br><br>  GPIO_InitStructure.GPIO_Speed ‚Äã‚Äã= GPIO_Speed_2MHz; <br><br>  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3; <br><br>  GPIO_Init (GPIOD, &amp; GPIO_InitStructure); <br><br>  SYSCFG_EXTILineConfig (EXTI_PortSourceGPIOD, EXTI_PinSource3); <br><br>  / * Configure EXTI3 line * / <br><br>  EXTI_InitStructure.EXTI_Line = EXTI_Line3; <br><br>  EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt; <br><br>  EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising; <br><br>  EXTI_InitStructure.EXTI_LineCmd = ENABLE; <br><br>  EXTI_Init (&amp; EXTI_InitStructure); <br><br>  NVIC_InitStructure.NVIC_IRQChannel = EXTI3_IRQn; <br><br>  NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0x0F; <br><br>  NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0x0F; <br><br>  NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; <br><br>  NVIC_Init (&amp; NVIC_InitStructure); <br><br>  } <br><br></div></div><br><br>  This code uses an interrupt on PORTD.3, or rather it should be on PORTD, I have not figured out why the interrupt is triggered on all ports on the third pin.  The use of interrupts is taken from an example from the manufacturer, an attempt was made to write directly to the interrupt settings registers, the result is ‚Äú0‚Äù or there is no interruption, or it exists on all ports. <br>  If someone explains where the error will be very grateful. <br><br>  The fifth point was quickly passed, but the ADC setting in the sixth caused some headache. <br>  Again, examples, no complaints, the example works fine.  Only in the example did they consider reading from one ADC channel, and I have four.  In datasheet signs on channels, regular groups, entered groups.  Due to limited time, the old ‚Äúold-fashioned‚Äù method was chosen: <br>  -Change channel; <br>  - Start of one-time reading; <br>  -Process processing; <br>  -Repeat. <br><br><div class="spoiler">  <b class="spoiler_title">Read ADC</b> <div class="spoiler_text"><br>  void ADC1_2_IRQHandler (void) <br><br>  { <br><br>  ADC_ClearITPendingBit (ADC1, ADC_IT_EOC); <br><br>  ADC1ConvertedValue = ADC_GetConversionValue (ADC1); <br><br>  / * Compute the voltage * / <br><br>  ADC1ConvertedVoltage = (ADC1ConvertedValue * 3300) / 0xFFF; <br><br>  adcp [iadc] = ADC1ConvertedVoltage; <br><br>  iadc ++; <br><br>  ADCready = 1; <br><br>  } <br><br>  void SetADCchannel () <br><br>  { <br><br>  / * Configure ADC channel * / <br><br>  numadc [0] = 7;  // BT <br><br>  numadc [1] = 16;  // Termometer <br><br>  numadc [2] = 6;  // Battery voltage <br><br>  numadc [3] = 3;  // Gas sensor <br><br>  kadc = 4;  // amount channels <br><br>  } <br><br>  void getADC (uint8_t channel) <br><br>  { <br><br>  if (ADCready == 1) <br><br>  { <br><br>  ADCready = 0; <br><br>  ADC_RegularChannelConfig (ADC1, channel, 1, ADC_SampleTime); <br><br>  ADC_StartConversion (ADC1); <br><br>  } <br><br>  } <br><br>  uint8_t ADC_init () <br><br>  { <br><br>  uint16_t calibration_value = 0; <br><br>  ADC_InitTypeDef ADC_InitStructure; <br><br>  ADC_CommonInitTypeDef ADC_CommonInitStructure; <br><br>  GPIO_InitTypeDef GPIO_InitStructure; <br><br>  / * Configure the ADC clock * / <br><br>  RCC_ADCCLKConfig (RCC_ADC12PLLCLK_Div2); <br><br>  / * Enable ADC1 clock * / <br><br>  RCC_AHBPeriphClockCmd (RCC_AHBPeriph_ADC12, ENABLE); <br><br>  / * ADC Channel configuration * / <br><br>  / * GPIOC Periph clock enable * / <br><br>  RCC_AHBPeriphClockCmd (RCC_AHBPeriph_GPIOC, ENABLE); <br><br>  RCC_AHBPeriphClockCmd (RCC_AHBPeriph_GPIOA, ENABLE); <br><br>  / * Configure ADC Channel7 as analog input * / <br><br>  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2 | GPIO_Pin_3; <br><br>  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AN; <br><br>  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL; <br><br>  GPIO_Init (GPIOC, &amp; GPIO_InitStructure); <br><br>  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2; <br><br>  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AN; <br><br>  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL; <br><br>  GPIO_Init (GPIOA, &amp; GPIO_InitStructure); <br><br>  ADC_StructInit (&amp; ADC_InitStructure); <br><br>  / * Calibration procedure * / <br><br>  ADC_VoltageRegulatorCmd (ADC1, ENABLE); <br><br>  / * Insert delay equal to * / <br><br>  Delay (15); <br><br>  ADC_SelectCalibrationMode (ADC1, ADC_CalibrationMode_Single); <br><br>  ADC_StartCalibration (ADC1); <br><br>  while (ADC_GetCalibrationStatus (ADC1)! = RESET); <br><br>  calibration_value = ADC_GetCalibrationValue (ADC1); <br><br>  ADC_CommonInitStructure.ADC_Mode = ADC_Mode_Independent; <br><br>  ADC_CommonInitStructure.ADC_Clock = ADC_Clock_AsynClkMode; <br><br>  ADC_CommonInitStructure.ADC_DMAAccessMode = ADC_DMAAccessMode_Disabled; <br><br>  ADC_CommonInitStructure.ADC_DMAMode = ADC_DMAMode_OneShot; <br><br>  ADC_CommonInitStructure.ADC_TwoSamplingDelay = 1000; <br><br>  ADC_CommonInit (ADC1, &amp; ADC_CommonInitStructure); <br><br>  ADC_InitStructure.ADC_ContinuousConvMode = ADC_ContinuousConvMode_Disable; <br><br>  ADC_InitStructure.ADC_Resolution = ADC_Resolution_12b; <br><br>  ADC_InitStructure.ADC_ExternalTrigConvEvent = ADC_ExternalTrigConvEvent_0; <br><br>  ADC_InitStructure.ADC_ExternalTrigEventEdge = ADC_ExternalTrigEventEdge_None; <br><br>  ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right; <br><br>  ADC_InitStructure.ADC_OverrunMode = ADC_OverrunMode_Disable; <br><br>  ADC_InitStructure.ADC_AutoInjMode = ADC_AutoInjec_Disable; <br><br>  ADC_InitStructure.ADC_NbrOfRegChannel = 1; <br><br>  ADC_Init (ADC1, &amp; ADC_InitStructure); <br><br>  ADC_RegularChannelSequencerLengthConfig (ADC1,1); <br><br>  / * ADC1 regular channel7 configuration * / <br><br>  ADC_RegularChannelConfig (ADC1, ADC_Channel_7, 1, ADC_SampleTime); <br><br>  ADC_TempSensorCmd (ADC1, ENABLE); <br><br>  / * Enable ADC1 * / <br><br>  ADC_Cmd (ADC1, ENABLE); <br><br>  / * wait for ADRDY * / <br><br>  while (! ADC_GetFlagStatus (ADC1, ADC_FLAG_RDY)); <br><br>  NVIC_InitTypeDef NVIC_InitStructure; <br><br>  NVIC_InitStructure.NVIC_IRQChannel = ADC1_2_IRQn; <br><br>  NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1; <br><br>  NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1; <br><br>  NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; <br><br>  NVIC_Init (&amp; NVIC_InitStructure); <br><br>  ADC_ITConfig (ADC1, ADC_IT_EOC, ENABLE); <br><br>  return 1; <br><br>  } <br><br>  / * and somewhere in main post <br><br>  if (iadc &lt;kadc) <br><br>  { <br><br>  getADC (numadc [iadc]); <br><br>  } <br><br>  else <br><br>  { <br><br>  iadc = 0; <br><br>  } <br><br>  * / <br><br></div></div><br><br>  After I figured out the ADC, the seventh item did not cause any problems. <br><br>  Application for android special difficulties and losses from the nerve cells did not cause (not counting departures from changing the button location) examples for working with bluetooth on the network abound, and a slightly modified class from this <a href="http://habrahabr.ru/post/111405/">article</a> added the ability to control the speed and direction of the vessel by moving the thumb up / down and left / right across the screen. <br><br><div class="spoiler">  <b class="spoiler_title">Class someview</b> <div class="spoiler_text"><br><br>  public class SomeView extends View { <br><br>  Paint paint; <br><br>  int [] X; <br><br>  int [] Y; <br><br>  final static int Radius = 50; <br><br>  int PointerCount; <br><br>  public SomeView (Context context, AttributeSet attrs) <br><br>  { <br><br>  super (context, attrs); <br><br>  paint = new Paint (); <br><br>  paint.setColor (Color.RED); <br><br>  paint.setStyle (Style.STROKE); <br><br>  paint.setStrokeWidth (3); <br><br>  PointerCount = 0; <br><br>  X = new int [10]; // These will be arrays of coordinates (we will perceive up to 10 fingers) <br><br>  Y = new int [10]; <br><br>  } <br><br>  public boolean onTouchEvent (MotionEvent event) <br><br>  { <br><br>  StringBuilder result = new StringBuilder (300); <br><br>  PointerCount = event.getPointerCount (); <br><br>  for (int i = 0; i &lt;PointerCount; i ++) <br><br>  { <br><br>  int ptrId = event.getPointerId (i); <br><br>  X [i] = (int) event.getX (i); // Remember the coordinates <br><br>  Y [i] = (int) event.getY (i); <br><br>  MainActivity.flag = 1; <br><br>  MainActivity.setX (X [i], Y [i], ptrId); <br><br>  } <br><br>  return true; <br><br>  } <br><br>  protected void onDraw (Canvas canvas) <br><br>  { <br><br>  for (int i = 0; i &lt;PointerCount; i ++) <br><br>  { <br><br>  if (Y [i] &lt;(MainActivity.height / 4)) Y [i] = MainActivity.height / 4; <br><br>  if (Y [i]&gt; (MainActivity.height * 0.75) -75) Y [i] = (int) (MainActivity.height * 0.75) -75; <br><br>  canvas.drawCircle (X [i], Y [i], Radius, paint); <br><br>  canvas.drawLine (MainActivity.width / 2, (int) (MainActivity.height * 0.75) -25, X [i], Y [i], paint); <br><br>  canvas.drawLine (0, (int) (MainActivity.height / 4) -50, MainActivity.width, (int) (MainActivity.height / 4) -50, paint); <br><br>  canvas.drawLine (0, (int) (MainActivity.height * 0.75) -25, MainActivity.width, (int) (MainActivity.height * 0.75) -25, paint); <br><br>  } <br><br>  invalidate (); <br><br>  } <br><br>  } <br><br></div></div><br><br>  And to display information about the sensors, DialogFragment was used: <br><br><div class="spoiler">  <b class="spoiler_title">Dialog class</b> <div class="spoiler_text"><br><br>  public class dialog extends DialogFragment implements OnClickListener { <br><br>  final String LOG_TAG = "myLogs"; <br><br>  android.widget.TextView datch; <br><br>  public View onCreateView (LayoutInflater inflater, ViewGroup container, <br><br>  Bundle savedInstanceState) { <br><br>  getDialog (). setTitle ("Sensor Readings"); <br><br>  View v = inflater.inflate (R.layout.dialog, null); <br><br>  v.findViewById (R.id.btnYes) .setOnClickListener (this); <br><br>  datch = (android.widget.TextView) v.findViewById (R.id.textView1); <br><br>  datch.setText (MainActivity.mesdat); <br><br>  return v; <br><br>  } <br><br>  public void onClick (View v) { <br><br>  Log.d (LOG_TAG, ‚ÄúDialog:‚Äù + ((Button) v) .getText ()); <br><br>  dismiss (); <br><br>  } <br><br>  public void onDismiss (DialogInterface dialog) { <br><br>  super.onDismiss (dialog); <br><br>  Log.d (LOG_TAG, "Dialog: onDismiss"); <br><br>  } <br><br>  public void onCancel (DialogInterface dialog) { <br><br>  super.onCancel (dialog); <br><br>  Log.d (LOG_TAG, "Dialog: onCancel"); <br><br>  } <br><br>  } <br><br></div></div><br><br><h1>  Afterword </h1><br><br>  I know that the creation process has covered only in general terms, but if there are questions, I will definitely try to answer them.  The management program is far from ideal, there is still a lot to consider.  For example, with a sharp turn, the inertia of the vessel makes it ‚Äúwag its tail‚Äù another seven meters.  But we will continue and improve our work. </div><p>Source: <a href="https://habr.com/ru/post/178597/">https://habr.com/ru/post/178597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178581/index.html">Paravirtualization in Xen: no bootloader anywhere</a></li>
<li><a href="../178583/index.html">Google maps engine</a></li>
<li><a href="../178585/index.html">The court acquitted the noble cybersquatter</a></li>
<li><a href="../178587/index.html">Useful projects for xna developers</a></li>
<li><a href="../178593/index.html">Create dynamic websites using PHP, MySQL, JavaScript and CSS. 2nd ed</a></li>
<li><a href="../178599/index.html">OpenGL ES 2.0 wrapper for Qt</a></li>
<li><a href="../178601/index.html">The Russian Indie Bundle # 1 launched</a></li>
<li><a href="../178603/index.html">Mozilla protests against spyware under the guise of Firefox</a></li>
<li><a href="../178605/index.html">The coolest and most terrifying bionic robots</a></li>
<li><a href="../178607/index.html">ProDesk3D: the world's first desktop color 3D printer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>