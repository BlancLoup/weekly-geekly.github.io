<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Alljoyn: embedded view of the developer. Part 2: Linux to help us</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The previous part of the Alljoyn cycle : embedded view of the developer. Part 1: Introduction 

 We continue the story of how to get a "real piece of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Alljoyn: embedded view of the developer. Part 2: Linux to help us</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/323/750/9d9/3237509d9db646069b2bbe979908be40.png"><br><br>  The previous part of the <a href="https://habrahabr.ru/company/rainbow/blog/273859/">Alljoyn</a> cycle <a href="https://habrahabr.ru/company/rainbow/blog/273859/">: embedded view of the developer.</a>  <a href="https://habrahabr.ru/company/rainbow/blog/273859/">Part 1: Introduction</a> <br><br>  We continue the story of how to get a "real piece of iron", working on the protocol AllJoyn.  The ultimate goal of the cycle is to get a prototype of the ‚Äúsmart Wi-Fi light bulb‚Äù.  And it is precisely the ‚Äúprototype‚Äù, because we will not touch upon the implementation of the power section of our light bulb, since this is a separate major topic that has nothing to do with frameworks and control methods.  Therefore, we restrict ourselves to the LED on the SAMD21-XPRO debug board. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before we start porting the framework to the microcontroller, we will deal with tools that will provide us with invaluable assistance in the development process.  In principle, AllJoyn is a cross-platform framework and you are free to use the operating system option that is convenient for you.  I used Linux (Ubuntu) - simply because it is more familiar to me. <a name="habracut"></a><br><br><h4>  We download source codes, we compile, we try </h4><br>  To do this, follow the instructions in paragraph 4.1 of the <a href="https://wiki.allseenalliance.org/_media/tsc/lighting/getting_started_alljoyn_lighting_service_framework_15.04_lamp_service.pdf">instructions</a> from the official site.  True, this instruction suggests using Git to download source files, but with this method the framework refused to compile (the situation could have changed since then), so I downloaded the <a href="https://allseenalliance.org/framework/download">source</a> files one folder from the official site and laid them out in accordance with the required structure.  I put the sources in my home folder in the alljoyn / lsf directory. <br>  You need to get the following file structure: <br> <code>~/alljoyn/lsf <br> |------ core <br> | |------ service_framework ( Lighting Service Framework Source) <br> | |------ ajtcl ( Thin Core Source) <br> | |------ alljoyn ( Standard Core Source) <br> |------ base_tcl <br> |------ base ( Base Services Source) <br></code> <br>  To compile, we will need additional programs.  We put them: <br><pre> <code class="bash hljs">sudo apt-get install build-essential libgtk2.0-dev libssl-dev xsltproc ia32-libs libxml2-dev sudo apt-get install python sudo apt-get install scons sudo apt-get install libssl-dev</code> </pre><br>  Go to the service_framework folder and build the project: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/alljoyn/lsf/core/service_framework scons WS=off</code> </pre><br>  I am not a great Linux expert, but in the process of working with him I had the persistent feeling that there are no two identical solutions of the same task on different computers and there are always some nuances in each specific case.  Personally, I had a long trip to the torment before everything was successfully gathered, but I don‚Äôt see much point in describing my adventures in this article.  So go ahead and in the end you will see the following: <br><pre> <code class="bash hljs">scons: Reading SConscript files ... BULLSEYE_BIN not specified Using OpenSSL crypto GTEST_DIR not specified skipping common unit <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> build BULLSEYE_BIN not specified GTEST_DIR not specified skipping About Service unit <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> build GTEST_DIR not specified skipping alljoyn_core unit <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> build GTEST_DIR not specified skipping LSF unit <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> build scons: <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> reading SConscript files. scons: Building targets ... ... scons: <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> building targets.</code> </pre><br>  As a result, there will be compiled a lot of things.  We will need 3 programs: <br><ol><li>  <b>lamp_service</b> is an imitator of a ‚Äúsmart bulb‚Äù (hereinafter, I will often call this program a ‚Äúbulb‚Äù).  Use Thin (lightweight) version of the framework.  It is this program that we will port to the Atmel SAMD21 microcontroller in the third part of the cycle.  Also, this program is the basis of the Android application Luminaire.  Located in the ~ / alljoyn / lsf / core / service_framework / build / linux / thin_core_library / lamp_service / bin folder </li><li>  <b>lighting_controller_service</b> is the Router for our Thin device (read the theoretical part in the first part).  Lies in the folder ~ / alljoyn / lsf / core / service_framework / build / linux / standard_core_library / lighting_controller_service / bin </li><li>  <b>lighting_controller_client_sample</b> is the ‚Äúcontrol panel‚Äù with which we will control our light bulb.  This program is the basis of the Android application LSF, which was mentioned in the last article.  Located in the ~ / alljoyn / lsf / core / service_framework / build / linux / standard_core_library / lighting_controller_client / samples folder </li></ol><br>  Thus, we can now present the ‚Äúabstruse‚Äù pictures from the previous article in a more substantive form: <br><img src="https://habrastorage.org/files/786/a98/eca/786a98eca1d44d22adb1c6299604d5e8.png"><br><br>  Now turn on WireShark, run lamp_service and see what happens: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/alljoyn/lsf/core/service_framework/build/linux/thin_core_library/lamp_service/bin ./lamp_service</code> </pre><br>  In order not to drown in the stream of network traffic, we add a filter to WireShark <b>udp.port == 5353 ||</b>  <b>udp.port == 9956</b> <br><img src="https://habrastorage.org/files/16d/7a7/bc4/16d7a7bc41b946a386f2b8880a9bf9ea.png"><br>  We see that the bulb sends its presentation data to the network in search of the Router, using all three methods available to it (multicast 224.0.0.113:9956, multicast 224.0.0.251.153535, broadcast: 9956).  In this case, these attempts are futile, as there is no Router on the network.  The light bulb periodically sends these packets to the network, after which it ‚Äúpauses‚Äù for a while (up to 40 seconds). <br><br>  Consider for interest the contents of one of the packages.  We will look at the broadcast AllJoyn package.  Although it is an outdated format (as discussed in the first article), it looks less cumbersome compared to MDNS and therefore easier to understand.  MDNS uses a similar principle. <br><img src="https://habrastorage.org/files/843/d78/050/843d7805033a49e3b5a7abc0641105ce.png"><br>  The bus identifier may or may not be used by the Router to decide whether the Router will be ‚Äúfriends‚Äù with our device.  Who is he to be friends with when the developer writes the Router code.  The IP address and port are used to indicate the TCP connection data to Router.  In our case, we see that the light bulb lifted a TCP server on port 9955. <br><br><h4>  Add Router </h4><br>  In principle, it does not matter whether Router is physically on the same device as lamp_service or on different ones.  But if you run lighting_controller_service (this is a specialized Router for our case) on the same computer, they will connect inside the machine, so the exchange will not work through a network card and WireShark will not fix it.  To visualize the exchange, run lighting_controller_service on another computer. <br><img src="https://habrastorage.org/files/847/ced/8f2/847ced8f20ce49d18c6220c18f12eb73.PNG"><br><br>  As we see this time, the ‚Äúcries of the light bulb‚Äù did not go unheard, and Router, after having previously ‚Äúheard‚Äù the light bulb via UDP, connected to it via TCP and produced a rather lengthy process of exchanging more detailed information.  In principle, to successfully use the framework, it is not at all necessary to understand the intricacies of this exchange, since it lies on the shoulders of the alliance developers and is delivered in finished form.  But if you look closely, you can see the use of DBus of a similar protocol with all sorts of BusHello, Introspect, etc. Looking ahead, I‚Äôll note that later in the exchange process, if you wish, you can use all sorts of authentication methods, encryption, etc.  As a result, AllJoyn resembles a sort of Frankenstein, consisting of parts of different protocols and technologies.  But this is the lyrics, I repeat, in theory, diving too deeply is not required (although this fate did not pass us, as in the process of work we had to pretty much walk around the rake). <br><div class="spoiler">  <b class="spoiler_title">About AllJoyn and WireShark</b> <div class="spoiler_text">  Windows WireShark understands Alljoyn and knows how to parse it beautifully, breaking it up into separate fields - an invaluable help with debugging.  Unfortunately, in Ubuntu WireShark does not know this protocol, which upsets.  Since I have Ubuntu installed on a virtual machine under Windows, I made a forwarding of the Linux network card to the external network (this allows VMWare Workstantion).  As a result, I have WireShark in Windows, I see the whole Linux exchange.  That is why in this article, some of the screenshots are made in Ubuntu, and some in Windows. <br>  For AllJoyn, you can configure two filters: <br>  <b>ajns</b> - AllJoyn Name Service is the already-mentioned, outdated format of broadcasting over UDP via port 9956, with which AllJoyn devices find each other on the network. <br>  <b>aj</b> - AllJoyn is an exchange protocol implemented over TCP.  Parsed packages are visible in the previous picture. <br></div></div><br>  After the light bulb has ‚Äúmade friends‚Äù with Router via TCP, it (the light bulb) stops ‚Äúmaking noise‚Äù via UDP.  Now Router does it for it, offering its services to control panels.  The process occurs in general similarly - Router multicast and / or brodkastovo notifies the local network of the existence of a light bulb (or light bulbs).  If the control panel is interested, it connects via TCP.  And here is an important difference: Router does not cease to ‚Äúmake noise‚Äù via UDP so that other panels can join in if necessary. <br>  Actually, now it becomes clear such an intricate organization of exchange.  Router is a program on ‚Äúserious‚Äù hardware, with a normal implementation of the TCP / IP stack and supporting a large number of simultaneous connections.  While the requirements for the light bulb are reduced - all that is required from the microcontroller and the stack is the ability to support one UDP socket and one TCP connection. <br><br>  We present the above in the form of a comic book: <br><img src="https://habrastorage.org/files/234/302/4db/2343024db70140ff97d7967e3990b7b6.png"><br><br><h4>  Connect the "control panel" </h4><br>  The last exercise for today is to see the 4th stage in the picture above in action.  To do this, run our control panel.  We use for this a separate instance of the terminal.  Again, it does not matter on which physical device our panel will be launched: <br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/alljoyn/lsf/core/service_framework/build/linux/standard_core_library/lighting_controller_client/samples $ ./lighting_controller_client_sample</code> </pre><br>  As a result, if done correctly, the panel should detect our light bulb: <br><img src="https://habrastorage.org/files/8db/a87/ebd/8dba87ebd31340e8b7b770b970bfca5c.png"><br>  Immediately we see the 32-bit unique identifier of the light bulb, which was broadcast over UDP.  Unfortunately, when preparing this article, different instances of lamp_service were launched, so the values ‚Äã‚Äãof this identifier on the screenshots do not match - just take a word for it that this is it. <br>  In addition to detection, lighting_controller_client_sample allows you to perform a lot of manipulation with a light bulb (request parameters, set values, etc.).  If you wish, you can play around with it, but I will omit this part so as not to inflate the article to indecent scales.  I will only warn you that the program's interface is far from being friendly ... but this is one of the most insignificant obstacles on the thorny path of the AllJoyn pioneer. <br><br>  On this theoretical, technical and moral training will be considered complete and in the third (probably final) part of the cycle we will begin to implement the ‚Äúsmart light bulb‚Äù in the gland and shooting the result for youtube. <br><br><h4>  Appendix A. Compliance with linux programs and mobile applications </h4><br>  The programs collected and used today clearly echo the mobile Android applications, which were discussed in the <a href="https://habrahabr.ru/company/rainbow/blog/273859/">first article</a> .  Fix this moment: <br>  The <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.qualcomm.luminaire%26hl%3Dru">Luminaire</a> application corresponds to the <b>lamp_service</b> program.  We will port it to the microcontroller in the third part. <br>  The <a href="https://wiki.allseenalliance.org/tsc/connected_lighting">LSF Sample App is</a> compliant with the <b>lighting_controller_client_sample</b> program.  It is used to control our light bulb. <br><br><h4>  Appendix B. Statement of the problem for the third part of the cycle </h4><br>  As a result of our research, we want to get a physical device (debugging with a microcontroller and a Wi-Fi module) that will be detected and controlled from our control panels (a mobile phone with the <b>LSF Sample App</b> installed and a program in <b>lighting_controller_client_sample</b> ).  As the Router, we will use the lighting_controller_service program running on a computer with Linux. <br><br>  Today this is all, I hope it was interesting.  Until new meetings. </div><p>Source: <a href="https://habr.com/ru/post/278845/">https://habr.com/ru/post/278845/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278835/index.html">As web design rolls straight to hell</a></li>
<li><a href="../278837/index.html">Game Gomoku (tic-tac-toe, 5 in a row)</a></li>
<li><a href="../278839/index.html">Gigabit Wi-Fi in Russia</a></li>
<li><a href="../278841/index.html">Database Testing Developer Version</a></li>
<li><a href="../278843/index.html">Installing and configuring GitLab + Redmine collaboration on Debian 8 jessie + Nginx - Part 1</a></li>
<li><a href="../278847/index.html">How can you simplify your life using Telegram-bot</a></li>
<li><a href="../278849/index.html">How Cloud@mail.ru saved all * my files and what came of it</a></li>
<li><a href="../278853/index.html">Obstacle Chase</a></li>
<li><a href="../278855/index.html">Do not miss the details about the new SQL Server 2016 and Linux support, see the online event on March 10 at 18:00 (MCK)</a></li>
<li><a href="../278857/index.html">Microsoft fixed another Stuxnet-like vulnerability in Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>