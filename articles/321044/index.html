<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I parsed docx using XSLT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The task of processing documents in docx format, as well as xlsx tables and pptx presentations is very nontrivial. In this article I will tell you how...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I parsed docx using XSLT</h1><div class="post__text post__text-html js-mediator-article"><p>  The task of processing documents in docx format, as well as xlsx tables and pptx presentations is very nontrivial.  In this article I will tell you how to learn to parse, create and process such documents using only XSLT and ZIP archiver. </p><a name="habracut"></a><br><h2 id="zachem">  What for? </h2><br><p>  docx is the most popular document format, so the task to give information to the user in this format can always arise.  One solution to this problem is to use a ready-made library, which may not be suitable for a number of reasons: </p><br><ul><li>  libraries may simply not exist </li><li>  the project does not need another black box </li><li>  library restrictions on platforms, etc. </li><li>  licensing issues </li><li>  work speed </li></ul><br><p>  Therefore, in this article we will use only the most basic tools for working with the docx document. </p><br><h2 id="struktura-docx">  Docx structure </h2><br><p>  First, let's look at what the docx document is.  docx is a zip archive that physically contains 2 types of files: </p><br><ul><li> xml files with <code>xml</code> and <code>rels</code> </li><li>  media files (images, etc.) </li></ul><br><p>  And logically - 3 types of elements: </p><br><ul><li>  Types (Content Types) - a list of media file types (for example, png) found in the document and types of document parts (for example, document, header). </li><li>  Parts (Parts) are separate parts of the document, for our document it is document.xml, this includes both xml documents and media files. </li><li>  Relationships identify parts of a document for links (for example, the link between a section of a document and a footer), and also define external parts (for example, hyperlinks). </li></ul><br><p>  They are described in detail in <a href="http://www.ecma-international.org/publications/standards/Ecma-376.htm">ECMA-376: Office Open XML File Formats</a> , the main part of which is a <a href="">PDF document of</a> 5000 pages, and another 2000 pages of bonus content. </p><br><h2 id="minimalnyy-docx">  Minimum docx </h2><br><p>  <a href="https://github.com/eduard93/docx/releases/download/v1.0.0/minimal.docx">The simplest docx</a> after unpacking is as follows </p><br><p><img src="https://habrastorage.org/files/ce5/f66/840/ce5f66840d3f4df484e083998829618c.PNG" alt="image"></p><br><p>  Let's <a href="https://github.com/eduard93/docx/commit/5313b19d6b14392fee217f66afb11866fe738067">see</a> what it consists of. </p><br><h4 id="content_typesxml">  [Content_Types] .xml </h4><br><p>  It is located at the root of the document and lists the MIME content types of the document: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Types</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/package/2006/content-types"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Default</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Extension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rels"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContentType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/vnd.openxmlformats-package.relationships+xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Default</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Extension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContentType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Override</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PartName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/word/document.xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContentType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Types</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h4 id="_relsrels">  _rels / .rels </h4><br><p>  Main list of document links.  In this case, only one link is defined - matching with the identifier rId1 and the word / document.xml file - the main body of the document. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Relationships</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/package/2006/relationships"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Relationship</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rId1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"word/document.xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Relationships</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h4 id="worddocumentxml">  word / document.xml </h4><br><p>  <a href="http://www.datypic.com/sc/ooxml/e-w_document.html">The main content of the document</a> . </p><br><div class="spoiler">  <b class="spoiler_title">word / document.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:document</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wpc</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:mc</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:o</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:schemas-microsoft-com:office:office"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:r</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:m</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/officeDocument/2006/math"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:v</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:schemas-microsoft-com:vml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wp14</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w10</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:schemas-microsoft-com:office:word"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/wordprocessingml/2006/main"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w14</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2010/wordml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wpg</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2010/wordprocessingGroup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wpi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2010/wordprocessingInk"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wne</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2006/wordml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:wps</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/office/word/2010/wordprocessingShape"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mc:Ignorable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"w14 wp14"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pw:rsidR="005F670F"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:rsidRDefault</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"005F79F5"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span>Test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:bookmarkStart</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_GoBack"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:bookmarkEnd</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:sectPr</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:rsidR</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"005F670F"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pgSz</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:w</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12240"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:h</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"15840"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pgMar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:top</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1440"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:right</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1440"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:bottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1440"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:left</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1440"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:header</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"720"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:footer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"720"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:gutter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:cols</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:space</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"720"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:docGrid</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:linePitch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"360"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:sectPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:document</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Here: </p><br><ul><li>  <code>&lt;w:document&gt;</code> - the document itself </li><li>  <code>&lt;w:body&gt;</code> - document body </li><li>  <code>&lt;w:p&gt;</code> - paragraph </li><li>  <code>&lt;w:r&gt;</code> - run (fragment) of text </li><li>  <code>&lt;w:t&gt;</code> - the text itself </li><li>  <code>&lt;w:sectPr&gt;</code> - page description </li></ul><br><p>  If you open this document in a text editor, you will see a document from one word <code>Test</code> . </p><br><h4 id="word_relsdocumentxmlrels">  word / _rels / document.xml.rels </h4><br><p>  Here is a list of links to the <code>word/document.xml</code> .  The name of the file of links is created from the name of the part of the document to which it belongs and adding to it the extension <code>rels</code> .  The folder with the link file is called <code>_rels</code> and is on the same level as the part to which it belongs.  Since there are no links in <code>word/document.xml</code> this is also empty in the file: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Relationships</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/package/2006/relationships"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Relationships</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Even if there are no links, this file must exist. </p><br><h2 id="docx-i-microsoft-word">  docx and Microsoft Word </h2><br><p>  <a href="https://github.com/eduard93/docx/releases/download/v1.0.0/word.docx">docx</a> created using Microsoft Word, but in principle and using any other editor has a <a href="https://github.com/eduard93/docx/commit/5313b19d6b14392fee217f66afb11866fe738067">few additional files</a> . </p><br><p><img src="https://habrastorage.org/files/585/503/504/58550350424d4977910f9424a4af3104.PNG" alt="image"></p><br><p>  Here is what they contain: </p><br><ul><li>  <code>docProps/core.xml</code> - the main metadata of the document according to the <a href="https://en.wikipedia.org/wiki/Open_Packaging_Conventions">Open Packaging Conventions</a> and Dublin Core <a href="http://dublincore.org/documents/dcmi-terms/">[1]</a> , <a href="http://dublincore.org/documents/dces/">[2]</a> . </li><li>  <code>docProps/app.xml</code> - <a href="http://www.datypic.com/sc/ooxml/e-extended-properties_Properties.html">general information about the document</a> : the number of pages, words, characters, the application name in which the document was created, etc. </li><li>  <code>word/settings.xml</code> - <a href="http://www.datypic.com/sc/ooxml/e-w_settings.html">settings related to the current document</a> . </li><li>  <code>word/styles.xml</code> - <a href="http://www.datypic.com/sc/ooxml/e-w_styles.html">styles</a> applicable to the document.  Separate the data from the presentation. </li><li>  <code>word/webSettings.xml</code> - <a href="http://www.datypic.com/sc/ooxml/e-w_webSettings.html">settings for</a> displaying HTML parts of a document and settings for how to convert a document to HTML. </li><li>  <code>word/fontTable.xml</code> - a <a href="http://www.datypic.com/sc/ooxml/e-w_fonts.html">list of</a> fonts used in the document. </li><li>  <code>word/theme1.xml</code> - <a href="http://www.datypic.com/sc/ooxml/e-a_theme.html">theme</a> (consists of color scheme, fonts and formatting). </li></ul><br><p>  In complex documents parts can be much more. </p><br><h2 id="revers-inzhiniring-docx">  Reverse engineering docx </h2><br><p>  So, the initial task is to find out how any fragment of the document is stored in xml, in order to create (or parse) similar documents on its own.  For this we need: </p><br><ul><li>  Zip archiver </li><li>  Library for formatting XML (Word yields XML without indents, in one line) </li><li>  Means for viewing diff between files, I will use git and TortoiseGit </li></ul><br><h4 id="instrumenty">  Instruments </h4><br><ul><li>  Under Windows: <a href="http://gnuwin32.sourceforge.net/packages/zip.htm">zip</a> , <a href="http://gnuwin32.sourceforge.net/packages/unzip.htm">unzip</a> , <a href="">libxml2</a> , <a href="https://git-scm.com/download/win">git</a> , <a href="https://tortoisegit.org/download/">TortoiseGit</a> </li><li>  Under Linux: <code>apt-get install zip unzip libxml2 libxml2-utils git</code> </li></ul><br><p>  You also need <a href="https://github.com/eduard93/docx/commit/6b41b0e459329d62d0736aa6dc5a7b02e7398dcd">scripts</a> to automatically (once) archive and format XML. <br>  Use under Windows: </p><br><ul><li>  <code>unpack file dir</code> - unpacks the <code>file</code> document in the <code>dir</code> folder and formats the xml </li><li>  <code>pack dir file</code> - <code>pack dir file</code> folder to the <code>file</code> document </li></ul><br><p>  Using under Linux is similar, only <code>./unpack.sh</code> instead of <code>unpack</code> , and <code>pack</code> becomes <code>./pack.sh</code> . </p><br><h4 id="ispolzovanie">  Using </h4><br><p>  The search for changes is as follows: </p><br><ol><li>  Create an empty docx file in the editor. </li><li>  Unpack it using <code>unpack</code> in a new folder. </li><li>  Let's commit a new folder. </li><li>  Add to the file from p. 1. the studied element (hyperlink, table, etc.). </li><li>  Unpack the modified file into an existing folder. </li><li>  We study diff, removing unnecessary changes (permutations of connections, the order of namespaces, etc.). </li><li>  We pack the folder and check that the resulting file opens. </li><li>  Commit the changed folder. </li></ol><br><h4 id="primer-1-vydelenie-teksta-zhirnym">  Example 1. Bold text selection </h4><br><p>  Let‚Äôs see in practice how to find a tag that defines text formatting in bold. </p><br><ol><li>  Create a <code>bold.docx</code> document with plain (non-bold) Test text. </li><li>  Unpack it: <code>unpack bold.docx bold</code> . </li><li>  <a href="https://github.com/eduard93/docx/commit/910ea3fb0f1667ce2722da491b27c4e12474c8ec">Commit the result</a> . </li><li>  Select the text Test in bold. </li><li>  Unpack the <code>unpack bold.docx bold</code> . </li><li>  Initially, diff looked like this: </li></ol><br><p><img src="https://habrastorage.org/files/059/659/38c/05965938c8c64bbea20cb47fb5c6d457.PNG" alt="diff"><br>  Consider it in detail: </p><br><h4 id="docpropsappxml">  docProps / app.xml </h4><br><pre> <code class="diff hljs">@@ -1,9 +1,9 @@ - &lt;TotalTime&gt;0&lt;/TotalTime&gt; + &lt;TotalTime&gt;1&lt;/TotalTime&gt;</code> </pre> <br><p>  We do not need to change the time. </p><br><h4 id="docpropscorexml">  docProps / core.xml </h4><br><pre> <code class="diff hljs">@@ -4,9 +4,9 @@ - &lt;cp:revision&gt;1&lt;/cp:revision&gt; + &lt;cp:revision&gt;2&lt;/cp:revision&gt; &lt;dcterms:created xsi:type="dcterms:W3CDTF"&gt;2017-02-07T19:37:00Z&lt;/dcterms:created&gt; - &lt;dcterms:modified xsi:type="dcterms:W3CDTF"&gt;2017-02-07T19:37:00Z&lt;/dcterms:modified&gt; + &lt;dcterms:modified xsi:type="dcterms:W3CDTF"&gt;2017-02-08T10:01:00Z&lt;/dcterms:modified&gt;</code> </pre> <br><p>  Changing the document version and the modification date does not interest us either. </p><br><h4 id="worddocumentxml-1">  word / document.xml </h4><br><div class="spoiler">  <b class="spoiler_title">diff</b> <div class="spoiler_text"><pre> <code class="diff hljs">@@ -1,24 +1,26 @@ &lt;w:body&gt; - &lt;w:pw:rsidR="0076695C" w:rsidRPr="00290C70" w:rsidRDefault="00290C70"&gt; + &lt;w:pw:rsidR="0076695C" w:rsidRPr="00F752CF" w:rsidRDefault="00290C70"&gt; &lt;w:pPr&gt; &lt;w:rPr&gt; + &lt;w:b/&gt; &lt;w:lang w:val="en-US"/&gt; &lt;/w:rPr&gt; &lt;/w:pPr&gt; - &lt;w:r&gt; + &lt;w:rw:rsidRPr="00F752CF"&gt; &lt;w:rPr&gt; + &lt;w:b/&gt; &lt;w:lang w:val="en-US"/&gt; &lt;/w:rPr&gt; &lt;w:t&gt;Test&lt;/w:t&gt; &lt;/w:r&gt; &lt;w:bookmarkStart w:id="0" w:name="_GoBack"/&gt; &lt;w:bookmarkEnd w:id="0"/&gt; &lt;/w:p&gt; - &lt;w:sectPr w:rsidR="0076695C" w:rsidRPr="00290C70"&gt; + &lt;w:sectPr w:rsidR="0076695C" w:rsidRPr="00F752CF"&gt;</code> </pre> </div></div><br><p>  The changes in <code>w:rsidR</code> not interesting - this is inside information for Microsoft Word.  Key change here </p><br><pre> <code class="diff hljs"> &lt;w:rPr&gt; + &lt;w:b/&gt;</code> </pre> <br><p>  in the paragraph with Test.  Apparently the element <code>&lt;w:b/&gt;</code> makes the text bold.  We leave this change and cancel the rest. </p><br><h4 id="wordsettingsxml">  word / settings.xml </h4><br><pre> <code class="diff hljs">@@ -1,8 +1,9 @@ + &lt;w:proofState w:spelling="clean"/&gt; @@ -17,10 +18,11 @@ + &lt;w:rsid w:val="00F752CF"/&gt;</code> </pre> <br><p>  Also does not contain anything related to bold text.  We cancel. </p><br><p>  7 We pack a folder with a 1m change (by adding <code>&lt;w:b/&gt;</code> ) and check that the <a href="https://github.com/eduard93/docx/releases/download/v1.0.0/bold.docx">document</a> opens and shows what was expected. <br>  8 <a href="https://github.com/eduard93/docx/commit/17f1dca258c44d87e8563b86a7e515b01bd4cee0">Commit change</a> . </p><br><h4 id="primer-2-nizhniy-kolontitul">  Example 2. Footer </h4><br><p>  Now let's look at the more complicated example - adding a footer. <br>  <a href="https://github.com/eduard93/docx/commit/0cd149e7cdab4e816a82a9128dbc5cfe89d74a97">Here is the initial commit</a> .  Add a footer with the text 123 and unpack the document.  Such a diff is obtained initially: </p><br><p><img src="https://habrastorage.org/files/478/e62/048/478e62048c12443481a00783f164bebe.PNG" alt="diff"></p><br><p>  Immediately we exclude changes in <code>docProps/app.xml</code> and <code>docProps/core.xml</code> - there is the same as in the first example. </p><br><h4 id="content_typesxml-1">  [Content_Types] .xml </h4><br><pre> <code class="diff hljs">@@ -4,10 +4,13 @@ &lt;Default Extension="xml" ContentType="application/xml"/&gt; &lt;Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/&gt; + &lt;Override PartName="/word/footnotes.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.footnotes+xml"/&gt; + &lt;Override PartName="/word/endnotes.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.endnotes+xml"/&gt; + &lt;Override PartName="/word/footer1.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml"/&gt;</code> </pre> <br><p>  The footer obviously looks like what we need, but what to do with footnotes and endnotes?  Are they required when adding a footer or created at the same time?  Answering this question is not always easy, here are the main ways: </p><br><ul><li>  See if the changes are related to each other. </li><li>  Experiment </li><li>  Well, if it is not at all clear what is happening: </li></ul><br><p> <a href="http://www.commitstrip.com/en/%3F"><img src="https://habrastorage.org/getpro/habr/post_images/186/4df/94a/1864df94a114d2b8e654546fde43a954.jpg" alt="Read the documentation"></a> <br>  Go ahead for now. </p><br><h4 id="word_relsdocumentxmlrels-1">  word / _rels / document.xml.rels </h4><br><p>  Initially, the diff looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">diff</b> <div class="spoiler_text"><pre> <code class="diff hljs">@@ -1,8 +1,11 @@ &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt; &lt;Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"&gt; + &lt;Relationship Id="rId5" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/&gt; &lt;Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/webSettings" Target="webSettings.xml"/&gt; + &lt;Relationship Id="rId4" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable" Target="fontTable.xml"/&gt; &lt;Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings" Target="settings.xml"/&gt; &lt;Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/&gt; - &lt;Relationship Id="rId5" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/&gt; - &lt;Relationship Id="rId4" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/fontTable" Target="fontTable.xml"/&gt; + &lt;Relationship Id="rId6" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer" Target="footer1.xml"/&gt; + &lt;Relationship Id="rId7" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/endnotes" Target="endnotes.xml"/&gt; + &lt;Relationship Id="rId8" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footnotes" Target="footnotes.xml"/&gt; &lt;/Relationships&gt;</code> </pre> </div></div><br><p>  You can see that some of the changes are related to the fact that Word changed the order of the links, remove them: </p><br><pre> <code class="diff hljs">@@ -3,6 +3,9 @@ + &lt;Relationship Id="rId6" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer" Target="footer1.xml"/&gt; + &lt;Relationship Id="rId7" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/endnotes" Target="endnotes.xml"/&gt; + &lt;Relationship Id="rId8" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footnotes" Target="footnotes.xml"/&gt;</code> </pre> <br><p>  Again appear footer, footnotes, endnotes.  All of them are connected with the main document, let's move to it: </p><br><h4 id="worddocumentxml-2">  word / document.xml </h4><br><pre> <code class="diff hljs">@@ -15,10 +15,11 @@ &lt;/w:r&gt; &lt;w:bookmarkStart w:id="0" w:name="_GoBack"/&gt; &lt;w:bookmarkEnd w:id="0"/&gt; &lt;/w:p&gt; &lt;w:sectPr w:rsidR="0076695C" w:rsidRPr="00290C70"&gt; + &lt;w:footerReference w:type="default" r:id="rId6"/&gt; &lt;w:pgSz w:w="11906" w:h="16838"/&gt; &lt;w:pgMar w:top="1134" w:right="850" w:bottom="1134" w:left="1701" w:header="708" w:footer="708" w:gutter="0"/&gt; &lt;w:cols w:space="708"/&gt; &lt;w:docGrid w:linePitch="360"/&gt; &lt;/w:sectPr&gt;</code> </pre> <br><p>  A rare case when there are only necessary changes.  The explicit link to the footer from <a href="http://www.datypic.com/sc/ooxml/e-w_sectPr-3.html">sectPr is visible</a> .  And since there are no references in the document to footnotes and endnotes, we can assume that we will not need them. </p><br><h4 id="wordsettingsxml-1">  word / settings.xml </h4><br><div class="spoiler">  <b class="spoiler_title">diff</b> <div class="spoiler_text"><pre> <code class="diff hljs">@@ -1,19 +1,30 @@ &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt; &lt;w:settings xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:w15="http://schemas.microsoft.com/office/word/2012/wordml" xmlns:sl="http://schemas.openxmlformats.org/schemaLibrary/2006/main" mc:Ignorable="w14 w15"&gt; &lt;w:zoom w:percent="100"/&gt; + &lt;w:proofState w:spelling="clean"/&gt; &lt;w:defaultTabStop w:val="708"/&gt; &lt;w:characterSpacingControl w:val="doNotCompress"/&gt; + &lt;w:footnotePr&gt; + &lt;w:footnote w:id="-1"/&gt; + &lt;w:footnote w:id="0"/&gt; + &lt;/w:footnotePr&gt; + &lt;w:endnotePr&gt; + &lt;w:endnote w:id="-1"/&gt; + &lt;w:endnote w:id="0"/&gt; + &lt;/w:endnotePr&gt; &lt;w:compat&gt; &lt;w:compatSetting w:name="compatibilityMode" w:uri="http://schemas.microsoft.com/office/word" w:val="15"/&gt; &lt;w:compatSetting w:name="overrideTableStyleFontSizeAndJustification" w:uri="http://schemas.microsoft.com/office/word" w:val="1"/&gt; &lt;w:compatSetting w:name="enableOpenTypeFeatures" w:uri="http://schemas.microsoft.com/office/word" w:val="1"/&gt; &lt;w:compatSetting w:name="doNotFlipMirrorIndents" w:uri="http://schemas.microsoft.com/office/word" w:val="1"/&gt; &lt;w:compatSetting w:name="differentiateMultirowTableHeaders" w:uri="http://schemas.microsoft.com/office/word" w:val="1"/&gt; &lt;/w:compat&gt; &lt;w:rsids&gt; &lt;w:rsidRoot w:val="00290C70"/&gt; + &lt;w:rsid w:val="000A7B7B"/&gt; + &lt;w:rsid w:val="001B0DE6"/&gt;</code> </pre> </div></div><br><p>  And now there are links to footnotes, endnotes that add them to the document. </p><br><h4 id="wordstylesxml">  word / styles.xml </h4><br><div class="spoiler">  <b class="spoiler_title">diff</b> <div class="spoiler_text"><pre> <code class="diff hljs">@@ -480,6 +480,50 @@ &lt;w:rFonts w:ascii="Times New Roman" w:hAnsi="Times New Roman"/&gt; &lt;w:b/&gt; &lt;w:sz w:val="28"/&gt; &lt;/w:rPr&gt; &lt;/w:style&gt; + &lt;w:style w:type="paragraph" w:styleId="a4"&gt; + &lt;w:name w:val="header"/&gt; + &lt;w:basedOn w:val="a"/&gt; + &lt;w:link w:val="a5"/&gt; + &lt;w:uiPriority w:val="99"/&gt; + &lt;w:unhideWhenUsed/&gt; + &lt;w:rsid w:val="000A7B7B"/&gt; + &lt;w:pPr&gt; + &lt;w:tabs&gt; + &lt;w:tab w:val="center" w:pos="4677"/&gt; + &lt;w:tab w:val="right" w:pos="9355"/&gt; + &lt;/w:tabs&gt; + &lt;w:spacing w:after="0" w:line="240" w:lineRule="auto"/&gt; + &lt;/w:pPr&gt; + &lt;/w:style&gt; + &lt;w:style w:type="character" w:customStyle="1" w:styleId="a5"&gt; + &lt;w:name w:val="  "/&gt; + &lt;w:basedOn w:val="a0"/&gt; + &lt;w:link w:val="a4"/&gt; + &lt;w:uiPriority w:val="99"/&gt; + &lt;w:rsid w:val="000A7B7B"/&gt; + &lt;/w:style&gt; + &lt;w:style w:type="paragraph" w:styleId="a6"&gt; + &lt;w:name w:val="footer"/&gt; + &lt;w:basedOn w:val="a"/&gt; + &lt;w:link w:val="a7"/&gt; + &lt;w:uiPriority w:val="99"/&gt; + &lt;w:unhideWhenUsed/&gt; + &lt;w:rsid w:val="000A7B7B"/&gt; + &lt;w:pPr&gt; + &lt;w:tabs&gt; + &lt;w:tab w:val="center" w:pos="4677"/&gt; + &lt;w:tab w:val="right" w:pos="9355"/&gt; + &lt;/w:tabs&gt; + &lt;w:spacing w:after="0" w:line="240" w:lineRule="auto"/&gt; + &lt;/w:pPr&gt; + &lt;/w:style&gt; + &lt;w:style w:type="character" w:customStyle="1" w:styleId="a7"&gt; + &lt;w:name w:val="  "/&gt; + &lt;w:basedOn w:val="a0"/&gt; + &lt;w:link w:val="a6"/&gt; + &lt;w:uiPriority w:val="99"/&gt; + &lt;w:rsid w:val="000A7B7B"/&gt; + &lt;/w:style&gt; &lt;/w:styles&gt;</code> </pre> </div></div><br><p>  Changes in styles interest us only if we are looking for how to change the style.  In this case, this change can be removed. </p><br><h4 id="wordfooter1xml">  word / footer1.xml </h4><br><p>  Now let's look at the footer itself (some of the namespaces are omitted for readability, but they must be in the document): </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:ftr</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/wordprocessingml/2006/main"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pw:rsidR="000A7B7B"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:rsidRDefault</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"000A7B7B"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pStyle</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:val</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"a6"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:pPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span>123<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:ftr</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Here the text 123 is visible. The only thing that needs to be corrected is to remove the link to <code>&lt;w:pStyle w:val="a6"/&gt;</code> . </p><br><p>  As a result of the analysis of all changes, we make the following assumptions: </p><br><ul><li>  footnotes and endnotes are not needed </li><li>  In <code>[Content_Types].xml</code> you need to add footer </li><li>  In <code>word/_rels/document.xml.rels</code> you need to add a link to footer </li><li>  In <code>word/document.xml</code> in the <code>&lt;w:sectPr&gt;</code> you need to add <code>&lt;w:footerReference&gt;</code> </li></ul><br><p>  Reduce the diff to this changeset: </p><br><p><img src="https://habrastorage.org/files/5d3/4fc/b84/5d34fcb8479244b198bc82507f61100a.PNG" alt="final diff"></p><br><p>  Then we pack the <a href="https://github.com/eduard93/docx/releases/download/v1.0.0/footer.docx">document</a> and open it. <br>  If everything is done correctly, the document will open and there will be a footer with the text 123. And here is the final <a href="https://github.com/eduard93/docx/commit/1f794a5cdba458b60466d8c1ca9a16e252b44e59">commit</a> . </p><br><p>  Thus, the process of finding changes is reduced to finding a minimum set of changes sufficient to achieve a given result. </p><br><h2 id="praktika">  Practice </h2><br><p>  Having found the change we are interested in, it is logical to proceed to the next stage, it could be any of: </p><br><ul><li>  Docx creations </li><li>  Parsing docx </li><li>  Docx conversions </li></ul><br><p>  Here we need knowledge of <a href="https://ru.wikipedia.org/wiki/XSLT">XSLT</a> and <a href="https://ru.wikipedia.org/wiki/XPath">XPath</a> . </p><br><p>  Let's write a fairly simple conversion ‚Äî replacing or adding a footer to an existing document.  I will write in the language Cach√© ObjectScript, but even if you do not know it - it does not matter.  Basically, we will call XSLT and the archiver.  Nothing more.  So let's get started. </p><br><h3 id="algoritm">  Algorithm </h3><br><p>  The algorithm is as follows: </p><br><ol><li>  Unpack the document. </li><li>  Add our footer. </li><li>  We register the link to it in <code>[Content_Types].xml</code> and <code>word/_rels/document.xml.rels</code> . </li><li>  Add the <code>&lt;w:sectPr&gt;</code> tag to the <code>&lt;w:footerReference&gt;</code> tag in <code>word/document.xml</code> or replace the link to our footer in it. </li><li>  We pack the document. </li></ol><br><p>  Let's get started </p><br><h4 id="raspakovka">  Unpacking </h4><br><p>  Cach√© ObjectScript has the ability to execute OS commands using the <a href="">$ zf (-1, oscommand) function</a> .  Call unzip to unpack the document using a <a href="">wrapper over $ zf (-1)</a> : </p><br><pre> <code class="hljs bash">///  %3 (unzip)   %1   %2 Parameter UNZIP = <span class="hljs-string"><span class="hljs-string">"%3 %1 -d %2"</span></span>; ///   <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>   targetDir ClassMethod executeUnzip(<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>, targetDir) As %Status { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> timeout = 100 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> cmd = $$<span class="hljs-variable"><span class="hljs-variable">$FormatText</span></span>(..<span class="hljs-comment"><span class="hljs-comment">#UNZIP, source, targetDir, ..getUnzip()) return ..execute(cmd, timeout) }</span></span></code> </pre><br><h4 id="sozdayom-fayl-nizhnego-kolontitula">  Create a footer file </h4><br><p>  At the input comes the footer text, write it in the file in.xml: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xml</span></span></span><span class="hljs-tag">&gt;</span></span>TEST<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xml</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  In XSLT (file - footer.xsl) we will create a footer with text from the xml tag (part of the namespace is omitted, here is the <a href="">complete list</a> ): </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/XSL/Transform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/package/2006/relationships"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">omit-xml-declaration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">standalone</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:ftr</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/wordprocessingml/2006/main"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:rPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:lang</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:val</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en-US"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:rPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//xml/text()"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:ftr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Now call the <a href="">XSLT converter</a> : </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> #<span class="hljs-selector-id"><span class="hljs-selector-id">#class</span></span>(%<span class="hljs-selector-tag"><span class="hljs-selector-tag">XML</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.XSLT</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Transformer</span></span>)<span class="hljs-selector-class"><span class="hljs-selector-class">.TransformFile</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xml</span></span>", "<span class="hljs-selector-tag"><span class="hljs-selector-tag">footer</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xsl</span></span>", <span class="hljs-selector-tag"><span class="hljs-selector-tag">footer0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xml</span></span>")</code> </pre> <br><p>  The result is the <code>footer0.xml</code> footer <code>footer0.xml</code> : </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:ftr</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/wordprocessingml/2006/main"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:rPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:lang</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:val</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en-US"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:rPr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span>TEST<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:t</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:r</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:ftr</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h4 id="dobavlyaem-ssylku-na-kolontitul-v-spisok-svyazey-osnovnogo-dokumenta">  Add a footer link to the main document link list. </h4><br><p>  Links with identifier <code>rId0</code> usually do not exist.  However, you can use XPath to get an identifier that definitely does not exist. <br>  Add a link to <code>footer0.xml</code> with identifier rId0 in <code>word/_rels/document.xml.rels</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Xslt</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/XSL/Transform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/package/2006/relationships"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">omit-xml-declaration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"new"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Relationship</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rId0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"footer0.xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:param</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$new"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@* | node()"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h4 id="propisyvaem-ssylki-v-dokumente">  Register links in the document </h4><br><p>  Next you need to add the <code>&lt;w:footerReference&gt;</code> tag to each <code>&lt;w:sectPr&gt;</code> tag or replace the link to our footer in it.  <a href="https://msdn.microsoft.com/en-us/library/documentformat.openxml.wordprocessing.footerreference(v%3Doffice.14).aspx">It turned out</a> that each <code>&lt;w:sectPr&gt;</code> can have 3 <code>&lt;w:footerReference&gt;</code> - for the first page, even pages, and everything else: </p><br><div class="spoiler">  <b class="spoiler_title">Xslt</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/XSL/Transform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:r</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:w</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/wordprocessingml/2006/main"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">omit-xml-declaration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//@* | //node()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:apply-templates</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:apply-templates</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"node()"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//w:sectPr"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{name()}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">namespace</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{namespace-uri()}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"./namespace::*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:apply-templates</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"./*[local-name() != 'footerReference']"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:footerReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"default"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rId0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:footerReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"first"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rId0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w:footerReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">w:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"even"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">r:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rId0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:element</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h4 id="dobavlyaem-kolontitul-v-content_typesxml">  Add footer to <code>[Content_Types].xml</code> </h4><br><p>  Add to <code>[Content_Types].xml</code> information that <code>/word/footer0.xml</code> is of type <code>application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Xslt</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/XSL/Transform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/package/2006/content-types"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">omit-xml-declaration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"new"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Override</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PartName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/word/footer0.xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContentType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:param</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@* | node()"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$new"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:copy</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h4 id="v-rezultate">  As a result </h4><br><p>  All code is <a href="">published</a> .  It works like this: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(Converter.Footer).modifyFooter(<span class="hljs-string"><span class="hljs-string">"in.docx"</span></span>, <span class="hljs-string"><span class="hljs-string">"out.docx"</span></span>, <span class="hljs-string"><span class="hljs-string">"TEST"</span></span>)</code> </pre> <br><p>  Where: </p><br><ul><li>  <code>in.docx</code> - source document </li><li>  <code>out.docx</code> - outgoing document </li><li>  <code>TEST</code> - text that is added to the footer. </li></ul><br><h2 id="vyvody">  findings </h2><br><p>  Using only XSLT and ZIP, you can successfully work with docx documents, xlsx tables and pptx presentations. </p><br><h2 id="otkrytye-voprosy">  Open questions </h2><br><ol><li>  Initially I wanted to use 7z instead of zip / unzip t ... k. This is one utility and it is more common on Windows.  However, I ran into such a problem that documents packed with 7z for Linux cannot be opened in Microsoft Office.  I tried a lot <a href="http://7zip.bugaco.com/7zip/MANUAL/switches/index.htm">of</a> call <a href="http://7zip.bugaco.com/7zip/MANUAL/switches/index.htm">options</a> , but I could not achieve a positive result. </li><li>  I am looking for XSD with ECMA-376 version 5 schemas and comments.  XSD version 5 without comments is available for download on the ECMA website, but without comments it is difficult to understand.  XSD version 2 with comments is available for download. </li></ol><br><h2 id="ssylki">  Links </h2><br><ul><li>  <a href="http://www.ecma-international.org/publications/standards/Ecma-376.htm">ECMA-376</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/aa338205.aspx">Docx description</a> </li><li>  <a href="https://www.toptal.com/xml/an-informal-introduction-to-docx">Detailed article about docx</a> </li><li>  <a href="https://github.com/eduard93/docx">Repository with scripts</a> </li><li>  <a href="https://github.com/intersystems-ru/Converter/">Repository with footer converter</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321044/">https://habr.com/ru/post/321044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321032/index.html">Using Sketchode 2 in Development: An Overview</a></li>
<li><a href="../321034/index.html">Managing complexity in ruby ‚Äã‚Äãon rails projects. Part 3</a></li>
<li><a href="../321036/index.html">How it all began: developers remember the first games they created</a></li>
<li><a href="../321038/index.html">The history of the creation of the first game on Unity - from idea to release</a></li>
<li><a href="../321040/index.html">Russian 4Gap: distribution of 4G networks in Russia and in the world</a></li>
<li><a href="../321048/index.html">Analysis and translation of the alien language using the Wolfram Language</a></li>
<li><a href="../321050/index.html">The hunt for the mythical MVC. Review, return to the original sources and how to analyze and display patterns yourself</a></li>
<li><a href="../321052/index.html">BLE under the microscope. Part 3</a></li>
<li><a href="../321054/index.html">How to get a discount from 20 to 60% for posting vacancies and free access to the resume database on My Circle</a></li>
<li><a href="../321056/index.html">First steps with STM32 and mikroC compiler for ARM architecture - Part 3 - UART and GSM module</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>