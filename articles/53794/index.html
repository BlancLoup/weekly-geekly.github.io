<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Case of Lost Rows in DataView</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Debugging a WPF editor for a DB table, I ran into Exception when switching between adjacent cells using the keyboard. 
 It would seem a common thing -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Case of Lost Rows in DataView</h1><div class="post__text post__text-html js-mediator-article">  Debugging a WPF editor for a DB table, I ran into Exception when switching between adjacent cells using the keyboard. <br>  It would seem a common thing - who among us expects did not smell?  Yes, and the DataGrid component of the <a href="http://www.codeplex.com/wpf">WPF Toolkit is</a> very experimental, so there is nothing surprising.  However, something put me on my guard. <br><br><a name="habracut"></a><br>  IndexOutOfRangeException fell out in DataGrid.cs on line <br><blockquote><code><font color="black"><font color="#0000ff">object</font> nextItem = Items[nextRowIndex];</font></code> </blockquote> <br>  And yes, nextRowIndex really was out of range, it was -1. <br><br>  Now let's see where it comes from.  He announced a little higher: <br><blockquote> <code><font color="black"><font color="#0000ff">int</font> currentRowIndex = Items.IndexOf(CurrentItem); <br> <font color="#7f7f7f">int nextDisplayIndex = currentDisplayIndex;</font> <br> <font color="#0000ff">int</font> nextRowIndex = currentRowIndex;</font></code> </blockquote> <br>  and until the moment where we get the exeption, its value (in the case of the ‚Äúright‚Äù button) does not change. <br>  So, set a bryak to initialize nextRowIndex, reproduce actions with the editor ... voila, currentRowIndex == -1! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What do we have?  Items.IndexOf () tells us that such an item does not exist.  But we know that it is not.  Check it in Watch: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c9/6db/70a/5c96db70a951f06f457da539935be539.png"><br><br>  CurrentItem is equal to the corresponding Item from the collection, everything is fair.  Indices for neighboring elements are well defined.  But specifically "our" element - not found.  Well, we will understand ... <br><br>  First, the suspicion fell on the actual ItemCollection, an instance of which is Items. <br>  After installing some update on the framework, some of the libraries from WPF (in particular, to the PresentationFramework.dll that we are interested in), the source codes stopped coming up, so part of the way had to be done in assembly listing.  However, even in spite of this, we rather quickly found out that the ItemCollection is only a wrapper for the corresponding CollectionView.  And in our case, this is the BindingListCollectionView, which is the default view for the DataView. <br><br>  The BindingListCollectionView itself, however, also turned out to be a wrapper and sent a call to the IList.IndexOf () of the DataView.  After he returned the same ‚Äúminus one‚Äù, I abandoned the idea that the problem was in the WPF part. <br><br>  So, how does IndexOf work on a DataView and why does it not find the right row? <br><br>  Analysis of the code showed (and even in the debugger you can see the prerequisites for this) that DataTable uses an index for strings (RB Tree).  And the DataView refers specifically to the table index in its search for the DataRow associated with the desired DataRowView. <br>  However, if the DataRow is in edit mode, it creates a temporary record inside itself with a copy of all its values. <br>  And it turns out that at this moment DataRowView is associated with a temporary record (otherwise the changes in it would not affect the DataRow itself), respectively, he is trying to look for it in the index! <br><br>  Here is a small example to reproduce the problem: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">void</font> Main( <font color="#0000ff">string</font> [] args) <br> { <br> <font color="#0000ff">var</font> dataTable = <font color="#0000ff">new</font> DataTable(); <br> dataTable.Columns.Add( <font color="#A31515">"Id"</font> , <font color="#0000ff">typeof</font> ( <font color="#0000ff">int</font> )); <br> dataTable.Columns.Add( <font color="#A31515">"Name"</font> , <font color="#0000ff">typeof</font> ( <font color="#0000ff">string</font> )); <br> <br> <font color="#0000ff">var</font> row = dataTable.NewRow(); <br> row[ <font color="#A31515">"Id"</font> ] = 1; <br> row[ <font color="#A31515">"Name"</font> ] = <font color="#A31515">"John"</font> ; <br> dataTable.Rows.Add(row); <br> <br> row = dataTable.NewRow(); <br> row[ <font color="#A31515">"Id"</font> ] = 2; <br> row[ <font color="#A31515">"Name"</font> ] = <font color="#A31515">"Jack"</font> ; <br> dataTable.Rows.Add(row); <br> <br> <font color="#0000ff">var</font> view = dataTable.DefaultView; <br> <br> <font color="#008000">//row.BeginEdit();</font> <br> <br> <font color="#2B91AF">Console</font> .WriteLine(((IList)view).IndexOf(view[0])); <br> <font color="#2B91AF">Console</font> .WriteLine(((IList)view).IndexOf(view[1])); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In its original form, we obtain the expected 0 and 1. <br>  If you uncomment row.BeginEdit (), then the corresponding line will no longer exist. <br><br>  By the way, if instead of a DataRow call BeginEdit () on the corresponding DataRowView, then (at first glance) the row index will be displayed correctly.  This is due to the fact that DataRowView uses a lazy call - the associated DataRow will be called BeginEdit () only when there is a change in data. <br><br><h4>  Summary </h4><br>  I do not know how this behavior is correct.  Most likely this is a bug, however, the wizards of the .NET Team may well declare its features.  In any case, non-core operations should be avoided with the line being edited. <br>  Or use newer data models, like LINQ2SQL or EntityFramework.  However, there you are not insured against other surprises :) <br><br>  As a workout, I added to the DataGrid.cs before Items.IndexOf (CurrentItem) this: <br><blockquote> <code><font color="black"><font color="#008000">// BUG: item not found if in edit mode</font> <br> <font color="#0000ff">if</font> (IsEditingRowItem) <br> CommitRowItem();</font></code> </blockquote> <br>  This case can be considered closed. <br><br></div><p>Source: <a href="https://habr.com/ru/post/53794/">https://habr.com/ru/post/53794/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../53788/index.html">Let's discuss php frameworks</a></li>
<li><a href="../53790/index.html">Yota router or wimax2wifi in 15 minutes</a></li>
<li><a href="../53791/index.html">Captchaad - Captcha with ads</a></li>
<li><a href="../53792/index.html">Record guitar chords HTML + CSS (so far without barre)</a></li>
<li><a href="../53793/index.html">Logitech MX 5500 Revolution Overview</a></li>
<li><a href="../53795/index.html">hot keys in LJ</a></li>
<li><a href="../53796/index.html">Quake Live & Jabber</a></li>
<li><a href="../53801/index.html">bloGoo.ru - daily cream of the Russian blogosphere</a></li>
<li><a href="../53802/index.html">But have I fallen into hablability? :)</a></li>
<li><a href="../53803/index.html">HDtracker.ru - open registration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>