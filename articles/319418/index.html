<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to create your file system based on blob fields in the database. Why is it convenient? Efficiency issues</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear readers. This is the third article from the database cycle. 

 Table of contents: 



1. How to make a different time zone in different databases...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to create your file system based on blob fields in the database. Why is it convenient? Efficiency issues</h1><div class="post__text post__text-html js-mediator-article">  Dear readers.  This is the third article from the database cycle. <br><br>  Table of contents: <br><br><ol><li>  <a href="https://habrahabr.ru/post/317680/">How to make a different time zone in different databases on the same server.</a> </li><li>  <a href="https://habrahabr.ru/post/317866/">How to keep logs of data changes by users in the database, storing them in another database (so that the database of the main database is not clogged with garbage and does not grow)</a> </li><li>  <i>How to create your file system based on blob fields in the database.</i>  <i>Why is it convenient?</i>  <i>Issues of file storage efficiency (how to get the maximum speed and at the same time the minimum space occupied)</i> </li></ol><br>  This method is a method of implementing the storage of files attached by the user on the site via the web interface.  It will not be a ‚Äúfile system‚Äù as it is organized in the operating system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The example described in this article will solve the problem I once had: ‚Äú <i>Select a section within the company's account on a web site where employees of the company will be able to store their files, create folders (let's call it‚Äú Disk ‚Äù).</i>  <i>The disk should be isolated from the accounts of other companies and should be integrated into the account's work processes (organizing the storage of files attached to tasks, projects, counterparty cards, reports, etc.)</i> ‚Äù. <br><br>  Immediately, I note that this method, in terms of speed, is less effective simply storing files on a web server.  But it has certain advantages, which in my case outweighed the disadvantages of losing download speeds. <br><a name="habracut"></a><br>  <u>Disadvantages:</u> Increased file download time <br><br>  <u>Benefits</u> <br><br><ol><li>  Distributed storage structure.  Those.  It is not necessary to store client files on the web server itself.  You can store them anywhere, on any servers of your network.  Easily move them from server to server if necessary. <br></li><li>  Convenience of backing up client files.  You can do everything with standard backup tools. </li><li>  Security.  This method is deprived of the main vulnerabilities of web applications when downloading files (for example <a href="https://habrahabr.ru/post/44610/">,</a> you can read them <a href="https://habrahabr.ru/post/44610/">here</a> ).  The same method provides physical isolation of customer data from the data of other customers, because each company has its own database. </li></ol><br>  The main argument for the implementation of this file storage system was the possibility of distributed storage.  In principle, you can use solutions like cifs and samba, mount network drives from other machines and store client files there.  But at that time I got this here, not quite a standard solution, and I am completely satisfied with it. <br><br>  In this article we will consider the implementation process from simple to complex: <br><br><ol><li>  The general organization of the storage structure. </li><li>  Save files to blob fields.  Direct extraction. </li><li>  Saving files with intermediate archiving in blob fields.  Extraction with intermediate unarchiving. </li><li>  Saving files with deferred and selective archiving (it does not make sense to archive all files, in which cases the game is not worth the candle, and it also does not always make sense to archive immediately). </li><li>  Then we consider the organization of the directory structure, the organization of access rights, file operations, some special cases, etc. <br>  So, let's begin. </li></ol><br>  So, let's begin. <br><br>  As a database, firebird 3 is used. <br><br>  <b>1. The general organization of the storage structure.</b> <br><br>  As in the previous article (on storing logs), you should not store files in the main working database, it will be a lot of garbage, problems with backups, etc.  For this, it is better to select a separate database.  Let's call it ‚ÄúFile DB‚Äù.  The main database should store the directory structure and links to files, and the binary data from the files will be stored in the file database. <br><br>  In this case, you will get the convenience of backups, and a fast database.  For example, in my system I give users the opportunity to independently schedule their backups, including backups of the file database.  Moreover, there is even the possibility of automatically uploading the backup archive to the user on his FTP (for example, if he wants to store backups on his equipment and not pay for renting space in the cloud).  Such an implementation is possible thanks to the storage of files in a separate database and the organization of a distributed storage system. <br><br>  Also, thanks to this organization, the web server performs only the functions of a web server, and not file storage.  You can more intelligently organize the distribution of resources in the network.  With a huge number of clients (a huge number of databases and file structures), unallocated data storage will simply be unacceptable.  The structure should be unlimitedly scalable, as well as simple. <br><br>  The scheme can be represented as follows: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/238/c02/be8238c02008a98b4e6b2669f937c36c.png" alt="image"></div><br>  In addition, each of the elements can be (and better done so) on its own separate server.  The data storage structure can be organized as follows.  A structure with data about the attached file is created in the main database. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> FILES_ ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATA</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, <span class="hljs-comment"><span class="hljs-comment">--   DATA_DEL TIMESTAMP, --   USER_ INTEGER, --,   USER_DEL INTEGER, --,   ID_FILE INTEGER, --ID     FILE_NAME VARCHAR(256), --  FILE_NAME_TMP VARCHAR(256), --    CONTENT_TYPE VARCHAR(100), --   STATUS SMALLINT, --  (  ) SIZE BIGINT, --  SIZE_ZIP BIGINT, --   SIZE_ZIP_2 BIGINT, --   ZIP_USE SMALLINT, --    ID_FOLDER INTEGER, -- ,    FLAG_ZIP SMALLINT --   );</span></span></code> </pre> <br>  The structure of the file database can be like this (minimum data about the file and the file itself in the blob field). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> FILES_ ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATA</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, USER_ <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, <span class="hljs-comment"><span class="hljs-comment">--,   FILE_NAME VARCHAR(256), --  CONTENT_TYPE VARCHAR(100), --   FILE_DATA BLOB SUB_TYPE 0 SEGMENT SIZE 80, --   STATUS SMALLINT, -- (  ) SIZE INTEGER, --  SIZE_ZIP INTEGER, --   ZIP_USE SMALLINT --    );</span></span></code> </pre><br>  There is some data redundancy in these two tables relative to each other, but later it will come in handy, for example, during a deferred backup operation, during debugging, during subsequent data analyzes, etc.  Do not fence the same request into multiple databases. <br><br>  Let's start the review with a simple file entry in the blob field. <br><br>  <b>2.1.</b>  <b>Save files to blob fields.</b> <br><br>  Web forms and the process of uploading a file to a directory on a web server will not be covered here.  It is assumed that the reader is familiar with this. <br><br>  So, the user clicked a button in the web form, the file was downloaded and saved in the web server directory (for example, tmp). <br><br>  The file data at this moment we have in the global array FILES. <br>  (I will give examples in PHP) <br><br>  <i>PS: For simplicity, I deliberately omit the conversion of dangerous special characters to mnemonics, forced reduction of numerical data to a number, etc.</i>  <i>It is assumed that the reader has his own procedures for this and he is aware of the danger of sql injections.</i>  <i>If not, then I highly recommend to get acquainted with this topic and make the appropriate conversion.</i> <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    . $dbh_file = ibase_connect(‚Ä¶); //     $fd = fopen($_FILES[‚Ä¶]['tmp_name'], 'r'); //     $blob = ibase_blob_import($dbh_file, $fd); //  fclose($fd); //  ,       . if (!is_string($blob)) { } else { $query = 'INSERT INTO FILES_ ( USER_, NAME_FILE, CONTENT_TYPE, FILE_DATA, SIZE, SIZE_ZIP, ZIP_USE) VALUES ( '.$USER_.', '.$_FILES[...]['name'].', '.$file_type.', ?, '.$_FILES[...]['size'].', '.$_FILES[...]['size'].', 0) RETURNING ID'; $prepared = ibase_prepare($dbh_file, $query); $res_query = ibase_execute($prepared, $blob); $prom_query = ibase_fetch_row($res_query);</span></span></code> </pre> <br>  In $ prom_query [0] - will be the ID value of the recorded file.  After successfully writing the file data to the file database, you need to write the file data to our main database. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ,   , ID   . if (isset($prom_query[0])) //     $dbh_osn = ibase_connect(‚Ä¶); $query2 = ' INSERT INTO FILES ( USER_, ID_FILE, FILE_NAME, SIZE, SIZE_ZIP, CONTENT_TYPE, FILE_ NAME_TMP, ZIP_USE) VALUES ( '.$USER_.', '.$prom_query[0].', '. $_FILES[‚Ä¶]['name']).', '. $_FILES[‚Ä¶]['size'].', '. $_FILES[‚Ä¶]['size'].', '.$_FILES[‚Ä¶]['type'].', '.basename($_FILES[‚Ä¶]['tmp_name']).', 0)'; $res_query2 = ibase_query($dbh_osn, $query2); //       tmp. unlink($_FILES[‚Ä¶]['tmp_name']);</span></span></code> </pre> <br>  Everything, we have a file recorded in the file database.  It is not on the web server.  In the main database there is information about this file, its status, type, size and identifier in the file database. <br><br>  <b>2.2.</b>  <b>Reading a file from the database.</b> <br><br>  When the user clicks on the link with the file name, we need to reverse the process.  Extract the file from the database and present this sequence of data to the user's browser, saying what type of file it is. <br><br>  In the link, the file identifier must be specified as the GET parameters (or the hash identifier with the salt depends on the system security requirements, we will consider a simple situation so far).  For example, a link might look like this: File. <br><br>  At the stage of simple reading from the database (without archiving data), it is enough for us to access the file database. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     $dbh_file = ibase_connect(‚Ä¶) $query="select p.file_data, p.CONTENT_TYPE, p.FILE_NAME, p.size from FILES p where p.id=".$_GET['id']; $res = ibase_query($dbh_file, $query); $data = ibase_fetch_row($res);</span></span></code> </pre> <br>  When specifying the data type in the header, an individual problem with the Chrome browser has been identified.  It is fundamentally necessary for the filename in the header to be with single quotes, while other browsers are fundamentally necessary without quotes.  For this example, you can use the following solution. <br><br><pre> <code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">"/(MSIE|Opera|Firefox|Chrome|Version)(?:\/| )([0-9.]+)/"</span></span>, $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>], $browser_info); <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>(,$browser,$version) = $browser_info; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($browser==<span class="hljs-string"><span class="hljs-string">'Chrome'</span></span>) header(<span class="hljs-string"><span class="hljs-string">"Content-Disposition: attachment; filename='"</span></span>.str_replace(<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>,$data[<span class="hljs-number"><span class="hljs-number">2</span></span>]).<span class="hljs-string"><span class="hljs-string">"'"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> header(<span class="hljs-string"><span class="hljs-string">"Content-Disposition: attachment; filename="</span></span>.str_replace(<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>,$data[<span class="hljs-number"><span class="hljs-number">2</span></span>]));</code> </pre><br>  Replacing the space with "_" is carried out to correctly reflect the file name when downloading, because most likely the name will be cut off by a space. <br><br>  After that, we output the binary data of the file into the script body. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> ibase_blob_echo($data[<span class="hljs-number"><span class="hljs-number">0</span></span>]);</code> </pre> <br>  PS: Here I want to draw attention to a typical error.  There should be no characters before &lt;? Php and after?&gt; Otherwise it will not work. <br><br>  Now when you click on the link file_b.php? Id = 123, the user will download a window for downloading his file (with his name and the desired type). <br><br>  <b>3.1.</b>  <b>Download file with intermediate archiving</b> <br><br>  We looked at a fairly simple, basic way of storing files.  Now we will improve it a little.  After all, a binary sequence is stored in the database, why not make it shorter and save space.  To do this, before writing the data file in blob, zip it. <br><br><blockquote>  Some statistics: <br>  <i>The first time this thought came to me about 1.5 years ago.</i>  <i>At that moment I was just developing the invoice reconciliation module for one company and decided to experimentally integrate this function with it.</i>  <i>All sorts of files with information on invoices and agreements, pdf, xls, doc, etc. are attached to this module.</i> <i><br><br></i>  <i>For 1.5 years in a medium-type company with a staff of 50-70 people, 4085 files with a total volume of 1,526 mb were attached to one module (at the same time), while on the disk it all takes 1240 mb.</i>  <i>Those.</i>  <i>archiving zip archive, gave a saving of about 20%.</i>  <i>This is pretty good.</i> <i><br></i>  <i>In those days, archiving was implemented by me through the zip.lib.php library directly in the script.</i>  <i>Later I came to the conclusion that this method is not optimal in terms of compression and speed.</i>  <i>At present, the 7zip archiver is used in practice.</i> </blockquote><br>  Loading a file with archiving does not cause any special problems.  It is only necessary before saving the blob file sequence in the database, to archive it, for example: <br><br><pre> <code class="php hljs">exec(<span class="hljs-string"><span class="hljs-string">'7z a &lt; &gt; &lt; &gt;);</span></span></code> </pre> <br>  And then at the end, in addition to the original, delete its archive from the web server. <br><br>  But the process of extracting such a file to the user is much more interesting. <br><br>  <b>3.2.</b>  <b>Reading a file from the database with extracting it from the archive</b> <br><br>  Just as in the direct extraction, do not work.  After the user clicks the link, you must first read the file, save it to the web server, unzip it, and then transfer it to the user. <br><br>  Those.  when the user clicks on the file_b.php? id = 123 link, the script should pull another script that considers the data from the blob file (absolutely similar to clause 2.2) after saving this file to the server disk, then start unarchiving it, and the data From the received file, output to yourself, substituting the necessary header, so that the user gets out the window - that he is downloading the file. <br><br>  For this purpose we use CURL. <br><br>  After determining the type of browser and substitution header, do the following. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//         //  $fp = fopen($path, 'w'); // curl-   ,       blob ,      . $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, $url); curl_setopt($ch, CURLOPT_USERAGENT, $agent); curl_setopt($ch, CURLOPT_FILE, $fp); curl_exec($ch); curl_close($ch); fclose($fp);</span></span></code> </pre> <br>  Thus, in the file named $ path, our archived file appears.  We make its unarchiving. <br><br><pre> <code class="php hljs">exec(<span class="hljs-string"><span class="hljs-string">'7z e '</span></span>.$path.<span class="hljs-string"><span class="hljs-string">' ‚Äìo &lt; &gt; -y'</span></span>);</code> </pre> <br>  After that, we read the file and integrate its data into our script using fpassthru <br><br><pre> <code class="php hljs">$stream = fopen(&lt; &gt;,<span class="hljs-string"><span class="hljs-string">'r'</span></span>); fpassthru($stream); fclose($stream);</code> </pre> <br>  Now everything should work out. <br><br>  <b>4. Saving files with intermediate archiving in blob fields.</b> <br><br>  Now consider the issues of speed.  We then save the place.  But instead of waiting for the user to just download the file to the server, we make him wait for both the backup time and the time to add the file to the blob field.  For the user, the file download time often increases even more than 2 times.  When retrieving in a similar way, instead of reading the data directly, we begin to save them, unzip them, and then present them to the user.  All this is not very good.  What can be done in this case? <br><br>  1) First, you can post the process of downloading a file and the process of archiving it.  Those.  the user loads the file in its original form.  And only then, the script that starts with a periodicity will look at the newly uploaded files and archive them.  In this case, for the user, the download of files will be much faster, while we will save space.  Moreover, the operation of this script can be organized on another server, and it will not consume the resources of the web server (why would we need a highly loaded server to be engaged in archiving?), This process can take place aside, slowly. <br><br>  2) Secondly, not all file types make sense to compress.  For example, if the difference between a compressed and uncompressed file is less than 10%, then the game is definitely not worth the trouble, space saving is minimal - the CPU voltage and user waiting time are maximum.  For myself, I selected the following types of poorly compressible files that the archiver does not even touch, but simply tick (processed ‚Äî no longer touch).  RAR, GZ, ZIP, JAR, TAR, ARJ, UC2, GZ, UUE, LHA, CAB, LZH, ACE, TGZ, 7Z, AVI, MPG, 3GP, WMV, ASF, FLV, MP3, AAC, WMA, AMR, TIF, JPG, JP2, GIF, PNG. <br><br>  <i>PS: information from <a href="https://habrahabr.ru/users/ivanbolhovitinov/" class="user_link">ivanbolhovitinov</a> .</i>  <i>The correct XLSX, DOCX is always a ZIP archive.</i>  <i>The first 2 bytes are ‚ÄúPK‚Äù.</i>  You can check them like this: file_get_contents ($ filename, NULL, NULL, 0.2) <br><br>  3) Since  when extracting the file to the user, we also do work on unarchiving, even if the file is not a type from item 2 - it‚Äôs still not a fact that it makes sense to archive it.  Empty archiving is eating up your resources and what's more scary is user waiting time.  Therefore, the system, before archiving the file, must check if that makes sense.  For this, we had to make a system of preventive archiving, i.e.  the script first ‚Äútries‚Äù - it downloads the file, archives it, but before replacing the original with the archive - it checks how many percent the size of the archive differs from the size of the original.  If this value is again less than 10%, then archiving has no meaning at all.  Such files are marked as processed and not archived. <br><br>  Typical representatives of such xlsx files.  The format itself is compressed, but in fact there are very different files, some can be compressed by 50%, and some, God forbid, by 5%.  Depends on the filling. <br><br>  4) It also does not make sense to archive files smaller than 250 bytes in size, the archive will be larger than the original. <br><br>  5) No need to archive large files.  It is empirically derived that it is in the region of 15 mb or more.  Even if it compresses well - you have to spend some time (apart from having to extract it from the blob) to decompress it - such temporary user expectations can already be strained. <br><br>  <b>5. Organization of the directory structure, organization of access rights, file operations, some special cases.</b> <br><br>  So far we have considered only the file storage system.  This is the basic thing on which everything else is based.  But for a full-fledged ‚ÄúFile System‚Äù, it is still necessary to somehow structure these files, assign access rights to them, etc. <br><br>  Perhaps this chapter will not be interesting to everyone, because  the implementation of this structure will depend very much on the task at hand.  I implemented this structure for the erp-platforma.com cloud service, so in this chapter I will review the tasks that the file system should solve for the company's service organization: <br><br>  1) <u>Classic</u> - Directory tree files.  The mechanism of applying files, editing their metadata, deleting. <br><br>  2) A small introduction is required for this item.  Consider not the obvious thing for everyone in the work of automation systems: when you attach a file to a task, it is not physically stored in the task, but on disk.  The task contains only a link to this file. <br><br>  When disk space runs out, the system administrator may need to clear it.  And going through all the tasks for him in twenty years, deleting files from them - well, it's just silly. <br>  Those.  there should be some kind of file structure, for example, the ‚ÄúTasks‚Äù service directory on the disk where all files attached to the tasks will be stored, and the sysadmin can simply clean old files. <br><br>  But what happens if he removes them?  The tasks will remain links that do not lead anywhere!  Also not gud.  Consequently, the tasks should not be a link, but a kind of ‚Äúwindow‚Äù in the Disk, in which the task will see only its files. <br><br>  But simply ‚Äúwindows‚Äù are few.  The user can ‚Äúremember‚Äù that he attached the file, and the ‚Äúevil‚Äù sysadmin will silently delete it from the disk and tell the user that he is crazy.  Therefore, the file data can be deleted, but the record that the file was, should remain somewhere in the bins and in our ‚Äúwindow‚Äù the link should be displayed in some gray, inactive color. <br><br>  I cited the ‚Äútask‚Äù as an example; similarly, files can be attached to projects, contractors, employees, objects, etc.  Those.  The system should be universal. <br><br>  But that's not all.  For example, a customer may easily want counterparties to have 2 file application areas, for example, an area where bills are attached and an area where documents are attached.  Those.  These ‚Äúwindows‚Äù should be attached not just to the page and its input data, but to specific elements of the page. <br><br>  To summarize the point: the <u>file system must support some ‚Äúwindows‚Äù into it from the external system.</u>  <u>Each ‚Äúwindow‚Äù should have the functions of file operations within its framework.</u> <br><br>  3) The user may need to find in the folder the files that were attached to such a counterparty, or to such a project or even for some unknown signs, it does not matter how these files can be called.  Those.  <u>we need a certain search system not only by file names, but also by their belonging to external structures.</u> <br><br>  <i>PS: In my opinion, such things are optimally implemented using hashtags.</i>  <i>For these purposes, in the files, you can enter a couple of properties: ‚Äúsystem hashtags‚Äù and ‚Äúuser hashtags‚Äù.</i>  <i>System names are written in the system, for example, the name of the counterparty.</i>  <i>In custom - arbitrarily by the user, with the application file.</i> <br><br>  4) <u>Access rights</u> .  By itself, someone should have the right to view certain folders, some do not.  Rights to add, delete.  Or it may happen that the user should have access to the task and the files attached to it, and the folder in which these access files should not be.  Those.  ‚ÄúWindow‚Äù must have its rights.  The system administrator must have a mechanism for assigning or removing access rights to certain users. <br><br>  These are the requirements for the file system structure. <br><br>  Realization of all these things is quite complicated and branching code in scripts and in the database structure, therefore, this is not the result of this in the article.  And so it is a very big article. <br>  I will describe the basic principles for the implementation of each of the tasks. <br><br>  <u>The directory structure is</u> fairly straightforward.  This is a simple table in the database of a company that has: <br><br>  1) Folder name <br>  2) Folder Creator <br>  3) Folder node in which this folder is located <br>  4) Folder status <br>  5) Folder ID <br>  6) General rights to the default folder (which all users can do in the folder if they are not granted special rights) <br><br>  More on each item: <br><br>  1) The folder name can be duplicated at different levels of the tree, in different nodes.  The folder name cannot be duplicated in one node.  This mechanism is very simple to implement, just put a unique index on fields 1 and 3 of the table.  When duplicating a name in one node, the system will generate an error. <br><br>  2) Folder creator must be recorded.  The folder creator always has full rights to it, unless otherwise specified by the administrator as a user.  For example, even if a user has created a folder - the system administrator can still block access to it by making a corresponding entry in the role. <br><br>  The folder creator can configure default permissions for other users.  Those.  whether the others see the folder, can they look at the files only for reading, or can delete them, modify user hashtags, etc.  Again, these settings may be overlaid by the system administrator. <br><br>  3) A folder of another folder is registered in the folder in which it is located.  This is needed to build a tree-like folder system. <br><br>  4) Folder status.  The folder can be working, or it can be deleted.  The question is not really simple.  Here, each developer can decide for himself what to do, for example, you can organize the service folder ‚ÄúTrash‚Äù in which the folders with the status will be deleted.  You can really delete them - but then you need to work out what to do with the files in the folder, as well as with the folder connections in the system structure.  The correct solution, in my opinion, is not to physically delete the folder entry, as long as there are links to it in the system and there are some files in it.  We clean files, we clean communications, and after that - please, delete.  Otherwise, you can get glitches in dependent modules. <br><br>  5) Each folder must have its own identifier.  The names of different folders in different nodes can be duplicated, but identifiers are not.  When programming a system, when a user creates a File element on a web page, in this element he always indicates the folder identifier, and it is in this folder that the system will save the files attached to this module through this element. <br><br>  6) The rights of the default folder.  When a user views a folder, the system must first check the records for this folder as a user, if there are at least some rights settings (be it rights to everything, or vice versa prohibit all actions) then these rules should be applied, but if nothing is written, then must enter the rules set by the folder creator. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In my development, the system of rights to folders, I integrated the folders into the general system of rights and for the company administrator, adding folders to the user's role should not cause problems (as an example, the implementation of access rights to system elements can be read </font></font><a href="https://erp-platforma.com/help/help_h.php%3Fm%3D87%26g34%3D3%26id_g34%3D89%26v%3D1%26i%3D2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an elegant solution </font><u><font style="vertical-align: inherit;">for linking a file with a page element</font></u><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary to calculate the hash amount, in which there should be a unique identifier of the page element, and the page data (for example, the project or task number). This hash will always be unique and should be stored in the data record of the file. When loading the page at the moment of displaying the ‚Äúwindow‚Äù, this binding hash should be calculated and it will be searched for files and output to the page of their list.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, the ‚Äúwindow‚Äù must know the directory in which the new files are to be added. </font></font><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Records hashtags to files</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . There are no problems with custom (arbitrary) hashtags, you need to make the user, when adding a file (or when editing it), the ability to make notes to the file.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More complex with system hashtags. For example, in each file to be added to the task it is necessary to put the tag ‚Äú#Test No.‚Ä¶ #‚Äù. Then, in the Tasks folder, the user, entering in the search box, for example, ‚Äú‚Ññ ... #‚Äú, will receive all the files of the task of interest. I have this functionality implemented at the programming language level, in the properties of the File element of the form (in the article I called it the ‚Äúwindow‚Äù). In its properties, you can specify a string with identifier elements, and associate these elements with the required data source. The rest of the system will build automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, as a nice bonus, you can consider a special case of a file game with blob fields - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Image Storage System</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At some point, in the development of an internal programming language, I was faced with the need to introduce a non-standard data type. There are different data types, integer, varchar, timestamp, etc. But there is no image type in the databases. A need. For example, it is very convenient to take and request to display a table in which there will be images, for example, up and down arrows to move data, delete data, etc. So that everything is already in the database and processed at the base level, and not to fence something in the user interface each time. For example, I can display such things in one query:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dac/e3f/567/dace3f567e351868d8ec312a82f4f574.png" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is possible due to the use of blob fields. In addition to the file storage table, you can create, for example, an IMG table in the file base of the client and organize the storage of images there. At the physical level, in the database with this type, only the image identifier will be stored. When displaying data on the page, the interpreter script, having encountered the image data type, will use this ID to access the file database and display the image from the blob field. In this case, the user will not see all this internal kitchen. He will simply indicate in the output of the procedure a parameter with type image and make in the procedure a query that displays a table field with type image in this parameter. Very convenient mechanism. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this cycle for the database until I finish.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If there are suggestions for improving the mechanisms described in the article, or alternatively organizing the storage of files with similar capabilities, write comments. </font></font></div><p>Source: <a href="https://habr.com/ru/post/319418/">https://habr.com/ru/post/319418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319406/index.html">Through thorns to the clouds: creating a cloud service for 3D design and design of premises based on the C3D and WebGL core</a></li>
<li><a href="../319408/index.html">How to become a product manager. Part 4 about Data Science and ASO</a></li>
<li><a href="../319410/index.html">Dynamic network traffic redirection</a></li>
<li><a href="../319414/index.html">Training acid battery somehow and do it yourself</a></li>
<li><a href="../319416/index.html">Juniper firewall update unauthorized root access to devices</a></li>
<li><a href="../319422/index.html">Cooking ORM, without departing from the plate. We generate SQL - query based on binary expression trees</a></li>
<li><a href="../319424/index.html">Graal and Truffle (Graal & Truffle)</a></li>
<li><a href="../319426/index.html">Who posted the 10 millionth comment? Secrets of numerology</a></li>
<li><a href="../319430/index.html">HPE Synergy Pro - Part V. Control</a></li>
<li><a href="../319436/index.html">tiny-dnn - library announcement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>