<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Promise.allSettled</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the 71st Ecma TC39 rally, the project and reference implementation of Promise.allSettled , the third of four major promise combinators, will be con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Promise.allSettled</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/uv/aw/cs/uvawcsdiwezkodeumjjgmsppcnu.jpeg"></p><br><p> At the 71st Ecma TC39 rally, the project and reference implementation of <code>Promise.allSettled</code> , the third of four major promise combinators, will be considered. </p><br><p>  <strong>Authors</strong> : Jason Williams (BBC), Robert Pamley (Bloomberg), Mathias Beinens (Google) <br>  <strong>Champion</strong> : Mathias Beinens (Google) <br>  <strong>Stage</strong> : 3 </p><br><p>  For fans of podcasts, duplicated <a href="https://www.youtube.com/watch%3Fv%3Djy5JhorT79k">on YouTube</a> . </p><a name="habracut"></a><br><h1 id="vvedenie-i-motivaciya">  Introduction and Motivation </h1><br><p>  There are four main combinators in the world of promises: </p><br><ul><li>  <code>Promise.all</code> .  ES2015.  Closes on the first rejected promise. </li><li>  <code>Promise.race</code> .  ES2015.  Closes the ground at least somehow resolved / settled promise. </li><li>  <code>Promise.any</code> .  Stage 1. Closes at the first satisfied promise. </li><li>  <code>Promise.allSettled</code> .  Stage 3 ‚Üí Stage 4. Does not close. </li></ul><br><p>  All of them are widely represented in regular user libraries, each of them is useful in itself and is suitable in different situations. </p><br><p>  The main use of <em>this</em> combinator comes when you want to perform an action immediately after the completion of multiple requests, regardless of whether they ended in success or failure.  The remaining promise combinators close ( <em>short-circuit</em> ), discarding the results of incoming values ‚Äã‚Äãthat lost in the race after a certain system state.  <code>Promise.allSettled</code> is unique in that it always expects everyone for whom it is responsible. </p><br><p>  <code>Promise.allSettled</code> returns a promise, which is performed with the return of an array of snapshots of promise states, but only after all the original promises are resolved (settled). </p><br><h1 id="otkuda-vzyalos-nazvanie-allsettled">  Where did the name allSettled come from? </h1><br><p>  We say that the promise is <em>settled</em> , if it is not suspended <em>pending</em> , i.e.  when he is either satisfied or rejected - one of two things.  To understand the terminology, take a look at the old <a href="">States and Fates</a> document. </p><br><p>  And yet, this name, <code>allSettled</code> , is widely used in existing libraries that implement this functionality.  The list will be below. </p><br><h1 id="primery">  Examples </h1><br><p>  Imagine you need to iterate over an array of promises and return a new value with a known status (which occurs in any of two possible branches of logic). </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reflect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.then( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'fulfilled'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: v }; }, (error) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'rejected'</span></span>, <span class="hljs-attr"><span class="hljs-attr">reason</span></span>: error }; } ); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> promises = [ fetch(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>), fetch(<span class="hljs-string"><span class="hljs-string">'https://does-not-exist/'</span></span>) ]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> results = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all(promises.map(reflect)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> successfulPromises = results.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.status === <span class="hljs-string"><span class="hljs-string">'fulfilled'</span></span>);</code> </pre> <br><p>  The proposed API allows the developer to process these options, without the need to create a function to <code>reflect</code> independently, or to store the results in temporary variables.  The new API looks like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> promises = [ fetch(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>), fetch(<span class="hljs-string"><span class="hljs-string">'https://does-not-exist/'</span></span>) ]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> results = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.allSettled(promises); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> successfulPromises = results.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.status === <span class="hljs-string"><span class="hljs-string">'fulfilled'</span></span>);</code> </pre> <br><p>  If for some reason we need rejected promises, then we probably need to collect the reasons for what happened.  <code>allSettled</code> makes it just as easy to do this. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> promises = [ fetch(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>), fetch(<span class="hljs-string"><span class="hljs-string">'https://does-not-exist/'</span></span>) ]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> results = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.allSettled(promises); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> errors = results .filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.status === <span class="hljs-string"><span class="hljs-string">'rejected'</span></span>) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.reason);</code> </pre> <br><h1 id="realnye-primery">  Real examples </h1><br><p>  Quite common is the desire to know that all requests have been completed, regardless of the state of each of them.  This is important when you want in the future to do a gradual improvement.  We do not always need to get a response from the API. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> urls = [ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requests = urls.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> fetch(x)); <span class="hljs-comment"><span class="hljs-comment">// , -    ,  - - . //        ,   . try { await Promise.all(requests); console.log('  ,    .'); } catch { console.log('-    ,     . .'); }</span></span></code> </pre> <br><p>  Using <code>Promise.allSettled</code> you can write something that more closely matches our expectations. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,     API  . Promise.allSettled(requests).finally(() =&gt; { console.log('  :    ,   '); removeLoadingIndicator(); });</span></span></code> </pre> <br><h1 id="polzovatelskie-realizacii">  Custom implementations </h1><br><ul><li>  <a href="https://www.npmjs.com/package/promise.allsettled">https://www.npmjs.com/package/promise.allsettled</a> </li><li>  <a href="https://www.npmjs.com/package/q">https://www.npmjs.com/package/q</a> </li><li>  <a href="https://www.npmjs.com/package/rsvp">https://www.npmjs.com/package/rsvp</a> </li><li>  <a href="http://bluebirdjs.com/docs/api/reflect.html">http://bluebirdjs.com/docs/api/reflect.html</a> </li><li>  <a href="https://www.npmjs.com/package/promise-settle">https://www.npmjs.com/package/promise-settle</a> </li><li>  <a href="">https://github.com/cujojs/when/blob/master/docs/api.md#whensettle</a> </li><li>  <a href="https://www.npmjs.com/package/es2015-promise.allsettled">https://www.npmjs.com/package/es2015-promise.allsettled</a> </li><li>  <a href="https://www.npmjs.com/package/promise-all-settled">https://www.npmjs.com/package/promise-all-settled</a> </li><li>  <a href="https://www.npmjs.com/package/maybe">https://www.npmjs.com/package/maybe</a> </li></ul><br><h1 id="v-drugih-yazykah">  In other languages </h1><br><p>  Similar functionality exists in other languages, under different names.  Since there is no universal mechanism that is compatible with many languages ‚Äã‚Äãat once, this document follows the names of the libraries listed above.  Here‚Äôs how it looks in other languages: </p><br><ul><li>  Rust - <code>futures::join</code> ; </li><li>  C # - <code>Task.WhenAll</code> .  You can use either try / catch or <code>TaskContinuationOptions.OnlyOnFaulted</code> ; </li><li>  Python - <code>asyncio.wait</code> with the <code>ALL_COMPLETED</code> option </li><li>  Java - <code>CompletableFuture.allOf</code> </li></ul><br><h1 id="materialy-dlya-dalneyshego-izucheniya">  Materials for further study </h1><br><ul><li>  <a href="https://www.bennadel.com/blog/3289-implementing-q-s-allsettled-promise-method-in-bluebird.htm">https://www.bennadel.com/blog/3289-implementing-qs-allsettled-promise-method-in-bluebird.htm</a> </li><li>  <a href="">https://github.com/domenic/promises-unwrapping/blob/master/docs/states-and-fates.md</a> </li><li>  <a href="http://exploringjs.com/es6/ch_promises.html">http://exploringjs.com/es6/ch_promises.html</a> </li><li>  <a href="https://github.com/kriskowal/q/issues/257">https://github.com/kriskowal/q/issues/257</a> </li></ul><br><h1 id="minutki-so-vstrech-tc39">  Minutes from TC39 meetings </h1><br><ul><li>  <a href="https://tc39.github.io/tc39-notes/2018-09_sept-27.html">September 2018</a> </li><li>  <a href="https://tc39.github.io/tc39-notes/2019-01_jan-30.html">January 2019</a> </li><li>  <a href="">March 2019</a> </li><li>  July 2019 - coming soon </li></ul><br><h1 id="specifikaciya">  Specification </h1><br><ul><li>  <a href="https://github.com/tc39/proposal-promise-allSettled/blob/master/spec.html">Ecmarkup source</a> </li><li>  <a href="https://tc39.github.io/proposal-promise-allSettled/">In the form of HTML</a> </li></ul><br><h1 id="realizacii">  Implementations </h1><br><ul><li>  <a href="https://bugs.chromium.org/p/v8/issues/detail%3Fid%3D9060">V8</a> , Chrome 76 </li><li>  <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D1539694">SpiderMonkey</a> , Firefox 68 Nightly </li><li>  <a href="https://bugs.webkit.org/show_bug.cgi%3Fid%3D197600">JavaScriptCore</a> , Safari TP 85 and Safari 13 Beta </li><li>  <a href="https://github.com/microsoft/ChakraCore/pull/6138">Chakra</a> </li><li>  <a href="https://www.npmjs.com/package/promise.allsettled">Basic polyfill</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459970/">https://habr.com/ru/post/459970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459958/index.html">Parsing tasks from the Hydra conference - load balancing and in-memory storage</a></li>
<li><a href="../45996/index.html">Password is not long enough</a></li>
<li><a href="../459964/index.html">8 simple UI techniques to make the design prototype dynamic, without resorting to animation</a></li>
<li><a href="../459968/index.html">What really happened to the missing Malaysian Boeing (part 3/3)</a></li>
<li><a href="../45997/index.html">Benefit from Habr?</a></li>
<li><a href="../459972/index.html">Development for Docker. Local environment. Part 1</a></li>
<li><a href="../459976/index.html">New build Nemesida WAF Free for NGINX</a></li>
<li><a href="../459978/index.html">Node.js developer tools. Remote procedure call on web sockets</a></li>
<li><a href="../459980/index.html">High tech Nigerian letters</a></li>
<li><a href="../459982/index.html">Roslyn Analyzers. How to write code quickly and accurately</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>