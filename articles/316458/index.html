<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Queues and locks. Theory and practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We exhaled after HighLoad ++ and continue to publish the best reports of the past. HighLoad ++ turned out great, the number of organizational improvem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Queues and locks. Theory and practice</h1><div class="post__text post__text-html js-mediator-article">  We exhaled after <a href="http://highload.ru/">HighLoad ++</a> and continue to publish the best reports of the past.  HighLoad ++ turned out great, the number of organizational improvements spasmed into a new product quality.  Habr, by the way, led the text translation from the conference ( <a href="https://habrahabr.ru/post/314396/">first</a> , <a href="https://habrahabr.ru/post/314442/">second</a> days). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a37/558/5cb/a375585cbb4e4230884153111b8c1bdb.jpg" alt="Alexander Kalendarev"><br><br><h2>  Alexander Calendarev ( <a href="https://habrahabr.ru/users/akalend/" class="user_link">akalend</a> ) </h2><br>  Dear colleagues!  My report will be about the thing, without which not a single HighLoad project can do - about the queue server, and if I have time, I‚Äôll tell you about the blocking (the decryptor‚Äôs note had time :). <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/273/aa8/a6a/273aa8a6a43a06678364c473a7a08aa8.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What will the report be about?  I will tell you about where and how queues are used, why all this is needed, I will tell you a little bit about protocols. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/abe/8f0/ae3/abe8f0ae36a3ce95614259e321e58ade.png"><br><br>  Since  Our conference calls HighLoad Junior, I would like to go from the Junior project.  We have a typical Junior project - this is some kind of web page that accesses the database.  Maybe this is an electronic store or something else there.  And so, the users went and went to us, and at some stage we got a mistake (maybe another error): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f0/322/aa9/7f0322aa988b3c68ac7ec4f152ee9c51.png"><br><br>  We climbed the Internet, began to explore how to scale, we decided to get backends. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6e2/855/7c8/6e28557c8d6bdb4d6a1b45ecdd57f0a3.png"><br><br>  More users and more users went, and we had another mistake: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/679/6a0/69a/6796a069abb612378da04fcc5da32f57.png"><br><br>  Then we got into the logs, looked at how you can scale the SQL-server.  Found and made replication. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/142/e60/249/142e602494bc6d3c90c2c68f22fbce35.png"><br><br>  But here we got errors in MySQL: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a7/59a/349/4a759a3498fa6b666315174a51a8b55a.png"><br><br>  Well, errors can be in simpler configurations, I showed it here figuratively. <br><br>  And at this moment we begin to think about our architecture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/acb/3d0/f83/acb3d0f833e4f020c7c2e44c541b4326.png"><br><br>  We view our architecture ‚Äúunder the microscope‚Äù and single out two things: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/075/344/c04/075344c048dd68d17c561bfd6e333bf9.png"><br><br>  The first is some critical elements of our logic that need to be done;  and the second - some slow and unnecessary things that can be put off until later.  And we are trying to divide this architecture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d08/6a6/2c0/d086a62c03ddcdd23aad6bfff6c153c7.png"><br><br>  We divided it into two parts. <br><br>  We try to put one part on one server, and another part on another.  I call this pattern a ‚Äúcunning student‚Äù. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f4/cd7/b5b/8f4cd7b5b61efa5aeab1f2f6b9964e01.png"><br><br>  I myself once ‚Äúsuffered‚Äù with it: I told my parents that I had already done my homework and ran for a walk, and the next day I read these homework before homework and told the teachers in two minutes. <br><br>  There is a more scientific name for this pattern: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/58c/9a4/f74/58c9a4f741fb00773c87982b03c58f67.png"><br><br>  And in the end we come here to this architecture, where there is a web server and a backend server: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/063/3d6/5a4/0633d65a4c04bd72d33e973c974522e5.png"><br><br>  Between themselves, they must somehow bind.  When these are two servers, it is made easier.  When there are several, it is a little more complicated.  And we wonder how to connect them?  And one of the solutions of communication between these servers is a queue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f33/5c7/ae7/f335c7ae7091ec54bd8daf511563a6b8.png"><br><br>  What is the queue?  The queue is a list. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/961/2a5/566/9612a5566dc622ba94d1c47fc30b09fd.png"><br><br>  There is a longer and tedious, but this is just a list where we write the elements, and then we read them and delete them, we execute them.  The list goes on, the elements are reduced, the queue is so regulated. <br><br>  Moving on to the second part - where and how is it used?  Once I worked in such a project: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/176/f8d/0f5/176f8d0f53b1802f68f4cca098fffc22.png"><br><br>  This analogue of Yandex.Market.  In this project, there are a lot of different services.  And these services somehow had to be synchronized.  They synchronized through the database. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c3/54e/143/9c354e143b7ed61cc4bd1301ffd43566.png"><br><br>  How is the queue on the database? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/d02/529/fa7d02529295cbad89c1a75fe4027346.png"><br><br>  There is a certain counter - in MySQL it is an auto-increment, in Postgress this is realized through Sikkens;  there is some data. <br><br>  Write the data: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f65/4bf/88f/f654bf88fae2b4c6ce8f6b626760a66f.png"><br><br>  We read data: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/672/774/ba6/672774ba67531b25b6c2140b6635316b.png"><br><br>  We remove from the queue, but for complete happiness you need lock'i. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d63/5f0/d46/d635f0d46046ef7bd4a53a8623d0f76c.png"><br><br>  Is it good or bad? <br><br>  It is slow.  My given pattern for this does not exist, but in some cases many people make a queue through the database. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b2e/7bd/4c3/b2e7bd4c3ffb2829c3625a7736b166b0.png"><br><br>  First, through the database you can store history.  Then the deleted field is added, it can be both flag and timestamp to write.  My colleagues through the line do the communication, which goes through the affiliate network, they record banners - how many clicks, then they have analytics on Vertic find clusters, which groups of users respond to which banners more. <br><br>  We use MongoDb for this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/389/84a/be3/38984abe3ec2fab7e781ef00cde759ba.png"><br><br>  In principle, everything is the same, only some collection is used.  We write to this collection, we read from this collection.  With deletion - read the item, it is automatically deleted. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ec/3cf/66f/6ec3cf66f7d87f00fb86572c4a007ef6.png"><br><br>  It is also slow, but still faster than DB.  For our needs, we use it in statistics, this is normal. <br><br>  Further, I worked in such a project, it was a social toy - ‚Äúone-armed bandit‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c00/33c/604/c0033c604f95bc064979f7c13370e550.png"><br><br>  Everyone knows, you press a button, our drums are spinning, coincidences fall out.  The toy was implemented in PHP, but I was asked to refactor it because our database could not cope. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b5c/7dd/d4b/b5c7ddd4be03918ce567ae400e6bebcc.png"><br><br>  I used Tarantool for this.  Tarantool in a nutshell is key value storage, it is now closer to document-oriented databases.  The operational cache was implemented on my Tarantool, it only slightly helped.  We decided to organize all this through a queue.  Everything worked fine, but once we have it all fell.  The backend server fell.  And in Tarantool, queues began to accumulate, user data accumulate, and memory overflowed because this is Memory Only storage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c48/d3f/64c/c48d3f64c3da12d63c12135b762e3e3b.png"><br><br>  Memory overflowed, everything fell, user data lost in half a day.  Users are a little unhappy, somewhere they played something, lost, won.  Who has lost, to that well, who has won - to that is worse.  What is the conclusion?  It is necessary to do monitoring. <br><br>  What is there to monitor?  The length of the queue.  If we see that it exceeds the average length every 5 or 10, 20 times, then we have to send an SMS - we have such a service done on Telegram.  Telegram is free, SMS still costs money. <br><br>  What else does Tarantool give us?  Tarantool is a good solution, there is a sharding out of the box, replication out of the box. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/04c/66a/93e/04c66a93ed7e09eaace0b8d4c1bca8d7.png"><br><br>  Even in Tarantool there is a wonderful package with Queue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/83c/41f/5f4/83c41f5f4c5b65e141bb9bccad8ac4f5.png"><br><br>  What I implemented was 4-5 years ago, then there was no such package yet.  Now there is a very good API for Tarantool, if anyone is using Python, they have an API, generally honed under the queue.  I myself have been in PHP since 2002, 15 years already.  Developed a module for Tarantool in PHP, so PHP is a little closer to me. <br><br>  There are two operations: writing to a queue and reading from a queue.  I want to draw attention to this tsiferka (0.1 blue on the slide) - this is our timeout.  And, in general, there are two approaches to the approach to writing backend scripts that parse the queue: synchronous and asynchronous. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f93/c3e/48c/f93c3e48c12a6e0c5e6da1533046e47d.png"><br><br>  What is a synchronous approach?  This is when we read from the queue and, if there is data, then we process it, if there is no data, then we get up in the lock and wait for the data to come.  The data came, we went read further. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a8/26c/22b/7a826c22b40b3905950baf60c2608b8a.png"><br><br>  Asynchronous approach, as is clear, when there is no data, we went further - either we read from another queue, or we do some other operations.  If necessary, wait.  And again we go to the beginning of the cycle.  Everyone understands everything is very simple. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1de/4cd/e33/1de4cde334cd7b582bd03207fcee73aa.png"><br><br>  What kind of buns do we give the package Queue?  There are queues with priorities, this I have not seen anywhere else among other servers of the queues.  There you can still set the life of an element of the queue - sometimes it is very useful.  Delivery confirmation - and that's it.  I spoke about synchrony and asynchrony. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a99/df5/ec8/a99df5ec8d748f604dae276bec91d0c8.png"><br><br>  Redis.  This is our zoo, where there are many different data structures.  The queue is implemented on the lists.  What are good lists?  They are good because the access time to the first element of the list or to the last one occurs in constant time.  How is the queue implemented?  From the beginning of the list we write, from the end of the list we read.  You can do the opposite, it does not matter. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/52c/b7e/cb4/52cb7ecb4439391be5ebd8bbce25c5f0.png"><br><br>  I worked in a toy.  This toy was written on VKontakte.  The classic implementation was, the toy worked fast, the flash drive communicated with the web server. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b6/ee1/605/5b6ee1605788f91349843240b2a85886.png"><br><br>  Everything was fine, but once we were told from above: ‚ÄúLet's use statistics, our partners want to know how many units we bought, which units we buy most, how many we have left and from what level of users, etc.‚Äù.  And they suggested that we not reinvent the wheel and use external statistics scripts.  And everything was wonderful. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/964/dff/474/964dff474fb4013fd786739685548f33.png"><br><br>  Only my script worked 50 ms, and when they turned to the external script, there was some kind of America, it was at least 250 ms, and then more than 2 seconds ping went there.  Accordingly, the whole toy is frozen. <br><br>  We applied the following scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c23/faa/fa6/c23faafa6456cfdb489af07e9ffbc66f.png"><br><br>  And everything was good, everything worked quickly.  But once our admin went on vacation.  The admin went on vacation, everything was fine the first week, and a week later we learned that Redis was flowing.  Redis flows, there is no admin, we come in, we look at the console in the morning, we look at how much memory is left, how much is left before the swap'a, sighing: "Oh, how good, you have carried by today."  On Friday, many users came to us, especially after lunch, there was not enough memory. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc2/616/15a/fc261615aff92e726c98e569b03b6bc6.png"><br><br>  The conclusions are the same as with Tarantool.  Another project, the same mistakes.  Memory needs to be monitored.  The queue length needs to be monitored.  Everybody says a lot about monitoring, I will not repeat. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e74/56f/637/e7456f6379ca48716bdd6dc4ac805e20.png"><br><br>  In Redis, you can also perform both blocking and non-blocking read operations;  Count operation is needed just for monitoring. <br><br>  Somehow I also worked remotely in the project of downloading videos from popular video hosting sites: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/08a/751/729/08a751729a6e2a2587076aad54b576f1.png"><br><br>  What is the problem with this project?  The fact is that if we upload a video, then we convert it, if the video is slightly longer, the web client just falls off.  Applied this scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/97a/4f8/504/97a4f850418a083ea5e30c2aee915d46.png"><br><br>  Everything is good with us.  Upload the file.  But the queue works for us only in one direction, and we have to inform our web script - the file has already been downloaded. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/da0/d0c/8f4/da0d0c8f448b1dc4f4a5ba9234cb16c7.png"><br><br>  How it's done?  This is done in two ways. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75c/61d/733/75c61d733053f68058e91a125566d2a7.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/85c/873/810/85c873810e4f4632541ecdc78aaa15f0.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f8/a46/46d/5f8a4646d4bd4dab5bf44c96c0995440.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/050/edc/27e/050edc27e96f0d3ccdfcdb5d23fb3b94.png"><br><br>  First, we check the status through some specific timeout.  What could be the status?  This is the keyvalue repository - it is better to take the same Redis.  Key can serve any MD5 hash from our URL.  And after we convert, we write the status in the keyvalue.  The status can be: "completed", "converted", "not found" or something else.  After a second, after some timeut, the script will request the status, see what is done or not done, show everything to the client.  All clear.  This is the first way we used pooling. <br><br>  The second is web sockets. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ece/bc3/7f0/ecebc37f0505f36bdfd43c88957b1c8d.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c39/1ad/d03/c391add03a00c91111a15897a658e833.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/071/a0c/cc0/071a0ccc079c2029fff3814df5f3e527.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/551/8d1/e38/5518d1e38763d7d109d84dfed7b02130.png"><br><br>  We load the file - this is the second way.  These are subscriptions.  Here, just, used web sockets. <br><br>  How it's done?  As soon as we started downloading, we immediately subscribe to the channel in Redis.  If there it was possible, say, to use memcahed or something else, if we did not use Redis, then it is tied to Redis.  Subscribe to a channel, the name of the channel.  Roughly speaking, the same MD5 hash from the URL. <br><br>  As soon as we uploaded the file, we take and push into the channel, that we have the status "fulfilled" or the status "not found".  And immediately instantly with us, Push gives status to a web script.  After that, download the file if it is found. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/186/9bd/670/1869bd6705032d33be65b3df70e3d869.png"><br><br>  Not quite directly, some such scheme. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0bd/8c4/add/0bd8c4add19aed0ffe0b6a095fd303e7.png"><br><br>  How it's done?  There is a certain source of data - the temperature of the volcano, the number of stars visible in telescopes, directed by NASA, the number of deals for specific stocks ... We accept this data, and our background script, which received this data, pulls them into a certain channel.  Our web script is via a web socket, JS nodes are usually used, subscribes to a certain channel, as soon as data is received there, it sends this data to a client script via a web socket, and they are displayed there. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/028/620/c47/028620c47e23072d906eae6f9a654c96.png"><br><br>  There is such a solution - MamecachedQ.  This is a rather old solution, I would say, one of the first.  It was spawned by using Mamecached and BerkeleyDb, this is an embedded, one of the earliest, keyvalue repository. <br><br>  What is interesting about this decision?  By using the Mamecached protocol. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b51/3b2/2c1/b513b22c17b32b7a8ae372e070eaa966.png"><br><br>  What is the big minus - we are not able to understand the queue length here.  What I said is monitoring is needed, but there is no monitoring here. <br><br>  Speaking of queues, one can not say about the Zerro MQ. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/693/f7f/320/693f7f320619c8777f3c47af77a80e3c.png"><br><br>  Zerro MQ is a good and fast solution, but it is not a queuing broker, it must be understood.  This is just an API, i.e.  we connect one point to another point.  Or one point with many points.  But there are no queues, if one of the points disappears, then some data will be lost.  Of course, I can write the same broker on the same Zerro MQ and realize it ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e82/70e/713/e8270e713f4271ed49e2fe4ee1fb439e.png"><br><br>  Apache Kafka.  Somehow I tried to use this solution.  This is a decision from the hadoop stack.  It is, in principle, a good, high-performance solution, but it is needed where there is a large flow of data and it needs to be processed.  And so, I would use lighter solutions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/217/937/fdc/217937fdc307a3f9913a0954565a858d.png"><br><br>  It needs to be configured for a very long time, synchronized via Zookepek, etc. <br><br>  Protocols.  What are protocols? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b74/d8d/06b/b74d8d06bd0c474ef27f504c0a053ff1.png"><br><br>  I showed you a bunch of all sorts of decisions.  The IT community thought and said: ‚ÄúWhat are we all reinventing bicycles, let‚Äôs lead us to the whole thing.‚Äù  And invented protocols.  One of the earliest protocols is STOMP. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b91/8cb/0e5/b918cb0e5dd5cc74de8ef79e92dfa128.png"><br><br>  His description covers everything that can be done with queues. <br><br>  The second protocol, MQTT, is the Message Queue Telemetry Transport protocol. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/07e/294/98f/07e29498fa30f1aed8b85cc9caf60272.png"><br><br>  It is binary, as opposed to STOMP, covers, in principle, all the same functionality as STOMP, but more quickly due to the fact that binary. <br><br>  Here are the most prominent representatives, the queue broker, who work with protocols: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/649/441/016/6494410163335927b2092fd47cc4aa09.png"><br><br>  ActiveMQ uses all three protocols, even four (there is one more).  RabbitMQ uses three protocols;  Qpid uses Q and P. <br><br>  Now briefly about AMQP - Advanced Message Queuing Protocol. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f03/33a/4fa/f0333a4fabb463e5a7e8d74fa7a64f32.png"><br><br>  If you talk about it for a long time, then you can talk about its features for an hour and a half, no less.  I am brief.  We will present a broker as an ideal postal service.  Exchange - this will be the mailbox of the sender where the message arrives. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dbb/854/cec/dbb854ceca687ed232b2b91ce53fe3e1.png"><br><br>  This Exchange has type, properties. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/13c/6ca/261/13c6ca261b4c7f74f70c8b82c8033612.png"><br><br>  Here it is written in PHP how to declare it.  By the way, I also developed this driver. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a1/c7f/3d7/4a1c7f3d71decc823b17020b3ae555d9.png"><br><br>  Once there is a sender's box, we must have a recipient's box.  The recipient's box has such a feature that we can take only one letter for one appeal.  The recipient's box also has a name, a property.  Something like this should be declared: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c8e/ce9/46f/c8ece946f1191ab343c5f8ed5e498d9f.png"><br><br>  Between the sender's box and the recipient's box, you need to build a route along which the postmen will run and carry our letters. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ef2/49d/e22/ef249de2254986635999dd6276000d0b.png"><br><br>  This route is determined by the routing key. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d06/593/754/d065937545a49cc5ea4d22f1241469e1.png"><br><br>  When we declare a connection, we will definitely specify the routing key.  This is one of the ways to advertise. <br><br><p>  There is a second approach.  We can declare Exchange and make it Bind to the queue, i.e.  it is the opposite - we can make a connection from Exchange to Exchange or from Exchange to a queue, it makes no difference. <br><img src="https://habrastorage.org/getpro/habr/post_images/7fe/054/262/7fe054262f2ab1188053012c17f8df87.png"><br><br>  We have a message.  The message must necessarily specify routingKey, i.e.  This is the key that our postman will follow the route. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fcb/828/761/fcb8287618e1d406aaf13ae3eb483865.png"><br><br>  Our postmen can be of three types: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f4/32f/d04/6f432fd043e60203f6a534a42765b596.png"><br><br></p><ol><li>  The first type is blind postmen.  They cannot read the key; they run only along the route that we have laid for them.  These postmen are fleeing, and this <br>  the fastest postmen. <br></li><li>  Postmen of the second type can read a little, they check letters, but they don‚Äôt know how to ... They checked the letters, that the key of our message is the same and <br>  corresponding path, which run, and run along that path.  Those.  our recipient is purely on the key match. <br></li><li>  And the third kind of postmen is Topic.  We can set a mask, a mask is the same as in the file system, and according to this mask our postmen carry letters. <br></li></ol><br>  Approximately this is how messages are sent: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/001/367/0e6/0013670e6a3cfae5050c36220c4bd8db.png"><br><br>  What typical mistakes do we have? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c8/df0/bcf/5c8df0bcf45196d8f90e62abb9f8216e.png"><br><br>  Typical mistakes are that people often forget to define a connection.  Now the third Rabbit is more or less decent, it has a web interface, you can see everything through the web interface: what is announced there, which queues, what type they have, what exchange there is, what type they have. <br><br>  The second typical mistake.  When we declare a queue or exchange, they default to our autodelete - the session has ended, the queue was killed.  Therefore, it must be redeclared each time.  In principle, it is undesirable to do this, but it is better to make a permanent queue and still designate durable.  Durable is such a sign that if we have a queue durable, then after a RabbitMQ restart, we will have this queue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c9e/d97/88f/c9ed9788faa1c42ab96c652289c2a8a3.png"><br><br>  What can you say about RabbitMQ?  It is not very pleasant to administer, but it can be expanded if we know Erlang.  He is very picky from memory.  RabbitMQ works through Erlang's embedded solution, but it eats a lot of memory.  There are some plugins that work with other repositories, but I honestly did not work with them. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/142/064/8ab/1420648ab213952f0350c0384e04ca91.png"><br><br>  Here in this journal "System Administrator" I wrote an article "Rabbit in the sandbox" - there, in principle, the same thing that I told you here. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/532/398/6ca/5323986ca0a11a6142afd74148eee283.png"><br><br>  And in this article, I described more such interesting patterns, how to use RabbitMQ, what queues can be redirected there, for example, how to make it so that if the queue is not read, then this data is written to another queue, to the spare one, which can then read another script.  If possible, read. <br><br><h4>  Blocking </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/245/4bc/616/2454bc616dc7802e48a5617577b5e90b.png"><br><br>  I told about such a project at the very beginning.  If I did this project today, I would use microservices. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f61/a06/dfd/f61a06dfdfb3dc3199d5bcabbf7e8b0a.png"><br><br>  And microservices require synchronization as an interaction.  We use a tool like Apache Zookeeper for synchronization. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/404/5f9/0bc/4045f90bc16da78f1cad61c93caeeb0c.png"><br><br>  The Apache Zookeeper philosophy is based on znode.  Znode, by analogy with the file system element, has a certain path.  And we have the operation of creating a node, creating children of a node, receiving children, obtaining data and writing something to the data. <br><br>  Znode come in two types: simple and ephemeral. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5df/37a/b50/5df37ab506e9884f21fecedac8a39a7d.png"><br><br>  Ephemeral - these are znode, which, if our user session has died, then znode is destroyed, autodelete. <br><br>  Sequences are auto-increment znode, i.e.  these are znode, which have a certain name and auto-increment numeric prefix. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5f/48d/3a2/f5f48d3a2d0bbff5a2cd32ea446332dd.png"><br><br>  Using the configuration example on the fly, I‚Äôll tell you how it all works.  We have two groups of processes - a group of processes a and a group of processes b.  Processes 1 connect to processes 2 and somehow interact.  Processes 2, when started, write their configuration in Zookeeper. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c4/c20/d3b/9c4c20d3bf04d54c4370c68cc79c458f.png"><br><br>  Each process creates its own znode - the first process, the second, the third. <br><br>  And here we are one of the processes stopped or, for example, launched.  I have here on the example of stopping the processes shown: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a4/bbc/9dc/1a4bbc9dc873bfa6b6a69810c6968c22.png"><br><br>  Our process is stopped, the connection is broken, the znode is gone, the event is sent, that we listened to this znode, that there was one znode in it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c4/a3f/ba0/4c4a3fba01cada1d6c6c4573045a7ebf.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/382/b74/bb0/382b74bb08cfdb31452dab186657da29.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d37/bc9/1d1/d37bc91d1abda0bb4cfd12bae0ee4bfa.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ee/daa/6e8/9eedaa6e846c4bfda1b5c48af7d3ae32.png"><br><br>  Event is sent, we recalculate the configuration.  Everything works very nicely. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/339/191/1b3/3391911b329b1b99bab8e7437aae8194.png"><br><br>  Something like this is synchronized.  There are other examples, as someone synchronized there with backups. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e5/179/5fc/3e51795fc3c7ac4fbe68f6ed53037f2f.png"><br><br>  In this summary slide, I would like to demonstrate all the capabilities of the queue servers.  Where we have question marks is either a controversial point, or there simply was no data.  For example, the database we scale, right?  It is not clear, but, in principle, it scales.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But is it possible to scale the queues for them or not? </font><font style="vertical-align: inherit;">Basically, no. </font><font style="vertical-align: inherit;">Therefore, I have a question here. </font><font style="vertical-align: inherit;">On ActiveMQ I just have no data. </font><font style="vertical-align: inherit;">With Redis, I can explain - there is an ACL, but it is not quite correct. </font><font style="vertical-align: inherit;">You can say it is not. </font><font style="vertical-align: inherit;">Scaling Redis? </font><font style="vertical-align: inherit;">Through the client it is scaled, I have not seen such some elements, boxed solutions. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d3/c26/546/7d3c26546c6805bddd660a57d0035957.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Such are the conclusions:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary to use each tool for its intended purpose. </font><font style="vertical-align: inherit;">I talked a lot with different developers, RabbitMQ now uses only non-lazy, but in </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">most cases the same RabbitMQ can be replaced by Redis.</font></font><br><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speed ‚Äã‚Äãmultiplied by reliability. </font><font style="vertical-align: inherit;">What did I mean by that? </font><font style="vertical-align: inherit;">The faster the tool works, the less reliability it has. </font><font style="vertical-align: inherit;">But on the other hand, the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value of this constant may vary - this is my personal observation.</font></font><br><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, about the monitoring, there was a lot of talk before me and professionals. </font></font><br></li></ol><br><h3>  Contacts </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬ª </font></font><a href="https://habrahabr.ru/users/akalend/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akalend</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akalend@mail.ru</font></font></a> <br><br><blockquote>  <font color="gray">This report is a transcript of one of the best speeches at the training conference for developers of high-load systems <a href="http://junior.highload.ru/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad ++ Junior</a> .</font> <font color="gray"><br><br></font>  <font color="gray">Also, some of these materials are used by us in an online training course on the development of high-load systems <a href="http://highload.guide/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad.Guide</a> is a chain of specially selected letters, articles, materials, videos.</font>  <font color="gray">Already, in our textbook more than 30 unique materials.</font>  <font color="gray">Get connected!</font> <font color="gray"><br><br></font>  <font color="gray">Well, the main news is that we have begun preparations for the spring festival " <a href="http://ritfest.ru/">Russian Internet Technologies</a> ", which includes eight conferences, including <strong>HighLoad ++ Junior</strong> .</font> <font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, we are greedy merchants, but now we are selling tickets at cost price - you can catch up to the price increase :)</font></font></font> </blockquote><p></p></div><p>Source: <a href="https://habr.com/ru/post/316458/">https://habr.com/ru/post/316458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316444/index.html">ee javascript (run ReactOS in browser)</a></li>
<li><a href="../316448/index.html">Learning the gameplay cycle on the example of runners</a></li>
<li><a href="../316450/index.html">Overview of conferences we attended in 2016</a></li>
<li><a href="../316452/index.html">What is Microsoft Office 365 and how can it help the company?</a></li>
<li><a href="../316456/index.html">Deep Learning: Combining Deep Convolutional Neural Network with Recurrent Neural Network</a></li>
<li><a href="../316460/index.html">We write our programming language without moms, dads and bison. Part 0: Theory</a></li>
<li><a href="../316462/index.html">Development for Sailfish OS: Work with D-Bus</a></li>
<li><a href="../316464/index.html">Another method to reduce the volume of SPA applications (webpack)</a></li>
<li><a href="../316466/index.html">Microsoft encourages linux developers to try out Windows 10</a></li>
<li><a href="../316468/index.html">We publish the site in the interplanetary file system IPFS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>