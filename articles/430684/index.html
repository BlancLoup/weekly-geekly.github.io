<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Scanning Live Ethereum of Unchecked-Send Error Contracts. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuation of the article ‚ÄúScanning Live Ethereum of contracts for the error‚Äú Unchecked-Send ‚Äù. Part 1 " . 


 Almost a year ago (while Ethereum was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Scanning Live Ethereum of Unchecked-Send Error Contracts. Part 2</h1><div class="post__text post__text-html js-mediator-article"><h3></h3><p>  Continuation of the article <a href="https://habr.com/post/430602">‚ÄúScanning Live Ethereum of contracts for the error‚Äú Unchecked-Send ‚Äù.</a>  <a href="https://habr.com/post/430602">Part 1 "</a> . </p><br><p>  Almost a year ago (while Ethereum was in its ‚Äúborder‚Äù release), the popular lottery contract EtherPot <a href="https://github.com/etherpot/contract/issues/1">[9]</a> also suffered from the same error.  An earlier version of BTCRelay also showed this error <a href="https://cs.umd.edu/~amiller/BTCRelayAudit.pdf">[7]</a> .  Although a danger was discovered in a previous security audit, an incorrect patch was first applied <a href="http://martin.swende.se/blog/BTCRelay-Auditing.html">[8]</a> . </p><a name="habracut"></a><br><h3>  Unchecked-send error detection on live blockhain </h3><br><p>  How common are these errors?  Do you heed warnings?  Do best practices apply?  We answer these questions empirically by analyzing the block-chain Ethereum data, as well as the repository of the Solidity code repository found on etherscrape.com.  To do this, we are developing a simple software analysis tool that checks the block-chain contract and uses heuristics to check whether one of the most effective protection methods is being used.  Listing 2 shows the first protection technique, as recommended in the Ethereum documentation, which should check the return value of <strong>send</strong> and throw an exception.  To detect the use of this method, we use a rough approximation: we simply look to see if the return value of <strong>send is</strong> ignored or not. <br><br>  Listing 4 illustrates the second protection technique recommended in the UMD manual, which directly checks if the <strong>callstack</strong> is <strong>full</strong> by sending a test message.  To discover this technique, we again use a rough approximation: we simply check if a message is being sent in addition to the <strong>send</strong> command. <br><br>  If none of these heuristic indicators are present, we conclude that none of the best practice recommendations are followed.  We implement these heuristics using a simple pattern mapping with a compiled EVM byte code.  For more details on how we do this, see Appendix <a href="https://docs.google.com/document/d/1En0DjqmSpqVVxsdGAcJs4Rkw5IjxnUeTJMUVMhWum28/edit%3Fusp%3Dsharing">[12]</a> . </p><br><h3>  How many contracts are vulnerable? </h3><br><p>  We start by checking the heuristics in the Etherscrape repository of the Solidity source code.  As of March 20, 2016, Etherscrape retransmission contained 361 Solidity contract programs, 56 of which contained the send instruction.  Of these contract programs, we assume that most (at least 36 out of 56) do not use any of the protective programming methods. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Even if the contract does not use any of the security technologies, it may or may not have a real vulnerability.  We manually checked the Solidity contracts to confirm the presence of the vulnerability.  For our purposes, we consider a contract vulnerable if its state may change, even if the <strong>send</strong> command does not work (so we will look at the vulnerable code in Listing 5).  We confirmed that the vulnerability is present in the vast majority, 32 of 36 of these contracts. <br></p><br><p>  Similarly, our heuristics do not guarantee the correct application of defensive programming.  Take, for example, ‚ÄúWeiFund‚Äù, a decentralized open-source crowdfunding DApp.  <a href="http:/etherscrape.com/solidity/98">This contract</a> has two functions: <strong>refund ()</strong> and <strong>payout ()</strong> , which trick our heuristics.  The following is an excerpt from the <strong>refund</strong> . <br></p><br><p></p><pre><code class="plaintext hljs">function refund(uint _campaignID, uint contributionID) public { ... receiver.send(donation.amountContributed); donation.refunded = true; ... if(c.config != address(0)) WeiFundConfig(c.config).refund(_campaignID, donation.contributor, donation.amountContributed); }</code> </pre> <br><p>  In this code, the message is sent to WeiFundConfig (c.config) to call the refund method, but only under certain conditions.  If c.config is zero, then the contract is indeed vulnerable to a callstack attack.  When testing *, none of the Solidity programs that have passed our heuristic test have actually applied the recommended best practice of testing callstack directly.  * <br><br>  Then we turn our attention to contracts drawn up on the live block-chain Ethereum.  We looked at a snapshot of March 20, 2016 (time stamp: 1184243).  This snapshot contains a total of 13,645 block chains, which appear to be generated by the Solidity compiler, of which only 1,618 (11.8%) included the <strong>send</strong> command. <br><br>  Of these, the vast majority do not seem to use any of the defensive programming techniques. <br></p><br><p>  How about the recursive race problem in TheDAO?  The most exciting smart contract these days, TheDAO <a href="https://daohub.org/">[11]</a> , suffers from a completely separate error, which is that it is not ‚Äúsafe for reuse‚Äù <a href="http://hackingdistributed.com/2016/05/27/dao-call-for-moratorium/">[13]</a> .  This is another (related, but distinct) kind of insecure programming, which was also expected in previous security checks <a href="">[6]</a> , but probably still many contracts are unsafe today.  Future work was to make a tool that could also detect such an error. <br></p><br><h3>  Where did it all go wrong? </h3><br><p>  We do not expect that programming on smart contracts will be completely simple, at least for now.  However, it is surprising that this particular form of error is so common, in spite of the fact that it was described so long ago during the development of the Ethereum ecosystem. <br><br>  In a report in 2015 <a href="">[6],</a> this recommendation <a href="">was</a> given to the developers of Ethereum: " <br><br>  At present, the programming examples presented in the documentation are insufficient to disseminate advanced methods for writing safe contracts and solving problems with a gas mechanism.  Introductory tutorials in C ++ are often missed. <br>  error checking for readability, which led to numerous security errors.  Examples of Ethereum should teach the best habits.  Recommendation: Provide more examples of thorough programming of security contracts. " <br><br>  We only know one official answer to this question, which is to add a warning to the official Solidity documentation, mentioned earlier <a href="http://solidity.readthedocs.io/en/stable/types.html">[3],</a> repeated below: "There is some danger when using <strong>send</strong> : Transmission fails if the call stack depth is 1024 (this can always be caused by the caller), and also fails if the receiver runs out of gas. Therefore, to ensure the safe transmission of the air, always check the return value <strong>send</strong> or even better: use the pattern  in which the recipient withdraws money. " </p><br><p>  We believe that this remark is not enough to document the problem.  It offers only incomplete mitigation and describes only one option of danger, potentially misleading the reader about its degree. </p><br><ul><li><p>  Update: <br>  The inadequacy of the Solidity documentation has also been illustrated in detail by Peter Spring.  <a href="http://vessenes.com/ethereum-griefing-wallets-send-w-throw-considered-harmful/">[sixteen]</a> </p><br></li></ul><p>  In addition, the warning seems to be often ignored.  Therefore, we believe that additional preventive measures should be taken. </p><br><br><h3>  How can Etherscrape help? </h3><br><p>  We believe that using static analysis tools, even rough ones, such as those described in this message, can help improve the quality of intelligent contracts. At Etherscrape, we integrate analysis tools like this into our publicly accessible web service, and we add a link to the tool page when it is ready.  This will make it easier to view the code of an intelligent contract, highlighting the places where errors may occur.  We assume that users of such a smart contract (for example, potential investors in TheDAO or its offers) can easily use tools such as sanity checks before depositing their money.  Even non-technical investors can hold developers accountable for explaining how they reacted to the problems noted in the code. <br><br>  Etherscrape also helps by analyzing the public block chain and controlling the prevalence of this error, which can help in deciding, for example, how much money to allocate for research and development of static analysis tools.  In addition, compilers such as <strong>solc</strong> can integrate such analyzes, providing a warning to the programmer when an error seems probable. <br></p><br><h3>  Recommended literature </h3><br><ul><li>  [1] <a href="https://eprint.iacr.org/2015/460.pdf">Step-by-step Towards Creating a Safe Smart Contract</a> <br></li><li>  [2] <a href="https://mc2-umd.github.io/ethereumlab/docs/serpent_tutorial.pdf">UMD Programmer's Guide to Ethereum and Serpent (Section 5.14)</a> <br></li><li>  [3] <a href="http://solidity.readthedocs.io/en/stable/types.html">Official Ethereum Solidity Docs</a> <br></li><li>  [4] <a href="http://www.kingoftheether.com/postmortem.html">King of the Ether: Post-Mortem Investigation</a> <br></li><li>  [5] <a href="http://martin.swende.se/blog/Devcon1-and-contract-security.html">Swende on Contract Security</a> <br></li><li>  [6] <a href="">Least Authority audit of Ethereum</a> <br></li><li>  [7] <a href="https://cs.umd.edu/~amiller/BTCRelayAudit.pdf">BTC Relay Audit 1</a> <br></li><li>  [8] <a href="http://martin.swende.se/blog/BTCRelay-Auditing.html">BTC Relay Audit 2</a> <br></li><li>  [9] <a href="https://github.com/etherpot/contract/issues/1">EtherPot Security Bug Report</a> <br></li><li>  [10] <a href="https://forum.ethereum.org/discussion/comment/42100">Reentrant Contracts</a> <br></li><li>  [11] <a href="https://github.com/slockit/DAO">The DAO (Decentralized Autonomous Organization)</a> <br></li><li>  [12] <a href="https://docs.google.com/document/d/1En0DjqmSpqVVxsdGAcJs4Rkw5IjxnUeTJMUVMhWum28/edit">Appendix A: Details on how we analyze the blockchain</a> <br></li><li>  [13] <a href="http://hackingdistributed.com/2016/05/27/dao-call-for-moratorium/">A Call for a Temporary Moratorium on The DAO</a> <br></li><li>  [14] <a href="https://docs.google.com/document/d/1hbUte3HS8icIyXXenK2tnt-4UswMgpWit2coB_ALOko/edit%3Fusp%3Dsharing">Appendix B: Vulnerable Solidity Contracts</a> <br></li><li>  [15] <a href="https://docs.google.com/document/d/1dDSZjdbF6PA6x8uA8KS0EfEc0zleQA4049Jc-HKFwQY/edit%3Fusp%3Dsharing">Appendix C: Vulnerable Blockchain Contracts</a> <br></li><li>  [16] <a href="http://vessenes.com/ethereum-griefing-wallets-send-w-throw-considered-harmful/">Ethereum Griefing</a> <a href="http://vessenes.com/ethereum-griefing-wallets-send-w-throw-considered-harmful/"><br></a>  <a href="http://vessenes.com/ethereum-griefing-wallets-send-w-throw-considered-harmful/">Wallets: Send w / Throw Is Dangerous</a> <br></li></ul><br></div><p>Source: <a href="https://habr.com/ru/post/430684/">https://habr.com/ru/post/430684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430674/index.html">The logic of building universal work schedules</a></li>
<li><a href="../430676/index.html">Antiquities: shshsh, sssssss, VOIP, BBS and other modem friends</a></li>
<li><a href="../430678/index.html">Test ten dimmers with LED lamps</a></li>
<li><a href="../430680/index.html">Writing a simple processor and environment for it</a></li>
<li><a href="../430682/index.html">Three years of the lunar microsatellite project: stages of maturation</a></li>
<li><a href="../430686/index.html">Review: WAZER, the first desktop waterjet cutting machine</a></li>
<li><a href="../430688/index.html">Data transfer via animated QR to Gomobile and GopherJS</a></li>
<li><a href="../430690/index.html">Deterministic exceptions and error handling in the ‚ÄúC ++ future‚Äù</a></li>
<li><a href="../430694/index.html">A brief guide to learning C ++: what, when and what to create</a></li>
<li><a href="../430700/index.html">A unified online movie viewing system will start working in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>