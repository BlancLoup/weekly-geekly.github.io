<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are looking for java, runtime optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was very pleased to have read the articles: Optimization possibilities in C and C ++ languages and Development and execution speeds that are not ach...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are looking for java, runtime optimization</h1><div class="post__text post__text-html js-mediator-article">  I was very pleased to have read the articles: <a href="http://habrahabr.ru/post/182356/">Optimization possibilities in C and C ++ languages</a> and <a href="http://habrahabr.ru/post/182428/">Development and execution speeds that are not achievable in</a> <a href="http://habrahabr.ru/post/182356/">C.</a>  In them optimization in compilation is in details sorted.  The main condition for this optimization is the availability of the values ‚Äã‚Äãof most variables at the compilation stage.  In the real world, unfortunately, this is not always the case. <br><br>  Let's try to do something similar, but already in the process of program execution.  For this we use java, the execution system of which optimizes the code at the execution stage.  Plus, it allows you to create code on the fly. <br><br><a name="habracut"></a><br>  And so, the condition of the problem is similar - a linear search over an array of structures with filters.  I would like to get comparable execution time and memory consumption compared to C / C ++. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To represent our records, we use an array of longs and a wrapper class that allows us to conveniently work with them: <a href="">CashAccountRow</a> . <br><br>  The rest of the mechanics are concentrated in the <a href="">CashAccountStore</a> class. <br>  In the designer we fill our table.  CashAccountFinder provides a primitive DSL and generates a list of predicates.  Since, for comparison, the implementation is shown without code generation on the fly, the predicate contains the fieldGetter element. <br>  The compileList function converts a Map into an array and sorts it according to selectivity. <br><br>  Search without code generation: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CashAccountFinder finder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; CashAccountRow c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CashAccountRow(); finder.compileList(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ROW_COUNT; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(finder.isMatched(c.setBitStorage(accountRows[i]))) { ++rValue; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rValue; }</code> </pre> <br>  For code generation on the fly, use <a href="http://www.jboss.org/javassist">Javassist</a> .  The find2 function generates the name of the generated class for the search: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CashAccountFinder finder)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable</span></span>{ finder.compileList(); StringBuilder cname = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(CashAccountFinder.PredicateHolder p: finder.predicateHolderArray) { cname.append(p.field.toString()); }</code> </pre><br>  Checks whether a class has already been created for this set and predicate order: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(classMapper.containsKey(cname.toString())) { matcherBase = classMapper.get(cname.toString()); }</code> </pre><br>  If not, it creates a new class: <pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//     ClassPool classPool = ClassPool.getDefault(); //  classpath      // (     classloader', //      application ,   exec-maven-plugin ) classPool.insertClassPath(new ClassClassPath(this.getClass())); //    CtClass base = classPool.get("examples.data.GenMatcherBase"); //    CtClass gen = classPool.makeClass("examples.data.GenMatcher" + cname, base); //       StringBuilder sb = new StringBuilder("public boolean c(examples.data.CashAccountRow r){ return "); for(CashAccountFinder.PredicateHolder p: finder.predicateHolderArray) { switch (p.field) { case AGE: sb.append("r.getAge() &gt;= " + p.minValue + " &amp;&amp; r.getAge() &lt;= " + p.maxValue + " &amp;&amp; "); break; case AMOUNT: sb.append("r.getAmount() &gt;= " + p.minValue + " &amp;&amp; r.getAmount() &lt;= " + p.maxValue + " &amp;&amp; "); break; case CODE: sb.append("r.getCode() &gt;= " + p.minValue + " &amp;&amp; r.getCode() &lt;= " + p.maxValue + " &amp;&amp; "); break; case GENDER: sb.append("r.getGender() &gt;= " + p.minValue + " &amp;&amp; r.getGender() &lt;= " + p.maxValue + " &amp;&amp; "); break; case HEIGHT: sb.append("r.getHeight() &gt;= " + p.minValue + " &amp;&amp; r.getHeight() &lt;= " + p.maxValue + " &amp;&amp; "); break; } } sb.append("true; }"); //      gen.addMethod(CtMethod.make(sb.toString(), gen)); //      matcherBase = (GenMatcherBase) gen.toClass().newInstance(); classMapper.put(cname.toString(), matcherBase);</span></span></code> </pre><br>  Search: <br><pre> <code class="java hljs"> CashAccountRow c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CashAccountRow(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ROW_COUNT; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(matcherBase.c(c.setBitStorage(accountRows[i]))) { ++rValue; } }</code> </pre><br>  In the main run the search 2 times.  The first launch is needed to ‚Äúwarm up‚Äù, so that jit and inlining will work. <br><pre> <code class="java hljs"> System.out.println(<span class="hljs-string"><span class="hljs-string">"Warming up..."</span></span>); store.find2(finder); System.out.println(<span class="hljs-string"><span class="hljs-string">"Running benchmark..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> millis = System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = store.find2(finder); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> endMillis = System.currentTimeMillis();</code> </pre><br>  JVM: <br><pre> java version "1.7.0_21"
 Java (TM) SE Runtime Environment (build 1.7.0_21-b11)
 Java HotSpot (TM) 64-Bit VM Server (build 23.21-b01, mixed mode)
</pre><br>  The result of the launch on the Core I5-2500k 3.3GHz: <br><pre> Warming up ...
 Generated code:
 public boolean c (examples.data.CashAccountRow r) {return r.getAmount ()&gt; = 0 &amp;&amp; r.getAmount () &lt;= 0 &amp;&amp; r.getHeight ()&gt; = 0 &amp;&amp; r.getHeight () &lt;= 0 &amp;&amp; r .getGender ()&gt; = 0 &amp;&amp; r.getGender () &lt;= 0 &amp;&amp; true;  }
 Running benchmark ...
 Number of records matched: 38
 Elapsed time: 18ms
 Used Memory: 81MB
</pre><br>  The result of the program from the first article on the same machine: <br><pre> Generated rows: 10,000,000
 C ++ - Searching ...
 C ++ - optimized search took 0.039000 seconds.
 Found rows: 38
 C-Searching ...
 C-search took 0.053000 seconds.
 The C ++ faster than C: 1.358974 times
 Found rows: 38
</pre><br>  The result of the program from the second article on the same machine: <br><pre> Generated rows: 10,000,000
 C ++ - Searching ...
 C ++ - optimized search took 0.012000 seconds
 Found rows: 38
 C-Searching ...
 C-search took 0.051000 seconds.
 The C ++ faster than C: 4.250000 times
 Found rows: 38
</pre><br>  Almost on a par with the statically optimized C ++ version.  The code is available on <a href="https://github.com/scanban/java_search">GitHub.com</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/182788/">https://habr.com/ru/post/182788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182778/index.html">Technology of ‚Äúdrawn sound‚Äù: sound synthesis in the USSR of the 30s of the XX century</a></li>
<li><a href="../182780/index.html">Simple Android app framework</a></li>
<li><a href="../182782/index.html">HTML5 ASCII Art Generator</a></li>
<li><a href="../182784/index.html">Voxel graphics do-it-yourself - first steps</a></li>
<li><a href="../182786/index.html">Installing any clone of Red Hat Enterprise Linux without using a standard installer</a></li>
<li><a href="../182790/index.html">How in Ukraine to accept payments on PayPal in general (and when selling on eBay in particular)</a></li>
<li><a href="../182792/index.html">Replacing a system call handler</a></li>
<li><a href="../182794/index.html">LG Electronics TVs and DLNA protocol</a></li>
<li><a href="../182798/index.html">We are friends with Cisco IP Phone CP-7925G (WiFi), Cisco IP Conference Station CP-7937G, CP-3905G and Unified IP Phone CP-7965 with Asterisk</a></li>
<li><a href="../182802/index.html">Past and Future of JavaScript Compilation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>