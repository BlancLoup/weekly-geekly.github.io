<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installation of a certification authority in the enterprise. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And here is the final third part of our series of articles about the certification center at the enterprise. Today we will look at how to deploy certi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installation of a certification authority in the enterprise. Part 3</h1><div class="post__text post__text-html js-mediator-article">  And here is the final third part of our series of articles about the certification center at the enterprise.  Today we will look at how to deploy certificate services using Windows Server 2016 as an example. Let's talk about preparing a domain controller, preparing a web server, installing root and issuing certification authorities, and updating certificates.  Look under the cat! <br><br><img src="https://habrastorage.org/webt/l5/km/nm/l5kmnmr4vwebza_ffcfoxkghjam.jpeg"><a name="habracut"></a><br><br><blockquote>  <a href="https://habrahabr.ru/company/microsoft/blog/348944/"><i>The first part of the series</i></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://habrahabr.ru/company/microsoft/blog/348956/"><i>The second part of the series</i></a> </blockquote><br><h4>  Glossary </h4><br>  The following abbreviations and abbreviations have been used in this part of the series: <br><br><ul><li>  <b>PKI</b> ( <i>Public Key Infrastructure</i> ) is a public key infrastructure, a set of tools (technical, material, human, etc.), distributed services and components, used together to support crypto tasks based on private and public keys.  Since the abbreviation PKI is not common, hereafter, the more familiar English-language abbreviation PKI will be used. </li><li>  <b>X.509</b> is the <a href="">ITU-T standard</a> for public key infrastructure and privilege management infrastructure. </li><li>  <b>CA</b> ( <i>Certification Center</i> ) - a service that issues digital certificates.  A certificate is an electronic document confirming that the public key belongs to the owner. </li><li>  <b>CRL</b> ( <i>Certificate Revocation List</i> ) - certificate revocation list.  A signed electronic document published by the CA and containing a list of revoked certificates whose validity was terminated due to external reasons.  For each revoked certificate, its serial number, date and time of revocation, as well as the reason for revocation (optional) are indicated.  Applications can use the CRL to confirm that the certificate presented is valid and not revoked by the publisher ... Applications can use the CRL to confirm that the certificate presented is valid and not revoked by the publisher. </li><li>  <b>SSL</b> ( <i>Secure Sockets Layer</i> ) or <b>TLS</b> ( <i>Transport Layer Security</i> ) is a technology that ensures the security of data transmission between a client and a server over open networks. </li><li>  <b>HTTPS</b> ( <i>HTTP / Secure</i> ) - secure HTTP, is a special case of using SSL. </li><li>  <b>Internet PKI</b> is a set of standards, agreements, procedures and practices that provide a single (unified) data transmission protection mechanism based on the X.509 standard over open data transmission channels. </li><li>  <b>CPS</b> ( <i>Certificate Practice Statement</i> ) is a document that describes the procedures for managing public key infrastructure and digital certificates. </li></ul><br><h2>  General deployment plan </h2><br>  To deploy the certificate service, we need four machines running Windows Server 2016 that will perform the following functions: <br><br><ol><li>  <b>Domain controller</b> - necessary for the functioning of the Active Directory domain; </li><li>  <b>Web server</b> - will provide access to CA certificates and reviews for clients; </li><li>  <b>Root CA</b> - will perform the functions of the root CA; </li><li>  <b>Subordinate CA</b> - will perform the functions of the publishing CA. </li></ol><br>  PKI deployment will be phased on each server in the order in which they are listed above.  Preparing a domain controller will be limited to providing Active Directory functions, GPOs and accounts. <br><br><h2>  Domain controller preparation </h2><br>  Before deploying a PKI, you must ensure that the Active Directory domain is operational and that all the necessary servers (namely, the web server and the subordinate CA) are entered into the domain.  And also, that prepared the necessary accounts.  At this stage, we only need an account with Enterprise Admins rights. <br><br><blockquote>  A number of operations on a subordinate CA require Enterprise Admins rights, since a record is made in the configuration naming context.  If this is the root domain of the forest, then Domain Admins rights are sufficient for these operations. </blockquote><br>  The next step is to configure the autoenrollment policy.  This policy will be required during the operation of certificate services for the automatic issuance and renewal of expired certificates on clients.  The policy is configured in the configuration of the computer and user: <br><br><ul><li>  Computer Configuration \ Policies \ Windows Settings \ Security Settings \ Public Key Infrastructure \ Certificate Services Client - Auto-Enrollment </li><li>  User Configuration \ Policies \ Windows Settings \ Security Settings \ Public Key Infrastructure \ Certificate Services Client - Auto-Enrollment </li></ul><br>  The policy in both sections must be configured as shown in the following image: <br><br><img src="https://habrastorage.org/webt/ch/mw/i6/chmwi67tmfv436c7fyxwtywcfem.png"><br><br>  The configured group policy object (GPO) must be docked to the domain root.  This procedure must be repeated in all domains of the current Active Directory forest. <br><br>  Next, you need to create a CNAME record with the name CDP on the DNS server, which will point to the web server (IIS).  This procedure must be performed both on the internal and external (which serves the zone on the Internet) DNS servers.  You can create an entry using PowerShell: <br><br><pre><code class="cs hljs">Add-DnsServerResourceRecord -CName -Name <span class="hljs-string"><span class="hljs-string">"cdp"</span></span> -HostNameAlias <span class="hljs-string"><span class="hljs-string">"iis.contoso.com"</span></span> -ZoneName <span class="hljs-string"><span class="hljs-string">"contoso.om"</span></span></code> </pre> <br><h2>  Web server preparation </h2><br>  On the web server, we need to do the following: install IIS (if not already installed), create a shared folder, and configure the website to use this folder. <br><br><ul><li>  <b>Installing IIS</b> </li></ul><br>  To install IIS, you can use the following command: <br><br><pre> <code class="cs hljs">Install-WindowsFeature -Name Web-Server, Web-WebServer -IncludeManagementTools</code> </pre> <br><ul><li>  <b>Creating a PKIdata folder</b> </li></ul><br>  According to our configuration table (see part 2), to store CA certificates and revocation lists we will need a shared folder with the network name PKI in the following path: C: \ InetPub \ wwwroot \ PKIdata <br><br><pre> <code class="cs hljs">New-Item -ItemType Directory -Path C:\InetPub\wwwroot -Name PKIdata -Force New-SmbShare -Path C:\inetpub\wwwroot\PKIdata -Name PKI -FullAccess everyone</code> </pre> <br>  After that, you need to issue NTFS permissions to write to this folder for the group Cert Publishers. <br><br><ul><li>  <b>Website creation</b> </li></ul><br>  Now we need to create a separate website called ‚ÄúCDP‚Äù and hostname ‚Äúcdp.contoso.com‚Äù: <br><br><pre> <code class="cs hljs">New-Website -Name CDP -HostHeader cdp.contoso.com -PhysicalPath C:\inetpub\wwwroot\PKIdata New-WebVirtualDirectory -Site cdp -Name pki -PhysicalPath C:\inetpub\wwwroot\PKIdata</code> </pre> <br><ul><li>  <b>Enable Delta CRL support</b> </li></ul><br>  In our scenario, the issuing CA will publish the Delta CRL, which contains the plus sign ‚Äú+‚Äù in the file name (for example, contoso-pica + .crl).  By default, IIS will regard this character in the request as a metacharacter and will not allow customers to download the recall list.  To do this, you need to enable double escaping in the IIS settings in order to treat the plus sign in the query as a literal: <br><br><pre> <code class="cs hljs">Import-Module -Name WebAdministration Set-WebConfigurationProperty -PSPath <span class="hljs-string"><span class="hljs-string">'MACHINE/WEBROOT/APPHOST'</span></span> -Filter /system.webServer/security/requestFiltering -name allowdoubleescaping -Value <span class="hljs-string"><span class="hljs-string">'true'</span></span></code> </pre> <br><h2>  Installing a root CA </h2><br>  The actual installation of the CA will involve several steps: <br><br><ol><li>  Preparation of pre-installation configuration files (CAPolicy.inf); </li><li>  Installing the CA component; </li><li>  Perform post-install configuration; </li><li>  Check installation. </li></ol><br>  Before installing the root CA, you need to once again return to the configuration tables: <br><table><tbody><tr><th>  Parameter name </th><th>  Parameter value </th></tr><tr><td colspan="2" align="center">  <b>CA Server</b> </td></tr><tr><td>  CA class </td><td>  Standalone CA </td></tr><tr><td>  CA type </td><td>  Root CA </td></tr><tr><td colspan="2" align="center">  <b>Certificate</b> </td></tr><tr><td>  Certificate name </td><td>  Contoso Lab Root Certification authority </td></tr><tr><td>  Additional suffix </td><td>  OU = Division Of IT, O = Contoso Pharmaceuticals, C = US </td></tr><tr><td>  Key provider </td><td>  RSA # Microsoft Software Key Storage Provider </td></tr><tr><td>  Key length </td><td>  4096 bits </td></tr><tr><td>  Signature algorithm </td><td>  SHA256 </td></tr><tr><td>  Validity </td><td>  15 years </td></tr></tbody></table>  In the table, I selected only those parameters that are set before and during the installation process.  The remaining parameters will be adjusted after installation. <br><br><h4>  Preconfiguration </h4><br>  Preliminary configuration files are necessary for a number of settings that cannot be set during component installation (neither using the GUI, nor using the command line or PowerShell).  These usually include the CA certificate extension settings.  For example, to configure the Certificate Policies certificate extension, you need to use a preliminary configuration file in which the extension parameters are configured.  For Microsoft ADCS, this file is the CAPolicy.inf file, which should be located in the following path:% windir% \ CAPolicy.inf.  The syntax of this file can be found in the following article: <a href="https://technet.microsoft.com/en-us/library/cc737264(v%3Dws.10).aspx">How CA Certificates Work</a> .  Since we will not make any specific or non-standard settings in the root CA certificate, we will not need the preliminary configuration file now. <br><br><h4>  Installing the CA component </h4><br>  First you need to add installation components for AD CS: <br><br><pre> <code class="cs hljs">Install-WindowsFeature AD-Certificate, ADCS-Cert-Authority -IncludeManagementTools</code> </pre> <br>  After that, consult the previous table to determine the installation parameters.  Based on the data in the table, let's set the parameters for the <a href="https://docs.microsoft.com/en-us/powershell/module/adcsdeployment/install-adcscertificationauthority%3Fview%3Dwin10-ps">Install-AdcsCertificationAuthority cmdlet</a> : <br><br><pre> <code class="cs hljs">Install-AdcsCertificationAuthority -CACommonName <span class="hljs-string"><span class="hljs-string">"Contoso Lab Root Certification Authority"</span></span> ` -CADistinguishedNameSuffix <span class="hljs-string"><span class="hljs-string">"OU=Division Of IT, O=Contoso Pharmaceuticals, C=US"</span></span> ` -CAType StandaloneRootCA ` -CryptoProviderName <span class="hljs-string"><span class="hljs-string">"RSA#Microsoft Software Key Storage Provider"</span></span> ` -KeyLength <span class="hljs-number"><span class="hljs-number">4096</span></span> ` -HashAlgorithmName SHA256 ` -ValidityPeriod <span class="hljs-string"><span class="hljs-string">"years"</span></span> ` -ValidityPeriodUnits <span class="hljs-number"><span class="hljs-number">15</span></span> ` -DatabaseDirectory $(Join-Path $env:SystemRoot <span class="hljs-string"><span class="hljs-string">"System32\CertLog"</span></span>)</code> </pre> <br><h4>  Final setting </h4><br>  After installing the CA component, you must configure the operating parameters of the CA.  Consider again the elements that we need to configure: <br><table><tbody><tr><th>  Parameter name </th><th>  Parameter value </th></tr><tr><td colspan="2" align="center">  <b>CA Server</b> </td></tr><tr><td>  Validity of issued certificates </td><td>  15 years </td></tr><tr><td>  CRT Publish Points </td><td>  1) Default <br>  2) C: \ CertData \ contoso-rca &lt; <code>CertificateName</code> &gt; .crt <br>  3) IIS: \ InetPub \ PKIdata \ contoso-rca &lt; <code>CertificateName</code> &gt; .crt * </td></tr><tr><td>  CRT Distribution Points </td><td>  1) <a href="http://cdp.contoso.com/pki/contoso-rca">cdp.contoso.com/pki/contoso-rca</a> &lt; <code>CertificateName</code> &gt; .crt </td></tr><tr><td>  CRL Publish Points </td><td>  1) Default <br>  2) C: \ CertData \ contoso-rca &lt; <code>CRLNameSuffix</code> &gt; .crt <br>  3) IIS: \ InetPub \ PKIdata \ contoso-rca &lt; <code>CRLNameSuffix</code> &gt; .crt * </td></tr><tr><td>  CRL distribution points </td><td>  1) <a href="http://cdp.contoso.com/pki/contoso-rca">cdp.contoso.com/pki/contoso-rca</a> &lt; <code>CRLNameSuffix</code> &gt; .crt </td></tr><tr><td colspan="2" align="center">  <b>Certificate</b> </td></tr><tr><td>  CRL composition </td><td>  Base CRL </td></tr><tr><td colspan="2" align="center">  <b>Base CRL</b> </td></tr><tr><td>  Type of </td><td>  Base CRL </td></tr><tr><td>  Validity </td><td>  6 months </td></tr><tr><td>  Extension of validity </td><td>  1 month </td></tr><tr><td>  Signature algorithm </td><td>  SHA256 </td></tr><tr><td>  Publish to AD </td><td>  Not </td></tr></tbody></table>  * - copied to IIS server <br><br><h4>  Customization script </h4><br>  To configure the CA settings, we will use the BATCH script using the certutil.exe utility: <br><br><pre> <code class="cs hljs">:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: :: Root CA post-installation script :: :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::       (::) ::            ::    SET CrlLocal=C:\CertData\contoso-rca%%<span class="hljs-number"><span class="hljs-number">8.</span></span>crl SET CDP=http:<span class="hljs-comment"><span class="hljs-comment">//cdp.contoso.com/pki/contoso-rca%%8.crl SET AIA=http://cdp.contoso.com/pki/contoso-rca%%4.crt ::      ,     .   ::   ,     CertEnroll    Windows. md C:\CertData ::           . certutil -setreg CA\CRLPublicationURLs "1:%windir%\system32\CertSrv\CertEnroll\%%3%%8.crl\n1:%CrlLocal%\n2:%CDP%" certutil -setreg CA\CACertPublicationURLs "1:%windir%\system32\CertSrv\CertEnroll\%%1_%%3%%4.crt\n2:%AIA%" ::          ,  ::           CertData ren %windir%\system32\CertSrv\CertEnroll\*.crt contoso-rca.crt copy %windir%\system32\CertSrv\CertEnroll\contoso-rca.crt C:\CertData ::      certutil -setreg CA\ValidityPeriodUnits 15 certutil -setreg CA\ValidityPeriod "Years" ::         certutil -setreg CA\CRLPeriodUnits 180 certutil -setreg CA\CRLPeriod "Days" certutil -setreg CA\CRLOverlapPeriod "Months" certutil -setreg CA\CRLOverlapUnits 1 ::     ( Delta CRL) certutil -setreg CA\CRLDeltaPeriodUnits 0 ::   - certutil -setreg ca\CRLFlags +CRLF_DISABLE_ROOT_CROSS_CERTS ::           certutil ‚Äìsetreg ca\CRLFlags +CRLF_PUBLISH_EXPIRED_CERT_CRLS ::      ** certutil -setreg CA\AuditFilter 127 ::    ,  Windows Server 2016    . :: Windows Server 2016    SHA256. Certutil -setreg ca\csp\CNGHashAlgorithm SHA256 ::      . net stop certsvc &amp;&amp; net start certsvc ::   . certutil -CRL</span></span></code> </pre> <br>  A number of teams need a more detailed explanation.  Commands with customization extensions CRL Distribution Points and Authority Information Access have a specific syntax.  First, the publication and distribution paths are indicated in one line and are separated by the newline character "\ n".  Each path begins with a number and is separated from the path itself by a colon.  This number at the beginning of the path indicates the bit mask of the publication flags for a particular path.  The value of each bit for the CDP and AIA extensions is shown in the following table: <br><table><tbody><tr><th>  MMC checkmark name </th><th width="105">  Numerical value </th><th>  MMC checkmark name </th><th width="105">  Numerical value </th></tr><tr><td>  Publish CRLs to this location. </td><td align="center">  one </td><td>  Include in the AIA extension of issued <br>  certificates. </td><td align="center">  2 </td></tr><tr><td>  Include in the CDP extension of issued certificates. </td><td align="center">  2 </td><td>  Include in the Online Certificate Status.  Protocol (OCSP) extension. </td><td align="center">  32 </td></tr><tr><td>  Include in CRLs.  Clients use this to find Delta CRL locations. </td><td align="center">  four </td></tr><tr><td>  Include in all CRLs.  Specifies where to publish in AD DS when publishing manually. </td><td align="center">  eight </td></tr><tr><td>  Publish Delta CRLs to this location. </td><td align="center">  64 </td></tr><tr><td>  Include in the IDP extension of issued CRLs. </td><td align="center">  128 </td></tr></tbody></table>  If you take the path for CDP: 1:% windir% \ system32 \ CertSrv \ CertEnroll \ %% 3 %% 8.crl, then the number 1 at the beginning of the line indicates that this is the path to the physical location of the file (Publich CRLs to this location) .  Other options are not used here.  To include the path that will be published in the issued certificates, we will use the option ‚ÄúInclude in the CDP extension of issued certificates‚Äù with a numerical value of 2. The same principle applies to the other paths. <br><br>  Each path includes variables with a double percent sign "%%".  These are variables that the CA will automatically fill in when forming the path based on the type of variable. <br><br><blockquote>  The first percent sign is used as an escape symbol, so that the command line processor interprets the next percent sign as a literal.  The fact is that the percent sign in the CMD command processor is a service character.  The CA server also uses the percent sign to indicate that it is a variable.  To avoid conflict in the shell, a sequence of two percent signs is used. </blockquote><br>  The following table contains a description of all available variables and their brief description: <br><table><tbody><tr><th width="235">  Variable in the CDP and AIA Extensions Editor </th><th width="125">  Variable in script </th><th width="135">  Where used </th><th>  Value </th></tr><tr><td>  &lt; <code>ServerDNSName</code> &gt; </td><td align="center">  %one </td><td align="center">  CDP / AIA </td><td>  Full DNS server name CA </td></tr><tr><td>  &lt; <code>ServerShortName</code> &gt; </td><td align="center">  % 2 </td><td align="center">  CDP / AIA </td><td>  The short (NetBIOS) name of the CA server </td></tr><tr><td>  &lt; <code>CaName</code> &gt; </td><td align="center">  % 3 </td><td align="center">  CDP / AIA </td><td>  CA name (CN attribute in certificate) </td></tr><tr><td>  &lt; <code>CertificateName</code> &gt; </td><td align="center">  %four </td><td align="center">  AIA </td><td>  Certificate Index CA.  Used only when renewing a CA certificate. </td></tr><tr><td>  &lt; <code>ConfigurationContainer</code> &gt; </td><td align="center">  % 6 </td><td align="center">  CDP / AIA </td><td>  Path to configuration naming context in Active Directory </td></tr><tr><td>  &lt; <code>CATruncatedName</code> &gt; </td><td align="center">  % 7 </td><td align="center">  CDP / AIA </td><td>  The shortened (sanitized) name of the CA certificate.  In general, will match the full name of the CA </td></tr><tr><td>  &lt; <code>CRLNameSuffix</code> &gt; </td><td align="center">  %eight </td><td align="center">  CDP </td><td>  The key index of the CA that signed this CRL.  Used when updating a key CA pair. </td></tr><tr><td>  &lt; <code>DeltaCRLAllowed</code> &gt; </td><td align="center">  %9 </td><td align="center">  CDP </td><td>  Adds a suffix for the delta CRL (‚Äú+‚Äù sign). </td></tr><tr><td>  &lt; <code>CDPObjectClass</code> &gt; </td><td align="center">  %ten </td><td align="center">  CDP </td><td>  Object Class in Active Directory </td></tr><tr><td>  &lt; <code>CAObjectClass</code> &gt; </td><td align="center">  %eleven </td><td align="center">  CDP / AIA </td><td>  Object Class in Active Directory </td></tr></tbody></table>  In our particular case, only two variables will be used: &lt;CertificateName&gt; and &lt;CRLNameSuffix&gt;.  For the original CA certificate, these variables are empty.  When updating the CA certificate, the variable will be replaced with ‚Äú(index)‚Äù, where index is the CA certificate number.  Indexing starts from scratch.  For example, the file name for a subsequent CA certificate will look like: contoso-rca (1) .crt.  And so on.  The same applies to the variable, only here the index of the key pair of CA will be indicated. <br><br>  Special attention should be paid to the team, which includes the audit of operations on the CA server, which are recorded in the Security.evtx system log.  These include all basic operations: starting / stopping the service, sending a request, issuing or rejecting a certificate, issuing a revocation list.  This line can be found in almost every post-installation script for the CA, which can be found in similar articles on the Internet.  And almost no one bothers himself in a detailed explanation of the mechanism of his work, just copy from article to article. <br><br>  The peculiarity of CA audit is that setting the audit flags on the CA is a necessary but not sufficient condition.  The audit mechanism is based on logging events in the Security.evtx log, which, in turn, depends on the setting of the Audit Object Access policy in group policies.  Those.  Without setting group policies, there will be no audit. <br><br>  Experienced administrators know where the inclusion of Audit Object Access leads to the avalanche creation of journal entries from other OS components.  For example, auditing file system access, registry, other installed roles, etc.  As a result, the journal can literally fill up in a day or two.  Therefore, effective use of auditing requires measures to filter unnecessary events, for example, using the function of subscribing to events of interest.  There is no point in an audit if no one can read it and analyze it effectively.  But this topic is already beyond the scope of this article. <br><br><h4>  Other settings </h4><br>  After the root CA is installed and configured, make sure that everything went smoothly: <br><br><ul><li>  Open the Certification Authorities MMC snap-in (certsrv.msc), make sure that the service is running; </li><li>  Select the properties of the CA node and check the certificate fields to match the expected values; </li><li>  Locate the CertData folder in the root of the system disk and make sure that there are two files there: the certificate and the revocation list.  Verify that the fields in the revocation list are as expected. </li></ul><br>  If everything is fine, then copy the contents of the C: \ CertData folder to the IIS server in the PKIData folder.  The root CA certificate can already be imported to all devices that will use our PKI. <br><br>  To import a certificate to domain clients, it is enough to load it into Active Directory and after updating group policies on clients, the certificate will be installed in local certificate stores throughout the forest.  To publish a certificate in AD, run the following command: <br><br><pre> <code class="cs hljs">Certutil -f -dspublish path\contoso-rca.crt RootCA</code> </pre> <br>  To install the certificate on clients in workgroups and mobile devices, you need to use other tools that you have at your disposal.  For example, System Center Configuration Manager or Mobile Device Management.  If there are no suitable tools, you can copy and install the certificate on computers using the certutil.exe utility.  To install the certificate in the local certificate store, run the following command: <br><br><pre> <code class="cs hljs">Certutil -f -addstore Root path\contoso-rca.crt</code> </pre> <br><h2>  Installing a publishing CA </h2><br>  As in the case of the root CA, installing the issuing CA involves four steps: <br><br><ol><li>  Preparation of pre-installation configuration files (CAPolicy.inf); </li><li>  Installing the CA component; </li><li>  Perform post-install configuration; </li><li>  Verify installation and configuration. </li></ol><br><h4>  Pre-installation configuration </h4><br>  If we didn‚Äôt need the pre-installation configuration file for the root CA, then we will need it for the issuing CA.  In it, we will configure the Certificate Policies and Basic Constraints extensions for the CA certificate.  If everything is clear with the politicians, then in the Basic Constraints extension we forbid the issuance of certificates to other CAs from the issuing CA, since we have a two-level hierarchy and adding new levels only complicates our structure and increases the time spent on checking certificates by customers.  Also disable the automatic loading of templates from Active Directory to the list of issued templates.  By default, the CA server loads a certain set of certificate templates for issuance.  This is harmful for two reasons: <br><br><ol><li>  Domain controllers almost instantly detect the appearance of a CA in the forest, and even with the automatic issue policy disabled, they themselves request certificates. </li><li>  Administrators themselves must determine which templates they will use in the organization. </li></ol><br>  Therefore, we configure the CA so that the list of templates for issue will be empty.  This can be done only through CAPolicy.inf.  In our case, it will have the following content: <br><br><pre> <code class="cs hljs">;  INI  [Version] Signature= <span class="hljs-string"><span class="hljs-string">"$Windows NT$"</span></span> ;   ,      .   ;       AllIssuancePolicies. [PolicyStatementExtension] Policies = AllIssuancePolicy ;    .    Certificate Practice ; Statement (CPS)     [AllIssuancePolicy] URL = http:<span class="hljs-comment"><span class="hljs-comment">//cdp.contoso.com/pki/contoso-cps.html OID = 2.5.29.32.0 [BasicConstraintsExtension] IsCA = True PathLegth = 0 IsCritical = True ;     [certsrv_server] ;        LoadDefaultTemplates = 0</span></span></code> </pre> <br>  The file named CAPolicy.inf must be copied to the Windows system folder before installing the CA. <br><br><h4>  Installing the CA component </h4><br>  First you need to add installation components for AD CS: <br><br><pre> <code class="cs hljs">Install-WindowsFeature AD-Certificate, ADCS-Cert-Authority -IncludeManagementTools</code> </pre> <br>  After that, look at the installation table to determine the installation parameters: <br><table><tbody><tr><th>  Parameter name </th><th>  Parameter value </th></tr><tr><td colspan="2" align="center">  <b>CA Server</b> </td></tr><tr><td>  CA class </td><td>  Enterprise CA </td></tr><tr><td>  CA type </td><td>  Subordinate ca </td></tr><tr><td>  Automatic template loading </td><td>  Not </td></tr><tr><td colspan="2" align="center">  <b>Certificate</b> </td></tr><tr><td>  Certificate name </td><td>  Contoso Lab Issuing Certification authority </td></tr><tr><td>  Additional suffix </td><td>  OU = Division Of IT, O = Contoso Pharmaceuticals, C = US </td></tr><tr><td>  Key provider </td><td>  RSA # Microsoft Software Key Storage Provider </td></tr><tr><td>  Key length </td><td>  4096 bits </td></tr><tr><td>  Signature algorithm </td><td>  SHA256 </td></tr><tr><td>  Validity </td><td>  15 years (determined by superior CA) </td></tr><tr><td>  Issuing policies </td><td>  1) Name: All Issuance Policies <br>  OID = 2.5.29.32.0 <br>  URL = http: //cdp.contoso.com/pki/contoso-cps.html </td></tr><tr><td>  Basic Constraints </td><td>  isCA = True (certificate type - CA certificate) <br>  PathLength = 0 (the creation of other intermediate CAs under the current CA is prohibited). </td></tr></tbody></table>  In the table, I selected only those parameters that are set during the installation process.  The remaining parameters will be adjusted after installation.  Based on this data <a href="https://docs.microsoft.com/en-us/powershell/module/adcsdeployment/install-adcscertificationauthority%3Fview%3Dwin10-ps">, let's</a> create the parameters for the <a href="https://docs.microsoft.com/en-us/powershell/module/adcsdeployment/install-adcscertificationauthority%3Fview%3Dwin10-ps">Install-AdcsCertificationAuthority cmdlet</a> : <br><br><pre> <code class="cs hljs">Install-AdcsCertificationAuthority -CACommonName <span class="hljs-string"><span class="hljs-string">"Contoso Lab Issuing Certification authority"</span></span> ` -CADistinguishedNameSuffix <span class="hljs-string"><span class="hljs-string">"OU=Division Of IT, O=Contoso Pharmaceuticals, C=US"</span></span> ` -CAType EnterpriseSubordinateCa ` -CryptoProviderName <span class="hljs-string"><span class="hljs-string">"RSA#Microsoft Software Key Storage Provider"</span></span> ` -KeyLength <span class="hljs-number"><span class="hljs-number">4096</span></span> ` -HashAlgorithmName SHA256</code> </pre> <br>  After executing this command, a message will be displayed that the installation of the CA is not complete and to complete it you need to send a generated request (located in the root of the system disk) to the higher-level CA and receive a signed certificate.  Therefore, we find a file with the extension ‚Äú.req‚Äù in the root of the system disk and copy it to the root CA and perform the following commands on the root CA: <br><br><pre> <code class="cs hljs"> <span class="hljs-meta"><span class="hljs-meta">#    . certreq -submit 'C:\CA-01.contoso.com_Contoso Lab Issuing Certification authority.req' #     .        #      2 certutil -resubmit 2 #       .        # ,        certreq -retrieve 2 C:\subca.crt</span></span></code> </pre> <br>  The resulting file (subca.crt) must be copied back to the publishing CA and complete the installation: <br><br><pre> <code class="cs hljs">certutil -installcert c:\subca.crt net start certsvc</code> </pre> <br>  We install the issued certificate on the CA and start the certificate service.  After successful installation, you can start the Certification Authorities MMC snap-in (certsrv.msc) and make sure that the certificate is successfully installed and the CA is in a working state.  Now it is up to the post-installation configuration. <br><br><h4>  Final setting </h4><br>  By analogy with the root CA, we need to configure a number of parameters on the issuing CA.  To do this, we will again write the BATCH script using the certutil.exe utility.  But first, let's look at the installation table and find out the parameters that we need to configure: <br><br>  A similar table is compiled for the issuing CA. <br><table><tbody><tr><th>  Parameter name </th><th>  Parameter value </th></tr><tr><td colspan="2" align="center">  <b>CA Server</b> </td></tr><tr><td>  Validity of issued certificates </td><td>  Maximum: 5 years (the rest is controlled by certificate templates) </td></tr><tr><td>  Publish to AD (containers) </td><td>  AIA <br>  NTAuthCertificates </td></tr><tr><td>  CRL composition </td><td>  Base CRL <br>  Delta CRL </td></tr><tr><td>  CRT Publish Points </td><td>  1) Default <br>  2) \\ IIS \ PKI \ contoso-pica &lt; <code>CertificateName</code> &gt; .crt </td></tr><tr><td>  CRT Distribution Points </td><td>  1) <a href="http://cdp.contoso.com/pki/contoso-pica">cdp.contoso.com/pki/contoso-pica</a> &lt; <code>CertificateName</code> &gt; .crt </td></tr><tr><td>  CRL Publish Points </td><td>  1) Default <br>  2) \\ IIS \ PKI \ contoso-pica &lt; <code>CRLNameSuffix</code> &gt; &lt; <code>DeltaCRLAllowed</code> &gt; <code>DeltaCRLAllowed</code> </td></tr><tr><td>  CRL distribution points </td><td>  1) <a href="http://cdp.contoso.com/pki/contoso-pica">cdp.contoso.com/pki/contoso-pica</a> &lt; <code>CRLNameSuffix</code> &gt; &lt; <code>DeltaCRLAllowed</code> &gt; <code>DeltaCRLAllowed</code> </td></tr><tr><td colspan="2" align="center">  <b>Base CRL</b> </td></tr><tr><td>  Type of </td><td>  Base CRL </td></tr><tr><td>  Validity </td><td>  Week 1 </td></tr><tr><td>  Extension of validity </td><td>  Default </td></tr><tr><td>  Signature algorithm </td><td>  SHA256 </td></tr><tr><td>  Publish to AD </td><td>  Not </td></tr><tr><td colspan="2" align="center">  <b>Delta CRL</b> </td></tr><tr><td>  Type of </td><td>  Delta CRL </td></tr><tr><td>  Validity </td><td>  1 day </td></tr><tr><td>  Extension of validity </td><td>  Default </td></tr><tr><td>  Signature algorithm </td><td>  SHA256 </td></tr><tr><td>  Publish to AD </td><td>  Not </td></tr></tbody></table>  We will take the script from the root CA as a basis and change only individual fragments: <br><br><pre> <code class="cs hljs">:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: :: Issuing CA post-installation script :: :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: ::       (::) ::            ::    SET CrlLocal=\\IIS\PKI\contoso-pica%%<span class="hljs-number"><span class="hljs-number">8</span></span>%%<span class="hljs-number"><span class="hljs-number">9.</span></span>crl SET CDP=http:<span class="hljs-comment"><span class="hljs-comment">//cdp.contoso.com/pki/contoso-pica%%8%%9.crl SET AIA=http://cdp.contoso.com/pki/contoso-pica%%4.crt ::           . certutil -setreg CA\CRLPublicationURLs "1:%windir%\system32\CertSrv\CertEnroll\%%3%%8%%9.crl\n65:%CrlLocal%\n6:%CDP%" certutil -setreg CA\CACertPublicationURLs "1:%windir%\system32\CertSrv\CertEnroll\%%1_%%3%%4.crt\n2:%AIA%" ::          ,  ::            ren %windir%\system32\CertSrv\CertEnroll\*.crt contoso-pica.crt copy %windir%\system32\CertSrv\CertEnroll\contoso-pica.crt \\IIS\PKI ::      certutil -setreg CA\ValidityPeriodUnits 5 certutil -setreg CA\ValidityPeriod "Years" ::         ::  CRL certutil -setreg CA\CRLPeriodUnits 1 certutil -setreg CA\CRLPeriod "weeks" :: Delta CRL certutil -setreg CA\CRLDeltaPeriodUnits 1 certutil -setreg CA\CRLDeltaPeriod "days" ::      ** certutil -setreg CA\AuditFilter 127 ::    Certificate Policies    certutil -setreg Policy\EnableRequestExtensionList +"2.5.29.32" ::    OcspRevNoCheck,    ::   (Online Responder  OCSP ) certutil -v -setreg policy\editflags +EDITF_ENABLEOCSPREVNOCHECK ::    ,  Windows Server 2016    . :: Windows Server 2016    SHA256. Certutil -setreg ca\csp\CNGHashAlgorithm SHA256 ::      . net stop certsvc &amp;&amp; net start certsvc ::   . certutil -CRL</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that in the CRLDistribution Points paths, the publication flags have been changed (the Delta CRL publication has been added) and the variable% 9 has been added to the file name to support the unique name for the delta. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we no longer create a folder in the root of the system disk, but use the PKI network folder on the IIS server, where we directly copy the certificate file and publish revocation lists.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Other settings </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After the publishing CA is installed and configured, make sure that everything went smoothly: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certification Authorities MMC snap-in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (certsrv.msc), make sure that the service is running</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Select the properties of the CA node and check the certificate fields to match the expected values. </font></font></li><li>    PKI (  IIS)  ,       (   )     (  ,    ). ,          . </li></ul><br>    ,              .      ( ,   ,      )    <b>Enterprise PKI Health</b> (pkiview.msc).                 .     .   ,      .            : <br><br><img src="https://habrastorage.org/webt/kc/3j/ni/kc3jniyaa4gpv4sbf1tuatwu99m.png"><br><br>    : <br><br><img src="https://habrastorage.org/webt/cl/ba/ut/clbauthhawhrfkxbu1naypnwxhe.png"><br><br>          <b>Enterprise PKI Health</b>   ,     ,  PKI  . <br><br><h2>  Recommendations </h2><br>  ,    ,     ,     .        ,   ,           PKI. <br><br><h4>   </h4><br>     ,  Active Directory      .      <b>Certificate Templates MMC</b> (certtmpl.msc).    : <br><br> <b>   </b> <br><br>     ,         .         ,     Duplicate Template    .       ,       . , <b>Contoso Web Server, Contoso Smart Card Logon</b> .             . <br><br> <b> </b> <br><br>   Windows Server 2012,     .              : <br><br><img src="https://habrastorage.org/webt/oc/x5/9k/ocx59kjygd7wf4sc55xbkjwsnly.png"><br><br>        (, Windows 7  ),       .    ,      CNG (Cryptography Next Generation),   ,    .        ,  Windows Server 2003/Windows XP,        . ,  ,   .NET,   System Center,   (AD FS)  ..       (  ). <br><br>      ,    .NET,    CryptoAPI.     , , IIS, Remote Desktop Services. <br><br> <b> Subject  Subject Alternative Names</b> <br><br>      Subject   Subject Alternative Names:   .      ,   Subject Name. <br><br><img src="https://habrastorage.org/webt/6q/xd/pi/6qxdpiq0zhiabvo_fgd0bzcxisa.png"><br><br>     (  ),                  ,   .       (,    -)         .       .   ,   Issuance Requirements     ¬´CA certificate manager approval¬ª. <br><br><img src="https://habrastorage.org/webt/lq/1b/fd/lq1bfdxiojurm0r1pnszhxexgcm.png"><br><br>   ,       .     ,            Active Directory.           .        ,              Pending Requests    ,             .  Those.          ,        .       . <br><br> <b>   </b> <br><br>    Active Directory    configuration naming context,        .              .       . <br><br><h4>    </h4><br>     .   ,     . <br><br> <b>   </b> <br><br>     : <br><br><ul><li>     ; </li><li>   ; </li><li>       ; </li><li>     (  ). </li></ul><br>  ,    ,            ? <br><br>           .         15 ,       5  (.  ).  ,        10 .    ,            . <br><br> <b>  </b> <br><br>             . ,         ,    .     ,    . <br><br> <b>     </b> <br><br>        :       : <br><br><img src="https://habrastorage.org/webt/vr/fj/0k/vrfj0k7gbqxoo_wzqvoq1mmrtjk.png"><br><br>         Microsoft    . ,  ,    .      .                 .    Microsoft   .  : <br><br><ul><li> <a href="https://support.microsoft.com/en-us/help/2831004/certificate-validation-fails-when-a-certificate-has-multiple-trusted-c">Certificate validation fails when a certificate has multiple trusted certification paths to root CAs</a> . </li><li> <a href="https://support.microsoft.com/en-us/help/2639180/0x80092013-crypt-e-revocation-offlinea-error-message-when-you-try-to-v">¬´0x80092013, CRYPT_E_REVOCATION_OFFLINEA¬ª error message when you try to verify a certificate that has multiple chains in Windows Server 2008 or in Windows Vista.</a> </li></ul><br>                        . <br><br><h4>  Backup </h4><br>          .      ,        . <br><br> Microsoft Active Directory Certificate Services       : <br><br><ul><li>  Certification Authority MMC (certsrv.msc); </li><li>  certutil.exe   -backup. </li></ul><br>             .          .     .         : <br><br><pre> <code class="cs hljs">HKLM\System\CurrentControlSet\Services\CertSvc</code> </pre> <br>        .     REG         . <br><br>    ,       : <br><br><ul><li>    ; </li><li>   ; </li><li>    ; </li><li>   ; </li><li>    . </li></ul><br>            ,         . <br><br><h2>  about the author </h2><br><img src="https://habrastorage.org/webt/yi/eq/4o/yieq4os65jmmhcqhrnv9y9ws76u.jpeg" align="left" width="120"> <b> </b> ‚Äî     PowerShell  Public Key Infrastructure, Microsoft MVP: Cloud and Datacenter Management  2009     PowerShell PKI.   9           PKI  .    PKI  PowerShell     <a href="https://www.sysadmins.lv/"></a> . </div><p>Source: <a href="https://habr.com/ru/post/349202/">https://habr.com/ru/post/349202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349192/index.html">Archiving and restoring indexes in Elasticsearch</a></li>
<li><a href="../349194/index.html">Three unusual examples of using the blockchain</a></li>
<li><a href="../349196/index.html">Make me think</a></li>
<li><a href="../349198/index.html">Design Patterns in React</a></li>
<li><a href="../349200/index.html">Veeam Academy: from basic knowledge of C # to team development in 2.5 months</a></li>
<li><a href="../349204/index.html">Modeling Dynamic Systems: An Introduction to GNU Octave</a></li>
<li><a href="../349206/index.html">Half of our employees work remotely. Tell us how we do it.</a></li>
<li><a href="../349208/index.html">Werewolf file: NES cartridge image and ZIP file in one</a></li>
<li><a href="../349212/index.html">Creating a dynamic tooltip in Angular2 + applications</a></li>
<li><a href="../349214/index.html">Smart contract trap in the network Ethereum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>