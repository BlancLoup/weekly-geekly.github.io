<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rails + Sphinx =? Part I</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Talk about searching in Ruby on Rails? 

 I decided to break the narration into two parts: the first one is a boring project setup and a simple search...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rails + Sphinx =? Part I</h1><div class="post__text post__text-html js-mediator-article">  Talk about searching in Ruby on Rails? <br><a name="habracut"></a><br>  I decided to break the narration into two parts: the first one is a boring project setup and a simple search in one field of the same model.  In the second we will dwell on the intricacies in more detail and I will try to tell you about everything that a plugin can do.  By the way, in the source code (link in the text) the project has already been slightly modified for the second part, but this will not cause problems. <br><br><h1>  Installation </h1><br>  Install Rails 2.0.2 or later. <br>  Download sphinx 0.9.8: <a href="http://www.sphinxsearch.com/downloads.html">www.sphinxsearch.com/downloads.html</a> and collect it yourself, or use ports / portazhi / &lt;insert the necessary&gt; <br> <code>$ sudo port install sphinx <br></code> <br>  Sphinx supports two subd - MySQL and PostgreSQL, but you can quite easily support any database. <br>  Post-installation check: <br> <code>Macintosh:sphinx-0.9.8 kronos$ searchd -h <br> Sphinx 0.9.8-release (r1371) <br> Copyright (c) 2001-2008, Andrew Aksyonoff <br> ... <br></code> <br>  The path to searchd and indexer must be in the path variable. <br><br>  Sphinx consists of several utilities, some of them are: <br>  searchd - search daemon <br>  search - console analogue of searchd for debugging / test searching. <br>  indexer - indexer. <br>  Create a project: <br> <code>$ rails sphinxtest -d mysql <br> $ cd sphinxtest/ <br></code> <br>  Do not forget to edit config / database.yml 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For convenience, we will use a plugin to work with the sphinx. <br>  I believe that there are two adequate plug-ins for Rails - <a href="http://blog.evanweaver.com/files/doc/fauna/ultrasphinx/files/README.html">ultrasphinx</a> and <a href="http://ts.freelancing-gods.com/usage.html">Thinking Sphinx</a> (by the way, while writing an article <a href="http://railscasts.com/episodes/120-thinking-sphinx">RailsCast</a> was <a href="http://railscasts.com/episodes/120-thinking-sphinx">released</a> about it).  Since the latter conflicts with another plugin ‚Äúredhill on rails‚Äù because of internal naming, I use the first one.  But perhaps the second is better - choose yourself.  :) <br>  Installing the plugin: <br> <code>$ script/plugin install git://github.com/fauna/ultrasphinx.git <br></code> <br><br><h1>  Customization </h1><br> <code>$ mkdir config/ultrasphinx <br> cp vendor/plugins/ultrasphinx/examples/default.base config/ultrasphinx/ <br></code> <br>  default.base - preparation for the sphinx configuration file.  In the first part, just configure the paths to logs / pids / indexes: <br> <code># ... <br> searchd <br> { <br> # ... <br> log = /opt/local/var/db/sphinx/log/searchd.log <br> query_log = /opt/local/var/db/sphinx/log/query.log <br> pid_file = /opt/local/var/db/sphinx/log/searchd.pid <br> # ... <br> } <br> # ... <br> index <br> { <br> #      <br> path = /opt/local/var/db/sphinx/ <br> # ... <br> } <br> # ... <br></code> <br><h1>  Write the code </h1><br>  For simplicity, let's make one controller with a form that, with the help of ajax, will look for, let's say ... Artists by name.  The model of the artist will consist of one field - title: <br> <code>$ script/generate controller home index search <br> $ script/generate model artist <br></code> <br>  Migration code, let the artist have only one title field (db / migrate /..._ create_artists.rb): <br><pre> class CreateArtists &lt;ActiveRecord :: Migration
   def self.up
     create_table: artists do | t |
       t.string: title,: null =&gt; false
       t.timestamps
     end
   end

   def self.down
     drop_table: artists
   end
 end
</pre><br>  Now let's say to the sphinx that we will search by one field (app / models / artist.rb): <br> <code>class Artist &lt; ActiveRecord::Base <br> is_indexed :fields =&gt; ['title'] <br> end <br></code> <br>  The entry ‚Äúis_indexed: fields =&gt; ['title']‚Äù means that indexing will take place on one field. <br><br>  Well, create the database and perform the migration: <br> <code>$ rake db:create <br> $ rake db:migrate <br></code> <br>  It is also worth setting up routes in the config / routes.rb file: <br> <code>map.root :controller =&gt; 'home' <br> map.search 'search', :conditions =&gt; {:method =&gt; :get}, :controller =&gt; 'home', :action =&gt; 'search' <br></code> <br><br>  Controller code (app / controllers / home_controller.rb): <br><pre> class HomeController &lt;ApplicationController
   def index
   end

   def search
     query = params [: query] .split (/ '([^'] +) '| "([^"] +) "| \ s + | \ + /). reject {| x | x.empty?}. map {| x | x.inspect} * '&amp;&amp;'
     @artists = Ultrasphinx :: Search.new (: query =&gt; query, 
                                       : sort_mode =&gt; 'relevance', 
                                       : class_names =&gt; ["Artist"])    
     @ artists.run
     respond_to do | format |
       format.js # search.js.erb
     end
   end
 end
</pre><br>  With the first regular expression, we parse the search query, breaking up words by spaces, ignoring empty words (for example ,,) and adding quotes to all words.  The &amp;&amp; operation means only a set of words, for example, a query <br>  ‚ÄúBleed it out‚Äù =&gt; 'Bleed' &amp;&amp; 'it' &amp;&amp; 'out' will match and the ‚ÄúSell it out‚Äù entry (two words out of three matched), i.e.  &amp;&amp; does not dictate a list of mandatory words, but only lists them (if you need the obligatory presence of all words, then you need to use AND, but this is in the second part). <br>  Let's briefly go over the parameters: <br>  : query - search query <br>  : sort_mode - type of results sorting <br>  : class_names - an array of model class names that will be created as a result of the search.  Sphinx internally stores each document as a set of fields and their values.  In Rails, working with such a view is not convenient, but much more convenient with a ready-made model object.  Ultrasphinx will determine to which model the found document belongs and create an instance of it, so the search itself is no different from Artist.find (...) or Artist.paginate (yes, the search query results are compatible with will_paginate). <br>  The @ artists.run command executes the request.  Requests are executed very quickly.  At the seven millionth base - thousandths of a second. <br>  Views (templates) can be viewed in the <a href="http://rghost.ru/files/15017">finished project.</a> <br><br>  Now you can add something to the database: <br> <code>$ script/console <br> &gt;&gt; Artist.create(:title =&gt; 'Tiesto') <br> &gt;&gt; Artist.create(:title =&gt; 'Armin') <br> &gt;&gt; Artist.create(:title =&gt; 'ATB') <br> &gt;&gt; exit <br></code> <br>  Perform the necessary preparations for the plug-in to work (this should be done every time you change something in the models in the is_indexed description): <br> <code>$ rake ultrasphinx:configure <br> $ rake ultrasphinx:index <br> $ rake ultrasphinx:daemon:start ( restart   ) <br></code> <br>  Run and test) <br> <code>$ mongrel_rails -p 3001 -d <br></code> <br><h1>  One small but </h1><br>  Indices are separate data in the database separately.  When we delete / change / add indexes to the database do not change.  To change the database reflected on the indexes full re-indexing database: <br> <code>$ rake ultrasphinx:index <br></code> <br>  Of course this is not very good.  But I can assure you that the solution to the problem exists and is called delta-indexing.  About this in the next part. <br><h1>  Summary </h1><br>  Sphinx is a very cool thing :).  Open source, free, smartly searches and indexes.  Must have! <br><br><h1>  Analogs </h1><br>  Of analogs, I can mark acts_as_ferret, for small projects it fits perfectly (for example, <a href="http://hf.realisticgroup.com/">we used it</a> at the <a href="http://hackfest.rambler.ru/">Hackfest Rambler</a> ), but for large amounts of data it behaves, to put it mildly, it doesn‚Äôt matter very much ‚Äî it takes a very long time to index. <br>  For postgrest tsearch2 there seems to be a bad plugin: <a href="http://code.google.com/p/acts-as-tsearch/">Acts as tsearch</a> , didn‚Äôt use it in combat, I don‚Äôt know.  Still have <a href="http://acts-as-solr.rubyforge.org/">acts_as_solr</a> <br></div><p>Source: <a href="https://habr.com/ru/post/29538/">https://habr.com/ru/post/29538/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../295366/index.html">Real Time Trading (RTB): A Comprehensive Guide for Profit</a></li>
<li><a href="../295368/index.html">The biggest mistake in A / B testing</a></li>
<li><a href="../295370/index.html">Know your target audience or die: 34 vital questions</a></li>
<li><a href="../295376/index.html">Square company has applied for an IPO. Jack Dorsey will be the head of two public companies - Twitter and Square</a></li>
<li><a href="../295378/index.html">7 misconceptions beginners or "leap of faith"</a></li>
<li><a href="../295380/index.html">18 insights of top online entrepreneurs</a></li>
<li><a href="../295382/index.html">5 designer tips or how to find an adequate employer and stay yourself adequate</a></li>
<li><a href="../295384/index.html">Where is the recruitment market in Russia? Westerly winds</a></li>
<li><a href="../29539/index.html">Mail server for the site</a></li>
<li><a href="../295390/index.html">In the first three quarters of 2015, the global venture capital market grew faster than in the whole 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>