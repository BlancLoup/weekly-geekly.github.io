<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On power up</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And an amazing story happened to me, which, if it were written with silver needles in the corners of the eyes, would serve as an edification for those...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On power up</h1><div class="post__text post__text-html js-mediator-article"><h1>  And an amazing story happened to me, which, if it were written with silver needles in the corners of the eyes, would serve as an edification for those who learn. </h1><br>  This story began with the design of a portable device, in which it was desirable to reduce battery consumption in off mode, but the mechanical switch was unacceptable due to design features.  It was also undesirable to use the transistor as a key due to the significant operating currents of the device (more than 3A).  Therefore, a widespread decision was made to block the operation of the power sources (PIs) that make up the device by controlling the work permit signal.  Nothing new or unusual, such schemes can be found 12 to a dozen in devices with autonomous power, however, quite unexpectedly, certain complications arose, which led to a number of instructive conclusions. <br><a name="habracut"></a><br>  To begin with, I will give a scheme, which will be discussed further, it is presented in a simplified version. <br><br><img src="https://habrastorage.org/files/6ee/d06/721/6eed06721cab45b1b57b904b322dcf0d.GIF"><br><br>  Everything is simple here - in the initial state there is a main voltage of 5 volts (battery), but the power sources are turned off, which is provided by the resistor R2.  In this case, the power sources consume a rest current from the main source, which is quite small (in this case, 2 ŒºA + 2 * 1 ŒºA = 4 ŒºA. To turn on, press the S1 button, the voltage from the main source through diodes D3 and D2 goes to the enabling inputs of the PI, which are turned on and start generating the required voltages, including the 3.3 V power supply for the MK. The MK starts up, starts the program and sets a high level on the corresponding pin, which through the diode D1 additionally enables the operation of the power supply. From this point on, you can release the S button  1, the further work of the PI is provided by the output of the MK until the decision is made to disconnect and the MK does not remove the high potential from the diode D1, then the PI will stop working and we will return to the initial state. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This scheme was implemented, tested, and proved to be quite workable.  It has its pitfalls associated with the chattering of the S1 key, but in this case it is not about them. <br><br>  Surprises awaited us elsewhere.  The fact is that the applied MK has a built-in loader through the UART, and for its use an additional switching mode was implemented using auxiliary MK outputs.  From the point of view of the power management scheme, the peculiarity of this mode was that the corresponding output was not involved in the loader program, all outputs after the initial reset should be in the high-impedance (third) state, therefore, when the S1 key is depressed, the device must be powered off ( R2 is provided, which is essential to prevent the MK from hanging in case of an unforeseen entry into the programming mode (the output from the boot program without connecting a programming device to this MK was not implemented  van). <br><br>  However, the reality overturned the rainbow plans, after releasing the S1 button, the device remained on.  We start the search for a malfunction: first, we unsolder the diode D1 and make sure that the shutdown happens - it means that the power-on hold signal comes from the MC (well, yes, there is nowhere else, but you never know). <br>  We suggest that the leakage current of the output is enough to create a voltage across the resistor R2, change it to the nominal 10 kŒ©, the phenomenon does not disappear.  The calculation shows that the leakage current must be at least 0.3mA, which clearly exceeds the leakage by specifications by orders of magnitude.  We change the nominal to 1 kOhm, the device starts to turn off, this means that the current from the output of the MC does not exceed 3 mA.  In principle, the scheme has earned and you can do other things, but the spirit of research calls to figure out where such a large current comes from on the disconnected output (of course, it is not that big, but it exceeds the data of TU - 1 ŒºA by orders of magnitude). <br><br>  We measure the outgoing current of the other outputs in the third state and make sure that everything is within the limits of the specifications, that is, not more than 1 ŒºA.  We return the old face value and try to measure the current at this output of the MK, and here the misunderstandings begin.  As soon as we touch the device probe (portable, by the way, that is, without communication with the network) to this MK pin, the device immediately turns off, and the second probe of the device dangles in the air.  If we look with an oscilloscope, we see a high level of approximately 3.3V.  This behavior of the MC leads to certain suspicions, and to check them we connect an ammeter parallel to the diode D1.  And we observe that when the S1 button is pressed, 300 ŒºA flows into the MK, but when it is released, the device turns off, that is, the device continues to influence the situation. <br><br>  There is an assumption that we are dealing with the so-called ‚Äúthyristor snapping-in‚Äù CMOS structures, which spoiled a lot of blood for developers, but went into non-existence along with the 564 series. But unlike those snaps, which led to a significant through-current, this snapping is weak and may be disturbed even by a slight change in the capacitance connected to the output.  The main condition for snapping is the excess voltage at the chip output over the supply voltage. To check this fact, we remove the voltage waveform at this output of the MK (yellow color) together with the supply voltage of the MK (blue color) in the process of switching on. <br><img src="https://habrastorage.org/files/1c0/676/fc0/1c0676fc06de431f997d7255a58dcd23.png"><br>  And precisely, we observe the confirmation of this hypothesis - the voltage at the MK output stably exceeds the supply voltage until a certain moment, apparently, at this moment the snapping-in occurs. <br><br>  From where we can get an excess at the MK input - the answer is simple: from the main power source through the reverse-offset diode D1.  Let us test this hypothesis, for which we connect in series with the diode D2 a resistor of 2/3 of R2, then we limit the voltage at the control point to less than 3 V, and accordingly, we limit the excess over the power supply of the MC.  We receive the following oscillogram. <br><br><img src="https://habrastorage.org/files/969/813/b51/969813b5140140e18739fbc905b6b2d6.png"><br><br>  It is seen that our assumption was confirmed, the excess occurs only up to the 3V supply value and the device starts to turn off stably when the S1 button is released.  Again, everything is good, the problem is solved, but still we have moments when the voltage at the output exceeds the supply voltage, and I would like to avoid this situation - we have already received an incomprehensible snap once, who knows when it will come out. <br><br>  We install a 10kŒ© resistor at the MK input and connect it to ground.  The oscillogram shows that there is no excess voltage over the power supply (in fact, it is and is about 100 mV, but we believe that it does not exist). <br><br><img src="https://habrastorage.org/files/def/57e/922/def57e922223483ea3c9f8487a3c7e8f.png"><br><br>  From here, it is possible to calculate the current flowing through the reverse-biased diode D1 - about 10 ŒºA, which correlates well with the value from TU - no more than 500 ŒºA at a voltage of -20 V (we have-5 V). <br><br>  How can we reduce this current?  It is enough to replace the Schottky diode with a conventional one and, even with old resistor values, the device begins to turn off stably.  Well, not surprisingly, since a normal diode has a reverse current of no more than 25nA with the same -20V. <br><br>  However, just in case, we do everything possible: we change the Schottky diode to a normal one, reduce the R2 nominal to 10k ohm, install a 6.8k ohm resistor in series with the D2 diode, install a 10k ohm resistor between the output and ground of the MK, and make sure that the device stably turns off. <br><br>  We summarize - the incorrect behavior of the device was caused by the latching state of the MK output caused by the supply of an external voltage source exceeding the supply voltage of the MK through the reverse-biased Schottky diode due to its high (compared to a conventional diode but strictly within the DUT) leakage current. <br><br>  Why the Schottky diodes were initially chosen because of the low fall in the forward direction, although it was possible to open the specifications for the power supplies and see that for them the high level is 1.2V, which is also well achieved by conventional diodes (3.3-0.7&gt; 1.2).  In this case, the habit of minimizing the fall on the diodes and, accordingly, the heat dissipation on them, played a cruel joke with the author. <br><br>  Why the conclusion of the MC went into a latched state, and at some incomprehensible moment, the author does not know, this is surely some kind of technological feature, but in any case the author does not have any complaints about the developers of MC, for the <s>fig</s> does not need to give any impact that goes beyond TU. </div><p>Source: <a href="https://habr.com/ru/post/357928/">https://habr.com/ru/post/357928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357916/index.html">Determining that you are at home using a WiFi router (to automate the smart home)</a></li>
<li><a href="../357918/index.html">I2C sniffer</a></li>
<li><a href="../357920/index.html">Arduino <-> STM32 HAL, or there and back</a></li>
<li><a href="../357922/index.html">As I wrote code for Arduino using Python</a></li>
<li><a href="../357924/index.html">Keyboard layout indicator in the form of a color cube on the table using Arduino</a></li>
<li><a href="../357930/index.html">Making the PC turn on cotton per evening</a></li>
<li><a href="../357932/index.html">Running line on Arduino + control from the smartphone</a></li>
<li><a href="../357934/index.html">LED cube 8x8x8, interesting and beautiful</a></li>
<li><a href="../357936/index.html">Smart Redmond SkyPlug RSP-100S Socket Analysis of the design and the electrical circuit diagram. Identifying deficiencies</a></li>
<li><a href="../357942/index.html">Heavy industry removal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>