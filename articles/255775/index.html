<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithms of intellectual autogeneration of levels in iOS game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I love to look at the starry sky and think about distant worlds, but the fact of the infinity of the universe hardly fits in my head. According to the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithms of intellectual autogeneration of levels in iOS game</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/612/e67/59e/612e6759e645c3edbf3a625bf2559bc9.png"><br><br>  I love to look at the starry sky and think about distant worlds, but the fact of the infinity of the universe hardly fits in my head.  According to the big bang theory, our universe is continuously expanding and cooling from a singular state, but let's assume that our infinite universe is constantly generated according to certain rules, and the number of these rules is limited.  It can be assumed that our universe has already been generated, that is, for each point of the infinite universe, generation was generated according to a finite number of rules (generation was performed an infinite number of times), as a result we have an infinite generated universe. <br><br>  Let's return to our task, we need to intelligently generate maps for the <strong>IPhone / iPad</strong> games of the ‚ÄúMario‚Äù type, for a start we will look at the generation of a map within a field of 128x128 cubes. <br><a name="habracut"></a><br>  Why even generate a map for the game if you can draw it in the map editor?  Developing the iOS game ‚Äútanchiki‚Äù, I made a level editor with the ability to save a level on my server, I expected that the players themselves would draw maps and send them to me.  But the reality turned out to be more severe, the players piled me with thousands of cards, which, to put it mildly, were unfinished, unfinished and simply ugly.  Developing a new game, I firmly decided that the level should be generated automatically and look as far as possible, comparable to the levels from the editor. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>What we have:</strong> <br>  - The map consists of 128x128 blocks, each block has a size of 32x32 pixels; <br>  - The map is stored in the form of an array of 128x128, where: <br><br><ul><li>  0 - empty block; </li><li>  1 - the ground, the character can mix up on this block and can blow it up; </li><li>  2 - stone - a block that can not be blown up; </li><li>  3 - a box with jewels; </li><li>  4 - thorns, on falling on which the player dies; </li></ul><br><br><h4>  Level generation by simple method or random method </h4><br>  To begin with, I decided to implement the function of generating a map with a simple formula that includes the randomization function.  By changing the values ‚Äã‚Äãof the variables in the formula, I hoped to calibrate the map to an acceptable state. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/65f/4d7/3ac/65f4d73ac3fe9ec710169f1ebb5aa892.png"><br><br>  strong&gt; The formula generated the following elements of the game map: <br><br><ol><li>  Floors: the whole map was divided into conditional floors, the distance between the floors was determined by the "Rand" function. </li><li>  Gaps: between floors a random number of passes of random width was generated. </li><li>  Noise: random blocks formed on the floors. </li><li>  Rooms: a random number of rectangular rooms with one, two exits or no exits was formed on each floor. </li><li>  Treadmills: in order for the player to accelerate while running, a random number of straight running tracks were generated on each floor, a ‚Äúceiling‚Äù of random height was randomly drawn over some of them. </li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/636/7f3/c5c/6367f3c5cab254251e4637491a60c10b.png"><br><br>  <strong>Cons level generation method "random"</strong> <br><br><ul><li>  The level passed too quickly, as often the openings between the floors were one above the other. </li><li>  The levels looked too monotonous. </li><li>  Maps visually looked too unpresentable. </li></ul><br><br>  Improving the complexity of the formula for generating a map could have achieved a better result, but I decided to move along a different path. <br><br>  <strong>Requirements the algorithm must meet</strong> <br><br><ul><li>  For this game, the main character must get from point A to point B. </li><li>  While advancing in level, a player should not be stuck or stumble on a dead end. </li><li>  You must have space to fly a jetpack. </li></ul><br><br><h4>  Level generation using path </h4><br>  How to generate maps?  By patterns!  And the templates themselves will contain smaller templates (subpatterns). <br><br>  To begin, let's divide our playing field into 64 squares, 8x8, for each of these squares we will load the values ‚Äã‚Äãfrom the template in the future, let's call this square ‚Äúroom‚Äù.  So, now our map consists of 8x8 = 64 rooms. <br><br>  The essence of the game is to get from point A (entry point) to point B (exit point) while moving from one room to another.  In this case, the entry point is in the upper row of rooms, and the exit point is at the bottom of the map. <br><br>  So, first we need to create a route (path) along which the player should move.  To do this, we divide our rooms into types: <br><br><ul><li>  0: A room that is not in the path of the main route. </li><li>  1: The room from which there is guaranteed to have an exit on the left and on the right. </li><li>  2: The room from which there is guaranteed to have an exit on the left, on the right and below. </li><li>  3: The room from which there is guaranteed to have an exit on the left, right and above. </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/20f/e2c/f1f/20fe2cf1f3e6078604313000f32ea356.png"><br><br>  This algorithm for generating a path resembles the device of a Turing machine; we have a control device (write-read head) that moves through the matrix of rooms.  The number of possible states of the control device is of course and precisely specified, the states correspond to the types of rooms. <br><br><ul><li>  To begin with, we place the first room in the top row, the type of room can be 1 or 2, but for a start we set type 1. </li><li>  Then we have to decide in which direction we should move, for this we take at random a number from 1 to 5, if this number is 1 or 2 - then we move our way to the left, if 2 or 3 - then to the right, if this number is 5 - then we move down, while changing the type of the very first room from 1 to 2 (now the starting room has an exit below). </li><li>  If, while moving, our path ‚Äúrests‚Äù against the screen boundaries on the left or on the right, then we change the direction to the opposite.  It is worth noting that each time we move down, we must overwrite the type of the current room from 1 to 2 (as this room has an exit from below). </li><li>  After moving to the next room, we check from which room we have just moved.  If from a room with type 2 - then now our room can have again type 2 (with the next exit down) or type 3 (exit from the top, left and right).  Since the rooms of type 2 and 3 have exits to the left and to the right, we can repeat our algorithm again and again. </li><li>  If we are already in the bottom row, and the algorithm suggests that we move even lower, then we simply place the exit from the room and complete the algorithm. </li></ul><br><br>  At this stage, we have formed a movement path for the character, now we just fill all the rooms unaffected by the algorithm with zeros (0 is a room that may not have exits at all). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/096/5f7/967/0965f79670ac4a6410a7866062b4bb0f.png"><br><br><h4>  Algorithm parameters </h4><br>  How can you influence the algorithm so that it generates paths with different characteristics, for example, less tortuous or, conversely, more entangled? <br><br>  If you choose a random number from 1 to 7 on the first paragraph of the algorithm, move the number from 1 to 3 and move to the left, with the number from 4 to 6 to the right, and if the number 7 goes down, then during the generation there will be more rooms on each floor such as ‚Äú1‚Äù, this will make the path more confusing.  A random number from 1 to 3, by analogy will make the path less tortuous. <br><br><h4>  Displays the path on the map </h4><br>  <em>On these screenshots, I tiled all-purpose rooms like ‚Äú0‚Äù to better display the path.</em> <br><img src="https://habrastorage.org/getpro/habr/post_images/47a/6f7/f76/47a6f7f7698098fa8be4344b3cd75cdb.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/5ac/874/72f/5ac87472f05a7efe19b3e99ee3add91e.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/97d/1e2/92e/97d1e292ec3fbec0a92cfecf119bd428.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/56e/e55/1b2/56ee551b291eebdd29166c52c5e47451.png"><br><br><h4>  Templates </h4><br>  Each room is a 16x16 square, we have 4 types of rooms, for each type of room the templates will be in a separate .plist file: <br><br>  room0.plist <br>  room1.plist <br>  room2.plist <br>  room3.plist <br><br>  To begin with, we will define restrictions for our types of rooms, rooms of type 1 do not have exits at the bottom and at the top, which means that regardless of the pattern, exits at the top and bottom for rooms of type 1 can be immediately ‚Äúclosed‚Äù.  For rooms of type 2, we ‚Äúclose‚Äù the exit from below, and for a room of type 3 - exit from the top. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a35/5c4/a2d/a355c4a2db0dffd54eb087c53d20ac74.png"><br><br>  Each time for each room of type 1, the program selects any template from the file room1.plist, <br>  and for this template in 50% of cases makes a mirror image from left to right. <br><br>  Consider an example of patterns for rooms of type 1: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d56/6b4/b98/d566b4b98d988ce879628f250c431427.png"><br><br>  When drawing up a map from a template, we use the following rules: <br><br><ul><li>  0 - empty block; </li><li>  1 - the ground, the character can mix up on this block and can blow it up; </li><li>  2 - stone - a block that can not be blown up; </li><li>  3 - a box with jewels; </li><li>  4 - thorns, on falling on which the player dies; </li><li>  7 - ‚Äúsub-pattern‚Äù - a block with a height of 3 and a width of 5. </li><li>  8 - 75% chance that there will be land.  25% - the probability of emptiness. </li><li>  9 - 50% chance that there will be land. </li></ul><br><br><h4>  Masking pattern </h4><br>  If you assemble a card from templates, then on large maps there will be repeated sections with blocks, our task is to make the cards within the same template differ from each other. <br>  To do this, in addition to mirroring the templates horizontally, we enter the numbers 8 and 9 in the templates, which, with a probability of 75% and 50%, respectively, are replaced by one (earth block).  If our GZCH (write-read head) stumbles upon the number 7 - then this section of the template is replaced with a ‚Äúsub-pattern‚Äù, which is read according to the rules similar to the template. <br><br><h4>  Sub-patterns </h4><br>  Subpatterns are also introduced to make two identical patterns different from each other.  There are 7 numbers in the templates - if the algorithm stumbles on the number 7, then it fills the template with any ‚Äúsub-template‚Äù from the boxTemplate.plist file <br><br>  <strong>Examples of sub patterns:</strong> <br><br><blockquote>  00100 <br>  01110 <br>  00100 <br><br>  11111 <br>  01110 <br>  00100 <br><br>  00100 <br>  11111 <br>  00100 <br></blockquote><br><br>  For subpatterns, in 50% of cases we make a mirror image from left to right. <br><br>  I tried to avoid creating a graphical map editor, but for drawing templates I still had to implement it.  The more templates and sub patterns you add to the game, the more diverse your cards will look. <br><br><h4>  Result of using ‚Äúsub-template‚Äù </h4><br>  In these four screenshots, you see <strong>the same template</strong> , which, thanks to the numbers 7,8,9, looks different every time. <br><img src="https://habrastorage.org/getpro/habr/post_images/b8e/7c5/ed8/b8e7c5ed89b0ba07941cff63c999db24.png"><br><br>  In the video you can see how the generation of levels looks like in practice: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/XTXEpPELu08%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700248,15700253,15700258&amp;usg=ALkJrhhxxS_PZW51w69cJ40-30Hg5CygTg" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Perspectives </h4><br><ul><li>  The number of templates directly affects the quality of the level, so adding new templates will greatly improve the gameplay. </li><li>  For more diverse cards, you can make ‚Äúsub-templates‚Äù in ‚Äúsub-templates‚Äù. </li><li>  By changing the scale of the world and the points of entry and exit - you can generate an infinite map, dynamically forming blocks in the way of the character and caching the traversed sections. </li></ul><br><br>  If you are interested in this topic, let me know, I will cover the topic in more detail. <br><br>  To compile this article, I partially used Spelunky game level generation algorithms, but there may be games with more advanced level generation that I don‚Äôt know about. <br><br>  Write in the comments what other games with good level generation you know. <br><br>  <em>All errors on this article, please send in private messages.</em> </div><p>Source: <a href="https://habr.com/ru/post/255775/">https://habr.com/ru/post/255775/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255761/index.html">Algorithms for fast calculation of factorial</a></li>
<li><a href="../255763/index.html">Coffee with cucumbers (Espresso + Cucumber)</a></li>
<li><a href="../255767/index.html">Study protection Artmoney. Part one</a></li>
<li><a href="../255769/index.html">Very subjective review of JS frameworks. AmpersandJS, part 0</a></li>
<li><a href="../255773/index.html">Java-based configuration of embedded Jetty / Spring MVC / Spring Security</a></li>
<li><a href="../255779/index.html">Microsoft and Adobe released a set of updates for their products, April 2015</a></li>
<li><a href="../255781/index.html">A new issue of the journal "In the clouds. RF"</a></li>
<li><a href="../255785/index.html">Lumen - a new PHP microframe from the developer Laravel</a></li>
<li><a href="../255787/index.html">How to make a Laser Squad from XCOM: etude for GDB in OSX</a></li>
<li><a href="../255789/index.html">Analysis of external links in MegaIndex and updating the procurement algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>