<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Looking for errors in Mono: hundreds of them</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Large projects check interesting. As a rule, they manage to find various interesting mistakes and tell people about them. It is also a good way to tes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Looking for errors in Mono: hundreds of them</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/91c/df3/ef6/91cdf3ef660140bd866711f9cfddc54d.png"></div><p></p><br>  Large projects check interesting.  As a rule, they manage to find various interesting mistakes and tell people about them.  It is also a good way to test our analyzer and improve its various aspects.  I have long wanted to check 'Mono', and finally this opportunity has appeared.  And, it should be said, the test justified itself, since it was possible to find a lot of interesting things.  About what was found, what nuances arose when checking, and there will be this article. <br><a name="habracut"></a><br><h2>  about the project </h2><br>  <a href="http://www.mono-project.com/">Mono</a> - a project to create a full-fledged implementation of the .NET Framework system based on free software.  The main developer of the Mono project is <a href="https://www.xamarin.com/">Xamarin</a> Corporation, formerly Novell. <br><br>  Mono includes the C # compiler, the .NET runtime ‚Äî mono (with JIT support) and mint (without JIT support), a debugger, and a number of libraries, including the implementation of WinForms, ADO.NET and ASP.NET, and the smcs compilers (for creating applications for Moonlight) and vbc (for applications written in VB.NET). <br><br>  The project also develops bindings for the GTK + graphics library on the .NET platform. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The source code is available for download in the <a href="https://github.com/mono/mono">repository on GitHub</a> .  The number of lines of code when checking the repository loaded from GitHub was about 6.3 million (excluding blank lines).  This amount of code base looks extremely attractive - probably somewhere in the code errors crept in.  On the other hand, checking such a large project will also be useful for the analyzer, since it will serve as a good stress test. <br><br><h2>  Analysis tool, verification features </h2><br>  The static code analyzer <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> acted as an analysis tool.  Currently, the C # analyzer includes <a href="http://www.viva64.com/ru/d/0368/">over 100 diagnostic rules</a> , each of which is accompanied by documentation containing information about the error, possible consequences and remedies.  Since the release, it has been possible to check many different projects written in C #, such as <a href="http://www.viva64.com/ru/b/0363/">Roslyn</a> , <a href="http://www.viva64.com/ru/b/0400/">Xamarin.Forms</a> , <a href="http://www.viva64.com/ru/b/0376/">Space Engineers</a> , <a href="http://www.viva64.com/ru/b/0365/">CoreFX</a> , <a href="http://www.viva64.com/ru/b/0361/">Code Contracts</a> , etc. (the full list can be found <a href="http://www.viva64.com/ru/inspections/">here</a> ). <br><br>  The analyzer itself is available for <a href="http://www.viva64.com/ru/pvs-studio-download/">download at the link</a> .  The trial version should be enough for the first acquaintance with the analyzer.  If you are interested in the tool, <a href="http://www.viva64.com/ru/about-feedback/">write to us</a> and we will provide a key for more intimate acquaintance and help with its setting. <br><br>  I also want to note that the article did not cite errors from files containing some mention of Microsoft at the beginning of the file.  This is done mainly in order to avoid possible intersections with errors mentioned in other articles.  In any case, there was enough material already. <br><br>  As always, the article does not provide all the errors, as this would greatly increase its volume.  I tried to choose the most interesting places, but many still remained outside the scope of the article.  Do not think that I want to reproach the authors of 'Mono' for something.  The number of errors due to the large size of the project, and this is understandable.  Nevertheless, it would be good to correct the existing errors and prevent the appearance of new ones.  To help with this will help the introduction of static analysis in the development process.  More on this is written below in the corresponding section. <br><br><h2>  A couple of words about why checking projects is not a trivial exercise. </h2><br>  In an ideal world, checking projects and writing an article is done according to the following scenario: I found a project -&gt; I collected -&gt; I checked it with the analyzer -&gt; I found a sufficient number of errors -&gt; I wrote an article.  Everyone is happy, everyone is happy: we ticked a checked project, people read a new article, the developers learned about errors in the code, the author did a good job. <br><br>  Alas, our world is not perfect.  At certain stages, problems often arise, this time with the assembly.  If there is a detailed assembly instruction, or if it is easy to do on your own, this is great!  Then you can safely proceed to the verification of the project and writing the article.  Otherwise, a headache begins.  It happened with 'Mono'.  The <i>net_4_x.sln</i> solution, which combines C # projects, is not going out of the box (that is, immediately after downloading from the repository).  One of the build scripts turned out to be inoperative (the path was incorrectly spelled (possibly due to the fact that the directory hierarchy changed over time)), but its correction also did not bear fruit. <br><br>  Of course, I did not want to retreat, so I experimented with the assembly even during off-hours, but the result turned out to be a bit.  As a result, after taking a fair amount of time with this, it was decided to write the article ‚Äúas is‚Äù. <br><br>  Periodically in the articles, I repeat that in order to fully validate the project, it should be compiled - with all dependencies, without errors and p.  As a rule, I try to achieve this, but there are exceptions to the rules, as in this case. <br><br>  Of course, checking an unassembled project is not good for several reasons: <br><br><ul><li>  project analysis is not as good as it could be.  It is a fact.  What exactly the quality is reduced depends on the implementation of the diagnostic rule.  Perhaps a false positive will appear, or vice versa, a useful trigger will not be issued; </li><li>  when viewing the log, you need to be an order of magnitude more attentive, since there arises (albeit small) the probability of the occurrence of false positives, which would not exist if the project was correctly assembled </li><li>  as some useful operations disappear, it is possible to miss interesting errors that could get into the article and which the developers would learn about (however, they can learn about these errors by checking the project themselves); </li><li>  you have to write sections "A couple of words about why checking projects ...". </li></ul><br>  Nevertheless, there were many suspicious places, some of which will be discussed below. <br><br><h2>  Test results </h2><br>  Recently, in the articles we are trying to provide statistics on a verified project: the total number of warnings, the number of false positives and real errors. <br><br>  Unfortunately, this time I can not give such statistics.  First, the code, as well as warnings, a lot.  If the total number of warnings analyzed is several dozen, you can view them and give a rough estimate.  When the count of warnings goes to hundreds, the task of analysis becomes nontrivial. <br><br>  Secondly, on a fully compiled project, these statistics can change in any of the directions: a decrease or increase in the number of warnings.  In the assembled project, more semantic information is available to the analyzer, therefore, it can conduct a deeper analysis (false positives will disappear, new warnings will appear).  For those who are interested in how semantic information affects the analysis and by what principles it all works, I suggest reading the article " <a href="http://www.viva64.com/ru/b/0399/">Introduction to Roslyn. Using the development of static analysis tools</a> ." <br><br>  But you probably can't wait to see what interesting things you found in the project code?  Well, let's look at some code snippets. <br><br>  <b>Same subexpressions within the same expression</b> <br><br>  One of the most common mistakes.  The reasons for the occurrence are many.  These include copy-paste, similar variable names, abuse of IntelliSense, and trivial inattention.  Were distracted for a minute - made a mistake. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExactInference</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TypeSpec u, TypeSpec v</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ac_u = (ArrayContainer) u; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ac_v = (ArrayContainer) v; .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ga_u = u.TypeArguments; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ga_v = v.TypeArguments; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (u.TypeArguments.Length != u.TypeArguments.Length) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return 0; .... }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are identical sub-expressions 'u.TypeArguments.Length' to the left and the right!  generic.cs 3135 <br><br>  Now that the method code is simplified, it is easy to notice an error in the condition of the <i>if</i> operator ‚Äî the parameter <i>v</i> , rather than <i>u</i> , should act as the <i>TypeSpec instance</i> in the second subexpression.  Perhaps the mistake was made because the external characters <i>u</i> and <i>v</i> are similar, and without focusing on this expression, you can easily overlook the trick. <br><br>  The rest of the code was given in order to indicate that these parameters are mainly used together, on the basis of which it is possible to conclude an error and the correct code version: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (u.TypeArguments.Length != v.TypeArguments.Length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  Not less interesting case. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BetterFunction</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!candidate_params &amp;&amp; !candidate_pd.FixedParameters [j - j].HasDefaultValue) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= return true; } .... if (!candidate_pd.FixedParameters [j - 1].HasDefaultValue &amp;&amp; best_pd.FixedParameters [j - 1].HasDefaultValue) return true; if (candidate_pd.FixedParameters [j - 1].HasDefaultValue &amp;&amp; best_pd.HasParams) return true; .... }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are no sub-expressions.  ecore.cs 4832 <br><br>  In one of the index calculation expressions, the programmer made a mistake by writing the expression <i>j - j</i> .  Thus, access to the first element of the array will always be performed.  If this were required, it would be more logical to use an integer literal equal to 0. The fact that this is really an error is confirmed by other index calls to the same array: <i>j - 1</i> .  I suppose that, again, the error was not noticed due to some similarity in writing the characters <i>j</i> and <i>1</i> , so that during a cursory review of the code this could be overlooked. <br><br>  <b>Note colleagues Andrei Karpov.</b>  When I read the draft of the article, I was about to make a note to Sergei that he apparently had written the wrong part of the code.  I looked into the code and did not see the error.  Just starting to read the description, I realized what was the matter.  I confirm this typo is very difficult to notice.  Our PVS-Studio is gorgeous! <br><br>  Continue to "break eyes": <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRequestLine</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((ic &gt;= <span class="hljs-string"><span class="hljs-string">'A'</span></span> &amp;&amp; ic &lt;= <span class="hljs-string"><span class="hljs-string">'Z'</span></span>) || (ic &gt; <span class="hljs-number"><span class="hljs-number">32</span></span> &amp;&amp; c &lt; <span class="hljs-number"><span class="hljs-number">127</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'('</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">')'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'&lt;'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'&lt;'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'@'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">','</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">';'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">':'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'\\'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'"'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'/'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'['</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">']'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'?'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'='</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'{'</span></span> &amp;&amp; c != <span class="hljs-string"><span class="hljs-string">'}'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are identical sub-expressions 'c! =' &lt;'' Operator.  HttpListenerRequest.cs 99 <br><br>  Within the expression, the subexpression <i>c! = '&lt;'</i> Occurs twice.  Probably just an extra comparison. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShouldSerializeLinkHoverColor</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> grid_style.LinkHoverColor != grid_style.LinkHoverColor; }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are identical sub-expressions of the 'grid_style.LinkHoverColor' on the left!  DataGrid.cs 2225 <br><br>  Simplify the method to highlight the error is not needed.  In comparison, the same subexpressions are <i>involved</i> - <i>grid_style.LinkHoverColor</i> . <br><br>  The correct code should look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShouldSerializeLinkHoverColor</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> grid_style.LinkHoverColor != default_style.LinkHoverColor; }</code> </pre> <br>  Why so?  Above there are a number of methods in which various properties of the <i>grid_style</i> object <i>are</i> compared with properties of the <i>default_style</i> object.  But in the latter case, relaxed and made a mistake.  Hmm, " <a href="http://www.viva64.com/ru/b/0260/">last line effect</a> "? <br><br>  Well, this is a classic typos: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AreEqual</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">VisualStyleElement value1, VisualStyleElement value2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value1.ClassName == value1.ClassName &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= value1.Part == value2.Part &amp;&amp; value1.State == value2.State; }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0381/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are identical sub-expressions 'value1.ClassName' to the left.  ThemeVisualStyles.cs 2141 <br><br>  Accidentally compared the <i>value1.ClassName</i> subexpression with itself.  Of course, in the second case, the <i>value2</i> object should have been used. <br><br>  I think if you make such a code using a table method, then the error will be much easier to notice.  This is a good prevention of such typos: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AreEqual</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">VisualStyleElement value1, VisualStyleElement value2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value1.ClassName == value1.ClassName &amp;&amp; value1.Part == value2.Part &amp;&amp; value1.State == value2.State; }</code> </pre> <br>  Code that is formatted this way is much easier to read, and it is easier to notice that there is something wrong with one column.  For details on code alignment, see Chapter 13 from the book " <a href="http://www.viva64.com/ru/b/0391/">The Main Question of Programming, Refactoring, and All That</a> ." <br><br>  The remaining suspicious places detected by diagnostic rule V3001 are listed in the <a href="http://cppfiles.com/Mono-V3001.txt">file</a> . <br><br>  <b>Same conditions in the 'else if' construct</b> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TitleStyle { None = <span class="hljs-number"><span class="hljs-number">0</span></span>, Normal = <span class="hljs-number"><span class="hljs-number">1</span></span>, Tool = <span class="hljs-number"><span class="hljs-number">2</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> TitleStyle title_style; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Point MenuOrigin { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.title_style == TitleStyle.Normal) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= pt.Y += caption_height; } else if (this.title_style == TitleStyle.Normal) { // &lt;= pt.Y += tool_caption_height; } .... }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0382/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0382/">V3003</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 597, 599. Hwnd.cs 597 <br><br>  The same expression <i>this.title_style == TitleStyle.Normal is checked twice</i> .  Obviously, this code contains an error.  After all, regardless of the value of the above expression, the expression <i>pt.Y + = tool_caption_height</i> will never be executed.  I will assume that the second case implied a comparison of the <i>title_style</i> field with the constant <i>TitleStyle.Tool</i> . <br><br>  <b>Same 'if-then' and 'if-else' bodies</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawText</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (showNonPrint) TextRenderer.DrawTextInternal (g, text, font, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rectangle (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)x, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)y), max_size), color, TextFormatFlags.NoPadding | TextFormatFlags.NoPrefix, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> TextRenderer.DrawTextInternal (g, text, font, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rectangle (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)x, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)y), max_size), color, TextFormatFlags.NoPadding | TextFormatFlags.NoPrefix, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0402/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0402/">V3004</a> The 'then' statement is equivalent to the 'else' statement.  System.Windows.Forms-net_4_x TextBoxTextRenderer.cs 79 <br><br>  Regardless of the value of the <i>showNonPrint</i> variable, the static <i>DrawTextInternal</i> method of the <i>TextRenderer</i> class with the same arguments will be called.  It is possible that the error was made due to the use of copy-paste.  The method call was copied, but the arguments were forgotten. <br><br>  <b>The return value of the method is not used.</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConvertTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">.... </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Type destinationType</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (destinationType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString(); } } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0406/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0406/">V3010</a> The return value of the function 'ToString' is required to be utilized.  ColumnTypeConverter.cs 91 <br><br>  A very interesting mistake, apparently, with far-reaching consequences.  From the code you can see that type checking is performed, and if the type is <i>string</i> , a check is performed for <i>null</i> equality.  And then - the most interesting.  If the <i>value</i> reference is <i>null</i> , an empty string is returned, otherwise ... Most likely, it was assumed that the string representation of the object will be returned, but the <i>return statement is</i> missing.  Therefore, the return value of the <i>ToString ()</i> method will not be used in any way, and the <i>ConvertTo</i> method <i>will</i> continue its execution.  Thus, because of the forgotten operator <i>return</i> , the logic of the program has changed.  I assume that the correct version of the code should look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString(); }</code> </pre><br>  <b>What error is described here, you will find out later</b> <br><br><p><img src="https://habrastorage.org/files/404/bc2/305/404bc23051444d67a43b698a295c9bfc.png"></p><br>  I usually simplify the methods so that the error is easier to notice.  I propose to play the game.  Find the error in the following method fragment.  To make it more interesting, I will not write the type of error and simplify all the code (and so provide only part of the method). <br><br><p><img src="https://habrastorage.org/files/fb7/895/b4f/fb7895b4f3c74604bacb5196b5aea275.png"></p><br>  Well, how are you doing?  For some reason it seems to me that most did not even try.  I will not torment you. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0383/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0383/">V3012</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value: Color.FromArgb (150, 179, 225).  ProfessionalColorTable.cs 258 <br><br>  Here it is, the ill-fated ternary operator: <br><br><pre> <code class="cs hljs">button_pressed_highlight = use_system_colors ? Color.FromArgb (<span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">179</span></span>, <span class="hljs-number"><span class="hljs-number">225</span></span>) : Color.FromArgb (<span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">179</span></span>, <span class="hljs-number"><span class="hljs-number">225</span></span>);</code> </pre> <br>  Regardless of the value of the use_system_colors variable, the button_pressed_highlight object will be assigned the same value.  If you think that such errors are difficult to track, I suggest you look at the entire file ( <a href="">ProfessionalColorTable.cs</a> ) and understand that such errors are not just difficult to track on your own - this is simply unrealistic. <br><br>  By the way, there are many such places (as many as 32), which even suggests that this is not a mistake at all, but such is the intention.  Nevertheless, the code looks strange, and I would advise checking it out.  Even if this is not an error, but the expected logic, it would be easier to use ordinary assignment than to write strange ternary operators that are confusing.  The remaining warnings V3012 are given in the <a href="http://cppfiles.com/Mono-V3012.txt">file</a> . <br><br>  <b>Using another cycle counter</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; PermissionSet ps = (obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PermissionSet); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ps == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state != ps.state) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (list.Count != ps.Count) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.Count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ps.list.Count; j++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (list [i].Equals (ps.list [j])) { found = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!found) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0385/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0385/">V3015</a> It is likely that a variable is being compared inside the 'for' operator.  Consider reviewing 'i' corlib-net_4_x PermissionSet.cs 607 <br><br>  A suspicious condition to exit a nested loop looks like: <i>i &lt;ps.list.Count</i> .  The variable <i>j</i> acts as a loop counter, but the output condition uses the outer loop counter ‚Äî variable <i>i</i> . <br><br>  The intentions of the author of the code are clear - check that the collections contain the same elements.  But if it turns out that some element of the <i>list</i> collection is not contained in <i>ps.list</i> , the exit from the nested loop will not be performed using the <i>break</i> statement.  At the same time, within the same cycle, the variable <i>i</i> does not change, i.e.  <i>i &lt;ps.list.Count</i> expression will always be <i>true</i> .  As a result, the cycle will be executed until the collection overflows the boundary (due to the constant increment of the counter <i>j</i> ). <br><br>  <b>Checking the wrong</b> <b><i>null</i></b> <b>reference</b> <b>after casting with the</b> <b><i>as</i></b> <b>operator</b> <br><br>  As it turned out, this is a typical error for the C # language.  She <a href="http://www.viva64.com/ru/examples/V3019/">is in</a> almost every project on which the article is written.  Typically, diagnostic rule <a href="http://www.viva64.com/ru/d/0388/">V3019</a> detects cases of the following: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> derived = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Derived; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// do something } // work with 'derived' object</span></span></code> </pre> <br>  Checking <i>base == null will</i> save only if the <i>base is</i> indeed <i>null</i> , and then it doesn‚Äôt matter to us whether the cast succeeded or not.  But it is obvious that link verification was <i>derived</i> .  And then, if <i>base! = Null</i> and the conversion failed, and then the method works with the members of the <i>derived</i> object, an exception of type <i>NullReferenceException</i> will be generated. <br><br>  <b>Moral:</b> if you use this pattern, make sure that you check the correct link for <i>null</i> equality. <br><br>  But this is a theory.  Let's see what we found in practice: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> o</span></span></span><span class="hljs-function">)</span></span> { UrlMembershipCondition umc = (o <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UrlMembershipCondition); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (String.Compare (u, <span class="hljs-number"><span class="hljs-number">0</span></span>, umc.Url, ....) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0388/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0388/">V3019</a> Possibly an incorrect variable is compared to null after type conversion using 'as' keyword.  Check variables 'o', 'umc'.  UrlMembershipCondition.cs 111 <br><br>  The pattern is one to one described above.  If the object type <i>o is</i> incompatible with the <i>UrlMembershipCondition</i> type <i>,</i> and the object <i>o is</i> not <i>null</i> , then an attempt to access the <i>umc.Url</i> property will generate an exception of type <i>NullReferenceException</i> . <br><br>  Accordingly, to correct the error, it is necessary to correct the check: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (umc == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre><br>  Take a look at another blooper. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QSortArrange</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">.... </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v0, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v1, ....</span></span></span><span class="hljs-function">)</span></span> { IComparable cmp; .... cmp = v1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IComparable; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v1 == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || cmp.CompareTo (v0) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0388/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0388/">V3019</a> Possibly an incorrect variable is compared to null after type conversion using 'as' keyword.  Check variables 'v1', 'cmp'.  Array.cs 1487 <br><br>  The situation is similar to that described above.  Unless in the case of an unsuccessful cast, an <i>NullReferenceException</i> exception will be <i>thrown</i> right there - right when checking the expression. <br><br>  In general, the situation in other places is similar, so I‚Äôll just give you another 12 warnings in a <a href="http://cppfiles.com/Mono-V3019.txt">text file</a> . <br><br>  <b>Unqualified exception exception</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadEmptyContent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlReader r, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (r.MoveToContent(); r.NodeType != XmlNodeType.EndElement; r.MoveToContent()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.NamespaceURI != DbmlNamespace) r.Skip(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> UnexpectedItemError(r); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } .... }</span></span></code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0410/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0410/">V3020</a> An unconditional 'throw' within a loop.  System.Data.Linq-net_4_x XmlMappingSource.cs 180 <br><br>  At the first iteration of the loop, an exception of type <i>UnexpectedItemError</i> will be generated.  At least, it looks weird.  By the way, Visual Studio highlights the object <i>r</i> in the section for changing the loop counter with a hint about unreachable code.  But, probably, the author of the code did not use Visual Studio, or simply did not notice the warning, which is why the error remained in the code. <br><br>  <b>Suspicious 'if' Operators</b> <br><br>  Periodically there are errors of this type, when there are 2 identical 'if' operators in the method, and the values ‚Äã‚Äãof the objects used in the conditional expressions of these operators do not change between them.  If any of these conditional expressions are true, the method body will be exited.  Thus, the second 'if' statement will never be executed.  Let's look at a snippet of code in which a similar error was made: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastIndexOfAny</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> [] anyOf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_stringLength == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_stringLength == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0390/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0390/">V3021</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  This means that the statement is a senseless corlib-net_4_x String.cs 287 <br><br>  The execution of the method never reaches the second <i>if statement</i> given in this fragment, since if <i>this.m_stringLength == 0</i> , the output will be made when the first conditional statement is executed.  This code would be justified if the value of the <i>m_stringLength</i> field were changed between <i>if statements</i> , but this is not the case. <br><br>  The consequences of the error depend on the reason for its occurrence: <br><br><ul><li>  if both conditional expressions are correct (from the point of view of logic), and the second code is simply redundant - there is nothing terrible, but you should remove it in order not to confuse other people; </li><li>  if one of the operators was meant to test another expression, or if the expression was true, other actions had to be performed - this is a more serious problem, indicating the presence of an error in the logic of the program.  Then it is worth taking the solution of the issue more seriously. </li></ul><br>  An example of a second, more serious error case can be seen in the following code snippet (click on image to enlarge): <br><br><p><img src="https://habrastorage.org/files/610/e76/88f/610e7688f2ae4bc997d38de8820e15e2.png"></p><br>  Notice the error in this code is not difficult.  Just kidding, just kidding, of course.  But not for the analyzer.  Let us resort to our standard code simplification method to make everything clearer: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> PaperKind </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPaperKind</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (width == <span class="hljs-number"><span class="hljs-number">1100</span></span> &amp;&amp; height == <span class="hljs-number"><span class="hljs-number">1700</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PaperKind.Standard11x17; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (width == <span class="hljs-number"><span class="hljs-number">1100</span></span> &amp;&amp; height == <span class="hljs-number"><span class="hljs-number">1700</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PaperKind.Tabloid; .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0390/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0390/">V3021</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  If it‚Äôs a statement, it‚Äôs a senseless System.Drawing-net_4_x PrintingServicesUnix.cs 744 <br><br>  If the expression <i>width == 1100 is</i> true <i>&amp;&amp; height == 1700</i> , only the first <i>if statement</i> will be executed.  However, the values ‚Äã‚Äãreturned for the truth of this expression are different, so you cannot just say that the second <i>if statement is</i> superfluous.  Moreover - most likely in its condition there should be another expression.  There is a violation of the logic of the program. <br><br>  Finally, I would like to consider another piece of code with a similar error: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializeCore</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SerializationStore store, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> absolute</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException (<span class="hljs-string"><span class="hljs-string">"value"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (store == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException (<span class="hljs-string"><span class="hljs-string">"store"</span></span>); CodeDomSerializationStore codeDomStore = store <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CodeDomSerializationStore; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (store == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException (<span class="hljs-string"><span class="hljs-string">"store type unsupported"</span></span>); codeDomStore.AddObject (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, absolute); }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0390/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0390/">V3021</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  CodeDomComponentSerializationService.cs 562 <br><br>  This warning intersects with the warning V3019, since there is clearly a <i>null</i> test pattern after the cast with the <i>as</i> operator of the wrong link.  But whatever warning is issued is a mistake. <br><br>  There were other similar warnings: <br><br><ul><li>  V3021 There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  Mono.Data.Sqlite-net_4_x SQLiteDataReader.cs 270 </li><li>  V3021 There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  This means that the statement is a senseless system. Web-net_4_x HttpUtility.cs 220 </li><li>  V3021 There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  CodeDomComponentSerializationService.cs 562 </li><li>  V3021 There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  This means that the statement is a senseless Mono.Security.Providers.DotNet-net_4_x DotNetTlsProvider.cs 77 </li></ul><br>  <b>Suspicious format lines</b> <br><br>  Diagnostic rule <a href="http://www.viva64.com/ru/d/0392/">V3025</a> detects erroneously formatted strings.  It is also a type of error that occurs in many verifiable projects.  Situations of 2 types are detected: <br><br><ul><li>  the format string is expecting more parameters than they are presented; </li><li>  The format string is expecting fewer parameters than they are presented. </li></ul><br>  In the first case, an exception of type <i>FormatException</i> will be generated; in the second case, unused arguments will simply be ignored.  Anyway, you should pay attention to such places and fix the code properly. <br><br>  Of course, I would not recall this diagnostic rule, if such errors were not found in the code. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IMessageSink </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientChannelSinkChain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, ....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (url != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> msg = String.Format ( <span class="hljs-string"><span class="hljs-string">"Cannot create channel sink to connect to URL {0}. An appropriate channel has probably not been registered."</span></span>, url); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemotingException (msg); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> msg = String.Format ( <span class="hljs-string"><span class="hljs-string">"Cannot create channel sink to connect to the remote object. An appropriate channel has probably not been registered."</span></span>, url); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemotingException (msg); } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0392/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0392/">V3025</a> Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: url.  corlib-net_4_x RemotingServices.cs 700 <br><br>  I want to draw your attention to the second line of formatting.  It is a string literal, in which argument substitution is not provided (as opposed to the format string above).  However, the <i>Format</i> method takes a <i>url</i> object as its second argument.  It follows from the above that the <i>url</i> object will simply be ignored when forming a new line, and information about it will not be included in the exception text. <br><br>  In C # 6.0, <a href="https://msdn.microsoft.com/ru-ru/library/dn961160.aspx">interpolated strings</a> were added, which in some cases will help avoid problems associated with the use of format strings, including with an inappropriate number of arguments. <br><br>  Consider another piece of erroneous code. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format (<span class="hljs-string"><span class="hljs-string">"ListViewSubItem {{0}}"</span></span>, text); }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0392/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0392/">V3025</a> Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: text.  System.Windows.Forms-net_4_x ListViewItem.cs 1287 <br><br>  Based on the format string, it can be concluded that the final line should have text in curly brackets.  In fact, the resulting string will look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-string"><span class="hljs-string">"ListViewSubItem {{0}}"</span></span></code> </pre> <br>  To correct this error, the interpolated lines would be perfect, using which the method could be rewritten as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"ListViewSubItem {{</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{text}</span></span></span><span class="hljs-string">}}"</span></span>,; }</code> </pre> <br>  Or, remaining true to the <i>String.Format</i> method, it was worth adding one brace on each side.  Then the format string would look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-string"><span class="hljs-string">"ListViewSubItem {{{0}}}"</span></span></code> </pre> <br>  And the last code snippet with formatting strings.  As always, the most interesting thing is left for dessert: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadEntropy</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.IsEmptyElement) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlException ( String.Format (<span class="hljs-string"><span class="hljs-string">"WS-Trust Entropy element is empty.{2}"</span></span>, LineInfo ())); .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/d/0392/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/d/0392/">V3025</a> Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Format items not used: {2}.  Arguments not used: 1st.  System.ServiceModel-net_4_x WSTrustMessageConverters.cs 147 <br><br>  I do not know how the formatting element with the index '2' got into the formatting string, but it leads to a very interesting error.  It was planned to throw an exception with some text made up of a format string.  And an exception will be generated.  The exception is of type <i>FormatException</i> , because for the current formatting line, 3 arguments are needed (since the third one is required), and only one is presented. <br><br>  If in some way only the number of the requested argument is confused (for example, during refactoring), it will not be difficult to correct the error: <br><pre> <code class="cs hljs"><span class="hljs-string"><span class="hljs-string">"WS-Trust Entropy element is empty.{0}"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other suspicious places found by rule V3025 are listed in the </font></font><a href="http://cppfiles.com/Mono-V3025.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Null reference dereferencing</font></font></b> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsContractMethod</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> methodName, Method m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TypeNode genericArgument</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m.Name != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; m.Name == methodName &amp;&amp; (m.DeclaringType.Equals (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ContractClass) <span class="hljs-comment"><span class="hljs-comment">// &lt;= || (m.Parameters != null &amp;&amp; m.Parameters.Count == 3 &amp;&amp; m.DeclaringType != null &amp;&amp; // &lt;= m.DeclaringType.Name != ContractClassName)); }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0414/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0414/"><font style="vertical-align: inherit;">V3027</font></a><font style="vertical-align: inherit;"> The variable "m.DeclaringType" was used. Mono.CodeContracts-net_4_x ContractNodes.cs 211 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before </font><i><font style="vertical-align: inherit;">accessing the </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> property of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeclaringType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> property </font><font style="vertical-align: inherit;">, the programmer decided to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play it safe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and check </font><i><font style="vertical-align: inherit;">DeclaringType</font></i><font style="vertical-align: inherit;"> for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inequality </font><font style="vertical-align: inherit;">so that it does not accidentally dereference the null reference. The desire is clear and completely legitimate - everything is correct. But it still does not take action, because the </font><font style="vertical-align: inherit;">instance method </font><i><font style="vertical-align: inherit;">Equals</font></i><font style="vertical-align: inherit;"> is called </font><font style="vertical-align: inherit;">above the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeclaringType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> property </font><font style="vertical-align: inherit;">, which means that </font><i><font style="vertical-align: inherit;">DeclaringType == null</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, an exception of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be </font><i><font style="vertical-align: inherit;">thrown</font></i><font style="vertical-align: inherit;"> . To solve the problem, you can, for example, transfer the test to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inequality </font><font style="vertical-align: inherit;">above by code, or use the null-conditional operator ('?.'), Available in C # 6.0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another case.</font></font><br><br><pre> <code class="cs hljs">Node leftSentinel; .... <span class="hljs-function"><span class="hljs-function">IEnumerator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInternalEnumerator</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Node curr = leftSentinel; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((curr = curr.Nexts [<span class="hljs-number"><span class="hljs-number">0</span></span>]) != rightSentinel &amp;&amp; curr != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0414/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0414/"><font style="vertical-align: inherit;">V3027</font></a><font style="vertical-align: inherit;"> The variable 'curr' was used in the same logical expression. </font><font style="vertical-align: inherit;">Mono.Parallel-net_4_x ConcurrentSkipList.cs 306 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And again the same situation. </font><font style="vertical-align: inherit;">If </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curr == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it will exit the loop. </font><font style="vertical-align: inherit;">But if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curr</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was initially </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (i.e. at the time of executing the code </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leftSentinel == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), we again get a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exception </font><font style="vertical-align: inherit;">. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redundant verification</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In checked projects, periodically there are expressions of the following form or the like:</font></font><br><br><pre> <code class="cs hljs">!aa || (aa &amp;&amp; bb)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> They can be simplified to the following expression: </font></font><br><br><pre> <code class="cs hljs">!aa || bb</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps in some cases you will get a performance gain (even if it is insignificant), but the second variant is also easier to read, despite the fact that it is logically equivalent to the first one (in case the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aa expression</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not change between calls). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is possible that instead of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aa there</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> should have been another subexpression:</font></font><br><pre> <code class="cs hljs">!aa || (cc &amp;&amp; bb)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then we are talking about this error. </font><font style="vertical-align: inherit;">Anyway, in the PVS-Studio analyzer there is a diagnostic rule </font></font><a href="http://www.viva64.com/ru/d/0416/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3031</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which detects such cases. </font><font style="vertical-align: inherit;">Consider a few code fragments that were found with its help:</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opc</span></span></span><span class="hljs-function">)</span></span> { Debug.Assert(opc != OpCodes.Ret || ( opc == OpCodes.Ret &amp;&amp; stackHeight &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)); .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="http://www.viva64.com/ru/d/0416/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3031 Alert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be simplified.</font></font> The '||'<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operator is surrounded by opposite expressions. </font><font style="vertical-align: inherit;">mcs-net_4_x ILGenerator.cs 456 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redundant code. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accessing the opc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object </font><font style="vertical-align: inherit;">does not change its value, so the expression can be simplified:</font></font><br><br><pre> <code class="cs hljs">Debug.Assert(opc != OpCodes.Ret || stackHeight &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Another code snippet: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validate</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> checkAutoValidate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((checkAutoValidate &amp;&amp; (AutoValidate != AutoValidate.Disable)) || !checkAutoValidate) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Validate (); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="http://www.viva64.com/ru/d/0416/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3031 Alert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be simplified.</font></font> The '||'<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operator is surrounded by opposite expressions. </font><font style="vertical-align: inherit;">System.Windows.Forms-net_4_x ContainerControl.cs 506 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The situation is similar to the previous one. </font><font style="vertical-align: inherit;">The expression is easily and painlessly simplified to the following form:</font></font><br><br><pre> <code class="cs hljs">!checkAutoValidate || (AutoValidate != AutoValidate.Disable)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some of the warnings I have selected are listed in the </font></font><a href="http://cppfiles.com/Mono-V3031.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formatting code that does not comply with the logic.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When developing diagnostic rules like the </font></font><a href="http://www.viva64.com/ru/d/0400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3033</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , there were debates about how relevant they are. The fact is that diagnostics, tied to the formatting of the code, are very specific, since many editors / development environments (the same Visual Studio) themselves format the code in the course of its writing. Therefore, the probability of making such an error is very small. I rarely met such errors in the projects being checked, but a couple of them were found in 'Mono'.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> header ] { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fields.Contains (header)) fields.Add (header, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> fields.Remove (header); } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0400/"><font style="vertical-align: inherit;">V3033</font></a><font style="vertical-align: inherit;"> It is possible that this 'else' branch must apply to the previous 'if' statement. HttpCacheVaryByHeaders.cs 159 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is formatted in such a way that it may seem as if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">else</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> belongs to the first </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . But the compiler is completely indifferent to how your code is formatted, so it will decrypt this fragment in its own way, associating </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">else</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the second </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as it should be. There is an interesting mistake. Code formatted according to a given logic should look like this:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fields.Contains (header)) fields.Add (header, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> fields.Remove (header);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A similar warning occurred again: V3033 It is possible that this "else" branch must apply. </font><font style="vertical-align: inherit;">HttpCacheVaryByParams.cs 102 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another diagnostic rule, </font></font><a href="http://www.viva64.com/ru/d/0426/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3043,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be assigned to this category </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Error code:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yyerror</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] expected</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; expected.Length; ++ n) ErrorOutput.Write (<span class="hljs-string"><span class="hljs-string">" "</span></span>+expected[n]); ErrorOutput.WriteLine (); .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="http://www.viva64.com/ru/d/0426/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3043</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The code's operational logic does not correspond with its formatting.</font></font> The statement is indented.  It is possible that curly brackets are missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cs-parser.cs 175 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Judging by the formatting of the code (forgetting about the rules of a programming language), one might think that both method calls ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteLine</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) refer to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">. In fact, only the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method will be called in the loop </font><font style="vertical-align: inherit;">. This code is definitely wrong! If such logic was implied (it would seem, everything is logical - the elements are output, after which an empty line is inserted), why is the formatting misleading? On the other hand - skimming through the code, you can immediately and do not understand the true logic of the operator. Not just as programmers adhere to certain formatting styles.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildParameters</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) result.Append (<span class="hljs-string"><span class="hljs-string">", "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p.Direction == TdsParameterDirection.InputOutput) <span class="hljs-comment"><span class="hljs-comment">// &lt;= result.Append (String.Format("{0}={0} output", p.ParameterName)); else result.Append (FormatParameter (p)); .... }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="http://www.viva64.com/ru/d/0426/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3043</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The code's operational logic does not correspond with its formatting.</font></font> The statement is indented.  It is possible that curly brackets are missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tds50.cs 379 The </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not relate to the first. </font><font style="vertical-align: inherit;">Why then mislead people working with this code?</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Restore</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (saved_count &lt; objects.Count) objects.Remove (objects.Last ().Key); referenced.Remove (objects.Last ().Key); saved_count = <span class="hljs-number"><span class="hljs-number">0</span></span>; referenced.RemoveRange (saved_referenced_count, referenced.Count - saved_referenced_count); saved_referenced_count = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="http://www.viva64.com/ru/d/0426/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3043</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The code's operational logic does not correspond with its formatting.</font></font> The statement is indented.  It is possible that curly brackets are missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XamlNameResolver.cs 81 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apparently, it was planned to remove from the collections of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objects</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referenced</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> values ‚Äã‚Äãcorresponding to a particular key. But they forgot about braces, as a result </font><font style="vertical-align: inherit;">only one value will be removed </font><font style="vertical-align: inherit;">from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referenced</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collection </font><font style="vertical-align: inherit;">. What is even more interesting is that one cannot get off with curly braces, because in this case, at each iteration of the cycle from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referenced</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collection, the </font><font style="vertical-align: inherit;">object will be deleted not by the same key that was removed from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objects</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collection </font><font style="vertical-align: inherit;">. This is due to the fact that at the time the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remove</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method is called </font><font style="vertical-align: inherit;">for the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referenced</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collection, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objects</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collection </font><font style="vertical-align: inherit;">will already be changed, which means the </font><i><font style="vertical-align: inherit;">Last</font></i><font style="vertical-align: inherit;"> method</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will return another item. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There were also warnings about errors with formatting that did not correspond to the logic of the program.</font></font> Here are some of them: <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V3043 The code's operational logic does not correspond with its formatting. </font></font> The statement is indented.  It is possible that curly brackets are missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ExpressionParser.cs 92 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V3043 The code's operational logic does not correspond with its formatting. </font></font> The statement is indented.  It is possible that curly brackets are missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> EcmaUrlParser.cs 80 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V3043 The code's operational logic does not correspond with its formatting. </font></font> The statement is indented.  It is possible that curly brackets are missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ILParser.cs 167 </font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bringing an object to its own type / checking an object for compatibility with its own type</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The diagnostic rule </font></font><a href="http://www.viva64.com/ru/d/0455/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is responsible for finding similar situations </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As a rule, it finds a redundant code of the form</font></font><br><br><pre> <code class="cs hljs">String str; String str2 = str <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String;</code> </pre> <br>  or <br><br><pre> <code class="cs hljs">String str; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (str <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> String)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But there are (although rarely) much more interesting cases. </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/d7e/c84/136/d7ec841362b1407c9b80485a77acd72c.png"></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider the code snippet: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateHttpGetMessage</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Port port, OperationBinding obin, Operation oper, OperationMessage msg</span></span></span><span class="hljs-function">)</span></span> { .... MimeXmlBinding mxb = (MimeXmlBinding) obin.Output .Extensions .Find (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MimeXmlBinding)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MimeXmlBinding; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mxb == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req; .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0455/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0455/"><font style="vertical-align: inherit;">V3051</font></a><font style="vertical-align: inherit;"> An type cast. The object is already the mimeXmlBinding type. SampleGenerator.cs 232 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It would seem - too redundant, so what? Below we check </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mxb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equality </font><font style="vertical-align: inherit;">, so if the type is incompatible, that's okay. It was not there. The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">returns an instance of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Object</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> type </font><font style="vertical-align: inherit;">, after which it is explicitly </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cast</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the </font><i><font style="vertical-align: inherit;">MimeXmlBinding</font></i><font style="vertical-align: inherit;"> type </font><font style="vertical-align: inherit;">and after that it is cast to the same type using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">. However, the operator of explicit, if the argument is incompatible type, does not return </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (as opposed to the operator </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), and throws an exception of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InvalidCastException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As a result, checking </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mxb == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not help in case of unsuccessful type conversion. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The remaining warnings are not so interesting (for example, redundant casting), so I will list them in a text </font></font><a href="http://cppfiles.com/Mono-V3051.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The parameter is overwritten in the body of the method before the</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fact that the method parameter is immediately overwritten is used, looks suspicious. After all, the value that came to the method is not used at all, but is simply ignored / lost. Ideally, you should fix the method signature and make the parameter a local variable. True, this approach is not always possible. For example, when implementing an interface or virtual functions.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetErrorInfo</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwReserved, IErrorInfo errorInfo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retVal = <span class="hljs-number"><span class="hljs-number">0</span></span>; errorInfo = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; .... retVal = _SetErrorInfo (dwReserved, errorInfo); .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0468/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0468/"><font style="vertical-align: inherit;">V3061</font></a><font style="vertical-align: inherit;"> Parameter 'errorInfo' is always rewritten. corlib-net_4_x Marshal.cs 1552 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The value that came as an </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">errorInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">is not used at all. The parameter is immediately reset, and then passed to the method. In this case, it would be logical to make </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">errorInfo a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> local variable (if it is possible to change the method signature). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The remaining places are similar, therefore, as before, I provide a list of warnings in a list in the </font></font><a href="http://cppfiles.com/Mono-V3061.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invalid static member initialization</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ResXResourceWriter</span></span> : <span class="hljs-title"><span class="hljs-title">IResourceWriter</span></span>, <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ResourceSchema = schema; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> schema = ....; .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0472/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0472/"><font style="vertical-align: inherit;">V3070</font></a><font style="vertical-align: inherit;"> Uninitialized variable 'schema' used when initializing the 'ResourceSchema' variable. ResXResourceWriter.cs 59 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The programmer wanted to set the value of the </font><font style="vertical-align: inherit;">read-only </font><font style="vertical-align: inherit;">public static field </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResourceSchema</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to another static field - the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schema</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No error has not done. At the time of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResourceSchema</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initialization, </font><font style="vertical-align: inherit;">the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schema</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field </font><font style="vertical-align: inherit;">will be initialized with a default value ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in this case). It is unlikely that this is exactly what the developer wanted. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wrong initialization of the static field, decorated with the attribute [ThreadStatic]</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A rare and interesting error. Consider the code snippet:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Profiler</span></span> { [ThreadStatic] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Stopwatch timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0496/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0496/"><font style="vertical-align: inherit;">V3089</font></a><font style="vertical-align: inherit;"> Initializer of a field marked by [ThreadStatic] attribute will be called once.</font></font> The field will have a default value on different threads.  System.Data.Linq-net_4_x Profiler.cs 16 <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decorating a field with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ThreadStatic]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute </font><font style="vertical-align: inherit;">means that the value of this field in each thread will be unique. </font><font style="vertical-align: inherit;">It seems to be nothing complicated. </font><font style="vertical-align: inherit;">But the fact is that such fields cannot be initialized either during the declaration or in the static constructor. </font><font style="vertical-align: inherit;">This is a great way to shoot yourself in the foot (or even both) and get a subtle mistake. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The point is, if initialization is performed during the declaration, the field will be initialized with this value only on the first accessing stream. </font><font style="vertical-align: inherit;">For other threads, the field will contain a default value (in this case, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stopwatch</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- reference type). </font><font style="vertical-align: inherit;">The static constructor will also be called only once - when the first thread is accessed. </font><font style="vertical-align: inherit;">Therefore, in other streams, the field will also be initialized with a default value. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The error is quite intricate, so I strongly recommend that you read the </font></font><a href="http://www.viva64.com/ru/d/0496/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation for the diagnostic rule</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in order to prevent such situations and not to waste precious time on debugging. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intersecting ranges</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EmitLong</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (l &gt;= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MinValue &amp;&amp; l &lt;= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue) { EmitIntConstant (<span class="hljs-keyword"><span class="hljs-keyword">unchecked</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) l)); ig.Emit (OpCodes.Conv_I8); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (l &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; l &lt;= <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>.MaxValue) { EmitIntConstant (<span class="hljs-keyword"><span class="hljs-keyword">unchecked</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) l)); ig.Emit (OpCodes.Conv_U8); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ig.Emit (OpCodes.Ldc_I8, l); } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0493/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0493/"><font style="vertical-align: inherit;">V3092</font></a><font style="vertical-align: inherit;"> Range intersections are possible within conditional expressions.</font></font> Example: if (A&gt; 0 &amp;&amp; A &lt;5) {...} else if (A&gt; 3 &amp;&amp; A &lt;9) {...}.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mcs-net_4_x codegen.cs 742 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer found the ranges intersection in expressions to be suspicious:</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l&gt; = int.MinValue &amp;&amp; l &lt;= int.MaxValue</font></font></i> </li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l&gt; = 0 &amp;&amp; l &lt;= uint.MaxValue</font></font></i> </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For both of these expressions, the range [0, Int32.MaxValue] is common, so if the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> has a value lying in this range, the first condition will be satisfied, although the second one could also be satisfied. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similar warnings:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V3092 Range intersections are possible within conditional expressions. </font></font> Example: if (A&gt; 0 &amp;&amp; A &lt;5) {...} else if (A&gt; 3 &amp;&amp; A &lt;9) {...}.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I18N.CJK-net_4_x CP51932.cs 437 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V3092 Range intersections are possible within conditional expressions. </font></font> Example: if (A&gt; 0 &amp;&amp; A &lt;5) {...} else if (A&gt; 3 &amp;&amp; A &lt;9) {...}.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I18N.CJK-net_4_x CP932.cs 552 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V3092 Range intersections are possible within conditional expressions. </font></font> Example: if (A&gt; 0 &amp;&amp; A &lt;5) {...} else if (A&gt; 3 &amp;&amp; A &lt;9) {...}.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I18N.CJK-net_4_x ISO2022JP.cs 460 </font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access to a collection item by a constant index, carried out within the cycle.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The practice of giving loop counters with short names is distributed everywhere. There is nothing wrong with calling the cycle counter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it is immediately clear what this variable serves as (with the exception of those cases where the counters require yet more meaningful names). But there are cases when a non-loop counter and a numeric literal are used as an index. It is clear that sometimes this is done on purpose, but sometimes it indicates an error. Diagnostic Rule </font></font><a href="http://www.viva64.com/ru/d/0502/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3102</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> looks for similar error spots.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConvertGlobalAttributes</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TypeContainer member, NamespaceContainer currentNamespace, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isGlobal</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> member_explicit_targets = member.ValidAttributeTargets; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Attrs.Count; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attr = Attrs[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (attr.ExplicitTarget == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0502/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0502/"><font style="vertical-align: inherit;">V3102</font></a><font style="vertical-align: inherit;"> Suspicious access to the element of the Attrs object. </font><font style="vertical-align: inherit;">mcs-net_4_x attribute.cs 1272 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At each iteration of the loop, the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attr is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initialized with the same value, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attrs [0]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Later, some work is done with it (properties are called, passed to the method). </font><font style="vertical-align: inherit;">It is unlikely that at all iterations of the loop they wanted to work with the same value, so I suppose that the correct initialization should look like this:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attr = Attrs[i];</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Similar errors occurred in two places: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3102 Suspicious access to the element of the 'seq' object by a constant index inside a loop. </font><font style="vertical-align: inherit;">System.Xml-net_4_x XmlQueryRuntime.cs 679</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constant index inside a loop. </font><font style="vertical-align: inherit;">System.Web-net_4_x Login.cs 1223</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insecure locks</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In many verifiable projects one has to deal with the code of the form </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lock (this)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lock (typeof (....))</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is not the best way to lock, as it can lead to deadlocks.</font></font> But let's get everything in order.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> First, look at the dangerous code: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RegistryKey </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ensure</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (KeyHandler)){ .... } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;">V3090</font></a><font style="vertical-align: inherit;"> Unsafe locking on a type. The type of object will be the same. corlib-net_4_x UnixRegistryApi.cs 245 A </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">common problem with the potential occurrence of a deadlock is that locking is performed on the same object. Therefore, the general advice that will allow to get rid of such problems is to use an object that is inaccessible from the outside as a lock object - a local variable or a private class field. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the problem with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typeof</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">? This statement always returns an instance of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the same for the same argument, therefore, violates the rule described above - there is the problem of blocking on the same object. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the project code there are several such places:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3090 Unsafe locking on a type. </font><font style="vertical-align: inherit;">The type of object will be the same. </font><font style="vertical-align: inherit;">corlib-net_4_x UnixRegistryApi.cs 245</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3090 Unsafe locking on a type. </font><font style="vertical-align: inherit;">The type of object will be the same. </font><font style="vertical-align: inherit;">corlib-net_4_x UnixRegistryApi.cs 261</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3090 Unsafe locking on a type. </font><font style="vertical-align: inherit;">The type of object will be the same. </font><font style="vertical-align: inherit;">corlib-net_4_x UnixRegistryApi.cs 383</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3090 Unsafe locking on a type. </font><font style="vertical-align: inherit;">The type of object will be the same. </font><font style="vertical-align: inherit;">corlib-net_4_x UnixRegistryApi.cs 404</font></font></li><li> V3090 Unsafe locking on a type. All instances of a type will have the same 'Type' object. corlib-net_4_x UnixRegistryApi.cs 451 </li><li> V3090 Unsafe locking on a type. All instances of a type will have the same 'Type' object. corlib-net_4_x UnixRegistryApi.cs 469 </li><li> V3090 Unsafe locking on a type. All instances of a type will have the same 'Type' object. corlib-net_4_x UnixRegistryApi.cs 683 </li><li> V3090 Unsafe locking on a type. All instances of a type will have the same 'Type' object. corlib-net_4_x UnixRegistryApi.cs 698 </li><li> V3090 Unsafe locking on a type. All instances of a type will have the same 'Type' object. System-net_4_x NetworkChange.cs 66 </li><li> V3090 Unsafe locking on a type. All instances of a type will have the same 'Type' object. System-net_4_x NetworkChange.cs 74 </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3090 Unsafe locking on a type. </font><font style="vertical-align: inherit;">The type of object will be the same. </font><font style="vertical-align: inherit;">System-net_4_x NetworkChange.cs 85</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3090 Unsafe locking on a type. </font><font style="vertical-align: inherit;">The type of object will be the same. </font><font style="vertical-align: inherit;">System-net_4_x NetworkChange.cs 93</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The situation with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetType ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method is </font><font style="vertical-align: inherit;">fundamentally no different from the one described above:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureHttpChannel</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (GetType()) { .... } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;">V3090</font></a><font style="vertical-align: inherit;"> Unsafe locking on a type. The type of object will be the same. System.Runtime.Remoting-net_4_x HttpRemotingHandlerFactory.cs 61 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetType ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">also returns an instance of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> type </font><font style="vertical-align: inherit;">, so if you block it elsewhere using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetType ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">or the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typeof</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">, for an object of the same type, there is a possibility of deadlock . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separately, I would like to consider blocking on objects of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since in this case the situation becomes much more interesting, and errors more probable and difficult to detect.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Profiles_SettingsPropertyCollection = <span class="hljs-string"><span class="hljs-string">"Profiles.SettingsPropertyCollection"</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitProperties</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Profiles_SettingsPropertyCollection) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_properties == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _properties = properties; } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;">V3090</font></a><font style="vertical-align: inherit;"> Unsafe locking on an object of type 'String'. System.Web-net_4_x ProfileBase.cs 95 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The essence of the problem remains unchanged - locking on the same object, but the details are more interesting. Objects of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be accessed even from another application domain (this is due to the string interning mechanism). Imagine how to debug a deadlock resulting from the fact that in different application domains used the same line as the object of the lock. The advice is brief - do not use objects of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, by the way, too). These and other problems associated with the use of synchronization mechanisms (as well as ways to avoid them) are described in the </font></font><a href="http://www.viva64.com/ru/d/0497/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation for diagnostic rule V3090</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erroneous comparison</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CounterSample other</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rawValue == other.rawValue &amp;&amp; baseValue == other.counterFrequency &amp;&amp; counterFrequency == other.counterFrequency &amp;&amp; systemFrequency == other.systemFrequency &amp;&amp; timeStamp == other.timeStamp &amp;&amp; timeStamp100nSec == other.timeStamp100nSec &amp;&amp; counterTimeStamp == other.counterTimeStamp &amp;&amp; counterType == other.counterType; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="http://www.viva64.com/ru/d/0532/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3112</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An abnormality within similar comparisons. It is possible that a typo is currently inside the expression 'baseValue == other.counterFrequency'. System-net_4_x CounterSample.cs 139 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I deliberately did not change the formatting of the code, leaving it in the same form as it was in the original source. The idea of ‚Äã‚Äãthe method is clear and does not cause any problems for understanding - it simply compares the fields of the current object and the object that came as an argument. But even this seemingly simple method contains an error. I am sure that if the formatting of the code were performed better, it would be easier to notice it. This is the same code snippet, but formatted:</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CounterSample other</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rawValue == other.rawValue &amp;&amp; baseValue == other.counterFrequency &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= counterFrequency == other.counterFrequency &amp;&amp; // &lt;= systemFrequency == other.systemFrequency &amp;&amp; timeStamp == other.timeStamp &amp;&amp; timeStamp100nSec == other.timeStamp100nSec &amp;&amp; counterTimeStamp == other.counterTimeStamp &amp;&amp; counterType == other.counterType; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think that with such formatting an error is much easier to notice - it is clear that the same field being compared is compared with different fields of the current object. </font><font style="vertical-align: inherit;">As a result, the logic of the program is violated. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code fragment is clearly visible - formatting plays an important role! </font><font style="vertical-align: inherit;">And if the compiler doesn‚Äôt care how your code is formed, it‚Äôs important for programmers to avoid annoying errors and also simplify the perception of the code and understanding of the program‚Äôs logic.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to rule all this? </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, mistakes found. Many errors. If you count the errors described in the article, as well as those that were given in the files, it turns out 167 pieces! I want to note that these are not all erroneous / suspicious places - I just chose enough material for the article (which was not a problem). Many other errors, perhaps even the majority, left out of the scope of the article, because it was already quite voluminous. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There may be a reasonable question, how to fix it all? How to implement a static analyzer in the project?</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/b93/fcd/2cf/b93fcd2cfefb4d5b962feabad99b3417.png"></div><p></p><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is unlikely that a separate team will be allocated, which will deal exclusively with the correction of errors (unless we ourselves will correct these errors, as was </font></font><a href="http://www.viva64.com/ru/b/0330/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the case with the Unreal Engine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). It will be correct to fix the existing errors, which will be gradually corrected, and to prevent the emergence of new ones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To solve the first problem will help the mechanism of mass suppression of warnings. This will allow differentiating old and new errors, observing the appearance and correction of errors only in the new code. Old errors are ruled separately. </font></font><br><br> <a href="http://www.viva64.com/ru/d/0218/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incremental analysis mode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">urged to solve the second problem. This mode starts the analysis on the developer's machine immediately after compilation, allowing you to detect more recent errors and correct them before entering the version control system (SLE). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anyway, most likely a certain percentage of errors will fall into hard currency. To detect an erroneous code as quickly as possible after getting into SCR, a good solution would be to inject static analysis into nightly assemblies and use analysis results.</font></font> How?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can, for example, notify the person responsible for the project, as well as the programmer who allowed this error to get into the repository. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is important to correct such errors immediately, until they are 'overgrown' with additional code, and the task of correction has not been complicated several times. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combining the tips described above (introducing static analysis both on the build server and on the developers' machines) will reduce the cost of fixing errors, since with the proper organization of the process they will be corrected as quickly as possible (without reaching the testers and even more so without getting in releases). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More information about the introduction of static analysis in the development process can be found in the article " </font></font><a href="http://www.viva64.com/ru/b/0309/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to quickly implement static analysis in a large project?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br><br><h2>  Conclusion </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the comments to one of the articles they wrote: ‚ÄúYou write that you check open-source products with your analyzer, but in fact you check your analyzer with open-source products!‚Äù. This is the truth. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indeed, we are constantly working to improve the analyzer, and checking projects allows us to do it better ‚Äî correct false positives, teach the analyzer to find new errors, etc. This side of the verification usually remains outside the scope of the article, as it is more interesting to the developers of the analyzer.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But we still check projects and, importantly, we find real mistakes there. We do not just find, but try to bring this information to the developers and all interested. And how to use this information - a personal matter of each. I think the benefits of our work for the open-source community are definitely there. Not so long ago, we passed over the mark of </font></font><a href="http://www.viva64.com/ru/b/0421/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,000 errors found</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, our main goal is to popularize the methodology of static analysis in general and the PVS-Studio analyzer in particular. And our articles are a great way to demonstrate the benefits of this methodology. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Try PVS-Studio on your project: </font></font><a href="http://www.viva64.com/ru/pvs-studio/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.viva64.com/en/pvs-studio/</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, it is a little sad that the compiled project could not be verified, which is why a truly complete and in-depth analysis did not work. </font><font style="vertical-align: inherit;">On the other hand, there was enough material for the article without it, so developers should think about correcting errors and introducing static analysis into the development process. </font><font style="vertical-align: inherit;">And we are always happy to help them with this.</font></font><br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0431/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to share this article with an English-speaking audience, then please use the link to the translation: Sergey Vasiliev. </font></font><a href="http://www.viva64.com/en/b/0431/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Searching for bugs in Mono: there are hundreds of them!</font></font></a>  . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/310732/">https://habr.com/ru/post/310732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310722/index.html">Testing filter and setting changes in Google Analytics</a></li>
<li><a href="../310724/index.html">Collaborate on documents: SharePoint 2016. Part 2. Configure external access.</a></li>
<li><a href="../310726/index.html">The book "How to survive the full end of the dinner, or security in PHP." Part 1</a></li>
<li><a href="../310728/index.html">Gartner Quadrant for Wireless and Wired Networks 2016</a></li>
<li><a href="../310730/index.html">We work in the cloud based on Hyper-V, part 1: familiarity with the control panel</a></li>
<li><a href="../310734/index.html">Lecture by Jimmy Wales, founder of Wikipedia, in Yandex</a></li>
<li><a href="../310736/index.html">BGP protocol in Quagga</a></li>
<li><a href="../310738/index.html">Logging Git revision in Java using Maven</a></li>
<li><a href="../310740/index.html">How to rewrite the SDK in TypeScript, upgrade the platform and do not regret anything</a></li>
<li><a href="../310742/index.html">Getting started in STM32CubeMX. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>