<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ARP: Cisco equipment features and interesting cases. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi habr! Each future engineer in the process of studying network technologies gets acquainted with the ARP protocol (Address Resolution Protocol, here...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ARP: Cisco equipment features and interesting cases. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/48a/bba/677/48abba677af841938f8d3d49d0aea4db.jpg"><br><br>  Hi habr!  Each future engineer in the process of studying network technologies gets acquainted with the ARP protocol (Address Resolution Protocol, hereinafter referred to as ARP).  The main task of the protocol is to obtain the L2 address of the device at the known L3 address of the device.  At the dawn of a professional career, a novice specialist, it seems to me, rarely faces situations where you need to recall the existence of ARP.  It seems that ARP is some kind of autonomous service that does not require any intervention in its work, and if there are any problems with communication, many people who have inexperience may forget to check ARP operation. <a name="habracut"></a><br><br>  I remember my order of thoughts when I started working as a network engineer: ‚ÄúSo, the interface has risen, there are no errors in physics, it seems.  The route where to send the packages, I registered.  There are no access lists.  So why not traffic?  What is still not enough for the router? ‚ÄùSooner or later, every network engineer will face a problem, the cause of which will lie precisely in the peculiarities of ARP operation / configuration on network equipment.  The simplest example: changing the gateway at the edge of the network (for example, we install a router instead of an MS TMG server).  In this case, the configuration of the router was tested in advance in the laboratory.  And here, when connecting to the provider, no connection works.  Return MS TMG - everything works.  Where to look after checking the channel and physical layer?  The most likely answer is to check ARP operation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will not describe in detail the principles of operation of ARP and protocols of this family (RARP, InARP, UnARP, etc.).  There are already lots of articles on this topic on the Internet (for example, ARP variants <a href="http://www.atraining.ru/arp-inarp-rarp-proxy-gratuitous-dai-sticky-and-more/">are</a> not well described <a href="http://www.atraining.ru/arp-inarp-rarp-proxy-gratuitous-dai-sticky-and-more/">here</a> ).  The only theoretical point on which I will focus a little more attention is the Gratuitous ARP (GARP) mechanism. <br><br>  The article will consist of two parts.  In the first part there will be some theory and features of ARP operation on Cisco routers related to NAT rules and the Proxy ARP feature.  In the <a href="https://habrahabr.ru/company/cbs/blog/277251/">second part I</a> will describe the differences in ARP work between Cisco routers and Cisco ASA firewalls, and I will also share several interesting cases from practice related to ARP work. <br><br>  <b>A little bit of theory</b> <br><br>  ARP request / ARP response <br><br>  Below is an example of exchanging an ARP request / ARP response in the Wireshark sniffer program: <br><br><img src="https://habrastorage.org/files/de4/ff8/b22/de4ff8b22a424db1902b1f89c7ceb612.png"><br><br><img src="https://habrastorage.org/files/fe6/c1b/959/fe6c1b9598444af3a5c0248d54956e08.png"><br><br>  The ARP request is sent to the broadcast MAC address ff: ff: ff: ff: ff: ff.  In the body of an ARP request, the field with the unknown value of the Target MAC Address is filled with zeros. <br><br>  The ARP reply is sent to the MAC address of the recipient who sent the ARP request.  The Sender MAC Address field indicates the requested MAC address of the device. <br><br>  The opcode field in the ARP header may take the value 1 for the ARP request and the value 2 for the ARP response. <br><br>  In order for two devices to start sending traffic between each other, there must be a corresponding neighboring device entry in their ARP tables.  It is logical to assume that the ARP entry appears in the tables; for each device, the ARP request / ARP response should be worked out.  That is, before sending traffic to the networks, two ARP requests and two ARP responses (ARP request / ARP response for the first computer and ARP request / ARP response for the second computer) must pass through.  However, this assumption is not true for all cases.  Cisco networking equipment adds a new entry to the ARP table immediately after an ARP request arrives from the remote device. <br><br>  Consider an example.  A new device is added to the broadcast domain with the address 198.18.0.200.  Start the ping from the new device and see debug arp on the Cisco router: <br><br><pre><code class="python hljs"><span class="hljs-number"><span class="hljs-number">019383</span></span>: Feb <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> UTC: IP ARP: rcvd req src <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span> <span class="hljs-number"><span class="hljs-number">64e9</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span>c8.d6cd, dst <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.7</span></span> <span class="hljs-number"><span class="hljs-number">019384</span></span>: Feb <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> UTC: IP ARP: creating entry <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> IP address: <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span>, hw: <span class="hljs-number"><span class="hljs-number">64e9</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span>c8.d6cd <span class="hljs-number"><span class="hljs-number">019385</span></span>: Feb <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> UTC: IP ARP: sent rep src <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> d8b1<span class="hljs-number"><span class="hljs-number">.902</span></span>e.e741, dst <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span> <span class="hljs-number"><span class="hljs-number">64e9</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span>c8.d6cd GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.7</span></span></code> </pre> <br>  As you can see, immediately after the arrival of an ARP request from an unknown IP address (rcvd req src 198.18.0.200), the router creates a corresponding entry in its ARP table (creating entry for IP address: 198.18.0.200, hw: 64e9.50c8.d6cd ). <br><br>  For the current article, I did not conduct a detailed study on what kind of network equipment adds an ARP entry at the onset of an ARP request.  However, I assume that the described behavior is inherent not only to Cisco network equipment, but also to network equipment from other manufacturers, since this mechanism allows for a significant reduction in ARP traffic on the network. <br><br><div class="spoiler">  <b class="spoiler_title">ARP request / ARP response for end equipment</b> <div class="spoiler_text">  The described behavior is inherent in network equipment.  The end equipment, in most cases, receives an entry into the ARP table only after the full ARP request / ARP reply procedure.  For example, I checked the procedure on a computer with a Windows 7 operating system. Below is a dump of ARP packets.  In this example, arp-cache was cleared on the Cisco router and on the Windows computer.  After that, the ping from the router to the computer was launched. <br><br><img src="https://habrastorage.org/files/57a/e94/155/57ae941551af4216aa50466a046382e5.png"><br><br>  From the presented dapma, you can see that the router first sends an ARP request and receives an ARP reply.  But an ARP request from the router does not result in the required entry in the ARP table of the Windows computer, therefore, in turn, the computer sends an ARP request and receives an ARP response from the router. </div></div><br>  <b>Gratuitous ARP</b> <br><br>  The Gratuitous ARP mechanism is used to notify devices within the broadcast domain about the appearance of a new IP address and MAC address binding.  When the device‚Äôs network interface receives IP settings (manually or via DHCP), the device sends a Gratuitous ARP message to notify its neighbors of its presence.  Gratuitous ARP message is a special kind of ARP response.  The opcode field takes the value 2 (ARP response).  The MAC address is obtained both in the Ethernet header and in the body of the ARP response is broadcast (ff: ff: ff: ff: ff: ff).  The Target IP Address field in the body of the ARP response matches the Sender IP Address field. <br><br>  The Gratuitous ARP mechanism is used for many purposes.  For example, using Gratuitous ARP, you can notify about the change of the MAC address or detect IP address conflicts.  Another example is the use of First Hop redundancy protocols (First Hop Redundancy Protocols), for example, HSRP from Cisco.  Remember, HSRP allows you to have a virtual IP address shared between two or more network devices.  In normal operation, the maintenance of the virtual IP address (responses to ARP requests, etc.) is provided by the primary device.  If the primary device fails, the virtual IP address service goes to the second device.  To notify about the change of the MAC address of the responsible device, a Gratuitous ARP message is being sent. <br><br>  The example below shows a Gratuitous ARP message when you turn on the router's network interface with configured IP addresses 198.18.0.1. <br><br><img src="https://habrastorage.org/files/b20/921/6a4/b209216a43f54f0299d4086a5db40954.png"><br><br>  If the router has a secondary IP address configured, when the interface transitions to the UP state, Gratuitous ARP notifications will be sent for each interface IP address.  The example below shows the Gratuitous ARP messages sent when the router interface with the primary IP address 198.18.0.1 and the secondary IP address 198.18.2.1 is enabled. <br><br><img src="https://habrastorage.org/files/9ae/836/790/9ae836790f9b48a2bc5f2c9ecd005236.png"><br><br>  Of course, the router will respond to ARP requests for both the primary and secondary IP addresses. <br><br>  It is logical to assume that as soon as the device receives Gratuitous ARP, a new entry is immediately added to the ARP table.  However, it is not.  If there is no ARP entry in the device table associated with the IP address from the Gratuitous ARP message, the new entry will not be added.  If you need to send traffic, an ARP request will be generated and an ARP response will be received.  Only after this procedure will a new entry be added to the ARP table. <br><br>  An example on a Cisco router.  Turn on debug arp and connect a new device with the address 198.18.0.200 to the broadcast domain.  Before connecting a new device, the ARP table of the router looks like this: <br><pre> <code class="python hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#sh arp | inc 198.18.0.200 &lt; &gt;</span></span></code> </pre><br>  We include the new device with the address 198.18.0.200.  We receive a debug message about the arrival of Gratuitous ARP: <br><pre> <code class="python hljs">IP ARP: rcvd rep src <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span> <span class="hljs-number"><span class="hljs-number">64e9</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span>c8.d6cd, dst <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span> GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Check the ARP table: <br><pre> <code class="python hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#sh arp | inc 198.18.0.200 &lt; &gt;</span></span></code> </pre><br>  A new entry has not appeared.  We ping to the new address: <br><pre> <code class="python hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#ping 198.18.0.200 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 198.18.0.200, timeout is 2 seconds: 019275: Feb 4 10:23:06 UTC: IP ARP: creating incomplete entry for IP address: 198.18.0.200 interface GigabitEthernet0/0/1 019276: Feb 4 10:23:06 UTC: IP ARP: sent req src 198.18.0.1 d8b1.902e.e741, dst 198.18.0.200 0000.0000.0000 GigabitEthernet0/0/1 019277: Feb 4 10:23:06 UTC: IP ARP: rcvd rep src 198.18.0.200 64e9.50c8.d6cd, dst 198.18.0.1 GigabitEthernet0/0/1 .!!!! Success rate is 80 percent (4/5), round-trip min/avg/max = 2/2/3 ms</span></span></code> </pre><br>  Debug messages indicate that an ARP request / ARP response has passed.  Check the ARP table: <br><pre> <code class="python hljs">cisoc<span class="hljs-comment"><span class="hljs-comment">#sh arp | i 198.18.0.200 Internet 198.18.0.200 6 64e9.50c8.d6cd ARPA GigabitEthernet0/0/1</span></span></code> </pre><br>  New entry has appeared. <br><br>  <b>ARP and NAT on Cisco routers</b> <br><br>  Now let's look at how things work with ARP, if the router uses network address translation rules - NAT or PAT.  In this case, we can broadcast the address or addresses of the local network either to the address of the router's interface, or to some other address, which in NAT terminology will be called an inside global address (inside global or inside mapped).  If the translation happens to the interface address, there are no questions with ARP.  In the case of translation to an address other than the interface address, the following rules apply: <br><ol><li>  If the inside global address is on the same IP subnet as the router's interface address, the router will respond to ARP requests to that address.  At the same time, a static entry for the internal global address is created in the router's own arp-table. </li><li>  If the inside global address is on an IP subnet other than the router's interface address, the router will not respond to ARP requests to this address.  A static entry is not created in its own arp table.  For the connection with such an IP address to work, additional configuration is required.  We will look at this case in more detail later in the article. </li></ol><br>  We should also mention the behavior of Gratuitous ARP.  I will not consider the options for generating Gratuitous ARP for various cases (transition of the interface to the UP state, changing the primary IP address of the interface, changing the Secondary IP address, etc.), since there will be too many options.  I want to specify only two points.  The first point: setting up a new NAT rule does not generate a Gratuitous ARP notification.  The second point: using the <i>clear arp-cache</i> command, you can not only clear all dynamic arp entries in the router's table, but also force the router to send Gratuitous ARP for all IP addresses that the router must respond to, including the internal global addresses from the NAT rules. <br>  Consider examples based on the following simplest topology: <br><br><img src="https://habrastorage.org/files/46c/eb7/4ce/46ceb74ce78b4ea9a33cf361d7e11bf3.png"><br><br>  <i><u>Note: The</u></i> tests used a C4321 router with 15.4 (3) S3 software and a Cisco ASA5505 firewall with 9.1 (6) 6 software. <br><br>  Computer Wireshark from addresses 198.18.0.250 in our case will designate connection to an external network (for example, to an Internet provider).  With the help of Wireshark sniffer, we will look at the ARP messaging between the router and the computer. <br><br>  Router Interface Settings: <br><pre> <code class="python hljs">interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> description === inside === ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> no ip proxy-arp ip nat inside ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.7</span></span> description === outside === ip address <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> no ip proxy-arp ip nat outside</code> </pre><br>  Add a dynamic NAT rule to broadcast the address of the computer from the LAN (192.168.20.5) to the internal global address 198.18.0.5 when accessing the computer outside (Wireshark).  Add a static PAT rule to publish the TCP port 3389 (RDP) of the computer from the LAN under the global address 198.18.0.2. <br><br><img src="https://habrastorage.org/files/419/643/7f5/4196437f57b34ae18a89b4df86596969.png"><br><br><pre> <code class="python hljs">ip access-list standard acl-test-arp permit <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> ip nat pool test-pool <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ip nat inside source list acl-test-arp pool test-pool overload ip nat inside source static tcp <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">3389</span></span> extendable</code> </pre><br>  Let's look at the ARP table on the router: <br><pre> <code class="python hljs">cisco<span class="hljs-comment"><span class="hljs-comment">#sh arp Protocol Address Age (min) Hardware Addr Type Interface . . . Internet 198.18.0.1 - d8b1.902e.e741 ARPA GigabitEthernet0/0/1.7 Internet 198.18.0.2 - d8b1.902e.e741 ARPA GigabitEthernet0/0/1.7 Internet 198.18.0.5 - d8b1.902e.e741 ARPA GigabitEthernet0/0/1.7 . . .</span></span></code> </pre><br>  We see that the ARP table contains static entries for both the external interface of the router (198.18.0.1) and internal global addresses from the rules of dynamic and static NAT. <br><br>  Make a <i>clear arp-cache</i> on the router and see in Wireshark which Gratuitous ARP notifications will be sent from the external interface: <br><br><img src="https://habrastorage.org/files/cc0/223/e91/cc0223e9180b4752a4836d36884f5d37.png"><br><br>  As you can see, the router indicated its readiness to maintain the interface address, the address from the dynamic NAT rule, and the address from the static NAT rule. <br><br>  And now let's imagine a situation where the provider expands the pool of public addresses issued to the client at the expense of another subnet.  Suppose, in addition to the IP subnet 198.18.0.0/24 on the external interface of the router, we receive from the provider a new pool 198.18.99.0/24 and want to publish our internal services under the new IP addresses.  For clarity, I will give the scheme with the provider: <br><br><img src="https://habrastorage.org/files/86c/004/e16/86c004e1673e4c1ea6e65eba47e8e9cd.png"><br><br>  Add a static PAT rule for publishing TCP port 3389 (RDP) of a computer from the LAN under the new global address 198.18.99.2: <br><pre> <code class="python hljs">ip nat inside source static tcp <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-number"><span class="hljs-number">198.18</span></span><span class="hljs-number"><span class="hljs-number">.99</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">3389</span></span> extendable</code> </pre><br>  If you look at the router's ARP table again with the show arp command, you will see that the static entry for the IP address 198.18.99.2 has not been added. <br><br>  To be able to send ARP requests to the new network 198.18.99.0/24 from the Wireshark computer, we will expand the mask of its network settings to 255.255.0.0 (/ 16).  Let me remind you that for our example, Wireshark acts as an ISP‚Äôs router. <br><br>  After entering the <i>clear arp-cache, the</i> sniffer still shows Gratuitous ARP for only three IP addresses: 198.18.0.1, 198.18.0.2, 198.18.0.5.  For the new address 198.18.99.2 Gratuitous ARP does not work.  Let's try to open tcp-port 3389 of the address 198.18.99.2 and at the same time look at the sniffer: <br><br><img src="https://habrastorage.org/files/c7a/e17/74c/c7ae1774cee84ffeb9ad8f17af92de5f.png"><br><br><img src="https://habrastorage.org/files/e5a/235/e80/e5a235e800e74b17bd84798741fe6c29.png"><br><br>  Failure.  Check the ARP table: <br><br><img src="https://habrastorage.org/files/d8a/8c5/e10/d8a8c5e1018e45b3bbc0dc331de06e67.png"><br><br>  An ARP entry for the new IP address 198.18.99.2 did not appear.  The reason is that the new IP address 198.18.99.2 is on an IP subnet different from the interface address of the router.  How can we make the new pool of IP addresses issued by the provider work?  There are four options: <br><ol><li>  Ask the provider to register static ARP entries for each IP address in the new range.  This is not very convenient if a wide range is issued as in our example. </li><li>  Ask the provider to register a static route.  Often, in order to issue an additional range of white IP-addresses, the provider writes the secondary IP-address on the interface of its equipment.  Instead, we can ask the provider to register a static route to the new IP subnet via the IP address of the external interface of the router.  In this case, the equipment provider will know that the new subnet is available through the IP address of the router's interface, and the router, in turn, will respond to ARP requests sent to its own interface. </li><li>  Register the secondary IP address from the new range on the external interface of the router.  In this case, any IP address of the new range will belong to the same subnet as the IP address (albeit secondary) of the router interface.  The router will automatically add static entries to its ARP table, send Gratuitous ARP and respond to ARP requests. </li><li>  Use the Proxy Arp mechanism on the router.  On this option, we dwell in more detail. </li></ol><br>  <b>Proxy ARP on Cisco routers</b> <br><br>  Proxy ARP functionality allows the router to respond to ARP requests when the following three conditions are met: <br><ol><li>  The target IP address of the ARP request is on an IP subnet other than the IP subnet in which the ARP request was received; </li><li>  The router has one or more routes to the target IP address of the ARP request; </li><li>  Routes to the target IP address of the ARP request indicate an outgoing interface other than the interface to which the ARP request was received. </li></ol><br>  By default, Proxy ARP is enabled on all interfaces of the router.  However, the use of the Proxy ARP mechanism has several drawbacks.  First of all, Proxy ARP introduces a potential vulnerability to Man-in-the-middle attacks, when an attacker gains the ability to intercept network traffic.  Therefore, it is recommended to disable Proxy ARP on at least the interfaces to which external networks are connected. <br><br>  Configure Proxy ARP on the router interface: <br><pre> <code class="python hljs">interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.7</span></span> ip proxy-arp</code> </pre><br>  You can globally disable Proxy ARP on all interfaces of the router: <br><pre> <code class="python hljs">ip arp proxy disable</code> </pre><br>  This setting takes precedence over Proxy ARP settings applied on interfaces. <br>  In addition to the <i>ip proxy arp</i> command, there is a <i>ip local-proxy-arp</i> command in the interface settings.  This command only works when <i>ip proxy arp is</i> enabled on the interface and allows the router to respond to ARP requests, even if the target IP address is on the same IP subnet from which the ARP request came.  Setup Example: <br><pre> <code class="python hljs">no ip arp proxy disable interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.7</span></span> ip proxy-arp ip local-proxy-arp</code> </pre><br>  This setting can be useful if we want traffic within one broadcast domain to go through our router's interface.  This task can be implemented using the Protected port (PVLAN edge) settings on the L2 switch ( <i>switchport protected</i> ). <br><br>  Enabling Proxy ARP on the external interface of the router will solve the problem with the new pool of addresses issued by the provider.  Let's try to open tcp-port 3389 of the address 198.18.99.2 after enabling Proxy ARP on the interface of the router and at the same time look at the sniffer: <br><br><img src="https://habrastorage.org/files/539/407/b4d/539407b4dd624dbe9b6d6b2f9545529a.png"><br><br>  Success.  The router responds to the ARP request and the port opens.  Thus, the Proxy ARP functionality can also be used when address translation to a new pool is needed. <br><br>  <b>Results</b> <br><br>  I will try to summarize the main points of the first part of the article: <br><ol><li>  Cisco networking equipment adds an ARP record of a new remote device to the ARP table immediately after an ARP request arrives from the remote device.  This behavior reduces ARP traffic on the network. <br></li><li>  The Cisco router will respond to ARP requests to the internal global IP address of the NAT rule if this IP address belongs to the same IP subnet as the router interface.  Additional settings for ARP are not required. <br></li><li>  If the inside global IP address of the router's NAT rule does not belong to the IP subnet of the router interface, additional configuration is required.  There are four options: <br><ol><li>  Static ARP-records on external equipment; <br></li><li>  Static route on external equipment; <br></li><li>  Configuring secondary IP addresses on the router interface; <br></li><li>  Using Proxy ARP. <br>  The first and second options involve changing the settings on the ‚Äúalien‚Äù network equipment and may not always be acceptable. <br>  The third option is the most preferred. <br>  The fourth option can be used, but it opens a vulnerability in terms of network security. <br></li></ol></li><li>  Proxy ARP functionality is enabled on the default router interfaces.  It is recommended to disable Proxy ARP at least on interfaces connected to Internet service providers. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/276863/">https://habr.com/ru/post/276863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276849/index.html">Review of physics in Sonic games. Part 2: Running</a></li>
<li><a href="../276851/index.html">AlfaCtrakhovanie Mobile. How we combined several IT systems in one application: case</a></li>
<li><a href="../276855/index.html">Cognitive computing - work faster than thought</a></li>
<li><a href="../276857/index.html">Using FPGA and DSL to speed up HFT trading</a></li>
<li><a href="../276859/index.html">Foster Day at the Foreign Ministry</a></li>
<li><a href="../276865/index.html">Bind additional one-time passwords to the Windows logon window</a></li>
<li><a href="../276867/index.html">Study of virtual hosting tariffs</a></li>
<li><a href="../276869/index.html">And again about storing files, and how to quickly find the right one.</a></li>
<li><a href="../276871/index.html">Tuples in programming languages. Part 1</a></li>
<li><a href="../276873/index.html">43 useful project management services. No epithets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>