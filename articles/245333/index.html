<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to rasp the class file</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usually when you compile a Java file, you get .class files of about the same size as the source. I was interested in whether it is possible to make a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to rasp the class file</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/318/23d/27b/31823d27b8b6404386b1fb2811933e2d.gif" align="right">  Usually when you compile a Java file, you get .class files of about the same size as the source.  I was interested in whether it is possible to make a .class file, which is larger by a small source, much more than the source. <br><br>  You can search for some short language constructs that are compiled into long bytecode chains, but I was not satisfied with the linear gain.  I immediately thought about the compilation of finally-blocks: <a href="http://habrahabr.ru/post/212759/">they</a> already <a href="http://habrahabr.ru/post/212759/">wrote</a> about it <a href="http://habrahabr.ru/post/212759/">on Habr√©</a> .  In short, for each finally-block, with a non-empty try-block, at least two variants are created in bytecode: for the case of normal completion of the try-block and for the case of completion with an exception.  In the latter case, the exception is stored in a new local variable, the finally code is executed, then the exception is taken from the local variable and transferred.  But what if you put try-finally inside the finally and so on?  The result exceeded all expectations. <br><a name="habracut"></a><br>  I compiled using Oracle javac 1.7.0.60 and 1.8.0.25, the results practically did not differ.  The path for exclusion is formed even if in the try block there is absolutely nothing reprehensible.  For example, assigning an integer constant to a local variable is two instructions <a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html">iconst</a> and <a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html">istore</a> , neither of which the specification says that they can throw an exception.  So we will write: <br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {a=<span class="hljs-number"><span class="hljs-number">0</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { a=<span class="hljs-number"><span class="hljs-number">0</span></span>; }}}}}}}}}}}} }}</code> </pre> <br>  Adding a new non-trivial code to the innermost finally causes a code too large compile error, so we limit ourselves to this.  If someone forgot, this is our <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html">initialization block</a> , which is attached to each constructor.  For our task, there is no point in declaring the method. <br><br>  Such a source takes <b>336</b> bytes, and the resulting class-file rattled up to 6,571,429 bytes, that is, 19,557 times (let's call it a dragging factor).  Even if you disable all debugging information with -g: none, the class file weighs <b>6,522,221</b> bytes, which is only slightly smaller.  Let's see what's inside with the <a href="https://docs.oracle.com/javase/7/docs/technotes/tools/windows/javap.html">javap</a> utility. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Pool of constants </h5><br>  <a href="http://habrahabr.ru/post/222519/">The pool of constants</a> turned out to be small: only 16 records.  In essence, everything you need is the following: attribute names of the Code type, class name, Java file, reference to the constructor of the parent class Object, etc. When you turn off debug information, three entries disappear: the attribute names LineNumberTable, SourceFile, and the A.java value for the SourceFile attribute . <br><br><h5>  Code </h5><br>  The default constructor code was 64507 bytes, almost resting on the maximum allowed limit.  It begins with normal execution: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0</span></span>: aload_0 <span class="hljs-number"><span class="hljs-number">1</span></span>: invokespecial #<span class="hljs-number"><span class="hljs-number">1</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> java/lang/<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>."&lt;init&gt;":()V <span class="hljs-number"><span class="hljs-number">4</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">5</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">6</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">7</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">8</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">9</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">10</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">11</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">12</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">13</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">14</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">15</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">16</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">17</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">18</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">19</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">20</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">21</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">22</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">23</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">24</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">25</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">26</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">27</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">28</span></span>: iconst_0 <span class="hljs-number"><span class="hljs-number">29</span></span>: istore_1 <span class="hljs-number"><span class="hljs-number">30</span></span>: goto <span class="hljs-number"><span class="hljs-number">38</span></span></code> </pre></div></div><br>  That is, the parent class constructor is called, and then the unit is written 13 times in the first local variable.  After this, a long goto chain begins, which bypasses all other copies of finally: 30-&gt; 38-&gt; 58-&gt; 104-&gt; 198-&gt; 388-&gt; 770-&gt; 1536-&gt; 3074-&gt; 7168-&gt; 15358-&gt; 31740- &gt; 64506, and at 64506 we find the long-awaited return statement. <br><br>  In between these goto, all possible combinations of normal and exceptional terminations of each try block.  Unexpectedly, for each finally handling an exception, a new local variable is created to hold the exception, even if the blocks are mutually exclusive.  Because of this, the code requires 4097 local variables.  Some statistics on the instructions: <br><br><ul><li>  iconst_1 - 8191 times </li><li>  istore_1 - 8191 times </li><li>  goto - 4095 times </li><li>  athrow - 4095 times </li><li>  astore_2 / aload_2 - 1 time </li><li>  astore_3 / aload_3 - 1 time </li><li>  astore / aload - 252 times (local variables with numbers from 4 to 255) </li><li>  astore_w / aload_w - 3841 times (local variables with numbers greater than 255) </li></ul><br>  Plus one aload_0, one invokespecial and one return - a total of 32765 instructions.  Those interested can draw <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D1%2580%25D0%25B0%25D1%2584_%25D0%25BF%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25B0_%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">a control flow graph</a> and hang it on the wall. <br><br><h5>  Exception table </h5><br>  The exception table contains entries of the form (start_pc, end_pc, handler_pc, catch_type) and tells the virtual machine "if, when executing instructions from the address start_pc to the address end_pc, an exception of the type catch_type occurred, then transfer control to the address handler_pc".  In this case, catch_type is equal to any, that is, any type of exception.  The records in table 8188 and it takes about the same as the code - about 64 kilobytes.  The beginning looks like this: <br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> target <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">49</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">49</span></span> <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-number"><span class="hljs-number">49</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span></code> </pre><br><br><h5>  Line number table </h5><br>  The line number table is debugging information that matches the addresses of the bytecode instructions to line numbers in the source code.  It has 12,288 entries and most often comes across links to the line with the innermost finally.  It takes about 48 kilobytes. <br><br><h5>  Stackmaptable </h5><br>  Where did the rest of the place go?  It was taken by the <a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html">StackMapTable</a> table, which is needed to verify the class file.  If it is very rough, for each branch point in the code, this table contains the types of elements in the stack and the types of local variables at that point.  Since we have a lot of local variables and branch points too, the size of this table grows quadratically with the size of the code.  If local variables were reused for exceptions in non-intersecting branches, they would need only 13 and the StackMapTable table would be much more modest in size. <br><br><h5>  Frighten further </h5><br>  Is it possible to ramp the class file even more?  Of course, you can dig out a method containing nested try-finally.  But the compiler may well do it for us.  Recall that the initialization block is glued to each constructor automatically.  It is enough to add a lot of empty constructors with different signatures to the code.  Be careful here, otherwise the compiler runs out of memory.  Well, you can modestly write this by packing the code into one line: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span></span>{{<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a;<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>{a=<span class="hljs-number"><span class="hljs-number">0</span></span>;}}}}}}}}}}}}}A(){}A(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a){}A(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> a){}A(<span class="hljs-keyword"><span class="hljs-keyword">double</span></span> a){}A(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a){}A(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> a){}A(<span class="hljs-keyword"><span class="hljs-keyword">short</span></span> a){}A(<span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> a){}A(String a){}A(Integer a){}A(Float a){}A(Short a){}A(Long a){}A(Double a){}A(Boolean a){}A(Character a){}}</code> </pre> <br>  Here I have 16 constructors, the source is <b>430 bytes</b> .  After compilation, we have 104,450,071 <b>bytes</b> ; the coefficient of haul was <b>242 907</b> .  And this is not the limit! </div><p>Source: <a href="https://habr.com/ru/post/245333/">https://habr.com/ru/post/245333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245319/index.html">Peter Thiel: Competition - the lot of losers</a></li>
<li><a href="../245321/index.html">Creating World of Tanks Blitz based on your own engine DAVA</a></li>
<li><a href="../245323/index.html">IPv6 addresses via EUI-64: Points above i</a></li>
<li><a href="../245325/index.html">Navigation in rooms with iBeacon and INS</a></li>
<li><a href="../245331/index.html">Down with the absolute units in the icons, sprites</a></li>
<li><a href="../245335/index.html">Hotel rakes: what you need to know in advance if you are doing a conference room</a></li>
<li><a href="../245337/index.html">Partition Option & Oracle Server SE One</a></li>
<li><a href="../245339/index.html">Hadoop for network engineers</a></li>
<li><a href="../245341/index.html">Worthy built-in digital amplifier LF do-it-yourself for reasonable money</a></li>
<li><a href="../245343/index.html">4 major PPC advertising errors that make it ineffective</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>