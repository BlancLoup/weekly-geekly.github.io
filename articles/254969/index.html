<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The killer bundle of NSCache and UINib</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share one more kresham with whom I understood a couple of months ago. Now, after the passage of time, crashreports of this type are no longe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The killer bundle of NSCache and UINib</h1><div class="post__text post__text-html js-mediator-article">  I want to share one more kresham with whom I understood a couple of months ago.  Now, after the passage of time, crashreports of this type are no longer observed in HockeyApp, and earlier they were among the most popular.  Actually, the problem has been observed for quite some time, but then our application still used TestFlight and the information was not enough for analysis.  Kresh was characterized by something like this: <br><br><pre><code class="bash hljs">Thread 0 Crashed: 0 libobjc.A.dylib 0x39abcf42 objc_msgSend + 2 1 CoreFoundation 0x2bfe0c61 __CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + 10 2 CoreFoundation 0x2bf3c6d5 _CFXNotificationPost + 1782 3 Foundation 0x2cc6e129 -[NSNotificationCenter postNotificationName:object:userInfo:] + 70 4 Foundation 0x2cc72c8f -[NSNotificationCenter postNotificationName:object:] + 28 5 UIKit 0x2f750883 -[UIApplication _performMemoryWarning] + 132 6 libdispatch.dylib 0x3a0107a7 _dispatch_client_callout + 20 7 libdispatch.dylib 0x3a021253 _dispatch_source_latch_and_call + 624 8 libdispatch.dylib 0x3a0122ed _dispatch_source_invoke + 210 9 libdispatch.dylib 0x3a013e1f _dispatch_main_queue_callback_4CF + 328 10 CoreFoundation 0x2bfee3b1 __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 6 11 CoreFoundation 0x2bfecab1 __CFRunLoopRun + 1510 12 CoreFoundation 0x2bf3a3c1 CFRunLoopRunSpecific + 474 13 CoreFoundation 0x2bf3a1d3 CFRunLoopRunInMode + 104 14 GraphicsServices 0x332cf0a9 GSEventRunModal + 134 15 UIKit 0x2f5487b1 UIApplicationMain + 1438 16 xxx 0x0015bb81 main (main.m:18) 17 libdyld.dylib 0x3a030aaf start + 0</code> </pre> <a name="habracut"></a><br>  On call - [UIApplication _performMemoryWarning] it is clear that the problem occurred while processing memory warning.  Apparently, some object subscribed to UIApplicationDidReceiveMemoryWarningNotification and forgot to unsubscribe before its destruction.  But checking by project code did not reveal suspicious situations - everyone who used this notification was either singleton or more or less correctly unsubscribed.  At that time, the matter was limited to this; there were no ideas for fixing yet. <br><br>  Then, when Apple bought TestFlight, we switched to HockeyApp.  They use a cool kresreportilku (PLCrashReporter), and in general work with kreshami there was much better (you can also attach your own logs / info when sending a report from the device).  But, returning to the problem, in addition to the stack above, these lines also appeared: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">Application Specific Information: objc_msgSend() selector name: setArchiveData:</code> </pre><br>  Now we know which selector was sent to the deceased object.  In our code, such methods / properties were not present, which confirmed the previous analysis.  Accordingly, the task is to find a class that has such a selector.  The obj-c functions of the objc_getClassList runtime (returns the list of registered classes) and class_copyMethodList (allows you to get the methods of the instances and the class itself) help with this.  Walking through all the classes and checking all their selectors, I got the only option - UINibStorage.  This is a private class, and using swizzling its methods we see that it is created and held by UINibs.  Next, again using swizzling and disassembling, we find out that UINib subscribes to UIApplicationDidReceiveMemoryWarningNotification, and when it is received, it clears the contents of its UINibStorage (including calls setArchiveData) - this call falls in the crash log.  Cancellation of notification occurs in the UINib deallock.  How did it happen that UINib died, but received a notification? <br><br>  The problem seems to have arisen from the fact that we used NSCache to cache nibs.  When memory is low, NSCache clears its contents in the background thread, i.e.  essentially asynchronously with memory warning in the main thread.  So  in the background thread, it is called - [UINib dealloc], in which it unsubscribes from notifications, and the main thing is their processing.  This is the wrong and dangerous approach to using NSNotificationCenter.  Generally speaking, during the work on the project we had to fix a lot of bugs related to asynchrony, because  Many asynchronous operations are performed there.  One of the common mistakes that have been encountered is the cancellation or unsubscribing from anything in the deallock.  This is too late, because  the object is actually dying, and if an asynchronous operation at the same time tries to work with it, then it will end badly.  Unfortunately, the harsh reality is that there is not always a good place to unsubscribe.  In the case of UINib, it is clear that there is no such convenient place, therefore it is difficult to blame for this (rather, then it is worth blaming the infrastructure or NSNotificationCenter). <br><br>  As a solution to the problem, I wrote a trivial cache for storing nibs.  In general, this is not the first crash with NSCache.  I used to have to fix the crash associated with NSCache storage in NSCache - this is also not worth doing.  But I also cannot call NSCache obviously guilty, since  he should not think that it is impossible to send a release to an object in any background thread due to the fact that this release may be the last, and the dealloc does more than nothing.  Perhaps this situation is one of those when clear and forgivable solutions give a negative result. </div><p>Source: <a href="https://habr.com/ru/post/254969/">https://habr.com/ru/post/254969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254955/index.html">Morphological image processing. Lectures from Yandex</a></li>
<li><a href="../254957/index.html">Risks and metrics in test automation</a></li>
<li><a href="../254959/index.html">Ansible - let's try</a></li>
<li><a href="../254961/index.html">Release Rust 1.0 Beta</a></li>
<li><a href="../254965/index.html">FAMP on pfsense using PHP-FPM</a></li>
<li><a href="../254971/index.html">To help the teacher-teacher. Instant test validation</a></li>
<li><a href="../254973/index.html">Convert svg to png</a></li>
<li><a href="../254975/index.html">Presentations 27 reports of our conferences on C #</a></li>
<li><a href="../254979/index.html">We write the extension for Chrome "download audio recordings from Vkontakte", part 2</a></li>
<li><a href="../254981/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ154 (March 30 - April 5, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>