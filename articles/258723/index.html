<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Entity Framework and performance, second attempt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my first attempt to close the hole in the performance of the Entity Framework, I considered only materialization. But further in the process of wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Entity Framework and performance, second attempt</h1><div class="post__text post__text-html js-mediator-article">  In my first attempt to close the hole in the performance of the Entity Framework, I considered only materialization.  But further in the process of work, as one would expect, I came across another, more weighty limitation.  The insertion, modification and deletion of records also occur slowly.  For 100 inserts, EF sends 100 insert requests to the database without attempting to group them. <br><br>  In addition, one unpleasant error was discovered in one of the projects: EF version 5.0.0, when working with Oracle, in Clob / Xml the fields do not allow inserting lines of more than 2000 characters. <br><a name="habracut"></a><br>  A component was created for the solution, which I called Context Items, with the following capabilities: <br><br>  1) Bulk Insert (MS Sql): in tables that do not have Identity as the primary key, it is possible to insert using the Bulk Insert method, which is supported by the Ms Sql Server database.  In the case of Identity, there is no way to reliably get back the keys generated by the base when inserting with the Bulk Insert, therefore, for tables with such keys, several usual Insert-queries are used in one query.  This works significantly slower than the Bulk Insert, but still faster than through EF. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2) Sequenced Bulk Insert (MS Sql): An alternative to Identity is usually the Guid, this solves the insertion problem, but creates another problem - due to the longer key of the Join operation, they start to work slower, besides this the Guid is inconsistent and therefore Clustered indexes do not bring their advantages .  As a solution to this problem, starting with MS Sql Server 2012, it is possible to use Sequence to create primary keys.  This allows the use of integer sequential keys, which allows the use of Clustered indexes, similar to Identity, and at the same time allows the use of Bulk Insert for insertion.  The component only supports acyclic Sequence with increment 1. <br><br>  3) Bulk Update (MS Sql): such an operation does not exist in the database itself, the component implements it sequentially by performing the following 4 operations: <br><pre>    a) A temporary table is created that has the same set of fields as the target table.
    b) Bulk insert data into a temporary table
    c) A Join-Update operation is performed that transfers data from the records of the temporary table to the records of the target table 
       having matching primary keys.
    d) The temporary table is deleted. </pre><br>  Due to the fact that the operation is not atomic, it is desirable to execute it in a transaction. <br><br>  4) Bulk Delete (MS Sql): as well as Bulk Update, this operation occurs in 4 steps: <br><pre>    a) A temporary table is created that has a set of fields that matches the primary key of the target table
    b) Bulk Insert is made to the temporary key table for the records to be deleted.
    c) A Join-Delete operation is performed.
    d) The temporary table is deleted.
</pre><br>  5) Materialization: The function migrated from the previous version; in addition, I added a test project to the repository, which includes a comparison of the materialization performance with the micro-ORM Dapper.  Context Items performs this operation about 3-5% faster than Dapper, and 40% faster than EF, when using AsNoTracking, without this, EF is still several times slower. <br><br>  6) Array-bound Insert, Update and Delete (Oracle): The Bulk Insert component implemented in ODP.Net does not take into account neither triggers nor constraints, nor even primary keys.  Therefore, it is not suitable for inserting directly into a table.  In addition, it does not support transactions.  Of course, you could try using a temporary table as in the case of MSSql, but I decided to use the method that is recommended by Oracle itself.  The method is called array-binding.  In short, a request sent to the database looks like we insert one record, but we pass not a set of fields as parameters, but a set of field arrays, and thus insert, update or delete an array of records, rather than one record.  You can read about the method <a href="http://www.oracle.com/technetwork/issue-archive/2009/09-sep/o59odpnet-085168.html">here.</a> <br><br>  7) Equality members: For all entities, methods GetHashCode and Equals are generated that work with the primary key. <br><br>  The Context Items component supports EF version 5.0.0 - 6.1.3, as well as Oracle databases and MS Sql Server. <br>  Only the database-first approach is supported, there is a limitation - the names of the entities must match the names of the tables.  Hands did not reach to fix this restriction. <br><br>  The component is published on nuget.org, with contextitemsmssql and contextitemsoracle identifiers.  You can read more about installation and use in the repository on GitHub.com: <a href="https://github.com/repinvv/ContextItems">github.com/repinvv/ContextItems</a> </div><p>Source: <a href="https://habr.com/ru/post/258723/">https://habr.com/ru/post/258723/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258711/index.html">Podcast "Five Minute PHP"</a></li>
<li><a href="../258715/index.html">The long-awaited domestic processor Baikal-T1 was released</a></li>
<li><a href="../258717/index.html">Windows Preinstallation Network Download Guide (WinPE)</a></li>
<li><a href="../258719/index.html">Remote user experience: Windows Server 2012R2 RDS and Azure RemoteApp</a></li>
<li><a href="../258721/index.html">Checking open source UEFI for Intel Galileo with PVS-Studio</a></li>
<li><a href="../258725/index.html">How Valera took a trainee team and started teaching him how to design</a></li>
<li><a href="../258727/index.html">Project "Oberon 2013"</a></li>
<li><a href="../258729/index.html">Registration is now open for the third annual championship for developers of the Russian Developers Cup</a></li>
<li><a href="../258731/index.html">Google WebFonts and FontFaceObserver. Use third-party fonts on your website</a></li>
<li><a href="../258735/index.html">Secure SSL / TLS Russian Internet Banking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>