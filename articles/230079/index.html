<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JSON Recording</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="JSON Recording 
 In one of my programs I needed to write data in JSON format . In short, an XML-like format is quite suitable for replacing Windows IN...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JSON Recording</h1><div class="post__text post__text-html js-mediator-article"><h4>  JSON Recording </h4><br>  In one of my programs I needed to write data in <a href="http://json.org/json-ru.html">JSON format</a> .  In short, an XML-like format is quite suitable for replacing Windows INI files or the same XML.  It is convenient in that it supports arrays and nesting of its own structures, but at the same time it does not litter the data file with its tags until it is completely unreadable by humans.  Here is an example data file: <br><pre><code class="cpp hljs">{ <span class="hljs-string"><span class="hljs-string">"Comment"</span></span>:<span class="hljs-string"><span class="hljs-string">"My comment"</span></span>, <span class="hljs-string"><span class="hljs-string">"Count"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"DiskParam"</span></span>: { <span class="hljs-string"><span class="hljs-string">"DB"</span></span>:<span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-string"><span class="hljs-string">"DBAngle"</span></span>:<span class="hljs-number"><span class="hljs-number">1.234000</span></span> }, <span class="hljs-string"><span class="hljs-string">"Range"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"Blades"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"Caption"</span></span>:<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>:<span class="hljs-number"><span class="hljs-number">65</span></span> }, { <span class="hljs-string"><span class="hljs-string">"Caption"</span></span>:<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>:<span class="hljs-number"><span class="hljs-number">66</span></span> }, { <span class="hljs-string"><span class="hljs-string">"Caption"</span></span>:<span class="hljs-string"><span class="hljs-string">"C"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>:<span class="hljs-number"><span class="hljs-number">67</span></span> } ], <span class="hljs-string"><span class="hljs-string">"Slots"</span></span>: [ <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> ] }</code> </pre> <br>  The format is quite simple, it is quite possible to work with it without any libraries.  Therefore, initially the following code was responsible for the record: <br><pre> <code class="cpp hljs"> <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(pOut, <span class="hljs-string"><span class="hljs-string">"{\n"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(pOut, <span class="hljs-string"><span class="hljs-string">" \"Comment\":\"%s\""</span></span>, Header-&gt;Comment); <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(pOut, <span class="hljs-string"><span class="hljs-string">",\n \"NumSt\":%d"</span></span>, Header-&gt;NumSt); <span class="hljs-comment"><span class="hljs-comment">//   fprintf(pOut, ",\n \"DBMax\":%lf", Header-&gt;DBMax); fprintf(pOut, ",\n \"Range\":%s", Header-&gt;Range?"true":"false"); fprintf(pOut, ",\n \"Blades\":\n ["); for(int i=0; i&lt;Header-&gt;Count; i++) { TElement &amp;e=Element[i]; fprintf(pOut, i?",\n {":"\n {"); fprintf(pOut, "\"Caption\":\"%s\"", e.Caption); fprintf(pOut, ",\"Value\":%lf", e.BaseChar); fprintf(pOut, "}"); } fprintf(pOut, "\n ]"); //   fprintf(pOut, "\n}");</span></span></code> </pre> <br>  Koryavno, although quite workable.  But the program was actively developed, the data format was changed 5 times a day and the problem of tracking all changes was acute.  Despite some formatting of the source code, it was hard not to forget to close any tag or correctly print the necessary number of spaces to format the data file itself.  Even in the above fragment, before publication, an error was discovered, a comma was not put between the elements of the array. <br><br>  I decided this technical process to slightly mechanize and create a micro library for working with JSON. <br><a name="habracut"></a><br>  What did I want?  So that in my program I wrote something in pseudo-language: <br><pre> <code class="cpp hljs">Key(<span class="hljs-string"><span class="hljs-string">"1"</span></span>); Value(<span class="hljs-string"><span class="hljs-string">"1"</span></span>); Key(<span class="hljs-string"><span class="hljs-string">"2"</span></span>); Value(<span class="hljs-string"><span class="hljs-string">"2"</span></span>); Object(<span class="hljs-string"><span class="hljs-string">"1"</span></span>); Key(<span class="hljs-string"><span class="hljs-string">"3"</span></span>); Value(<span class="hljs-string"><span class="hljs-string">"3"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//3,4   1 Key("4"); Value("4"); Array("1"); Key("5"); Value("5"); //5...N   1 Key("6"); Value("6"); ... Key("N"); Value("N");</span></span></code> </pre> <br>  And let the compiler / program take into account the indents that determine the structure of the data file.  At the right moment will substitute the opening and, most importantly, the closing tag.  The matter was complicated by the fact that inside this script I wanted to use C ++ constructs, for example, loops inside arrays. <br><br>  After several days of continuous brain siege of this problem, a rather elegant solution was found.  To control the insertion of JSON entities into each other and the timely closure of tags, the scope of variables is used.  Quite simply, an instance of one of the TJson *** classes is created ‚Äî the key and the opening tag are written and all the following created objects are considered to be its attachments.  The copy is destroyed - the closing tag is put. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TCF_USED 1 class TTagCloser { public: TTagCloser *Owner; static TTagCloser *Current; static int Depth; int Flags; int Count; int operator()(){Flags^=TCF_USED; return Flags&amp;TCF_USED;} TTagCloser(){Count=Flags=0; Owner=Current; Current=this; Depth++;} ~TTagCloser(){Depth--; Current=Owner;} }; TTagCloser *TTagCloser::Current=NULL; int TTagCloser::Depth=-1;</span></span></code> </pre> <br>  A simple class, the whole purpose of which is to temporarily associate the generated objects into a kind of tree.  For what the overloaded operator () is needed will be clear a bit later. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This class has a descendant in which the basic writing functionality in JSON format is laid.  The programmer should only override the Write *** function. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TCF_OBJECT 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TCF_ARRAY 2 class TJsonTagCloser:public TTagCloser { public: void WriteTab(); void WriteInt(int); void WriteDouble(double); void WriteStr(char *); TJsonTagCloser(char *Key); }; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//---------------------------------------------------------------------------- TJsonTagCloser::TJsonTagCloser(char *Key):TTagCloser() { if(Owner) { if(Owner-&gt;Count) WriteStr(","); if(Owner-&gt;Flags&amp;TCF_ARRAY) { if(!Owner-&gt;Count) WriteTab(); } else { WriteTab(); WriteStr("\""); if(Key) WriteStr(Key); WriteStr("\":"); } Owner-&gt;Count++; } }</span></span></span></span></code> </pre> <br>  The WriteTab () function is introduced into the convenience program of geeks who like to climb Notepad data files.  It should write a line feed and the number of spaces corresponding to the embedding depth (TTagCloser :: Depth) in the data file.  If formatting were not necessary, the function would degenerate into WriteTab () {;}. <br><br>  In my test example, the functions Write *** are defined as follows: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; void TJsonTagCloser::WriteTab(){printf("\n%*s", Depth*2, "");} void TJsonTagCloser::WriteInt(int Value){printf("%d", Value);} void TJsonTagCloser::WriteDouble(double Value){printf("%lf", Value);} void TJsonTagCloser::WriteStr(char *Value){printf("%s", Value);}</span></span></span></span></code> </pre> <br>  JSON-format assumes that there are Objects in the data stream (they look like SIC structures), Arrays (they are also arrays in Africa), and simply ‚ÄúKey: Value‚Äù pairs.  All this diversity can be mixed and nested in each other, for example in a pair of ‚ÄúKey: Value‚Äù. The value can be an Array of Objects.  The following classes are created for working with these entities: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TJsonArray</span></span></span><span class="hljs-class">:</span></span><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TJsonTagCloser { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TJsonArray(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key); ~TJsonArray(); }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TJsonObject</span></span></span><span class="hljs-class">:</span></span><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TJsonTagCloser { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TJsonObject(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key); ~TJsonObject(); }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TJsonValue</span></span></span><span class="hljs-class">:</span></span><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TJsonTagCloser { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TJsonValue(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Value):TJsonTagCloser(Key){WriteInt (Value);} TJsonValue(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key, <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Value):TJsonTagCloser(Key){WriteDouble(Value);} TJsonValue(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Value):TJsonTagCloser(Key){WriteStr((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)(Value?<span class="hljs-string"><span class="hljs-string">"true"</span></span>:<span class="hljs-string"><span class="hljs-string">"false"</span></span>));} TJsonValue(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Value); }; TJsonArray::TJsonArray(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Key):TJsonTagCloser(Key) { Flags|=TCF_ARRAY; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Owner &amp;&amp; (!(Owner-&gt;Flags&amp;TCF_ARRAY) || Owner-&gt;Count&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>)) WriteTab(); WriteStr(<span class="hljs-string"><span class="hljs-string">"["</span></span>); } TJsonArray::~TJsonArray() { WriteTab(); WriteStr(<span class="hljs-string"><span class="hljs-string">"]"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//---------------------------------------------------------------------------- TJsonObject::TJsonObject(char *Key):TJsonTagCloser(Key) { Flags|=TCF_OBJECT; if(Owner &amp;&amp; (!(Owner-&gt;Flags&amp;TCF_ARRAY) || Owner-&gt;Count&gt;1)) WriteTab(); WriteStr("{"); } TJsonObject::~TJsonObject() { WriteTab(); WriteStr("}"); } TJsonValue::TJsonValue(char *Key, char *Value):TJsonTagCloser(Key) { if(Value) { WriteStr("\""); WriteStr(Value); WriteStr("\""); } else WriteStr("null"); }</span></span></code> </pre> <br>  For ease of use of the library in its program defined macros: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ARRAY(k) for(TJsonArray array(k); array();) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OBJECT(k) for(TJsonObject object(k); object();) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VALUE(k,v) {TJsonValue value(k,v);}</span></span></code> </pre> <br>  So we got to the overloaded operator ().  It is needed for a single execution of the body of the for loop, that is, it returns true to the first call and false to subsequent calls. <br><br>  And this is how the script looks in the body of the program, on which the filling of the data file is written: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ OBJECT(<span class="hljs-string"><span class="hljs-string">""</span></span>) { VALUE(<span class="hljs-string"><span class="hljs-string">"Comment"</span></span>, <span class="hljs-string"><span class="hljs-string">"My comment"</span></span>); VALUE(<span class="hljs-string"><span class="hljs-string">"Count"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); OBJECT(<span class="hljs-string"><span class="hljs-string">"DiskParam"</span></span>) { VALUE(<span class="hljs-string"><span class="hljs-string">"DB"</span></span>, <span class="hljs-number"><span class="hljs-number">10.0</span></span>); VALUE(<span class="hljs-string"><span class="hljs-string">"DBAngle"</span></span>, <span class="hljs-number"><span class="hljs-number">1.234</span></span>); } VALUE(<span class="hljs-string"><span class="hljs-string">"Range"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); ARRAY(<span class="hljs-string"><span class="hljs-string">"Blades"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-string"><span class="hljs-string">'A'</span></span>; i&lt;<span class="hljs-string"><span class="hljs-string">'A'</span></span>+<span class="hljs-number"><span class="hljs-number">3</span></span>; i++) OBJECT(<span class="hljs-string"><span class="hljs-string">""</span></span>) { VALUE(<span class="hljs-string"><span class="hljs-string">"Caption"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)&amp;i); VALUE(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>, i); } } ARRAY(<span class="hljs-string"><span class="hljs-string">"Slots"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>; i++) VALUE(<span class="hljs-string"><span class="hljs-string">""</span></span>, i); } }</code> </pre> <br>  You can see the JSON file generated by this program at the beginning of the article.  All commas are stamped, all parentheses are closed when necessary, in each line the required number of leading spaces - beauty! </div><p>Source: <a href="https://habr.com/ru/post/230079/">https://habr.com/ru/post/230079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230059/index.html">Creating a project management system at Yandex Tolstoy Camp</a></li>
<li><a href="../230063/index.html">Email: Email Tracking Services</a></li>
<li><a href="../230065/index.html">Creating a new module for open-source CRM EspoCRM</a></li>
<li><a href="../230073/index.html">Search Mediawiki with Sphinx</a></li>
<li><a href="../230075/index.html">Latent semantic analysis and artificial intelligence (LSA and AI)</a></li>
<li><a href="../230081/index.html">Create game character</a></li>
<li><a href="../230083/index.html">What is wrong with Angara-1.2PP</a></li>
<li><a href="../230085/index.html">Remote access for mobile devices: managed and cloud VPN services</a></li>
<li><a href="../230087/index.html">Juniper SRX: Site-to-Site IPSec VPN using pre-shared-key</a></li>
<li><a href="../230091/index.html">WEXLER.TAB 8q Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>