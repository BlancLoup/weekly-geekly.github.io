<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we schedule public transport in 2GIS added</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2GIS helps to navigate the city. You open the application, enter the name of the street or organization in the search, find, rejoice. After the necess...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we schedule public transport in 2GIS added</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/iv/vq/vz/ivvqvzsblexpxjsszzlpjetb3ry.png"><br><br>  2GIS helps to navigate the city.  You open the application, enter the name of the street or organization in the search, find, rejoice.  After the necessary organization is found, a reasonable question arises: how to get there?  And if we recently paid considerable attention to automotive scenarios, then the search for travel on public transport was forgotten a little.  I will tell you about how the search for travel was created, share the intricacies of collecting and processing information. <br><a name="habracut"></a><br><h3>  Where did the task come from </h3><br>  We love to communicate with users.  At the end of 2016, we conducted a survey to find out how our users use public transport.  The result was curious - we share. <br><br><img src="https://habrastorage.org/webt/i-/9u/6r/i-9u6r_jys61twylegtvt41f2fe.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ‚Äú <i>How often do you use public transport?‚Äù</i>  " <br><br>  In general, in all cities where 2GIS is present, more than half of the respondents use public transport every day.  The larger the city, the more people use public transport daily.  On weekdays, it is most popular with residents of Moscow and St. Petersburg, and in other cities, people actively use public transport and on weekends. <br><br>  With the frequency of use figured out, time to see what types of public transport - the favorites of citizens. <br><br><img src="https://habrastorage.org/webt/ts/vo/o9/tsvoo9wtcalya_eudsy1cprznoe.png"><br><br>  ‚Äú <i>Which modes of transport do you prefer?‚Äù</i>  " <br><br>  Regarding the top positions, the result is quite expected.  In large cities, the preferred mode of transport is the metro.  Second place for buses.  More than a third of Muscovites use the train.  In Novosibirsk, they go by minibus, and in Petersburg, among other things, they like trams. <br><br>  An interesting discovery was that half of the respondents could walk to their destination. <br><br>  The next step was to ascertain the weaknesses of 2GIS.  We came to users with a question - what are we missing? <br><br><img src="https://habrastorage.org/webt/vy/up/ox/vyupoxdh2-wozlhte0_wrszbiwu.png"><br><br>  ‚Äú <i>What is missing in 2GIS?</i>  " <br><br>  The problem with the choice of specific modes of transport, we decided using the newly released filters, where the user can specify which type of transport he wants to use.  But the question ‚ÄúWhen will the bus arrive?‚Äù Remains relevant for 64% of the respondents. <br><br>  It was at this moment that we thought about adding a public transport timetable to 2GIS and how all our desires could be realized. <br><br><h3>  Where to get the data? </h3><br>  This is the first question we have encountered.  Indeed, in most cases for our product, we collect data on our own.  When a new microdistrict is built in the city, the information collector travels to the claimed location and verifies all the necessary details ‚Äúin the fields‚Äù.  With the new feature, the usual approach would not work.  Sending specialists to a bus stop is a waste of time and effort, as the schedule is constantly changing.  New carriers appear, routes are optimized, winter gives way to spring.  During the collection, planned schedules and intervals would simply be outdated. <br><br>  Yes.  Unfortunately, the data is becoming obsolete, and this was the second problem that confronted us.  The logical and quite obvious decision was to apply to those who schedule and control this - in subordinate institutions.  Often, a constructive dialogue began only through a thorny bureaucratic path and advice, such as: "Write to the Ministry of Transport / Depression, and then we'll talk." <br><br>  Found responsible, started the dialogue - half the problem. <br><br>  Next began the marathon with: <br><br><ol><li>  Explanations that we want and why we need it. </li><li>  Beliefs that our idea is useful for residents and visitors. </li><li>  Proof that 2GIS does not monetize the construction of routes, taking into account the frequency of movement. </li><li>  The assurances that it is safe. </li></ol><br>  Victory?  And no. <br><br>  The most curious thing is the technical side of the issue, and in particular, the data transfer format.  Yes, in some cities there are automated systems for maintaining a schedule and an API for accessing this data (gtfs or transferring to json in its own format), but this was not expected everywhere.  Somewhere they simply offered to parse the site, again, for security reasons, without providing access to the databases.  Somewhere we were ready to send files (.xls, .doc, .pdf), but only once, without the ability to timely update the information in our directory. <br><br>  We assigned the first place by originality to a photo of a piece of paper with a schedule of public transport. <br><br>  But initially the problem seemed trivial - to get publicly available data from the original source! <br><br><h3>  Loading data into the internal system </h3><br>  Having accessed and downloaded the data, we faced another problem.  You can not just take and upload other people's data into the internal system. <br><br><h3>  Why? </h3><br>  It's time to tell how the original data is stored inside 2GIS. <br>  We develop all internal products for collecting and storing information.  The software for cartographers (who are responsible not only for the map, but also for transport) is called Fiji - a detailed story <a href="https://habrahabr.ru/company/2gis/blog/341508/">here</a> (briefly, cartographers draw a traffic graph in Fiji, enter data on public transport, store the timetable. All the collected routes have already been entered into the system ). <br><br>  The first analysis showed that the routes within our system and among suppliers differ, and in places - drastically.  It was necessary to somehow map their own routes and routes of the supplier.  You can, of course, do it manually, but we decided to write our own matcher. <br><br><img src="https://habrastorage.org/webt/lb/uc/fq/lbucfqgsyqgi1ocukur1lni5s3k.png"><br><br>  <a href="https://ru.wikipedia.org/wiki/General_Transit_Feed_Specification">GTFS was</a> chosen as an intermediate format for storage as a generally accepted standard, plus some suppliers are able to issue a schedule in this format.  For the intermediate database on which the matcher works, we chose PostgreSQL, and the matcher himself wrote it for simplicity in Python. <br><br>  The match simply did not work out according to the type and name of the route, since the routes diverge greatly in names between us and the suppliers.  Match the names of the stops did not work for the same reason.  As a result, the matcher works according to a rather complicated scheme, taking into account the geometry of the route, the type of transport and then the names of the stops and the route numbers. <br><br>  At the same time, there are still errors in the comparison, as the suppliers have a very large number of areas: separately for each weekday, separately for every day off.  Errors also occur in the comparison of ring routes if they are set up differently at the supplier and in our internal system (Fiji). <br><br>  Therefore, the final decision is the same for the person - the cartographer can manually cancel the schedule mapping if he realizes that the algorithm worked incorrectly. <br><br><h3>  Algorithm </h3><br>  The core of the search algorithm is written in C ++.  In fact, the search for travel on public transport is not one algorithm, but several.  The search for passage to the nearest stops is considered to be our pedestrian routing algorithm, which, in turn, consists of two algorithms - ‚Äú <a href="https://habrahabr.ru/company/2gis/blog/266753/">pixel</a> ‚Äù (with which we build a passage through the territory without a graph of roads) and the usual one (already on a pedestrian graph to the stop). <br>  In the quality of the search algorithm of travel between stops, we use a strongly modified <a href="https://ru.wikipedia.org/wiki/A*">A *</a> , to which we added support for the accounting of the schedule.  And if earlier the waiting time of transport at the bus stop was a kind of ‚Äúaverage‚Äù time for each project and each type of transport, now either the exact or interval schedule is taken into account. <br><br>  At the same time, the algorithm had to take into account many funny nuances in the data.  For example, a route may have a departure time from a stop at 25 or even 47 hours.  From the point of view of data, this means that this is the same flight that went in the previous day, and he just has not completed his work.  You also need to take into account that the flight can start walking ‚Äútomorrow‚Äù and, if the user is looking for a route at the end of the current day, then you need to look in the next day (as relevant, if you keep the schedule by day). <br><br>  Separately solved the problem of how to combine data with a schedule and without a schedule.  In the end, we decided that routes with no timetable still participate in the search, they just have less weight.  At the same time, if a route without a timetable coincides with stopping platforms with a route with a timetable, then we simply hook it up to issue, and if it goes somehow differently, then this will be a separate travel option with less weight, since we don‚Äôt We know about the waiting time at the bus stop. <br><br>  Since 2GIS works both online and offline, the algorithm works both inside the application and on the server.  Despite the fact that these schedules are more or less static, our server search is also used, because on slow devices, if the Internet is available, the server request will be processed much faster than local search.  For server search, we have 8 search backends located in three data centers in Novosibirsk, Moscow and Dronten (Holland). <br><br><h3>  Release </h3><br>  The final result of adding the public transport timetable to 2GIS you can evaluate in our mobile application in <a href="https://play.google.com/store/apps/details%3Fid%3Dru.dublgis.dgismobile">Google Play</a> and the <a href="https://itunes.apple.com/ru/app/2%25D0%25B3%25D0%25B8%25D1%2581/id481627348">App Store</a> .  The web version will appear a little later. <br><br>  Having grown jealous, we received quite a lot of feedback.  After analyzing the negative, identified two main causes of complaints: <br><br><ol><li> We didn‚Äôt tell the users in a proper way that the timetable is now used in the search for directions and broke the usual scripts for working with the application. <br>  When searching for a route in the evening or at night, users lost their usual routes in the issue.  Control the choice of date / time of travel when building a route fell out of scope. <br><br>  Most of the calls to technical support looked like this: <br><br>  <i>- Hello, you search for travel in public transport has become inadequate, because ....</i>  <i>/ description of a specific problem.</i> <i><br></i>  <i>- You know, we released a schedule in search of travel by public transport, here is the control, you can set the time for which the trip is planned.</i> <i><br></i>  <i>- It is clear, thank you very much!</i> </li><li>  The algorithm tried not to offer routes without a schedule (or omit them in the issue) if there is an alternative with a schedule.  Because of this, in some cases, the issue has become less relevant. <br><br>  Our technologists had to urgently refine and manually make an interval schedule for all remaining modes of transport to return them to the issue, and we - to carry out additional adjustment of search algorithms. </li></ol><br><h3>  Captain conclusions </h3><br>  What conclusions can be made on the basis of the launch? <br><br><ul><li>  If you plan to use other people's data in your application, be sure to think about how you will get these same data.  Not the fact that your expectations and reality coincide.  Consider the risks. </li><li>  If you greatly change the current logic of the application - be sure to tell users about it and teach them to use new features: ‚ÄúWhat's new‚Äù in the pages read units. </li><li>  Prepare technical support for a surge of calls no matter how well you told about the new feature and how to use it. </li></ul><br><h3>  PS About completeness </h3><br>  As far as it was possible to reach an agreement with all Deptrans / Mintrans, the schedule so far is only in Moscow, St. Petersburg, Novosibirsk, Yekaterinburg, Krasnoyarsk, Omsk, Chelyabinsk, Krasnodar and Rostov-on-Don.  We will increase the coverage of transport by the timetable in these cities, as well as add new cities, as we receive data. </div><p>Source: <a href="https://habr.com/ru/post/343924/">https://habr.com/ru/post/343924/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343912/index.html">Should I develop my hobby in a startup?</a></li>
<li><a href="../343914/index.html">The history of moving the system administrator in Germany. Part One: Job Search and Visa</a></li>
<li><a href="../343916/index.html">How to evaluate the effectiveness of advertising in the application: ARPDAU, seasonality and a few secrets</a></li>
<li><a href="../343918/index.html">ASO Monthly # 17: September 2017</a></li>
<li><a href="../343922/index.html">Performance as Perception: Managing Perception</a></li>
<li><a href="../343926/index.html">Announcement of the conference Mobius 2018 Piter</a></li>
<li><a href="../343928/index.html">Metrics storage: how we switched from Graphite + Whisper to Graphite + ClickHouse</a></li>
<li><a href="../343930/index.html">Tcl / Tk. Thematic TTK widgets and designer TKproE-2.20</a></li>
<li><a href="../343932/index.html">Name Assignment: Programmer's Guide</a></li>
<li><a href="../343934/index.html">Why repository in pom.xml is a bad idea</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>