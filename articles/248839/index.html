<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of software for laser thickness on FriendlyARM Smart210</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Short description: the task is to measure the cross section of an object between two moving laser sensors, the whole calculation takes place on the co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of software for laser thickness on FriendlyARM Smart210</h1><div class="post__text post__text-html js-mediator-article">  Short description: the task is to measure the cross section of an object between two moving laser sensors, the whole calculation takes place on the computer side. <br><br>  Qt was chosen as a development tool due to the fact that it is a cross-platform product, as well as OpenSource.  Qt was installed the latest at the time of version 5.4.  The initial use of the program was assumed under Windows OS with a touch screen.  Somewhere in the middle of the path we decided to remake the Smart210. <br><a name="habracut"></a><br>  Smart210 development of our Chinese counterparts, with the ability to install operating systems (included): WinCE 6, Linux, Qtopia, Android.  The Debian build was also tested. <br><br>  The target system on this device was originally Linux.  Working with the thickness gauge controller via FT2232HL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The use of proprietary FTDI drivers has a number of steps and features: <br><br>  Requires disabling the standard ftdi_sio and usbserial libraries: <br><br><pre><code class="bash hljs">sudo rmmod ftdi_sio sudo rmmod usbserial</code> </pre> <br>  This is impossible to do without rebuilding the kernel with the inclusion of these libraries as kernel modules. <br><br>  The kernel was built using the toolschain arm-linux- version 4.5.1 supplied by the manufacturer, an attempt to build the kernel with newer compilers caused the touchscreen to not work, because the module sarmarm-ts-mtinput (responsible for the multi touch screen) fell into errors, possibility of rebuilding for new compilers is missing (no source). <br><br>  In the file mini210_linux_defconfig, set the path to the compiler and configure as kernel modules: <br><br><pre> <code class="bash hljs">CONFIG_CROSS_COMPILE=<span class="hljs-string"><span class="hljs-string">"arm-linux-"</span></span> ... CONFIG_USB_SERIAL=m CONFIG_USB_SERIAL_FTDI_SIO=m</code> </pre><br>  Although CONFIG_USB_SERIAL = m includes all dependent libraries as kernel modules, including ftdi_sio (just in case CONFIG_USB_SERIAL_FTDI_SIO = m).  Then execute the command: <br><br><pre> <code class="bash hljs">./build</code> </pre><br>  Since the composition of the modules has changed, it is necessary to perform: <br><br><pre> <code class="bash hljs">make modules</code> </pre><br>  After that, it remains to copy to the file system.  Building the file system with the yaffs2 utility bundled from the disk caused a file error at the time of installation.  I had to use the standard: <br><br><pre> <code class="bash hljs">mkyaffs2 rootfs_rtm_210 rootfs_rtm_210.img</code> </pre><br>  After the done manipulations it became possible to use the FTDI library. <br>  Qt to work in Linux took version 5.3.2 and compiled with linuxfb support. <br><br>  Subsequent use of this approach revealed insufficient drawing speed (the touch screen did not react when drawing).  Used for drawing frame buffer, the lack of support for OpenGL ES from the drivers. <br><br>  I stopped on Android, I had to redraw the rewrite to use ttyUSB, since FTDI driver for Android exists only for Java. <br><br>  When FTDI was disconnected and connected, the appearance of 0x00 bytes was found, which led to a shift, and with a fixed data length of 10 bytes and without the sign of the beginning of the packet, it created trouble.  In addition, a break (as an emergency could break a packet), the solution is to look for the first 10 bytes tested for CRC8: <br><br><pre> <code class="hljs vala"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Controller::readBlockN(<span class="hljs-keyword"><span class="hljs-keyword">uchar</span></span> *tmp, qint64 blockSize){ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytesReceived = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytesRead = <span class="hljs-number"><span class="hljs-number">0</span></span>; qint64 m_blockSize = blockSize; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (m_blockSize &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { bytesReceived = read(uart0_filestream, ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)&amp;tmp_block) + bytesRead, m_blockSize); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytesReceived &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ m_blockSize -= bytesReceived; bytesRead += bytesReceived; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytesRead &gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tmp_block[bytesRead - blockSize + <span class="hljs-number"><span class="hljs-number">9</span></span>] == getCRC8((<span class="hljs-keyword"><span class="hljs-keyword">uchar</span></span>*)&amp;tmp_block + bytesRead - blockSize, <span class="hljs-number"><span class="hljs-number">9</span></span>)){ memcpy(tmp, (<span class="hljs-keyword"><span class="hljs-keyword">uchar</span></span>*)&amp;tmp_block + bytesRead - blockSize, <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ m_blockSize = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  At this stage, it was discovered that there are no rights to use ttyUSB * ports and this happens after each reboot.  The solution is to insert a string when loading the program: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("su -c 'chmod 777 /dev/ttyUSB*'");</code> </pre><br>  It remained to remove the navigation bar (make the most of the screen, in addition, it is assumed that this device will not run other applications).  The standard panel does not respond to hiding events and is always on top of all applications.  I decided to just remove it: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("su -c 'rm /system/app/SystemUI.apk'");</code> </pre><br>  FriendlyARM has a battery that does not reset the time, but still decided to call the standard Android date settings when you start the application: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("am start -n com.android.settings/.DateTimeSettingsSetupWizard");</code> </pre><br><br>  Graphics are fully traced in QgraphicsView: <br><br>  System Status: <br><br><img src="https://habrastorage.org/files/136/78d/e65/13678de6592d410291111ebc250927b6.png"><br><br>  Manual mode: <br><br><img src="https://habrastorage.org/files/a45/ad6/0e1/a45ad60e1f0241d2be1be12f1d0bc956.png"><br><br>  Auto mode: <br><br><img src="https://habrastorage.org/files/09f/732/b9c/09f732b9c1924b62bbb06b0efffd96b2.png"><br><br>  Video: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/DNt-Z3HIcGU%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhieKRJv4MgguXch0yu9I-kdSPX5PQ" frameborder="0" allowfullscreen=""></iframe><br><br>  Surveys and results: <br><br>  Debian: <br>  Cumbersome, takes ~ 430MB in its pure form, there is support for OpenGL ES, the mesa driver is used.  There is no support for multi touch screen. <br><br>  Qtopia: <br>  The lack of support for OpenGL ES, and she herself has not been supported for a long time. <br><br>  Linux (rootfs_rtm_210): <br>  The lack of support for OpenGL ES, takes up very little space in its pure form ~ 15MB, with all Qt ~ 90MB libraries installed, the OS download speed is just over 8 seconds. <br><br>  WinCE 6: <br>  Not tested seriously, just rummaged in a binary file on the mention of OpenGL ES, and it would require an argument under CE.  Time is running out decided to postpone. <br><br>  Android: <br>  Supports OpenGL ES, takes ~ 215 MB, runs about 2 minutes. </div><p>Source: <a href="https://habr.com/ru/post/248839/">https://habr.com/ru/post/248839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248829/index.html">Modern Business Intelligence (BI) systems by the example of IBM Cognos BI</a></li>
<li><a href="../248831/index.html">Features of the Intel x86 Hi-End Server - HP Superdome X System</a></li>
<li><a href="../248833/index.html">IBM introduced the new z13 mainframe</a></li>
<li><a href="../248835/index.html">PHP Digest number 55 - interesting news, materials and tools (January 11 - 25, 2015)</a></li>
<li><a href="../248837/index.html">How to implement almost instant site switching between sites, when one fell</a></li>
<li><a href="../248841/index.html">What I wanted to know at the beginning of my development career. Part 1</a></li>
<li><a href="../248843/index.html">How to encrypt and hide a hard disk partition using CyberSafe</a></li>
<li><a href="../248845/index.html">PostgreSQL vs MySQL</a></li>
<li><a href="../248847/index.html">Unification and search with return on C #</a></li>
<li><a href="../248851/index.html">Bitcoin and previously created anonymous electronic money systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>