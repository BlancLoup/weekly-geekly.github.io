<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CI for frontend: Gitlab, Traefik, Docker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every self-respecting project should involve QA engineers. Every day they will be faced with the task of checking the execution of tasks in separate b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CI for frontend: Gitlab, Traefik, Docker</h1><div class="post__text post__text-html js-mediator-article">  Every self-respecting project should involve QA engineers.  Every day they will be faced with the task of checking the execution of tasks in separate branches.  Very often, the process of switching to the desired branch, assembly and testing takes a lot of time, and besides, it is not always possible locally to completely recreate the most identical combat environment. <br><br>  The purpose of this article is to show a simple technique of setting up a stand for several branches.  This article is written by developers from the developer, so it is unlikely to be of significant interest to professional DevOps engineers. <br><a name="habracut"></a><br>  <b>Requirements:</b> <br><br><ul><li>  Gitlab (bare metal / cloud) </li><li>  Dedicated server </li><li>  Free domain </li></ul><br><h3>  Step One: Configure Gitlab </h3><br><ol><li>  <a href="https://docs.gitlab.com/runner/install/">Install Gitlab Runner on your dedicated server</a> </li><li>  <a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">Create a worker that supports docker builds of images</a> </li><li>  <a href="https://docs.gitlab.com/ee/user/project/container_registry.html">Turn on the Container Registry</a> </li></ol><br><h3>  Step Two: Server Setup </h3><br><ol><li>  <a href="https://docs.docker.com/install/">Install Docker</a> </li><li>  <a href="https://docs.docker.com/compose/install/">Install Compose</a> </li><li>  Create a user: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     ,      $ sudo adduser deployer $ sudo groupadd docker $ sudo usermod -aG docker deployer #  ssh  $ su deployer $ ssh-keygen -t rsa (when asked for a passphrase, enter no passphrase) #          $ cp ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys</span></span></code> </pre> <br></li><li>  Configure traefik (server proxying requests to Docker containers based on their labels (labels)): <br><br><pre> <code class="bash hljs">$ sudo mkdir -p /opt/traefik $ docker network create web <span class="hljs-comment"><span class="hljs-comment">#   docker-compose &amp; traefik        </span></span></code> </pre><br>  <b>/opt/traefik/docker-compose.yml</b> <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> services: traefik: image: traefik:<span class="hljs-number"><span class="hljs-number">1.4</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> networks: - web volumes: - /var/run/docker.sock:/var/run/docker.sock - ./traefik.toml:/traefik.toml container_name: traefik networks: web: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br>  <b>/opt/traefik/traefik.toml</b> <br><br>  Replace DOMAIN.COM with your domain. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> checkNewVersion = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> logLevel = "ERROR" defaultEntryPoints = ["http"] [entryPoints] [entryPoints.http] address = ":80" [retry] [docker] endpoint = "unix:///var/run/docker.sock" <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> = "DOMAIN.COM" watch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> exposedbydefault = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre><br></li><li>  Run traefik: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/traefik &amp;&amp; docker-compose up -d</code> </pre> <br></li><li>  Add an entry for DOMAIN.COM of the form '*' - IP of the dedicated server. <br></li></ol><br><h3>  Step three: prepare the repository </h3><br><ol><li>  Add the Dockerfile to the root of the repository: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> node:<span class="hljs-number"><span class="hljs-number">8.9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> build-deps WORKDIR /usr/src/app <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> package.json ./ RUN npm i <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> . ./ RUN npm run build <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> nginx:<span class="hljs-number"><span class="hljs-number">1.12</span></span>-alpine <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> <span class="hljs-comment"><span class="hljs-comment">--from=build-deps /usr/src/app/dist /usr/share/nginx/html EXPOSE 80 CMD ["nginx", "-g", "daemon off;"]</span></span></code> </pre><br>  Change <br><br><pre> <code class="bash hljs">npm run build</code> </pre> <br>  on your build team.  Similarly edit the path <br><br><pre> <code class="bash hljs">/usr/src/app/dist</code> </pre> <br>  changing <i>dist</i> to your build directory. <br>  You can read more about the structure and commands of Docherfaye <a href="https://docs.docker.com/engine/reference/builder/">here</a> . <br></li><li>  Add the .gitlab-ci.yml file with the image assembly section: <br><br><pre> <code class="hljs bash">image: docker:stable variables: DOCKER_HOST: tcp://docker:2375/ DOCKER_DRIVER: overlay2 GITLAB_DOMAIN: gitlab.com services: - docker:dind stages: - build build_staging: stage: build script: - <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> GITLAB_DOMAIN=gitlab.com - <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CONTAINER_IMAGE=<span class="hljs-variable"><span class="hljs-variable">$GITLAB_DOMAIN</span></span>/frontend/main/image - docker login -u gitlab-ci-token -p <span class="hljs-variable"><span class="hljs-variable">$CI_BUILD_TOKEN</span></span> <span class="hljs-variable"><span class="hljs-variable">$GITLAB_DOMAIN</span></span> - docker pull <span class="hljs-variable"><span class="hljs-variable">$CONTAINER_IMAGE</span></span>:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> URL=<span class="hljs-string"><span class="hljs-string">"Host:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_NAME}</span></span></span><span class="hljs-string">.tests.DOMAIN.COM"</span></span> - docker build -t <span class="hljs-variable"><span class="hljs-variable">$CONTAINER_IMAGE</span></span>:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span> . --label <span class="hljs-string"><span class="hljs-string">"traefik.backend=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_NAME}</span></span></span><span class="hljs-string">"</span></span> --label <span class="hljs-string"><span class="hljs-string">"traefik.frontend.rule=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${URL}</span></span></span><span class="hljs-string">"</span></span> - docker push <span class="hljs-variable"><span class="hljs-variable">$CONTAINER_IMAGE</span></span>:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span></code> </pre></li><li>  Add the private key <i>deployer@DOMAIN.COM</i> to the repository settings (Settings -&gt; CI / CD -&gt; Variables) as <i>SSH_PRIVATE_KEY</i> </li><li>  Add deploy sections: <br><br><pre> <code class="hljs bash">stages: - build - deploy /// .... deploy_staging: stage: deploy image: kroniak/ssh-client:3.6 script: - mkdir ~/.ssh - <span class="hljs-string"><span class="hljs-string">'[[ -f /.dockerenv ]] &amp;&amp; echo -e "Host *\n\tStrictHostKeyChecking no\n\n" &gt; ~/.ssh/config'</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> $(ssh-agent -s) - ssh-add &lt;(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SSH_PRIVATE_KEY</span></span></span><span class="hljs-string">"</span></span>) - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker login -u gitlab-ci-token -p </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_BUILD_TOKEN</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$GITLAB_DOMAIN</span></span></span><span class="hljs-string">"</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker stop frontend_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker rm frontend_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker rmi GITLAB-DOMAIN.COM/frontend/main/image:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker run --name frontend_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string"> --network=web -d </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$GITLAB_DOMAIN</span></span></span><span class="hljs-string">/frontend/main/image:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> environment: name: review/<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> url: http://<span class="hljs-variable"><span class="hljs-variable">${CI_COMMIT_REF_NAME}</span></span>.tests.DOMAIN.COM on_stop: stop_staging stop_staging: stage: deploy image: kroniak/ssh-client:3.6 variables: GIT_STRATEGY: none script: - mkdir ~/.ssh - <span class="hljs-string"><span class="hljs-string">'[[ -f /.dockerenv ]] &amp;&amp; echo -e "Host *\n\tStrictHostKeyChecking no\n\n" &gt; ~/.ssh/config'</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> $(ssh-agent -s) - ssh-add &lt;(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SSH_PRIVATE_KEY</span></span></span><span class="hljs-string">"</span></span>) - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker login -u gitlab-ci-token -p </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_BUILD_TOKEN</span></span></span><span class="hljs-string"> GITLAB-DOMAIN.COM"</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker stop frontend_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker rm frontend_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> - ssh deployer@DOMAIN.COM <span class="hljs-string"><span class="hljs-string">"docker rmi </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$GITLAB_DOMAIN</span></span></span><span class="hljs-string">/frontend/main/image:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_REF_SLUG}</span></span></span><span class="hljs-string">"</span></span> || <span class="hljs-literal"><span class="hljs-literal">true</span></span> when: manual environment: name: review/<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> action: stop</code> </pre> </li></ol><br>  The above steps are enough to get the following result: <br><br><ul><li>  Each new commit to a branch initiates the assembly and development of the latest actual code at% branch_name% .tests.DOMAIN.COM </li><li>  Gitlab includes an environment mechanism that allows you to create / delete / open closed images in a couple of taps. </li></ul><br>  Next steps: <br><br><ul><li>  Set up a separate section for the wizard builds.  In the case of a master, it is reasonable to tag an image via COMMIT_SHA </li><li>  Add configs to nginx in docker </li><li>  To forward the build parameters of the bundle through the ARG and ENV mechanisms of the dockfile </li><li>  Configure use of cache from image for assemblies </li></ul><br>  <a href="https://thecodingmachine.io/continuous-delivery-on-a-dedicated-server">Based on the article.</a> </div><p>Source: <a href="https://habr.com/ru/post/429824/">https://habr.com/ru/post/429824/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429814/index.html">When Java finally dies, what to do and what will happen to the JPoint</a></li>
<li><a href="../429816/index.html">OpenSceneGraph: build from source and Hello World</a></li>
<li><a href="../429818/index.html">Intel Vision Accelerator - Deep Learning in every home</a></li>
<li><a href="../429820/index.html">HTTP-over-QUIC officially becomes HTTP / 3</a></li>
<li><a href="../429822/index.html">Special Purpose Debug Board</a></li>
<li><a href="../429826/index.html">Wearable "batteries": textile micro-supercondensers based on PEDOT-Cl</a></li>
<li><a href="../429828/index.html">(Not only) freshman: high school.Instruction 2.0</a></li>
<li><a href="../429832/index.html">Translation of Andrew Un's book ‚ÄúPassion for Machine Learning‚Äù Chapter 28 - 29</a></li>
<li><a href="../429834/index.html">Why can a machine play Mario inhumanly good, but not Pokemon?</a></li>
<li><a href="../429836/index.html">Goodbye Electron. Hello Desktop PWA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>