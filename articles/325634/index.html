<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google Benchmark Library</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago I wrote about C ++ libraries for microbenchmarking. I talked about three libraries: Nonius, Hayai and Celero. But in reality, I wanted...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google Benchmark Library</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2a0/e14/4ad/2a0e144ad2c6449fb82b1a6585b6438d.jpg"><br><br>  Not so long ago <a href="http://www.bfilipek.com/2016/01/micro-benchmarking-libraries-for-c.html">I wrote</a> about C ++ libraries for microbenchmarking.  I talked about three libraries: Nonius, Hayai and Celero.  But in reality, I wanted to talk about the fourth.  My Windows then did not support the Google Benchmark library, so I could not test it.  Fortunately, from the comments on the previous post I learned that the library is now available in Visual Studio! <br><br>  Let's see how you can use it. <br><a name="habracut"></a><br><h2>  <font color="#c75733">Library</font> </h2><br>  ‚Üí <a href="https://github.com/google/benchmark">Main github repository</a> <br>  ‚Üí <a href="https://groups.google.com/forum/">Discussion</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thanks to KindDragon: <a href="https://github.com/google/benchmark/commit/9e37d69b23743db226a284ca709a3a89bda30c2d">Support MSVC on appveyor</a> , we can build the library in Visual Studio.  I easily downloaded the latest code from the repository, generated the solution files using CMake and compiled the required version.  To use the library in your project, it remains only to include the library itself and one header file. <br><br><h2>  <font color="#c75733">Simple example</font> </h2><br>  In the original article, I conducted two experiments: <br><br><ul><li> <code>IntToStringConversionTest(count)</code> - converts integers from the range 0 ... count-1 into strings and returns the vector of these strings. </li><li>  <code>DoubleToStringConversionTest(count)</code> - converts 0.12345 ... count-1 + 0.12345 into strings and returns a string vector. </li></ul><br>  An example of benchmarks entirely: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"benchmark/benchmark_api.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../commonTest.h"</span></span></span><span class="hljs-meta"> void IntToString(benchmark::State&amp; state) { while (state.KeepRunning()) { benchmark::DoNotOptimize( IntToStringConversionTest(state.range_x()) ); } } BENCHMARK(IntToString)-&gt;Arg(TEST_NUM_COUNT1000); void DoubleToString(benchmark::State&amp; state) { while (state.KeepRunning()) { benchmark::DoNotOptimize( DoubleToStringConversionTest(state.range_x()) ); } } BENCHMARK(DoubleToString)-&gt;Arg(TEST_NUM_COUNT1000); BENCHMARK_MAIN()</span></span></code> </pre> <br>  Beautiful and simple!  The <code>BENCHMARK</code> macro is used to define the benchmark, then you can add call parameters.  In the example above, I used the <code>Arg</code> method.  The parameter in this method is passed to the state object, which is available to the benchmark function.  In our example, we get this value using <code>state.range_x()</code> .  It is then used as the size of the output row vector. <br><br>  Inside the benchmark function in the while loop, the main code is executed.  The library will automatically select the number of iterations. <br><br>  Typically, an application runs in the console and displays the following result: <br><br><img src="https://habrastorage.org/files/103/bb2/ef1/103bb2ef1f70412a8e876a14fb01d568.png"><br><br>  The conclusion is very simple: the name of the benchmark, the time in nanoseconds (can be changed using the <code>Unit()</code> method), the CPU time, the number of iterations performed. <br><br>  Why is this library so good? <br><br><ul><li>  You can easily change the parameters: Arg, ArgPair, Range, RangePair, Apply. <br><ul><li>  Values ‚Äã‚Äãcan be obtained using <code>state.get_x()</code> , <code>state.get_y()</code> </li><li>  So you can create benchmarks for tasks in one- and two-dimensional space. </li></ul></li><li>  Fixture </li><li>  Measurements in multiple streams </li><li>  Manual time management: useful when code is executed on a GPU or other device where the standard CPU time is not applicable. </li><li>  Output formats: as table, CSV, Json </li><li>  The ability to add your own labels using <code>state.SetLabel()</code> </li><li>  Tags for processed objects and processed bytes, thanks to <code>state.SetItemsProcessed()</code> and <code>state.SetBytesProcessed()</code> </li></ul><br>  This is how the output of the benchmark with bytes per second, objects per second, labels and modified time units looks like. <br><br><img src="https://habrastorage.org/files/dac/9ec/3cd/dac9ec3cdffa4b1e86c1b565a3025ae7.png"><br><br><h2>  <font color="#c75733">Complicated example</font> </h2><br>  In <a href="http://www.bfilipek.com/2016/02/revisiting-old-benchmark-vector-of.html">another post about libraries for micro-benchmarking,</a> I tested the libraries with a slightly more complex example.  This is my usual benchmark - a vector of pointers against the vector of objects.  See if we can implement this example using Google Benchmark. <br><br><h3>  <font color="#c75733">Customization</font> </h3><br>  Here is what we are going to test: <br><br><ul><li>  The class Particle (particle) - contains 18 float attributes: 4 to indicate movement (pos), 4 to designate speed (vel), 4 to accelerate (acceleration), 4 for color (color), 1 for time (time), 1 for rotation (rotation).  We will also have a buffer, also of type float, with a variable number of elements in it. <br><ul><li>  The standard particle is 76 bytes. </li><li>  Increased particle - 160 bytes </li></ul></li><li>  We want to measure the speed of the Update method on the particle vector. </li><li>  We will use five types of containers: <br><ul><li> <code>vector&lt;Particle&gt;</code> </li> <li>  <code>vector&lt;shared_ptr&lt;Particle&gt;&gt;</code> - with randomization in memory </li><li>  <code>vector&lt;shared_ptr&lt;Particle&gt;&gt;</code> - without memory randomization </li><li>  <code>vector&lt;unique_ptr&lt;Particle&gt;&gt;</code> - with randomization in memory </li><li>  <code>vector&lt;unique_ptr&lt;Particle&gt;&gt;</code> - without memory randomization </li></ul></li></ul><br><h3>  <font color="#c75733">Some code</font> </h3><br>  Sample code for <code>vector&lt;Particle&gt;</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Part</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParticlesObjVectorFixture</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ::benchmark::Fixture { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ::benchmark::State&amp; st)</span></span></span><span class="hljs-function"> </span></span>{ particles = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Part&gt;(st.range_x()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;p : particles) p.generate(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ::benchmark::State&amp;)</span></span></span><span class="hljs-function"> </span></span>{ particles.clear(); } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Part&gt; particles; };</code> </pre> <br>  But the benchmark: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> P76Fix = ParticlesObjVectorFixture&lt;Particle&gt;; BENCHMARK_DEFINE_F(P76Fix, Obj)(benchmark::State&amp; state) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (state.KeepRunning()) { UpdateParticlesObj(particles); } } BENCHMARK_REGISTER_F(P76Fix, Obj)-&gt;Apply(CustomArguments); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> P160Fix = ParticlesObjVectorFixture&lt;Particle160&gt;; BENCHMARK_DEFINE_F(P160Fix, Obj)(benchmark::State&amp; state) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (state.KeepRunning()) { UpdateParticlesObj(particles); } } BENCHMARK_REGISTER_F(P160Fix, Obj)-&gt;Apply(CustomArguments);</code> </pre> <br>  With this code, we test two types of particles: small - 76 bytes and more - 160 bytes.  The CustomArguments method generates the number of particles for each iteration of the benchmark: 1k, 3k, 5k, 7k, 9k, 11k. <br><br><h3>  <font color="#c75733">results</font> </h3><br>  In this post we focused on the library itself, but I would like to answer the question I was asked earlier - the question about the different particle sizes.  So far I have used only two types: 76-byte and 160-byte. <br><br>  Results for 76 bytes: <br><br><img src="https://habrastorage.org/files/530/058/70e/53005870e41a4f5e847cf7fa5f55bd63.png"><br><br>  Randomized pointers are almost 76% slower than object vectors. <br><br>  Results for 160 bytes: <br><br><img src="https://habrastorage.org/files/739/332/a58/739332a580794122b169fe6b38af4a8d.png"><br><br>  Almost straight lines in the case of large particles!  Randomized pointers are only 17% slower ...  Well, let them not quite straight :) <br><br>  In addition, we tested and <code>unique_ptr</code> .  As you can see, in terms of update (data access), the speed is almost the same as that of <code>shared_ptr</code> .  Therefore, indirect handling is a smart pointer problem, not an inevitable overhead. <br><br><h2>  <font color="#c75733">Total</font> </h2><br>  <a href="https://github.com/fenbf/benchmarkLibsTest">Repository with code examples</a> <br><br>  I had no difficulty using the Google Benchmark library.  You can learn the basic principles of writing benchmarks in a few minutes.  Multi-threaded benchmarks, fixture, automatic selection of the number of iterations, output in CSV or Json format - that‚Äôs all the basic functions.  Personally, I like most the flexibility of passing parameters to the benchmark code.  The rest of the libraries I checked had problems in order to transfer the parameters of the problem area to the benchmark.  The simplest from this point of view was Celero. <br><br>  It lacks, perhaps, only an expanded display of results.  The library shows us only the average time to perform iterations.  Although in most cases this is enough. <br><br>  From the point of view of the experiment, I obtained interesting results for particles of different sizes.  This can be the basis for a future final test.  I will try to rewrite my examples with a wide variety of object sizes.  I expect to see a huge difference in the results for small objects and a slight one for large ones. <br><br><blockquote><div class="spoiler">  <b class="spoiler_title">Oh, and come to work with us?</b>  <b class="spoiler_title">:)</b> <div class="spoiler_text">  <a href="http://wunderfund.io/"><b>wunderfund.io</b></a> is a young foundation that deals with <a href="https://en.wikipedia.org/wiki/High-frequency_trading">high-frequency algorithmic trading</a> .  High-frequency trading is a continuous competition of the best programmers and mathematicians of the whole world.  By joining us, you will become part of this fascinating fight. <br><br>  We offer interesting and challenging data analysis and low latency tasks for enthusiastic researchers and programmers.  Flexible schedule and no bureaucracy, decisions are quickly made and implemented. <br><br>  Join our team: <a href="http://wunderfund.io/">wunderfund.io</a> </div></div></blockquote></div><p>Source: <a href="https://habr.com/ru/post/325634/">https://habr.com/ru/post/325634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325624/index.html">13 years of bad code in games</a></li>
<li><a href="../325626/index.html">Build a project in python3 & PyQT5 for Windows using PyInstaller</a></li>
<li><a href="../325628/index.html">React Native: another ‚Äúsilver bullet‚Äù for cross-platform development?</a></li>
<li><a href="../325630/index.html">Details that matter</a></li>
<li><a href="../325632/index.html">Second honorary. Notes of the participant of the contest Dstl Satellite Imagery Feature Detection</a></li>
<li><a href="../325636/index.html">StakeOverflow Developer Survey (2017)</a></li>
<li><a href="../325638/index.html">Why do the Russian labor market need women programmers?</a></li>
<li><a href="../325640/index.html">We write the mnemonic editor for SCADA-system on Fabric.js. Part 2</a></li>
<li><a href="../325642/index.html">Top PostgreSQL Development Tools</a></li>
<li><a href="../325644/index.html">We read binary files of iOS-applications. Part 2: Swift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>