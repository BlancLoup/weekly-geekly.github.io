<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>There is no flow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The important truth about asynchrony in its original form: there is no flow. 

 Those who argue, innumerable. ‚ÄúNo,‚Äù they shout, ‚Äúif I am expecting an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>There is no flow</h1><div class="post__text post__text-html js-mediator-article">  The important truth about asynchrony in its original form: there is no flow. <br><br>  Those who argue, innumerable.  ‚ÄúNo,‚Äù they shout, ‚Äúif I am expecting an operation, there must be a flow that is waiting!  Perhaps this is a thread from the pool.  Or the flow of the operating system!  Or something related to the device driver ... " <br><br>  Do not heed these cries.  If the operation is truly asynchronous, then there is no thread. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Skeptics are not convinced.  Let us ridicule them. <br><a name="habracut"></a><br>  We trace the execution of an asynchronous operation down to hardware, paying particular attention to the .NET platform and the device driver.  We will have to simplify this description, omitting some of the details, but we will not go far from the truth. <br><br>  Consider some ‚Äúwrite‚Äù operation (to a file, network stream, USB toaster, anywhere).  Our code is simple: <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data = ... <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> myDevice.WriteAsync(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, data.Length); }</code> </pre> <br><br>  We already know that the UI thread is not blocked while waiting.  Question: Is there another thread that sacrifices itself on the Lock Altar so that the UI thread can live? <br><br>  Hold on.  We will have to dive deep. <br><br>  First stop: library (for example, BCL code).  We assume that WriteAsync is implemented using the standard asynchronous I / O system in the .NET framework, which is based on overlapped I / O *.  So  Win32 starts an overlapped I / O operation specifying the device DISCRIPTOR. <br><br>  The OS, in turn, accesses the device driver and asks it to start a write operation.  This request is an object that describes a write operation;  such an object is called an I / O Request Packet (IRP). <br><br>  The driver receives the IRP packet and instructs the device to start recording data.  If the device supports the direct memory access (DMA) mode, then the execution of the command consists only in writing the buffer address to the device register.  This is all a driver can do;  it marks the IRP packet as ‚Äúrunning‚Äù and returns control to the OS. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f9/a32/5af/5f9a325af3f46bfbcda5d3411e6a09a6.png" alt="image"><br><br>  Here is the point: the device driver is not allowed to block control during the processing of an IRP packet.  This means that if an IRP packet cannot be processed immediately, it must be processed asynchronously.  This is true even for synchronous methods!  At the device driver level, all (non-trivial) requests are asynchronous. <br><br><blockquote>  To quote <a href="http://www.amazon.com/gp/product/0735648735/ref%3Das_li_ss_tl%3Fie%3DUTF8%26camp%3D1789%26creative%3D390957%26creativeASIN%3D0735648735%26linkCode%3Das2%26tag%3Dstepheclearys-20">Tom</a> <a href="http://www.amazon.com/gp/product/0735665877/ref%3Das_li_ss_tl%3Fie%3DUTF8%26camp%3D1789%26creative%3D390957%26creativeASIN%3D0735665877%26linkCode%3Das2%26tag%3Dstepheclearys-20">Wisdom</a> , ‚ÄúRegardless of the type of I / O request, all I / O operations assigned to the driver by the application are performed asynchronously.‚Äù </blockquote><br>  With the IRP packet in the ‚Äúrunning‚Äù status, the OS returns to the library, which returns the unfinished task to the button press handler, which in turn suspends the method execution, and the UI thread continues its execution. <br><br>  We followed the request to the very abyss of the system, up to the physical device. <br><br>  Now the write operation is in progress.  How many threads do it? <br><br>  Not at all. <br><br>  Neither the device driver thread, the OS thread, nor the BCL stream, nor the thread from the pool perform this write operation.  <b>There is no flow.</b> <br><br>  Now let's follow the answer that follows from the possessions of demons back into the mortal world. <br><br>  Some time after the start of the operation, the device ends the recording.  And notifies the processor with an interrupt. <br><br>  The driver interrupt handler is called.  An interrupt is a processor level event, so any work that the processor was busy with is temporarily suspended, regardless of which thread was currently running.  It can be considered that the interrupt handler ‚Äúlends‚Äù the executing thread, however, I am of the opinion that interrupt handlers are executed at such a low level that the concept of ‚Äúflow‚Äù does not exist;  they are executed "under" all threads, so to speak. <br><br>  If the interrupt handler is written correctly, then all it does is tell the device ‚ÄúThank you for the interrupt‚Äù and put the Deferred Procedure Call (DPC) object in the queue. <br><br>  When the processor finishes processing interrupts, it proceeds to deferred procedure calls.  They are also performed at such a low level, that speaking about ‚Äústreams‚Äù is not entirely correct;  Like interrupt handlers, deferred procedure calls are executed directly on the CPU, ‚Äúunder‚Äù the flow control system. <br><br>  DPC takes an IRP packet, which is a write request, and marks it as ‚Äúcompleted.‚Äù  However, this status exists only at the operating system level;  The process has its own address space, and it also needs to be notified.  Therefore, the OS creates a special kernel-level asynchronous procedure call (APC) object and places it in the queue of the thread that owns the DISCRIPTOR. <br><br>  Since the / BCL library uses the standard overlapped I / O mechanism, it has already bound the handle to the I / O Completion Port, which is part of the thread pool.  Therefore, to perform APC, a stream from the I / O thread pool ** is used, which notifies the task that it has been completed. <br><br>  As the task captures the UI context, the asynchronous method resumes its execution not in the thread of the pool.  Instead, the continuation of the method is queued for execution in the UI context, and the UI context resumes execution of the method when it reaches it. <br><br>  So we see that while the operation was performed, there was no flow.  When the operation was completed, different threads were used to quickly perform various tasks.  The execution time of such tasks is from a millisecond (for example, performing APC in a pool thread) to a microsecond (for example, interrupt processing).  But no thread was blocked waiting for the operation to complete. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ee6/c3e/416/ee6c3e4167be0563101b5606b2365149.png" alt="image"><br><br>  The chain of execution that we have traced is ‚Äústandard‚Äù, somewhat simplified.  There are countless variations, but the essence remains the same. <br><br>  The idea that "somewhere there must be a thread performing an asynchronous operation" is erroneous. <br><br>  Free your mind.  Do not try to find this "asynchronous stream" - it is impossible.  Instead, be aware of the truth: <br><br>  <b>There is no flow.</b> <br><br><hr><br>  * - I did not see an unambiguous translation into Russian of the term ‚Äúoverlapped I / O‚Äù.  The term ‚Äúasynchronous I / O‚Äù is close in meaning. <br>  ** - there are two thread pools in the CLR: a pool of worker threads and a pool of input / output streams (approx. Lane). </div><p>Source: <a href="https://habr.com/ru/post/216659/">https://habr.com/ru/post/216659/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216641/index.html">Quick javascript gzip for browser and node.js</a></li>
<li><a href="../216647/index.html">The future is behind modular electronics: Mighty Cast NEX Band</a></li>
<li><a href="../216649/index.html">Microsoft accounts to the FBI: the corporation receives money for each official request of the special services to disclose user information</a></li>
<li><a href="../216653/index.html">Get acquainted! Appnestic - a new generation hosting platform</a></li>
<li><a href="../216655/index.html">The history of PCI - on the road to a brighter future drives</a></li>
<li><a href="../216663/index.html">HERE space odyssey or how our employees spend their weekends</a></li>
<li><a href="../216665/index.html">Finite and infinite in mathematics. Lecture by Pavel Kozhevnikov for high school students in Yandex</a></li>
<li><a href="../216667/index.html">IntelliJ IDEA 13.1: Spring Update</a></li>
<li><a href="../216669/index.html">Pop-up tags in forms on pure CSS</a></li>
<li><a href="../216671/index.html">Commenting systems and pitfalls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>