<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I prosthetics UPS indicator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the late 90s I had a UPS. Beautiful, with an LED indicator and a bunch of buttons, had two batteries inside and could support the life of my comput...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I prosthetics UPS indicator</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/4f0/b42/8eb/4f0b428ebdd6405db46834adaf3a9543.jpg" alt="in the process of debugging"><br><br>  In the late 90s I had a UPS.  Beautiful, with an LED indicator and a bunch of buttons, had two batteries inside and could support the life of my computer then (with the monitor!) For as much as 15 minutes.  The times in Kamchatka were then hard, the lights were turned off regularly, so this device was very helpful.  I went through with him the entire energy crisis, and more than once he saved my coursework from the sudden loss of electricity.  And yet, it was possible to connect a tape recorder to it and, by candlelight, listen to the radio or your favorite tapes, preparing dinner for yourself on a portable gas stove ... <br><a name="habracut"></a><br>  Naturally, UPS broke down.  The first time his transformer burned down.  Not the one that is big and stands in the inverter, but some small one, probably, for measuring the voltage in the network.  Not finding the same factory one, I set up a self-made one, and the device worked for some time.  Then stopped.  For a long, long time, I could not find the reason.  We had to unsolder different parts, check them for operability and solder them back.  The problem was not.  The gutted device lained under the bed for a couple of years, until one fine day I had the idea to apply 5 volts directly to the controller.  And lo and behold: there was a squeak of the built-in speaker and numbers appeared on the LED indicator.  He was alive!  Next - a matter of technology: I walked along the power supply circuit with a voltmeter and found out that a fuse was soldered on the board, which looked like a resistor in a brazen manner!  The fuse (burnt out naturally) was replaced and the UPS came to life. <br><br>  Unfortunately, my repair and two years under the bed did not pass for the device for nothing.  Somehow, in an incomprehensible way, the port burned in the controller, which was responsible for the glow of the green On-Line LED and the lowest segment of all digital segment indicators.  There is nothing you can do - I had to accept.  After a while I left Kamchatka and our paths diverged. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Years passed and, arriving to visit my parents, in the far corner I found my favorite bespereboynik: abandoned, dirty, without batteries and rubber feet.  By that time, I had already acquired my own housing in another city, so it was decided to take the device to my place, restore its working capacity and use it for its intended purpose. <br><br>  <b>Task</b> <br><br>  First of all, the UPS was washed and dried.  Then, in a certain shop of radio components, suitable rubber feet and new batteries were bought.  Much to his surprise, a suitable transformer was found in the same store, instead of my homemade products.  A couple of days of work, and washed, updated bespereboynik joyfully squeaked and began to charge their new batteries.  Everything was good, but the indicator was still not working. <br><br>  The idea to fix it came to me before.  Having drawn all the numbers (and some letters) of the seven segment indicator on a notebook sheet, I realized that it is possible to determine the state of the lowest segment by the state of the others.  The green LED can be turned on when other LEDs are off.  There were a lot of thoughts about how this could be done: from a simple ROM chip to a simple FPGA.  But, since I was a student and lived in Kamchatka, I did not have the opportunity to acquire something more complicated than small logic.  Indicator repair was postponed. <br><br><img src="https://habrastorage.org/files/0d1/175/f43/0d1175f43d72446383ebd4f0dcb687db.jpg" alt="draw segments"><br><br>  This time I decided to tackle the problem seriously.  Rummaging in the bins, I again did not find any ROM, or FPGA and any CPLD.  On the other hand, the Arduino Pro Mini, or rather, its cheap Chinese clone with Ali Express, came under the arms.  I bought Arduin in order to make a mini-computer based on a WiFi SD card from Transcend.  Unfortunately, the card died during the experiments, and the board with the microcontroller was left idle.  Nothing, we found her a new task! <br><br>  <b>Job</b> <br><br>  Dynamic indication is implemented in the display module: the segment signals are common to all four indicators so that only one of them is lit at a time.  Moreover: as though the fifth indicator also connected three LEDs.  Five selection signals allow you to specify which indicator (or LED strip) is being used now.  These selection signals are successively scanned at a fairly high speed and, due to the inertia of vision, it seems that all indicators are lit at the same time. <br><br>  At first, I wanted to get away with the simplest solution: an ordinary cycle that checks signals from six working segments, and turns the non-working seventh on or off.  In fact, this is just an emulation of the ROM, about which I thought at the very beginning. <br><br>  To do this, I had to connect six working segment to the input of the microcontroller, and a non-working segment - to the output. <br><br>  Sketching a small array that matched the various states of the inputs with the output and the loop that bypasses this array, I loaded everything into the controller and immediately got a problem: the bottom segment was always lit.  The first thought: a cant in the program.  However, no matter how I looked at the code, no errors were found.  In the end, it came to be understood that my cycle was not synchronized with the switching of indicators.  If we read the state of the segments at the end of the cycle of selecting one indicator, then it is likely that we will light or extinguish the lower segment of the next one.  Disorder. <br><br>  Without thinking twice, I soldered five indicator selection signals to the remaining free inputs of the Arduino, configured them to generate an interrupt, and began to use an interrupt handler instead of a loop.  It became better, but did not solve the problem.  In the right places, the segment was burning as it should, but in those places where it should have been extinguished, there was not a bright residual glow. <br><br>  After thinking for some time, I decided that this effect can occur if the search cycle in the array of the desired state for the segments takes longer than the indicator burning time.  In this case, we also get out of our phase and manage the segment of the next indicator.  It is necessary that between the time of receiving the interrupt from the select signal to the segment control command, as little time as possible should pass.  It was possible to do this only in one way: make the code that makes a decision about the state of the segment from the interrupt handler, run it in the main loop with the lowest priority, and save the result in a certain global buffer.  The interrupt handler will only have to read the value of their global buffer and quench or ignite a segment, depending on its contents.  In the worst case, we can only be late with a change in the state of a segment in a certain indicator, but no longer climb on the next one. <br><br>  That was the right decision.  But finally everything worked only after I synchronized the decision-making cycle with an interruption using a spin-lock and disallowed the processing of the interruption during the operation of this cycle.  And it not just earned, but earned as it should! <br><br>  There was another problem with the indicators: most of the time they showed only numbers.  However, after turning on the UPS, a testing process was launched, during which, in addition to numbers, two more words appeared: TEST and PASS.  And if the letters T, E and P could simply be added to the array of valid characters, and S was similar to 5, then the letter A did not differ from the figure of eight, from the point of view of my program.  The decision loop simply found the corresponding pattern in the array and finished drawing the lower segment.  It was necessary to think of something to avoid it. <br><br>  And I thought up.  At the time of the arrival of a signal about a change of indicator, it is necessary to determine which indicator it belongs to and save the state of its segments into a variable specially assigned to it.  Now, at any time, I can accurately determine the current content of all four indicators at once.  And if on the first, third and fourth symbols P, 5 and 5 are displayed, respectively, then the second symbol is definitely A, and there is no need to light the lower segment.  Just in case, I also added the processing of the word FAIL, which I have never seen, but the possibility of its appearance. <br><br>  Everything, with the digital indicator is over.  It remains only to fix the green LED "On-Line".  But then a surprise was waiting for me ... The idea was this: the green LED (On-Line) always lights up alone.  If the yellow (Battery) or red (Low Battery) LEDs are lit, the green should not be lit.  Thus, we solder the wires from these LEDs to the microcontroller, set a simple if () with a logical ‚ÄúOR‚Äù and everything should work.  But it turned out that when the yellow LED is on, it actually does not light up permanently, but flashes quickly.  Quickly, but not enough, if () missed it and did not light the green LED.  It turned out that when working from the network, the green LED lights up in a hollow brightness, but when switching to the battery, it burned at half the brightness, but still it burned.  Well, not a problem, I thought, I will put a simple low-pass filter: I will cut off all the fast blinks, but leave only the slow ones that correspond to switching to the battery and back.  The analysis of the flashing time of the yellow LED brought the following surprise: the period of impulses that are fed to it is very unstable and can reach quite large values.  It turned out that the filter should pass signals no higher than 0.5-1 Hz.  This is not very good, because we get a rather large delay in changing the On-Line signal, but it is quite tolerable. <br><br>  I decided to make the filter very simple.  We are 50 times, at equal intervals of time, monitor the status of yellow and red LEDs.  If one of them is lit, then increase the special counter by one.  Then, we check the value of the counter, and if the control LEDs are lit for 50% of the time being checked, then we consider that it is on, and if it is less, then it is off.  In the process of debugging, we had to reduce this figure to 10%.  Why - did not understand. <br><br><img src="https://habrastorage.org/files/88e/bd5/51b/88ebd551ba62430ba32362657836bd94.jpg" alt="final assembly"><br><br>  And it all worked!  It only remained to beautifully mount the Arduino board in the UPS with a double-sided tape and a glue gun. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Elb8pT4lWlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  For the curious: <br><div class="spoiler">  <b class="spoiler_title">the resulting code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; #include &lt;avr/io.h&gt; #include &lt;avr/interrupt.h&gt; #define AVG_TIME 50 #define THS_TIME 45 #define SD_SEG_A _BV(0) #define SD_SEG_B _BV(1) #define SD_SEG_C _BV(2) #define SD_SEG_D _BV(3) #define SD_SEG_E _BV(4) #define SD_SEG_F _BV(5) #define SD_SEG_G _BV(6) #define SD_LED_RED SD_SEG_A #define SD_LED_YLW SD_SEG_C #define LD_SEL_LED _BV(0) #define LD_SEL_1 _BV(1) #define LD_SEL_2 _BV(2) #define LD_SEL_3 _BV(3) #define LD_SEL_4 _BV(4) #define GET_SEL (PINC &amp; 0x1f) #define SD_SYM_NONE (0) #define SD_SYM_0 (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F) #define SD_SYM_1 (SD_SEG_B | SD_SEG_C) #define SD_SYM_2 (SD_SEG_A | SD_SEG_B | SD_SEG_D | SD_SEG_E | SD_SEG_G) #define SD_SYM_3 (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_G) #define SD_SYM_4 (SD_SEG_B | SD_SEG_C | SD_SEG_F | SD_SEG_G) #define SD_SYM_5 (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G) #define SD_SYM_6 (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G) #define SD_SYM_7 (SD_SEG_A | SD_SEG_B | SD_SEG_C) #define SD_SYM_8 (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G) #define SD_SYM_9 (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G) #define SD_SYM_E (SD_SEG_A | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G) #define SD_SYM_P (SD_SEG_A | SD_SEG_B | SD_SEG_E | SD_SEG_F | SD_SEG_G) #define SD_SYM_T (SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G) #define GET_SYM (~PIND &amp; 0x7f) #define BROKEN_SEG (SD_SEG_D) static uint8_t sd_symbols[] = { // list of known symbols SD_SYM_NONE, SD_SYM_0, SD_SYM_1, SD_SYM_2, SD_SYM_3, SD_SYM_4, SD_SYM_5, SD_SYM_6, SD_SYM_7, SD_SYM_8, SD_SYM_9, SD_SYM_E, SD_SYM_P, SD_SYM_T }; volatile static uint8_t sel, symbol; // current input signals volatile static short fb0, fb1, fb2, fb3, fb4; // display frame buffer // display routine ISR(PCINT1_vect) { sel = GET_SEL; symbol = GET_SYM; if (((sel &amp; LD_SEL_LED) &amp;&amp; fb0) || ((sel &amp; LD_SEL_1) &amp;&amp; fb1) || ((sel &amp; LD_SEL_2) &amp;&amp; fb2) || ((sel &amp; LD_SEL_3) &amp;&amp; fb3) || ((sel &amp; LD_SEL_4) &amp;&amp; fb4)){ PORTD &amp;= ~BROKEN_SEG; } else { PORTD |= BROKEN_SEG; } } // // entry point // int main(void) { int cur_time; int led_on_time; uint8_t last_symbol_1, last_symbol_2, last_symbol_3, last_symbol_4; int i; // setup GPIO ports DDRC = 0; DDRD = BROKEN_SEG; // setup pin change interrupt PCICR |= _BV(PCIE1); PCMSK1 |= _BV(PCINT8) | _BV(PCINT9) | _BV(PCINT10) | _BV(PCINT11) | _BV(PCINT12); cur_time = 0; led_on_time = 0; last_symbol_1 = last_symbol_2 = last_symbol_3 = last_symbol_4 = 0; fb0 = fb1 = fb2 = fb3 = fb4 = 0; while(1) { // sync with display strobe sei(); while (sel == 0) {} cli(); // if select one of segment indicator if (sel &amp; (LD_SEL_1 | LD_SEL_2 | LD_SEL_3 | LD_SEL_4)) { // looking for displayed symbol for (i = 0; i &lt; 14; i++) { uint8_t sd_symbol = sd_symbols[i]; if ((symbol &amp; ~BROKEN_SEG) == (sd_symbol &amp; ~BROKEN_SEG)) { short val; if (sd_symbol &amp; BROKEN_SEG) { val = 1; } else { val = 0; } if (sel &amp; LD_SEL_1) { last_symbol_1 = sd_symbol; fb1 = val; } else if (sel &amp; LD_SEL_2) { last_symbol_2 = sd_symbol; fb2 = val; } else if (sel &amp; LD_SEL_3) { last_symbol_3 = sd_symbol; fb3 = val; } else if (sel &amp; LD_SEL_4) { last_symbol_4 = sd_symbol; fb4 = val; } // PASS workaround if ((last_symbol_1 == SD_SYM_P) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp; (last_symbol_3 == SD_SYM_5) &amp;&amp; (last_symbol_4 == SD_SYM_5)) { fb2 = 0; } // FAIL workaround else if ((last_symbol_1 == SD_SYM_E) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp; (last_symbol_3 == SD_SYM_1) &amp;&amp; (last_symbol_4 == SD_SYM_1)) { fb1 = 0; fb2 = 0; fb4 = 1; } break; } } } // if select LED line else if (sel &amp; LD_SEL_LED) { if (cur_time++ &gt; AVG_TIME) { if (led_on_time &lt; THS_TIME) { fb0 = 0; } else { fb0 = 1; } cur_time = 0; led_on_time = 0; } else { if ((symbol &amp; (SD_LED_RED | SD_LED_YLW)) == 0) { led_on_time++; } } } // reset sync flag sel = 0; } return 0; }</span></span></span></span></code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/397697/">https://habr.com/ru/post/397697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../397687/index.html">Some laptops with Windows 10 can not be installed Linux</a></li>
<li><a href="../397689/index.html">Why do we feel busy all the time?</a></li>
<li><a href="../397691/index.html">Buy as PRO, bro</a></li>
<li><a href="../397693/index.html">Scientists for the first time made a 3D-model of the brain Drosophila</a></li>
<li><a href="../397695/index.html">What is plasticizers and what they eat</a></li>
<li><a href="../397699/index.html">The use of calligraphy and other educational myths</a></li>
<li><a href="../397701/index.html">Video card named after me: how to become a professional overclocker</a></li>
<li><a href="../397703/index.html">Winners of the Nobel Prize 2016</a></li>
<li><a href="../397705/index.html">Lithium-ion and lithium-polymer batteries: marketing tricks and common mistakes</a></li>
<li><a href="../397707/index.html">Amazing cerebellum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>