<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analyzing HTTP traffic with Mitmproxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the practice of a web developer, situations often arise when it is necessary to track and analyze the traffic of applications communicating with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analyzing HTTP traffic with Mitmproxy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6ad/c8d/355/6adc8d35564a0044d1cec9e225f38794.png" alt="mitmproxy" width="100%" height="100%"><br><br>  In the practice of a web developer, situations often arise when it is necessary to track and analyze the traffic of applications communicating with the server using the HTTP protocol (for example, testing applications for mobile devices or the HTTP API). <br><br>  The tools traditionally used to listen to traffic (tshark, about which we <a href="http://blog.selectel.ru/analiz-setevogo-trafika-na-servere-pri-pomoshhi-tshark/">have already written</a> , as well as ngrep and tcpdump) are poorly suited for this purpose: their functionality for working with the HTTP protocol is limited. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There is a more specialized, simple and effective solution for analyzing HTTP traffic.  Meet: <a href="http://mitmproxy.org/" rel="nofollow">mitmproxy</a> .  There are almost no detailed publications about it in Russian.  In this article we will share our experience with mitmproxy and hope that you will find it useful. <br><a name="habracut"></a><br><br><h2>  general information </h2><br><br>  Mitmproxy is a whole set of software tools, which includes: <br><ul><li>  mitmproxy itself is an interactive console program that intercepts traffic ‚Äúon the fly‚Äù; </li><li>  <a href="http://mitmproxy.org/doc/mitmdump.html" rel="nofollow">mitmdump</a> is a utility that can be described as an analogue of tcpdump for the HTTP protocol: it intercepts traffic and saves all the information about it into a text file; </li><li>  <a href="http://mitmproxy.org/doc/scripting/libmproxy.html" rel="nofollow">libmproxy</a> is a Python library that implements all the mitmproxy functionality. </li></ul><br><br>  The very name mitmproxy comes from the abbreviation MITM, which means man in the middle, or "man in the middle."  This is the name of the method of compromising a communication channel, in which a hacker connects to a transmission channel between two contractors and intervenes in the transmission protocol, viewing, deleting and distorting information.  mitmproxy works in a similar way: it is used as a proxy server, registering all HTTP traffic.  Like any proxy server, in some cases mitmproxy can modify both user requests and responses to them. <br>  Consider the principles and features of mitmproxy in more detail. <br><br><h2>  How it works </h2><br><br>  In the case of unencrypted HTTP connections, everything is simple: mitmproxy accepts a connection from a client (for example, from a browser on a mobile device), displays information about it on the console (or saves it to a text file), and then returns a response from the recipient to the client. <br><br>  Mitmproxy can also be used to intercept protected HTTPS traffic.  When running mitmproxy or mitmdump, a set of CA files is created in the ~ / .mitmproxy directory, based on which substitute certificates are generated.  Naturally, the browser will identify these certificates as suspicious, giving a warning on every attempt to establish an SSL connection using mitmproxy. <br><br>  To prevent this warning, you can add a certificate from mitmproxy to the list of certificates used by the browser (detailed instructions are available <a href="http://mitmproxy.org/doc/ssl.html" rel="nofollow">here</a> ). <br>  When these two conditions are met, the client concludes that the connection being established is secure. <br><br>  Mitmproxy can intercept and secure HTTPS traffic.  The interception procedure consists of the following steps: <br><br><ol><li>  The client establishes a connection with mitmproxy. </li><li>  Mitmproxy sends a response code 200 to the client (connection established). </li><li>  The client interacts with mitmproxy in the same way as with a remote server and establishes an SSL connection.  To specify a host name, it uses SNI. </li><li>  Mitmproxy connects to the server and establishes an SSL connection using the hostname specified by the client. </li><li>  In response, the server sends an SSL certificate containing the values ‚Äã‚Äãof the CN and SAN parameters, on the basis of which a substitute certificate will then be created. </li><li>  Mitmproxy generates a spoof certificate and continues the SSL conversation with the client, suspended in step 3. </li><li>  The client sends the request via the established SSL connection. </li><li>  Mitmproxy sends the request to the server over the SSL connection established in step 4. </li></ol><br><br>  More clearly, the process of intercepting protected traffic can be represented as the following graphic scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b2/1e0/070/5b21e0070ccfd79b61dd4fea77699f69.png" alt="mitmproxy" width="100%" height="100%"><br><br><h2>  Why do you need it </h2><br><br>  The name mitmproxy comes from the name of one of the most common types of attacks.  Even the official documentation for the product is replete with words such as "attack", "interception" and the like.  All this suggests that this tool can act as a tool for hacking.  Of course, mitmproxy (like all products with a similar set of functions - the so-called sniffers) may well be used for illegal purposes, but for obvious reasons we will not discuss this and focus on the legal use cases. <br><br>  Mitmproxy can be used, firstly, to test and debug web applications.  With it, you can get detailed information about what requests the application makes and what answers it receives.  Also mitproxy can help in studying the features of the functioning of some REST API, especially poorly documented and using closed (and often very suspicious) technologies. <br><br>  Secondly, Mitmproxy can work in <a href="http://mitmproxy.org/doc/transparent.html" rel="nofollow">transparent proxy</a> mode <a href="http://mitmproxy.org/doc/transparent.html" rel="nofollow">with traffic interception</a> , which means that it can be used to analyze the network activity of suspicious applications. <br><br><h2>  Testing Mitmproxy </h2><br><br><h3>  Installation </h3><br><br>  Today, mitmproxy is included in the linux repositories and can be installed using the standard package manager: <br><br><pre> $ sudo aptitude install mitmproxy
</pre><br><br>  You can also install it in other ways: <br><br><pre> $ pip install mitmproxy
</pre><br><br>  or <br><br><pre> $ easy_install mitmproxy
</pre><br><br><h3>  First start </h3><br><br>  Let's look at specific examples of how mitmproxy works.  Open the browser (in our case, it‚Äôs Firefox) in the settings (Settings menu ‚Üí Network ‚Üí Connection) and in the Manual proxy service settings section, specify the machine on which mitmproxy is installed as a proxy server. <br><br>  Now connect to the server where mitmproxy is installed, via ssh and execute the following command: <br><br><pre> $ mitmproxy
</pre><br>  The console then looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/582/09f/4fe/58209f4feea045e253a30eae8900d842.png" alt="mitmproxy" width="100%" height="100%"><br><br>  To exit this mode, press the q key.  You can get help by pressing the key combination that indicates the question mark (?). <br><br>  Now open any site in the browser - for example, ya.ru.  All requests to this site will be displayed on the console: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/791/f8a/bc4/791f8abc4dec448456a71538c1be8135.png" alt="mitmproxy" width="100%" height="100%"><br><br>  You can navigate through the list of requests by clicking on the arrow keys.  You can return to the main window by pressing the q key.  To view detailed information about a particular request, you need to move the cursor to it and press the Enter key: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/295/ffa/73b/295ffa73bec8b11c319b8afbf5ba8c22.png" alt="mitmproxy" width="100%" height="100%"><br><br>  The Request field displays detailed information about the request (the requested host, the software with which the request was made, the transmitted headers), and the Response field displays information about the response received. <br><br>  You can switch between these fields using the Tab key.  You can return to the request list by pressing the q key. <br><br>  Requests and responses can be modified.  To do this, use the so-called interception filters.  To enter a filter, you need to press the i key.  We introduce as a filter, for example, ya.ru All requests containing this address will be intercepted.  The intercepted requests in the list will be highlighted in orange: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/03e/494/371/03e494371123d697425dc629944b154e.png" alt="mitmproxy" width="100%" height="100%"><br><br>  Such requests will not be processed unless we accept them.  To accept the request, you need to move the cursor to it and press the a key, and to accept all intercepted requests, press the A key. <br><br>  More detailed information about the request can be viewed by moving the cursor to it and pressing the E key (E is the first letter in the English word event - ‚Äúevent‚Äù).  The event log that occurred during the processing of this request will be opened: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3c2/fa6/7ad/3c2fa67ad77af80cd4360d8ed0dfa5bf.png" alt="mitmproxy" height="100%"><br><br>  Both requests and responses can be edited.  The editing function can be useful when testing: you can, for example, simulate a specific situation and see how the application will behave when it receives a certain response from the server. <br><br>  Let's move the cursor to the query that interests us, move the cursor to it and press the Enter key.  Then move the cursor to the Request field and press the E key (the first letter in the word edit is edit).  The edit menu will appear at the bottom of the console: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/732/f0d/cb3/732f0dcb38db816fdc9ab69545bbc4bd.png" alt="mitmrpoxy" width="100%" height="100%"><br><br>  You can change both the entire query (the Q key) and its individual parameters: the path (the P key), the URL (U), the header (H), the form (F), the body ¬Æ and the method (M). <br><br>  The answer is edited in the same way.  You can edit its code (C key), message (M), headers (H) and body ¬Æ. <br><br><h2>  Additional functions </h2><br><br><h3>  Proxy Authentication </h3><br><br>  In mitmproxy, you can activate user authentication mode before using a proxy.  Authentication headers are removed from requests and are not transferred to upstream servers.  Currently, only basic HTTP authentication is supported.  Authentication configuration is performed using the following options: <br><pre> # ban anonymous users from using proxy
 $ mitmproxy --nonanonymous 

 # allow only specified user to use proxy
 $ mitmrpoxy --singleuser &lt;username&gt; 

 # allow proxy usage only when entering one of the passwords specified in the file;
 $ mitmproxy ‚Äîhtpasswd &lt;password file path&gt;
</pre><br><br><h2>  Binding cookies </h2><br><br>  The cookie binding function (sticky cookies) is useful when working with services that require authorization.  It is enough to log in to this service once, and mitmproxy will automatically add the appropriate cookie to each request.  After that, all requests will be transmitted to the server without re-authorization. <br><br>  Cookie mode is activated as follows: <br><pre> $ mitmproxy -t &lt;filter&gt;
</pre><br><br>  You can also add authorization headers to all proxied requests.  Use the -u option for this. <br><br><h3>  Reverse proxy mode </h3><br><br>  In this mode, all requests are sent to the upstream server.  Mitmproxy in this case can be used as a temporary layer, observing and intercepting requests. <br>  The reverse proxy mode is activated using the command: <br><pre> $ mitmproxy -P http [s]: // hostname [: port]
</pre><br><br><h3>  Anticache function </h3><br><br>  Mitmproxy can remove if-modified-since and if-none-match headers from a request.  Because of this, you can always view the full response from the server, even if the browser reports that the requested document is in the cache. <br><br>  This feature is activated with the following command: <br><br><pre> $ mitmproxy - anticache 
</pre><br><br><h2>  Replay client requests </h2><br><br>  The client side replay feature allows you to play queries from previously saved HTTP conversations.  Requests are executed one after another: sending one request, mitmproxy waits for a response from the server, and only then proceeds to the next.  Therefore, the client's behavior may differ from that recorded in the saved dialog, in which some requests could be executed simultaneously. <br><br>  You can play client requests using the command: <br><br><pre> $ mitmproxy -c &lt;path to saved dialog&gt;
</pre><br><br><h2>  Mitmdump </h2><br><br>  As mentioned above, Mitmdump is a utility that works just like tcpdump, only for the HTTP protocol.  It intercepts all HTTP traffic and writes information about it into a separate text file. <br><br>  To get started with mitmdump, you need to start mitmproxy in proxy mode, and then run the following command: <br><br><pre> $ mitmdump -w &lt;filename&gt;
</pre><br>  Saved information can be filtered using regular expressions and then saved to a new file: <br><pre> $ mitmdump -nr &lt;file1&gt; -w &lt;file2&gt; "~ m post"
</pre><br><br>  In the above example, mitmdump selects from the file 1 requests that meet a specific criterion (in our case, POST requests), and writes them to file 2. <br><br>  Mitmdump can read already saved information about client requests from a file, replay these requests again, and save the results to a new file: <br><pre> $ mitmdump -nc &lt;file 1&gt; -w &lt;file 2&gt;
</pre><br>  This feature may be useful when testing some web applications. <br><br>
<h2>  Conclusion </h2><br><br>  In this article, we gave a brief overview of the capabilities of mitmproxy.  For those who want to learn more, here are some links: <br><br><ul><li>  <a href="http://mitmproxy.org/doc/index.html" rel="nofollow">official mitmproxy documentation</a> ; </li><li>  <a href="https-traffic-of-your-phone/" rel="nofollow">an article about tracking mobile application traffic</a> ; </li><li>  <a href="http://corte.si/%252Fposts/code/mitmproxy/howitworks/index.html">A description of how Mitmproxy works by the developer is Aldo Cortesi</a> . </li></ul><br>  Readers who for one reason or another are not able to leave comments here are invited <a href="http-trafika-s-mitmproxy/">to our blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/242727/">https://habr.com/ru/post/242727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242709/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ133 (November 3 - 9, 2014)</a></li>
<li><a href="../242711/index.html">Polytech 2.0: First chips!</a></li>
<li><a href="../242713/index.html">Runner under iOS with five characters</a></li>
<li><a href="../242715/index.html">Blade syntax extension</a></li>
<li><a href="../242725/index.html">Automatic connection of network multifunction devices with the ability to scan [Part 2]</a></li>
<li><a href="../242729/index.html">Configuring Ruby Module</a></li>
<li><a href="../242731/index.html">Low cost, small, networked computers - a small overview</a></li>
<li><a href="../242739/index.html">Power Raspberry Pi using Arduino</a></li>
<li><a href="../242741/index.html">Open vSwitch as a virtual network core</a></li>
<li><a href="../242743/index.html">Paul Graham: An Illogical Startup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>