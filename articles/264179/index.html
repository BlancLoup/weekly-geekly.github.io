<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a bot for Tox messenger</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Against the background of the general enthusiasm for creating bots for Telegram, I would like to tell you about the API of the not very well-known mes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a bot for Tox messenger</h1><div class="post__text post__text-html js-mediator-article">  Against the background of the general enthusiasm for creating bots for Telegram, I would like to tell you about the API of the not very well-known messenger Tox and show with the example of a simple echo-bot how you can easily and quickly create your own. <br><br><img src="https://habrastorage.org/files/076/382/78c/07638278cf8b4503a161e1cb6aae49df.png" alt="image"><br><br><a name="habracut"></a><br><h1>  Introduction </h1><br>  The Tox kernel ( <a href="https://github.com/irungentoo/toxcore">toxcore on github</a> ) consists of three parts: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>ToxCore</b> - in fact, the kernel itself, which allows you to manage contacts, messages, files, avatars, statuses and group chats. </li><li>  <b>ToxAV</b> - voice and video call subsystem. </li><li>  <b>ToxDNS</b> is a subsystem for obtaining ToxID from a human-readable address (approximate equivalent of email or JabberID) via a DNS query. </li></ul><br>  The contact unit is <b><abbr title="Typical ToxID View: 11095C9A5249ACC78792FB822E5712A4470ACF6A89564701860E6C179BD398625936729A77CD">ToxID</abbr></b> (aka ‚Äúaddress‚Äù in terms of API) - a hexadecimal string 76 characters long that encodes: <br><br><ul><li>  Public key (32 bytes or 64 characters). </li><li>  Anti-spam protection "nospam" (4 bytes or 8 characters) is a random data set, changing which allows you to continue to support previously authorized contacts, but ignore requests from new ones. </li><li>  Checksum (2 bytes or 4 characters) - XOR operation on the public key and the value of "nospam", serves to quickly check the correctness of ToxID. </li></ul><br>  The general cycle of working with Tox API can be presented sequentially in the form: <br><br><ol><li>  Initialization of the kernel ( <b>tox_new</b> ) - installation of protocols (IPv4 / IPv6, UDP / TCP), proxy settings (HTTP / SOCKS5), ranges of ports used and (if available) loading of the previously saved state with the list of contacts. </li><li>  Setting callback functions for event handling ( <b>tox_callback_ *</b> ) - event handlers are called from the main loop (4) and they usually contain the main logic of the application. </li><li>  Connect to one or more DHT nodes ( <b>tox_bootstrap</b> ). </li><li>  The main work cycle ( <b>tox_iterate</b> ) and event handling. </li><li>  Pause <b>tox_iteration_interval</b> and return to the previous step. </li></ol><br>  Since  The main way to get knowledge of how Tox API works is to read the source code (written in C), to simplify the following, I will use the python wrapper ( <a href="https://github.com/abbat/pytoxcore">pytoxcore on github</a> ).  For those who do not wish to engage in self-build libraries from source, there are also links to ready-made binary packages for common distributions. <br><br>  When using python wrappers, you can get library help in the following way: <br><br><pre><code class="python hljs">$ python &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytoxcore <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ToxCore &gt;&gt;&gt; help(ToxCore) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToxCore</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToxCore</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> ... | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tox_add_tcp_relay</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(...)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tox_add_tcp_relay</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(address, port, public_key)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Adds</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">additional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">:</span></span>port pair <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCP relay. | This function can be used to initiate TCP connections to different ports on the same bootstrap node, <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> to add TCP relays without using them <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bootstrap nodes. | | tox_bootstrap(...) | tox_bootstrap(address, port, public_key) | Sends a <span class="hljs-string"><span class="hljs-string">"get nodes"</span></span> request to the given bootstrap node <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> IP, port, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> public key to setup connections. | This function will attempt to connect to the node using UDP. You must use this function even <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Tox_Options.udp_enabled was set to false. ...</code> </pre> <br>  Below we will focus on each step of working with the API in a little more detail. <br><br><h1>  Kernel initialization </h1><br>  To initialize the kernel, the <b>Tox_Options</b> structure is used as a parameter.  In python it can be a dictionary with the same fields.  The default values ‚Äã‚Äãcan be obtained by calling the <b>tox_options_default</b> method: <br><br><pre> <code class="python hljs">$ python &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytoxcore <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ToxCore &gt;&gt;&gt; ToxCore.tox_options_default() {<span class="hljs-string"><span class="hljs-string">'start_port'</span></span>: <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">'proxy_host'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'tcp_port'</span></span>: <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">'end_port'</span></span>: <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">'udp_enabled'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'savedata_data'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'proxy_port'</span></span>: <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">'ipv6_enabled'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'proxy_type'</span></span>: <span class="hljs-number"><span class="hljs-number">0L</span></span>}</code> </pre><br>  Here: <br><br><ul><li>  <b>ipv6_enabled</b> - True or False depending on whether you are the proud owner of IPv6. </li><li>  <b>udp_enabled</b> - except when working through a proxy, it is recommended to set it to True, since  UDP is the native protocol for Tox. </li><li>  <b>proxy_type</b> is a proxy type, can be: <br><ul><li>  <b>TOX_PROXY_TYPE_NONE</b> - do not use proxy. </li><li>  <b>TOX_PROXY_TYPE_HTTP</b> - HTTP proxy. </li><li>  <b>TOX_PROXY_TYPE_SOCKS5</b> - SOCKS5 proxy (for example, Tor). </li></ul></li><li>  <b>proxy_host</b> - proxy server host or IP address. </li><li>  <b>proxy_port</b> - proxy port (ignored for TOX_PROXY_TYPE_NONE). </li><li>  <b>start_port</b> - starting port from the range of allowed ports. </li><li>  <b>end_port</b> - the end port from the range of allowed ports.  If the start and end ports are 0, then the range [33445, 33545] is used.  If only one of the ports is zero, then a single non-zero port is used.  In the case of start_port&gt; end_port, they will be swapped. </li><li>  <b>tcp_port</b> - port for raising the TCP server (relay), if set to 0, the server will be disabled.  TCP relay allows other users to use your instance as an intermediate node (super-node concept). </li><li>  <b>savedata_data</b> - data to load or None in case of their absence. </li></ul><br>  In most cases, all parameters except the <b>savedata_data</b> can be left as default: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import os from pytoxcore import ToxCore class EchoBot(ToxCore): def __init__(self): tox_options = ToxCore.tox_options_default() if os.path.isfile("tox.save"): with open("tox.save", "rb") as f: tox_options["savedata_data"] = f.read() super(EchoBot, self).__init__(tox_options)</span></span></code> </pre><br>  When you first start the kernel will generate public and private keys, which, if necessary, you can save: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"tox.save"</span></span>, <span class="hljs-string"><span class="hljs-string">"wb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(self.tox_get_savedata())</code> </pre><br>  Since the data is always kept in memory, to protect against accidental failures, I recommend periodically saving the data to a temporary file and (if successful, and atomically) replacing the main data file with it. <br><br>  The current values ‚Äã‚Äãof the address to transfer to users, public and private keys and the value of "nospam" can be obtained by calling: <br><br><ul><li>  <b>tox_self_get_address</b> - current address (ToxID). </li><li>  <b>tox_self_get_public_key</b> - public key. </li><li>  <b>tox_self_get_secret_key</b> - private key. </li><li>  <b>tox_self_get_nospam / tox_self_set_nospam</b> ‚Äî getting and setting the nospam value. </li></ul><br><pre> <code class="python hljs">$ python &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytoxcore <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ToxCore &gt;&gt;&gt; core = ToxCore(ToxCore.tox_options_default()) &gt;&gt;&gt; core.tox_self_get_address() <span class="hljs-string"><span class="hljs-string">'366EA3B25BA31E3ADC4C476098A8686E4EAE87B04E4E4A3A3A0B865CBB9725704189FEDAEB26'</span></span> &gt;&gt;&gt; core.tox_self_get_public_key() <span class="hljs-string"><span class="hljs-string">'366EA3B25BA31E3ADC4C476098A8686E4EAE87B04E4E4A3A3A0B865CBB972570'</span></span> &gt;&gt;&gt; core.tox_self_get_secret_key() <span class="hljs-string"><span class="hljs-string">'86003764B4C99395E164024A17DCD0ECB80363C5976FF43ECE11637FA0B683F9'</span></span> &gt;&gt;&gt; core.tox_self_get_nospam() <span class="hljs-string"><span class="hljs-string">'4189FEDA'</span></span></code> </pre><br>  After initializing the kernel, the bot can at any time set a nickname and signature by calling <b>tox_self_set_name</b> and <b>tox_self_set_status_message</b> .  The name must not exceed the <b>TOX_MAX_NAME_LENGTH</b> value, the length of the signature must not exceed the <b>TOX_MAX_STATUS_MESSAGE_LENGTH</b> value (sizes in bytes).  Installation of the avatar will be discussed below, because  technically is sending a file to a contact. <br><br><h1>  Setting callback functions </h1><br>  In the python wrapper, the connection to the supported callback functions is performed automatically.  The handlers themselves can be methods of the successor to <b>ToxCore</b> and have the suffix <b>* _cb</b> : <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_self_connection_status_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, connection_status)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection_status == ToxCore.TOX_CONNECTION_NONE: print(<span class="hljs-string"><span class="hljs-string">"Disconnected from DHT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> connection_status == ToxCore.TOX_CONNECTION_TCP: print(<span class="hljs-string"><span class="hljs-string">"Connected to DHT via TCP"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> connection_status == ToxCore.TOX_CONNECTION_UDP: print(<span class="hljs-string"><span class="hljs-string">"Connected to DHT via UDP"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError(<span class="hljs-string"><span class="hljs-string">"Unknown connection_status: {0}"</span></span>.format(connection_status))</code> </pre><br>  The specific handlers and their arguments will be discussed below. <br><br><h1>  Connect to DHT node </h1><br>  DHT-node is determined by IP address, port number and public key.  The initial list of DHT nodes can <a href="https://wiki.tox.chat/users/nodes">be found on the project wiki</a> . <br><br>  According to the <a href="">Tox Client Guidelines</a> , the client every 5 seconds should try to connect to at least four random nodes until the kernel reports a successful connection (see <b>tox_self_connection_status_cb</b> ).  In the case of loading from the state file, the client should not attempt to connect within 10 seconds after the first call <b>tox_iterate</b> and, in the case of no connection, repeat the aggressive connection strategy above. <br><br>  For the bot, who plans to be always in touch, these recommendations look a bit over-complicated.  You can try to reduce the required number of DHT nodes for connection by raising your own local DHT node.  An additional plus of having a local node, in addition to constant communication with it, is the ‚Äúgain‚Äù of the Tox network itself. <br><br>  To raise the local node, you need to install and configure the <b>tox-bootstrapd</b> daemon.  It can be assembled with the toxcore library, as well as obtained in binary form from <a href="https://wiki.tox.chat/binaries">the developers repository</a> . <br><br>  The daemon configuration is set in the <i>/etc/tox-bootstrapd.conf</i> file and is <a href="">well documented</a> .  Additional information on the daemon launch can be obtained in the corresponding <a href="https://github.com/irungentoo/toxcore/tree/master/other/bootstrap_daemon">README</a> , and for the deb distributions <a href="">of the tox.pkg project, the</a> installation of the <a href="http://software.opensuse.org/download.html%3Fproject%3Dhome%253Aantonbatenev%253Atox%26package%3Dtox-bootstrapd">tox-bootstrapd</a> package is <a href="http://software.opensuse.org/download.html%3Fproject%3Dhome%253Aantonbatenev%253Atox%26package%3Dtox-bootstrapd">self-</a> sufficient.  The public key of the local DHT node can be found in the system log after starting the daemon. <br><br>  Thus, a simplified version of the connection with the DHT node and the duty cycle can be represented as: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> checked = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.tox_bootstrap(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">33445</span></span>, <span class="hljs-string"><span class="hljs-string">"366EA...72570"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: status = self.tox_self_get_connection_status() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> checked <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> status != ToxCore.TOX_CONNECTION_NONE: checked = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> checked <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> status == ToxCore.TOX_CONNECTION_NONE: self.tox_bootstrap(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">33445</span></span>, <span class="hljs-string"><span class="hljs-string">"366EA...72570"</span></span>) checked = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.tox_iterate() interval = self.tox_iteration_interval() time.sleep(interval / <span class="hljs-number"><span class="hljs-number">1000.0</span></span>)</code> </pre><br>  In some cases, a client can work without calling <b>tox_bootstrap</b> at all ‚Äî for this, it is necessary that another client or a DHT node be running within the same broadcast domain of the network.  This feature makes it possible to communicate within the local network without the need to access the Internet and communicate with the outside world, if at least one client has access to the network and is a relay. <br><br><h1>  Event handling </h1><br>  As it was written earlier, to connect an event handler in python, it is enough to add the required method with the necessary arguments to the <b>inheriting</b> class, and as an example, the <b>tox_self_connection_status_cb</b> connection state handler, which is called when the bot is connected and disconnected from the DHT network, was given. <br><br><h2>  Work with contacts </h2><br>  In order for the bot to interact with other members of the network, they must be added to the bot's contact list.  In API terms, a contact is called ‚Äúfriend‚Äù and is denoted by an integer (" <b>friend_number</b> "), unique in the lifetime of a ToxCore instance. <br><br>  When another client makes a request to add a bot to the contact list, the <b>tox_friend_request_cb (public_key, message)</b> handler is called on the side of the bot, where: <br><br><ul><li>  <b>public_key</b> - friend's public key. </li><li>  <b>message</b> - a message from a friend like <i>‚ÄúHi, this is abbat!</i>  <i>Add me as a friend?</i> </li></ul><br>  Inside the handler, you can either add a person as a friend by calling <b>tox_friend_add_norequest</b> , or just ignore the request.  All further event handlers will use <b>friend_number</b> as a friend identifier, which can be obtained from the public key by calling <b>tox_friend_by_public_key</b> . <br><br>  After adding a contact as a friend on the bot side, the following events may occur: <br><br><ul><li>  <b>tox_friend_connection_status_cb (friend_number, connection_status)</b> - change the friend‚Äôs connection status, where <b>connection_status</b> can be: <br><ul><li>  <b>TOX_CONNECTION_NONE</b> is a friend offline. </li><li>  <b>TOX_CONNECTION_TCP</b> is a friend online and connected via TCP. </li><li>  <b>TOX_CONNECTION_UDP</b> is a friend online and connected via UDP. </li></ul></li><li>  <b>tox_friend_name_cb (friend_number, name)</b> - change friend's nickname. </li><li>  <b>tox_friend_status_message_cb (friend_number, message)</b> - change the signature. </li><li>  <b>tox_friend_status_cb (friend_number, status)</b> - a change in state, where <b>status</b> can be: <br><ul><li>  <b>TOX_USER_STATUS_NONE</b> - available ("online"). </li><li>  <b>TOX_USER_STATUS_AWAY</b> - departed. </li><li>  <b>TOX_USER_STATUS_BUSY</b> - busy. </li></ul></li><li>  <b>tox_friend_message_cb (friend_number, message)</b> - message from a friend. </li><li>  <b>tox_friend_read_receipt_cb (friend_number, message_id)</b> - receipt of receipt of another message sent by the <b>tox_friend_send_message</b> call (see below). </li></ul><br>  In the case of the echo-bot when you receive a message from a friend, you just need to send it back: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_friend_request_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, public_key, message)</span></span></span><span class="hljs-function">:</span></span> self.tox_friend_add_norequest(public_key) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_friend_message_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, friend_number, message)</span></span></span><span class="hljs-function">:</span></span> message_id = self.tox_friend_send_message(friend_number, ToxCore.TOX_MESSAGE_TYPE_NORMAL, message)</code> </pre><br>  A message is sent to a friend by calling the <b>tox_friend_send_message</b> method, which returns the <b>message_id</b> message id ‚Äî a monotonically increasing number that is unique to each friend.  The method takes as parameters the friend's identifier, message type, and the message text itself.  The following restrictions apply to the message text: <br><br><ul><li>  The message can not be empty. </li><li>  The message can not be more than <b>TOX_MAX_MESSAGE_LENGTH</b> (byte), long messages must be divided into parts. </li></ul><br>  If the processing of a message from a friend takes some time, the bot's behavior can be varied by sending randomly ‚Äúmessage set‚Äù events ( <b>tox_self_set_typing</b> ). <br><br>  By the value of a <b>friend_number of a</b> friend, at any moment of work you can get the following information about him: <br><br><ul><li>  <b>tox_friend_get_connection_status</b> - friend‚Äôs current network status (last value from <b>tox_friend_connection_status_cb</b> ). </li><li>  <b>tox_friend_get_name</b> - friend's current nickname (last value from <b>tox_friend_name_cb</b> ). </li><li>  <b>tox_friend_get_status_message</b> - friend‚Äôs current signature (last <b>tox_friend_status_message_cb</b> ). </li><li>  <b>tox_friend_get_status</b> - friend‚Äôs current status (last value from <b>tox_friend_status_cb</b> ). </li><li>  <b>tox_friend_get_last_online</b> - the date of the last appearance in online (unixtime). </li></ul><br>  Additional operations with friends: <br><br><ul><li>  <b>tox_self_get_friend_list_size</b> - get the number of friends. </li><li>  <b>tox_self_get_friend_list</b> ‚Äî <b>Get a friend_number of</b> friends list. </li><li>  <b>tox_friend_delete</b> - delete a friend from the contact list. </li></ul><br>  Here everything seems simple and intuitive.  It will be a little more difficult. <br><br><h2>  Work with files </h2><br><h3>  Receiving files </h3><br>  When a friend sends a file to the bot, a <b>tox_file_recv_cb</b> event <b>(friend_number, file_number, kind, file_size, filename) occurs</b> , where: <br><br><ul><li>  <b>friend_number</b> ‚Äî friend‚Äôs number (see ‚ÄúWorking with Contacts‚Äù). </li><li>  <b>file_number</b> is the file number, a unique number within the current list of received and transmitted files from this friend. </li><li>  <b>kind</b> - file type: <br><ul><li>  <b>TOX_FILE_KIND_DATA</b> - the transmitted file is a simple file. </li><li>  <b>TOX_FILE_KIND_AVATAR</b> - the transmitted file is a friend's avatar. </li></ul></li><li>  <b>file_size</b> - file size.  For <b>TOX_FILE_KIND_AVATAR,</b> a file size of 0 means that the friend has no avatar installed.  File size equal to UINT64_MAX indicates an unknown file size (streaming). </li><li>  <b>filename</b> is the name of the file. </li></ul><br>  Here you should pay special attention to the <b>filename</b> parameter.  Although the specification requires all data to be transferred to UTF-8 and the file name should not contain parts of the path, in real life anything can flow up to unreadable binary data containing newline characters and zeros. <br><br>  When this event occurs, the following bot action should be the call to the controlling method <b>tox_file_control (friend_number, file_number, control)</b> , where: <br><br><ul><li>  <b>friend_number</b> - friend number. </li><li>  <b>file_number</b> is the file number. </li><li>  <b>control</b> - file control command: <br><ul><li>  <b>TOX_FILE_CONTROL_CANCEL</b> - cancel receiving the file. </li><li>  <b>TOX_FILE_CONTROL_PAUSE</b> - put the file transfer on pause (not supported by all clients). </li><li>  <b>TOX_FILE_CONTROL_RESUME</b> - continue the file transfer. </li></ul></li></ul><br>  For echo-bot reception of files is not required, so he can always cancel the operation: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_file_recv_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, friend_number, file_number, kind, file_size, filename)</span></span></span><span class="hljs-function">:</span></span> self.tox_file_control(friend_number, file_number, ToxCore.TOX_FILE_CONTROL_CANCEL)</code> </pre><br>  In the case of the transfer of control via <b>TOX_FILE_CONTROL_RESUME</b> , the <b>tox_file_recv_chunk_cb</b> event <b>starts to be triggered (friend_number, file_number, position, data)</b> , where: <br><br><ul><li>  <b>friend_number</b> - friend number. </li><li>  <b>file_number</b> is the file number. </li><li>  <b>position</b> - the current position in the file. </li><li>  <b>data</b> - <b>data</b> chunk or None for the end of the transfer. </li></ul><br>  Here you should pay attention to the fact that <b>position</b> does not have to monotonously increase - in general, chunks can come in any sequence and of any length. <br><br><h3>  File transfer </h3><br>  To start the file transfer procedure, you need to call the <b>tox_file_send</b> method <b>(friend_number, kind, file_size, file_id, filename)</b> , where: <br><br><ul><li>  <b>friend_number</b> - friend number. </li><li>  <b>kind</b> is the value of <b>TOX_FILE_KIND_DATA</b> or <b>TOX_FILE_KIND_AVATAR</b> . </li><li>  <b>file_size</b> is the file size (special values ‚Äã‚Äã0 and UINT64_MAX are discussed above). </li><li>  <b>file_id</b> is a unique identifier for a file of length <b>TOX_FILE_ID_LENGTH</b> , which allows you to continue the transfer after a kernel restart or None for automatic generation. </li><li>  <b>filename</b> is the name of the file. </li></ul><br>  Here the special parameter is <b>file_id</b> .  In the case of automatic generation, it can later be obtained by calling <b>tox_file_get_file_id</b> , however, when sending an avatar, it is recommended to set its value to the result of a <b>tox_hash</b> call from the avatar file data, which allows the receiving party to cancel the transfer of previously loaded avatars to save traffic. <br><br>  It should also be noted that the transfer of files is only possible to friends who are connected to the network.  Disconnecting a friend from the network stops file transfer. <br><br>  After calling <b>tox_file_send, the</b> kernel waits for the decision from the receiving side.  The solution is processed by the <b>tox_file_recv_control_cb</b> event <b>(friend_number, file_number, control)</b> , where: <br><br><ul><li>  <b>friend_number</b> - friend number. </li><li>  <b>file_number</b> is the file number. </li><li>  <b>control</b> - file control command ( <b>TOX_FILE_CONTROL_CANCEL</b> , <b>TOX_FILE_CONTROL_PAUSE</b> or <b>TOX_FILE_CONTROL_RESUME</b> discussed earlier). </li></ul><br>  Processing this event allows you to free up resources in case of failure of the client to accept the file. <br><br>  Echo bot only needs to send an avatar.  Avatar transfer is recommended to be done every time a friend appears on the network.  If a friend‚Äôs tox client has previously uploaded an avatar with the given <b>file_id</b> , then he can cancel the retransmission of the avatar. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... self.avatar_name = <span class="hljs-string"><span class="hljs-string">"avatar.png"</span></span> self.avatar_size = os.path.getsize(avatar_name) self.avatar_fd = open(avatar_name, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>) data = self.avatar_fd.read() self.avatar_id = ToxCore.tox_hash(data) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_friend_connection_status_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, friend_number, connection_status)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection_status != ToxCore.TOX_CONNECTION_NONE: send_avatar(friend_number) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_avatar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, friend_number)</span></span></span><span class="hljs-function">:</span></span> file_number = self.tox_file_send(friend_number, ToxCore.TOX_FILE_KIND_AVATAR, self.avatar_size, self.avatar_id, self.avatar_name) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_file_recv_control_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, friend_number, file_number, control)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tox_file_chunk_request_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, friend_number, file_number, position, length)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> length == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.avatar_fd.seek(position, <span class="hljs-number"><span class="hljs-number">0</span></span>) data = self.avatar_fd.read(length) self.tox_file_send_chunk(friend_number, file_number, position, data)</code> </pre><br><br>  In addition to receiving and transmitting messages and files, the kernel provides the possibility of packet transmission (lossy or lossless).  To do this, <b>use the tox_friend_send_lossy_packet</b> and <b>tox_friend_send_lossless_packet methods</b> , as well as the <b>tox_friend_lossy_packet_cb</b> and <b>tox_friend_lossless_packet_cb events</b> . <br><br><h1>  Links </h1><br><ul><li>  <a href="https://tox.chat/">tox.chat</a> is the current official site of the Tox project (tox.im instead). </li><li>  Kernel <a href="https://github.com/irungentoo/toxcore">toxcore</a> project <a href="https://github.com/irungentoo/toxcore">on github</a> . </li><li>  The <a href="https://github.com/abbat/pytoxcore">pytoxcore</a> python wrapper <a href="https://github.com/abbat/pytoxcore">project on github</a> . </li><li>  A project to build binary versions of clients and <a href="">tox.pkg</a> libraries <a href="">on github</a> . </li><li>  The project of the "official" Python wrapper <a href="https://github.com/aitjcize/PyTox">PyTox on github</a> (at the time of this writing, the library was not compiled due to the use of the "old" api). </li></ul></div><p>Source: <a href="https://habr.com/ru/post/264179/">https://habr.com/ru/post/264179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264167/index.html">Using the Media Capture API in a browser</a></li>
<li><a href="../264169/index.html">‚ÄúDepth-depth, I'm not yours. Let me go, depth. ‚Äù Virtual Reality for Developers</a></li>
<li><a href="../264171/index.html">Creating an Excel file from a select with parameters using pure PL / SQL</a></li>
<li><a href="../264173/index.html">Globals are Cossack swords for data storage. Trees Part 2</a></li>
<li><a href="../264175/index.html">Real-time stateful React components update for Browserify</a></li>
<li><a href="../264181/index.html">RPC, Messaging, REST: Terminology</a></li>
<li><a href="../264185/index.html">Modern Adaptec RAID controllers from A to Z. Part 2</a></li>
<li><a href="../264189/index.html">Implementation of the wave algorithm for finding the shortest path to dynamically moving objects in unity3d on C # in a 2d game</a></li>
<li><a href="../264191/index.html">Interpolation of data: we connect points so that it was beautiful</a></li>
<li><a href="../264193/index.html">How to find out the year of release of the song on the set of audio characteristics?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>