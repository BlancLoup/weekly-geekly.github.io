<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Providing browser crashes with behavioral fuzzing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will tell you how I used fuzzing to find a few crashes in Firefox. Usually the goal of fuzzing is to find a failure indicating memo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Providing browser crashes with behavioral fuzzing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/de5/60c/9c4/de560c9c4bd1bb90f65f35ecacdbc310.jpg" alt="image"><br><br>  In this article, I will tell you how I used fuzzing to find a few crashes in Firefox.  Usually the goal of fuzzing is to find a failure indicating memory corruption, but my goal is different: I want to detect an unexpected browser response.  These can be characters that open or close an unusual tag, or perhaps characters that are ignored by the JavaScript parser.  Such an unexpected reaction can often be used to conduct XSS attacks, bypassing security filters and avoiding JavaScript sandboxes. <a name="habracut"></a><br><br>  The first mistake I want to talk about is how to close the HTML comment in a different way.  If you read the HTML specification, you know that a comment can be closed with -&gt; or -!&gt;.  But how to do it differently?  Great question to start fuzzing!  You just need to generate a code that will give the answer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Back in 2008, when I put <a href="http://shazzer.co.uk/home">Shazzer</a> to fuzz browser behavior, I was limited to about 10,000 page per page.  Today, in 2019, everything works faster, so we can fuzz much more often.  In addition, using DOM speeds up fuzzing because you no longer need to add each direction to the current document.  It is worth noting that this is an unreliable approach, since you can get different results.  Indeed, I have found cases where the DOM allows null values ‚Äã‚Äã(NULL) in attribute arguments such as href, but the HTML parser does not.  These are still non-critical failures, but you can not always trust the results to get a complete picture of what the HTML parser will do.  However, in most cases it works, and it is much faster than HTML output from the server side. <br><br>  The first step has already been taken - we have a question: ‚ÄúWhat characters can close an HTML comment?‚Äù.  To answer it, we need to use existing characters that will close the HTML comment and fuzz characters that we do not know.  The next step is to use appropriate fuzzing programs.  In my case, I use my <a href="https://hackvertor.co.uk/public">Hackvertor</a> tool, but with the help of a local web server you can achieve the same results.  The idea of ‚Äã‚Äãthis tool is to put the input in the input box, convert the tags a bit and do something with the output.  Since we have nothing to convert, we can put our code directly into the output field.  Therefore, click on the text output area and create an array to store the outlined characters and a div element for HTML testing: <br><br><pre><code class="javascript hljs">log = []; div=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>);</code> </pre> <br>  Then we need to flip over 1,000,000 Unicode characters or, more precisely, 0x10ffff.  A simple for loop is all we need: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;=<span class="hljs-number"><span class="hljs-number">0x10ffff</span></span>;i++){</code> </pre> <br>  Then we reuse the div element we created for each character.  In this case, I test the position after!, So the character will be entered after! .. Then I use the img element to see if the fuzzing was successful.  If this element exists, then the HTML comment has been closed, and we have some interesting characters! <br><br><pre> <code class="javascript hljs">div.innerHTML = <span class="hljs-string"><span class="hljs-string">'&lt;!-- --!'</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCodePoint(i)+<span class="hljs-string"><span class="hljs-string">'&gt;&lt;img&gt;--&gt;'</span></span>;</code> </pre> <br>  Finally, using querySelector, we check if img exists and add characters to the logs.  Then I close the if statement and the for loop.  Finally, I enter the results in the input field on the left: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(div.querySelector(<span class="hljs-string"><span class="hljs-string">'img'</span></span>)){ log.push(i); } } input.value=log</code> </pre> <br>  Here is the <a href="https://hackvertor.co.uk/public">full version of the</a> code.  You need to open the URL in Firefox, and then place the input characters in the output field and click the ‚ÄúExecute JS‚Äù button to phase the characters.  After fuzzing is complete, you should see the numbers in the input field, which correspond to the character codes that were successful.  At the time of writing, the Firefox (version 67) material still allows for new characters in the string - \ n and \ r - after! To close the comment.  I was informed that this was fixed in future versions of Firefox.  So, the last phase of fuzzing is building your payload; it's pretty simple.  You need to replace the character code with a character and add the XSS payload: <br><br><pre> <code class="javascript hljs">&lt;!-- --! &gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">img</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onerror</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">alert(1)</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> --&gt;</span></span></code> </pre> <br>  You can use Hackvertor again to test it by inserting the above into the output field and then clicking "Test HTML".  A warning window should appear because Firefox (version 67) allows the new line as part of the final comment. <br><br>  So this allowed us to find a non-critical error in the HTML parser Firefox.  Let's find one more!  We need a new question: "What characters can open an HTML comment?".  Instead of going beyond the existing HTML comment, we will now use the HTML comment to go beyond the existing HTML attribute.  As I am sure, you all know that you can open an HTML comment with &lt;!  -.  All right  We will use the same code again, but this time we will change the purpose of innerHTML to verify the opening comment: <br><br><img src="https://habrastorage.org/webt/nb/ji/du/nbjidu5mobde5mgiiojvfnumiwi.png"><br><br>  Thus, the character that we fuzz will be after the first hyphen.  If the character successfully creates the opening HTML comment, it will comment the div element and, therefore, exit the title attribute.  This time, when we launch ‚ÄúExecute JS‚Äù, ‚Äã‚Äãwe get two results in Firefox (version 67): ‚Äú0.45‚Äù.  Code 45 is expected because it is a hyphen character, but 0 is a NULL character!  This means that Firefox interprets the sequence &lt;! - NULL- as an open comment.  Some kind of game!  (I think browser vendors need to do more behavioral fuzzing =)).  To complete this test case, we now need to create our direction.  Do the same: replace the String.fromCodePoint function with the NULL and XSS direction again: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.innerHTML = <span class="hljs-string"><span class="hljs-string">'&lt;!-\x00- &gt;&lt;div title="--&gt;&lt;img src=1 onerror=alert(1)&gt;"&gt;&lt;/div&gt;'</span></span>;</code> </pre> <br>  Let's go over JavaScript instead of HTML.  I tested every browser, and I'm sorry for Mozilla, but Firefox does some kind of game again.  I was inspired by the fact that fuzzing jinmo123 from a <a href="https://twitter.com/jinmo123/status/1128973541238484992">tweet</a> uses new interesting features of ES6 to call functions without brackets.  The question I came up with for fuzzing was: ‚Äúwhich characters are allowed after the in or instanceof operators?‚Äù.  Then we create the code again in Hackvertor, it follows a similar pattern, but this time it does not use DOM.  First, create an array and a for loop: <br><br><pre> <code class="javascript hljs">log = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;=<span class="hljs-number"><span class="hljs-number">0x10ffff</span></span>;i++){</code> </pre><br>  Then we will use eval instead of innerHTML to fuzz our values.  First we need to use a try catch block to detect any exceptions caused by invalid characters. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-string"><span class="hljs-string">"/a/"</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCodePoint(i)+<span class="hljs-string"><span class="hljs-string">"instanceof function(){}"</span></span>);</code> </pre> <br>  The eval function is used to see if our JavaScript is valid.  If so, it will go to the next line, if not, will throw an exception that will be noticed, and then go to the next character.  The next line simply registers the character, and then closes the try catch block and the for loop.  The function then displays the results in the input field. <br><br><pre> <code class="javascript hljs">log.push(i); }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e){} } input.value=log</code> </pre> <br>  If you run this code with ‚ÄúExecute JS‚Äù, ‚Äã‚Äãyou will get a bunch of results!  Firefox ignores many characters.  If you try the Chrome code, you will get more reasonable results.  Find the character code in the input field that you want to use, in my case it was ‚Äú1114110‚Äù or ‚Äú0x10fffe‚Äù in hex.  Now we will create our javascript vector: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-string"><span class="hljs-string">"1337"</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCodePoint(<span class="hljs-number"><span class="hljs-number">1114110</span></span>)+<span class="hljs-string"><span class="hljs-string">"in"</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCodePoint(<span class="hljs-number"><span class="hljs-number">1114110</span></span>)+<span class="hljs-string"><span class="hljs-string">"alert(1337)"</span></span>);</code> </pre> <br>  You can also submit it inside the SVG script: <br><br><img src="https://habrastorage.org/webt/hv/92/k2/hv92k2ivxpvq3-2faoms6akr9hg.png"><br><br>  The latest dual-processor configurations of dedicated servers with Intel Scalable 2019 processors are available on <a href="https://dedic.sh/%3Futm_source%3Dhabrahabr%26utm_medium%3Dwidget%26utm_content%3D455602"><b>DEDIC.SH</b></a> : <br><ul><li>  2x Xeon Silver 4214 - a total of 24 cores </li><li>  2x Xeon Gold 5218 - total 32 cores </li><li>  2x Xeon Gold 6240 - configuration with 36 cores. </li></ul><br>  Server cost with two Xeon Silver 4214 - <a href="https://dedic.sh/%3Futm_source%3Dhabrahabr%26utm_medium%3Dwidget%26utm_content%3D455602"><b>from 15210 rub / month</b></a> <br>  We are also ready to collect <b>any configuration</b> for you - <b><a href="">write to us</a></b> ! <br><br>  If a large capacity of a dedicated server is not required - <b><a href="https://vds.sh/ru/%3Futm_source%3Dhabrahabr%26utm_medium%3Dwidget%26utm_content%3D454614">VDS from 150 rubles / month</a></b> - what you need! </div><p>Source: <a href="https://habr.com/ru/post/455602/">https://habr.com/ru/post/455602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455594/index.html">Operating Microsoft Edge from CVE to RCE on Windows 10</a></li>
<li><a href="../455596/index.html">DevConfX :: Management - reports of managers in simple words</a></li>
<li><a href="../455598/index.html">Update exim urgently to 4.92 - an active infection is in progress</a></li>
<li><a href="../4556/index.html">Another site safely "zaguglen"</a></li>
<li><a href="../455600/index.html">3DEXPERIENCE Platform Helps Build Future Public Transport</a></li>
<li><a href="../455606/index.html">Machine learning and data analysis: magistracy of the Higher School of Economics in St. Petersburg</a></li>
<li><a href="../455610/index.html">Legendary Intel Core i7-2600K: Sandy Bridge Testing in 2019 (Part 1)</a></li>
<li><a href="../455612/index.html">We think over characters of games and dialogues on the advice of writers and on the example of supporters of the theory of a flat Earth</a></li>
<li><a href="../455616/index.html">Why go to the "Industrial Programming" in the Petersburg HSE?</a></li>
<li><a href="../455618/index.html">DevOps LEGO: how we layered pipelines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>