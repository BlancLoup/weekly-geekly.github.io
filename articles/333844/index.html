<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL multi-tiered backup with Barman and synchronous transfer of transaction logs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yandex.Money stores a lot of important information for comfortable user experience. Profile settings and subscriptions for penalties also need to be b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL multi-tiered backup with Barman and synchronous transfer of transaction logs</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/961/249/bf4/961249bf4d264b6b9c5e6ad9b959ce56.png"></p><br><p>  Yandex.Money stores a lot of important information for comfortable user experience.  Profile settings and subscriptions for penalties also need to be backed up, which is what the link from Barman Backup &amp; Recovery for PostgreSQL and <em>pg_receivexlog does</em> for <em>us</em> . </p><br><p>  In this article I will talk about why the architecture became what it was, and also tell you how to implement such a script for your PostgreSQL database. <a name="habracut"></a></p><br><h1 id="kak-bylo-i-pochemu-eto-ne-kruto">  How it was, and why it is not cool </h1><br><p>  Before the changes described in the article, the backup of the payment system was removed from the master database at one of our data centers (DC).  In general, a payment system consists of a set of individual services, databases and applications.  All this stuff is reserved according to the importance of the data.  Since the article is more practical, I‚Äôll consider one of many DBMSs as an example without increased security requirements - it stores user profile settings, translation history, authentication preferences, and so on. </p><br><blockquote>  As a backup tool in use, we love Barman, a flexible and stable product.  In addition, it is made by people involved in the development of our beloved PostgreSQL. </blockquote><p>  The problem with backup only from active nodes is that if the master was switched to the second DC (where there were no backups), then the backup server of the first DC was slowly and for a long time collecting copies from the new master over the network.  And the potential loss of the most recent transactions during recovery began to raise more and more concerns as the number of users grew. </p><br><h1 id="delaem-pravilno">  Doing right </h1><br><p>  So, we will solve the following tasks: </p><br><ol><li><p>  Ensuring the availability of backups in case of failure of the DC or backup server. </p><br></li><li>  Preventing loss of transactions when the master server fails. </li></ol><br><p>  The scale of our task was 20 PostgreSQL 9.5 servers (10 masters and 10 slaves) serving 36 databases with a total capacity of about 3 TB.  But the described scenario is also suitable for a couple of servers with critical databases. </p><br><blockquote>  Since version 2.1, Barman Backup &amp; Recovery now has the ability to record a stream of transactions not only from the master, but also from the slave servers (replicas). </blockquote><p>  The general scheme of the new solution is presented below; it is rather uncomplicated: <br><img src="https://habrastorage.org/web/04e/38d/f76/04e38df7619246be89449ea663ba0a1f.png"></p><br><p>  <em>There is one backup server in each DC, their configuration is common (one of the advantages of Barman).</em> </p><br><p>  <strong>The configuration process is as follows:</strong> </p><br><p>  1. Connect to the database server and install <strong>postgresql-9.5-pgespresso</strong> with the help of the package manager - an extension for the integration of Barman Backup &amp; Recovery with PostgreSQL.  All commands are for Ubuntu, for other distributions there may be differences: </p><br><pre><code class="bash hljs">apt-get install postgresql-9.5-pgespresso</code> </pre> <br><p>  2. Install the <strong>pg_espresso</strong> extension in PostgreSQL: </p><br><pre> <code class="bash hljs">postgres@db1:5432 (postgres) <span class="hljs-comment"><span class="hljs-comment"># CREATE EXTENSION pgespresso</span></span></code> </pre> <br><p>  3. Now on the server with Barman, you need to create a file that describes the backup settings for the db1 server - <strong>db1.conf</strong> in the <strong>/etc/barman.d/</strong> directory with the following contents: </p><br><pre> <code class="bash hljs">[db1] ssh_command = ssh postgres@db1 conninfo = host=pgdb1 user=postgres port=5432 backup_options = concurrent_backup ;         pg_espresso archiver = off ;     archive_command streaming_archiver = on ;       slot_name = barman ;   </code> </pre> <br><p>  4. Next, you need to create a replication slot to ensure that the wizard does not delete the transaction logs that have not yet been received by the replica: </p><br><pre> <code class="bash hljs">$ barman receive-wal --create-slot db1</code> </pre> <br><p>  5. And check that Barman sees the server and takes transaction logs from it: </p><br><pre> <code class="bash hljs">$ barman check db1</code> </pre> <br><p>  If all commands are executed correctly, then as a result of the verification command, you should get something similar: </p><br><pre> <code class="bash hljs">Server db1: PostgreSQL: OK superuser: OK PostgreSQL streaming: OK wal_level: OK replication slot: OK directories: OK retention policy settings: OK backup maximum age: OK (no last_backup_maximum_age provided) compression settings: OK failed backups: OK (there are 0 failed backups) minimum redundancy requirements: OK (have 7 backups, expected at least 7) ssh: OK (PostgreSQL server) pgespresso extension: OK pg_receivexlog: OK pg_receivexlog compatible: OK receive-wal running: OK archiver errors: OK</code> </pre> <br><p>  Now Barman will pick up magazines and make backups from replicas.  All PostgreSQL databases with user profiles, payment history, subscriptions to fines, authentication settings, etc., fall into the backup. </p><br><h1 id="otryad-ne-zametil-poteri-boyca">  The squad did not notice the loss of a fighter </h1><br><p>  Let me remind you that zero RPO when restoring is very important for us, so we decided to back up Barman with an additional mechanism - <strong>pg_receivexlog</strong> .  This process is on a separate server ‚Äî not on a server with a database ‚Äî and continuously transfers copies of transaction logs from the master node to a separate repository transaction log store.  And so for each DC separately. </p><br><p>  The peculiarity of the mechanism is that the DBMS does not confirm the application to write the data to the database until it receives confirmation from <em>pg_receivexlog</em> about the successful copying of the transaction. </p><br><p>  Without this, the probability of the following scenario would remain: </p><br><ol><li><p>  For example, Innokenty pays 100 rubles for cellular communication, the operation is successfully carried out by our payment system (PS). </p><br></li><li><p>  Immediately after the backend, an accident occurs and we roll back the backup, including the transaction logs. </p><br></li><li>  But since the transfer occurred right before the accident, this transaction was not backed up and will no longer be reflected in the history of operations on the Innocentia wallet. </li></ol><br><p>  It turns out that the PS knows about the payment, the money is not lost, but the operation itself in history does not look.  Of course, this is inconvenient and discouraging.  The operation would have to be made manually through the support service. </p><br><p>  <strong>Now how to set up a miracle mechanism for synchronous transfer of logs:</strong> </p><br><p>  1. Create a slot for the log collector: </p><br><pre> <code class="bash hljs">pg_receivexlog --create-slot -S pgreceiver --<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-not-exists -h db1</code> </pre> <br><p>  2. Start the log collection service from the PostgreSQL server: </p><br><pre> <code class="bash hljs">pg_receivexlog -S pgreceiver -d <span class="hljs-string"><span class="hljs-string">"host=db1 user=postgres application_name=logreceiver"</span></span> -D /var/lib/postgresql/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/db1/ --verbose --synchronous</code> </pre> <br><pre> <code class="hljs markdown"><span class="hljs-emphasis"><span class="hljs-emphasis">*-S:   .      ;*</span></span> <span class="hljs-emphasis"><span class="hljs-emphasis">*-d:    ;*</span></span> <span class="hljs-emphasis"><span class="hljs-emphasis">*-D: ,    ;*</span></span> <span class="hljs-emphasis"><span class="hljs-emphasis">*‚Äîsynchronous:     ;*</span></span></code> </pre> <br><p>  3. After starting, <strong>pg_receivexlog</strong> will try to save transaction logs to the directory in synchronous mode.  There may be several such collectors, one per PostreSQL server.  But in order for the synchronous mode to work, you need to specify the parameter in the PostgreSQL configuration in the DBMS settings on the master node: </p><br><pre> <code class="bash hljs">synchronous_standby_names = <span class="hljs-string"><span class="hljs-string">'logreceiver, standby'</span></span></code> </pre> <br><p>  4. But if the server with the log collector fails, the master node can continue processing user transactions, it is better to specify a replica for the second server.  On the replica in <strong>recovery.conf,</strong> you need to specify where to get the transaction logs if the master node is unavailable: </p><br><pre> <code class="bash hljs">restore_command = <span class="hljs-string"><span class="hljs-string">'scp postgres@logreceiver:/var/lib/postgresql/log/db1/%f* %p'</span></span></code> </pre> <br><p>  Of course, if the log collection server fails, the speed of the entire system will slightly decrease, because instead of sending logs to the log collector in the same DC, the master will have to send them with confirmation to another DC.  However, stability is more important. </p><br><p>  As a summary, I‚Äôll give some specifics about the time and volume of backups as described in the article.  The full backup of the servers mentioned above is removed at Yandex.Money daily and weighs about 2 TB, for which the backup server needs 5-10 hours to process.  In addition, there is a constant backup of transaction logs by moving their files to the repository. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/333844/">https://habr.com/ru/post/333844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333834/index.html">Preview RamblerFront & # 2</a></li>
<li><a href="../333836/index.html">Doom 3 source code analysis</a></li>
<li><a href="../333838/index.html">Antivirus on batch file in the past „Ö° it's time to PowerShell sniffer</a></li>
<li><a href="../333840/index.html">The need to regulate the Internet of things</a></li>
<li><a href="../333842/index.html">Monitoring the work of production web studio</a></li>
<li><a href="../333846/index.html">Photographing objects in C #: Chronicle and comparison of images, reconstruction of the state of the image</a></li>
<li><a href="../333848/index.html">What is the power of Redux?</a></li>
<li><a href="../333850/index.html">Security in the era of the Internet of Things: stories of hacking video-babies, pacemakers and supercars</a></li>
<li><a href="../333852/index.html">SwiftyBeaver iOS Guide: Logging Platform for Swift</a></li>
<li><a href="../333854/index.html">Overview-rating providers virtual servers Windows: 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>