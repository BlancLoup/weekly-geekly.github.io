<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the PerfView utility in customer support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the stages of processing the application from the user in our support service is to reproduce the problem. Difficulties with reproduction arise...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the PerfView utility in customer support</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b18/2a9/f09/b182a9f0926a40725eb1456233914287.jpg"><br>  One of the stages of processing the application from the user in our support service is to reproduce the problem.  Difficulties with reproduction arise for various reasons: the user cannot always provide an example of an application where the incorrect behavior of the code manifests itself, or the problem may be specific to a particular environment.  Today, a huge number of software, hardware configurations and virtual environments are used in which programs written with our components work.  The screen width in pixels can vary five times (from 800 to 4k).  And configurations may differ by other parameters: memory size, number of displays, DPI, security settings, video card and its drivers.  This diversity provides a steady stream of requests from customers specific to a particular configuration.  For example, the problem is reproduced only on a specific version of Windows, or only on certain DPI settings, or if the user has three monitors.  To solve this problem for several years, our support service has been using the <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D28567">Microsoft PerfView</a> utility.  If all other ways to reproduce the problem are exhausted, we give the user a simple instruction on how to start the trace and send us the resulting file.  Tracing information helps to understand exactly what causes the problem. <br><br>  This article will discuss the possibilities of using PerfView in technical support and the limitations of this utility. <br><a name="habracut"></a><br>  Initially, PerfView was created for internal use and used by Microsoft to optimize Windows, .NET CLR and Visual Studio performance.  The utility uses the Windows kernel tool - <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb968803%2528v%3Dvs.85%2529.aspx">ETW (event tracing for windows)</a> <br><br>  In order to correctly interpret the trace results, it is important to understand how this utility works.  Any program can be represented as a directed graph, the vertices of which are methods.  Then the stack of the program at any time will be the path from the main () method to the method that is currently running. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/34a/5e9/efe/34a5e9efe2f1ee1f3c8741f8cf7111ad.png"><br><br>  In the ideal case, to analyze the operation of this program, it is necessary to have information about its state at each time point.  For example, this information is provided by debugging.  But, first, the debugger has an impact on the process being debugged and the data obtained may be unreliable.  Secondly, asynchronous calls are becoming more common, which debuggers do not analyze well enough.  For many tasks, there is no need for information about the state of the program being analyzed at any given time.  You can take snapshots of the program at regular intervals.  The figure shows the timing diagram of a simple program in one thread.  The time axis at the bottom of the diagram is divided into equal periods of time, multiples of the processor clock cycle.  Stacked stacks are unavailable for gray segments, and available for green ones. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/13a/7f7/9f9/13a7f79f9b19386f0dca58ff5a69f3df.png"><br><br>  Based on this idea, the PerfView profiler was created.  After certain, rather short periods of time, a snapshot of the stacks of all processes on the machine is taken.  PerfView can download symbols from the Internet, is small in size and is transferred to another machine by simple copying.  This makes PerfView a powerful tool for analyzing the operation of any programs on any Windows machine.  In addition to stack count, system events, .NET events, and much more are stored.  This information often helps to understand the essence of the problem and find a solution. <br><br>  Consider the typical situations where PerfView may be useful for technical support: <br>  1. The application freezes at the user.  This is the simplest thing that can be.  The stack count that causes the hang is guaranteed to be contained in the trace. <br>  2. The application stops working with an error.  At the same time, Windows suspends the problematic process and calls the debugging process dwwin.exe for it.  This call takes time much longer than the time between shots, so you can safely say that the stack of the fall will also fall into the trace. <br>  3. The application does not work as expected.  For example, in some configurations, the application may flicker unpleasantly when the window is resized.  In this situation, it is necessary to compare the results of the traces with the ‚Äúgood‚Äù and ‚Äúbad‚Äù configurations. <br>  4. Poor application performance on the user's machine.  PerfView was originally created as a performance profiler.  In this case, the utility is used for its intended purpose. <br><br>  Of course, PerfView will not be useful in situations where the problematic code is manifested for a time that is shorter than the interval between images and does not repeat. <br><br><h2>  Example </h2> <br>  It is proposed to analyze the work of a simple WPF application that draws lines on the screen when it is played with a finger, drawing with the mouse is also supported.  The finished application was taken <a href="http://www.codeproject.com/Articles/617868/Scribble-WPF-InkCanvas-Application-Using-PRISM-MVV">from here.</a> <br>  This is the application being analyzed: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f2/589/7f4/6f25897f46d7f2d3124eab1107304a00.png"><br><br>  Task: estimate the delay time from input to display the line on the screen, examine the delay time for the following scenarios <br>  1. The application launches the Acer Iconia W3 810 tablet. Touch input is used. <br>  2. Remotely launch the application on Acer Iconia W3 810 and use mouse input instead of touch input. <br>  Cheap and weak tablet from Acer is not chosen by chance.  It is rather slow and has little memory in order to run some other, more demanding software developer. <br><br>  We start by collecting data for analysis.  In the main PerfView window, press Alt + C.  A dialog will appear. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c0/3ff/4b9/6c03ff4b9320b8bb609aa8922cd9264e.png"><br><br>  We leave the options as they are, click Start Collection.  In order not to analyze too much, it is advisable to reduce the number of actions during data collection.  For example, you can run the analyzed program in advance, if you are not interested in what happens when it starts.  We draw several lines and click Stop Collection.  It‚Äôs not convenient to analyze on a small tablet screen, so we transfer the resulting * .etl file to a large computer.  To analyze the trace, you need pdb files for assemblies that were installed on the machine at the time of the trace.  PerfView puts them in the archive with the etl file if you run Collect-&gt; Merge.  The latest version of the utility does it by default, in earlier versions it was necessary to remember this.  Open the received file. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/021/d3e/18d/021d3e18de713e0a769b030fa8742754.png"><br><br>  There is a lot that can be told here, but now we select CPU Stacks and see all the processes that were running on the tablet at the time of the trace. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd1/61d/340/fd161d34068e7c41a9e77029d22f8349.png"><br><br>  You can see any of them.  This makes PerfView a useful tool for analyzing cross-process interactions.  The third process above is ours.  Choose it, get it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c06/801/919/c068019196a929943798d7dc21a57afa.png"><br><br>  The When column displays numbers on the time axis.  The smaller the number, the less processor resources were consumed.  A dash in this column means that the stacks with this method did not fit into the trace at the appropriate points in time.  There are five bursts of activity.  When tracing drew five lines.  GroupPats is best set to Group class entries.  In this mode, the table line will correspond to the method. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c2e/5e8/1f0/c2e5e81f055b347fdc01a125cb028db9.png"><br><br>  PerfView shows several hundred methods in the table, although there are many more.  Therefore, to see a more complete picture, it is important to reduce the time interval when analyzing the trace data.  As we already guessed, bursts of activity on the time axis correspond to drawing lines.  Choose a second burst;  To do this, select the characters in the When column, and PerfView will prompt the beginning and end of the interval, which must be entered into the Start and End fields.  The following view corresponds to the beginning of the line drawing.  At the beginning of the time period, the application process did nothing.  If we order the methods by the When column, we get: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/13f/489/a53/13f489a5378cb88c8b6aa2e94aa94ecf.png"><br><br>  In this screenshot, you can see that the drawing process begins with handling the event of touch input PresentationCore.ni! PenThreadWorker.ThreadProc.  This occurred 3,735 milliseconds from the start of the trace.  The touch event will be processed in the program and should cause a redraw.  Since the methods are ordered by call time, just scroll down the table and look for calls related to redrawing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d6f/f76/e3a/d6ff76e3a52dcf10ab32ba301aef8bdb.png"><br><br>  Calls in wpfgfx occur after about three milliseconds, but this is not what we were looking for, because the code of our application did not work in this time interval.  It seems that we accidentally made a small discovery - WPF has its own visualization of sensory input.  Even if the application does not handle touch input events, its window will still redraw when such events arrive.  The end of the redraw will be the d3d9! CSwapChain :: Present call.  The first redraw (not ours) occurred at 3,740 milliseconds.  Moving further along the time axis.  The touch event was processed by user code after another 4 milliseconds.  Below is the full stack of event handling. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a99/2d5/4cc/a992d54cc3576e0b1975c9ee4bca453e.png"><br><br>  The next call to the d3d9 method! CSwapChain :: Present occurred at 3,767 milliseconds. <br>  Thus, it took about 32 milliseconds from a touch event to a redraw caused by the operation of a custom code.  With the speed of one finger per second, the visualization lag will be about three pixels. <br>  In the case of a remote connection to the tablet, the delay time will consist of: the delay in transmitting user input to the remote machine, the delay in forming the frame on the remote machine, the delay in receiving and drawing the frame in Remote Desktop.  To estimate these delays, it is enough to perform a trace on the machine with which Remote Desktop is started.  We present here only the results of the analysis and interesting findings.  We will analyze the process mstsc.exe.  Neglecting the time spent on processing the input message, we will take the delay time from the call to mstscax! CTSProtocolHandler Base: SendBuffer to the call to mstscax! COP :: PresentContentGDI.  The transfer of user input to the remote machine occurred at 14,348 milliseconds. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d8d/739/680/d8d739680f955b3ca35d1447c099b5e2.png"><br><br>  After that, receiving graphic data from a remote machine and redrawing the Remote Desktop application window occurred at 15,139 milliseconds. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/158/cba/86b/158cba86b19275a627b2b4d48d4d91ac.png"><br><br>  The delay was 791 millisecond.  At a speed of one finger per second, the visualization lag will be about 75 pixels. <br><br>  We hope that after reading the article will be less elusive bugs, and all sorts of "miracles" and incomprehensible points related to the work of programs. </div><p>Source: <a href="https://habr.com/ru/post/218767/">https://habr.com/ru/post/218767/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218757/index.html">Another migration of PROXMOX to softRAID1, but now already 3.2 and on GPT partitions, installing FreeNAS 9.2 on a virtual machine and forwarding a physical disk to it</a></li>
<li><a href="../218759/index.html">Windows command line subtleties</a></li>
<li><a href="../218761/index.html">Capture video in OpenGL applications using Intel INDE Media Pack</a></li>
<li><a href="../218763/index.html">The sound on the chip AY-3-8910 (or Yamaha YM2149F) comes from the ZX Spectrum on the PC via LPT-port</a></li>
<li><a href="../218765/index.html">Have you seen your printed circuit boards under the microscope?</a></li>
<li><a href="../218769/index.html">Curiosity photographed a mysterious bright glow on Mars</a></li>
<li><a href="../218771/index.html">What is behind the print resolution? How does multibit technology work</a></li>
<li><a href="../218775/index.html">‚ÄúVirtual Vision System‚Äù for blind OrCam appeared on sale</a></li>
<li><a href="../218777/index.html">The personnel policy of the data center is laid during the design</a></li>
<li><a href="../218779/index.html">Show Sound # 8 - Podcast about audio equipment, components, formats and technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>