<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load testing in Skyforge, or Bots - server orderlies. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again, habrauzer! 

 This is the second article dedicated to testing the Skyforge server. Just in case, I remind you that Skyforge is a MMORPG, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load testing in Skyforge, or Bots - server orderlies. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Hello again, habrauzer! <br><br>  This is the second article dedicated to testing the <a href="http://skyforge.ru/">Skyforge</a> server.  Just in case, I remind you that Skyforge is a MMORPG, the server of which is designed for hundreds of thousands of players and is written in Java. <br>  Unlike the <a href="http://habrahabr.ru/company/mailru/blog/191378/">first part</a> , which deals with the role of bots, this article talks about load testing and metrics. <br><br> <a href=""><img src="https://habrastorage.org/storage3/00e/5df/e50/00e5dfe50d61f4fd9f35c82adeb02d9e.jpg"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h3>  Stress Testing </h3><br>  Habr's readers know that load testing is a collection of software performance indicators to verify compliance. <br><br>  Our requirements for such tests are quite simple: the load on the server in ‚Äúcombat‚Äù conditions should be within the normal range, and the user experience should not suffer.  Therefore, when organizing load testing, it is necessary first of all to determine what conditions to consider ‚Äúcombat‚Äù.  For example, for us this means the following: on two servers of game mechanics, one server of databases and one server with different support services, 5,000 players frolic at the same time.  Secondly, you need to determine which load is considered normal.  We believe that the server copes with the load if it spends in processing less than 20 milliseconds per server "tick". <br><br>  We have a service-oriented architecture - this means that the topology of services during the test must coincide with the topology in "combat" conditions.  The volume of content should also be close to the volume that will be on the "combat".  In general, load testing is production in miniature, where, instead of real users, there are bots. <br><br><h3>  Testing organization </h3><br>  All tests, including those using bots, are run on our project in a continuous integration system.  At the beginning of the test, the build agent updates and starts the server, starts the bots and waits for a specified time, after which it stops the server, analyzes the results and proceeds to the next test. <br><br>  Due to the fact that we are limited in resources (we have only one bot platform), we need to somehow synchronize their use.  Therefore, all tests that use bots are run on a dedicated build agent. <br><br><h3>  Night bots test </h3><br>  The main load test, during which all content is checked, goes at night for 8 hours.  Why was this duration chosen?  It was experimentally observed that the most serious mistakes occur at the turn of 4.5‚Äì6 hours, and in order to find them, we simply have to carry out such lengthy tests.  This interval accounts for FullGC-pause ( <a href="https://blogs.oracle.com/vmrobot/entry/%25D1%2581%25D0%25B1%25D0%25BE%25D1%2580%25D1%2589%25D0%25B8%25D0%25BA_%25D0%25BC%25D1%2583%25D1%2581%25D0%25BE%25D1%2580%25D0%25B0_concurrent_mark_sweep">more about this phenomenon</a> ), the fight against which is also the goal of the tests.  In our plans to implement constant tests lasting 56 hours over the weekend.  But so far, unfortunately, these are only plans. <br><br><h3>  Server </h3><br>  <i>And now I will allow myself to give some tips on the organization of load testing, in passing talking about how it works with us.</i>  <i>Yes, I understand that for some people these tips will seem like the notes of the notorious Captain, but for some they may still be useful.</i> <br><br>  The most important stage of load testing is the selection and preparation of servers for tests.  Since we have no combat servers, we chose as close as possible to those that will be at the time of the game's release.  Otherwise, it would be necessary to use servers similar to the ‚Äúcombat‚Äù. <br>  Servers must be configured exactly as they will be used in the "combat" mode.  By the way, we are considering the possibility of using the technology of <a href="http://en.wikipedia.org/wiki/Processor_affinity">Thread Affinity</a> , which allows you to assign individual processor cores to specific streams, for example, to the flows of game mechanics.  And if this technology "shoots", it will mean that this setting should be enabled when conducting load testing.  Otherwise, the server's behavior under load in a test environment and in reality will differ significantly. <br><br>  You also need to remember that on modern servers there are ‚Äúgreen environment‚Äù or ‚Äúelectricity saving‚Äù modes.  I recommend turning them off immediately, exposing the processors to full performance, because ‚Äúin battle‚Äù the servers will not have to rest, but to fix non-existent performance problems during the test in eco mode - this is a bad idea. <br><br>  It is important that you have full access to your site, so that you can go in at any time and see what is happening there, what processes are running, etc. There should not be an army of evil admins who control every thing between you and the server.  This is necessary for two reasons.  First, by setting up your stand by yourself and being responsible for its condition, you better understand the problems that may arise.  Secondly, you will have complete information about what is happening with your test site.  This is very useful when analyzing data anomalies. <br><br>  Full access also means that you are there alone.  If you do load testing, you need to make sure that the server does not have your colleague employed by the same one, and also find out if the database is backing up.  You need to be 100% sure that you are there alone. <br><br><h3>  Statistics removed </h3><br>  The easiest and most visual way to analyze load data is to visualize it.  We use the <a href="http://www.highcharts.com/">Highcharts</a> library for <a href="http://www.highcharts.com/">charting</a> , which confidently supplanted <a href="http://www.jqplot.com/">jqPlot</a> .  Let's look at the examples. <br><br><h4>  Load schedule </h4><br> <a href=""><img src="https://habrastorage.org/storage3/4cc/3ab/560/4cc3ab560ad949e3a3902b361f0fda84.png"></a> <br><br>  I see a similar schedule every morning.  It allows you to track the load.  The load on the server is a value equal to the ratio of time in milliseconds spent in processing data for 1 server ‚Äútick‚Äù to 20 milliseconds.  If on the graph the indicator is more than one (more than the norm), then everything is bad, if less - everything is good. <br><br><h4>  Memory usage graph </h4><br> <a href=""><img src="https://habrastorage.org/storage3/39d/0e4/cb0/39d0e4cb0cd4f747244399d31cbffed2.png"></a> <br><br>  This is a general graph of memory usage.  It allows you to roughly evaluate the work of the "garbage collector". <br><br><h4>  GC work schedule </h4><br> <a href=""><img src="https://habrastorage.org/storage3/e19/692/a60/e19692a6015447e9b597ba79185e473a.png"></a> <br><br>  This is probably one of the most important graphs for Java servers.  It is unlikely that players will not notice a pause during a complete garbage collection.  On it, on the Y axis, the duration of a particular phase of the garbage collector operation is marked. <br><br><div class="spoiler">  <b class="spoiler_title">The keys that we use to collect data on the work of the GC</b> <div class="spoiler_text">  -verbose: gc <br>  -XX: + PrintGCTimeStamps <br>  -XX: + PrintGCDetails <br>  -XX: + PrintGCDateStamps <br>  -XX: + PrintTenuringDistribution <br>  -XX: + PrintGCApplicationStoppedTime <br>  -XX: + PrintPromotionFailure <br>  -XX: + PrintClassHistogramBeforeFullGC <br>  -XX: + PrintClassHistogramAfterFullGC <br>  -XX: + PrintGCApplicationConcurrentTime <br></div></div><br><br><h4>  Safepoint Stops Schedule </h4><br> <a href=""><img src="https://habrastorage.org/storage3/3ea/5b8/ceb/3ea5b8ceb6a3ff2db45d33cc60e834f5.png"></a> <br><br>  Safepoint is a point in the Java Virtual Machine, where a stop occurs each time you need to collect a stack trace or to collect garbage.  Read more about safepoints <a href="http://blog.ragozin.info/2012/10/safepoints-in-hotspot-jvm.html">here</a> .  This graph shows how many milliseconds in 1 minute the server spends at these points. <br><br><h4>  Schedule of date operations </h4><br> <a href=""><img src="https://habrastorage.org/storage3/fbb/7e6/d14/fbb7e6d1426eea3bf38a8c30b04707dc.png"></a> <br><br>  But the beautiful "scarves", which were commissioned by <a href="http://habrahabr.ru/users/randll/" class="user_link">Randll</a> , whose <a href="http://habrahabr.ru/company/mailru/blog/182088/">report</a> on the databases you could read earlier.  These "scarves" allow us to evaluate which database-operations and in what quantity we are performing. <br><br>  In addition, several dozens of statisticians are logged, who can tell about high-level indicators (the number of mobs in a single player battle), and low-level indicators (the number of transmitted packets).  Most of these statisticians were instituted during investigations regarding the growth load. <br><br>  For the same purpose, using <a href="http://www.yourkit.com/docs/80/help/command_line_tool.jsp">the Yourkit API,</a> we automatically removed the memory dump and load profile at the end of the test.  Now they are analyzed only in manual mode, but it is planned to automate this process as well. <br><br><h3>  Cherry </h3><br>  At the end of the test, a so-called error analyzer is launched.  We take all the mistakes - and they sometimes go up to 100 gigabytes for the night - and put them on the shelves.  We compare which mistakes are repeated most often and which are rare, and we divide them into groups.  We sort by type ‚Äî an error, warning, or informational message ‚Äî and find out if this is a content error.  We transmit the content errors to the QA-specialists in content, and we ourselves investigate errors in the server code. <br><br> <a href=""><img src="https://habrastorage.org/storage3/df5/e9c/923/df5e9c923ef2327a1dac3b72acfbdce5.png"></a> <br><br>  The report indicates how many times and at what time intervals the error was repeated.  The number indirectly characterizes the difficulty of repeating this error, its cost for the server (do not forget that when collecting each callstack on the server, the kitten dies) and priority in the bug tracker. <br>  The time of occurrence allows you to evaluate the distribution of errors on the test time.  It's one thing if errors are spread evenly, and quite another if they begin and end in a certain time period. <br><br>  In the future, we plan to develop this system so that we can associate errors with tasks in JIRA and find a revision in which the error was noticed for the first time. <br><br><h3>  Problems </h3><br>  Load night tests have very expensive iterations.  The cost of each test is a day.  Of course, we make every effort to pass the test every night, but in reality it passes less often and iterations become even more expensive.  Any failure in any infrastructure node can disrupt the test. <br><br><h3>  Conclusion </h3><br>  Regular load testing with the use of various statistics is the best tool for healthy sleep of developers.  Now I can‚Äôt imagine how it is possible to live without this kind of testing, because thanks to him every morning I see where we have <s>a lot of</s> trouble.  It helps us move in the right direction.  Thanks for attention! <br><br>  Other materials can be viewed on <a href="http://skyforge.ru/">the Skyforge developers website</a> and in our <a href="http://vk.com/skyforgegame">Vkontakte community</a> . <br><br>  <i>Thank you for helping to create a report and writing an article for the entire Skyforge server team.</i> </div><p>Source: <a href="https://habr.com/ru/post/193452/">https://habr.com/ru/post/193452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193428/index.html">Acronis True Image 2014 - what's new?</a></li>
<li><a href="../193430/index.html">Layout letters, a set of snippets</a></li>
<li><a href="../193436/index.html">Dusk Rift - online game about the real world and real places</a></li>
<li><a href="../193442/index.html">Live Broadcast Windows Camp</a></li>
<li><a href="../193450/index.html">Electromagnetic radiation that blocks the operation of engines</a></li>
<li><a href="../193454/index.html">IBM Introduces NeXtScale System - High-Performance Computing Platform for Data Centers</a></li>
<li><a href="../193460/index.html">Automate monitoring: low-level detection</a></li>
<li><a href="../193464/index.html">Yealink and 3CX become strategic partners</a></li>
<li><a href="../193466/index.html">Competition within the team kills the team spirit</a></li>
<li><a href="../193468/index.html">Localization trends and localization of trends: a summary of Localization World-2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>