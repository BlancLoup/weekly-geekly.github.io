<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Virtual machine backup and freeze / thaw scripts InterSystems Cach√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will look at Cach√© backup strategies using external backup systems and give examples of integration with solutions based on virtual...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Virtual machine backup and freeze / thaw scripts InterSystems Cach√©</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, I will look at Cach√© backup strategies using external backup systems and give examples of integration with solutions based on virtual machine snapshots (VM snapshot, snapshot).  Most of the solutions that I come across today are deployed based on Linux and VMware, so I will give examples of solutions using VMware snapshots. </p><a name="habracut"></a><br><p>  A list of my articles from the series 'InterSystems Data Platforms and Performance' is <a href="https://community.intersystems.com/post/capacity-planning-and-performance-series-index">here</a> . </p><br><p>  For a better understanding of this article, you should also read the Cach√© online <a href="">backup and restore guide in the</a> Cach√© online documentation. </p><br><h2 id="cach-backup-batareyki-v-komplekte">  Cach√© backup: batteries included? </h2><br><p>  The built-in hot backup (Cach√© online backup) comes out of the box with Cach√© and is designed to back up Cach√© databases without stopping the system.  However, there are more efficient backup solutions that you should be aware of when you are planning to scale a large system.  External Backup (External Backup) with the use of snapshot technologies is a solution I recommend for backing up systems, including those using Cach√© databases. </p><br><h2 id="chto-neobhodimo-uchityvat-pri-vneshnem-rezervnom-kopirovanii">  What should be considered when external backup? </h2><br><p>  In InterSystems online documentation on <a href="">external backup</a> , you can find all the details of interest.  We only note the key point: </p><br><blockquote>  ‚ÄúTo ensure the integrity of the snapshot of the file system, Cach√© provides opportunities for freezing (freeze) records to the database at the time of the snapshot.  Only attempts to physically write to the database files are frozen, which allows user processes to continue to perform database updates in memory without fail. </blockquote><p>  It is also important to note that part of the process of creating a snapshot in virtualized systems causes a small pause in the operation of the virtual machine, which is commonly called fading (stun).  Usually fading lasts less than a second, so users do not notice it and it does not affect the operation of the system, however in some cases fading can last longer.  If the fade lasts longer than the QoS (Quality of service, quality of service) timeout of the Cach√© database mirroring, the backup mirror node will decide that a failure has occurred in the main system and will switch the mirror.  Later in this article I will tell you how to measure the fading time in case you need to make changes to the QoS timeout setting for mirroring. </p><br><h2 id="varianty-rezervnogo-kopirovaniya">  Backup options </h2><br><h3 id="minimalistichnoe-reshenie-dlya-rezervnogo-kopirovaniya--vstroennoe-rezervnoe-kopirovanie-cach-online-backup">  Minimalistic backup solution - integrated backup (Cach√© Online Backup) </h3><br><p>  If you are not able to use other tools, this good old way that comes with InterSystems platforms remains.  Note that Cach√© online backup backs up only Cach√© database files, storing all non-empty blocks in databases, writing them sequentially to a file.  Cach√© Online Backup supports cumulative and incremental backup. </p><br><p>  In the context of VMware, Cach√© Online Backup runs on a guest machine.  Like other similar solutions, the operations performed by Cach√© Online Backup are the same, regardless of whether the application is virtualized or runs directly on a physical server.  Accordingly, copies received by Cach√© Online Backup must be transferred to backup media along with all other files used by your application.  When backing up the system, you should remember about the application directory, the main and alternative directories of the database log, and any other directories containing the files used by the application. </p><br><p>  Cach√© Online Backup should be considered either as an entry-level approach for small projects wishing to implement an inexpensive solution for ‚Äúhot‚Äù backup of databases, or for making one-time backups.  For example, making such copies is very useful when initially setting up mirroring.  However, since databases grow in size and because Cach√© databases are usually only part of the client dataset, external backups combined with snapshot technology when using third-party utilities are recommended as the best solution with advantages such as the ability to include files in the backup other than database files, reduced recovery time, the ability to control data across the organization and the availability of improved tools for the directory  tion and management. </p><br><h3 id="rekomenduemoe-reshenie-dlya-rezervnogo-kopirovaniya-vneshnee-rezervnoe-kopirovanie">  Recommended backup solution: external backup </h3><br><p>  Consider it on the example of VMware.  Using VMware for virtualization adds new features and capabilities to protect virtual machines in general.  Solution virtualization leads the system (including the operating system) to effectively encapsulate your application with all the data inside one vmdk file (and several other files).  If necessary, these files can be very easily manipulated, and they can be used to quickly restore the entire system.  This is very different from restoring your application to bare-metal hardware, where you must repair and configure each component individually - the operating system, drivers, third-party applications, DBMS and database files, etc. </p><br><h2 id="snimok-sostoyaniya-vmware">  VMware snapshot </h2><br><p>  VMware vSphere Data Protection (VDP) and other third-party backup solutions for virtual machines, such as Veeam or Commvault, use the snapshot functions of VMware virtual machines to create backup copies.  Below is a brief explanation of how VMware snapshots work.  For more information, see the documentation. </p><br><p>  It is important to remember that snapshots are made from the entire virtual machine and that the guest operating system and any applications or DBMS are not aware that they are taking a snapshot now.  Remember also the following: </p><br><blockquote>  VMware images themselves are not backups! </blockquote><p>  Snapshots allow you to use backup software and make backups, but they are not backup copies by themselves. </p><br><p>  VDP and other third-party solutions use the process of creating VMware snapshots in conjunction with any application to manage the creation and, very importantly, the removal of snapshots.  Briefly, the sequence of events for creating an external backup using VMware snapshots is as follows: </p><br><ul><li>  Third-party backup software requests an ESXi host to take a VMware health snapshot. </li><li>  The virtual machine .vmdk files are transferred to read-only mode and a child .vmdk delta file is created for each .vmdk file of each virtual machine. </li><li>  Any write to disk occurs in the delta file of the virtual machine.  Any read operations are performed first from the delta file. </li><li>  Backup software backs up read-only parent .vmdk files </li><li>  When the backup is complete, the snapshot merges with the original file (the virtual machine disks become writable and updated blocks from the delta files are appended to the parent files). </li><li>  VMware snapshots are deleted. </li></ul><br><p>  Backup solutions also contain special features, such as Changed Block Tracking (CBT), to perform incremental or cumulative backups as quickly and efficiently as possible (which is especially important to save space).  Similar solutions usually also add other useful and important functions, such as data compression, organizing work on a schedule, restoring virtual machines with a different IP address to verify integrity, restoring both the entire virtual machine and individual files from it, managing the backup directory etc. </p><br><blockquote>  VMware snapshots that are not properly managed or left to hang for a long time can greatly reduce the free space in the storage (as changes accumulate, the delta files become more and more), and also slow down the virtual machine. </blockquote><p>  You should think very carefully before manually taking snapshots on the main database server.  Why are you doing this?  What happens if you return to the past by the time you took the picture?  What happens to all transactions between snapshot creation and rollback? </p><br><p>  If your backup software creates and deletes snapshots, this is absolutely normal.  The snapshot should only be created for a short time, and the key part of your backup strategy will be choosing the copy time when the system is at minimum load, which will further reduce the impact on users and overall performance. </p><br><h2 id="osobennosti-cach-dlya-snimkov-sostoyaniya-sistemy">  Cach√© features for system snapshots </h2><br><p>  Before taking a snapshot, the database must be quiesced: all records in the files must be completed and the database files must be in the correct state.  Cach√© provides methods and APIs for completing and then freezing (freeze) writing to the database for a short snapshot.  Only attempts to physically write to the database files are frozen during snapshot creation, which allows user processes to continue to perform updates in memory without fail.  After the snapshot was taken, the ability to write to the database is restored, the database ‚Äúthaws‚Äù (thaw), and the backup continues to be copied to the backup media.  The time between freezing and thawing should be short (no more than a few seconds). </p><br><p>  In addition to pausing recording, freezing Cach√© also changes log files and places a backup token in a log.  Writing to the log file at the same time continues normally, while writing to the physical database is frozen.  If the system crashes while the records in the physical database are frozen, the data will be restored from the log as usual at startup. </p><br><p>  The following diagram shows freezing and thawing with taking snapshots to create a backup with the correct database file. </p><br><p><img src="https://habrastorage.org/web/95f/b1c/3cf/95fb1c3cfbf743e39e9a5e27eb17770a.png"></p><br><p>  Note the short time between freezing and thawing ‚Äî this is only the time to take a snapshot, not the time it takes to copy the entire parent object to the backup. </p><br><h2 id="zamorozka-i-ottaivanie-cach">  Freezing and thawing Cach√© </h2><br><p>  vSphere allows you to automatically invoke scripts before and after creating a snapshot: these are the very moments that are called freezing and thawing of Cach√©.  Note: for proper operation of this ESXi functionality, the host requests freezing of disks through the VMware Tools from the guest operating system. </p><br><p> VMware Tools must be installed in the guest operating system.  Scripts must adhere to strict name and location requirements.  You must also assign the correct file permissions.  Script names for VMware on Linux: </p><br><pre><code class="hljs pgsql"># /usr/sbin/pre-<span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span>-script # /usr/sbin/post-thaw-script</code> </pre> <br><p>  The following are examples of freeze and thaw scripts that our team uses to back up with Veeam in our internal test labs.  These scripts should also be suitable for working with other products.  The examples were tested and used on vSphere 6 and Red Hat 7. </p><br><p>  Although these scripts can be used as examples and are an illustration of the method being described, you must ensure that they are correct for your own environment! </p><br><p>  Sample freeze script: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # # Script called by VMWare immediately prior to snapshot for backup. # Tested on Red Hat 7.2 # LOGDIR=/var/log SNAPLOG=$LOGDIR/snapshot.log echo &gt;&gt; $SNAPLOG echo "`date`: Pre freeze script started" &gt;&gt; $SNAPLOG exit_code=0 #     for INST in `ccontrol qall 2&gt;/dev/null | tail -n +3 | grep '^up' | cut -c5- | awk '{print $1}'`; do echo "`date`: Attempting to freeze $INST" &gt;&gt; $SNAPLOG # Detailed instances specific log LOGFILE=$LOGDIR/$INST-pre_post.log # Freeze csession $INST -U '%SYS' "##Class(Backup.General).ExternalFreeze(\"$LOGFILE\",,,,,,1800)" &gt;&gt; $SNAPLOG $ status=$? case $status in 5) echo "`date`: $INST IS FROZEN" &gt;&gt; $SNAPLOG ;; 3) echo "`date`: $INST FREEZE FAILED" &gt;&gt; $SNAPLOG logger -p user.err "freeze of $INST failed" exit_code=1 ;; *) echo "`date`: ERROR: Unknown status code: $status" &gt;&gt; $SNAPLOG logger -p user.err "ERROR when freezing $INST" exit_code=1 ;; esac echo "`date`: Completed freeze of $INST" &gt;&gt; $SNAPLOG done echo "`date`: Pre freeze script finished" &gt;&gt; $SNAPLOG exit $exit_code</span></span></code> </pre><br><p>  Defrost script example: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # # Script called by VMWare immediately after backup snapshot has been created # Tested on Red Hat 7.2 # LOGDIR=/var/log SNAPLOG=$LOGDIR/snapshot.log echo &gt;&gt; $SNAPLOG echo "`date`: Post thaw script started" &gt;&gt; $SNAPLOG exit_code=0 if [ -d "$LOGDIR" ]; then #     for INST in `ccontrol qall 2&gt;/dev/null | tail -n +3 | grep '^up' | cut -c5- | awk '{print $1}'`; do echo "`date`: Attempting to thaw $INST" &gt;&gt; $SNAPLOG # Detailed instances specific log LOGFILE=$LOGDIR/$INST-pre_post.log #  csession $INST -U%SYS "##Class(Backup.General).ExternalThaw(\"$LOGFILE\")" &gt;&gt; $SNAPLOG 2&gt;&amp;1 status=$? case $status in 5) echo "`date`: $INST IS THAWED" &gt;&gt; $SNAPLOG csession $INST -U%SYS "##Class(Backup.General).ExternalSetHistory(\"$LOGFILE\")" &gt;&gt; $SNAPLOG$ ;; 3) echo "`date`: $INST THAW FAILED" &gt;&gt; $SNAPLOG logger -p user.err "thaw of $INST failed" exit_code=1 ;; *) echo "`date`: ERROR: Unknown status code: $status" &gt;&gt; $SNAPLOG logger -p user.err "ERROR when thawing $INST" exit_code=1 ;; esac echo "`date`: Completed thaw of $INST" &gt;&gt; $SNAPLOG done fi echo "`date`: Post thaw script finished" &gt;&gt; $SNAPLOG exit $exit_code</span></span></code> </pre><br><p>  Do not forget to set file permissions: </p><br><pre> <code class="hljs pgsql"># sudo chown root.root /usr/sbin/pre-<span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span>-script /usr/sbin/post-thaw-script # sudo chmod <span class="hljs-number"><span class="hljs-number">0700</span></span> /usr/sbin/pre-<span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span>-script /usr/sbin/post-thaw-script</code> </pre> <br><h2 id="testirovanie-zamorozki-i-ottaivaniya">  Freeze and thaw testing </h2><br><p>  To test the operation of the above scripts, you can manually start the snapshot execution on the virtual machine and check what the script displays.  The following screenshot shows the Take VM Snapshot dialog and its options. </p><br><p><img src="https://habrastorage.org/web/18a/821/931/18a821931f3043a78d26691704c8afd3.png"></p><br><p>  <strong>Uncheck the box</strong> "Snapshot the virtual machine's memory" (Save the virtual memory of the virtual machine) <br>  <strong>Tick ‚Äã‚Äãthe checkbox</strong> "Quiesce guest file system (Needs VMware Tools installed)" (Stabilize guest file system).  This will pause the running processes in the guest operating system and reset the buffers so that the contents of the file system are in a known consistent state when the snapshot is taken. </p><br><blockquote>  <strong>Important!</strong>  After the test, do not forget to delete the taken picture! </blockquote><p>  If the quiescing checkbox is checked and the virtual machine is running while the snapshot is being taken, VMware Tools will be used to stabilize the virtual machine file system.  File system stabilization is the process of bringing data on a disk to a ‚Äúready for backup‚Äù state.  This process may include operations such as clearing the full buffers between the operating system cache in memory and the disk. </p><br><p>  The following output shows the contents of the <code>$SNAPLOG</code> log file listed in the above examples of freeze / thaw scripts after starting the backup procedure, which also takes a snapshot. </p><br><pre> <code class="hljs pgsql">Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Pre <span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> script started Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Attempting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> H20152 Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: H20152 <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> FROZEN Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Completed <span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> H20152 Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Pre <span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> script finished Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Post thaw script started Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Attempting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> thaw H20152 Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: H20152 <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> THAWED Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Completed thaw <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> H20152 Wed Jan <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> EST <span class="hljs-number"><span class="hljs-number">2017</span></span>: Post thaw script finished</code> </pre> <br><p>  This example shows that the time between freezing and thawing is 6 seconds (16:30:36 - 16:30:42).  During this period, users are not interrupted.  You will need to collect statistics from your own systems, but for information, we note that this example was launched during application performance testing on a system without ‚Äúbottlenecks‚Äù in the I / O system, which on average performed over 2 million database reads per second ( Glorefs / sec), 170,000 database writes per second (Gloupds / sec) and an average of 1100 physical disk read operations per second and 3000 records per cycle of the database write daemon (write daemon cycle). </p><br><p>  Remember that RAM is not part of the snapshot, so when restoring a backup, the virtual machine will reboot and perform recovery procedures.  Database files will be consistent.  You do not intend to ‚Äúcontinue work‚Äù from a backup copy and just want you to have the correct backup copies of files at a specific point in time.  You can then run the database logs and perform other recovery procedures necessary to restore the integrity of the application and transaction consistency after the files are restored. </p><br><p>  For additional data protection, <a href="">a log change</a> can also be performed by itself, followed by a backup or log replication, for example, hourly. <br>  The following is the contents of the <code>$LOGFILE</code> from the freeze / thaw example above, which shows the log details for the snapshot. </p><br><pre> <code class="hljs sql">01/04/2017 16:30:35: Backup.General.ExternalFreeze: Suspending <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> Journal <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> switched <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: /trak/jnl/jrnpri/h20152/H20152_20170104<span class="hljs-number"><span class="hljs-number">.011</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>: Backup.General.ExternalFreeze: <span class="hljs-keyword"><span class="hljs-keyword">Start</span></span> a journal <span class="hljs-keyword"><span class="hljs-keyword">restore</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> journal <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: /trak/jnl/jrnpri/h20152/H20152_20170104<span class="hljs-number"><span class="hljs-number">.011</span></span> Journal marker <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">197192</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> /trak/jnl/jrnpri/h20152/H20152_20170104<span class="hljs-number"><span class="hljs-number">.011</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>: Backup.General.ExternalFreeze: <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> suspended <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>: Backup.General.ExternalThaw: Resuming <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>: Backup.General.ExternalThaw: <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> resumed</code> </pre> <br><h2 id="zamiranie-virtualnoy-mashiny">  Virtual machine freeze </h2><br><p>  During the creation of a snapshot of the virtual machine, as well as after completing the backup and deleting the snapshot, the virtual machine must be frozen for a short period of time.  This short-term freeze is often referred to as stun.  A good article on virtual machine fading is <a href="http://cormachogan.com/2015/04/28/when-and-why-do-we-stun-a-virtual-machine/">here</a> .  I will set out some of the details below for the Cach√© databases. </p><br><blockquote>  Excerpt from the article: ‚ÄúTo take a snapshot of a virtual machine, the virtual machine‚Äú freezes ‚Äùto (i) serialize the state of the device to disk and (ii) close the current working disk and create the starting point of the snapshot ... When the delta files merge, the virtual machine freezes to close the discs for recording and put them into a state suitable for merging. ‚Äù </blockquote><p>  The fading time is usually about 100 milliseconds, however, with a very high write activity on the disk, during the merge phase of the delta files, the fading can last up to several seconds. </p><br><blockquote>  If the virtual machine is a primary or backup member of the Cach√© mirroring, and the fading time is longer than the QoS timeout for mirroring, the mirror may mistakenly report the failure of the primary virtual machine and initiate the interception of the mirror by the backup system. </blockquote><p>  For more information about the QoS parameter when mirroring, refer to the <a href="https://community.intersystems.com/post/documentation%5D(">documentation</a> .  Strategies that minimize fading time include choosing when to back up when database activity is as low as possible, as well as having a well-tuned storage system. </p><br><p>  As noted above, when creating a snapshot there are several options that you can specify.  One of the options allows you to enable the preservation of RAM in the snapshot.  Remember that retaining RAM is not required to back up the Cach√© database.  If the save memory flag is set, the internal state of the virtual machine will be dumped into the snapshot.  Taking a snapshot with memory takes much longer.  Snapshots are used to return to the state of the virtual machine that was at the time of the snapshot.  This is NOT required to back up the database files. </p><br><blockquote>  When a memory snapshot is taken, the state of the entire virtual machine will be <strong>frozen indefinitely</strong> . </blockquote><p>  As noted earlier, for backups, the ‚Äúconsistency‚Äù (quiesce) check box should be checked to ensure a consistent and successful backup. </p><br><h2 id="uznaem-vremya-zamiraniya-iz-zhurnalov-vmware">  We learn time of fading from VMware logs </h2><br><p>  Starting with ESXi 5.0, the fade time is recorded in the log file of each virtual machine (vmware.log) with messages similar to the following: </p><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">15</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">58.846</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">38123</span></span> us</code> </pre> <br><p>  The fading time is indicated in microseconds, so in the example above 38123 us it is 38123 / 1,000,000 seconds or 0.038 seconds. </p><br><p>  To be sure that the machine‚Äôs freezing time is within acceptable limits, or if there is a suspicion that a long time that the machine is <code>vmware.log</code> causes problems, you can download and view the <code>vmware.log</code> files from the folder of this virtual machine.  After downloading, you can open and organize the log using standard Linux commands, which we will look at in the next chapter. </p><br><h3 id="primer-zagruzki-faylov-vmwarelog">  Example of downloading vmware.log files </h3><br><p>  There are several ways to download logs, including by creating a VMware <em>support bundle</em> via the vSphere management console or via the ESXi host command line.  Refer to the VMware documentation for all the details, and the following is a simple way to create and collect a minimum package of support logs, which includes the vmware.log file, which allows you to find out the duration of a fade. </p><br><p>  You will need the long name of the directory where the virtual machine files are located.  Log in to ssh on the ESXi host where the virtual machine with the database is running and run the <code>vim-cmd vmsvc/getallvms</code> to get a list of vmx files and their unique long names associated with them. </p><br><p>  An example of a long name for a virtual machine database mentioned in this article will look like this: </p><br><pre> <code class="hljs">26 vsan-tc2016-db1 [vsanDatastore] e2fe4e58-dbd1-5e79-e3e2-246e9613a6f0/vsan-tc2016-db1.vmx rhel7_64Guest vmx-11</code> </pre> <br><p>  Next, run the command to collect log files: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">vm-support</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-a</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">VirtualMachines</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:logs</span></span></code> </pre> <br><p>  The command will display the location of the created support package, for example: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">To</span></span> see the files collected, <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-string"><span class="hljs-string">'/vmfs/volumes/datastore1 (3)/esx-esxvsan4.iscinternal.com-2016-12-30--07.19-9235879.tgz'</span></span></code> </pre> <br><p>  Now you can pick up files from the host for further processing and analysis using the sftp protocol. <br>  In this example, after unpacking the support package, you can follow the paths corresponding to the long database names of the virtual machines.  For example, in this case: </p><br><pre> <code class="hljs pgsql">&lt;bundle <span class="hljs-type"><span class="hljs-type">name</span></span>&gt;/vmfs/volumes/&lt;host long <span class="hljs-type"><span class="hljs-type">name</span></span>&gt;/e2fe4e58-dbd1<span class="hljs-number"><span class="hljs-number">-5e79</span></span>-e3e2<span class="hljs-number"><span class="hljs-number">-246e9613</span></span>a6f0.</code> </pre> <br><p>  There you will see several numbered log files.  The latest file has no number, it is vmware.log.  The magazine can be no more than 100 KB, but it will contain a lot of information.  Since we are simply looking for moments of beginning and end of fading, they are fairly easy to find using the grep utility, for example: </p><br><pre> <code class="hljs ruby">$ grep Unstun vmware.log <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T21:</span></span><span class="hljs-number"><span class="hljs-number">30</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">19.662</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">1091706</span></span> us --- <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">15</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">58.846</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">38123</span></span> us <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">15</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">59.573</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">298346</span></span> us <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">03</span></span>.<span class="hljs-number"><span class="hljs-number">672</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">301099</span></span> us <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">06</span></span>.<span class="hljs-number"><span class="hljs-number">471</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">341616</span></span> us <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">24.813</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">264392</span></span> us <span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-symbol"><span class="hljs-symbol">T22:</span></span><span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">30.921</span></span>Z<span class="hljs-params"><span class="hljs-params">| vcpu-0|</span></span> <span class="hljs-symbol"><span class="hljs-symbol">I125:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">Checkpoint_Unstun:</span></span> vm stopped <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">221633</span></span> us</code> </pre> <br><p>  In the example, we see two groups of fading.  The first one consists of the moment of creating snapshots, and the second - after 45 minutes for each disk when the image is merged (for example, after the backup software has finished copying the main vmx file).  In the example above, we can see that most of the fading does not exceed a second, although the initial fading is just over one second. </p><br><p>  Short fading is not noticeable to the end user.  However, system processes, such as, for example, Cach√© mirroring, constantly monitor whether the base is ‚Äúlive‚Äù.  If the fading time exceeds the QoS timeout for mirroring, the node may be considered non-contact and ‚Äúdead‚Äù, and an emergency will be handled. </p><br><p>  <em>Tip:</em> for a review of all logs or troubleshooting, it‚Äôs convenient to use the grep command to find all the fading times and then format them using the awk utility and sort them like in the following example: </p><br><pre> <code class="bash hljs">grep Unstun vmware* | awk <span class="hljs-string"><span class="hljs-string">'{ printf ("%'</span></span><span class="hljs-string"><span class="hljs-string">"'"</span></span><span class="hljs-string"><span class="hljs-string">'d", $8)} {print " ---" $0}'</span></span> | sort -nr</code> </pre> <br><h2 id="itog">  Total </h2><br><p>  You should regularly monitor your system during normal operation in order to know and understand the amount of fading time and how it can affect the means of ensuring high availability, such as mirroring.  As noted earlier, strategies aimed at minimizing fading time include running backups, when database and storage activity is low and when storage performance is maximum.  For continuous monitoring logs can be processed using VMware Log insight or other tools. </p><br><p>  I will return to backup operations for InterSystems data platforms in future articles.  And now if you have comments or suggestions based on the processes occurring in your systems, share them in the comments. </p><br><p>  <em>Translator‚Äôs note:</em> since we are working with the author in the same office, I can give him your questions and send his answers here.  Also, the discussion in English is in the <a href="https://community.intersystems.com/post/intersystems-data-platforms-and-performance-%25E2%2580%2593-vm-backups-and-cach%25C3%25A9-freezethaw-scripts">original article</a> on the InterSystems Developer Community. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/334144/">https://habr.com/ru/post/334144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334134/index.html">BIT-picnic sip of summer and useful information</a></li>
<li><a href="../334136/index.html">Random forest vs neural network: who will better cope with the task of recognizing gender in speech (part 1)</a></li>
<li><a href="../334138/index.html">Work with servlets for dummies. GET / POST</a></li>
<li><a href="../334140/index.html">Kubernetes success stories in production. Part 1: 4200 pods and TessMaster on eBay</a></li>
<li><a href="../334142/index.html">Quick removal of spaces from strings on ARM processors - alternative analysis</a></li>
<li><a href="../334146/index.html">A simple family budget tracker with AWS SES, Lambda and DynamoDB (and Route53)</a></li>
<li><a href="../334148/index.html">Enjoy! Isolate authentication server in open source</a></li>
<li><a href="../334150/index.html">Welcome to Tarantool Meetup August 10th</a></li>
<li><a href="../334152/index.html">Innovations of the main Russian Robotic Olympiad in the official video</a></li>
<li><a href="../334154/index.html">Experience of using FPGA boards DE10-Standard and DMA PL330</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>