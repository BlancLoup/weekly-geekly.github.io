<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expansion of system (and not only) tables in MODX Revolution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the moment I am engaged in alteration of one news portal on MODX Revolution. Since the attendance on the site is up to 100,000 people per day, the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expansion of system (and not only) tables in MODX Revolution</h1><div class="post__text post__text-html js-mediator-article">  At the moment I am engaged in alteration of one news portal on MODX Revolution.  Since the attendance on the site is up to 100,000 people per day, the question of productivity here is one of the most important.  Taking into account the fact that currently there are more than 75,000 articles in the database, the site‚Äôs brakes are almost guaranteed with the wrong (and even with the traditional MODX approach to development), and if the frequency of visits exceeds the query execution time, the server will generally fall.  Here are some of the techniques involved here for solving these problems, and I will describe in this article. <a name="habracut"></a><br><br><h2>  1. Long generation of cache. </h2><br>  Surely many people know that when updating the MODX cache, it goes through all the documents and stuffs the resource map into the context cache.  If someone does not know, I wrote about it in detail <a href="http://modxclub.ru/blog/139.html">here</a> .  And although in MODX, starting from version 2.2.7 (or around that), it is possible to disable resource map caching in the settings (system setting <strong>cache_alias_map</strong> ) this problem is only partially solved - MODX does not cache document URLs, but the structure with ID-schnick digits anyway going through all the documents from the database.  This leads to the fact that, firstly, the context cache file grows, and secondly, the script may simply not run in 30 seconds and the cache file will be beaten, which can generally lead to fatal errors and make the site inoperable. <br><br>  But even if the server is still able to pull all the documents and stuff everything into the cache, let's look at the comparative figures for one request with different settings.  These numbers will be very relative for much depends on the server settings and on different servers the memory consumption of the same site will be different, but in comparison these figures will give an idea of ‚Äã‚Äãthe difference of states.  To estimate the memory consumption, I will call getdata processor to receive 10 articles. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, <strong>option one:</strong> Full resource map caching is enabled. <br><blockquote>  Context cache file size: 5,792,604 bytes. <br>  Memory consumption upon request: 28.25 Mb <br>  Time: 0.06-0.1 sec. </blockquote><br><br>  <strong>Option two:</strong> Full resource map caching is disabled (system setting <strong>cache_alias_map</strong> == false). <br><blockquote>  Context cache file size: 1,684,342 bytes. <br>  Memory consumption upon request: 15,5 Mb <br>  Time: 0.03-0.06 seconds. </blockquote><br><br>  <strong>Option Three:</strong> Caching of the resource map with the <a href="http://modx.com/extras/package/cacheoptimizer">cacheOptimizer</a> patch is <a href="http://modx.com/extras/package/cacheoptimizer">completely disabled</a> . <br><blockquote>  Context cache file size: 54,945 bytes. <br>  Memory consumption upon request: 4.5 Mb <br>  Time: 0.02-0.03 seconds </blockquote><br><br>  And that's just 75,000 resources.  On hundreds of thousands, the difference will be much more palpable. <br><br>  There are of course here and cons.  For example, Wayfinder, which builds a menu based on alias map data, will not work.  Here you have to collect the menu itself.  I most often use the menu processor I wrote about <a href="http://modxclub.ru/blog/modx-club-portfolio/153.html">here</a> (see section <strong>2. Replacing Wayfinder</strong> ). <br><br><h2>  2. Poor performance due to TV-parameters of documents. </h2><br>  But this is the main and most interesting reason for writing this topic.  There are probably no MODX-developers who did not use TV-field <s>TVs</s> .  They solve two problems at once: 1. add custom fields to documents; 2. provide different interfaces for editing them depending on the type of field. <br><br>  But they also have a serious disadvantage - they are all stored in the same table.  This adds several problems at once: <br><br>  <strong>1. You cannot control the uniqueness of values ‚Äã‚Äãat the database level.</strong> <br><br>  <strong>2. You can not use different data types for different TV-fields.</strong>  All data of TV-fields are contained in a single column <strong>value</strong> with the data type mediumtext.  That is, we cannot use more data, and we will store numeric values ‚Äã‚Äãas lower-case (which imposes additional requirements on the formation of a query with sorting), and we do not have to compare the data from different columns and many, many more unpleasant because of this. <br><br>  <strong>3. Poor performance when sampling from several tables.</strong>  For example, we have several TV-fields for one document, of which at least 2-3 fields are almost always filled.  We want to get in the request immediately the data and documents and fields to them.  We have two main options for forming a request for this: <br><br>  <strong>1. Simply add a table of TV-NIS.</strong> <br><pre><code class="php hljs">$q = $modx-&gt;newQuery(<span class="hljs-string"><span class="hljs-string">"modResource"</span></span>); $alias = $q-&gt;getAlias(); $q-&gt;leftJoin(<span class="hljs-string"><span class="hljs-string">"modTemplateVarResource"</span></span>, <span class="hljs-string"><span class="hljs-string">"tv"</span></span>, <span class="hljs-string"><span class="hljs-string">"tv.contentid = {$alias}.id"</span></span>); $c-&gt;select(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"tv.*"</span></span>, <span class="hljs-string"><span class="hljs-string">"{$alias}.*"</span></span>, ));</code> </pre> <br>  But there is a serious disadvantage: in the resulting table we get C * TV number of records, where C is the number of records in site_content, and TV is the number of records in the table site_tmplvar_contentvalues ‚Äã‚Äãfor each document separately.  That is, if we have, for example, 100 document recordings and 3 TV recordings for each document (on average), we will end up with 100 * 3 = 300 recordings. <br><br>  Since, for this reason, as a result, there was more than one resultant record per document, it is necessary to further process the data at the PHP level in order to form unique data.  This <a href="https://github.com/MODX-Club/modxSite/blob/04604a37ebc59ebe4d73f7f89c9c1fdd51fe239a/core/components/modxsite/processors/site/web/getdata.class.php">is what</a> we get <a href="https://github.com/MODX-Club/modxSite/blob/04604a37ebc59ebe4d73f7f89c9c1fdd51fe239a/core/components/modxsite/processors/site/web/getdata.class.php">in the getdata processor</a> .  And it also increases the load and increases the execution time. <br><br>  Here I have in this news portal just had an average of 3 main entries per document.  As a result, ~ 225,000 TV records.  Even with query optimization, performing with conditions took 1-4 seconds, which is very long. <br><br>  <strong>2. Join each TV field separately.</strong> <br>  Sample request: <br><pre> <code class="php hljs">$q = $modx-&gt;newQuery(<span class="hljs-string"><span class="hljs-string">"modResource"</span></span>); $alias = $q-&gt;getAlias(); $q-&gt;leftJoin(<span class="hljs-string"><span class="hljs-string">"modTemplateVarResource"</span></span>, <span class="hljs-string"><span class="hljs-string">"tv1"</span></span>, <span class="hljs-string"><span class="hljs-string">"tv1.tmplvarid = 1 AND tv1.contentid = {$alias}.id"</span></span>); $q-&gt;leftJoin(<span class="hljs-string"><span class="hljs-string">"modTemplateVarResource"</span></span>, <span class="hljs-string"><span class="hljs-string">"tv2"</span></span>, <span class="hljs-string"><span class="hljs-string">"tv2.tmplvarid = 2 AND tv2.contentid = {$alias}.id"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ......... $c-&gt;select(array( "tv1.value as tv1_value", "tv2.value as tv2_value", "{$alias}.*", ));</span></span></code> </pre><br>  Such a query will work out faster, because the result table will have as many records as document records, but still the load will not be small when the count of records goes to tens and hundreds of thousands, and the number of TV-shecks will be over a dozen (after all, each TV the scale is a plus of another table joining). <br><br>  Of course, the best option in this case is storing the TV values ‚Äã‚Äãin the site_content system table itself, that is, each value is stored in a separate column of this table. <br><br>  If anyone thinks that this is another lesson on the subject CRC, then this is not quite so.  Traditionally, we were taught to expand the existing classes with our own and add the columns we need there (or even prescribe our own table).  But this path is not optimal.  The main problem here is that we are somehow expanding the class, but not changing it.  Extensions concern only the expanding (and not the expanding) class, as well as those extending classes that will extend our class.  Confusing, but difficult to say easier.  Will explain.  We have a base class of modResource.  It is extended by the modDocument, modWebLink, modSimLink, etc. classes.  All of them inherit from modResource map table.  If we expand the modResource class with our class, then there will be new columns in our class that we will add, but they will not be in the modDocument class, since it does not extend our class.  In order for information about new columns to appear in all classes extending modResource, this information must be in the modResource class itself.  But how to do it without touching the system files themselves? .. In fact, I wrote about this partly more than two years ago (I <a href="http://modxclub.ru/topics/klassyi-dlya-rabotyi-s-bazoj-dannyix-na-letu-1607.html">moved the</a> article <a href="http://modxclub.ru/topics/klassyi-dlya-rabotyi-s-bazoj-dannyix-na-letu-1607.html">here</a> ), but only now I implemented it in combat mode.  We do this: <br><br>  1. Create a new component that will be loaded as extensionPackage (wrote about it in detail <a href="http://modxclub.ru/blog/115.html">here</a> ). <br><br>  2. Create new columns in the site_content table via phpMyAdmin or something like that. <br><br>  3. Using the CMPGenerator, we generate a separate package with the site_content table map.  In this map there will be a description of your new columns and tables. <br><br>  4. We register the data of your columns and indexes in your package in the metadata.mysql.php file (an example of such a file <a href="https://github.com/MODX-Club/ShopModxBox/blob/master/core/components/billing/model/billing/metadata.mysql.php">can be seen</a> in our assembly ShopModxBox). <div class="spoiler">  <b class="spoiler_title">For example, I have this file looks like this</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $custom_fields = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"modResource"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"fields"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"article_type"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"defaultValue"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"metaData"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'dbtype'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'tinyint'</span></span>, <span class="hljs-string"><span class="hljs-string">'precision'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3'</span></span>, <span class="hljs-string"><span class="hljs-string">'attributes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'unsigned'</span></span>, <span class="hljs-string"><span class="hljs-string">'phptype'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'integer'</span></span>, <span class="hljs-string"><span class="hljs-string">'null'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">'index'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'index'</span></span>, ), ), <span class="hljs-string"><span class="hljs-string">"image"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"defaultValue"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"metaData"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'dbtype'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'varchar'</span></span>, <span class="hljs-string"><span class="hljs-string">'precision'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'512'</span></span>, <span class="hljs-string"><span class="hljs-string">'phptype'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-string"><span class="hljs-string">'null'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, ), ), ), <span class="hljs-string"><span class="hljs-string">"indexes"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'article_type'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'alias'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'article_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'primary'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'unique'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'BTREE'</span></span>, <span class="hljs-string"><span class="hljs-string">'columns'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'article_type'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'length'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'collation'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'A'</span></span>, <span class="hljs-string"><span class="hljs-string">'null'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, ), ), ), ), ), ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($custom_fields <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $class =&gt; $class_data){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($class_data[<span class="hljs-string"><span class="hljs-string">'fields'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $field =&gt; $data){ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;map[$class][<span class="hljs-string"><span class="hljs-string">'fields'</span></span>][$field] = $data[<span class="hljs-string"><span class="hljs-string">'defaultValue'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;map[$class][<span class="hljs-string"><span class="hljs-string">'fieldMeta'</span></span>][$field] = $data[<span class="hljs-string"><span class="hljs-string">'metaData'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($class_data[<span class="hljs-string"><span class="hljs-string">'indexes'</span></span>])){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($class_data[<span class="hljs-string"><span class="hljs-string">'indexes'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $index =&gt; $data){ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;map[$class][<span class="hljs-string"><span class="hljs-string">'indexes'</span></span>][$index] = $data; } } }</code> </pre></div></div><br>  Read it carefully.  It adds information about two columns and one index to the site_content table. <br><br>  Let's make sure the columns were actually added.  Run this code in the console: <br><pre> <code class="php hljs">$o = $modx-&gt;newObject(<span class="hljs-string"><span class="hljs-string">'modDocument'</span></span>); print_r($o-&gt;toArray());</code> </pre><br><br>  We will see the following result: <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [id] =&gt; [type] =&gt; document [contentType] =&gt; text/html [pagetitle] =&gt; [longtitle] =&gt; <span class="hljs-comment"><span class="hljs-comment">//      //       [article_type] =&gt; [image] =&gt; )</span></span></code> </pre><br><br>  Now we can work with the system table with our custom fields.  For example, you can write this: <pre> <code class="php hljs">$resource = $modx-&gt;getObject(<span class="hljs-string"><span class="hljs-string">'modResource'</span></span>, $id); $resource-&gt;article_type = $article_type; $resource-&gt;save();</code> </pre><br>  In the table for this document will be recorded our value. <br><br><h4>  Creating your own columns and indexes on pure MODX. </h4><br>  It is clear that with this approach we have the problem of migration from such a custom site to a pure MODX, because there are no our custom fields and indices in the tables.  But in fact, this is not a problem at all.  The fact is that as we generate a map from tables, we can also create tables, columns and indexes from map descriptions of classes.  Creating a column or index is very simple: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//       $manager = $modx-&gt;getManager(); //   $manager-&gt;addField($className, $fieldName); //   $manager-&gt;addIndex($className, $fieldName);</span></span></code> </pre><br>  In this case, it is not necessary to specify any data of columns and indexes except their names.  XPDO will receive this data from our map and use it when creating the described column or index. <br><br>  If you assemble your component into a normal installation package, then you can directly write a script there so that when you install the package, your custom columns and indices are immediately created in the tables. <br><br><h4>  Rendering your custom data in TV-fields when editing documents. </h4><br>  As I said above, the convenience of TV-NIS is that various control elements are created for them (text fields, drop-down lists, checkboxes, radio boxes, etc.).  Plus, in the native form editor, you can demarcate the rights to certain TV fields, so that someone can‚Äôt see / edit private fields.  <em>In fact, it is possible, if you really want to, but still private fields will not be a callous to the eyes of someone who does not like.</em>  And it‚Äôs just that I don‚Äôt want to lose these mechanisms, because otherwise I‚Äôll have to set up my own interfaces to manage this data, which is very labor-intensive.  I would like to use the native resource editor to edit such data.  There is no perfect mechanism here, but I have worked a less suitable option.  Its meaning is to substitute a TV-field with its custom value at the time of the plug-in editing document form, while saving the document to intercept the TV-shki data and save this data into our custom fields.  Unfortunately, it does not work here as it should be (it‚Äôs just because the API doesn‚Äôt allow it), so we cannot affect the data transmitted to the document processor, which means that TVshi data will still be written to the TVs table, but this is not a problem - just after saving the document automatically, let's clean this label and that's it.  Here is an example of a plugin that triggers three events (1. rendering the document editing form with TV field substitution and custom data, 2. receiving data and changing the document object before saving it, 3. cleaning unnecessary data). <div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/* OnBeforeDocFormSave OnDocFormSave OnResourceTVFormRender */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>($modx-&gt;event-&gt;name){ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'OnResourceTVFormRender'</span></span>: $categories = &amp; $scriptProperties[<span class="hljs-string"><span class="hljs-string">'categories'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($categories <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $c_id =&gt; &amp; $category){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($category[<span class="hljs-string"><span class="hljs-string">'tvs'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp; $tv){ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($tv-&gt;id == <span class="hljs-string"><span class="hljs-string">'1'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($document = $modx-&gt;getObject(<span class="hljs-string"><span class="hljs-string">'modResource'</span></span>, $resource)){ $q = $modx-&gt;newQuery(<span class="hljs-string"><span class="hljs-string">'modResourceTag'</span></span>); $q-&gt;select(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"GROUP_CONCAT(distinct tag_id) as tags"</span></span>, )); $q-&gt;where(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"resource_id"</span></span> =&gt; $document-&gt;id, )); $tags = $modx-&gt;getValue($q-&gt;prepare()); $value = str_replace(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">"||"</span></span>, $tags); $tv-&gt;value = $value; $tv-&gt;relativeValue = $value; $inputForm = $tv-&gt;renderInput($document, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>=&gt; $tv-&gt;value)); $tv-&gt;set(<span class="hljs-string"><span class="hljs-string">'formElement'</span></span>,$inputForm); } } <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($tv-&gt;id == <span class="hljs-number"><span class="hljs-number">2</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($document = $modx-&gt;getObject(<span class="hljs-string"><span class="hljs-string">'modResource'</span></span>, $resource)){ $tv-&gt;value = $document-&gt;image; $tv-&gt;relativeValue = $document-&gt;image; $inputForm = $tv-&gt;renderInput($document, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>=&gt; $tv-&gt;value)); $tv-&gt;set(<span class="hljs-string"><span class="hljs-string">'formElement'</span></span>,$inputForm); } } <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($tv-&gt;id == <span class="hljs-number"><span class="hljs-number">12</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($document = $modx-&gt;getObject(<span class="hljs-string"><span class="hljs-string">'modResource'</span></span>, $resource)){ $tv-&gt;value = $document-&gt;article_status; $tv-&gt;relativeValue = $document-&gt;article_status; $inputForm = $tv-&gt;renderInput($document, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>=&gt; $tv-&gt;value)); $tv-&gt;set(<span class="hljs-string"><span class="hljs-string">'formElement'</span></span>,$inputForm); } } } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    case 'OnBeforeDocFormSave': $resource = &amp; $scriptProperties['resource']; /* .            active = 0.      active = 1.      OnDocFormSave       */ if(isset($resource-&gt;tv1)){ $tags = array(); foreach((array)$resource-&gt;Tags as $tag){ $tag-&gt;active = 0; $tags[$tag-&gt;tag_id] = $tag; } // $tags = array(); if(!empty($resource-&gt;tv1)){ foreach((array)$resource-&gt;tv1 as $tv_value){ if($tv_value){ if(!empty($tags[$tv_value])){ $tags[$tv_value]-&gt;active = 1; } else{ $tags[$tv_value] = $modx-&gt;newObject('modResourceTag', array( "tag_id" =&gt; $tv_value, )); } } } } $resource-&gt;Tags = $tags; $tags_ids = array(); foreach($resource-&gt;Tags as $tag){ if($tag-&gt;active){ $tags_ids[] = $tag-&gt;tag_id; } } $resource-&gt;tags = ($tags_ids ? implode(",", $tags_ids) : NULL); } /*   */ if(isset($resource-&gt;tv2)){ $resource-&gt;image = $resource-&gt;tv2; } /*   */ if(isset($resource-&gt;tv12)){ $resource-&gt;article_status = $resource-&gt;tv12; } break; /*   */ case 'OnDocFormSave': $resource =&amp; $scriptProperties['resource']; /*      */ $modx-&gt;removeCollection('modResourceTag',array( 'active' =&gt; 0, 'resource_id' =&gt; $resource-&gt;id, )); /*  TV-,         TV-,        */ $modx-&gt;removeCollection('modTemplateVarResource',array( 'tmplvarid:in' =&gt; array( 1, //  2, //  12, //  ), 'contentid' =&gt; $resource-&gt;id, )); break; }</span></span></code> </pre></div></div><br><br>  Thanks to this plugin, custom data is rendered in the document editing form and processed when it is saved. <br><br><h2>  Total </h2><br>  Of the 225+ thousand entries in the table of additional fields, only 78 remain. Of course, not all of the TVs will appear in the system table (but only those used for searching and sorting), and some data will of course be in the table of TV fields, but the load nevertheless seriously decreased, and requests became simpler. <br><br>  <strong>UPD:</strong> A more universal <a href="https://gist.github.com/Fi1osof/531aa919507bcd7cd356">plugin for rendering and processing tvsh</a> to. </div><p>Source: <a href="https://habr.com/ru/post/253737/">https://habr.com/ru/post/253737/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253723/index.html">We print stories from Medium</a></li>
<li><a href="../253725/index.html">Antifraud. Fast, cheap ... great (part 1)</a></li>
<li><a href="../253727/index.html">Pwn2Own 2015: results</a></li>
<li><a href="../253729/index.html">Using Microsoft Active Accessibility technology to access browser content</a></li>
<li><a href="../253731/index.html">Antifraud. Functional and non-functional requirements (part 2)</a></li>
<li><a href="../253739/index.html">Crowdin: anesthetic for localization</a></li>
<li><a href="../253741/index.html">Low Cost SAN Storage on LSI Syncro Part 2</a></li>
<li><a href="../253743/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ152 (March 16 - 22, 2015)</a></li>
<li><a href="../253745/index.html">Creating full-fledged applications on Max 7. Part 1 - Task setting, visual programming</a></li>
<li><a href="../253749/index.html">RAII and unhandled exceptions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>