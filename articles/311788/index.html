<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Convert Method Reference to Method in Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine that we have a Function<A, B> foo = SomeClass::someMethod; object Function<A, B> foo = SomeClass::someMethod; This is a lambda, which is guara...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Convert Method Reference to Method in Java</h1><div class="post__text post__text-html js-mediator-article"><p> Imagine that we have a <code>Function&lt;A, B&gt; foo = SomeClass::someMethod;</code> object <code>Function&lt;A, B&gt; foo = SomeClass::someMethod;</code>  This is a lambda, which is guaranteed to be a link to a non-static method.  How can one get from the <code>foo</code> object an instance of the <code>Method</code> class corresponding to the written method? </p><br><p>  If in short, then in no way, information about a specific method is stored exclusively in bytecode (I do not take into account all the instrumentation there).  But this does not prevent us in certain cases to get what we want to bypass. </p><br><a name="habracut"></a><br><p>  So, our goal is a method: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;A, B&gt; <span class="hljs-function"><span class="hljs-function">Method </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unreference</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Function&lt;A, B&gt; foo)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p>  which could be used as follows: </p><br><pre> <code class="java hljs">Method m = unreference(SomeClass::someMethod)</code> </pre> <br><p>  The first thing to start with is to look directly at the class to which the method belongs.  That is, for the <code>Function&lt;A, B&gt;</code> you need to find a specific <code>A</code>  Usually, if we have a parameterized type and its concrete implementation, we can find the values ‚Äã‚Äãof the parameter types by calling <code>getGenericSuperClass()</code> on the specific implementation.  For good, this method should return us an instance of the <code>ParameterizedType</code> class, which is already provided by an array of specific types via the <code>getActualTypeArguments()</code> call. </p><br><pre> <code class="java hljs">Type genericSuperclass = foo.getClass().getGenericSuperclass(); Class actualClass = (Class) ((ParameterizedType) genericSuperclass).getActualTypeArguments()[<span class="hljs-number"><span class="hljs-number">0</span></span>];</code> </pre> <br><p>  But with lambdas such a trick does not work - runtime for the sake of simplicity and efficiency scores on these details and in fact gives us an object of type <code>Function&lt;Object, Object&gt;</code> (in such a situation there is no need to generate bridge methods and all sorts of metadata).  GenericSuperclass for it coincides with just the superclass, and the above code will not work. </p><br><p>  For us, this is certainly not the best news, but all is not lost, since the implementation of apply (or any other "functional" method) for lambdas looks like this: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object param)</span></span></span><span class="hljs-function"> </span></span>{ SomeClass cast = (SomeClass) param; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> invokeSomeMethod(cast); }</code> </pre> <br><p>  It is this cast that we need, since this is one of the few places that actually stores information about the type (the second such place is the method called in the next line).  What happens if I apply an object of the wrong class to apply?  True, <code>ClassCastException</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { foo.apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassCastException e) { <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p>  The message in our exception will look like this: <code>java.lang.Object cannot be cast to sample.SomeClass</code> (at least in the tested version of the JRE, the specification on the subject of this message says nothing).  Unless this is a method of the Object class, then we cannot guarantee anything, alas. </p><br><p>  Knowing the name of the class, we can easily get the corresponding instance of the class <code>Class</code> .  Now it remains to get the name of the method.  This is already more difficult, since information about the method, as mentioned earlier, is only in bytecode.  If we had our own copy of the class SomeClass, whose method calls we could track, then we could pass it to apply and see what caused it (calling the stack of calls or something else). </p><br><p>  The first thing that comes to my mind is, of course, <code>java.lang.reflect.Proxy</code> , but it introduces a new and very strong limitation - SomeClass must be an interface so that we can generate a proxy for it.  On the other hand, the code thus turns out to be absolutely elementary - we create a proxy, call <code>apply</code> and inside the <code>invoke</code> method of our <code>InvocationHandler</code> object we get a ready-made <code>Method</code> , which we wanted to find! </p><br><p>  The full code looks like this.  I naturally do not recommend using it in real projects. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Pattern classNameExtractor = Pattern.compile(<span class="hljs-string"><span class="hljs-string">"cannot be cast to (.*)$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;A, B&gt; <span class="hljs-function"><span class="hljs-function">Method </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unreference</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Function&lt;A, B&gt; reference)</span></span></span><span class="hljs-function"> </span></span>{ Function erased = reference; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { erased.apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassCastException cce) { Matcher matcher = classNameExtractor.matcher(cce.getMessage()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (matcher.find()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Class&lt;?&gt; iface = Class.forName(matcher.group(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iface.isInterface()) { AtomicReference&lt;Method&gt; resultHolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AtomicReference&lt;&gt;(); Object obj = Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[]{iface}, (proxy, method, args) -&gt; { resultHolder.set(method); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { erased.apply(obj); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable ignored) { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resultHolder.get(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException ignored) { } } } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Something's wrong"</span></span>); }</code> </pre> <br><p>  You can check it like this (a separate variable is needed because Java does not always cope with type inference): </p><br><pre> <code class="java hljs">Function&lt;List, Integer&gt; size = List::size; System.out.println(unreference(size));</code> </pre> <br><p>  This code will correctly execute and output <code>public abstract int java.util.List.size()</code> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311788/">https://habr.com/ru/post/311788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311774/index.html">Unofficial supplement to the article about MegaFon's bank card</a></li>
<li><a href="../311778/index.html">The best vacancies on My Circle for the week, September 19-25</a></li>
<li><a href="../311780/index.html">RDP Disable system, function keys. Windows 2008R2</a></li>
<li><a href="../311782/index.html">Numbers grow: attack at 620 Gbps registered</a></li>
<li><a href="../311784/index.html">Understanding Veeam SureBackup</a></li>
<li><a href="../311790/index.html">Speech analytics as a tool for managing KPI contact center. Case "Rostelecom"</a></li>
<li><a href="../311792/index.html">JUG.ru Group's internal kitchen: how is the conference for 1000 programmers done</a></li>
<li><a href="../311794/index.html">Gamification aka gamification in business</a></li>
<li><a href="../311796/index.html">Banking Trojan Qadars returned and attacks banks in the UK</a></li>
<li><a href="../311800/index.html">Design as a coder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>