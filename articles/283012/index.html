<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of using contracts in REST API calls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are two irreconcilable camps of software developers: the first one says that the more an application crashes, the better it works. The second is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of using contracts in REST API calls</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/49d/507/3f5/49d5073f5cbb42b28a3ea0a6f544a6ed.png"><br>  There are two irreconcilable camps of software developers: the first one says that the more an application crashes, the better it works.  The second is that the programmer is smart enough to handle any abnormal situation.  A characteristic feature of the former is the abundance of Asset directives in the code, while the latter, even addition operations, are placed in a try - catch block.  Moreover, both camps call this kind of approach "contract programming".  The arguments of the first are reduced to an <a href="https://en.wikipedia.org/wiki/Design_by_contract">article in Wikipedia</a> , the arguments of the second - to the book <a href="https%253A%252F%252Fvk.com%252Fdoc9385624_274277026%253Fhash%253Da351256a10ddc59413%2526dl%253Ddd173388cd78d0a62c%26usg%3DAFQjCNECs7yZHziKhrl6bWLa-jkn6nSFGA%26sig2%3DqfmmJIMMvOukp6x9iDIj9w">Feel the Class by Bertrand Meyer</a> . <br><br>  As part of a scientific study, it would be correct to consider the whole variety of approaches to the protective mechanisms of programming, especially those in the title of this article, however, I would like to demonstrate only one of the possibilities that the second camp has. <br><a name="habracut"></a><br>  The main message is this: <i><b>If an exception arises in an application, then we pretend that the operation that led to it did not cause it at all.</b></i>  Well, in any case, it will look like this from the point of view of the product user.  In addition, we add an important limitation here - we are talking <b>exclusively about client-server interaction</b> . <br><br>  The practical aspect is this: When a REST response comes from the server that we cannot process due to data integrity problems (values ‚Äã‚Äãhave wrong ranges, no required fields, etc.), we simply ignore the call and don‚Äôt try to parse it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the sake of fairness, it must be said that there are libraries that produce document-object transformations on the resulting JSON / XML object.  The downside of their medal is that, as a rule, such an approach makes the use of the CoreData model unviable, since two model logics are required: a document-object transformation (JSON -&gt; Binary Objects) and an object-relational transformation (Binary Objects -&gt; CoreData Entities), support both logic, and do synchronization between them - I do not want anyone. <br><br>  The usual client-server interaction process is as follows: <br><ol><li>  We form a request to the server with the available parameters (request) </li><li>  Make a request for a given url </li><li>  We get a response </li><li>  We retrieve from the answer data (parsing) </li></ol><br><br>  As a rule in the process of parsing we are waiting for surprises, because not everything that comes from the server is trustworthy.  You have to check each parameter for type matching, band ownership, key validity, etc., and this significantly increases the code of the parsing method, especially if the resulting hierarchical structure has many nesting levels and different data types (arrays, dictionaries, etc.) validating each of the parameters suggests the logic of validation at least in a separate method.  This will make the approach somewhat more flexible: <br>  <b>We get a response.</b>  <b>Validate the response.</b>  <b>If the validation was successful, we do the parsing, otherwise we do nothing (or issue a notification to the server / user).</b> <br>  It‚Äôs no secret that JSON is at the heart of the REST interaction.  Those who prefer to use XML, as a rule, have their own mechanisms for solving similar problems.  For example, WCF controls types at the stage of creating proxy classes.  Alas, JSON users of this sugar are deprived, and everything has to be done manually.  As a result, the code for checking the validity of an object often becomes as big as the parsing code. <br><br>  Help in solving this situation allows the use of the mechanism JSON schemes.  The format is very well standardized and has a redundant description: <a href="http://json-schema.org/">json-schema.org</a> , in addition, there are many online tools that allow you to create schemes according to the entered JSON: <a href="http://jsonschema.net/">jsonschema.net/#</a> <br><br>  Let's try to consider a practical example for the programming language Swift. <br>  In a cursory search, we managed to find a public service that returns a JSON response to a simple GET request: <a href="httpbin.org/get%3FmyFirstParam%3DmyFirstValue%26mySecondParam%3DMySecondValue">httpbin.org/get?myFirstParam=myFirstValue&amp;mySecondParam=MySecondValue</a> <br><br>  The answer will be roughly as follows: <br><div class="spoiler">  <b class="spoiler_title">Response</b> <div class="spoiler_text"><code>{ <br> "args": { <br> "myFirstParam": "myFirstValue", <br> "mySecondParam": "MySecondValue" <br> }, <br> "headers": { <br> "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", <br> "Accept-Encoding": "gzip, deflate, br", <br> "Accept-Language": "ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3", <br> "Host": "httpbin.org", <br> "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:45.0) Gecko/20100101 Firefox/45.0" <br> }, <br> "origin": "193.105.7.55", <br> "url": "https://httpbin.org/get?myFirstParam=myFirstValue&amp;mySecondParam=MySecondValue" <br> } <br></code> <br></div></div><br><br>  The answer does not contain any practically useful information, but allows you to debug the process of interaction.  The response contains the string GET request, and the parameters that were passed, as well as some information about the browser through which the request was made.  When making a request from a simulator or a real device, the result of the response may be slightly different.  At the same time, it must be subordinated to a certain scheme, which can be extracted using online tools (http://jsonschema.net/#/ and similar). <br><br>  In the left pane, install all the checkboxes.  I recommend setting the ‚ÄúArrays‚Äù option switch to ‚ÄúSingle schema (list validation)‚Äù (Swift language features). <br><img src="https://habrastorage.org/files/cfc/134/67f/cfc13467f3bf4a71ad23316279059065.jpg"><br><br>  Copy the browser response in the upper left window, and make sure that we have placed valid JSON.  This will be clear from the words ‚ÄúWell done!  You provided valid JSON. ‚ÄùOn a green background directly below the window.  Unfortunately, the response to the XCode console, even with the print () operator, does not comply with the format requirements.  If you still decide to take the answer text from the console, you will have to replace all the equals ‚Äú=‚Äù with a colon ‚Äú:‚Äù, and take all the field names in double quotes. <br><img src="https://habrastorage.org/files/001/dfb/6a0/001dfb6a0a4143a78b7aea61effd22f9.jpg"><br><br>  After clicking on the Generate Schema button, we get in the right window a rather long scheme for such a small query: <br><img src="https://habrastorage.org/files/1f5/b08/957/1f5b08957df9431fafd5e92f2356f74b.jpg"><br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"> <code>{ <br> "$schema": "http://json-schema.org/draft-04/schema#", <br> "id": "http://myjsonschema.net", <br> "type": "object", <br> "additionalProperties": true, <br> "title": "Root schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "/", <br> "properties": { <br> "args": { <br> "id": "http://myjsonschema.net/args", <br> "type": "object", <br> "additionalProperties": true, <br> "title": "Args schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "args", <br> "properties": {} <br> }, <br> "headers": { <br> "id": "http://myjsonschema.net/headers", <br> "type": "object", <br> "additionalProperties": true, <br> "title": "Headers schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "headers", <br> "properties": { <br> "Accept": { <br> "id": "http://myjsonschema.net/headers/Accept", <br> "type": "string", <br> "minLength": 1, <br> "title": "Accept schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "Accept", <br> "default": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", <br> "enum": [ <br> null, <br> "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" <br> ] <br> }, <br> "Accept-Encoding": { <br> "id": "http://myjsonschema.net/headers/Accept-Encoding", <br> "type": "string", <br> "minLength": 1, <br> "title": "Accept-Encoding schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "Accept-Encoding", <br> "default": "gzip, deflate, br", <br> "enum": [ <br> null, <br> "gzip, deflate, br" <br> ] <br> }, <br> "Accept-Language": { <br> "id": "http://myjsonschema.net/headers/Accept-Language", <br> "type": "string", <br> "minLength": 1, <br> "title": "Accept-Language schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "Accept-Language", <br> "default": "ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3", <br> "enum": [ <br> null, <br> "ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3" <br> ] <br> }, <br> "Host": { <br> "id": "http://myjsonschema.net/headers/Host", <br> "type": "string", <br> "minLength": 1, <br> "title": "Host schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "Host", <br> "default": "httpbin.org", <br> "enum": [ <br> null, <br> "httpbin.org" <br> ] <br> }, <br> "User-Agent": { <br> "id": "http://myjsonschema.net/headers/User-Agent", <br> "type": "string", <br> "minLength": 1, <br> "title": "User-Agent schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "User-Agent", <br> "default": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:45.0) Gecko/20100101 Firefox/45.0", <br> "enum": [ <br> null, <br> "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:45.0) Gecko/20100101 Firefox/45.0" <br> ] <br> } <br> } <br> }, <br> "origin": { <br> "id": "http://myjsonschema.net/origin", <br> "type": "string", <br> "minLength": 1, <br> "title": "Origin schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "origin", <br> "default": "193.105.7.55", <br> "enum": [ <br> null, <br> "193.105.7.55" <br> ] <br> }, <br> "url": { <br> "id": "http://myjsonschema.net/url", <br> "type": "string", <br> "minLength": 1, <br> "title": "Url schema.", <br> "description": "An explanation about the purpose of this instance described by this schema.", <br> "name": "url", <br> "default": "https://httpbin.org/get", <br> "enum": [ <br> null, <br> "https://httpbin.org/get" <br> ] <br> } <br> }, <br> "required": [ <br> "args", <br> "headers", <br> "origin", <br> "url" <br> ] <br> } <br></code> <br></div></div><br><br>  In principle, the scheme can be reduced without setting a tick, and setting the ‚ÄúArray‚Äù switch to the ‚ÄúSingle empty schema‚Äù state, but this way we will lose the opportunity to use some of the common features of the scheme and Swift language sharing. <br><br>  In real life, the server‚Äôs response is often quite large, and contains many array elements that can also be dictionaries.  In this case, the scheme will not increase in size, since the constructor will correctly process the repeatability of elements. <br><br>  Create a file called response.json and add it to the project. <br>  If you use Cocoapods add the line <br>  <i><b>pod 'VVJSONSchemaValidation'</b></i> in your <b>Podfile</b> .  If you don‚Äôt use Cocoapods, you‚Äôll have to go directly to the Vita Voloshin GitHub repository: <a href="https://github.com/vlas-voloshin/JSONSchemaValidation">github.com/vlas-voloshin/JSONSchemaValidation</a> <br><br>  After updating Cocoapods, it will be enough to add the following class to the project source code: <br><br><div class="spoiler">  <b class="spoiler_title">Validator class</b> <div class="spoiler_text"> <code>import UIKit <br> import VVJSONSchemaValidation <br> <br> class Validator <br> { <br> <br> private var _schemaName = "" <br> var schemaName:String { <br> get { <br> return _schemaName <br> } <br> set(value) <br> { <br> _schemaName = value <br> guard let path = NSBundle.mainBundle().pathForResource(value, ofType: "json") else { <br> return <br> } <br> <br> do <br> { <br> if let schemaData = NSData(contentsOfFile:path) { <br> self.schema = try VVJSONSchema(data: schemaData, baseURI: nil, referenceStorage: nil) <br> } <br> } <br> catch let error as NSError <br> { <br> print("\n") <br> print("===============================================================") <br> print("Schema '\(value).json' didn't create:\n\(error.localizedDescription)") <br> print("===============================================================") <br> print("\n") <br> } <br> } <br> } <br> <br> private var schema:VVJSONSchema? <br> <br> func validate(response:AnyObject?) -&gt; Bool <br> { <br> if let schema = self.schema <br> { <br> do { <br> try schema.validateObject(response!) <br> } <br> catch let error as NSError <br> { <br> print("\n") <br> print("===============================================================") <br> print("\(error.userInfo["NSLocalizedDescription"]!)\n\(error.userInfo["NSLocalizedFailureReason"]!)") <br> print("===============================================================") <br> print("\n") <br> return false <br> } <br> } <br> <br> return true <br> } <br> } <br> <br></code> <br></div></div><br><br>  In the class in which you receive a response from the server, add: <br><br> <code>let validator = Validator() <br> validator.schemaName = "response" <br></code> <br><br>  And in the method (block) where we get the server response, we write: <br><br> <code>if self.validator.validate(response) { <br> self.parse(response) // &lt;‚Äî      JSON <br> } <br></code> <br><br>  That's all. <br>  Now, if from the server side the data that does not correspond to the specified scheme comes, then the parsing mechanism will not be launched.  You do not need to describe the logic of the JSON response in the code, only to understand whether there is some kind of mistake.  That is, if it is correct, you can safely parse.  Of course, such a code does not protect you 100%, but 99.9% of erroneous answers will be eliminated.  Experience shows that with manual programming of logic, the number of erroneous answers leading to the crash of the system is eliminated only in 68.2%. <br><br>  Additional buns from this approach can highlight the fact that you can specify default values ‚Äã‚Äãdirectly in the scheme: <br> <code>"default": ¬´193.105.7.55"    "default": "127.0.0.1", <br></code> <br><br>  And in ‚Äúenum‚Äù provide a list of those values ‚Äã‚Äãthat are valid for the data model object.  In my case, this is an Optional String (String?), I.e., a string that could potentially contain either nil or "193.105.7.55": <br><div class="spoiler">  <b class="spoiler_title">Enum</b> <div class="spoiler_text"> <code>"enum": [ <br> null, <br> "193.105.7.55" <br> ] <br></code> <br></div></div><br><br>  It is very easy to proceed to the development of this concept: <br><ol><li>  Schemes can be created by developers who are developing a REST API, and can be integrated into an application as a finished product.  In case of errors, there will always be one responsible for data integrity violations. </li><li>  In case data validation fails, the name of the scheme, request and response of the server are transferred to the server side.  This will allow you to quickly track and adjust the work of the API on the back-end side </li></ol></div><p>Source: <a href="https://habr.com/ru/post/283012/">https://habr.com/ru/post/283012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283000/index.html">In Q1 2016, 227,000 malware samples were identified daily.</a></li>
<li><a href="../283002/index.html">Mouse gesture editor and other new items in the assembly Vivaldi 1.2.470.11</a></li>
<li><a href="../283004/index.html">How to build a competent testing system? Insights from QA experts on May 19 in St. Petersburg</a></li>
<li><a href="../283008/index.html">Differences between Azure Resource Manager and Azure Service Manager - a developer‚Äôs perspective, part two, about Networking</a></li>
<li><a href="../283010/index.html">Viber received end-to-end encryption by default</a></li>
<li><a href="../283018/index.html">Dagger 2. We treat dependencies by the method of Google</a></li>
<li><a href="../283020/index.html">The first success of a complex game bot</a></li>
<li><a href="../283022/index.html">Developers lazy to the edge?</a></li>
<li><a href="../283024/index.html">We delegate the right to restore virtual machines, files and application objects using Enterprise Manager</a></li>
<li><a href="../283026/index.html">How to replace ELK for viewing logs?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>