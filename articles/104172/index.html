<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Exceptions and performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to put a little research on how the support of C ++ exceptions affects the overall performance of the code. 

 My work experience includes s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Exceptions and performance</h1><div class="post__text post__text-html js-mediator-article">  I decided to put a little research on how the support of C ++ exceptions affects the overall performance of the code. <br><br>  My work experience includes several years of development for various embedded systems, where performance has to be constantly taken into account when writing code (real-time systems that process a large amount of information ‚Äî processor and memory speeds have never been ‚Äúa lot‚Äù there).  Accordingly, in this environment, programmers are usually quite well aware of what overhead is incurred (or not borne) by one or another opportunity provided by the C ++ language.  For example, <a name="habracut"></a>  namespace support - no extra cost at all;  RTTI - additional section with the names of the classes / structures with their type_info (the final binary increases in size, but this does not affect code generation);  etc.  As ( <i>not on all platforms</i> ), support for exceptions is implemented, we'll see. <br><br>  Used tools: ancient front-end from <a href="http://en.wikipedia.org/wiki/Edison_Design_Group">EDG</a> for converting C ++ code to C code and <a href="http://astyle.sourceforge.net/">Artistic Style</a> for formatting received C-files (otherwise it is impossible to read them).  About the front-end from EDG, I must say especially - this is the very frond-end that is built into the Intel compilers, Texas Instruments compilers, etc.  Since supporting all the features of C ++ is a very difficult task (compared to implementing all the features of the C language), on some platforms C ++ code is translated into identical C code, and this code is already fed to the C compiler.  The front-end is not used the freshest, but it is suitable for understanding. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, let's take a fairly simple text code (the names and constants are specially chosen so that they are easy to find in the processed listing): <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AAAAA</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; AAAAA() { a = <span class="hljs-number"><span class="hljs-number">1234</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~AAAAA() {} }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BBBBB</span></span></span><span class="hljs-class"> :</span></span> AAAAA { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; BBBBB() { a = <span class="hljs-number"><span class="hljs-number">5678</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~BBBBB() {} }; <span class="hljs-comment"><span class="hljs-comment">// forward declaration int bar(); int foo() { BBBBB b1; b1.a = bar(); b1.process(); BBBBB b2; b2.a = bar(); b2.process(); return b1.a + b2.a; }</span></span></code> </pre> <br><br>  Everything is very simple - two inline constructors / destructors, a pair of virtual functions, a pair of calls to an external function. <br><br>  Here is the resulting code without exception support (the result was processed by AStyle).  Sheet, but it is necessary: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 1 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1.cpp"</span></span></span><span class="hljs-meta"> struct __T9639768; struct AAAAA; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 9 struct BBBBB; struct __T9639768 { short d; short i; void (*f)(); }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 1 struct AAAAA { int a; struct __T9639768 *__vptr; }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 9 struct BBBBB { struct AAAAA __b_AAAAA; }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 17 extern int bar__Fv(void); extern int foo__Fv(void); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 10 extern void process__5BBBBBFv(struct BBBBB *const); extern struct __T9639768 __vtbl__5AAAAA[3]; extern struct __T9639768 __vtbl__5BBBBB[3]; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 19 int foo__Fv(void) { auto int __T9722792; auto struct BBBBB b1; auto struct BBBBB b2; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 21 { { ((b1.__b_AAAAA).__vptr) = __vtbl__5AAAAA; ((b1.__b_AAAAA).a) = 1234; } ((b1.__b_AAAAA).__vptr) = __vtbl__5BBBBB; ((b1.__b_AAAAA).a) = 5678; } ((b1.__b_AAAAA).a) = (bar__Fv()); process__5BBBBBFv((&amp;b1)); { { ((b2.__b_AAAAA).__vptr) = __vtbl__5AAAAA; ((b2.__b_AAAAA).a) = 1234; } ((b2.__b_AAAAA).__vptr) = __vtbl__5BBBBB; ((b2.__b_AAAAA).a) = 5678; } ((b2.__b_AAAAA).a) = (bar__Fv()); process__5BBBBBFv((&amp;b2)); { __T9722792 = ((((b1.__b_AAAAA).a)) + (((b2.__b_AAAAA).a))); { ((b2.__b_AAAAA).__vptr) = __vtbl__5BBBBB; { { ((b2.__b_AAAAA).__vptr) = __vtbl__5AAAAA; } } } { ((b1.__b_AAAAA).__vptr) = __vtbl__5BBBBB; { { ((b1.__b_AAAAA).__vptr) = __vtbl__5AAAAA; } } } return __T9722792; } }</span></span></code> </pre><br><br>  It is clearly seen how each object is ‚Äúconstructed‚Äù, how vtable / inheritance is implemented, that the constructors / destructors are still inline, and the C-compiler still has all the information to effectively optimize this code.  Also note that the resulting C code takes 72 lines, and approximately 1.6kB. <br><br>  Now the same source is translated with exception support. <br><br>  See the result here: <a href="http://pastebin.com/E04f9zt9">C-equivalent of 253 lines and 8.5 kB</a> .  Here I will not post it, I will confine myself to the main function (the former <code>int foo()</code> ) with comments of some moments: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo__Fv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T9641460</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T9653776</span></span></span><span class="hljs-class">[2] = {</span></span>{((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*)())__dt__5BBBBBFv),((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)<span class="hljs-number"><span class="hljs-number">0U</span></span>),((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)<span class="hljs-number"><span class="hljs-number">65535U</span></span>),((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">0U</span></span>)},{((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*)())__dt__5BBBBBFv),((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)<span class="hljs-number"><span class="hljs-number">1U</span></span>),((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)<span class="hljs-number"><span class="hljs-number">0U</span></span>),((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">0U</span></span>)}}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *__T9731464[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __T9733536; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line</span></span></span><span class="hljs-class"> 20 __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T9643156</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T9734356</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BBBBB</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b1</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BBBBB</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2</span></span></span><span class="hljs-class">;</span></span> (__T9734356.next) = __curr_eh_stack_entry; __curr_eh_stack_entry = (&amp;__T9734356); (__T9734356.kind) = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">1U</span></span>); (((__T9734356.variant).function).regions) = ((struct __T9641460 *)__T9653776); (((__T9734356.variant).function).obj_table) = ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **)__T9731464); ((( #line <span class="hljs-number"><span class="hljs-number">25</span></span> __T9734356.variant).function).saved_region_number) = __eh_curr_region; __eh_curr_region = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)<span class="hljs-number"><span class="hljs-number">65535U</span></span>); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 21 __ct__5BBBBBFv((&amp;b1)); (((void **)__T9731464)[0U]) = ((void *)(&amp;b1)); __eh_curr_region = ((unsigned short)0U); ((b1.__b_AAAAA).a) = (bar__Fv()); process__5BBBBBFv((&amp;b1)); __ct__5BBBBBFv((&amp;b2)); (((void **)__T9731464)[1U]) = ((void *)(&amp;b2)); __eh_curr_region = ((unsigned short)1U); ((b2.__b_AAAAA).a) = (bar__Fv()); process__5BBBBBFv((&amp;b2)); { __T9733536 = ((((b1.__b_AAAAA).a)) + (((b2.__b_AAAAA).a))); __eh_curr_region = ((unsigned short)0U); __dt__5BBBBBFv((&amp;b2), 2); __eh_curr_region = ((unsigned short)65535U); __dt__5BBBBBFv((&amp;b1), 2); { __eh_curr_region = ((((__T9734356.variant).function).saved_region_number)); __curr_eh_stack_entry = #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 29 ((__T9734356.next)); return __T9733536; } } }</span></span></code> </pre><br>  Major changes: <br><ul><li>  constructors stopped being inline (calls of __ct__5BBBBBFv appeared), </li><li>  similar situation with destructors (__dt__5BBBBBFv), </li><li>  the code now keeps track of which object is already constructed (or already deleted), and which is not yet - because you need to know which object destructors need to be called if an exception occurs, </li><li>  The code of constructors / destructors has become more complicated (functions __dt__5BBBBBFv / ct__5BBBBBFv, see the link), </li></ul><br>  The very trouble with the first two points - the logic of designers / destructors has become so complicated that the front-end brings them into separate functions.  It is clear why - embedding them (inline) will lead to a strong increase in the code of each function, where objects like BBBB are used.  But the consequence of this will be that the C-compiler optimizer generates a significantly less efficient code (we have additional calls and checks in the code). <br><br>  That is: simply the inclusion of support for exceptions led to an increase in the size of the final binary file, and to slow down the operation of all functions inside which objects are being constructed (with the exception of the most trivial). <br><br>  Actually, this is the main reason why support for exceptions for embedded development is turned off by default - you have to pay for it, even if you really don‚Äôt use it. <br><br>  PS: this all, of course, does not mean that ‚Äúexceptions are bad!‚Äù Or ‚Äúuse return codes instead of exceptions!‚Äù.  Just every tool is good for its task. <br>  PPS: support for handling erroneous situations in the embedded development, of course, is and is actively used.  It usually does not use C ++ exceptions, this is a topic for a separate article. </div><p>Source: <a href="https://habr.com/ru/post/104172/">https://habr.com/ru/post/104172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104167/index.html">Undo / Redo - Tail wags the dog</a></li>
<li><a href="../104168/index.html">What else is Undo / Redo capable of?</a></li>
<li><a href="../104169/index.html">Opera 10.70 (Win / Mac / Linux | 9046) September 8 and 13</a></li>
<li><a href="../104170/index.html">Microsoft will support Russian public organizations with free software</a></li>
<li><a href="../104171/index.html">Understanding node.js</a></li>
<li><a href="../104174/index.html">Who is he, a domestic IT leader?</a></li>
<li><a href="../104175/index.html">Looks like the HDCP master key is hacked</a></li>
<li><a href="../104176/index.html">Physics on Flash. Creating Ragdoll in Nape on AS3</a></li>
<li><a href="../104177/index.html">Mail.Ru Technologies Forum: follow the online broadcast</a></li>
<li><a href="../104178/index.html">Funny hint at the iPad in advertising the new Kindle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>