<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New Phaser Synchronizer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Phaser (Etapshchik) - powerful and flexible implementation of the pattern of synchronization Barrier . Included in JDK 7 as part of the java.util.conc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New Phaser Synchronizer</h1><div class="post__text post__text-html js-mediator-article">  Phaser (Etapshchik) - powerful and flexible implementation of the pattern of synchronization <a href="http://parlab.eecs.berkeley.edu/wiki/_media/patterns/paraplop_g1_3.pdf">Barrier</a> .  Included in JDK 7 as part of the java.util.concurrent package. <br><br>  Since the documentation, as they say, you cannot figure out without a hundred grams, I will describe here the principle of operation, unobvious moments and give a few examples of use. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Phaser quite naturally expands the functionality of its predecessor from JDK 1.5, CyclicBarrier (you can read about it <a href="http://www.ibm.com/developerworks/java/tutorials/j-concur/section5.html">here</a> ): <ul><li>  The number of barrier participants may vary. </li><li>  The stream does not have to wait until all participants gather at the barrier.  It is enough to report the readiness of their work. </li><li>  On the contrary, the flow does not necessarily have to be a member of the barrier in order to expect to overcome it. </li></ul>  By the way, this extension is so general that it is consistent with the third barrier contract from the standard library, CountDownLatch. <br><br><br>  The status of the attendant includes <ol><li>  phase number (phase, synchronization cycle) |  int phase </li><li>  number of participants |  int parties </li><li>  number of participants who have declared / not declared their readiness |  int arrived, unarrived </li><li>  completion status |  boolean terminated </li></ol>  Always true: <br>  terminated = false → phase = [real stage number, counting is from scratch]% (2 <sup>31</sup> - 1) <br>  parties = arrived + unarrived <br>  0 ≤ unarrived, arrived ≤ parties <br><br>  All elements of the state are equipped with getters. <br><br><br>  0. If the worker is in the terminal state (terminated = true), he does not change;  calling any control method returns immediately.  Phase has a negative value, parties, arrived, unarrived - the <i>value at the time of completion.</i> <br><br><br>  1. Basic control methods: <br><table><tbody><tr><td>  register () </td><td>  register member </td></tr><tr><td>  arrive () </td><td>  inform the attendant about his readiness <i>without</i> waiting for the opening of the barrier </td></tr><tr><td>  arriveAndAwaitAdvance () </td><td>  classic arrival at the barrier.  Exact counterpart of CyclicBarrier.await () </td></tr><tr><td>  arriveAndDeregister () </td><td>  cancel your participation </td></tr></tbody></table>  Clearly, as in the other synchronizers from the JDK, the calling thread in control methods is not tracked, therefore terms like “participant thread” and “its registration” are conditional.  That is, a loaded pistol is already in our hands, it remains to send it to the foot and pull the trigger :-) However, it is not difficult to write a wrapper that corrects this dangerous situation. <br><br><br>  2. The barrier opens immediately after any <i>decrease unarrived to zero.</i>  <i><sup>1</sup></i> That is, including when the last participant is removed, however, when creating an “empty” stage worker (new Phaser () or new Phaser (0)), the “gate is closed”. <br><br>  One way or another, the barrier can be overcome only by calling one of the methods starting at “arrive”.  In the context of the stream that does this, the onAdvance (phase, parties) protected method is executed - if it returns true, the stage keeper terminates his work (terminated ← true).  This mechanism allows you to manage the life cycle from the inside of the class.  In the default phaser implementation, it dies just when all the participants left the barrier (parties = 0). <br><br>  The opening of the barrier is a transition to a new stage: phase ← phase + 1. <br><br>  How about it works: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Phaser ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phaser(<span class="hljs-number"><span class="hljs-number">4</span></span>); ph.arrive(); ph.register(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread() {<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ ph.arriveAndAwaitAdvance(); }}.start(); ph.arrive(); ph.arrive(); ph.arriveAndDeregister(); <span class="hljs-comment"><span class="hljs-comment">// phase number = 1 // Thread-0 released</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/a42/fc3/2fc/a42fc32fc97248d3b9dcf48008281afb.png" alt="image"><br>  <i>Above the state is written a method that led him</i> <br><br><br>  3. <b>arriveAndDeregister</b> - it is bad to think that the stream first declares readiness, and only then it is removed, which is hinted at by the name of the method.  The essence would reflect “arriveToDeregister”, “arrived to put a membership card on the table” :-) Such an approach eliminates ambiguity in understanding (see illustration above): was it called onAdvance () with the parties = 4 or 5 before going to the new stage? <br><br><br>  4. An example of changing the completion logic in the <b>onAdvance</b> method.  A “non-destructible” land surveyor is constructed as: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phaser() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAdvance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phase, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> parties)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } };</code> </pre><br>  Even in the method can be performed so-called.  barrier action - the composition of the results of the work of participants, etc. <br><br>  More specifically, what happens during the transition to the next stage: <br><img src="https://habrastorage.org/getpro/habr/post_images/5f4/517/331/5f4517331e4ec02d2b31e73ea79ca384.png" alt="image"><br><br><br><h4>  Using </h4><br>  To get from Phaser CyclicBarrier, it suffices to use the method arriveAndAwaitAdvance (). <br><br>  CountDownLatch emulation is a little more complicated: <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// aka countDown() phaser.arriveAndDeregister(); //  arrive()    // aka await() if (!phaser.isTerminated()) //  phaser.awaitAdvance( phaser.getPhase() );</span></span></code> </pre><br>  The awaitAdvance (getPhase ()) construct is safe (though not atomic) because the awaitAdvance (int phaseNumber) method returns immediately if the specified step has already been passed. <br><br><br>  In general, the presence of a stage meter greatly simplifies life and increases the number of class applications. <br><br>  Parallelization of N identical actions in a row: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.Phaser; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FBIEasterEgg</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lines = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String alphabet = <span class="hljs-string"><span class="hljs-string">"abcdefghijklmnopqrstuvwxyz"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> StringBuffer randomAlphabet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuffer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Phaser phaser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phaser() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAdvance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phase, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> parties)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// John Nash mode /* print "deviations" for (int i = 0; i &lt; alphabet.length(); i++) { System.out.printf("%d ", randomAlphabet.indexOf( alphabet.charAt(i) + "") - i); } System.out.println(); */ System.out.println(randomAlphabet); // randomAlphabet = new StringBuffer(); return phase &gt;= lines; //loop count managing here } }; // everyone have to wait for the main thread phaser.register(); for (int i = 0; i &lt; alphabet.length(); i++) { final char next = alphabet.charAt(i); phaser.register(); // ticket for the following thread new Thread() { public void run() { do { randomAlphabet.append(next); phaser.arriveAndAwaitAdvance(); // checkout } while ( !phaser.isTerminated() ); } }.start(); } System.out.println("Write this by hand and carry in the pocket:"); // some additional preparations may be done here // release phaser.arriveAndDeregister(); } }</span></span></code> </pre><br><br>  Wait until the specified number of events occur: <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventCounter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Phaser count = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phaser(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventOccured</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ count.arrive(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitFor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ count.register(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; events; i++) { count.arriveAndAwaitAdvance(); } count.arriveAndDeregister(); } }</code> </pre><br><br><br><h4>  Implementation </h4><br>  Doug Lee used a clever idea: to keep all the status of the stageman in one long, and to change through atomic compare-and-set operations. <br><img src="http://img38.imageshack.us/img38/1649/phaserstate.png" alt="Phaser from JDK 7"><br>  Due to this, the implementation almost does not use normal locks. <br><br><br><h4>  Links </h4><br>  <a href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/Phaser.html">Phaser javadoc</a> <br>  <a href="http://download.java.net/jdk7/">JDK 7 download page</a> <br>  <a href="http://gee.cs.oswego.edu/dl/concurrency-interest/index.html">Concurrency JSR-166 Interest Site</a> - there is a link to download a new java.util.concurrent for JDK 6. <br><br><br>  P. S. The name “Etapshchik” is, of course, clumsy, if someone knows / thinks up better - do not hide. <br>  <sup>1</sup> - provided that this Phaser is the root of the hierarchy.  In this review, the scaling mechanism is not considered (it would still lie), see javadoc. </div><p>Source: <a href="https://habr.com/ru/post/117185/">https://habr.com/ru/post/117185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117178/index.html">YouTube has launched an online broadcast platform</a></li>
<li><a href="../117179/index.html">Fun fonts in your application</a></li>
<li><a href="../117180/index.html">5 reasons to refuse assessments</a></li>
<li><a href="../117181/index.html">Development of plugins for qutIM from under Windows - quick start</a></li>
<li><a href="../117183/index.html">PIE 1.0 beta 4 released</a></li>
<li><a href="../117187/index.html">Issues 2.0: New Generation</a></li>
<li><a href="../117188/index.html">Tweet later, soap earlier and don't forget about saturday</a></li>
<li><a href="../117189/index.html">New version of Image Composite Editor released</a></li>
<li><a href="../117190/index.html">Branded MTS 1055 Tablet</a></li>
<li><a href="../117191/index.html">10 years of RSDN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>