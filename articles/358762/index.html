<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of Clickhouse API for Rambler / Top-100</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone knows what Rambler / Top 100? Just in case, this is a web analytics service. Our users place a counter on their sites, but we, in turn, prepa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of Clickhouse API for Rambler / Top-100</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ic/ou/4n/icou4nt12ewafqit50u19wdl5gi.png"><br><br>  Everyone knows what Rambler / Top 100?  Just in case, this is a web analytics service.  Our users place a counter on their sites, but we, in turn, prepare all the necessary statistics of visits in the form of a set of standard reports.  Under the cut, is the story of Vitaly Samigullin, the head of the Rambler / Top-100 technology development group, about how we developed the ClickHouse API in Python and why we started it all. <a name="habracut"></a><br><br><h3>  <font color="#0000cc">The transition from batch to stream processing required a new repository and a new API</font> </h3><br>  Actually, why would we need to develop the <a href="https://ru.wikipedia.org/wiki/ClickHouse">Clickhouse</a> API <a href="https://ru.wikipedia.org/wiki/ClickHouse">?</a>  First, we had certain changes in the data processing.  The general scheme of the service now looks as follows. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/ho/0r/ms/ho0rms80hfva2hnwlptdhoz4ysy.png"><br><br>  In the upper left corner you see counters that send us events.  The logs of these events are parsed and processed in a certain way.  How it happens now: we have a cluster of nightly batch-computing, which cheats the logs for yesterday.  For the user of Top 100, this is not very convenient, because the latest statistics appear in your account after a day. <br><br>  Everyone really wanted the service to work ‚Äúlike in the best houses in London‚Äù, and the statistics for the current day would arrive to the user as soon as possible.  Therefore, we decided to switch to the so-called stream data processing (near real-time data processing or micro-batchy).  The delay in displaying data in 5-10 minutes is nothing compared to the scheme, when the data arrive on the next day. <br><br>  If earlier the results of the night calculation were flooded in the open-source analogue of BigTable from Google, then for real-time we needed a new database.  We chose ClickHouse (more on this in our article <a href="https://habr.com/company/rambler-co/blog/332202/">on Habr√©</a> ).  Then we started developing the ClickHouse API to work with this database.  It should be noted that the API is quite low-level.  Users interact with it through various layers: partner APIs, user application APIs. <br><br><h3>  <font color="#0000cc">What is Clickhouse?</font> </h3><br>  <a href="https://ru.wikipedia.org/wiki/ClickHouse">Clickhouse</a> is a database management system.  ClickHouse is a column database.  This means that the data is stored, organized in columns, not in lines.  This provides the opportunity to work with dozens and even hundreds of columns.  The second important feature of this database is that it is very fast just because it is organized into columns (when we query, we only read the required columns), it uses data compression, it can parallelize the processing of requests on several processor cores, and also supports distributed processing of the request on a cluster from many servers. <br><br>  Another important aspect is the SQL-like syntax of the query language, extended by a large number of useful functions of aggregation and transformation.  This allows part of the logic to be removed from the application to the request.  That is, if you have an application in Python, the removal of logic in Clickhouse, written in C ++, will not only be convenient, but also provide a speed boost. <br><br><h3>  <font color="#0000cc">Analytic queries</font> </h3><br>  Analytical queries are a pattern with a set of characteristics.  For example, analytic queries involve mostly reading.  In analytical queries, we do not need transactions ‚Äî the data is read and almost never changes.  And if changes are required, this is done through deleting partitions and recording a new partition.  In addition, the recording takes place in large batches from a real-time cluster.  In analytical queries, it is often envisaged to read the data of individual columns from a wide multi-column table. <br><br>  In contrast to the nightly calculation, the results of microbatch are recorded in ClickHouse in a non-aggregated form.  And when there is so much data, requests can be slow.  For analytics, queries are allowed based on a piece of data with some approximate result.  ClickHouse allows you to do this using the sampling mechanism. <br><br><h3>  <font color="#0000cc">Product challenge</font> </h3><br>  Previously, we performed standard reports for users with night-time data ‚Äî these are about 30 standard reports, for example, reports on classroom or behavioral indicators, technologies, traffic sources, page contents.  From the API side, two pens were required for each report: one for tabular data, the second for a chart. <br><br>  Now we were faced with a grocery call - in addition to speeding up the calculation to almost real time and saving the already existing reports with statistics, we had to implement the report designer.  The report designer should allow the user to create fully custom reports to fit his needs.  What does this mean for the API? <br><br>  This means that we can no longer do the standard template with a SQL query for each standard report from our statistics.  You need to be able to generate queries for custom reports.  That is, the API assumes the functions of almost- <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> .  Why almost because we did not solve some kind of universal task of generating SQL queries for ClickHouse.  We solved the problem for our data schema, for our tables. <br><br>  It is clear that in the case of the API that will be used for the report designer, we need a certain single entry point, one handle: the handle receives a set of parameters for the query to the database, generates the query, sends it to ClickHouse, formats it in some way and returns the answer.  In order to generate this query, we introduced such a concept as cubes. <br><br>  <b>Cubes</b> are entities for generating SQL queries.  By their type, cubes are divided into two categories: <br><br>  Dimensions - answer the question <b>WHAT?</b> <br>  Metrics - answer the question <b>HOW MUCH?</b> <br><br>  Best of all, the structure of the cube can be seen on the example of our standard report ‚ÄúGeography‚Äù.  In the table we see a breakdown by country.  It is obvious that the country answers the question ‚ÄúWHAT?‚Äù And refers to the dimension.  Each country has some quantitative views: visitors, refusals, viewing depth, and so on.  These are metrics. <br><br><img src="https://habrastorage.org/webt/mm/gc/eb/mmgceby84qmysproy7pqk55xbr0.png"><br><br>  Now let's imagine that a user was inspired by a report broken down by country and decided to add regions and cities as dimensions to conduct more complex analytics and find out on which pages the residents of Moscow, Kiev and Minsk finish viewing his site.  And then the user will want to see how these indicators change over time and add the Day cube to the report designer. <br><br><h3>  <font color="#0000cc">From API request to SQL query</font> </h3><br>  What would an API request look like?  What database query will it generate?  How is the SQL query generated?  And how the cubes are implemented in Python code. <br><br>  As an example, take the simplest report "Technology / Operating Systems." <br><br>  <b>JSON API Request</b> <br><br><pre><code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"dimensions"</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"counter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"filters"</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">"op"</span></span>: <span class="hljs-string"><span class="hljs-string">"eq"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-number"><span class="hljs-number">123</span></span>}]}, {<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"os"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"filters"</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">"op"</span></span>: <span class="hljs-string"><span class="hljs-string">"nlike"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows%"</span></span>}]}, {<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"day"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"filters"</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">"op"</span></span>: <span class="hljs-string"><span class="hljs-string">"eq"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-03-22"</span></span>}]} ], <span class="hljs-attr"><span class="hljs-attr">"metrics"</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"visitors"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"filters"</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">"op"</span></span>: <span class="hljs-string"><span class="hljs-string">"gt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>}]} ], <span class="hljs-attr"><span class="hljs-attr">"sort"</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"visitors"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"order"</span></span>: <span class="hljs-string"><span class="hljs-string">"desc"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"os"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"order"</span></span>: <span class="hljs-string"><span class="hljs-string">"asc"</span></span>} ], <span class="hljs-attr"><span class="hljs-attr">"offset"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"limit"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sample"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>}</code> </pre> <br>  Obviously, we will send some JSON to the API, which consists of a list of metrics, dimensions, sorts, limits, offsets and sample (if we want to build a query only on the part of the data set). <br><br>  Each cube - both metrics and dimensions - is described by some keyword and includes filters.  In the above case, it is clear that we have the dimension "Counter", "Project Number" and it is equal to a certain ID.  We have the ‚ÄúOperating Systems‚Äù cube, and in this query we want to make a breakdown for all operating systems except Windows.  We have a cube "Day", and we want to see the data only for today. <br><br>  The same with metrics.  We have ‚ÄúVisitors‚Äù, we want to see all operating systems where there were more than a hundred visitors.  Well, sort it all in descending order by visitors and increasing order by OS name. <br><br>  <b>From SQL query to cubes</b> <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> os_name <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> os, uniqCombined(user_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> visitors <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> hits <span class="hljs-keyword"><span class="hljs-keyword">SAMPLE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (counter_id = <span class="hljs-number"><span class="hljs-number">123</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (dt = toDate(<span class="hljs-string"><span class="hljs-string">'2018-03-22'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (os <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'Windows%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> visitors &gt; <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> visitors <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>, os <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre><br>  We want the API based on the incoming JSON to generate a SQL query for ClickHouse.  In the above query, we see all the dimensions and metrics described in JSON.  We have a SELECT section, in it we choose the names of operating systems.  There is also an aggregation of visitors.  All filters are sent to the WHERE and HAVING sections.  After grouping, we want to weed out all the operating systems, where we have 100 users and less, and so on. <br><br>  <b>Properties of cubes</b> <br><br>  Each cube has certain properties that define it: <br><br><ul><li>  Column in db </li><li>  Alias </li><li>  Sign of Visibility </li><li>  Filters </li><li>  Sorting </li><li>  Expressions for all necessary sections of the SQL query (SELECT, WHERE, ...) </li></ul><br>  For example, for the ‚ÄúOperating Systems‚Äù cube, the column in the database, as we see from the query, is os_name.  Alias ‚Äã‚Äãallows you to conveniently work with filters, groupings and sorts.  The sign of visibility is this: in the example above, it is clear that the dimension, ‚ÄúCounter‚Äù and ‚ÄúDay‚Äù are invisible.  We use them only for sorting, but they do not participate in the SELECT section.  At the same time, the ‚ÄúOperating Systems‚Äù and ‚ÄúVisitors‚Äù cubes are clearly visible.  It's the same with sorting - some cubes are involved in sorting, some are not.  There are certain orders to sort.  And naturally, in the final query, we want to get pieces for each section of the query, for each keyword: SELECT, WHERE, and others.  Each cube will provide us these pieces through the corresponding expressions. <br><br>  <b>Implementing Cubes in Python</b> <br><br>  The API is written in Python.  Consider the implementation of cubes in this programming language. <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Selectable</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> column = not_implemented alias = not_implemented <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, visible: bool=True, sortable: bool=False)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> self.visible = visible self.sortable = sortable self.filters = [] ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, operator: str, value: Any)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ascending: bool=False,  priority: int=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> ... @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; Optional[str]:</span></span> ...</code> </pre><br>  Obviously, metrics and dimensions have much in common.  Therefore, we will describe the properties common to these entities in the base, parent class.  It has class variables: column, alias.  During initialization, we set the properties of visibility and sortability.  We have a method for adding filters, which will add an operator and a value.  And it is obvious that there can be many filters, so all these filters will be added to the list.  For example, we may have a date range in the "from and to" query.  Accordingly, two filters are added. <br><br>  The same with sorting: we can specify the sorting order in descending or ascending.  Next, we want to have attributes for each section of the query that will return rows.  From these lines, a large final query will be glued together. <br><br>  Below is a simplified example of the implementation of the "Operating Systems" and "Visitors" cubes in Python. <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OSName</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(StringDimension)</span></span></span><span class="hljs-class">:</span></span> column = <span class="hljs-string"><span class="hljs-string">'os_name'</span></span> alias = <span class="hljs-string"><span class="hljs-string">'os'</span></span> functions = [] ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Visitors</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(IntegerMetric)</span></span></span><span class="hljs-class">:</span></span> column = <span class="hljs-string"><span class="hljs-string">'user_id'</span></span> alias = <span class="hljs-string"><span class="hljs-string">'visitors'</span></span> functions = [uniqCombined] ...</code> </pre> <br>  We simply inherit from the parent class, set the column names in the database, alias, the list of transformation or aggregation functions.  For example, as we saw in the request, we need the uniqCombined aggregation function to calculate the approximate number of visitors. <br><br>  All our cubes can be ordered in a certain class hierarchy. <br><br><img src="https://habrastorage.org/webt/r_/bf/z4/r_bfz4-qadfzimlwtuxur1c6pi8.png"><br><br>  As mentioned earlier, metrics and dimensions have a lot in common.  Therefore, the main logic is in the main parent class Selectable. <br><br>  However, there are differences between them.  For example, we always group by dimensions, and the HAVING section is only for metrics.  Accordingly, they will be different in this.  Similarly with sampling.  When we specify, for example, a 1/10 sample, we need to multiply the metrics by the reciprocal number (by 10) to get an approximate value for these metrics.  Therefore, we distinguish two classes Metric and Dimension. <br><br>  At the next level of hierarchy, it is logical to create classes that are somehow tied to the type of stored and output data.  Metrics can be integer, such as "Visitors" or "Page views."  These can be floating point metrics, such as the Bounce Rate. <br><br>  It is the same with dimensions, but there are mainly lines: ‚ÄúBrowser name‚Äù, ‚ÄúOperating systems‚Äù, URL, and so on.  On the diagram you also see Mixin-classes.  These are such auxiliary classes that we can mix when defining concrete cubes, for example, to implement more complex logic, say, in working with transformation or aggregation functions.  In the simplest case, which suits us in most cases, it is a kind of chain of functions applied to a column.  Sometimes there are complex functions that require arguments, dependencies with other cubes, and more.  Mixin in this case are well suited. <br><br>  <b>SQL Query Generator</b> <br><br>  So, we have cubes.  From the set of cubes you need to collect a line of request.  This is done by the SQLGenerator class ‚Äî the generator is initialized with certain properties of the query as a whole, which are applicable to all all the cubes that participate in the generation of the final SQL query.  Obviously, such a common property may be the name of the table, for example, ‚Äúhits‚Äù.  This is a sample - it is clear that there can not be a different sample for different cubes.  Well, limits, offset. <br><br>  Next to this generator, we must pass a list of objects that have already been initialized, have visibility set, filters set, sort.  As a result, the generator class must save lists of strings in some dictionary.  The keys of the dictionary will be the names of the query sections (SELECT, WHERE, ...), and the values ‚Äã‚Äãwill be these same lists of cubes, from which we refer to the attributes corresponding to the query section.  Attributes are simply strings, pieces of the corresponding section. <br><br><pre> <code class="hljs cs">generator = SQLGenerator(table=<span class="hljs-string"><span class="hljs-string">"hits"</span></span>, sample=<span class="hljs-number"><span class="hljs-number">0.01</span></span>, limit=[offset, limit]) generator.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([sel1, sel2, ...]) ... { <span class="hljs-string"><span class="hljs-string">'SELECT'</span></span>: [sel1.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>, sel2.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>], <span class="hljs-string"><span class="hljs-string">'FROM'</span></span>: <span class="hljs-string"><span class="hljs-string">'hits'</span></span>, <span class="hljs-string"><span class="hljs-string">'SAMPLE'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'WHERE'</span></span>: [sel1.<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>, sel2.<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>], <span class="hljs-string"><span class="hljs-string">'GROUP BY'</span></span>: [sel1.groupby, sel2.groupby], <span class="hljs-string"><span class="hljs-string">'HAVING'</span></span>: [sel1.having, sel2.having], <span class="hljs-string"><span class="hljs-string">'ORDER BY'</span></span>: [sel1.<span class="hljs-keyword"><span class="hljs-keyword">orderby</span></span>, sel2.<span class="hljs-keyword"><span class="hljs-keyword">orderby</span></span>], <span class="hljs-string"><span class="hljs-string">'LIMIT'</span></span>: [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>], }</code> </pre> <br>  Finally, to get a fully formed string for each section, we must glue these pieces according to some rule.  Obviously, we will have a dictionary of correspondences of the section and the rules of gluing, separator.  For example, in SELECT we will connect all the pieces separated by commas.  And in WHERE or HAVING, the pieces will be glued together through AND. <br><br><h3>  <font color="#0000cc">API internal device</font> </h3><br>  How does it look all together?  Consider the diagram below. <br><br><img src="https://habrastorage.org/webt/s0/gr/zo/s0grzomvlcupokxgytivjjotvq8.png"><br><br>  As with any API, we need to validate incoming requests, in our case, a POST request with a JSON load.  Next we need to look at the correspondence of the names of the cubes to the names of classes in Python, initialize the corresponding classes, set filters, sort.  Next, we need to slip the objects of the classes into the generator so that it will glue us a line of the SQL query.  Then, through a special connector, in which all the logic of working with ClickHouse is made, the request will be sent to ClickHouse.  We must receive a response from the database, format it and give it to the user. <br><br><h3>  <font color="#0000cc">findings</font> </h3><br>  The project is developed on CPython 3.6.4.  We really like f-string.  If you do not use them, consider that life passes by you.  Equally important are ordered dictionaries, where the order of inserting keys is de facto guaranteed, and starting with Python 3.7, this guarantee will be official - also very convenient, taking into account the use of dictionaries, where the keys are the names of the SQL query sections, which must be followed in a certain order.  This significantly increased the speed of development.  Well, since different clients are included in this API, and a relatively high load is planned for the API, we decided to try asyncio and the <a href="https://habr.com/post/242541/">aiohttp framework</a> .  As a result, we got a fairly fast API. <br><br>  We also liked the thing called <a href="http://www.mypy-lang.org/">mypy</a> .  A great tool that can improve the quality of the code, forcing the programmer in some cases, it is better to decompose the functions and, of course, catch some of the errors before starting the program.  If you previously had experience with mypy and it was negative, it is definitely worth trying again - lately mypy has stabilized, some unpleasant bugs have been fixed. <br><br>  Since the ClickHouse API component is critical in our architecture, it is important for us to maintain the quality of the code.  We write a lot of unit tests with a large percentage of code coverage, and <a href="https://habr.com/post/269759/">pytest</a> helps us a lot with <a href="https://habr.com/post/269759/">this</a> .  Especially convenient is the ability to write parameterized tests.  We use this to compare the SQL queries that the generator creates across the various input JSON queries with the corresponding SQL reference queries. <br><br>  <b>PS</b> You can also watch the video from the presentation of Vitaly Samigullin (aka <a href="https://habr.com/users/pilosus/">pilosus</a> ). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/dHqxPoqW5CY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/358762/">https://habr.com/ru/post/358762/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358750/index.html">Integration of Veeam Backup & Replication and PureStorage</a></li>
<li><a href="../358752/index.html">OpenVINO Toolkit - to look at the world with a clear look</a></li>
<li><a href="../358754/index.html">Logging hits (payload) Google Analytics to Google Sheets via Google Tag Manager</a></li>
<li><a href="../358758/index.html">Need more gold. How is marketing in GameDev-company?</a></li>
<li><a href="../358760/index.html">Sales using voice assistant Yandex: create skills for Alice</a></li>
<li><a href="../358764/index.html">Fintech-digest: blockchain-smartphone from HTC, determination of solvency by phone brand and regulation of ICO in Russia</a></li>
<li><a href="../358766/index.html">How I started to love Vue</a></li>
<li><a href="../358768/index.html">Month after blocking Telegram: what has changed?</a></li>
<li><a href="../358770/index.html">How to pack three large banks in one site</a></li>
<li><a href="../358772/index.html">As we played the game ‚ÄúStone - scissors - paper‚Äù on the Ethereum blockchain. Part 2 Technical</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>