<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We speed up the restoration of backups in Postgres. Part Two (because shortening the time is not enough)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the article ‚ÄúAccelerating the restoration of backups in Postgres,‚Äù I described the steps taken to reduce recovery time in the loc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We speed up the restoration of backups in Postgres. Part Two (because shortening the time is not enough)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a00/87a/470/a0087a4707d442e5a4c70d0c65994869.jpeg"><br><br><p> In the <a href="https://habrahabr.ru/company/centosadmin/blog/328056/">first part of the article ‚ÄúAccelerating the restoration of backups in Postgres,‚Äù</a> I described the steps taken to reduce recovery time in the local environment.  We started with a simple one: pg_dump-drank (is there such a word?), Packed with gzip, unpacked and sent output to <code>psql &lt; file.sql</code> .  It took about 30 minutes to recover.  As a result, we stopped at <a href="https://www.postgresql.org/docs/current/static/app-pgdump.html">the Postgres customizable format</a> and applied the <code>-j</code> argument, achieving a reduction in time to 16 minutes. </p><br><p>  In this article, I described how we managed to reduce the size of the backup file, which further accelerated the recovery process. </p><a name="habracut"></a><br><h2 id="issleduem-razmer-bekapa">  Investigate the size of the backup </h2><br><p>  When I started writing about our attempts to speed up the recovery process, the size of the packed backup file was about 2 GB (unpacked - 30 GB).  Since then, our base has almost doubled (packed - 3.7 GB, unpacked - 68 GB).  This not only significantly increased the recovery time, but also took more time to copy / transfer the backup file. </p><br><p>  Realizing that the backup file had doubled, I began to find out why this happened and what data was to blame. </p><br><p>  At first I found out the size of the base: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># SELECT pg_size_pretty(pg_database_size('dbname')); pg_size_pretty ---------------- 68 GB (1 row)</span></span></code> </pre> <br><p>  Then I decided to look at the sizes of the tables in order to find out if there are any obvious culprits among the base's proliferation among them. </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># SELECT table_name, pg_relation_size(table_name), pg_size_pretty(pg_relation_size(table_name)) FROM information_schema.tables WHERE table_schema = 'public' ORDER by 2 DESC; table_name | pg_relation_size | pg_size_pretty -------------------+------------------+--------------- logging | 19740196864 | 18 GB reversions | 15719358464 | 15 GB webhook_logging | 8780668928 | 8374 MB ... | 1994645504 | 1902 MB ... | 371900416 | 355 MB ... | 304226304 | 290 MB</span></span></code> </pre> <br><p>  The listing clearly shows that the top 3 tables, which occupy more than 60% of the entire database, refer to history or logging, which are not needed for the dev environment.  Together with their indices (17 GB, 1 GB, 1.5 GB, respectively), these tables occupy 89% of the base.  At this point I decided to stop the study of the size of the tables (89% reduction is acceptable) and see if I can exclude the tables from the backup. </p><br><h2 id="umenshaem-razmer-rezervnoy-kopii">  Reduce backup size </h2><br><p>  Starting to deal with any problem, I try first to get acquainted with the documentation.  The PostgreSQL project in this regard did a wonderful job - after a few minutes of reading the <a href="https://www.postgresql.org/docs/current/static/app-pgdump.html"><code>pg_dump</code></a> section, I found exactly what was needed. </p><br><pre> <code class="bash hljs">pg_dump dbname -Fc \ --exclude-table-data <span class="hljs-string"><span class="hljs-string">'logging*'</span></span> \ --exclude-table-data <span class="hljs-string"><span class="hljs-string">'reversions*'</span></span> \ --exclude-table-data <span class="hljs-string"><span class="hljs-string">'webhooks_logging*'</span></span> &gt; postgres.dev.sql</code> </pre> <br><p>  <em>* (asterisk) is used here as a wildcard and helps to exclude also the indices of these tables.</em> </p><br><p>  Specifying excluded tables using the <code>--exclude-table-data</code> parameter allowed us to reduce the backup file size from 3.7 GB (uncompressed - 68 GB) to 0.7 GB (uncompressed - 5.4 GB). </p><br><p>  Looking at the listings, you can make sure that the results are just wonderful. </p><br><p>  <strong>Before:</strong> </p><br><pre> <code class="bash hljs">$ pg_restore -d db -j 8 dumpfc.gz real 16m49.539s user 1m1.344s sys 0m39.522s</code> </pre> <br><p>  <strong>After:</strong> </p><br><pre> <code class="bash hljs">$ pg_restore -d db -j 8 devfc.gz real 5m38.156s user 0m24.574s sys 0m13.325s</code> </pre> <br><p>  The exclusion of three tables allowed reducing the size of the base by 89% and speeding up the recovery by 66%!  If you remember, in the first part we started with 32.5 minutes.  So, we were able to reduce the recovery time by 26.9 minutes, or 87%. </p><br><p>  According to the results of this article, we achieved an acceleration of recovery from 16 to 5 minutes.  <strong>This saves us 57 hours of recovery time per year (6 developers 52 times a year for 11 minutes)</strong> .  In total, we have reduced the waiting time for recovery by 130 hours. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Returning to the <a href="https://www.postgresql.org/docs/current/static/populate.html">PostgreSQL documentation</a> , I note that there are several other ways to speed up the recovery process.  For example, you should take a look at the <code>-j</code> parameter of the <code>pg_dump</code> , which can shorten the time it takes to create a backup (available starting from PostgreSQL 9.3).  It may also help: disabling <code>autocommit</code> , a significant increase in <code>maintenance_work_mem</code> and setting a higher value for <code>max_wal_size</code> . </p><br><p>  At the moment, the recovery time of the backup of our database in the local dev-environment suits me perfectly. </p><br><p>  References: </p><br><ol><li>  Original: <a href="https://tech.gadventures.com/speeding-up-postgres-restores-part-2-4f09aad19fe8">Speeding up Postgres Restores Part 2 (Because it wasn‚Äôt just enough)</a> . </li><li>  <a href="https://habrahabr.ru/company/centosadmin/blog/328056/">We speed up the restoration of backups in Postgres.</a>  <a href="https://habrahabr.ru/company/centosadmin/blog/328056/">Part One</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328058/">https://habr.com/ru/post/328058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328048/index.html">All-In-One: Proxmox + OpenMediaVault or another idea for a home NAS</a></li>
<li><a href="../328050/index.html">There is no</a></li>
<li><a href="../328052/index.html">Boxing and unboxing - which is faster?</a></li>
<li><a href="../328054/index.html">2038: only 21 years left</a></li>
<li><a href="../328056/index.html">Accelerating the restoration of backups in PostgreSQL</a></li>
<li><a href="../328060/index.html">New version of HPE Recovery Management Central 4.0 is available for download.</a></li>
<li><a href="../328062/index.html">Services on Go in Badoo: how we write and support them</a></li>
<li><a href="../328064/index.html">3D modeling and animation: a guide for beginners</a></li>
<li><a href="../328066/index.html">Internet of things - marketing or a real threat</a></li>
<li><a href="../328068/index.html">Ensuring data and service availability: RPO, RTO performance and SLA planning</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>