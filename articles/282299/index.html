<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Especially unscientific: Tarantool 1.6 vs Golang (by speed)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I recently read about Tarantool, it became interesting. The idea is good - the code next to the database is stored in such a fast Redis-like environme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Especially unscientific: Tarantool 1.6 vs Golang (by speed)</h1><div class="post__text post__text-html js-mediator-article"><p>  I recently read about Tarantool, it became interesting.  The idea is good - the code next to the database is stored in such a fast Redis-like environment. </p><br><p>  And I thought about something - we are now actively using Golang at work, in fact, the thought came that a lot of things were written on Go, including  and embedded databases.  And what if you compare, for example, Go + LevelDB (actually, it would be possible to any other) against Tarantool.  I also tested Go + RocksDB, but it turned out to be a <a href="https://github.com/tecbot/gorocksdb/issues/49">bit more complicated</a> , and the result is about the same on small data. </p><br><p>  I tested a simple task ‚Äî an HTTP server; when prompted, write the key to the database, retrieve it by name (without any checks on the race), send back a simple JSON from this value. </p><br><p> Compared: <code>go+leveldb</code> , <code>tarantool</code> , <code>go+go-tarantool</code> , <code>nginx upstream tnt_pass</code> </p><a name="habracut"></a><br><p>  Looking ahead - in my unscientific test I won Go + LevelDB by using all the processor cores.  Most likely, if you run a few Tarantulas and a balancer, there may be some gain, but not to say that it is significant ... But, really, there will have to be replication or something like that. </p><br><p>  But, in general, Tarantool is a very impressive thing. </p><br><p>  <strong>Please note: I compare a very specific case</strong> , this does not mean that in all other cases, Go / LevelDB will win or lose. </p><br><p>  And also: instead of LevelDB, it's probably better to use RocksDB. </p><br><p>  So the result (briefly) </p><br><p>  <code>4-10</code> = 4 streams, 10 simultaneous connections <br>  <code>10-100</code> = 10 threads, 100 connections </p><br><p> <a href=""><img src="https://i.imgur.com/xTyjinZ.png" alt="image"></a> </p><br><p>  <strong>Please note</strong> Tarantool takes only 1 CPU thread (or rather, by the form 2), and was tested on a 4-line CPU.  Go uses all kernels and threads by default. </p><br><p>  nginx lua tnt_pass is taken from the <a href="https://habrahabr.ru/users/dedokone/" class="user_link">dedokOne</a> <a href="https://habrahabr.ru/post/282299/">comment</a> ( <a href="https://habrahabr.ru/post/282299/">result</a> ) </p><br><p>  <code>wrk -t 4 -c 10</code> (4 streams, 10 connections): </p><br><p>  Golang: </p><br><pre> <code class="hljs matlab"> Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span><span class="hljs-comment"><span class="hljs-comment">% 269.00us 99% 1.64ms Requests/sec: 25637.26</span></span></code> </pre> <br><p>  Tarantool: </p><br><pre> <code class="hljs matlab"> Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span><span class="hljs-comment"><span class="hljs-comment">% 694.00us 99% 1.43ms Requests/sec: 10377.78</span></span></code> </pre> <br><p>  But, Tarantula took about only half of the cores, so, probably, their speed is about the same. </p><br><p>  Under a large load ( <code>wrk -t 10 -c 100</code> ) Tarantula remained in place on the RPS (but latency sagged much more noticeably than Golang, especially the upper part), and Golang even cheered up (but latency also sagged, of course). </p><br><p>  Go: </p><br><pre> <code class="hljs matlab"> Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span><span class="hljs-comment"><span class="hljs-comment">% 2.85ms 99% 8.12ms Requests/sec: 33226.52</span></span></code> </pre> <br><p>  Tarantool: </p><br><pre> <code class="hljs matlab"> Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span><span class="hljs-comment"><span class="hljs-comment">% 8.69ms 99% 73.09ms Requests/sec: 10763.55</span></span></code> </pre> <br><p>  Tarantool has its advantages: secondary index, replication ... </p><br><p>  Go also has a huge ecosystem of libraries ( <a href="https://golanglibs.com/">about 100 thousand</a> by my calculations, among them and the implementations of embedded (and not very) databases - the <a href="https://golanglibs.com/category/databases">sea</a> ), and, as an example, the same <a href="https://github.com/blevesearch/bleve">bleve</a> gives a full-text search (which, as I understand it, , not in Tarantool). </p><br><p>  Feels like the Tarantula ecosystem is poorer.  At least everything that is offered - msgpack, http server, client, json, LRU cache, ... in Go is implemented in numerous variants .. </p><br><p>  That is, in general, there is no insane speed win. </p><br><p>  So far, <em>my personal choice</em> remains in the direction of Go, because there is no feeling that the Tarantool ecosystem will shoot so much in the near future, and Go has been actively developing for a long time. </p><br><p>  The code in Tarantool, of course, is shorter, but mainly due to the fact that errors are processed by the language.  In Go, you can also cut all the <code>err</code> and will remain about the same. </p><br><p>  Maybe someone has other opinions? </p><br><p>  Even in the comments we noticed about <strong>atomic code updates</strong> in Tarantool, but since we are talking about HTTP requests - we ( <a href="https://github.com/fvbock/endless">end of the</a> current place of work) use <a href="https://github.com/fvbock/endless">endless</a> for go and according to our tests (and we have thousands of requests there per second) - we update Go code without losing HTTP requests.  An example at the end of the article. </p><br><p>  And if more about the test: </p><br><pre> <code class="hljs pgsql"> ‚ûú ~ go <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> go <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> go1<span class="hljs-number"><span class="hljs-number">.6</span></span> darwin/amd64 ‚ûú ~ tarantool <span class="hljs-comment"><span class="hljs-comment">--version Tarantool 1.6.8-525-ga571ac0 Target: Darwin-x86_64-Release</span></span></code> </pre> <br><p>  Golang: </p><br><pre> <code class="hljs ruby">‚ûú ~ wrk -t <span class="hljs-number"><span class="hljs-number">4</span></span> -c <span class="hljs-number"><span class="hljs-number">10</span></span> -d <span class="hljs-number"><span class="hljs-number">5</span></span> --latency <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> Running <span class="hljs-number"><span class="hljs-number">5</span></span>s test @ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> threads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> connections Thread Stats Avg Stdev Max +<span class="hljs-regexp"><span class="hljs-regexp">/- Stdev Latency 346.71us 600.80us 26.94ms 97.89% Req/</span></span>Sec <span class="hljs-number"><span class="hljs-number">6.54</span></span>k <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">88</span></span>k <span class="hljs-number"><span class="hljs-number">13.87</span></span>k <span class="hljs-number"><span class="hljs-number">73.13</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">269.00</span></span>us <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">368.00</span></span>us <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">493.00</span></span>us <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">1.64</span></span>ms <span class="hljs-number"><span class="hljs-number">130717</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">5.10</span></span>s, <span class="hljs-number"><span class="hljs-number">15.08</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">25637.26</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">2.96</span></span>MB</code> </pre> <br><p>  Tarantool: </p><br><pre> <code class="hljs ruby">‚ûú ~ wrk -t <span class="hljs-number"><span class="hljs-number">4</span></span> -c <span class="hljs-number"><span class="hljs-number">10</span></span> -d <span class="hljs-number"><span class="hljs-number">5</span></span> --latency <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/</span></span> Running <span class="hljs-number"><span class="hljs-number">5</span></span>s test @ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> threads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> connections Thread Stats Avg Stdev Max +<span class="hljs-regexp"><span class="hljs-regexp">/- Stdev Latency 767.53us 209.64us 4.04ms 87.26% Req/</span></span>Sec <span class="hljs-number"><span class="hljs-number">2.61</span></span>k <span class="hljs-number"><span class="hljs-number">437.12</span></span> <span class="hljs-number"><span class="hljs-number">3.15</span></span>k <span class="hljs-number"><span class="hljs-number">45.59</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">694.00</span></span>us <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">90</span></span>ms <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">1.02</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">1.43</span></span>ms <span class="hljs-number"><span class="hljs-number">52927</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">5.10</span></span>s, <span class="hljs-number"><span class="hljs-number">8.58</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">10377.78</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">1.68</span></span>MB</code> </pre> <br><p>  Under greater load: </p><br><p>  Go: </p><br><pre> <code class="hljs ruby">‚ûú ~ wrk -t <span class="hljs-number"><span class="hljs-number">10</span></span> -c <span class="hljs-number"><span class="hljs-number">100</span></span> -d <span class="hljs-number"><span class="hljs-number">5</span></span> --latency <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> Running <span class="hljs-number"><span class="hljs-number">5</span></span>s test @ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> threads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> connections Thread Stats Avg Stdev Max +<span class="hljs-regexp"><span class="hljs-regexp">/- Stdev Latency 3.04ms 1.48ms 25.53ms 80.21% Req/</span></span>Sec <span class="hljs-number"><span class="hljs-number">3.34</span></span>k <span class="hljs-number"><span class="hljs-number">621.43</span></span> <span class="hljs-number"><span class="hljs-number">12.52</span></span>k <span class="hljs-number"><span class="hljs-number">86.20</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">2.85</span></span>ms <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">3.58</span></span>ms <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">4.57</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">8.12</span></span>ms <span class="hljs-number"><span class="hljs-number">166514</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">5.01</span></span>s, <span class="hljs-number"><span class="hljs-number">19.21</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">33226.52</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">3.83</span></span>MB</code> </pre> <br><p>  Tarantool: </p><br><pre> <code class="hljs ruby">‚ûú ~ wrk -t <span class="hljs-number"><span class="hljs-number">10</span></span> -c <span class="hljs-number"><span class="hljs-number">100</span></span> -d <span class="hljs-number"><span class="hljs-number">5</span></span> --latency <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/</span></span> Running <span class="hljs-number"><span class="hljs-number">5</span></span>s test @ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8080/</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> threads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> connections Thread Stats Avg Stdev Max +<span class="hljs-regexp"><span class="hljs-regexp">/- Stdev Latency 10.65ms 14.24ms 269.85ms 98.43% Req/</span></span>Sec <span class="hljs-number"><span class="hljs-number">1.09</span></span>k <span class="hljs-number"><span class="hljs-number">128.17</span></span> <span class="hljs-number"><span class="hljs-number">1.73</span></span>k <span class="hljs-number"><span class="hljs-number">94.56</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">8.69</span></span>ms <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">10.50</span></span>ms <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">11.36</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">73.09</span></span>ms <span class="hljs-number"><span class="hljs-number">53943</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">5.01</span></span>s, <span class="hljs-number"><span class="hljs-number">8.75</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">10763.55</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">1.75</span></span>MB</code> </pre> <br><p>  Test sources: </p><br><p>  Go: </p><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"io"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/syndtr/goleveldb/leveldb"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db *leveldb.DB <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { err := db.Put([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>), []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) io.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } res, err := db.Get([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) io.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } result, err := json.Marshal(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(res)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) io.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } w.Write(result) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> err error db, err = leveldb.OpenFile(<span class="hljs-string"><span class="hljs-string">"level.db"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(err) } http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, hello) fmt.Println(<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:8081/"</span></span>) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8081"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) }</code> </pre> <br><p>  Tarantool: </p><br><pre> <code class="hljs pgsql">#!/usr/bin/env tarantool <span class="hljs-type"><span class="hljs-type">box</span></span>.cfg{logger = <span class="hljs-string"><span class="hljs-string">'tarantool.log'</span></span>} space = <span class="hljs-type"><span class="hljs-type">box</span></span>.space.data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> space <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> space = <span class="hljs-type"><span class="hljs-type">box</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>.create_space(<span class="hljs-string"><span class="hljs-string">'data'</span></span>) space:create_index(<span class="hljs-string"><span class="hljs-string">'primary'</span></span>, { parts = {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'STR'</span></span>} }) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">handler</span></span>(req) space:put({<span class="hljs-string"><span class="hljs-string">'foo'</span></span>,<span class="hljs-string"><span class="hljs-string">'bar'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> val = space:<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'foo'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render({ <span class="hljs-type"><span class="hljs-type">json</span></span> = val[<span class="hljs-number"><span class="hljs-number">2</span></span>] }) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> print "http://127.0.0.1:8080/" require(<span class="hljs-string"><span class="hljs-string">'http.server'</span></span>).<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(<span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>) :route({ <span class="hljs-type"><span class="hljs-type">path</span></span> = <span class="hljs-string"><span class="hljs-string">'/'</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">handler</span></span>) :<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>()</code> </pre> <br><p>  Golang (atomic code replacement, without loss of compounds): </p><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">package</span></span> main import ( <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"io"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"syscall"</span></span> <span class="hljs-string"><span class="hljs-string">"io/ioutil"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/fvbock/endless"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/gorilla/mux"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/syndtr/goleveldb/leveldb"</span></span> ) var db *leveldb.DB func hello(w http.ResponseWriter, r *http.Request) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> db == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { // ()  ,      panic(<span class="hljs-string"><span class="hljs-string">"DB is not yet initialized"</span></span>) } err := db.Put([]<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>), []<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } res, err := db.Get([]<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } result, err := json.Marshal(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(res)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } w.Write(result) } func main() { var err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> mux1 := mux.NewRouter() mux1.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, hello).Methods(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>) fmt.Println(<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:8081/"</span></span>) server := endless.NewServer(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8081"</span></span>, mux1) server.BeforeBegin = func(add <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { ioutil.WriteFile(<span class="hljs-string"><span class="hljs-string">"server.pid"</span></span>, []<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, syscall.Getpid())), <span class="hljs-number"><span class="hljs-number">0755</span></span>) db, err = leveldb.OpenFile(<span class="hljs-string"><span class="hljs-string">"level.db"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.Sleep(<span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.Millisecond) db, err = leveldb.OpenFile(<span class="hljs-string"><span class="hljs-string">"level.db"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) } } server.ListenAndServe() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> db != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { db.Close() } }</code> </pre> <br><p>  After that, you can do a <code>go build</code> run and try to do a <code>go build; kill -1 $(cat server.pid)</code> during load <code>go build; kill -1 $(cat server.pid)</code>  <code>go build; kill -1 $(cat server.pid)</code> - no data loss was observed in my tests. </p><br><p>  <strong>In the comments recommended to try go + go-tarantool</strong> </p><br><p>  I tried: </p><br><p>  Lower load </p><br><pre> <code class="hljs ruby">‚ûú ~ wrk -t <span class="hljs-number"><span class="hljs-number">4</span></span> -c <span class="hljs-number"><span class="hljs-number">10</span></span> -d <span class="hljs-number"><span class="hljs-number">5</span></span> --latency <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> Running <span class="hljs-number"><span class="hljs-number">5</span></span>s test @ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> threads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> connections Thread Stats Avg Stdev Max +<span class="hljs-regexp"><span class="hljs-regexp">/- Stdev Latency 799.14us 502.56us 25.22ms 95.74% Req/</span></span>Sec <span class="hljs-number"><span class="hljs-number">2.55</span></span>k <span class="hljs-number"><span class="hljs-number">248.65</span></span> <span class="hljs-number"><span class="hljs-number">2.95</span></span>k <span class="hljs-number"><span class="hljs-number">85.22</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">727.00</span></span>us <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">843.00</span></span>us <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">1.02</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">2.03</span></span>ms <span class="hljs-number"><span class="hljs-number">51591</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">5.10</span></span>s, <span class="hljs-number"><span class="hljs-number">5.95</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">10115.52</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">1.17</span></span>MB</code> </pre> <br><p>  Huge pressure: </p><br><pre> <code class="hljs ruby">‚ûú ~ wrk -t <span class="hljs-number"><span class="hljs-number">10</span></span> -c <span class="hljs-number"><span class="hljs-number">100</span></span> -d <span class="hljs-number"><span class="hljs-number">5</span></span> --latency <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> Running <span class="hljs-number"><span class="hljs-number">5</span></span>s test @ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:8081/</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> threads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> connections Thread Stats Avg Stdev Max +<span class="hljs-regexp"><span class="hljs-regexp">/- Stdev Latency 7.49ms 4.00ms 65.06ms 81.21% Req/</span></span>Sec <span class="hljs-number"><span class="hljs-number">1.38</span></span>k <span class="hljs-number"><span class="hljs-number">357.31</span></span> <span class="hljs-number"><span class="hljs-number">8.40</span></span>k <span class="hljs-number"><span class="hljs-number">94.61</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">6.78</span></span>ms <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">8.86</span></span>ms <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">11.77</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">22.74</span></span>ms <span class="hljs-number"><span class="hljs-number">69091</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">5.10</span></span>s, <span class="hljs-number"><span class="hljs-number">7.97</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">13545.12</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">1.56</span></span>MB</code> </pre> <br><p>  Source: </p><br><p>  tarantool.lua: </p><br><pre> <code class="hljs pgsql">#!/usr/bin/env tarantool <span class="hljs-type"><span class="hljs-type">box</span></span>.cfg{ <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = <span class="hljs-string"><span class="hljs-string">'127.0.0.1:3013'</span></span>, logger = <span class="hljs-string"><span class="hljs-string">'tarantool.log'</span></span> } space = <span class="hljs-type"><span class="hljs-type">box</span></span>.space.data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> space <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-type"><span class="hljs-type">box</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">grant</span></span>(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'read,write,execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'universe'</span></span>) space = <span class="hljs-type"><span class="hljs-type">box</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>.create_space(<span class="hljs-string"><span class="hljs-string">'data'</span></span>) space:create_index(<span class="hljs-string"><span class="hljs-string">'primary'</span></span>, { parts = {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'STR'</span></span>} }) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> print(space.id) print(<span class="hljs-string"><span class="hljs-string">'Starting on 3013'</span></span>)</code> </pre> <br><p>  main.go: </p><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"io"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/tarantool/go-tarantool"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client *tarantool.Connection <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { spaceNo := <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(<span class="hljs-number"><span class="hljs-number">512</span></span>) _, err := client.Replace(spaceNo, []<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}{<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) io.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } indexNo := <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) resp, err := client.Select(spaceNo, indexNo, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, tarantool.IterEq, []<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}{<span class="hljs-string"><span class="hljs-string">"foo"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) io.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } first := resp.Data[<span class="hljs-number"><span class="hljs-number">0</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) result, err := json.Marshal(first[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.WriteHeader(<span class="hljs-number"><span class="hljs-number">500</span></span>) io.WriteString(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } w.Write(result) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> err error server := <span class="hljs-string"><span class="hljs-string">"127.0.0.1:3013"</span></span> opts := tarantool.Opts{ Timeout: <span class="hljs-number"><span class="hljs-number">500</span></span> * time.Millisecond, } client, err = tarantool.Connect(server, opts) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatalf(<span class="hljs-string"><span class="hljs-string">"Failed to connect: %s"</span></span>, err.Error()) } http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, hello) fmt.Println(<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:8081/"</span></span>) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8081"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) }</code> </pre> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282299/">https://habr.com/ru/post/282299/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282281/index.html">How to use JSON restrictions when working with PostgreSQL</a></li>
<li><a href="../282283/index.html">Student projects within the Google Summer of Code</a></li>
<li><a href="../282287/index.html">Separate host and user configurations in 3CX Phone System v14</a></li>
<li><a href="../282293/index.html">Use CommonJS modules in Rails with Browserify</a></li>
<li><a href="../282297/index.html">AdminVK - monitoring your own Vkontakte groups for new events using push notifications</a></li>
<li><a href="../282301/index.html">C / C ++: how to measure CPU time</a></li>
<li><a href="../282305/index.html">Optimizing the Nested Set model in PHPixie</a></li>
<li><a href="../282311/index.html">Organization of functional requirements for a large project</a></li>
<li><a href="../282313/index.html">Magic, broken calculator or just a "divorce"?</a></li>
<li><a href="../282317/index.html">Review of the review of the minuses of Bitrix, or the dude reads only the first 5 pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>