<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go: multithreading</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was interested in a topic about multithreading in Go: habrahabr.ru/post/195574 . 
 Carefully re-read the author and community comments and decided t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go: multithreading</h1><div class="post__text post__text-html js-mediator-article">  I was interested in a topic about multithreading in Go: <a href="http://habrahabr.ru/post/195574/">habrahabr.ru/post/195574</a> . <br>  Carefully re-read the author and community comments and decided that the topic was not fully disclosed. <br>  Further, in order not to misunderstand, I ask you to accept that hereinafter the term ‚Äústream‚Äù is used exclusively in the sense of ‚Äúthread‚Äù, and not in the meaning of ‚Äústream‚Äù.  Thank. <br><a name="habracut"></a><br>  Like the author of the first topic, I also love Go very much and use it at the first opportunity. <br>  I am also impressed with the style of its multithreading, and at any opportunity I apply parallelization. <br>  For example, the organization of work with the database using multiple threads has so far allowed to significantly increase the access speed and achieve acceptable values ‚Äã‚Äãeven for one process. <br>  But here's an example with channels got you thinking. <br>  On my car, the difference was not 10-20 times, but it was.  And the difference is very significant - in 2 threads, the task was performed approximately 2 times slower. <br>  I rewrote the program to a convenient form, added load cycles and a pair of keys to it.  And that's what came out of it. <br><br><div class="spoiler">  <b class="spoiler_title">Text of the program</b> <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">/* channel_test01.go * Tests how go-routines interact with channels * Call: channel_test01 --help * Pls, do not use name "channel_test", because this name always is used by go-pkg-system */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">// flag support for program var MAXPROCS int var LOAD_CYCLES int //internal burden cycle var Usage = func() { fmt.Fprintf(os.Stderr, "Usage channel_test01 [-maxprocs=NN] [-cycles=NN] \n", os.Args[0]) } func init() { flag.IntVar(&amp;MAXPROCS, "maxprocs", 1, "maxprocs for testing. From 1 to 256 "); flag.IntVar(&amp;LOAD_CYCLES, "cycles", 1000, "burden internal cycle for testing. From 1 to 1000000 and more "); } func main() { flag.Parse();//get MAXPROCS and LOAD_CYCLES from flags // runtime.GOMAXPROCS() returns previous max_procs max_procs := runtime.GOMAXPROCS(MAXPROCS) // second call to get real state max_procs = runtime.GOMAXPROCS(MAXPROCS) fmt.Println("MaxProcs = ", max_procs) ch1 := make(chan int) ch2 := make(chan float64) go chan_filler(ch1, ch2) go chan_extractor(ch1, ch2) fmt.Println("Total:", &lt;-ch2, &lt;-ch2) } func chan_filler(ch1 chan int, ch2 chan float64) { const CHANNEL_SIZE = 1000000 for i := 0; i &lt; CHANNEL_SIZE; i++ { for j := 0; j &lt; LOAD_CYCLES; j++ { i++ } //thus we avoid optimizer influence i = i - LOAD_CYCLES ch1 &lt;- i } ch1 &lt;- -1 ch2 &lt;- 0.0 } func chan_extractor(ch1 chan int, ch2 chan float64) { const PORTION_SIZE = 100000 total := 0.0 for { t1 := time.Now().UnixNano() for i := 0; i &lt; PORTION_SIZE; i++ { // burden cycle for j := 0; j &lt; LOAD_CYCLES; j++ { i++ } i = i - LOAD_CYCLES m := &lt;-ch1 if m == -1 { ch2 &lt;- total } } t2 := time.Now().UnixNano() dt := float64(t2 - t1)/1e9 //nanoseconds ==&gt; seconds total += dt fmt.Println(dt) } }</span></span></code> </pre> <br></div></div><br><br><h5>  results </h5><br>  Machine: Intel, 4 cores for 3 GHz, 4 GB RAM, linux-x86-64, kernel-3.11, golang-1.1.2 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The maximum reachable value of runtime.MAXPROCS on my machine is equal to 256. You can set more, but still will be set to 256. The default value = 1. <br><br>  The number of threads generated by the program (ps -C channel_test01 -L) <br>  With -maxprocs = 1: 3 streams. <br>  With -maxprocs = 2 or more: always 4 threads. <br><br>  Sometimes during long operations, 2 more streams appeared, which remained until the end of the process.  It looks like garbage collection. <br><br>  (I tried on one of the virtual servers, which shows the presence of 24 cores in / proc / cpuinfo. The number of threads on it was also equal to 4. But often there was a fifth thread - it is very similar to the fact that the greedy vds did not hurry to allocate memory , and the garbage collector got out to look around). <br><br><h6>  Dependence of the channel filling speed on the number of threads with cycles = 1000 </h6><br><img src="https://habrastorage.org/storage3/5b1/986/143/5b19861430d520ba06dfcfaf59ced2ed.png" alt="perf-procs graph"><br><br>  Maximum performance develops with MAXPROCS = 1 <br><br><h6>  The dependence of the filling rate of the channel from the increase in ballast load </h6><br><br><img src="https://habrastorage.org/storage3/f92/8df/fad/f928dffadee01623e59c073dd1d06234.png" alt="perf-load graph"><br><br>  Under load, multi-threading still takes its toll. <br><br><h5>  Conclusions from the graphs </h5><br>  With maxprocs = 1, everything works in 1 thread, pseudo-multithreading is provided by the internal goal scheduler, which is very effective. <br>  When maxprocs = 2 or more, more streams appear, the interaction mechanism between streams is activated.  There are locks, and everything becomes slower, on sleeping streams - about 2 times. <br>  With maxprocs = 3..256, the actual number of threads in the system does not grow, but some of the flows become ‚Äúpseudo-flows‚Äù, the interaction between which begins to fall under the control of the internal glang scheduler.  This gives a small increase in speed with each increase in the number of "pseudo-threads." <br>  With a further increase in maxprocs (up to its maximum value of 256), more and more threads become pseudo-threads and fall under the control of the internal scheduler.  But some of the threads still remain independent system threads.  On sleep streams and fast calculations, this costs us about 10% of the performance. <br><br><h5>  Conclusion. </h5><br>  Changing the runtime.MAXPROCS parameter can bring both gains and performance losses.  This again confirms the general principle that the effect of parallelization depends on the specific task and specific equipment. </div><p>Source: <a href="https://habr.com/ru/post/195818/">https://habr.com/ru/post/195818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195808/index.html">We configure the HTTPS server on nginx</a></li>
<li><a href="../195810/index.html">Repairing a car with a 3D printer</a></li>
<li><a href="../195812/index.html">Derby.js deploy on Amazon EC2</a></li>
<li><a href="../195814/index.html">Timers in .Net</a></li>
<li><a href="../195816/index.html">Javascript function argument schema or C-style prototypes without heavyweight frameworks</a></li>
<li><a href="../195820/index.html">Automated test report generation</a></li>
<li><a href="../195830/index.html">We write a game development framework - Mechanic Framework</a></li>
<li><a href="../195832/index.html">Binary heap: proof of the complexity of the construction of O (n)</a></li>
<li><a href="../195834/index.html">Linear representation of an octree using the Morton code</a></li>
<li><a href="../195836/index.html">Methods for solving color perception problems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>