<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write chat bot quiz using Microsoft Bot Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have a tradition - every spring we participate in the Career Days of our beloved Novosibirsk State University, the main forge of our cadres. And ev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write chat bot quiz using Microsoft Bot Framework</h1><div class="post__text post__text-html js-mediator-article"><p>  We have a tradition - every spring we participate in the Career Days of our beloved Novosibirsk State University, the main forge of our cadres.  And every year we come up with something curious for students.  This year we made a master class on how to write a chat bot.  To register for a master class, Telegram launched its own Akademik bot @academic_quiz_bot.  He was all together and collected at the master class. </p><br><p><img src="https://habrastorage.org/files/f04/fff/407/f04fff407fee49829d2d40f2049c922d.png" alt="image"></p><br><p>  If you haven‚Äôt got a nice bot yet, now we‚Äôll tell you how to choose a theme and, in fact, make a bot. </p><br><a name="habracut"></a><br><h2>  Step 1. Chat bot and career days, where is the connection? </h2><br><p>  It was not easy to come up with an interesting topic for the master class, because you have to compete with yourself.  Two years ago, in an hour and a half of the master class, in front of the students, we <a href="https://habrahabr.ru/company/eastbanctech/blog/255727/">wrote an</a> iPhone <a href="https://habrahabr.ru/company/eastbanctech/blog/255727/">mobile app</a> that shows the weather around their alma mater NGU (more than 5000 downloads and continues to <a href="https://itunes.apple.com/ru/app/%25D1%2582%25D0%25B5%25D1%2580%25D0%25BC%25D0%25BE%25D0%25BC%25D0%25B5%25D1%2582%25D1%2580-%25D0%25BD%25D0%25B3%25D1%2583/id983980568%3Fmt%3D8">download</a> ).  A year ago, we <a href="https://habrahabr.ru/company/eastbanctech/blog/281238/">made an IoT solution in 1.5 hours</a> and learned how to light a light bulb from a smartphone.  This year it was necessary to do something equally incendiary, and we decided to teach students how to do chat bots, because these virtual interlocutors are now experiencing an explosive growth in popularity. </p><br><p>  The idea of ‚Äã‚Äãmaking a chat bot traditionally came from us not from the ceiling - for one of our customers, we just developed a chat bot in Telegram, which allows territorial managers of the company without access to a stationary computer and fast internet, to manage projects quickly - to appoint, delegate tasks and monitor the status of their execution. <br>  In addition, the bot was a convenient way to collect student contacts in a playful way and invite them to a master class. </p><br><p><img src="https://habrastorage.org/files/319/a36/ffe/319a36ffe6c84b328f9718b11a38a33d.jpg" alt="image"></p><br><h2>  Step 2. What are we going to chat about? </h2><br><p>  Bot we certainly wanted to make it useful for him to continue to live and delight everyone after the Career Days.  After much deliberation and controversy, we have found such a topic!  It was based on Alexey Kozionov‚Äôs popular <a href="http://evgenykozionov.com/viktorina/">online questionnaire</a> on the knowledge of the Novosibirsk Academgorodok.  And a week before the master class, we launched our Academician @academic_quiz_bot chat bot in the Telegram. </p><br><p>  ‚ÄúAkademik‚Äù asks curious questions (101 questions altogether) with answers to the life of the beloved district, like: ‚ÄúWhat is called‚Äú Toadstool ‚Äùat Academgorodok?‚Äù, ‚ÄúWhat American president visited Akademgorodok?‚Äù, ‚ÄúWhy is the neighborhood called Sh)? , ‚ÄúHow many steps does a staircase leading from the central beach to the bridge have?‚Äù, ‚ÄúWhich of the Nobel Prize winners lived in Akademgorodok?‚Äù And so on. </p><br><p><img src="https://habrastorage.org/files/fed/ad0/fc0/fedad0fc0d8a4d6c99eb77c5b0e45b72.jpg" alt="image"></p><br><p>  ‚ÄúAkademika‚Äù we added a sticker with encouraging phrases from our talisman - ebtman. </p><br><p><img src="https://habrastorage.org/files/6e1/8e4/da9/6e18e4da9f8b46deadfcdd295043f26d.jpg" alt="image"></p><br><p>  You <a href="https://t.me/addstickers/EastBanc">can</a> download Stickpack <a href="https://t.me/addstickers/EastBanc">here.</a> </p><br><p>  In the first week of life, the bot also worked as a registrar for a master class and carefully collected the contacts of the participants.  And now it's just an entertaining test.  Anyone who knows Akademgorodok, welcome the quiz to our colleges. </p><br><h2>  Step.  3. Recipe Chat Boot Quiz </h2><br><p>  About creating a chat bot using the Microsoft Bot Framework on Habr√© has been written a lot.  But tutorials - units.  Therefore, for all those who have not yet written down a virtual ‚Äútalker‚Äù for themselves, we tell our recipe. </p><br><p><img src="https://habrastorage.org/files/019/1ca/654/0191ca654239404e87b831e09c4fcdb1.JPG" alt="image"></p><br><p>  First, create a project in Visual Studio using the Bot Application Template. </p><br><p><img src="https://habrastorage.org/files/21f/737/765/21f737765828463c99226201e3dba1cd.png" alt="image"></p><br><p>  After creation, we immediately receive a finished ‚ÄúEcho‚Äù bot, which repeats the message sent to it in response.  We can start the project with the F5 button.  In the browser, the default page will look like this: </p><br><p><img src="https://habrastorage.org/files/680/7e0/19d/6807e019dfda446b93a15c4a4aba7d17.png" alt="image"></p><br><p>  Copy the address and run the emulator. </p><br><p><img src="https://habrastorage.org/files/24d/2d9/122/24d2d91224c54597bdf30357271e3200.png" alt="image"></p><br><p>  Where to paste the copied address and append api / messages.  We check that everything works. <br>  Next, we will improve our bot.  Make him ask his questions and check the answers. <br>  First we need data for questions.  You can do this in different ways.  Can be stored locally or downloaded from the cloud.  We chose the second option. <br>  Create a simple class for loading questions. </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">QuestService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> QuestService _instance; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> QuestService Instance =&gt; _instance ?? (_instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QuestService()) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _url = <span class="hljs-string"><span class="hljs-string">"https://academicquizbot.blob.core.windows.net/content/questions.txt"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;Question&gt; _questions; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> QuestionsCount =&gt; _questions.Count; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QuestService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> root = DoRequest&lt;QuestionRoot&gt;(_url); _questions = root.Questions; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _questions.Count; i++) { _questions[i].Index = i; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> T DoRequest&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> requestStr) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req = WebRequest.Create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(requestStr)); req.Method = <span class="hljs-string"><span class="hljs-string">"GET"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = req.GetResponse(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stream = response.GetResponseStream(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stream == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rstream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamReader(stream)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stringResult = rstream.ReadToEnd(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = JsonConvert.DeserializeObject&lt;T&gt;(stringResult); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Question </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetQuestion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; exceptIndexes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> questions = _questions.Select(q =&gt; q) .Where(q =&gt; !exceptIndexes.Contains(q.Index)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (questions.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> questions[rand.Next(questions.Count)]; } }</code> </pre> <br><p>  When creating this class, it will download questions from the server and, if necessary, return the next question excluding those that the user has already answered. </p><br><p>  Create a new class in Visual Studio called QuizDialog.  And we implement the IDialog &lt;string&gt; interface in it. </p><br><pre> <code class="hljs cpp">[Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QuizDialog</span></span></span><span class="hljs-class"> :</span></span> IDialog&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; { async Task IDialog&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;.StartAsync(IDialogContext context) { context.Wait&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;(MessageReceived); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessageReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDialogContext context, IAwaitable&lt;</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; message)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">await </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowQuestion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowQuestion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDialogContext context)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Implement the ShowQuestion function.  First, download a list of questions already passed from the repository. </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> history = <span class="hljs-type"><span class="hljs-type">DataProviderService</span></span>.<span class="hljs-type"><span class="hljs-type">Instance</span></span>.<span class="hljs-type"><span class="hljs-type">GetAnswerStatistic</span></span>(context.<span class="hljs-type"><span class="hljs-type">Activity</span></span>.<span class="hljs-type"><span class="hljs-type">From</span></span>.<span class="hljs-type"><span class="hljs-type">Id</span></span>);</code> </pre> <br><p>  And ask for the next question. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exceptIndexes = history.Select(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">h</span></span></span><span class="hljs-function"> =&gt;</span></span> h.Index).ToList(); _question = QuestService.Instance.GetQuestion(exceptIndexes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_question == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { context.Done(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br><p>  If there are no questions, then we consider the quiz passed and return control to the parent dialogue. <br>  Next, send the question text to the user. </p><br><pre> <code class="hljs vhdl">StringBuilder questionText = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); questionText.AppendLine(BoldString($<span class="hljs-string"><span class="hljs-string">" ‚Ññ{history.Count + 1}:"</span></span>)); questionText.AppendLine(_question.<span class="hljs-literal"><span class="hljs-literal">Text</span></span>); questionText.AppendLine(_question.ImageUrl); var reply = <span class="hljs-keyword"><span class="hljs-keyword">context</span></span>.MakeMessage(); reply.<span class="hljs-literal"><span class="hljs-literal">Text</span></span> = questionText.ToString(); reply.TextFormat = <span class="hljs-string"><span class="hljs-string">"xml"</span></span>; await <span class="hljs-keyword"><span class="hljs-keyword">context</span></span>.PostAsync(reply);</code> </pre> <br><p>  Also, pictures can be transmitted not via url (although I believe that it is more reliable in a telegram that way), but through Attachment. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(_question.ImageUrl)) { reply.Attachments.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Attachment(<span class="hljs-string"><span class="hljs-string">"image/jpg"</span></span>, _question.ImageUrl)); }</code> </pre> <br><p>  BoldString function code: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BoldString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(text)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;b&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{text}</span></span></span><span class="hljs-string">&lt;/b&gt;"</span></span>; }</code> </pre> <br><p>  The text is formatted in "xml" to divide the text into lines and highlight the line with the question numbers in bold color.  Here it should be borne in mind that not all instant messengers support the same formats; here it is worth reading the documentation. </p><br><p>  Next we need to display a list of answers.  We will display in two ways.  Since we have answers with long text.  We will simply display such numbers as numbers and buttons with answer numbers after.  And if the answers are short (up to 30 characters), then we will display them immediately in the form of buttons. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isLongAnswer = _question.Answers.Any(a =&gt; a.Length &gt; LongTextLength); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answers = _question.Answers; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLongAnswer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answersReply = context.MakeMessage(); StringBuilder text = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); answers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _question.Answers.Count; i++) { text.AppendLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{i+</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">1</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">) </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_question.Answers[i]}</span></span></span><span class="hljs-string">"</span></span>); answers.Add(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{i + </span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">1</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">"</span></span>); } answersReply.Text = text.ToString(); answersReply.TextFormat = <span class="hljs-string"><span class="hljs-string">"xml"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.PostAsync(answersReply); } ResumeAfter&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; answerRecived = AnswerReceived; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLongAnswer) { answerRecived = LongAnswerReceived; } PromptDialog.Choice(context, answerRecived, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PromptOptions&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;( prompt: <span class="hljs-string"><span class="hljs-string">"   . \n /exit -  "</span></span>, retry: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, tooManyAttempts: <span class="hljs-string"><span class="hljs-string">""</span></span>, options: answers, attempts: <span class="hljs-number"><span class="hljs-number">0</span></span>, promptStyler: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PromptStyler(), descriptions: answers));</code> </pre> <br><p>  Actually, the PromptDialog.Choice function shows a dialog with buttons.  Next we need two functions to handle the user's selection. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnswerReceived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDialogContext context, IAwaitable&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isCorrect = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> message; isCorrect = answer == _question.CorrectAnswer; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ignored } await ShowResult(context, isCorrect); } private async Task LongAnswerReceived(IDialogContext context, IAwaitable&lt;string&gt; message) { bool isCorrect = false; try { var answer = await message; var answerNumber = int.Parse(answer) - 1; isCorrect = _question.Answers[answerNumber] == _question.CorrectAnswer; } catch { // ignored } await ShowResult(context, isCorrect); }</span></span></code> </pre> <br><p>  If the user has written something incorrect, we consider his answer to be incorrect.  Here we are the villains. </p><br><p>  Next, you need to show the correct answer and statistics.  And small bonuses if the user communicates with the bot via a ‚Äútelegram‚Äù to encourage him with a sticker. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDialogContext context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isCorrect</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> isCorrectStr; Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> sticker = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCorrect) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = rand.Next(Consts.CorrectAnswers.Length); isCorrectStr = Consts.CorrectAnswers[index]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stickerIndex = rand.Next(Consts.GoodStickers.Length); sticker = Consts.GoodStickers[stickerIndex]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = rand.Next(Consts.BadAnswers.Length); isCorrectStr = Consts.BadAnswers[index]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stickerIndex = rand.Next(Consts.BadStickers.Length); sticker = Consts.BadStickers[stickerIndex]; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isTelegram = context.Activity.ChannelId == <span class="hljs-string"><span class="hljs-string">"telegram"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isTelegram &amp;&amp; rand.Next(<span class="hljs-number"><span class="hljs-number">100</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBotClient(Consts.Telegram.Token); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> bot.SendStickerAsync(context.Activity.From.Id, sticker); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reply = context.MakeMessage(); reply.Text = BoldString(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{isCorrectStr}</span></span></span><span class="hljs-string">"</span></span>); reply.TextFormat = <span class="hljs-string"><span class="hljs-string">"xml"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.PostAsync(reply); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnswerStatistic { Index = _question.Index, IsCorrect = isCorrect }; DataProviderService.Instance.AddAnswerStatistics(context.Activity.From.Id, answer); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ShowAnswerDescribe(context); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ShowStatistic(context); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ShowQuestion(context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowAnswerDescribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDialogContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reply = context.MakeMessage(); reply.Text = _question.DescribeAnswer + _question.DescribeAnswerImageUrl; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.PostAsync(reply); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowStatistic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDialogContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = DataProviderService.Instance.GetUser(context.Activity.From.Id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> history = DataProviderService.Instance.GetAnswerStatistic(context.Activity.From.Id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reply = context.MakeMessage(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> correctCount = history.Count(h =&gt; h.IsCorrect); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> questionsCount = QuestService.Instance.QuestionsCount; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text = <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{history.Count}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{questionsCount}</span></span></span><span class="hljs-string">   : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{correctCount}</span></span></span><span class="hljs-string">"</span></span>; reply.Text = text; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.PostAsync(reply); }</code> </pre> <br><p>  Further in MessagesController it is necessary to cause our dialogue. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromBody]Activity activity</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activity.Type == ActivityTypes.Message) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Conversation.SendAsync(activity, () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QuizDialog()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { HandleSystemMessage(activity); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = Request.CreateResponse(HttpStatusCode.OK); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response; }</code> </pre> <br><p>  After debugging in the emulator, you can publish the bot.  <a href="https://habrahabr.ru/post/307530/">Here</a> it is already described. </p><br><p>  And our project is entirely <a href="https://github.com/eastbanctechru/academic-quiz-bot">here.</a> </p><br><h2>  Step 4. Summing up </h2><br><p>  This student spring, we taught young people how to write their own chat bots and gathered a record number of participants for us at the master class.  We met the fans again ÔÅä We have guys, in the sense of a boy and a girl, who have been attending master classes for the third year in a row and, finally, have grown to 4 courses.  They say they will write a diploma and come to us right away (we will not take students anyway before the 4th year students). </p><br><p>  And also, they themselves enjoyed a great deal of communication with young people and inspiration for new projects!  Well, we really love our quiz and recommend it to anyone who is familiar with Academ - @academic_quiz_bot. </p><br><p><img src="https://habrastorage.org/files/f1f/70e/c1c/f1f70ec1c14248b4a33336ff3dd87a3c.png" alt="image"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327094/">https://habr.com/ru/post/327094/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327080/index.html">As I wrote a sentence to the standard C ++</a></li>
<li><a href="../327084/index.html">Classic and new internet marketing aids worth seeing</a></li>
<li><a href="../327086/index.html">Predictive analytics on the SCP platform</a></li>
<li><a href="../327088/index.html">How we built the cloud processing infrastructure for cross-product analytics</a></li>
<li><a href="../327090/index.html">On the MegaFon Card - technical details, part 2</a></li>
<li><a href="../327096/index.html">"Dream lazy" or the script engine on itself</a></li>
<li><a href="../327098/index.html">Oculus Rift games that can already be played</a></li>
<li><a href="../327100/index.html">UX-recipe phone number and email confirmation</a></li>
<li><a href="../327104/index.html">How I built NAS at home</a></li>
<li><a href="../327106/index.html">Managing the "power of thought": a resident accelerator at ITMO University</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>