<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúWe are starting! I said: let's start! ‚Äù, Or how we implemented the work with faststart-video for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most owners of smartphones, tablets and other gadgets daily consume a huge amount of digital information, including media: images, music and, of cours...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúWe are starting! I said: let's start! ‚Äù, Or how we implemented the work with faststart-video for Android</h1><div class="post__text post__text-html js-mediator-article">  Most owners of smartphones, tablets and other gadgets daily consume a huge amount of digital information, including media: images, music and, of course, video.  On the last dwell in more detail.  It is very important not to make users wait for content, especially when millions of people use the application every day.  There is a lot of video content in the iFunny application we are working on, and we thought that downloading the whole video is long, uninteresting and not scalable.  And what if in the near future you need to download a video that is not in 30-60 seconds, but in 5-10 minutes?  Make the user wait half a minute while the video is downloading?  And if the connection is bad?  So the interest in the application is not long to lose.  Therefore, we decided to make a faststart-video.  Details under the cut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gb/es/gc/gbesgclqf-4aksi0_tgvb6-bdtm.jpeg"></div><br><a name="habracut"></a><br>  So, the task is set, it's time to decompose it: <br><br><ul><li>  to study the structure and features of faststart-video; </li><li>  find out if our player supports this type of video; </li><li>  implement faststart playback; </li><li>  handle situations where download stops during playback. </li></ul><br>  First, let's see what the faststart video is all about. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Immediately, I‚Äôll make a reservation that the discussion will focus on the MP4 format (GIF and WebM are also supported), since basically the video in iFunny has this format.  I think I will not reveal America to you if I say that the video file consists of fragments and can be decoded in parts.  But how to decode it in parts if the metadata (Moov-atoms) of the video are in different parts of the file?  This is where the faststart flag comes into play.  With the help of it, all Moov-atoms at conversion are transferred to the beginning of the file.  To perform this kind of operation using FFmpeg, you need to add faststart to the movflags, for example: <br><br><pre><code class="bash hljs">ffmpeg -i &lt;input&gt; -c:v libx264 -c:a aac -movflags +faststart output.mp4</code> </pre> <br>  And after some simple manipulations, we will have a video ready for testing. <br><br>  So, we figured out with faststart, it‚Äôs time to check if our player has support for playing this type of video. <br><br>  We use <a href="https://github.com/Bilibili/ijkplayer">Ijkplayer from bilibili</a> , since at the time of the development of the first versions of the application, it provided much more functionality than the same <a href="https://github.com/google/ExoPlayer">ExoPlayer</a> . <br><br>  In the Ijkplayer documentation, nothing is written about the faststart video.  But we already have implemented file playback logic.  Then, looking at the <code>setDataSource(Context context, Uri uri)</code> method <code>setDataSource(Context context, Uri uri)</code> , to which we pass the URI to the video file as a parameter, the question arose: what other implementations does it have?  Can I just pass the URL to the video, and the player will figure it out himself?  Can.  But this method has limitations that are categorically not suitable for us: the inability to rewind and loop the video.  After studying the implementations of the setDataSource method, we found the answer with the previously unexplored parameter setDataSource (IMediaDataSource mediaDataSource).  Everything became clear after we looked inside the interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMediaDataSource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readAt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException</span></span>; }</code> </pre> <br>  The developers of Ijkplayer made an interface with which we can ‚Äúfeed‚Äù video player parts in the form of an array of bytes, after specifying its final size. <br>  From this it follows that we can render the video in parts, and this is exactly what we need.  Now let's move from words to deeds. <br><br>  Let's divide our subtask ‚ÄúImplement faststart playback‚Äù into 2 parts: <br><br><ul><li>  implement download video in parts; </li><li>  realize reading the video in parts and the ability to read from any part of the file. </li></ul><br>  We need to simultaneously write to the file when downloading and read from it during playback, and also change the pointer in the file to play the video again.  This feature is provided by the RandomAccessFile class, which means we will use it.  To download use the library OkHttp.  Could a situation arise when we have a half-downloaded video?  Of course it can!  So, we need somewhere to store information about the size of the downloaded part, as well as to know the final video size.  Therefore, we will make a separate model for this purpose and call it MediaCache. <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MediaCache</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cacheFile: File) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> finalSize: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> downloadedSize: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> isCachePartiallyDownloaded: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() = downloadedSize != <span class="hljs-number"><span class="hljs-number">0L</span></span> &amp;&amp; finalSize &gt; downloadedSize }</code> </pre> <br>  In this article you will not find how to manage this cache, since for each it will most likely be an individual implementation feature.  Just say that we use our LRU cache.  Read more about LRU <a href="https://habr.com/post/136758/">here</a> . <br>  Let's go back to the download.  We outlined the main points.  Let's see how it looks in practice: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">fun</span></span> download(url: <span class="hljs-type"><span class="hljs-type">String</span></span>) { val requestBuilder = <span class="hljs-type"><span class="hljs-type">Request</span></span>.<span class="hljs-type"><span class="hljs-type">Builder</span></span>().url(url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mediaCache.isCachePartiallyDownloaded) { requestBuilder.addHeader(<span class="hljs-string"><span class="hljs-string">"Range"</span></span>, <span class="hljs-string"><span class="hljs-string">"bytes=${mediaCache.downloadedSize}-"</span></span>) } val response = mediaHttpClient.newCall(requestBuilder.build()).execute() //   ,     <span class="hljs-number"><span class="hljs-number">200</span></span>  <span class="hljs-number"><span class="hljs-number">206</span></span>    <span class="hljs-type"><span class="hljs-type">Range</span></span>   <span class="hljs-type"><span class="hljs-type">Range</span></span> . val responseCode = response.code() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (responseCode == <span class="hljs-number"><span class="hljs-number">200</span></span> || responseCode == <span class="hljs-number"><span class="hljs-number">206</span></span>) { handleResponse(response.body()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // . } } override fun handleResponse(responseBody: <span class="hljs-type"><span class="hljs-type">ResponseBody</span></span>?) { responseBody?.<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> { body -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mediaCache.finalSize == <span class="hljs-number"><span class="hljs-number">0</span></span>L) { mediaCache.finalSize = body.contentLength() } val file = <span class="hljs-type"><span class="hljs-type">RandomAccessFile</span></span>(mediaCache.cacheFile, <span class="hljs-string"><span class="hljs-string">"rw"</span></span>) file.use { it.seek(mediaCache.downloadedSize) writeResponseInFile(body, it) } } } private fun writeResponseInFile(responseBody: <span class="hljs-type"><span class="hljs-type">ResponseBody</span></span>, file: <span class="hljs-type"><span class="hljs-type">RandomAccessFile</span></span>) { responseBody.use { val inputStream = <span class="hljs-type"><span class="hljs-type">BufferedInputStream</span></span>(it.byteStream()) inputStream.use { stream -&gt; var currentDownloadedSize: <span class="hljs-type"><span class="hljs-type">Long</span></span> = mediaCache.downloadedSize val finalSize = mediaCache.finalSize val <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ByteArray</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BYTE_ARRAY_SIZE</span></span></span><span class="hljs-class">) var count: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> while (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentDownloadedSize</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">finalSize</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class"> != -1) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentDownloadedSize</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toLong</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mediaCache</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloadedSize</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentDownloadedSize</span></span></span><span class="hljs-class"> } } } } }</span></span></code> </pre> <br>  Very similar to the usual file download, is not it?  That's just in parallel, the player will immediately read from this file.  At this point, we move on to the second part of our subtask: let's make the player reproduce what we have.  As it turned out, this is trivial: you just need to give the player bytes at the position that it asks for.  In fact, there were only two dozen lines: <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomMediaDataSource</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mediaCache: MediaCache): IMediaDataSource { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cacheFile: RandomAccessFile = RandomAccessFile(mediaCache.cacheFile, <span class="hljs-string"><span class="hljs-string">"r"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Throws(IOException::class)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readAt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(position: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, buffer: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ByteArray</span></span></span></span><span class="hljs-function"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, size: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cacheFile.filePointer != position) { cacheFile.seek(position) } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count = cacheFile.read(buffer, offset, size) <span class="hljs-comment"><span class="hljs-comment">/** *    -1,     ,   : ,     . *   ,       . *    ‚Äî  0,      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count == -<span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; position != mediaCache.finalSize) count = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mediaCache.finalSize } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { cacheFile.close() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Throwable) { Assert.fail(e.message) } } }</code> </pre><br>  Fine!  Everything worked, it remains only to finish a couple of small things, namely, to study the callbacks from the player and implement the progress bar display during video buffering / reloading.  To do this, take a look at the IMediaPlayer interface, in which, besides the main methods, there are many constants. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMediaPlayer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* * Do not change these values without updating their counterparts in native */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_UNKNOWN = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_STARTED_AS_NEXT = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_VIDEO_RENDERING_START = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_VIDEO_TRACK_LAGGING = <span class="hljs-number"><span class="hljs-number">700</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_BUFFERING_START = <span class="hljs-number"><span class="hljs-number">701</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_BUFFERING_END = <span class="hljs-number"><span class="hljs-number">702</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_NETWORK_BANDWIDTH = <span class="hljs-number"><span class="hljs-number">703</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_BAD_INTERLEAVING = <span class="hljs-number"><span class="hljs-number">800</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_NOT_SEEKABLE = <span class="hljs-number"><span class="hljs-number">801</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_METADATA_UPDATE = <span class="hljs-number"><span class="hljs-number">802</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_TIMED_TEXT_ERROR = <span class="hljs-number"><span class="hljs-number">900</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_UNSUPPORTED_SUBTITLE = <span class="hljs-number"><span class="hljs-number">901</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_SUBTITLE_TIMED_OUT = <span class="hljs-number"><span class="hljs-number">902</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_VIDEO_ROTATION_CHANGED = <span class="hljs-number"><span class="hljs-number">10001</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_AUDIO_RENDERING_START = <span class="hljs-number"><span class="hljs-number">10002</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_AUDIO_DECODED_START = <span class="hljs-number"><span class="hljs-number">10003</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_VIDEO_DECODED_START = <span class="hljs-number"><span class="hljs-number">10004</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_OPEN_INPUT = <span class="hljs-number"><span class="hljs-number">10005</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_FIND_STREAM_INFO = <span class="hljs-number"><span class="hljs-number">10006</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_COMPONENT_OPEN = <span class="hljs-number"><span class="hljs-number">10007</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_MEDIA_ACCURATE_SEEK_COMPLETE = <span class="hljs-number"><span class="hljs-number">10100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_UNKNOWN = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_SERVER_DIED = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_NOT_VALID_FOR_PROGRESSIVE_PLAYBACK = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_IO = -<span class="hljs-number"><span class="hljs-number">1004</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_MALFORMED = -<span class="hljs-number"><span class="hljs-number">1007</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_UNSUPPORTED = -<span class="hljs-number"><span class="hljs-number">1010</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_ERROR_TIMED_OUT = -<span class="hljs-number"><span class="hljs-number">110</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOnInfoListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OnInfoListener listener)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInfoListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IMediaPlayer mp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> what, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> extra)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IMediaDataSource mediaDataSource)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *      ,   . */</span></span> }</code> </pre> <br>  Of all these constants, we only need 3 to implement / hide the progress bar: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_VIDEO_RENDERING_START = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_BUFFERING_START = <span class="hljs-number"><span class="hljs-number">701</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MEDIA_INFO_BUFFERING_END = <span class="hljs-number"><span class="hljs-number">702</span></span>;</code> </pre> <br>  You need to understand that the player can manually set the size of video buffering (we set it in a feature from the server), so a situation may arise when video rendering requires less bytes than the minimum buffer.  That is, we need to take into account that rendering can start earlier than the callback with the end of buffering code is called.  And for these callbacks, the OnInfoListener interface is responsible, which we need to implement: <br><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InfoListener</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMediaPlayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnInfoListener</span></span></span><span class="hljs-class"> { override fun onInfo(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mp</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMediaPlayer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">what</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extra</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class">): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boolean</span></span></span><span class="hljs-class"> { when (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">what</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMediaPlayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MEDIA_INFO_BUFFERING_START</span></span></span><span class="hljs-class"> -&gt; onBufferingStart() //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMediaPlayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MEDIA_INFO_BUFFERING_END</span></span></span><span class="hljs-class"> -&gt; onBufferingEnd() //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMediaPlayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MEDIA_INFO_VIDEO_RENDERING_START</span></span></span><span class="hljs-class"> -&gt; onBufferingEnd() } return true } }</span></span></code> </pre> <br>  That's all, our implementation is ready.  Let's see what happened: <br><br>  Comparison with average connection speed (Throttling 2 Mbps ADSL, Faststart on the right). <br><br><img src="https://habrastorage.org/webt/ps/7d/zw/ps7dzwsj1pdqlpqolcsm7n2mqb8.gif" alt="image"><br><br>  In this scenario, playback began in 5 videos during normal download versus 9 videos of faststart. <br><br>  Comparison with a weak connection (Throttling 256 Kbps ISDN / DSL, Faststart on the right). <br><br><img src="https://habrastorage.org/webt/kd/uu/hi/kduuhivl_4s0sw1ap7fu25mvoci.gif" alt="image"><br><br>  In this case, faststart is very different from normal playback: 6 seconds before the start of playback against 27! <br><br>  So, the task is completed!  The result speaks for itself.  Thanks to this approach, we provided not only an almost instant video display, but also the ability to interrupt the download and cache it in parts, which is important.  This gave us savings on returning to the incompletely downloaded video, since reloading is always faster than downloading the file again.  And we spent the freed resources on additional prefetch of neighboring elements, if they were not loaded yet, in order to provide the user with content delivery as quickly as possible and without annoying progress bars. <br><br>  This implementation method is not positioned as a silver bullet, especially here we looked at the faststart only on Ijkplayer, although on ExoPlayer it will most likely be similar.  I hope this article will encourage you to start improving your product (even if it is perfect), because we all want to use the fastest and most convenient applications.  Comments and suggestions will be waiting in the comments.  Perhaps someone has already encountered this and he has something to say from the perspective of experience.  Be sure to write, it is interesting to know how you coped with such tasks! </div><p>Source: <a href="https://habr.com/ru/post/358248/">https://habr.com/ru/post/358248/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358236/index.html">DevOps Moscow meetup: Monitoring</a></li>
<li><a href="../358238/index.html">Women's networks: who makes the choice for us?</a></li>
<li><a href="../358242/index.html">AI.Hack St. Petersburg</a></li>
<li><a href="../358244/index.html">Playing Cap: how to put the cashier on the cashier's table</a></li>
<li><a href="../358246/index.html">Material Design 2.0 and Android P</a></li>
<li><a href="../358250/index.html">UI components on pixel shaders: write your first shader</a></li>
<li><a href="../358252/index.html">What I learned from personal experience over the years of freelancing</a></li>
<li><a href="../358256/index.html">What's New in PostgreSQL 11: Improved Casting</a></li>
<li><a href="../358258/index.html">How tickets in support turn into tickets in Jira</a></li>
<li><a href="../358260/index.html">Four ways to work with text UI in Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>