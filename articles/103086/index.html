<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MakeMeLaughNow - analysis of the worm of a new generation on Facebook (translation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a recent topic, they expressed a wish that it would be good if someone translated. I looked at the text - it seems not so much. Therefore, to whom ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MakeMeLaughNow - analysis of the worm of a new generation on Facebook (translation)</h1><div class="post__text post__text-html js-mediator-article"> In a <a href="http://habrahabr.ru/blogs/infosecurity/103036/">recent topic, they expressed a wish</a> that it would be good if someone translated.  I looked at the text - it seems not so much.  Therefore, to whom it is interesting, we look ... <br><a name="habracut"></a><br><br>  New malicious worm application on Facebook is released. <br><br>  It avoids the ‚Äúsandbox‚Äù mechanism on Facebook and is activated BEFORE, as the authorization form is shown - just by visiting the application page, you start sending a message to your friends and update your status. <br>  According to the news on <a href="http://niebezpiecznik.pl/post/uwaga-na-facebookowa-aplikacje-makemelaughnow/">niebezpiecznik.pl</a> , it uses Facebook mobile site (touch.facebook.com) for distribution.  I quickly analyzed - let's see what exactly is in the application code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Disclaimer: Do not do this at home - I am a professional stuntman and besides, I love living dangerously.  Do not perform this analysis on your standard Facebook account, use a virtual machine in case an exploit is installed there, and so on.  As soon as I found out that the touch.facebook.com site is involved, I added: <br> <code>127.0.0.1 touch.facebook.com</code> <br>  in / etc / hosts (it redirects all requests to touch.facebook.com to my computer), but please be careful.  You have been warned. <br><br><h4>  Look around quickly </h4><br><br>  The home page of the application looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c5/602/10a/8c560210a1ffd2c6a510a7cfe881979b.png" alt="image"><br><br>  All you can see is a few advertisements.  But under this all there is a lot of things.  Let's take a look at the Firebug network panel. <br><img src="https://habrastorage.org/getpro/habr/post_images/c82/a0e/964/c82a0e9645711a447a683c3f4645ff6e.png" alt="image"><br><br>  The application, even before requesting any permissions from you, already sends requests to touch.facebook.com, possibly sending messages and performing other actions on your behalf.  These requests are marked in red on the screenshot (I blocked the mobile Facebook site).  After that, the advertisement is loaded from be2.pl.  So the application is definitely malicious. <br><br><h4>  Get <s>shorty</s> code </h4><br><br>  The code itself and the HTML are in <code><a href="http://apps.facebook.com/fbml/fbjs_ajax_proxy.php%3F__a%3D1"></a> apps.facebook.com/fbml/fbjs_ajax_proxy.php?__a=1</code> <br> <br>  The code is ‚Äújittered‚Äù in the <a href="http://www.json.org/">JSON</a> file and looks like this: <img src="https://habrastorage.org/getpro/habr/post_images/5b2/35c/2d1/5b235c2d1a3956cfaafa885903e98532.png" alt="image"><br><br>  After downloading the JSON file to the local disk and the subsequent extraction (I used PHP &amp; Spidermonkey to extract and Eclipse for formatting) we will get the final application code (see <a href="">step2_2.js)</a> . <br><br><h4>  Sandbox </h4><br><br>  All Facebook applications are ‚Äú <a href="http://en.wikipedia.org/wiki/Sandbox_%2528computer_security%2529">dirty</a> ‚Äù in order to prevent them from referring to the global window object (so that they cannot change the Facebook page, redirect, send hidden forms, and so on).  For this particular analysis, the following important points should be noted: <br><br><ul><li>  JS code and objects are in the prefix <code>aBIGNUMBER_variable_name</code> ( <code>aBIGNUMBER_variable_name</code> ) </li><li>  HTML objects have IDs using the <code>div id="appBIGNUMBER_name"</code> ( <code>div id="appBIGNUMBER_name"</code> ) ( <i>div should be enclosed in triangular brackets, but with them Habrough editor mercilessly korzhet, removed - approx. Transl.</i> ) </li><li>  <code>$FBJS</code> used to prevent the application from linking to the global window object.  For our purposes, you can assume that <br> <code>$FBJS.idx(a) === a</code> <br> <code>$FBJS.ref(this) === this</code> </li> <li>  For honors, I replaced BIGNUMBER with the letter 'x'. </li></ul><br><br>  All the code used in this post is hosted on <a href="http://github.com/koto/owasp-malicious-javascript/tree/master/makemelaugh">github.com</a> - look, this is really interesting. <br><br><h4>  Analysis </h4><br><br><h5>  The method of "dullness" </h5><br><br>  After initialization, the application starts with the following ad: <br><br> <code>ax_domethod = ax_findvalues.firefunc(ax_document.getElementById('help_container').getFirstChild().getTitle());</code> <br> <br>  Thus, the application receives the header of one of its DOM elements and passes it to some function.  What's in the headline?  Looking at the page code ( <a href="http://github.com/koto/owasp-malicious-javascript/blob/master/makemelaugh/app.html">app.html</a> ), we will see that it looks rather strange: <br> <code>&lt;div id="app100124540047022_m" <br> class="m" <br> fbcontext="6ff9e32a4c8c" <br> title="choy:ketmdslqxb.ujpzgvnra/fiw_?="/&gt; <br></code> <br><br>  It looks as if the header is something like a key that can be used to decrypt the hidden variables of the application.  <b>And we are right.</b>  In fact, <code>choy:ketmdslqxb.ujpzgvnra/fiw_?=</code> Is a dictionary - the <a href="">ax_create.help ()</a> function picks up characters from this dictionary to form URLs, field names, and so on.  Character <a href="">offsets are</a> defined in the slightly confusing <a href="">ax_meth</a> variable. <br><br><h5>  Scratching data </h5><br><br>  Ok, the application is confusing and uses a DOM object to decrypt its variables.  But what does it do? <br>  Let's look at <a href="">ax_findvalues</a> : <br> <code>var ax_findvalues = { <br> a : ((new ax_RegExp('st_.or._i.\\\x22 .al.e=\\\x22(.*?)\\\x22', ''))), <br> // &lt;form action="http://www.facebook.com/wallpost.php" post_form_id value <br> b : ((new ax_RegExp('b_d.s.\\\x22 v..ue=\\\x22(.*?)\\\x22', ''))), <br> // value = type="hidden" id="fb_dtsg" name="fb_dtsg" <br> c : ((new ax_RegExp('po.le\\.pp\\?i.=(\\d+)\\\x22', ''))), <br> // href="http://www.facebook.com/profile.php?id=xxx" your profile ID <br> d : ((new ax_RegExp('na.e=\\\x22i.s\\[]\\\x22 vle=\\\x22(.*?)\\\x22', 'gi'))), <br> // name=ids[] value= -- your friend ids <br> //...</code> <br> <br>  This variable contains quite interesting regular expressions - they are used to extract your friends' IDs, your own IDs, and some unique authenticators from the HTML code embedded in Facebook into the application.  But the application can not do anything with this data, as we are protected by "zapochechivaniem", right?  Well, not quite. <br><br><h5>  Hacked by touch </h5><br><br>  <i>Hacked by touch is a free translation of the ‚ÄúExploited by touching‚Äù word game, literally meaning that an exploit was used on the mobile site touch.facebook.com.</i>  <i>- (approx. Transl.)</i> <i><br></i> <br><br>  Looking deeper into the code, we can see that the jumbled data actually: <br> <code>m=http://touch.facebook.com/message_send.php <br> ftarg=fra <br> su=http://touch.facebook.com/submit_status.php (status update) <br> pid=post_form_id <br> lp=http://touch.facebook.com/reqs.php?id= <br> fhome=http://touch.facebook.com/home.php <br> fbd=fb_dtsg <br> hc=fb_dtsg <br></code> <br><br>  So, most likely, the application contacts touch.facebook.com for sending messages and updating statuses.  Again, <b>we are right</b> .  The process itself: <br><ul><li>  ax_findvalues.firefunc () retrieves your friends' IDs and other data in ax_sheep, ax_params variables ( <a href="">line 264</a> ) </li><li>  Create a new form and iframe </li><li>  ax_methodaction ( <a href="">line 183</a> ) fills out a form on touch.facebook.com with the following message to some (maximum 20) friends: <br>  i thought of you ... <br><br>  im using up my fb ad gift to send ua gift so HERE = http: //apps.facebook.com/makemelaughnow/ <br></li><li>  If you have more than 500 or less than 2, then the status update: ‚Äúonly go here if you are my TRUE friend http: //apps.facebook.com/makemelaughnow /‚Äù (I <i>‚Äôve got a link that God forbid no one clicked. Habrareditor if it turns off the creation of links, then it turns off automatic hyphenation - approx. transl.</i> ). </li><li>  You add yourself this application ( <a href="">line 297</a> ) </li><li>  Advertising is displayed and the application cleans up their objects. </li></ul><br><br><h4>  Conclusion </h4><br><br>  What we can see here is an application supposedly using a Facebook vulnerability, when the mobile site uses the same authentication as the normal site, but is not protected by the "wrinkling" mechanism.  Thus, the application, instead of requesting permission to update your status, quietly receives a session of data from the DOM and sends requests via touch.facebook.com, avoiding sandbox protection and spreading quickly - very similar to the <a href="http://www.owasp.org/index.php/Cross-Site_Request_Forgery_%2528CSRF%2529">CSRF</a> / session hijacking vulnerability.  It‚Äôs quite clear that a bug is being used on Facebook.  Lesson - <b>do not forget about your mobile sites</b> . <br><br>  The original is <a href="http://blog.kotowicz.net/2010/08/makemelaughnow-analysis-of-new.html">here</a> . <br><br>  <b>UPD.:</b> As suggested in the comments, the parser korzhit links a bit, so to go through the links, look where they lead and just correct them. <br><br>  PS If you notice any inaccuracies in the translation - let me know, I do not know Russian programming vocabulary perfectly. </div><p>Source: <a href="https://habr.com/ru/post/103086/">https://habr.com/ru/post/103086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../103069/index.html">Soon it will be possible to play Starcraft 2 using the iPhone and iPad</a></li>
<li><a href="../103073/index.html">Hand held breakpoints (for x86 architecture)</a></li>
<li><a href="../103075/index.html">Designer's thoughts on iPad design</a></li>
<li><a href="../103077/index.html">Did I miss something or Google for half past five?</a></li>
<li><a href="../103085/index.html">Google just acquired another startup</a></li>
<li><a href="../103088/index.html">Micropayments on the site, or selfish question</a></li>
<li><a href="../103089/index.html">The Oxford English Dictionary will no longer be published on paper.</a></li>
<li><a href="../103090/index.html">Some impressions about the e-book market</a></li>
<li><a href="../103091/index.html">Minor changes in Google Reader</a></li>
<li><a href="../103094/index.html">Organization of video broadcasting at Chaos Constructions 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>