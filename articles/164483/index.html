<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another look at the Entity Framework: performance and pitfalls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's no secret that the adaptation of the Entity Framework is very slow. A huge number of companies continue to use Linq2Sql and do not plan to change...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another look at the Entity Framework: performance and pitfalls</h1><div class="post__text post__text-html js-mediator-article">  It's no secret that the adaptation of the Entity Framework is very slow.  A huge number of companies continue to use Linq2Sql and do not plan to change it to something new in the foreseeable future, despite the fact that EF is the officially recommended database access technology by Microsoft, and Linq2Sql is almost not supported. <br><br>  Those who still doubt whether it is possible to use EF (and especially - code first) on real projects, I invite under kat. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Firstly, if you already have a couple of completed projects using EF, you can stop reading.  It is unlikely that you will learn something new. <br><br>  Despite the fact that there will be quite a few references to Linq2Sql below, the post is not a direct comparison of technologies.  I simply do not know Linq2Sql well enough to adequately compare it with anything. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is not an optimization manual, although some recommendations will be given.  Useful material can be found <a href="http://msdn.microsoft.com/en-us/library/cc853327.aspx">here</a> or <a href="http://msdn.microsoft.com/en-us/data/hh949853.aspx">here</a> .  Also, optimization methods through hand-written SQL-code will not be considered, although sooner or later it will have to be written in any more or less large project. <br><br>  The post assumes at least a general acquaintance with the Entity Framework Code First, SQL and in general the principles of ORM. <br><br>  The current version of EF at the time of writing is EF5.  For <a href="http://blogs.msdn.com/b/adonet/archive/2012/02/14/sneak-preview-entity-framework-5-0-performance-improvements.aspx">maximum performance</a> , .NET 4.5 was used.  Everything said below relates primarily to Code First with automatic database generation (which is actively <a href="http://www.hanselman.com/blog/SimpleCodeFirstWithEntityFramework4MagicUnicornFeatureCTP4.aspx">advertised</a> by Microsoft employees themselves).  The database server is LocalDb (usually it works slower than a full-fledged MS SQL Server). <br><br>  The test code is available on <a href="https://github.com/tp7ptr/EfCrutches">GitHub</a> . <br><br><h4>  Data model </h4><br>  For the demonstration a very simplified model of correspondence will be used.  Strictly speaking, knowledge of the model is not required to understand the following examples, but will not be harmful. <br><br>  Each user ( <code>Account</code> ) has several folders with letters ( <code>MessageFolder</code> ).  Each folder contains several message chains ( <code>MessageThread</code> ), while one chain can be in multiple folders at the same time ( <code>ThreadsInFolders</code> ).  Each thread consists of many letters.  In this case, the chains are rummaging between accounts, letters - no. <br><br>  Of course, a model in such a form can hardly be used in real code (although, undoubtedly, something in the spirit can occur), but it was the first small, but rather complex for our experiments, system that came to my mind.  Excuse me. <br><img src="https://habrastorage.org/storage2/a26/2a5/3bf/a262a53bfa7dfa7e8ba15034d799249f.png"><br><div class="spoiler">  <b class="spoiler_title">She's in the code.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Account</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Message</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsRead { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> MessageThread Thread { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Account Owner { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Account Sender { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Account Receiver { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageThread</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] [StringLength(<span class="hljs-number"><span class="hljs-number">150</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Subject { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;MessageFolder&gt; Folders { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageFolder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Account Owner { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;MessageThread&gt; Threads { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre></div></div><br><h3>  Reading data </h3><br>  The most important thing in any ORM system is reading data.  There is no problem with EF - queries to the database are fun and playful, lazy loading is supported.  All loaded objects fall into the internal context cache, then they can be requested directly from it (only through the <code>Find</code> method). <br><br>  A simple query will look something like this: <br><pre> <code class="cs hljs">context.Messages.AsNoTracking().OrderBy(f =&gt; f.Id).Take(count) .Include(f =&gt; f.Owner).Include(f =&gt; f.Sender).Include(f =&gt; f.Receiver) .ToList();</code> </pre><br><div class="spoiler">  <b class="spoiler_title">SQL</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">100</span></span>) [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id1], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id2], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Name1], [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id3], [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Name2] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Account</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[Owner_Id] = [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Account</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent3] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[Sender_Id] = [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Account</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent4] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[Receiver_Id] = [Extent4].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre></div></div><br>  <code>AsNoTracking</code> disables EF tracking of received objects (they will not be cached);  <code>Include</code> - loads the specified related entities (navigation property / navigation properties) through the generation, most often, <code>INNER JOIN</code> ;  the rest is LINQ familiar to everyone. <br><br>  The most interesting point here is <code>Include</code> .  Strictly speaking, the final realization of what you may need occurs at the presentation level, so the most logical arrangement of all <code>Include</code> is there, or at the neighboring level (for example, controllers in MVC).  In fact, this means that you have to drag <code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre> <code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <div class="spoiler"> <code><b class="spoiler_title"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> SQL <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></b></code> <div class="spoiler_text"> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre></div></div> <code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <ol><li> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </li> <li> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </li> </ol> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <div class="spoiler"> <code><code><b class="spoiler_title"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> SQL <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</b></code></code> <div class="spoiler_text"> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre></div></div> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <div class="spoiler"> <code><code><b class="spoiler_title"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> SQL <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</b></code></code> <div class="spoiler_text"> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre></div></div> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <table><tbody><tr><th> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </th> <th> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </th> <th> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </th> </tr><tr><td> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </td> <td> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </td> <td> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </td> </tr><tr><td> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </td> <td> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </td> <td> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </td> </tr></tbody></table> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><code><code class="cs"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> var count = folder.Threads.Count(); </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <div class="spoiler"> <code><code><b class="spoiler_title"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> SQL <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</b></code></code> <div class="spoiler_text"> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre></div></div> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><code><code class="cs"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id))); </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <div class="spoiler"> <code><code><b class="spoiler_title"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> SQL <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</b></code></code> <div class="spoiler_text"> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre></div></div> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><code><code class="cs"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> Response.Cache.SetLastModified(lastUpdated); </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </h3> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <pre> <code class="hljs pgsql"><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); //     -    var m = context.Messages.First(); Console.WriteLine(m.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>.Name);</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Account] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [c].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [c].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [c].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [c].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [c].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [c].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [c].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [c].[Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Receiver_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [c]</code> <br>   <code>context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>(f=&gt;f.<span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span>).First()</code>         . :    <code><span class="hljs-keyword"><span class="hljs-keyword">Include</span></span></code>    <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>-,   . <br> <br>  ,     ,     ,       ,       <code><code>context.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>().<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        <span class="hljs-number"><span class="hljs-number">1000</span></span>   EF   <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span></code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span></code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      <span class="hljs-number"><span class="hljs-number">100</span></span> . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(f=&gt;f.Thread.Id == threadId); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> messages) m.IsRead = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; context.SaveChanges();</code> <br> <b class="spoiler_title"><span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span></b> <code class="sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id], [Extent1].[IsRead] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [IsRead], [Extent1].[<span class="hljs-type"><span class="hljs-type">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Date</span></span>], [Extent1].[<span class="hljs-type"><span class="hljs-type">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-type"><span class="hljs-type">Text</span></span>], [Extent1].[Thread_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Thread_Id], [Extent1].[Owner_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Owner_Id], [Extent1].[Sender_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Sender_Id], [Extent1].[Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Reciever_Id] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Thread_Id] = @p__linq__0 <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> [dbo].[Message] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [IsRead] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ([Id] = @<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--(N )</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    update/delete   .    ,    </span></span><a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment">  </span></span><a href="https://github.com/loresoft/EntityFramework.Extended"><span class="hljs-comment"><span class="hljs-comment"> </span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  EntityFramework.Extended       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">        .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì SQL     .       ,       - ,     /. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). </span></span><br><span class="hljs-comment"><span class="hljs-comment">   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,  EntityFramework.Extended     ,      .    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   navigation property </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì           . ¬´ !¬ª       : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = folder.Threads.Count();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,   navigation properties,  ,     SQL. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   EF,   Linq2Sql,  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Count()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Any()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><b class="spoiler_title"><span class="hljs-comment"><span class="hljs-comment">SQL</span></span></b><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="sql"><span class="hljs-comment"><span class="hljs-comment">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      ,    , ,     ,  ¬´  ¬ª. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><br><span class="hljs-comment"><span class="hljs-comment">          ‚Äì        ,   . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">Response.Cache.SetLastModified(lastUpdated);</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">lastUpdated</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ‚Äì    ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,  ASP.NET MVC       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,     : </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ‚Äì    , </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment">    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Kind</span></span></code><span class="hljs-comment"><span class="hljs-comment">        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind.Undefined</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ( ,      ,      -  UTC   ).       ,   ,       (     </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTimeKind</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ),    </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToUniversalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">ToLocalTime()</span></span></code><span class="hljs-comment"><span class="hljs-comment">         . ,         GMT - N. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">      EF,    Linq2Sql ,  ,   .    </span></span><a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,   code first  .      </span></span><code><span class="hljs-comment"><span class="hljs-comment">ObjectMaterialized</span></span></code><span class="hljs-comment"><span class="hljs-comment">     (    )      .        </span></span><code><span class="hljs-comment"><span class="hljs-comment">DateTime</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">ComplexType</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,        reference type. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> RequiredAttribute </span></span><br><span class="hljs-comment"><span class="hljs-comment">           EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> ,      </span></span><code><span class="hljs-comment"><span class="hljs-comment">Owner</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Sender</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , </span></span><code><span class="hljs-comment"><span class="hljs-comment">Receiver</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Thread</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . -,      ,       </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,  -,      EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> , -,           ? </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,       -  .  </span></span><code><span class="hljs-comment"><span class="hljs-comment">DbEntityValidationException</span></span></code><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   ,        null,        .  , , </span></span><a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   :      (),    (),  </span></span><code><span class="hljs-comment"><span class="hljs-comment">try-catch</span></span></code><span class="hljs-comment"><span class="hljs-comment">  </span></span><code><span class="hljs-comment"><span class="hljs-comment">SaveChanges</span></span></code><span class="hljs-comment"><span class="hljs-comment">      </span></span><code><span class="hljs-comment"><span class="hljs-comment">catch</span></span></code><span class="hljs-comment"><span class="hljs-comment"> (),  ,   (),      </span></span><code><span class="hljs-comment"><span class="hljs-comment">RequiredAttribute</span></span></code><span class="hljs-comment"><span class="hljs-comment">   </span></span><code><span class="hljs-comment"><span class="hljs-comment">NOT NULL</span></span></code><span class="hljs-comment"><span class="hljs-comment">  Fluent API. , ,   ,         ,     ,           (  </span></span><code><span class="hljs-comment"><span class="hljs-comment">Required</span></span></code><span class="hljs-comment"><span class="hljs-comment">   null      </span></span><code><span class="hljs-comment"><span class="hljs-comment">UPDATE</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ).   ,         ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  (tl;dr) </span></span><br><span class="hljs-comment"><span class="hljs-comment">    EF  -       ?  .    ,  Microsoft      -            EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">   ,      EF      ,     ,     .    ,       </span></span><a href="http://habrahabr.ru/post/161703/"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,             ,          EF. </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     EF    Linq2Sql? ,  , .          code first (    ),          .    </span></span><a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"><span class="hljs-comment"><span class="hljs-comment"></span></span></a><span class="hljs-comment"><span class="hljs-comment"> ,     (   </span></span><a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap"><span class="hljs-comment"><span class="hljs-comment">EF6</span></span></a><span class="hljs-comment"><span class="hljs-comment"> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">     ,      ,    - Entity Framework.        // ,    .    .</span></span></code></code> </pre> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> <h4> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </h4> <code><code><a href="http://blog.byndyu.ru/2011/08/repository.html"></a> <a href="http://habrahabr.ru/post/161703/"></a> <code>IQueryable    ,  ,     ,   Linq2Entities,     .    (--)    . ,      extension methods  IQueryable   ,    . <br> <br>    Find</code>   . Find      ,             .  ,    <code>context.Messages.Find(1)</code>   ,         .      . ,          . <br> <code class="cs">context.Accounts.Load(); //     -    var m = context.Messages.First(); Console.WriteLine(m.Owner.Name);</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[Name] AS [Name] FROM [dbo].[Account] AS [Extent1] GO SELECT TOP (1) [c].[Id] AS [Id], [c].[IsRead] AS [IsRead], [c].[Date] AS [Date], [c].[Text] AS [Text], [c].[Thread_Id] AS [Thread_Id], [c].[Owner_Id] AS [Owner_Id], [c].[Sender_Id] AS [Sender_Id], [c].[Receiver_Id] AS [Receiver_Id] FROM [dbo].[Message] AS [c]</code> <br>   <code>context.Messages.Include(f=&gt;f.Owner).First()</code>         . :    <code>Include</code>    SQL-,   . <br> <br>  ,     ,     ,       ,       <code>context.Set().Local,      ,   .   SaveChanges</code> .         .     Linq2Sql. <br> <br>   :        1000   EF   2-3  ,  Linq2Sql. , API   ,  <a href="http://stackoverflow.com/questions/7863503/simple-eager-lazy-loading-examples-in-linq2sql">  Linq2Sql</a> . <br> <br>   <br>     .     <code>Add</code>          <code>Added</code> .    <code>SubmitChanges</code>  ,      <code>INSERT</code>     .   navigation property,       ,     <code>Added</code>     (      ). <br> <br>    : <br>       <code>ValidateOnSaveEnabled</code>  <code>AutoDetectChangesEnabled</code> .    .         .        ,         GC    .  ,      100 . <br>      <a href="http://stackoverflow.com/questions/5940225/fastest-way-of-inserting-in-entity-framework">StackOverflow</a> . <br>    EF  ,     ( ) Linq2Sql. , ,     Linq2Sql. <br> <br>     <br>       .NET ORM-.      Bulk-. ,   SQL     , ORM    . <br> ,        .  EF     : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); foreach (var m in messages) m.IsRead = true; context.SaveChanges();</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent1].[Id] AS [Id], [Extent1].[IsRead] AS [IsRead], [Extent1].[Date] AS [Date], [Extent1].[Text] AS [Text], [Extent1].[Thread_Id] AS [Thread_Id], [Extent1].[Owner_Id] AS [Owner_Id], [Extent1].[Sender_Id] AS [Sender_Id], [Extent1].[Reciever_Id] AS [Reciever_Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 update [dbo].[Message] set [IsRead] = @0 where ([Id] = @1) --(N )</code> <br> -,        ,         .   , ,   ,     ‚Äì  .  ,     ,    .           . <br> <br>    update/delete   .    ,    <a href="http://blogs.msdn.com/b/alexj/archive/2007/12/07/rolling-your-own-sql-update-on-top-of-the-entity-framework-part-1.aspx"></a>  <a href="https://github.com/loresoft/EntityFramework.Extended"> </a> . <br> <br>  EntityFramework.Extended       : <br> <code class="cs">var messages = context.Messages.Where(f=&gt;f.Thread.Id == threadId); messages.Update(f =&gt; new Message {IsRead = true});</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">UPDATE [dbo].[Message] SET [IsRead] = @p__update__0 FROM [dbo].[Message] AS j0 INNER JOIN ( SELECT [Extent1].[Id] AS [Id] FROM [dbo].[Message] AS [Extent1] WHERE [Extent1].[Thread_Id] = @p__linq__0 ) AS j1 ON (j0.[Id] = j1.[Id])</code> <br>        .  ,    <code>SaveChanges</code> ‚Äì SQL     .       ,       - ,     /. <br> <br>  ,      ,      dynamic         ( , ,  IntelliTrace),        .     (EntityFramework  ). <br>   10 ,   10000 ,  EntityFramework 8 935 EntityFramework.Extended 28 83 <br>   ,  EntityFramework.Extended     ,      .    . <br> <br>   navigation property <br>     ‚Äì           . ¬´ !¬ª       : <br> <code class="cs">var count = folder.Threads.Count();</code> <br>   ,   navigation properties,  ,     SQL. <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [Extent2].[Id] AS [Id], [Extent2].[Subject] AS [Subject] FROM [dbo].[ThreadsInFolders] AS [Extent1] INNER JOIN [dbo].[MessageThread] AS [Extent2] ON [Extent1].[MessageThread_Id] = [Extent2].[Id] WHERE [Extent1].[MessageFolder_Id] = @EntityKeyValue1</code> <br>   EF,   Linq2Sql,  <code>Count()</code> , <code>Any()</code> ,       ,   navigation property,        .   ,    ¬´¬ª  .  ,     ,  : <br> <code class="cs">var count = context.Threads.Count(f =&gt; f.Folders.Any(e =&gt; e.Id == folder.Id)));</code> <br> <b class="spoiler_title">SQL</b> <code class="sql">SELECT [GroupBy1].[A1] AS [C1] FROM ( SELECT COUNT(1) AS [A1] FROM [dbo].[MessageThread] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[ThreadsInFolders] AS [Extent2] WHERE ([Extent1].[Id] = [Extent2].[MessageThread_Id]) AND ([Extent2].[MessageFolder_Id] = @p__linq__0) ) ) AS [GroupBy1]</code> <br>   ,      ,    , ,     ,  ¬´  ¬ª. <br> <br>  <br>          ‚Äì        ,   . <br> <br>     : <br> <code class="cs">Response.Cache.SetLastModified(lastUpdated);</code> <br>  <code>lastUpdated</code> ‚Äì    ,    . <br>    ,  ASP.NET MVC       <code>ToUniversalTime()</code> ,     : <br> <code class="cs">if (utcDate &gt; DateTime.UtcNow) { throw new ArgumentOutOfRangeException("utcDate"); }</code> <br>     ‚Äì    , <code>DateTime</code>    <code>Kind</code>        <code>DateTimeKind.Undefined</code> ( ,      ,      -  UTC   ).       ,   ,       (     <code>DateTimeKind</code> ),    <code>ToUniversalTime()</code>  <code>ToLocalTime()</code>         . ,         GMT - N. <br> <br>      EF,    Linq2Sql ,  ,   .    <a href="http://stackoverflow.com/questions/4648540/entity-framework-datetime-and-utc"></a> ,   code first  .      <code>ObjectMaterialized</code>     (    )      .        <code>DateTime</code> ,       <code>ComplexType</code> ,        reference type. <br> <br> RequiredAttribute <br>           EF. <br> <br> ,      <code>Owner</code> , <code>Sender</code> , <code>Receiver</code>  <code>Thread</code>   <code>Required</code> . -,      ,       <code>NOT NULL</code> ,  -,      EF. <br> <br> , -,           ? <br> <code class="cs">var message = context.Messages.Find(1); message.IsRead = true; context.SaveChanges();</code> <br>   ,       -  .  <code>DbEntityValidationException</code> . <br> <br>  <code>RequiredAttribute</code>   ,        null,        .  , , <a href="http://stackoverflow.com/questions/6038541/ef-validation-failing-on-update-when-using-lazy-loaded-required-properties"></a> . <br> <br>   :      (),    (),  <code>try-catch</code>  <code>SaveChanges</code>      <code>catch</code> (),  ,   (),      <code>RequiredAttribute</code>   <code>NOT NULL</code>  Fluent API. , ,   ,         ,     ,           (  <code>Required</code>   null      <code>UPDATE</code> ).   ,         ,    . <br> <br>  (tl;dr) <br>    EF  -       ?  .    ,  Microsoft      -            EF. <br> <br>   ,      EF      ,     ,     .    ,       <a href="http://habrahabr.ru/post/161703/"></a> ,             ,          EF. <br> <br>     EF    Linq2Sql? ,  , .          code first (    ),          .    <a href="http://stackoverflow.com/questions/5889905/how-do-i-define-a-database-view-using-entity-framework-4-code-first"></a> ,     (   <a href="http://entityframework.codeplex.com/wikipage%3Ftitle%3DRoadmap">EF6</a> ).           -- (     ,         )  ..  ORM-    EF ‚Äì  . <br> <br>     ,      ,    - Entity Framework.        // ,    .    .</code></code> </div><p>Source: <a href="https://habr.com/ru/post/164483/">https://habr.com/ru/post/164483/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164471/index.html">Quick Start with Google Test</a></li>
<li><a href="../164475/index.html">5 APIs that will change the web in 2013</a></li>
<li><a href="../164477/index.html">Drawing Snowflakes with SVG</a></li>
<li><a href="../164479/index.html">Multiple Assertions without interruption in one unit test using NUnit as an example</a></li>
<li><a href="../164481/index.html">Happy new year, Habr!</a></li>
<li><a href="../164485/index.html">We follow the comments on the site in the widget "Comments" from VKontakte</a></li>
<li><a href="../164487/index.html">Java multithreading</a></li>
<li><a href="../164489/index.html">Ways of moving computer characters (Part 1)</a></li>
<li><a href="../164491/index.html">Homemade lights on quadrocopter</a></li>
<li><a href="../164493/index.html">Directives in AngularJS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>