<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cloning objects in Node.js: Faster, deeper, more tender!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, after reading the article by idoroshenko ‚ÄúWhy eval is not always bad,‚Äù I wondered whether it was possible to use the approach with ge...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cloning objects in Node.js: Faster, deeper, more tender!</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, after reading the article by <a href="https://habrahabr.ru/users/idoroshenko/" class="user_link">idoroshenko</a> <a href="http://habrahabr.ru/post/158403/">‚ÄúWhy eval is not always bad,‚Äù</a> I wondered whether it was possible to use the approach with generating the function body for cloning objects.  Even wrote a small library for this.  Benchmarks gave incredible results, but the applicability of this approach was limited only to multiple cloning of identical objects. <br><br>  Therefore, I had a question: is there really no <i>other</i> way in v8 to avoid the costs associated with the multiple re-creation of hidden classes?  After all, this is a major waste of resources when we clone objects.  As it turned out, this possibility really exists: in v8 objects themselves there is a method <a href="http://bespin.cz/~ondras/html/classv8_1_1Object.html">v8 :: Object :: Clone</a> .  This method clones objects in the broad sense of the word, that is, the objects themselves, as well as arrays, dates, regular expressions, functions, etc., while preserving all their properties, including non-standard (for example, named properties of arrays) and even hidden. <br><br>  There was only one small problem.  This method was used only in the depths of node.js, and was not open to the outside, for javascript. <br><a name="habracut"></a><br>  Without thinking, I went into the documentation of node.js for <a href="http://nodejs.org/api/addons.html">creating extensions in c ++</a> and wrote a <a href="">trial version of the</a> module, which simply reveals this function. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having received acceleration for different objects about 10-100 times, I realized that this technique has a lot of potential, and began to implement it in the <a href="https://github.com/AlexeyKupershtokh/node-v8-clone">node-v8-clone</a> ( <a href="https://npmjs.org/package/node-v8-clone">npm</a> ) module, trying not to lose this potential along the way, using a mixture TDD and benchmark driven development.  This allowed us to monitor the speed in developing and correcting problems, as well as to monitor regressions during optimizations.  At the same time, since the benchmarks and tests were ready, I decided to compare my module with others: <br><ul><li>  <a href="https://npmjs.org/package/lodash">lodash</a> (about which I <a href="http://habrahabr.ru/company/alawar/blog/157673/">wrote recently</a> ) </li><li>  <a href="https://npmjs.org/package/underscore">underscore</a> </li><li>  <a href="https://npmjs.org/package/owl-deepcopy">owl-deepcopy</a> </li><li>  <a href="https://npmjs.org/package/clone">clone</a> </li><li>  <a href="https://npmjs.org/package/cloneextend">cloneextend</a> </li></ul><br><br><h4>  Cloning quality </h4><br>  One of the goals was to maximize the quality of the cloning.  I had to straighten the imagination in order to come up with enough unpleasant situations for the cloning process.  These include, for example, functions, closures, arguments, regular expressions with the current state and properties added by the user.  My module handles these situations like this: <br><br><img src="https://habrastorage.org/storage2/47e/67e/4b5/47e67e4b5b20eb5c7efda276e675b11d.png"><br>  How are the competitors, you can evaluate <a href="https://github.com/AlexeyKupershtokh/node-v8-clone/wiki/Test-results">here</a> . <br><br>  I think it turned out very worthy. <br><br><h4>  Speed </h4><br>  It would be quite natural to assume that because of the support of high quality cloning, the speed should have dropped.  And the speed really fell, but not so much that the node-v8-clone lost the primacy in most situations. <br>  For example, here are the results of the surface cloning of an object of <code>{'_0': '_0', ..., '_99': '_99'}</code> elements <code>{'_0': '_0', ..., '_99': '_99'}</code> (in operations per second): <br><img src="https://habrastorage.org/storage2/bf4/911/aac/bf4911aac46acbcefba4b06e3ae43393.png"><br>  Deep cloning of 500 nested arrays located in 4 levels of nesting, which contain 900 lines (the <a href="">optimized version of</a> cloning from node-v8-clone is also compared here, which does not pass another test, but significantly speeds up the work by deeply cloning arrays): <br><img src="https://habrastorage.org/storage2/b99/e7a/72f/b99e7a72f2cebaee595b6b502394d007.png"><br>  But with small arrays things are somewhat worse.  This is due to the high cost of accessing the c ++ module, so simple algorithms, such as for, have an advantage. <br><img src="https://habrastorage.org/storage2/4a8/3c2/2ac/4a83c22ac9d2f4e1345f138910b5bd5f.png"><br><br>  <a href="https://github.com/AlexeyKupershtokh/node-v8-clone/wiki/Benchmark-graphs">All benchmark results.</a> <br><br><h4>  What's next </h4><br>  I am going to repair cloning of node.js-ovsky buffers.  Now they are cloned (a! == b), but they point to the same memory area and their contents are still bound. <br>  I would like to fix the cloning of arguments.  When a function has arguments, the arguments object is bound to the context of the function, and when cloned, they too are related to each other. <br>  I would like to come up with even more tricky incoming data, such as file descriptors, modules, timers ... I do not expect that I will be able to really clone them, but at least I would like to understand how this module will behave with them. <br><br>  I will be glad to any reviews, suggestions, bugs and patches.  Well, <a href="https://github.com/AlexeyKupershtokh/node-v8-clone">fork me on GitHub</a> :) </div><p>Source: <a href="https://habr.com/ru/post/147124/">https://habr.com/ru/post/147124/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147119/index.html">New interface Eviterra.com</a></li>
<li><a href="../147120/index.html">Android, NXT and Bluetooth</a></li>
<li><a href="../147121/index.html">Vacancy of the administrator / business analyst MS Dynamics Navision</a></li>
<li><a href="../147122/index.html">Evaluation of operators at Asterisk</a></li>
<li><a href="../147123/index.html">‚ÄúNefigigism‚Äù - the experience of creating a non-commercial project (three years of exposure)</a></li>
<li><a href="../147125/index.html">Detailed video review Android 4.1 Jelly Bean</a></li>
<li><a href="../147126/index.html">Saving contact information from sites</a></li>
<li><a href="../147128/index.html">Little C-function from the underworld</a></li>
<li><a href="../147129/index.html">I want my Luna Park with Fortran and C</a></li>
<li><a href="../147132/index.html">Ultrabook Software Contest: Let‚Äôs give free rein to our fantasy!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>