<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker implementation for a small project in Production, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Part 1 

 In the first part, we prepared our operating system for using Docker containers. 

 After we have completed the reboot, we will see the au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker implementation for a small project in Production, part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/646/fef/ff2/646fefff2c8bc3779eb1b1c030e38ec8.jpg" alt="image"><br><br>  ‚Üí <a href="https://habrahabr.ru/post/320316/">Part 1</a> <br><br>  In the first part, we prepared our operating system for using Docker containers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After we have completed the reboot, we will see the authorization invitations, but it will not be possible to do this from the server console, for the reason that authorization in the system is possible only by key.  By default, the core user does not have a password.  Of course, it can be installed using the command: <br><br><pre><code class="bash hljs">sudo passwd core</code> </pre> <a name="habracut"></a><br>  After that, enter a new password 2 times, but this will be possible after we log in to the console from another, for example, a home machine, using previously created keys, which of course we have registered in the config file. <br><br>  It can be used as a terminal client if you are a Linux, MacOS user, or Putty if you are working with Windows.  How to configure a connection to our server, I will not describe, this is a trivial task.  It is only necessary to take into account that during the installation we changed the port from standard to 2222. Therefore, do not forget to specify this in the connection parameters. <br><br>  For some hosting providers, in the case of a virtual private cloud service, you must configure the border router by creating a dst-nat rule with the following content: <br><br><pre> <code class="hljs vbscript">Source IP: Your <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> IP Address Source Port: <span class="hljs-number"><span class="hljs-number">2222</span></span> Destination IP: Your <span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> IP Address Destination Port: <span class="hljs-number"><span class="hljs-number">2222</span></span></code> </pre><br>  We need to explain to our router which port to which server to connect to.  In the case of a conventional virtual machine with a public address on eth0, of course, there will be no such problems.  For greater privacy, you can configure our IPTABLES, and this can be done at the configuration stage, or use a custom file located at: <br><br><pre> <code class="bash hljs">/usr/share/oem/cloud-config.yml</code> </pre> <br>  It is quite simple to do this, I will show, using the example of raising as a container service with sshguard (a daemon that reads the authorization log and adds unwanted users to the IPTABLES block list). <br><br>  To begin with, we will assemble our container, we can of course use the already prepared one taken from the hub, but we will assemble our own, based on minimalistic Alpine Linux.  For the organization of space and storage of various kinds of files, I decided for myself to make the following directory structure on the server: <br><br><pre> <code class="hljs 1c">/cloud/containers -  ,     ,   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  /cloud/etc/ -    , <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,       <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  /cloud/data/ -     ,  ,   ... /cloud/run/ -     unix    <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  ,  <span class="hljs-keyword"><span class="hljs-keyword"></span></span> php-fpm <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  uwsgi </code> </pre> <br>  So let's start, suppose we have prepared the structure of our directories, of course, to whom it is convenient, and then we will execute the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">vi</span></span> Dockerfile</code> </pre> <br>  Why am I using vi editor?  I remind the system is minimalistic, so there are no other editors in CoreOS, for example, vim nano mcedit and others (I‚Äôll tell you how to solve this problem a bit later, we won‚Äôt get ahead of ourselves). <br><br>  After launching the editor, translate it into insert mode by pressing the ‚Äúi‚Äù key on the keyboard, and place the following text: <br><br><pre> <code class="hljs tex">FROM alpine:3.2 RUN apk add --update <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>iptables <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>ip6tables <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>sshguard <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; rm -fr /var/cache/apk/* ENTRYPOINT ["/usr/sbin/sshguard"]</code> </pre> <br>  The first FROM line indicates which base image to use to build our container, as I said, we will use Alpine Linux version 3.2. <br><br>  With the line beginning with RUN, we say, execute the following commands, in our example we will install additional packages and sshguard itself.  Then we specify the entry point to our container / usr / sbin / sshguard. <br><br>  That's all, now we need to save the container configuration file.  To do this, leave the insert mode on the keyboard by pressing the ‚ÄúESC‚Äù key, then transfer vi to the command mode by pressing ‚ÄúShift +:‚Äù and write ‚Äúwq‚Äù and press ‚ÄúEnter‚Äù.  We‚Äôre all done with the configuration file.  Now we proceed to the assembly of our container.  To do this, perform the following in the console: <br><br><pre> <code class="bash hljs">docker build -t <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sshguard .</code> </pre> <br>  Let's take a closer look at this command, we specify the Docker through the build command to build the container into the local repository named sshguard, you can use your own repository on hub.docker.com, for example, but do not forget to docker push repo / container.  The -t key waits for the following parameter to tag (name) our image, in this case, we will build the local image local / sshguard.  Instead of a point, you need to specify the path to our Dockerfile, but if we are in the same directory as the file itself, then the point will be enough. <br><br>  After that the assembly of the container will begin, the hash of our container will be the result of a successful assembly.  You can view all created images on our server using the command: <br><br><pre> <code class="bash hljs">docker images</code> </pre> <br>  Delete the image with one or more names or id separated by a space: <br><br><pre> <code class="bash hljs">docker images rmi image_id  image_name</code> </pre> <br>  Great, we have compiled an image with our service, now it would not be bad to start using it.  We will use our image as a service, running it through systemd. <br><br>  To do this, proceed to editing the file /usr/share/oem/cloud-config.yml, and add the following content.  We use our favorite vi, by analogy above. <br><br><pre> <code class="hljs vhdl">#cloud-config coreos: <span class="hljs-keyword"><span class="hljs-keyword">units</span></span>: - name: sshguard.service command: start content: | [Unit] Description=sshguard <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=docker.service Requires=docker.service [Service] TimeoutStartSec=<span class="hljs-number"><span class="hljs-number">0</span></span> ExecStartPre=-/usr/bin/docker kill sshguard ExecStartPre=-/usr/bin/docker rm sshguard ExecStartPre=/usr/bin/docker pull local/sshguard # setup sshguard tables ExecStartPre=-/usr/sbin/iptables -N sshguard ExecStartPre=-/usr/sbin/ip6tables -N sshguard # <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> abuser traffic ExecStartPre=-/usr/sbin/iptables -D INPUT -j sshguard ExecStartPre=-/usr/sbin/ip6tables -D INPUT -j sshguard ExecStartPre=-/usr/sbin/iptables -A INPUT -j sshguard ExecStartPre=-/usr/sbin/ip6tables -A INPUT -j sshguard ExecStart=/bin/sh -c <span class="hljs-symbol"><span class="hljs-symbol">'journalctl</span></span> <span class="hljs-comment"><span class="hljs-comment">--no-pager -q -f -t sshd | sed -u "s/\\[[0-9]*\\]//" | docker run -i --name sshguard --rm --net=host --privileged local/sshguard' ExecStop=-/usr/bin/docker stop sshguard ExecStop=-/usr/bin/docker rm sshguard</span></span></code> </pre> <br>  After saving the file, it would be nice to initialize the system in order to apply our custom settings.  To do this, run the command in the console: <br><br><pre> <code class="bash hljs">sudo coreos-cloudinit --from-file /usr/share/oem/cloud-config.yml</code> </pre> <br>  Using the configuration file above, you can create the necessary rules in the necessary IPTABLES chains by analogy, substituting your parameters.  It is not difficult and I will not describe it. <br><br>  The result of our actions was a ready server that can block offenders of the console order for a certain time interval.  You can read about the additional parameters of sshguard in the official documentation and customize it to your taste.  We used the default settings.  In more detail, I only consider the startup command itself: <br><br><pre> <code class="bash hljs">ExecStart=/bin/sh -c <span class="hljs-string"><span class="hljs-string">'journalctl --no-pager -q -f -t sshd | sed -u "s/\\[[0-9]*\\]//" | docker run -i --name sshguard --rm --net=host --privileged local/sshguard'</span></span></code> </pre> <br>  since all the logs from us through journalctl get to the logging server, we need to extract them, at the same time filter and transfer to the input of sshguard starting in the container.  The parameter --net = host says that we need to perform all actions on our machine where the Docker daemon is running, while we start the container in privileged mode by specifying the key --privileged. <br><br>  Now it would not be bad to start working with our containers, but first I would like to talk about one <a href="http://getnucleus.io/">service</a> . <br><br>  This is a great cloud dashboard for managing your containers.  But first you need to install it, in the case of CoreOS it is extremely easy to do this, for this we do: <br><br><pre> <code class="bash hljs">sudo curl -s http://getnucleus.io/install/coreos_installer.sh | bash -s --</code> </pre> <br>  More information about the installation can be found <a href="http://docs.getnucleus.io/api/">here</a> . <br><br>  Then we perform authorization and can manage our containers, without connecting via ssh to the server console.  To do this, in the upper right corner click on the rocket icon, and execute our team by analogy as we would have done in the console.  For example, run the container with Nginx, for this we enter: <br><br><pre> <code class="bash hljs">docker run -p 80:80 -p 443:443 --name=nginx nginx</code> </pre> <br>  After executing the command, we will have a container in the list called nginx and published ports 80 and 443. You can read files and scripts in other articles or in official documentation about how to forward the server configuration.  By clicking on the sandwich, in the Control Deck column, you can not only manage our container, but also look at the resources it consumes, memory, CPU, networks, and so on. <br><br>  In the next article I will talk about how to organize the infrastructure for a blog on WP using Varnish, Memcached, PHP7.1-FPM, Nginx, Mariadb, as well as which extensions for php 7.1 to include and how to set it all up.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/320346/">https://habr.com/ru/post/320346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320330/index.html">How to "make friends" Mitel SIP-DECT and Asterisk</a></li>
<li><a href="../320336/index.html">Labor market overview in the field of big data and data science</a></li>
<li><a href="../320338/index.html">Observed models in Realm Xamarin</a></li>
<li><a href="../320342/index.html">Tale of the impossible bug: big.LITTLE and caching</a></li>
<li><a href="../320344/index.html">Olympiad of MIPT on electronics for schoolchildren</a></li>
<li><a href="../320348/index.html">How to establish a trust relationship between the computer and the main domain</a></li>
<li><a href="../320350/index.html">Five years, five educational projects: briefly about the main and the history of teachers</a></li>
<li><a href="../320354/index.html">How were born the IT-dynasties in Belarus</a></li>
<li><a href="../320356/index.html">How we lost 150,000 and closed the project</a></li>
<li><a href="../320360/index.html">What the flask?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>