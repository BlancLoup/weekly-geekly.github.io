<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load optimization in the ‚ÄúRemains in warehouses‚Äù task using partitioning in SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article provides a Transact SQL optimization solution for calculating stock balances. Applied: partitioning of tables and materialized views. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load optimization in the ‚ÄúRemains in warehouses‚Äù task using partitioning in SQL Server</h1><div class="post__text post__text-html js-mediator-article">  This article provides a Transact SQL optimization solution for calculating stock balances.  Applied: partitioning of tables and materialized views. <br><br><h2>  Formulation of the problem </h2><br>  The task needs to be solved on SQL Server 2014 Enterprise Edition (x64).  The company has many warehouses.  In each warehouse every day for several thousand shipments and acceptance of products.  There is a table of movements of goods in the stock receipt / consumption.  It is necessary to implement: <br><br>  Calculation of the balance on the selected date and time (up to an hour) for all / any warehouses for each product.  For analytics, it is necessary to create an object (function, table, view) with the help of which, for the selected date range, output the source table data for all warehouses and products and the additional calculation column - the balance in the position warehouse. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      These calculations are supposed to be performed on a schedule with different date ranges and should work at an acceptable time.  Those.  if it is necessary to display a table with residuals for the last hour or day, the execution time should be as fast as possible, as well as if it is necessary to output the same data for the last 3 years, for subsequent loading into the analytical database. <br><a name="habracut"></a><br>  Technical details.  The table itself: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.Turnover ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, dt datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, ProductID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, StorehouseID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, Operation <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (Operation <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)), <span class="hljs-comment"><span class="hljs-comment">-- +1   , -1    Quantity numeric(20,2) not null, Cost money not null )</span></span></code> </pre> <br><blockquote>  Dt - Date the time of receipt / debiting to / from the warehouse. <br>  ProductID - Product <br>  StorehouseID - warehouse <br>  Operation - 2 values ‚Äã‚Äãof arrival or consumption <br>  Quantity - the amount of product in stock.  It may be material if the product is not in pieces, but, for example, in kilograms. <br>  Cost - the cost of the product batch. </blockquote><br><h2>  Research task </h2><br>  Create a filled table.  In order to test and watch the results with me, I suggest creating and filling in the dbo.Turnover table with a script: <br><br><pre> <code class="sql hljs">if object_id('dbo.Turnover','U') is not null <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.Turnover; go <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> times <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> times <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>*<span class="hljs-number"><span class="hljs-number">365</span></span>*<span class="hljs-number"><span class="hljs-number">24</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 10  * 365  * 24  * 60  =    10  ) , storehouse as ( select 1 id union all select id+1 from storehouse where id &lt; 100 --   ) select identity(int,1,1) id, dateadd(minute, t.id, convert(datetime,'20060101',120)) dt, 1+abs(convert(int,convert(binary(4),newid()))%1000) ProductID, -- 1000 -    s.id StorehouseID, case when abs(convert(int,convert(binary(4),newid()))%3) in (0,1) then 1 else -1 end Operation, --     ,     3  2  1  1+abs(convert(int,convert(binary(4),newid()))%100) Quantity into dbo.Turnover from times t cross join storehouse s option(maxrecursion 0); go --- 15 min alter table dbo.Turnover alter column id int not null go alter table dbo.Turnover add constraint pk_turnover primary key (id) with(data_compression=page) go -- 6 min</span></span></code> </pre> <br>  I had this script on a PC with an SSD disk running for about 22 minutes, and the size of the table took about 8GB on the hard disk.  You can reduce the number of years, and the number of warehouses, in order to reduce the time for creating and filling the table.  But I recommend to leave some good volume for evaluating query plans, at least 1-2 gigabytes. <br><br>  Group data up to an hour <br><br>  Further, we need to group the amounts by products in stock for the studied period of time, in our formulation of the task it is one hour (you can up to a minute, up to 15 minutes, a day. But it is obvious that milliseconds hardly anyone will need reporting).  For comparisons in the session (window) where we execute our requests, we execute the command - set statistics time on ;.  Next, we execute the queries themselves and look at the query plans: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(datetime,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>),dt,<span class="hljs-number"><span class="hljs-number">120</span></span>)+<span class="hljs-string"><span class="hljs-string">':00'</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt, <span class="hljs-comment"><span class="hljs-comment">--    ProductID, StorehouseID, sum(Operation*Quantity) as Quantity from dbo.Turnover group by convert(datetime,convert(varchar(13),dt,120)+':00',120), ProductID, StorehouseID</span></span></code> </pre> <br><div style="text-align:center;"><img src="http://kurenkov.pro/images/projects/stock02.png" alt="image"></div><br><blockquote>  Request price - 12406 <br>  (lines processed: 1000) <br>  SQL Server running time: <br>  CPU time = 2096594 ms, elapsed time = 321797 ms. </blockquote><br>  If we make the resulting query with a balance, which is considered to be a cumulative total of our quantity, then the query and the query plan will be as follows: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(datetime,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>),dt,<span class="hljs-number"><span class="hljs-number">120</span></span>)+<span class="hljs-string"><span class="hljs-string">':00'</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt, <span class="hljs-comment"><span class="hljs-comment">--    ProductID, StorehouseID, sum(Operation*Quantity) as Quantity, sum(sum(Operation*Quantity)) over ( partition by StorehouseID, ProductID order by convert(datetime,convert(varchar(13),dt,120)+':00',120) ) as Balance from dbo.Turnover group by convert(datetime,convert(varchar(13),dt,120)+':00',120), ProductID, StorehouseID</span></span></code> </pre> <br><div style="text-align:center;"><img src="http://kurenkov.pro/images/projects/stock03.png" alt="image"></div><br><blockquote>  Request price - 19329 <br>  (lines processed: 1000) <br>  SQL Server running time: <br>  CPU time = 2413155 ms, elapsed time = 344631 ms. </blockquote><br>  Group optimization <br><br>  It's pretty simple here.  The query itself without a cumulative total can be optimized with a materialized view (index view).  To build a materialized view, what is summed should not be NULL, we sum the sum (Operation * Quantity), or make each field NOT NULL or add isnull / coalesce to the expression.  I propose to create a materialized view. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> schemabinding <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(datetime,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>),dt,<span class="hljs-number"><span class="hljs-number">120</span></span>)+<span class="hljs-string"><span class="hljs-string">':00'</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt, <span class="hljs-comment"><span class="hljs-comment">--    ProductID, StorehouseID, sum(isnull(Operation*Quantity,0)) as Quantity, count_big(*) qty from dbo.Turnover group by convert(datetime,convert(varchar(13),dt,120)+':00',120), ProductID, StorehouseID go</span></span></code> </pre> <br>  And build a clustered index on it.  In the index, we specify the order of the fields in the same way as in the grouping (for grouping, so much order is not important, it is important that all fields of the grouping be in the index) and progressively (here the order is important - first what's in partition by, then what's in order by): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uix_TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> dbo.TurnoverHour (StorehouseID, ProductID, dt)</code> </pre>  with (data_compression = page) - 19 min <br><br>  Now, after building the cluster index, we can re-execute queries by changing the aggregation of the amount as in the view: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(datetime,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>),dt,<span class="hljs-number"><span class="hljs-number">120</span></span>)+<span class="hljs-string"><span class="hljs-string">':00'</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt, <span class="hljs-comment"><span class="hljs-comment">--    ProductID, StorehouseID, sum(isnull(Operation*Quantity,0)) as Quantity from dbo.Turnover group by convert(datetime,convert(varchar(13),dt,120)+':00',120), ProductID, StorehouseID select top(1000) convert(datetime,convert(varchar(13),dt,120)+':00',120) as dt, --    ProductID, StorehouseID, sum(isnull(Operation*Quantity,0)) as Quantity, sum(sum(isnull(Operation*Quantity,0))) over ( partition by StorehouseID, ProductID order by convert(datetime,convert(varchar(13),dt,120)+':00',120) ) as Balance from dbo.Turnover group by convert(datetime,convert(varchar(13),dt,120)+':00',120), ProductID, StorehouseID</span></span></code> </pre> <br><br>  Query plans have become: <br><br><img src="http://kurenkov.pro/images/projects/stock04.png" alt="image">  Cost 0.008 <br><br><img src="http://kurenkov.pro/images/projects/stock05.png" alt="image">  Cost 0.01 <br><br><blockquote>  SQL Server running time: <br>  CPU time = 31 ms, elapsed time = 116 ms. <br>  (lines processed: 1000) <br>  SQL Server running time: <br>  CPU time = 0 ms, elapsed time = 151 ms. </blockquote><br>  So, we see that with an indexed view, the query scans not the table grouping the data, but the cluster index, in which everything is already grouped.  And accordingly, the execution time was reduced from 321797 milliseconds to 116 ms, i.e.  2774 times. <br><br>  This would allow us to finish our optimization, if not for the fact that we often need not the entire table (view), but its part for the selected range. <br><br>  Intermediate Balances <br><br>  As a result, we need fast execution of the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dateformat ymd; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> datetime = <span class="hljs-string"><span class="hljs-string">'2015-01-02'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">finish</span></span> datetime = <span class="hljs-string"><span class="hljs-string">'2015-01-03'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt, StorehouseID, ProductId, Quantity, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(Quantity) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> StorehouseID, ProductID <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dt ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(noexpand) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dt &lt;= @<span class="hljs-keyword"><span class="hljs-keyword">finish</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tmp <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dt &gt;= @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br><div style="text-align:center;"><img src="http://kurenkov.pro/images/projects/stock01.png" alt="image"></div><br>  Cost of the plan = 3103. <b>But imagine what would have happened if it were not for the materialized view, but for the table itself.</b> <br><br>  Data output materialized view and balance for each product in stock at a date with a time rounded up to an hour.  In order to calculate the balance, it is necessary from the very beginning (from zero balance) to sum all the quantities up to the specified last date (@finish), and then cut the data later than the <a href="https://habrahabr.ru/users/start/" class="user_link">start</a> parameter in the summarized result set. <br><br>  Here, obviously, intermediate calculated balances will help.  For example, on the 1st day of each month or on every Sunday.  Having such balance sheets, the task comes down to the fact that it will be necessary to sum up previously calculated balance sheets and calculate the balance not from the beginning, but from the last calculated date.  For experiments and comparisons, we will build an additional non-cluster index by date: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ix_dt <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> dbo.TurnoverHour (dt) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> (Quantity) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(data_compression=page); <span class="hljs-comment"><span class="hljs-comment">--7 min     : set dateformat ymd; declare @start datetime = '2015-01-02', @finish datetime = '2015-01-03' declare @start_month datetime = convert(datetime,convert(varchar(9),@start,120)+'1',120) select * from ( select dt, StorehouseID, ProductId, Quantity, sum(Quantity) over ( partition by StorehouseID, ProductID order by dt ) as Balance from dbo.TurnoverHour with(noexpand) where dt between @start_month and @finish ) as tmp where dt &gt;= @start order by StorehouseID, ProductID, dt</span></span></code> </pre> <br>  In general, this query, having even an index by date completely covering all the fields affected by the query, will select our clustered index and scan.  And not search by date, followed by sorting.  I propose to perform the following 2 requests and compare what we have obtained, then we will analyze what is still better: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dateformat ymd; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> datetime = <span class="hljs-string"><span class="hljs-string">'2015-01-02'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">finish</span></span> datetime = <span class="hljs-string"><span class="hljs-string">'2015-01-03'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @start_month datetime = <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(datetime,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>),@<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>)+<span class="hljs-string"><span class="hljs-string">'1'</span></span>,<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt, StorehouseID, ProductId, Quantity, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(Quantity) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> StorehouseID, ProductID <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dt ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(noexpand) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> @start_month <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">finish</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tmp <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dt &gt;= @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> StorehouseID, ProductID, dt <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt, StorehouseID, ProductId, Quantity, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(Quantity) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> StorehouseID, ProductID <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dt ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(noexpand,<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>=ix_dt) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> @start_month <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">finish</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tmp <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dt &gt;= @<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> StorehouseID, ProductID, dt</code> </pre> <br><blockquote>  SQL Server running time: <br>  CPU time = 33860 ms, elapsed time = 24247 ms. <br><br>  (lines processed: 145608) <br><br>  (lines processed: 1) <br><br>  SQL Server running time: <br>  CPU time = 6374 ms, elapsed time = 1718 ms. <br>  SQL Server parse and compile time: <br>  CPU time = 0 ms, elapsed time = 0 ms. </blockquote><br>  From the time it is clear that the index by date runs much faster.  But query plans in comparison are as follows: <br><br><img src="http://kurenkov.pro/images/projects/stock07.png" alt="image"><br><br>  The cost of the 1st request with the automatically selected cluster index = 2752, but the cost with the index by the request date = 3119. <br><br>  However, here we need two tasks from the index: sorting and sampling the range.  One index from available to us not to solve this task.  In this example, the data range is just 1 day, but if there is a longer period, but not all, for example, 2 months, then an unequivocal index search will not be effective due to the cost of sorting. <br><br>  Here, from the visible optimal solutions, I see: <br><br><ol><li>  Create a Year-Month calculated field and an index to create (Year-Month, the rest of the clustered index fields).  In the condition where dt between @start_month and <a href="https://habrahabr.ru/users/finish/" class="user_link">finish is</a> replaced by Year-Month = @ month, and after that, filter the desired dates. </li><li>  Filtered indexes - the index itself as a cluster, but the filter by date, for the desired month.  And there are as many of such indices as we have for months.  The idea is close to a solution, but here if the range of conditions is from 2 filtered indexes, a connection is required and in the future, sorting is inevitable anyway. </li><li>  We partition the cluster index so that in each section there is data for only one month. </li></ol><br>  In the project as a result I made the 3rd option.  Partitioning a clustered index of a materialized view.  And if the sample goes for a period of one month, then in fact the optimizer affects only one section, making it scan without sorting.  And the cut-off of unused data occurs at the cut-off level of unused sections.  Here, if the search from the 10th to the 20th day we do not have an exact search for these dates, but a search for data from the 1st to the last day of the month, further scanning of this range in a sorted index filtered during the scanning by the set dates. <br><br>  We partition the cluster index of the view.  First of all, let's remove all indexes from the view: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ix_dt <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> dbo.TurnoverHour; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uix_TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> dbo.TurnoverHour;</code> </pre> <br>  And create a function and partitioning scheme: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dateformat ymd; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pf_TurnoverHour(datetime) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-keyword"><span class="hljs-keyword">right</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ( <span class="hljs-string"><span class="hljs-string">'2006-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2006-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2007-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2008-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2009-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2011-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2012-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2013-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2014-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2017-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-12-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-01-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-02-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-03-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-04-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-05-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-06-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-07-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-08-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-09-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-10-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-11-01'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-12-01'</span></span>); go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> scheme ps_TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> pf_TurnoverHour all <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ([primary]); go            : <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uix_TurnoverHour <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> dbo.TurnoverHour (StorehouseID, ProductID, dt) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> (data_compression=page) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ps_TurnoverHour(dt); <span class="hljs-comment"><span class="hljs-comment">--- 19 min   ,    .  : set dateformat ymd; declare @start datetime = '2015-01-02', @finish datetime = '2015-01-03' declare @start_month datetime = convert(datetime,convert(varchar(9),@start,120)+'1',120) select * from ( select dt, StorehouseID, ProductId, Quantity, sum(Quantity) over ( partition by StorehouseID, ProductID order by dt ) as Balance from dbo.TurnoverHour with(noexpand) where dt between @start_month and @finish ) as tmp where dt &gt;= @start order by StorehouseID, ProductID, dt option(recompile);</span></span></code> </pre> <br><div style="text-align:center;"><img src="http://kurenkov.pro/images/projects/stock06.png" alt="image"></div><br><blockquote>  SQL Server running time: <br>  CPU time = 7860 ms, elapsed time = 1725 ms. <br>  SQL Server parse and compile time: <br>  CPU time = 0 ms, elapsed time = 0 ms. <br>  Request Plan Cost = 9.4 </blockquote><br>  In fact, data in one section is selected and scanned by a cluster index rather quickly.  It should be added here that when the request is parameterized, the unpleasant effect of parameter sniffing occurs, the option (recompile) is treated. </div><p>Source: <a href="https://habr.com/ru/post/330070/">https://habr.com/ru/post/330070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330060/index.html">Kotlin, bytecode compilation and performance (part 1)</a></li>
<li><a href="../330062/index.html">Own scripting engine for games using C ++ and Lua (part 1)</a></li>
<li><a href="../330064/index.html">Kotlin, bytecode compilation and performance (part 2)</a></li>
<li><a href="../330066/index.html">Issue # 3: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../330068/index.html">Must-Have: 20 game assets for the designer and artist</a></li>
<li><a href="../330072/index.html">Zen will not call</a></li>
<li><a href="../330074/index.html">Check Point Security CheckUP - R80.10. Part 3</a></li>
<li><a href="../330076/index.html">Remote work in numbers and diagrams</a></li>
<li><a href="../330078/index.html">How we improved TFS</a></li>
<li><a href="../330080/index.html">Win the Android Camera2 API with RxJava2 (Part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>