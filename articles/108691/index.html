<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increase netfilter performance using ipset</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="iptables - interface to the Linux firewall ( netfilter ). With a large number of iptables rules, the load can be quite high and create problems. In th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increase netfilter performance using ipset</h1><div class="post__text post__text-html js-mediator-article">  <b>iptables</b> - interface to the Linux firewall ( <i>netfilter</i> ).  With a large number of iptables rules, the load can be quite high and create problems.  In this post I will try to describe what affects the performance of iptables and how to improve it. <br><a name="habracut"></a><br><h4>  Main reason for the load </h4><br>  For a start: because of what there is a load when a large number of rules?  Due to the fact that each network packet processed by the kernel has to be compared across the entire list of rules for each chain.  Let me give you a scheme that reflects netfilter chains and the order in which packets pass through them: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b41/417/d3b/b41417d3b3b14e302e5b9d7abdf56bf9.png"><br><br>  The diagram shows through which chains a particular package passes and you can estimate the load.  Let's take one simple rule: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>-A INPUT -s 10.1.1.1/32 -p tcp --dport 25 -j DROP</code> <br> <br>  This rule tells the firewall to drop all packets from the IP address 10.1.1.1 to port 25 of the local machine.  I do not specify the table (-t), so the default (-t filter) will be used, which is what we need.  It is clear that the DROP action is not always performed.  However, a comparison of the source IP address will pass <b><i>any</i></b> packet incoming to the local machine.  And if there are a thousand such rules? <br><br><h4>  What to do? </h4><br>  Now we will think how to speed up the firewall.  The first answer is obvious - to reduce the number of rules.  But it is unlikely to seriously optimize the records, especially if they were originally compiled correctly.  Somewhere instead of the rules for several IP addresses, you can write one rule per subnet.  Somewhere instead of the rules for several ports you can use <code>-m multiport</code> and <code>--dports</code> / <code>--sports a,b,c</code> (a, b, c - port numbers).  And so on. <br><br><h4>  Branching rules, additional chains </h4><br>  And there is another option - the use of branching rules.  Its essence is that the rules of the same type are grouped into a separate chain, and in the main chain there is one rule that redirects the packet to a separate chain depending on some common attribute of the packets.  I will give an example.  There are three rules: <br><br> <code>-A INPUT -s 10.1.1.1/32 -p icmp -j ACCEPT <br> -A INPUT -s 10.1.1.2/32 -p icmp -j ACCEPT <br> -A INPUT -s 10.1.1.3/32 -p icmp -j ACCEPT</code> <br> <br>  What unites these rules?  The same protocol is icmp.  It is by this criterion and article <b><i>to</i></b> group the rules.  In general, in this case it is more efficient to use ipset, but more on that later.  To group, you need to create a new chain, and then create a rule that will send packets to this chain. <br>  Create PROT_ICMP chain: <br><br> <code>iptables -N PROT_ICMP</code> <br> <br>  Define the rules in this thread: <br><br> <code>-A PROT_ICMP -s 10.1.1.1/32 -j ACCEPT <br> -A PROT_ICMP -s 10.1.1.2/32 -j ACCEPT <br> -A PROT_ICMP -s 10.1.1.3/32 -j ACCEPT</code> <br> <br>  As you can see, we do not check the protocol (-p) in this chain, because  send only ICMP packets to this chain.  Finally, send all ICMP packets to this chain: <br><br> <code>-A INPUT -p icmp -g PROT_ICMP</code> <br> <br>  Now the incoming packet, if it is not ICMP, will pass through only one rule instead of three. <br><br><h4>  ipset </h4><br>  Now suppose the following situation: <br><br> <code>-A INPUT -s 10.1.1.1/32 -j DROP <br> -A INPUT -s 10.1.1.2/32 -j DROP <br> -A INPUT -s 10.1.1.3/32 -j DROP</code> <br> <br>  Several rules of the same type, but it is not possible to group them or make an additional chain.  In such cases, when it is necessary to check on a large number of IP addresses and / or ports, <b>ipset</b> comes to the <b>rescue</b> .  <a href="http://ipset.netfilter.org/">ipset</a> is the <i>ip_set</i> kernel <i>module</i> , a number of auxiliary libraries and the <i>ipset</i> utility for setting parameters.  Surely there is in the repositories of your distribution, so that the installation should not be a problem. <br>  Used as follows: <br>  * A list is created: <br><br> <code>ipset -N dropips iphash</code> <br>  dropips - the name of the list, iphash - the type of the list.  The types of lists can be viewed in the man ipset, they are for every taste - to work with ip-addresses, subnets, ports, mac-addresses.  iphash is used to store IP addresses, the use of hashing prevents adding to the list of duplicate IP addresses. <br>  * Add an IP address to the list: <br><br> <code>ipset -A dropips 10.1.1.1</code> <br> <br>  * Creates a rule to use the list: <br><br> <code>iptables -A INPUT -m set --set dropips src -j DROP</code> <br>  <code>-m set</code> indicates the use of the ipset module, <code>--set dropips</code> specifies a list of IP addresses, <code>src</code> indicates that you only need to <code>--set dropips</code> IP source.  Thus, all packets from the IP addresses specified in the dropips list will be dropped. <br><br>  In the article, I did not describe the tuning of network parameters of the kernel, but focused on the rational organization of firewall rules.  A lot of information about tuning can be found on the network, these are various net. * Mem *, in the case of a large number of connections and using conntrack, the parameters net.netfilter.nf_conntrack_max, net.netfilter.nf_conntrack * timeout, etc. <br><br>  Thanks for attention. <br>  Thanks <a href="https://habrahabr.ru/users/ivlis/" class="user_link">ivlis</a> for pointing out typos. </div><p>Source: <a href="https://habr.com/ru/post/108691/">https://habr.com/ru/post/108691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108682/index.html">Speak correctly. Part 1</a></li>
<li><a href="../108685/index.html">Last.fm & Gracenote</a></li>
<li><a href="../108687/index.html">Tim Berners-Lee: Facebook can fragment the Web</a></li>
<li><a href="../108689/index.html">Olympiad hobby. Waste disposal task</a></li>
<li><a href="../108690/index.html">Routing and policy-routing in Linux with iproute2</a></li>
<li><a href="../108695/index.html">Success tracing</a></li>
<li><a href="../108697/index.html">WD Advanced Format on Windows Server 2003</a></li>
<li><a href="../108698/index.html">Social network for google</a></li>
<li><a href="../108699/index.html">Founder of OpenStreetMap goes to work at Microsoft, and OSM gets access to Bing satellite images</a></li>
<li><a href="../108701/index.html">The war in the cyber epoch: the concept of geocentric theater</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>