<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto-Deploying Django from GitLab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will describe the configuration of automatic deployment of a web application on the stack of Django + uWSGI + PostgreSQL + Nginx fro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto-Deploying Django from GitLab</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article I will describe the configuration of automatic deployment of a web application on the stack of Django + uWSGI + PostgreSQL + Nginx from the repository on the service <a href="https://gitlab.com/">GitLab.com</a> .  The foregoing also applies to the custom installation of GitLab.  It is assumed that the reader has experience in creating web applications on Django, as well as experience in administering Linux-systems. </p><a name="habracut"></a><br><p>  Deployment is implemented using <a href="http://fabfile.org/">Fabric</a> , <a href="https://docker.io/">Docker</a> and <a href="https://docs.docker.com/compose">docker-compose</a> , and it will be implemented by the continuous integration service built into GitLab, called <a href="https://about.gitlab.com/gitlab-ci">GitLab CI</a> . </p><br><h1 id="mehanizm-avtomaticheskogo-razvyortyvaniya">  Automatic Deployment Mechanism </h1><br><p>  The deployment will be as follows: </p><br><ol><li>  When pushing new commits into the repository, GitLab CI will be automatically launched. </li><li>  GitLab CI will build a Docker image with a Django application ready for launch. </li><li>  Then GitLab CI will <em>push the</em> assembled Docker image to the <a href="https://about.gitlab.com/2016/05/23/gitlab-container-registry">GitLab container registry</a> .  Note that the privacy settings in the registry are the same as those of the repository, i.e.  for public repositories GitLab registry is <strong>open to all</strong> . </li><li>  Gitlab CI will launch unit tests. </li><li> If commits or merge requests were made to the main branch ( <code>master</code> ), then after successful assembly and testing of Gitlab CI with the help of Fabric, it will deploy the assembled Docker image to the server with the IP address specified by us. </li></ol><br><p>  Private data required for deployment - private keys, <code>SECRET_KEY</code> for Django, third-party service tokens, etc.  - to store in clear text in the repository is definitely not <a href="https://docs.gitlab.com/ce/ci/variables/README.html">worth</a> it, so for their storage we will use the mechanism <a href="https://docs.gitlab.com/ce/ci/variables/README.html">GitLab Secret Variables</a> : </p><br><p><img src="https://habrastorage.org/files/bd5/a1c/a89/bd5a1ca898a24f8ca8499ace094f4d62.png" alt="image"></p><br><p>  With this approach, confidential data is available in plain text only in two places: in the project settings on GitLab.com and on the server to which the deployment is performed.  In turn, on the server confidential data will be stored in the environment variables (read: will be visible to anyone who can access it via SSH). </p><br><p>  The following variables are required for the deployment mechanism to work: </p><br><ul><li>  <code>DEPLOY_KEY</code> - the private part of the SSH key that is used to log in to the server; </li><li>  <code>DEPLOY_ADDR</code> - its IP address; </li><li>  <code>SECRET_KEY</code> is the <a href="https://docs.djangoproject.com/en/dev/ref/settings/">corresponding</a> Django setting. </li></ul><br><p>  In addition, in the Django project's <code>settings.py</code> file, we define <code>SECRET_KEY</code> as follows: </p><br><pre> <code class="hljs vhdl">SECRET_KEY = os.getenv(<span class="hljs-symbol"><span class="hljs-symbol">'SECRET_KEY</span></span>') <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">'SECRET_KEY</span></span> environment <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> set.')</code> </pre> <br><h1 id="shag-1-docker">  Step 1: Docker </h1><br><p>  First of all, create a <code>Dockerfile</code> to run Django and uWSGI based on the lightweight <a href="https://hub.docker.com/_/alpine">Alpine Linux</a> image: </p><br><div class="spoiler">  <b class="spoiler_title">web / Dockerfile</b> <div class="spoiler_text"><pre> <code class="hljs dos">FROM python:<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>-alpine RUN <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> -p /usr/src/app WORKDIR /usr/src/app RUN apk add --no-cache --virtual .build-deps gcc musl-dev linux-headers pkgconf \ autoconf automake libtool make postgresql-dev postgresql-client openssl-dev &amp;&amp; \ apk add postgresql-libs postgresql-client &amp;&amp; \ #    uWSGI  Docker, . https://git.io/v1ve3 (while true; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pip --no-cache-<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> install uwsgi==<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">14</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; done) <span class="hljs-built_in"><span class="hljs-built_in">COPY</span></span> requirements.txt /usr/src/app/ RUN pip install --no-cache-<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> -r requirements.txt <span class="hljs-built_in"><span class="hljs-built_in">COPY</span></span> . /usr/src/app RUN SECRET_KEY=build ./manage.py collectstatic --noinput &amp;&amp; \ ./manage.py makemessages &amp;&amp; \ apk <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> .build-deps</code> </pre> </div></div><br><p>  It is assumed that our web application dependencies, as is customary in the Python world, are stored in the <code>requirements.txt</code> file. </p><br><h1 id="shag-2-docker-compose">  Step 2: docker-compose </h1><br><p>  Next, to orchestrate the <code>docker-compose</code> stack containers we need <code>docker-compose</code> . <br>  Theoretically, one could do without it, but then the file with instructions for CI would become bloated and unreadable (see for an example <a href="https://about.gitlab.com/2016/08/11/building-an-elixir-release-into-docker-image-using-gitlab-ci-part-1/">here</a> ). </p><br><p>  So, in the root directory of the repository, create a <code>docker-compose.yml</code> file <code>docker-compose.yml</code> following content: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs mel">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> services: web: # TODO:  username  project    . <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: registry.gitlab.com/username/project:${CI_BUILD_REF_NAME} build: ./web environment: #  ,    #     - SECRET_KEY command: uwsgi /usr/src/app/uwsgi.ini volumes: - static:/srv/static restart: unless-stopped test: # TODO:  username  project    . <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: registry.gitlab.com/username/project:${CI_BUILD_REF_NAME} command: <span class="hljs-keyword"><span class="hljs-keyword">python</span></span> manage.py test restart: <span class="hljs-string"><span class="hljs-string">"no"</span></span> postgres: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: postgres:<span class="hljs-number"><span class="hljs-number">9.6</span></span> environment: #  :     - POSTGRES_USER=root - POSTGRES_DB=database volumes: #   - data:/var/lib/postgresql/data restart: unless-stopped nginx: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: nginx:mainline ports: #    - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> volumes: #      - ./nginx:/etc/nginx:ro - static:/srv/static:ro depends_on: - web restart: unless-stopped</code> </pre> </div></div><br><p>  The given file corresponds to the following project structure: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">repository</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">mime</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.types</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conf</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssl_params</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">uwsgi_params</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">web</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">project</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ __<span class="hljs-selector-tag"><span class="hljs-selector-tag">init__</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">settings</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">urls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">wsgi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">migrations</span></span> ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ ... ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ __<span class="hljs-selector-tag"><span class="hljs-selector-tag">init__</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">admin</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">apps</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">models</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">tests</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">views</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">manage</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">requirements</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.txt</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">uwsgi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ini</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">docker-compose</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">fabfile</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span></code> </pre> <br><p>  Now the entire stack is started with a single <code>docker-compose up</code> , and inside the Docker stack containers, access to other running containers occurs using DNS names corresponding to the entries in the <code>docker-compose.yml</code> , in addition, all open container ports are accessible to each other, how they are on the same internal Docker network.  So, the relevant part of the Nginx config will look like this: </p><br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> django { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> web:<span class="hljs-number"><span class="hljs-number">8000</span></span>; }</code> </pre> </div></div><br><p>  ... and the Django database access settings are as follows: </p><br><div class="spoiler">  <b class="spoiler_title">settings.py</b> <div class="spoiler_text"><pre> <code class="hljs cs">DATABASES = { <span class="hljs-string"><span class="hljs-string">'default'</span></span>: { <span class="hljs-string"><span class="hljs-string">'ENGINE'</span></span>: <span class="hljs-string"><span class="hljs-string">'django.db.backends.postgresql'</span></span>, <span class="hljs-string"><span class="hljs-string">'NAME'</span></span>: <span class="hljs-string"><span class="hljs-string">'database'</span></span>, <span class="hljs-string"><span class="hljs-string">'HOST'</span></span>: <span class="hljs-string"><span class="hljs-string">'postgres'</span></span>, } }</code> </pre> </div></div><br><p>  Thanks to the <code>restart: unless-stopped</code> when the server is restarted, all the containers in our stack are automatically restarted with the parameters with which they were started initially, i.e.  no additional actions are required when restarting the server. </p><br><h1 id="shag-3-gitlab-ci">  Step 3: GitLab CI </h1><br><p>  Create a <code>.gitlab-ci.yml</code> file in the root of the repository with instructions for GitLab CI: </p><br><div class="spoiler">  <b class="spoiler_title">.gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#  Gitlab CI,     Docker  . image: docker:latest services: - docker:dind # , </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       : # -  Docker-, # -   Django, # -    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">. stages: - build - test - deploy #   ,    # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   . # ,    , </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   ,    #     Docker-,    . before_script: #  pip - apk add --no-cache py-pip #  docker-compose - pip install docker-compose==1.9.0 #   Gitlab Docker registry - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY #  Docker- build: stage: build script: #   - docker-compose build #    registry - docker-compose push #   test: stage: test script: # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  ,      #   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> registry - docker-compose pull test #   - docker-compose run test #   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> deploy: stage: deploy #    master only: - master # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">      before_script: #   Fabric, bash  rsync - apk add --no-cache openssh-client py-pip py-crypto bash rsync #  Fabric - pip install fabric==1.12.0 #    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  - eval $(ssh-agent -s) - bash -c 'ssh-add &lt;(echo "$DEPLOY_KEY")' - mkdir -p ~/.ssh - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" &gt; ~/.ssh/config script: - fab -H $DEPLOY_ADDR deploy</span></span></code> </pre> </div></div><br><p>  It is worth noting that the GitLab CI Docker runners that we use use the same <a href="https://hub.docker.com/_/alpine">Alpine Linux</a> image as a basis, which creates a number of difficulties - there is no bash out of the box, an unusual package manager <a href="https://wiki.alpinelinux.org/wiki/Alpine_Linux_package_management">apk</a> , an unusual standard library <a href="https://www.musl-libc.org/">musl-libc</a> , etc. Difficulties are compensated by the fact that Apline Linux-based images are truly lightweight;  so, the official <code>python:3.5.2-alpine</code> image <code>python:3.5.2-alpine</code> <a href="https://microbadger.com/images/python">weighs</a> only 27.6 MB. </p><br><h1 id="shag-4-fabric">  Step 4: Fabric </h1><br><p>  To roll out the application to the server, in the root directory of the repository, create the file <code>fabfile.py</code> , at least containing the following: </p><br><div class="spoiler">  <b class="spoiler_title">fabfile.py</b> <div class="spoiler_text"><pre> <code class="hljs lua">#!/usr/bin/env python2 from fabric.api import hide, env, settings, abort, run, cd, shell_env from fabric.colors import magenta, red from fabric.contrib.files import append from fabric.contrib.project import rsync_project import <span class="hljs-built_in"><span class="hljs-built_in">os</span></span> env.user = <span class="hljs-string"><span class="hljs-string">'root'</span></span> env.abort_on_prompts = True # TODO:     ,       PATH = <span class="hljs-string"><span class="hljs-string">'/srv/mywebapp'</span></span> ENV_FILE = <span class="hljs-string"><span class="hljs-string">'/etc/profile.d/variables.sh'</span></span> VARIABLES = (<span class="hljs-string"><span class="hljs-string">'SECRET_KEY'</span></span>, ) def deploy(): def rsync(): exclusions = (<span class="hljs-string"><span class="hljs-string">'.git*'</span></span>, <span class="hljs-string"><span class="hljs-string">'.env'</span></span>, <span class="hljs-string"><span class="hljs-string">'*.sock*'</span></span>, <span class="hljs-string"><span class="hljs-string">'*.lock'</span></span>, <span class="hljs-string"><span class="hljs-string">'*.pyc'</span></span>, <span class="hljs-string"><span class="hljs-string">'*cache*'</span></span>, <span class="hljs-string"><span class="hljs-string">'*.log'</span></span>, <span class="hljs-string"><span class="hljs-string">'log/'</span></span>, <span class="hljs-string"><span class="hljs-string">'id_rsa*'</span></span>, <span class="hljs-string"><span class="hljs-string">'maintenance'</span></span>) rsync_project(PATH, <span class="hljs-string"><span class="hljs-string">'./'</span></span>, exclude=exclusions, delete=True) def docker_compose(command): with cd(PATH): with shell_env(CI_BUILD_REF_NAME=<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>( <span class="hljs-string"><span class="hljs-string">'CI_BUILD_REF_NAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span>)): #  -, . https://git.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/vXH8a run(<span class="hljs-string"><span class="hljs-string">'set -o pipefail; docker-compose %s | tee'</span></span> % command) #     variables_set = True <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> var <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> VARIABLES + (<span class="hljs-string"><span class="hljs-string">'CI_BUILD_TOKEN'</span></span>, ): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>(var) is None: variables_set = False <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(red(<span class="hljs-string"><span class="hljs-string">'ERROR: environment variable '</span></span> + var + <span class="hljs-string"><span class="hljs-string">' is not set.'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> variables_set: abort(<span class="hljs-string"><span class="hljs-string">'Missing required parameters'</span></span>) with hide(<span class="hljs-string"><span class="hljs-string">'commands'</span></span>): run(<span class="hljs-string"><span class="hljs-string">'rm -f "%s"'</span></span> % ENV_FILE) append(ENV_FILE, [<span class="hljs-string"><span class="hljs-string">'export %s="%s"'</span></span> % (var, val) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> var, val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zip( VARIABLES, map(<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>, VARIABLES))]) # Fabric        run(), #      . . http://stackoverflow.com/q/<span class="hljs-number"><span class="hljs-number">38024726</span></span>/<span class="hljs-number"><span class="hljs-number">1336774</span></span> #   registry run(<span class="hljs-string"><span class="hljs-string">'docker login -u %s -p %s %s'</span></span> % (<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>(<span class="hljs-string"><span class="hljs-string">'REGISTRY_USER'</span></span>, <span class="hljs-string"><span class="hljs-string">'gitlab-ci-token'</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>(<span class="hljs-string"><span class="hljs-string">'CI_BUILD_TOKEN'</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">getenv</span></span>(<span class="hljs-string"><span class="hljs-string">'CI_REGISTRY'</span></span>, <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com'</span></span>))) #   ,   with settings(warn_only=True): with hide(<span class="hljs-string"><span class="hljs-string">'warnings'</span></span>): need_bootstrap = run(<span class="hljs-string"><span class="hljs-string">'docker ps | grep -q web'</span></span>).return_code != <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> need_bootstrap: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(magenta(<span class="hljs-string"><span class="hljs-string">'No previous installation found, bootstrapping'</span></span>)) rsync() docker_compose(<span class="hljs-string"><span class="hljs-string">'up -d'</span></span>) #   <span class="hljs-string"><span class="hljs-string">" "</span></span>, . https://habr.ru/post/<span class="hljs-number"><span class="hljs-number">139968</span></span> run(<span class="hljs-string"><span class="hljs-string">'touch %s/nginx/maintenance &amp;&amp; docker kill -s HUP nginx_1'</span></span> % PATH) rsync() docker_compose(<span class="hljs-string"><span class="hljs-string">'pull'</span></span>) docker_compose(<span class="hljs-string"><span class="hljs-string">'up -d'</span></span>) #   run(<span class="hljs-string"><span class="hljs-string">'rm -f %s/nginx/maintenance &amp;&amp; docker kill -s HUP nginx_1'</span></span> % PATH)</code> </pre> </div></div><br><p>  Generally speaking, copying <code>rsync</code> 's entire repository is optional; a <code>docker-compose.yml</code> and the contents of the <code>nginx</code> directory would be enough to run. <br>  The application code is stored on the server in case you need to make urgent "profitable" changes.  On free gitlab.com accounts, relatively weak virtualized hardware is used to run CI, so the build, tests, and rollout usually take 5-10 minutes to complete. </p><br><p><img src="https://habrastorage.org/files/ad8/d10/efb/ad8d10efb8a048da8d40ae381a73a2b6.png" alt="image"><br>  <em>(and it happens that they are still in the queue sticking out for ages)</em> </p><br><p>  However, there are cases when every second counts - for such cases we leave a loophole in the form of complete application sources.  To apply the changes made by "profitable", just go to the directory <code>/srv/mywebapp</code> and say in the console </p><br><pre> <code class="bash hljs">docker-compose build docker-compose up -d</code> </pre> <br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Thus, we have implemented continuous web application integration using the GitLab service. </p><br><p><img src="https://habrastorage.org/files/de7/3e2/dd0/de73e2dd0b7b4742b4cacaf481fa821f.png" alt="image"></p><br><p>  Now all changes will be run through the battery of automatic tests (which, of course, also need to write), and changes in the main branch will automatically be deployed to the combat server with near-zero downtime. </p><br><p>  The following questions were left out of the article: </p><br><ul><li>  setting up Nginx log rotation; </li><li>  PostgreSQL backups setup; </li><li>  setting <a href="https://github.com/spotify/docker-gc">docker-gc</a> to prevent the awkward " <code>No space left on device</code> " situation. </li></ul><br><p>  Let's leave them to the inquisitive reader as an independent exercise. </p><br><h2 id="ssylki">  Links </h2><br><p>  ¬ª <a href="https://habrahabr.ru/company/softmart/blog/310502">GitLab CI: Learning to Deploy</a> <br>  ¬ª <a href="https://docs.gitlab.com/ce/ci/quick_start/README.html">GitLab CI Quick Start</a> <br>  ¬ª <a href="https://gitlab.com/help/user/project/container_registry">GitLab Container Registry</a> <br>  ¬ª <a href="https://habrahabr.ru/post/226419">Django on production.</a>  <a href="https://habrahabr.ru/post/226419">uWSGI + nginx.</a>  <a href="https://habrahabr.ru/post/226419">Detailed guide</a> <br>  " <a href="http://www.fabfile.org/">Fabric documentation</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/316054/">https://habr.com/ru/post/316054/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316040/index.html">New survey ‚ÄúState of the Nation of Developers‚Äù by Vision Mobile</a></li>
<li><a href="../316046/index.html">Strange games</a></li>
<li><a href="../316048/index.html">How to open a startup in Berlin [infographics]</a></li>
<li><a href="../316050/index.html">Badoo Worldwide Billing QA Eyes</a></li>
<li><a href="../316052/index.html">Oracle buys high-profile Dyn provider in hopes of bypassing Amazon in the cloud market</a></li>
<li><a href="../316056/index.html">How I did mirroring virtual machines for Free ESXi</a></li>
<li><a href="../316058/index.html">Rambler.Android # 4 results</a></li>
<li><a href="../316060/index.html">‚ÄúPeople often forget about engaging the audience in their performance‚Äù - an interview with Roman Pochorchim, presentation coach</a></li>
<li><a href="../316062/index.html">Nobelic: how to make the camera smart, homely, durable</a></li>
<li><a href="../316064/index.html">10 reasons why you should try Microsoft SQL Server right now</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>