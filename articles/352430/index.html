<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tarantool application: stored procedures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation of an article with DZone. Original 


 I want to share my experience in creating applications for Tarantool, and today we will talk about ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tarantool application: stored procedures</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://dzone.com/storage/temp/7209529-800x350-stored-procedures.png" alt="image"></p><br><p>  <em>Translation of an article with DZone.</em>  <em><a href="https://dzone.com/articles/applications-for-tarantool-part-1-stored-procedure">Original</a></em> </p><br><p>  I want to share my experience in creating applications for Tarantool, and today we will talk about installing this database, storing data and accessing them, as well as writing stored procedures. </p><a name="habracut"></a><br><p>  Tarantool is a NoSQL / NewSQL database that stores data in RAM, but can use a disk and ensure consistency through a carefully designed mechanism called the write-ahead log (WAL).  Tarantool also boasts a built-in LuaJIT compiler (JIT - just-in-time), which allows you to execute Lua-code. </p><br><p><img src="https://habrastorage.org/webt/24/g-/tq/24g-tqoiw_sncacpmfniiukpzlg.png"></p><br><h2 id="pervye-shagi">  The first steps </h2><br><p>  We will consider the creation of a Tarantool application that implements an API for registering and authenticating users.  Its features: </p><br><ul><li>  Registration and authentication by mail in three stages: account creation, registration confirmation and password setting. </li><li>  Registration using social network credentials (FB, Google+, VKontakte, etc.). </li><li>  Password recovery. </li></ul><br><p>  For an example of a stored procedure for Tarantool, we turn to the first stage, or rather to obtain a registration confirmation code.  You can go to the <a href="https://github.com/mailru/tarantool-authman">GitHub repository</a> and perform all actions in the course of the story. </p><br><h2 id="ustanavlivaem-tarantool">  Install Tarantool </h2><br><p>  The network has detailed installation instructions for various operating systems.  For example, to install Tarantool under Ubuntu, paste it into the console and execute this script: </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> http://download.tarantool.org/tarantool/1.9/gpgkey | sudo apt-key add - release=`lsb_release -c -s` sudo apt-get -y install apt-transport-https sudo rm -f /etc/apt/sources.list.d/*tarantool<span class="hljs-regexp"><span class="hljs-regexp">*.list</span></span> sudo tee /etc/apt/sources.list.d/tarantool_1_9.list &lt;&lt;- EOF deb http://download.tarantool.org/tarantool/1.9/ubuntu/ <span class="hljs-variable"><span class="hljs-variable">$release</span></span> main deb-src http://download.tarantool.org/tarantool/1.9/ubuntu/ <span class="hljs-variable"><span class="hljs-variable">$release</span></span> main EOF sudo apt-get update sudo apt-get -y install tarantool</code> </pre> <br><p>  Verify the success of the installation by typing <code>tarantool</code> and logging in to the interactive administrator console. </p><br><pre> <code class="hljs pgsql">$ tarantool <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span>-g195d446 <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> interactive help tarantool&gt;</code> </pre> <br><p>  Here you can already try programming on Lua.  If you are not familiar with this language, then here is a quick start guide: <a href="http://tylerneylon.com/a/learn-lua/"></a>  <a href="http://tylerneylon.com/a/learn-lua">http://tylerneylon.com/a/learn-lua</a> . </p><br><h2 id="registraciya-po-pochte">  Registration by mail </h2><br><p>  Now we will write our first script to create a space in which all users will be stored.  It is similar to a table in a relational database.  The data itself is stored in tuples (arrays containing records).  Each space must have one primary index and may have several secondary indexes.  Indices can be defined by one or several fields.  Here is a space map of our authentication service: </p><br><p><img src="https://habrastorage.org/webt/s2/fy/2x/s2fy2xf4pyilnsatx0o7vuqceb4.png"></p><br><p>  We use two types of indices: <code>HASH</code> and <code>TREE</code> .  The <code>HASH</code> index allows you to search for tuples using a full match of the primary key, which must be unique.  The <code>TREE</code> index supports non-unique keys, allows you to search at the beginning of a composite index and organize the sorting of keys, since their values ​​are ordered within the index. </p><br><p>  The <code>session</code> space contains a special key ( <code>session_secret</code> ) used to sign session cookies.  Storing session keys allows you to log out users on the server side if necessary.  The session also has an optional reference to the <code>social</code> space.  This is needed to check the sessions of those users who log on to the social network credentials (we check the validity of the stored OAuth 2 token). </p><br><h2 id="pishem-prilozhenie">  We write application </h2><br><p>  Before you start writing the application itself, let's take a look at the project structure: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tarantool-authman</span></span> ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">authman</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">model</span></span> │ │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">password</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">password_token</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">session</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">social</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ │ └── <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">utils</span></span> │ │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ │ └── <span class="hljs-selector-tag"><span class="hljs-selector-tag">utils</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">db</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">init</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">response</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ └── <span class="hljs-selector-tag"><span class="hljs-selector-tag">validator</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> └── <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">case</span></span> │ ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">auth</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> │ └── <span class="hljs-selector-tag"><span class="hljs-selector-tag">registration</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ├── <span class="hljs-selector-tag"><span class="hljs-selector-tag">authman</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.test</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> └── <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span></code> </pre> <br><p>  The paths defined in the <code>package.path</code> variable are used to import Lua packages.  In our case, the packages are imported relative to the current <code>tarantool-authman</code> .  But if needed, the import paths can be easily extended: </p><br><pre> <code class="hljs scala">-- <span class="hljs-type"><span class="hljs-type">Prepending</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the highest priority <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>.path = “/some/other/path/?.lua;” .. <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>.path</code> </pre> <br><p>  Before creating the first space, let's put all the necessary constants in separate models.  You need to give a name to each space and index.  You also need to determine the order of the fields in the tuple.  For example, this is the model <code>authman/model/user.lua</code> : </p><br><pre> <code class="hljs python">-- Our package <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a Lua table local user = {} -- The package has the only function — model — that returns a table -- <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the model<span class="hljs-string"><span class="hljs-string">'s fields and methods -- The function receives configuration in the form of a Lua table function user.model(config) local model = {} -- Space and index names model.SPACE_NAME = '</span></span>auth_use<span class="hljs-string"><span class="hljs-string">r' model.PRIMARY_INDEX = '</span></span>primary<span class="hljs-string"><span class="hljs-string">' model.EMAIL_INDEX = '</span></span>email_index<span class="hljs-string"><span class="hljs-string">' -- Assigning numbers to tuple fields -- Note thatLua uses one-based indexing! model.ID = 1 model.EMAIL = 2 model.TYPE = 3 model.IS_ACTIVE = 4 -- User types: registered via email or with social network -- credentials model.COMMON_TYPE = 1 model.SOCIAL_TYPE = 2 return model end -- Returning the package return user</span></span></code> </pre> <br><p>  When processing users, we will need two indexes: unique by ID and non-unique by mail address.  When two different users are registered with social network credentials, they can specify the same addresses or not specify them at all.  And for users who register in the usual way, the application will check the uniqueness of postal addresses. </p><br><p>  The <code>authman/db.lua</code> contains a method for creating spaces: </p><br><pre> <code class="hljs scala">local db = {} -- <span class="hljs-type"><span class="hljs-type">Importing</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> and calling the model function -- <span class="hljs-type"><span class="hljs-type">The</span></span> config parameter is assigned a nil (empty) value local user = require(<span class="hljs-symbol"><span class="hljs-symbol">'authman</span></span>.model.user').model() -- <span class="hljs-type"><span class="hljs-type">The</span></span> db <span class="hljs-keyword"><span class="hljs-keyword">package</span></span><span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> method <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> creating spaces and indexes function db.create_database() local user_space = box.schema.space.create(user.<span class="hljs-type"><span class="hljs-type">SPACE_NAME</span></span>, { if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) user_space:create_index(user.<span class="hljs-type"><span class="hljs-type">PRIMARY_INDEX</span></span>, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-symbol"><span class="hljs-symbol">'has</span></span>h', parts = {user.<span class="hljs-type"><span class="hljs-type">ID</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'strin</span></span>g'}, if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) user_space:create_index(user.<span class="hljs-type"><span class="hljs-type">EMAIL_INDEX</span></span>, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-symbol"><span class="hljs-symbol">'tre</span></span>e', unique = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, parts = {user.<span class="hljs-type"><span class="hljs-type">EMAIL</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'strin</span></span>g', user.<span class="hljs-type"><span class="hljs-type">TYPE</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'unsigne</span></span>d'}, if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) end <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db</code> </pre> <br><p>  The UUID will act as the user ID, and we will use the <code>HASH</code> index for a full match search.  The index for searching by mail will consist of two parts: ( <code>user.EMAIL, 'string'</code> ) - the user's email address, ( <code>user.TYPE, 'unsigned'</code> ) - the type of user.  I recall that the types are determined a little earlier in the model.  The composite index allows you to search not only in all fields, but also in the first part of the index.  So we can only search by mail address (without user type). </p><br><p>  Log in to the admin console and use the <code>authman/db.lua</code> . </p><br><pre> <code class="hljs pgsql">$ tarantool <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span>-g195d446 <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> interactive help tarantool&gt; db = require(<span class="hljs-string"><span class="hljs-string">'authman.db'</span></span>) tarantool&gt; <span class="hljs-type"><span class="hljs-type">box</span></span>.cfg({}) tarantool&gt; db.create_database()</code> </pre> <br><p>  Great, we just created the first space.  Don't forget: before calling <code>box.schema.space.create</code> , you need to configure and start the server using the <code>box.cfg</code> method.  Now you can perform some simple actions inside the created space: </p><br><pre> <code class="hljs scala">-- <span class="hljs-type"><span class="hljs-type">Creating</span></span> users tarantool&gt; box.space.auth_user:insert({<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'example_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>}) — - - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'example_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] … tarantool&gt; box.space.auth_user:insert({<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'example_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>}) — - - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'example_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] … -- <span class="hljs-type"><span class="hljs-type">Getting</span></span> a <span class="hljs-type"><span class="hljs-type">Lua</span></span> table (array) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> all the users tarantool&gt; box.space.auth_user:select() — - - — [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'example_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] — [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'example_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] … -- <span class="hljs-type"><span class="hljs-type">Getting</span></span> a user by the primary key tarantool&gt; box.space.auth_user:get({<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1'}) — - - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'example_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] … -- <span class="hljs-type"><span class="hljs-type">Getting</span></span> a user by the composite key tarantool&gt; box.space.auth_user.index.email_index:select({<span class="hljs-symbol"><span class="hljs-symbol">'example_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>}) — - - — [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'example_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] … -- <span class="hljs-type"><span class="hljs-type">Changing</span></span> the data in the second field tarantool&gt; box.space.auth_user:update(<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', {{'=', <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'new_email</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru'}, }) — - - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'new_email</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] …</code> </pre> <br><p>  Unique indexes do not allow non-unique values.  If you want to create records that may already be in space, use the operation <code>upsert</code> (update / insert).  A complete list of available methods is given in the <a href="https://tarantool.org/doc/1.9/book/box/box_space.html">official documentation</a> . </p><br><p>  Let's expand the user model with the option of registering users: </p><br><pre> <code class="hljs delphi"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_space</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">box</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">space</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPACE_NAME</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_by_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(email, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">type</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validator</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">not_empty_string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(email)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_space</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EMAIL_INDEX</span></span></span><span class="hljs-function">]:</span></span>select(<span class="hljs-comment"><span class="hljs-comment">{email, type}</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> -- Creating a user -- Fields that are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the unique <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> mandatory <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_tuple)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">local</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user_id</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uuid</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">local</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validator</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_tuple[model.EMAIL])</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user_tuple</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EMAIL</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">or</span></span></span><span class="hljs-function"> '' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_space</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>insert<span class="hljs-comment"><span class="hljs-comment">{ user_id, email, user_tuple[model.TYPE], user_tuple[model.IS_ACTIVE], user_tuple[model.PROFILE] }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> -- Generating a confirmation code sent via email <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> used <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> -- account activation -- Usually, this code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> embedded into a link <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a GET parameter -- activation_secret — one <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the configurable parameters when -- initializing the application <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate_activation_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">digest</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">md5_hex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">.format(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'%s.%s'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, config.activation_secret, user_id)</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  The following code uses two standard packages Tarantool - <code>uuid</code> and <code>digest</code> - and one created by the user - <code>validator</code> .  But first you need to import them: </p><br><pre> <code class="hljs lisp">-- standard Tarantool packages local digest = require('digest') local uuid = require('uuid') -- Our application's package (<span class="hljs-name"><span class="hljs-name">handles</span></span> data validation) local validator = require('authman.validator')</code> </pre> <br><p>  When defining variables, we use the <code>local</code> operator, which limits their scope to the current block.  If you do not do this, the variables will be global, and we need to avoid this because of possible name conflicts. </p><br><p>  Now we will create the main <code>authman/init.lua</code> , which will store all API methods: </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> auth = {} <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.response'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> error = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> validator = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.validator'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.db'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> utils = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.utils.utils'</span></span>) -- The <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> returns the only function — api — that configures <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> -- returns the application function auth.api(config) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> api = {} -- The validator <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> contains checks <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> various value types -- This <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> sets the default <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> as well config = validator.config(config) -- Importing the models <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> working with data <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.model.user'</span></span>).model(config) -- Creating a space db.create_database() -- The api method creates a non-active user with a specified email -- address function api.registration(email) -- Preprocessing the email address — making it all lowercase email = utils.lower(email) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> validator.email(email) then <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.error(error.INVALID_PARAMS) end -- Checking <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a user already <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> with a <span class="hljs-keyword"><span class="hljs-keyword">given</span></span> email -- address <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> user_tuple = user.get_by_email(email, user.COMMON_TYPE) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user_tuple ~= nil then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user_tuple[user.IS_ACTIVE] then <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.error(error.USER_ALREADY_EXISTS) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> code = user.generate_activation_code(user_tuple[user.ID]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.ok(code) end end -- Writing data to the space user_tuple = user.create({ [user.EMAIL] = email, [user.TYPE] = user.COMMON_TYPE, [user.IS_ACTIVE] = false, }) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> code = user.generate_activation_code(user_tuple[user.ID]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.ok(code) end <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api end <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> auth</code> </pre> <br><p>  Fine!  Now users can create accounts. </p><br><pre> <code class="hljs lua">tarantool&gt; auth = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman'</span></span>).api(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- Using the api to get a registration confirmation code tarantool&gt; ok, code = auth.registration('example@mail.ru') -- This code needs to be sent to a user's email address so that they -- can activate their account tarantool&gt; code 022c1ff1f0b171e51cb6c6e32aefd6ab</span></span></code> </pre> <br><p>  <em>To be continued</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352430/">https://habr.com/ru/post/352430/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352420/index.html">New Intel microarchitecture: fast, but not free</a></li>
<li><a href="../352422/index.html">Payloads for testing web applications</a></li>
<li><a href="../352424/index.html">Analysis of the results of the presidential election of 2018. At the federal and regional level</a></li>
<li><a href="../352426/index.html">React v.16.3.0 released</a></li>
<li><a href="../352428/index.html">Friday JS: minus without minus</a></li>
<li><a href="../352432/index.html">Linux distribution from scratch to build Docker images - our experience with dappdeps</a></li>
<li><a href="../352434/index.html">Ransomware is gaining strength</a></li>
<li><a href="../352436/index.html">Blondes, monsters and artificial intelligence addictions</a></li>
<li><a href="../352438/index.html">Java Puzzlers NG S02: Wonderful and Wonderful</a></li>
<li><a href="../352440/index.html">The book "Security in PHP" (part 2). Code injection attacks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>