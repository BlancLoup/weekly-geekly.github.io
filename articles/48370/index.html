<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gmail Notifier DIY</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I started settling in under Linux and found that I greatly lack those beautiful popups, notifying of the arrival of new mail, which Google Talk can sh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gmail Notifier DIY</h1><div class="post__text post__text-html js-mediator-article"><img src="http://mraleph.symlevel.com/files/habr/awesomegmail/windows-notification.png" alt="image" align="left">  I started settling in under Linux and found that I greatly lack those beautiful popups, notifying of the arrival of new mail, which Google Talk can show under Windows.  Googling found several ready-made scripts that allow you to implement such pop-ups (among others: bash-script, bash-script + python-script, plus pidgin can check mail), but I didn‚Äôt like all approaches <s>slightly</s> and needed updating with a file, so I I decided to do everything from scratch (let it be ugly, but my own!).  About the things that I encountered in the process and will be discussed ... <br><br><a name="habracut"></a><br><br><h5>  Background: the choice of WM (window manager) </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In Linux, managing windows, drawing any frames and system menus is given to the X server by the so-called <i>window managers</i> .  Therefore, under Linux, unlike Windows, you can flexibly customize the appearance of windows, as well as their behavior and location. <br><br>  I must say that all the <a href="http://habrahabr.ru/blogs/crazydev/">‚Äúabnormal programmers‚Äù</a> have their own window managers for Linux.  The haskellists have <a href="http://xmonad.org/">xmonad</a> , and the lua's like me have <a href="http://modeemi.fi/~tuomov/ion/">Ion</a> and the modestly named <a href="http://awesome.naquadah.org/">awesome</a> .  Finally, C-Schnick has an ultra-light <a href="http://www.suckless.org/dwm/">dwm</a> , the only way to reconfigure that is editing and reassembling. <br><br>  All of the above-mentioned window managers belong to the <i>tiling window manager</i> class (Wikipedia offers the translation <i>‚Äúframe (or mosaic) window manager‚Äù</i> ), a small overview of such managers <a href="http://habrahabr.ru/blogs/beautiful_things/27227/">has recently been on Habr√©</a> .  A distinctive feature of such WM is that individual windows are placed on the screen without overlaps, covering it like a mosaic: <br><br><div style="text-align:center;"><img src="http://mraleph.symlevel.com/files/habr/awesomegmail/desktop-s320x240.png" height="200" width="320"></div><br><br>  This screenshot shows that as a <a href="http://habrahabr.ru/blogs/i_am_clever/48234/">Wiccan and lunopath</a> , as well as a person who respects modesty, I settled on awesome. <br><br>  In general, awesome has some problems with documentation (well, well, this is the scourge of many not only open, but also proprietary projects).  The API is well documented, but some things have to be guessed or fumbled on the wiki. <br><br>  A detailed procedure for installing the latest versions on Ubuntu is described, for example, <a href="http://ubuntuforums.org/showthread.php%3Fp%3D6059853">here</a> . <br><br><h5>  Display notifications </h5><br><br>  I love to move in the development of backwards, so I first became interested in the question: <i>‚Äúhow can I show a pop in awesome?‚Äù</i> .  The answer was found quickly: using the built-in library <b>naughty</b> (I think the reader has already caught the general direction of the names?).  For example, if you execute such code in the context of awesome: <br><pre> naughty.notify {
     title = title, 
     text = text, 
     timeout = 10, 
     fg = "# afbe01", 
     width = 500, 
     icon = icon_big,
     icon_size = 32
 }
</pre><br>  then in a given place on the screen a moderately beautiful popup pops up with the title <b>title</b> , the text of the text message and the <b>icon_big</b> icon. <br><br>  You can execute Lua code in the awesome context using the <b>awesome-client</b> utility.  In fact, this is a shell that accepts lua scripts as input (one at a line) and sequentially executes them. <br><br>  Thus, if you want to show a popup from some independently working program / script, you need to substitute their values ‚Äã‚Äãfor title, text and icon_big, then transfer the resulting line (without line breaks!) To the input awesome-client. <br><br>  Since I write most of the scripts on lua and constantly alternate normal lua code and forming lines for awesome-client, I don‚Äôt want to, I <a href="http://mraleph.symlevel.com/files/habr/awesomegmail/gmail-notifier.lua.html">used a special metatable magic to</a> write a mechanism that allows you to transparently call code in an awesome context.  It is enough to write in the script: <br><pre> local naughty = proxy "naughty"
</pre><br>  and further work with table fields (calls and assignments) naughty will be transparently performed in an awesome context. <br><br>  And naughty is friends with <a href="http://en.wikipedia.org/wiki/D-Bus">dbus</a> , but so far I have managed without it. <br><br><h5>  Us a letter? </h5><br><br>  So, I can show a notification, but it is completely incomprehensible to me where to get information about the arrival of a new letter.  You can, of course, allow POP access to the box and check its contents every <b>N</b> seconds or (prompted by @merlin_rterm), you can open IMAP access and pick up, get notifications ( <a href="http://www.ietf.org/rfc/rfc2177.txt">[RFC 2177] IMAP 4 IDLE Command</a> ).  You can take the Atom feed of the mailbox and <a href="http://awesome.naquadah.org/wiki/index.php%3Ftitle%3DGmail_Widget">parse it</a> every <b>M</b> seconds <a href="http://awesome.naquadah.org/wiki/index.php%3Ftitle%3DGmail_Widget">with a python script</a> or <a href="http://awesome.naquadah.org/wiki/index.php%3Ftitle%3DGmail_Widget-2">use bash &amp; wget &amp; grep-fu</a> .  None of these solutions seemed elegant enough.  I entered into Google a couple of requests that contained, among other things, the words <i>‚Äúgmail‚Äù</i> , <i>‚Äúapi‚Äù</i> and <i>‚Äúlua‚Äù</i> , but received only a fig.  My despair was so great that I wanted to throw everything to hell and <s>hang</s> myself to seduce myself into the pythonists ‚Äôcamp, but then a bright thought came to my head: once google talk shows notifications, once pidgin checks mail, it means it‚Äôs somehow connected with the XMPP protocol, popularly known as Jabber, on top of which Google Talk is implemented!  Inspired by this revelation, I entered <i>google talk api</i> into <i>google</i> and after a couple of mouse clicks I found myself on a page with a talking name <a href="http://code.google.com/intl/ru_ALL/apis/talk/jep_extensions/gmail.html">Gmail Notifications</a> . <br><br><h5>  Even to the Finnish rocks brown I treat with a pun. </h5><br><br>  <i>STANCE and (obsolete) stanz, stanza, (fr. Stance from it. Stanza) (lit.).</i>  <i>In verses - stanza, which is a complete syntactic period.</i> <br><br>  XMPP is such a fun protocol in which <s>Romeo and Juliet</s> clients and servers exchange XML stanza between themselves.  <a href="http://tools.ietf.org/html/rfc3920">[RFC 3920] XMPP Core</a> describes three types of stanzas: <b>&lt;iq /&gt;</b> (Info / Query), <b>&lt;presence /&gt;</b> (actually user information), and <b>&lt;message /&gt;</b> .  In general, XMPP Core is quite a simple protocol, but I didn‚Äôt smile at all to botch standards and was busy with parsing XML, TLS, SASL and other details, and implementing everything from scratch, so I reopened Google and told him <i>xmpp lua</i> . <br><br>  The very first link led me to the <a href="">Verse</a> page - a lua-library built over <a href="http://code.stanziq.com/strophe/">Str &lt;&gt; phe</a> (again with a slope!), Which in turn is a C-library for working with XMPP.  Strophe takes all the low-level work: connection (with TLS support), authorization (SASL) and parsing XML, as well as processing core stans.  Verse offers a convenient way to support extensions (XEP = XMPP Extension Protocols, formerly known as JEP), the ability to register event handlers that are triggered at the time of the arrival of a certain form. <br><br>  My joy could not be described by any stanzas ... I quickly downloaded both libraries.  Collected Strophe, tried to collect Verse and broke off.  It turned out that to build Verse, you need to patch Strophe in a special way ... Popatchil, rebuilt, rebuilt ... Hooray, the example works! <br><br><h5>  Google, Google, I am Aleph!  Welcome, welcome! </h5><br><br>  I try to connect to Google: <br><br><pre> conn = verse.connect ("mister.aleph@gmail.com/epsilon3", password, handler, "talk.google.com");
</pre><br><br>  <b>mister.aleph@gmail.com/epsilon3</b> is my Jabber ID.  A strange suffix <b>/ epsilon3</b> identifies the resource.  This allows one mister.aleph@gmail.com to log in to Jabber from several different places. <br><br>  Run the script.  I get a fig.  It turns out that by default Strophe is going without TLS support, so you have to rebuild everything again.  The benefit is not written in C ++ with boost :: mpl, so I don‚Äôt even have time to drink tea during the build. <br><br>  Now everything is logged in, and I even see how I get stanza &lt;presence /&gt; from my contacts.  However, I am not interested in these stanzas, for I do not intend to make a full-fledged chat (I will probably do a defective, but later).  I am only interested in the stanzas described in the Gmail Notifications JEP. <br><br>  I register in Verse a new protocol with two events: <br><br><pre> local gmail = {xmlns = "google: mail: notify"};
 verse.protocols.gmail = gmail;

 gmail.events = {
   response = {
     {name = "iq";  type = "result";  xmlns = gmail.xmlns};
     mailbox = "/ iq / mailbox";
   };

   newmail = {
       {name = "iq";  type = "set"};

       id = "/ iq / @ id";
       newmail = "/ iq / new-mail";
   };
 }
</pre><br><br>  The <b>response</b> event will be triggered when the server sends me a stans response to my mailbox request.  In the <b>mailbox</b> node, threads will be described, with detailed information (senders, tags, the date of the last message).  In the event handler for this event, I will sort through these threads and display notifications about new mail using naughty and show the total counter of unread emails in the tray. <br><br>  The <b>newmail</b> event will be triggered when the server sends me a stanza-notification of changes in the mailbox.  In response to this stanza, I will send a stanza-request for information about the contents of the box. <br><br>  Actually the full code can be viewed <a href="http://mraleph.symlevel.com/files/habr/awesomegmail/gmail-notifier.lua.html">here</a> . <br><br>  By the way, in the description of Gmail Notifications JEP it is indicated that you can request not only unread messages, but generally make a completely arbitrary request, for example, ask all threads marked with #lua label ( <i>"label: #lua"</i> ). <br><br><h5>  The fairy tale has a quick effect, but it is not done quickly. </h5><br><br>  I run the script, get a couple of popups and a segmentation fault, as soon as luavm wanted to collect garbage.  It looks like Matthew Wild (by Verse), knowingly warns on the main page: <br><blockquote>  Please note that this is ALPHA status software.  It does have crasher bugs, which I am aware of ... </blockquote><br>  But not on those attacked, we Russian all crazy Luashniki everything on the shoulder.  I arm myself with a magic <a href="http://valgrind.org/">valgrind</a> , gdb, piece of paper, a twenty-sided dice, a rosary, a bottle of brandy left with a NG, and a brain ... After half an hour, the segmentation fault disappears and the memory almost stops flowing away in an unknown direction. <br><br><h5>  Registration </h5><br><br>  The designer, illustrator or artist of me is none, so I turned back to Google and found <a href="http://csi.nfshost.com/goodies/">on the site of Shris Ivarson a</a> set of multi-colored gmail-ovsky icons (red, blue, green, black, pink) in ICNS format.  I overtook these icons in PNG using the <a href="http://sourceforge.net/projects/icns/">icns2png</a> utility.  I took the text color <a href="http://customize.org/wallpapers/48503">from the wonderful Daft Punk wallpaper</a> . <br><br><h5>  Total </h5><br><br>  I shift the finished script along with the icons in ~ / .config / awesome / gmail and add its launch to rc.lua: <br><br><div style="text-align:center;"><img src="http://mraleph.symlevel.com/files/habr/awesomegmail/result.png"></div><br><br>  Victory! <br><br><h5>  Some trite conclusions </h5><br><ul><li>  The eyes are afraid, and the hands do; </li><li>  Lua - rulezz; </li><li>  Linux is habitable without a spacesuit; </li><li>  If you take an open-source library, be prepared to take a file; </li><li>  A dog is man's best friend.  Google is the best friend of the programmer. </li><li>  Open API - rulezz! </li></ul></div><p>Source: <a href="https://habr.com/ru/post/48370/">https://habr.com/ru/post/48370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../48360/index.html">Lovers of text quests. Constructor.</a></li>
<li><a href="../48361/index.html">Linux4one distribution for Acer Aspire One subnote released</a></li>
<li><a href="../48362/index.html">microSD with USB interface</a></li>
<li><a href="../48365/index.html">"Time makes things worse"</a></li>
<li><a href="../48367/index.html">Firefox overclocking with TmpFS</a></li>
<li><a href="../48371/index.html">Hybrid forms</a></li>
<li><a href="../48375/index.html">Set ... code. New kind of earnings.</a></li>
<li><a href="../48376/index.html">FreeBSD 7.1</a></li>
<li><a href="../48378/index.html">Development of an information portal for your own region</a></li>
<li><a href="../48381/index.html">The subtleties of the disable property of the form buttons sent to the server (How to make buttons inactive)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>