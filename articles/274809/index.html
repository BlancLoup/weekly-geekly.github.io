<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick work with JSON in Swift</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At first glance, working with the JSON format in Swift does not present any particular difficulties. On the one hand, the standard set contains the NS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick work with JSON in Swift</h1><div class="post__text post__text-html js-mediator-article">  At first glance, working with the JSON format in Swift does not present any particular difficulties. On the one hand, the standard set contains the NSJSONSerialization class that can parse files, on the other hand, many third-party libraries promise to make this process easier, and the code is clearer.  As part of this article, I would like to consider how to read JSON files faster and why obvious approaches are slow. <br><a name="habracut"></a><br>  And so, at first it is worth formulating the problem to be solved: there is some fairly voluminous JSON (about 30 megabytes) of the following structure: <br><br>  data -&gt; [Node] -&gt; [Item] -&gt; id: String, pos: [Int], coo: [Double] <br><br>  You need to parse and get an array of objects of the Item type with the string id field, respectively, the pos field is an integer array, and the coo field is an array of floating-point numbers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Option one - use a third-party library:</b> <br><br>  I must say that all the solutions that came to me used the standard NSJSONSerialization as a parser, and their task was seen solely in adding ‚Äúsyntactic sugar‚Äù and more strict typing.  As an example, take one of the most popular SwiftyJSON: <br><br><pre><code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> json = JSON(data: data) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> nodes = json[<span class="hljs-string"><span class="hljs-string">"data"</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">array</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> node <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nodes { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> items = node.<span class="hljs-built_in"><span class="hljs-built_in">array</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> id = item[<span class="hljs-string"><span class="hljs-string">"id"</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> pos = item[<span class="hljs-string"><span class="hljs-string">"pos"</span></span>].arrayObject as? [<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> coo = item[<span class="hljs-string"><span class="hljs-string">"coo"</span></span>].arrayObject as? [Double] { Item(id: id, pos: pos, coo: coo) } } } } }</code> </pre> <br>  On iPhone 6, the execution of this code took about 7.5 seconds, which is inadmissible for a fairly quick device. <br>  For further comparison, we will consider this time as a reference. <br>  Now let's try to write the same thing without using SwiftyJSON. <br><br>  <b>Option two - use the ‚Äúclean‚Äù swift:</b> <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> json = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>! NSJSONSerialization.JSONObjectWithData(data, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: NSJSONReadingOptions()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> nodes = (json <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? [<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>: AnyObject])?[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? [[[<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>: AnyObject]]] { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> node <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nodes { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> node { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> id = item[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> pos = item[<span class="hljs-string"><span class="hljs-string">"pos"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? [Int], <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> coo = item[<span class="hljs-string"><span class="hljs-string">"coo"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? [Double] { Item(id: id, <span class="hljs-attr"><span class="hljs-attr">pos</span></span>: pos, <span class="hljs-attr"><span class="hljs-attr">coo</span></span>: coo) } } } }</code> </pre><br>  Our "bicycle" managed in 6 seconds (80% of the original), but still very long. <br><br>  Let's try to figure it out, the profiler suggests that the line: <br><br><pre> <code class="hljs lua">let nodes = (json as? [String: AnyObject])?[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] as? <span class="hljs-string"><span class="hljs-string">[[[String: AnyObject]]</span></span>]</code> </pre><br>  runs unexpectedly long. <br><br>  The behavior of the NSJSONSerialization class in Swift is completely analogous to its behavior in Objective C, which means the result of parsing will be a certain hierarchy consisting of objects of the type NSDictionary, NSArray, NSNumber, NSString and NSNull.  This command converts the objects of these classes into the structures of Swift Array and Dictionary, which means it copies the data!  (Arrays in Swift are more similar to arrays in C ++ than in Objective C) <br><br>  To avoid such copying, we try not to use Swift'a beautiful typed arrays. <br><br>  <b>Option three - without using Array and Dictionary:</b> <br><br><pre> <code class="hljs markdown">let json = try! NSJSONSerialization.JSONObjectWithData(data, options: NSJSONReadingOptions()) if let nodes = (json as? NSDictionary)?[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] as? NSArray { for node in nodes { if let node = node as? NSArray { for item in node { if let item = item as? NSDictionary, let id = item[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] as? NSString, let pos = item[<span class="hljs-string"><span class="hljs-string">"pos"</span></span>] as? NSArray, let coo = item[<span class="hljs-string"><span class="hljs-string">"coo"</span></span>] as? NSArray { var <span class="hljs-emphasis"><span class="hljs-emphasis">_pos = [Int](count: pos.count, repeatedValue: 0) var _</span></span>coo = [<span class="hljs-string"><span class="hljs-string">Double</span></span>](<span class="hljs-link"><span class="hljs-link">count: coo.count, repeatedValue: 0</span></span>) for var i = 0; i <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pos.count</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++ { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">let</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">pos[i]</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span></span><span class="xml"><span class="hljs-tag">? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NSNumber</span></span></span></span><span class="xml"><span class="hljs-tag"> { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_pos.append</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p.integerValue</span></span></span></span><span class="xml"><span class="hljs-tag">) } } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">coo.count</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++ { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">let</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">coo[i]</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span></span><span class="xml"><span class="hljs-tag">? </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NSNumber</span></span></span></span><span class="xml"><span class="hljs-tag"> { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_coo.append</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c.doubleValue</span></span></span></span><span class="xml"><span class="hljs-tag">) } } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Item</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pos:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_pos</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">coo:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">_coo</span></span></span></span><span class="xml"><span class="hljs-tag">) } } } } }</span></span></span></span></code> </pre><br>  It looks awful, of course.  But we are primarily interested in the speed of work: 2 seconds (almost 4 times faster than SwiftyJSON!) <br><br>  Thus, eliminating implicit conversions can achieve a significant increase in speed. <br></div><p>Source: <a href="https://habr.com/ru/post/274809/">https://habr.com/ru/post/274809/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274799/index.html">Parsing in Prolog</a></li>
<li><a href="../274801/index.html">Custom rounded view</a></li>
<li><a href="../274803/index.html">Using Matalysis in computer games (part 2)</a></li>
<li><a href="../274805/index.html">On the issue of timers in RTOS (Conclusions)</a></li>
<li><a href="../274807/index.html">High Speed ‚Äã‚ÄãFile Transfer Protocol - Aspera FASP</a></li>
<li><a href="../274811/index.html">Java and time: part one</a></li>
<li><a href="../274813/index.html">Shaders in libgdx for dummies</a></li>
<li><a href="../274815/index.html">Servo browser engine architecture</a></li>
<li><a href="../274819/index.html">All you need to know about the growing popularity of Malvertising</a></li>
<li><a href="../274821/index.html">How to predict a stock price: An adaptive filtering algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>