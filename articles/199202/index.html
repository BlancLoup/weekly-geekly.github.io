<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cooking NSA SELinux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! With this post, I want to divert the respected community from the NSA on the topic a little bit, and instead fill in the gap in the descripti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cooking NSA SELinux</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cfa/80e/805/cfa80e80563336b6fec88c41a29c85ca.png" alt="NSA logo" align="left">  Hi Habr!  With this post, I want to divert the respected community from the NSA on the topic a little bit, and instead fill in the gap in the description of one of their technologies, writing something between ‚Äúturn off SELinux‚Äù and ‚Äúdevote the best years to it to understand a small part‚Äù.  In fact, both of these points of view are equally far from the truth - the technology is quite simple, transparent and allows you to do a lot.  However, I want to warn about the huge number of letters, and rather narrow target audience, because  The following will be interesting not for everyone.  If you have long wanted to understand what SELinux is, but did not know which side to go for - this article is for you.  If you know all this for a long time and successfully apply it, then I made enough inaccuracies so that we could discuss it in the comments.  Well, world-class information security experts can boldly go to the very end and start playing, I have plans to continue :-) <br>  I will not deal in this article with topics related to the NSA as a whole, the ability to decipher RSA, wiretapping and other media aspects - no hype, no FUD, only technology.  We will, with varying degrees of activity, climb into different sources, add our own conditions to the very heart of the MLS, possibly introducing our vulnerabilities (we also make mistakes), and after that <s>we will try to take off and</s> carry out tests.  In other words, I describe what and how, and after that you no longer look at SELinux as an unknown animal and the abode of evil from a potential enemy, but boldly begin to use this technology for good.  Especially considering that it is already included in all of your androids (&gt; 4.3) and many distributions. <br>  So, if you are still interested, and you are not afraid to spend a week in one of the many spoilers, then <a name="habracut"></a><h4>  Preliminary readings </h4>  I mean that you already have enough experience with Linux to deploy your favorite distribution in a virtual environment.  I will do everything with the example of Debian, but if you decide to repeat this path, then all this can be (and very much needed) done on the most convenient and familiar distribution kit - in the process you will learn a lot about it.  I tried to write this article as a teaching material so that anyone could repeat it step by step.  I also mean that it will not be difficult for you to read technical documentation in English - information on SELinux in Russian is so far extremely scarce. <br><br><h5>  General technology information </h5>  There are so many rumors around SELinux that you will be surprised how small the introductory volume is, just three links: <ol><li>  <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security-Enhanced_Linux/">RH Guide</a> : if any command is incomprehensible, you will most likely find a description in it.  Open it in a separate tab, useful. </li><li>  <a href="http://billauer.co.il/selinux-policy-module-howto.html">Summary of the</a> lecture by Eli Billauer: consider it as the main collection of facts.  On it you can quickly understand what's what, and know what to ask Google. </li><li>  <a href="http://www.lurking-grue.org/writingselinuxpolicyHOWTO.html">Writing a politician</a> .  Despite the document‚Äôs ten years ago, it describes enough key points to understand the internal structure of SELinux, and how to pick it. </li></ol><br>  This is the main thing that I recommend reading <i>before</i> setting up, otherwise you will constantly return to these documents.  There are <a href="http://www.nsa.gov/research/selinux/">many</a> <a href="http://selinuxproject.org/">other</a> <a href="https://wiki.gentoo.org/wiki/Project:SELinux">resources</a> , but you will definitely get to them if you want to do something different from turning on / off boolean variables. <br><br>  So, when you read all this, we can check ourselves with simple questions: <ol><li>  What is unconfined_t / unconfined_u, and why SELinux cannot be tested on it? </li><li>  What is a special case, MLS or MCS? </li><li>  What is the difference between * .te and * .if and * .fc? </li></ol><div class="spoiler">  <b class="spoiler_title">Answers</b> <div class="spoiler_text"><ol><li>  Unlimited domain / user.  With the same success, you can configure SELinux on another machine. </li><li>  MCS.  MLS == MCS with MLS_SENS = 1. </li><li>  Basically - nothing.  Although in txt write, do not forget to fix the main Makefile. </li></ol></div></div><br><h4>  Task setting and pre-setting </h4>  Now that we already know what we want, but don‚Äôt know how we will implement it, we can formulate the objectives of the experiment: <ul><li>  We want to set up SELinux MLS (since they took it, let's get to the maximum, and not ready from the repository <s>next-&gt; next-&gt; agree</s> ); </li><li>  We want to take <a href="http://oss.tresys.com/projects/refpolicy/">RefPolicy as a basis</a> ; </li><li>  Well, after that we want to check the worst case scenario - we were broken, and not just broken, but received UID = 0, and not just received, but with constant shell access, and we forgot to root user_u and remap.  I intentionally make a number of similar assumptions, we will consider the worst-case scenario; </li><li>  We will set up the minimum required copy, otherwise it will not be an article, but a saga about five hundred pages; </li></ul><h5>  Server </h5>  With your permission, I will remove it under the spoiler.  YMMV, you may not be Debian, and the installation in KVM is no different.  Any distribution kit installed in the minimum configuration in a virtual environment will do.  Virtual - because it is more convenient, minimal - because it is faster. <div class="spoiler">  <b class="spoiler_title">Details</b> <div class="spoiler_text">  A typical Debian expert install, small details: <ul><li>  Disk layout (as many as 4GB!): <ul><li>  / dev / vda1 64MB as / boot, ext2. </li><li>  rest as LUKS: aes256: cbc-essiv: passphrase, all settings as default as possible. </li><li>  inside the remainder - all under LVM. </li></ul></li><li>  Here at once fstab <pre><code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># cat /etc/fstab # /etc/fstab: static file system information. # &lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt; /dev/vda1 /boot ext2 defaults 0 2 /dev/mapper/vg0-root / btrfs defaults 0 1 /dev/mapper/vg0-usr /usr btrfs defaults 0 2 /dev/mapper/vg0-var /var btrfs defaults 0 2 /dev/mapper/vg0-tmp /tmp btrfs defaults 0 2 /dev/mapper/vg0-rhome /root btrfs defaults 0 2 /dev/mapper/vg0-swap none swap sw 0 0</span></span></code> </pre> </li><li>  Separate sections rendered for further convenience testing. </li><li>  We put a minimal system with an SSH server, nothing else. </li><li>  Before completing the installation, we immediately call the shell, and remember the system key: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># ssh-keygen -l -f /etc/ssh/ssh_host_ecdsa_key 256 f6:9b:ad:dd:93:cb:3d:c2:83:76:45:c3:02:e8:6a:1d root@sandbox (ECDSA)</span></span></code> </pre></li></ul>  After installation, we go via ssh, and bring the system to the base version for our experiments, in my case it was like this: <pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/wheezy/jessie/g'</span></span> /etc/apt/sources.list <span class="hljs-comment"><span class="hljs-comment"># that's no bloody enterprise aptitude update &amp;&amp; aptitude dist-upgrade -VR # let's go testing, it's stable enough aptitude install vim bash-completion deborphan -VR # a little comfort couldn't hurt aptitude install policycoreutils auditd setools selinux-basics -VR # last is just helper scripts, optional vim /etc/network/interfaces # make interfaces static aptitude purge isc-dhcp-client console-setup console-setup-linux kbd iproute module-init-tools $(deborphan)</span></span></code> </pre>  Create keys for ssh, register them on the server for root: <pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>$ ssh-keygen -b 521 -t ecdsa -f selinux-test @remote<span class="hljs-comment"><span class="hljs-comment"># mkdir /root/.ssh &amp;&amp; cat selinux-test.pub &gt; /root/.ssh/authorized_keys2 &amp;&amp; chown &amp;&amp; chmod</span></span></code> </pre>  Well, by the end of the day, we assemble and install our core - we want support for the latest version of the policy, the minimum required set of modules, experiment with the PaX and GRSecurity patches (which, by the way, get on well with SELinux, but I‚Äôll probably describe this later).  In general, the vanilla kernel is best suited for us at the current stage.  Yes, I can hear you a voice from the audience talking about the Debian way - but today the samurai‚Äôs way is not limited to such a framework.  In this experiment, we still have UID = 0 without restrictions, and we are doing everything we want.  So, let's heat up a little Arizona (or local virtual machine): <pre> <code class="bash hljs">mkdir src &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> src &amp;&amp; wget -c http://kernel.org/pub/linux/kernel/v3.0/linux-3.10.18.tar.bz2 &amp;&amp; tar jxf linux*tar.bz2 &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux* &amp;&amp; make menuconfig &amp;&amp; make -j$((2* $(grep processor /proc/cpuinfo | wc -l))) deb-pkg &amp;&amp; make clean</code> </pre>  At the configuration stage, we <b>enable SELinux</b> (yes, this pun is intended!): <img src="https://habrastorage.org/getpro/habr/post_images/805/546/6c2/8055466c2f7ad7696341b7ad95e6d541.png" alt="selinux kernel opts, sorry for imageshack, habrastorage is not ok with my id"><div class="spoiler">  <b class="spoiler_title">.config</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># if you are lazy to configure yourself, here's my .config, usable on KVM+libvirt wget -O - $aboveimage | dd bs=1 skip=3991 | xzcat</span></span></code> </pre></div></div></div></div>  We believe that the basis for the experiments is ready. <br><h5>  Automating policy assembly </h5>  It was more convenient for me to build policies on a local machine and, in the form of a deb package, already installed on the server.  Therefore, I took the path of least resistance. <div class="spoiler">  <b class="spoiler_title">up'n'enter style</b> <div class="spoiler_text"><pre> <code class="bash hljs">wget http://oss.tresys.com/files/refpolicy/refpolicy-2.20130424.tar.bz2 tar jxf refpolicy-2.20130424.tar.bz2 cp -rp refpolicy custom <span class="hljs-comment"><span class="hljs-comment">#all our modifications asroot# mkdir /usr/share/selinux/custom # so we can 'make install' here asroot# mkdir /etc/selinux/custom asroot# chown $USER:$USER /etc/selinux/custom /usr/share/selinux/custom asroot# touch /etc/selinux/custom/setrans.conf &amp;&amp; chown $USER:$USER /etc/selinux/custom/setrans.conf # we'll need it later asroot# aptitude install selinux-utils python-selinux policycoreutils checkpolicy # these are for policy build</span></span></code> </pre>  Next, the package build script: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # sample deb build for custom selinux policy # harvests policy from local system version='0.0.1' name='selinux-policy-custom' description='Custom MLS SELinux policy' cf="${name}-control" cc="${name}-Copyright" # depends and conflicts shamessly ripped from selinux-policy-mls read -d '' cheader &lt;&lt; EOF Section: non-free Priority: optional Homepage: http://selinux/ Standards-Version: 3.9.2 Package: ${name} Version: ${version} Maintainer: secadm_r &lt;here.can+be@your.email&gt; Pre-Depends: Depends: policycoreutils (&gt;= 2.1.0), libpam-modules (&gt;= 0.77-0.se5), python, libselinux1 (&gt;= 2.0.35), libsepol1 (&gt;= 2.1.0) Conflicts: cron (&lt;= 3.0pl1-87.2sel), fcron (&lt;= 2.9.3-3), logrotate (&lt;= 3.7.1-1), procps (&lt;= 1:3.1.15-1), selinux-policy-refpolicy-strict, selinux-policy-refpolicy-targeted, sysvinit (&lt;= 2.86.ds1-1.se1) Architecture: all Copyright: ./selinux-policy-custom-Copyright Description: ${description} EOF read -d '' postinst &lt;&lt; "EOF" File: postinst 755 #!/bin/sh -e set -e if [ "$1" = configure ]; then /usr/sbin/semodule -s custom -b /usr/share/selinux/custom/base.pp $(find /usr/share/selinux/custom/ -type f ! -name base.pp | xargs -r -n1 echo -n " -i") fi #DEBHELPER# exit 0 EOF function make_policy() { cd custom make clean rm -rf /usr/share/selinux/custom/* make install cd .. } function make_files() { echo 'SELinux custom policy copyright:TODO' &gt; ${cc} echo -e "$cheader" &gt; ${cf} echo -e "$postinst" &gt;&gt; ${cf} echo -en "\nFiles: " &gt;&gt; ${cf} # our setrans file echo -e " /etc/selinux/custom/setrans.conf /etc/selinux/custom" &gt;&gt; ${cf} # /etc/selinux dir find /etc/selinux/custom -type f ! -name \*LOCK | xargs -r -n1 -If -- sh -c 'echo " f $(dirname f)"' &gt;&gt; ${cf} # /usr/share/selinux/custom dir find /usr/share/selinux/custom -type f | xargs -r -n1 -If -- sh -c 'echo " f $(dirname f)"' &gt;&gt; ${cf} } function cleanup() { rm -f ${cc} ${cf} } function build_deb() { equivs-build ${cf} [ $? -eq 0 ] &amp;&amp; cleanup } rm ./${name}*deb # glob is ok make_policy make_files build_deb scp -P 22 -i ~/.ssh/selinux-test selinux*deb root@selinux:/tmp/</span></span></code> </pre>  The complete reassembly time turned out to be ~ 30 seconds, so the general principle of the script is chosen - ‚Äúhead-on,‚Äù which is called, I think, to adapt for assembling rpm work will not be: <ul><li>  Make all </li><li>  We collect and set policies (make install) </li><li>  We find everything that is established (we know where to look), we collect the package </li><li>  Fill the server in / tmp </li><li>  In postinst, he himself will find what he has updated, pull semodule and reload policies </li></ul></div></div><br><h4>  SELinux, the first acquaintance. </h4>  The server is ready, the build system is ready, the reference policy is loaded, <i>now</i> you can get down to the most interesting.  (Approximately at this stage, assessing the already existing volume of the article, a seditious thought crept in to divide it by <s>2</s> 5 :-). <br>  For the first build, we define the parameters, I chose these: <pre> <code class="bash hljs">$ sed <span class="hljs-string"><span class="hljs-string">'/^#/d;/^$/d'</span></span> build.conf TYPE = mls NAME = custom DISTRO = debian UNK_PERMS = reject DIRECT_INITRC = n MONOLITHIC = n UBAC = y CUSTOM_BUILDOPT = MLS_SENS = 4 MLS_CATS = 32 MCS_CATS = 32 QUIET = n</code> </pre>  The differences from upstream are minimal: MLS is enabled (this means that all the parameters from policy / mls and config / appconfig-mls will be included during the build);  included distro-specific debian macros, which is not really necessary;  the policy will not load if permissions that are not reflected in the policy are defined in the kernel ‚Äî what if we have a much newer kernel;  Well, I have significantly reduced the number of levels and categories - we will have only 4 levels of secrecy, each with 32 categories.  For now, that's enough for us. <div class="spoiler">  <b class="spoiler_title">essence numbered uno</b> <div class="spoiler_text">  As an experiment, try setting MONOLITHIC = y and building a policy without setting it - make policy.  The result will be policy.conf, a textual representation of the policy.  That's just here, in a simple form, courtesy of the unfolded m4 of all the clutter of macros, described everything that SELinux will allow.  In other words (Warning: bad analogy time!): If secadm_r is like a SAT chief approving access levels and tolerances, then SELinux is an ordinary security officer who checks these lists, and in policy.conf, in fact, lists with fields: <br>  1. who (scontext) - where (tcontext) - to whom (class) - why (call) (plus, in the case of MLS: show your tolerance level as well, and if it is less than expected, I will not even look at the rules .) </div></div><br>  We create all the necessary configs, which we will edit to fit our needs: <b>make conf</b> .  At first, we‚Äôre correcting the <i>policy / modules.conf</i> that appeared - I turned off (modulename = off) almost all modules in the contrib group.  Plus - faster assembly, fewer modules.  Minus - the possible underdefinition of contexts.  Let me explain with an example: <ul><li>  The context of / dev / xconsole, although related more to logging, is defined in the xserver module; </li><li>  Disabling it, the context was inherited from the / dev / directory; </li><li>  And most likely, everything that I wanted to write in / dev / xconsole, and was taken into account in RefPolicy, immediately broke.  To correct - at your choice: either we include the xserver module, or we redefine the context in any of our local modules. </li></ul><div class="spoiler">  <b class="spoiler_title">contrib_off</b> <div class="spoiler_text"><pre> <code class="bash hljs">grep -A5 contrib policy/modules.conf | grep <span class="hljs-string"><span class="hljs-string">"= module$"</span></span> | wc -l <span class="hljs-comment"><span class="hljs-comment"># total number grep -A5 contrib policy/modules.conf | grep "= module$" | sed 's/ = module//' | xargs -r -n1 -I__n -- sh -c 'sed -i "s/^__n = module$/__n = off/" policy/modules.conf' # kekeke # turn some servicess off too (xserver + postgresql) # turn _on_ logrotate,mta,postfix,ulogd, and whatever you think you need</span></span></code> </pre></div></div>  As soon as we started to edit <i>modules.conf</i> , we passed the point of no return, after which we should <i>understand</i> what we are doing and why.  Possible underdetermining of contexts is just the first example of how our actions affect the system. <br>  Looking ahead, I‚Äôll immediately say a little about the wonderful <i>audit2allow</i> utility: it eats audit.log, and in a fairly clear form (especially with the -Rev keys) gives us what we need to add in the policy so that these messages no longer appear in the log. So, if you are somewhere (and this is almost everywhere) on the Internet, you will find a recommendation <pre> <code class="bash hljs">grep something-something /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/audit/audit.log | audit2allow -M mymegamodule semodule -i mymegamodule</code> </pre>  then follow it only if you are aware of what you are doing now - this set of commands means that SELinux will resolve <b>everything</b> that (potentially greedy) something-something has asked for access, and even a little more.  Moreover, in the case of MLS, this method does not work at all - because in MLS it is not enough to create an allow rule, it is necessary that the access satisfies all the restrictions imposed on tolerances and categories.  Such actions are equivalent to frank confession: ‚ÄúYes, today I don‚Äôt want to think at all with my head, it‚Äôs easier for me to allow everything.‚Äù  Do not make a <a href="http://en.wikipedia.org/wiki/Security_theater">theater</a> out of your system, and do not tune SELinux in this way - it‚Äôs like catching all the packages on a firewall and turning them into permissive rules with a script. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now it's time to run <b>make install</b> , and if everything is fine, then build our package and put it on the server: <pre> <code class="bash hljs">dpkg -i /tmp/selinux-policy-custom*deb sed -i <span class="hljs-string"><span class="hljs-string">'s/^SELINUX=.*$/SELINUX=enforcing/;s/^SELINUXTYPE=.*$/SELINUXTYPE=custom/'</span></span> /etc/selinux/config selinux-activate <span class="hljs-comment"><span class="hljs-comment"># if you installed helper package selinux-basics # if not: touch /.autorelabel # add 'selinux=1 security=selinux' to cmdline reboot # let's rock!</span></span></code> </pre>  The system will reboot, apply contexts as defined in the established policy ( <i>/ etc / selinux / custom / contexts / files / *</i> ), reboot again and kindly offer to go. <br><br><h4>  When is rocking "rocking" and when is it "shaking" * </h4>  Chef, it's all gone.  Nothing works.  We can't even log in via ssh - connection closed by host.  Meet SELinux.  As Eli Billauer remarkably articulated: <blockquote>  What is SELinux? <br>  In a nutshell: denied. </blockquote>  Nevertheless, it is good if you have reached this point.  This is exactly the behavior that we need, and now we will begin to understand <i>why</i> we are not allowed to. <div class="spoiler">  <b class="spoiler_title">the essence of numerically duo, this time without bad analogies</b> <div class="spoiler_text">  If you carefully read the preliminary documentation, you will surely remember the decision-making procedure: <ol><li>  First DAC.  If it is forbidden, then it will not even get to SELinux, permission denied will be the usual, unix, familiar to all of us at times when we just got acquainted with our first * nix system. </li><li>  Then MAC.  If no matching rules are found, permission denied will already be from SELinux.  In some distributions (RH), lines containing " <i>SELinux is preventing</i> " will appear in the logs, some will not, but there will be something in all in audit.log. </li></ol>  Total, most likely in RefPolicy there is simply no something that is in the distribution policy.  Let's find it and add it. </div></div>  Oh yeah, I forgot to say that from now on, you will need access to the server not only via ssh, it may not work.  Fortunately, in our case it is a virtual server, there is always VNC / <a href="http://en.wikipedia.org/wiki/SPICE_%2528protocol%2529">SPICE</a> / etc (link special for FSKN).  We try to enter locally - it does not allow.  Excellent situation to immediately illustrate how from it <div class="spoiler">  <b class="spoiler_title">go out</b> <div class="spoiler_text"><ol><li>  Don't panic. </li><li>  Reboot - for example, by sending Ctrl + Alt + Del, acpid will do everything for us. </li><li>  We catch grub at the boot stage, change selinux = 1 to selinux = 0 </li><li>  Log in, log in as root. </li></ol></div></div>  At this stage, audit.log contains all the reasons for <s>our failures</s> , why we could not enter.  Since  Now we have booted with disabled SELinux, the first thing that makes sense is to copy audit.log from the last download for further analysis, because with SELinux enabled, we simply cannot do it. <pre> <code class="bash hljs">cp /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/audit/audit.log /root wc -l /root/audit.log 195</code> </pre>  The scale of the disaster is small, two hundred lines.  It is time to slowly descend from the mountain: <ul><li><div class="spoiler">  <b class="spoiler_title">How to read logs</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=DAEMON_START msg=audit(1383338997.597:1957): auditd start, ver=2.3.2 format=raw kernel=3.10.17-vm-slnx auid=4294967295 pid =1319 subj=system_u:system_r:auditd_t:s3:c0.c31 res=success</code> </pre>  The first line tells us that auditd successfully (res) started, and on behalf of system_u, the role system_r, in the auditd_t domain, and applies to all categories (c0.c31) of our maximum level (s3).  According to <a href="http://en.wikipedia.org/wiki/Bell%25E2%2580%2593LaPadula_model">BLP</a> , this means that information from any level can successfully fall into the clutches of auditd (write up), and it can read from any level (read down).  If it is not completely clear, then let us remember <a href="http://www.nsa.gov/">who</a> this architecture was designed for and what they meant by recording information - transferring information from the source (who writes) to the recipient (where / to whom it writes).  And then everything falls into place - the Top Secret level really cannot write its data to the Secret level (ie, down, down) - they will become compromised, hence " <b>no write down</b> ".  About the " <b>read up</b> " hopefully more obvious.  Also in the MLS there are additional restrictions, but <s>I was asked to remain silent</s> about this further. <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=SYSCALL msg=audit(1383338997.620:219): arch=40000003 syscall=102 success=no <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>=-13 a0=3 a1=afbe1c10 a2=a779b000 a3=ffffffc8 items=0 ppid=1338 pid=1346 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 ses=4294967295 tty=(none) comm=<span class="hljs-string"><span class="hljs-string">"acpid"</span></span> exe=<span class="hljs-string"><span class="hljs-string">"/usr/sbin/acpid"</span></span> subj=system_u:system_r:initrc_t:s0-s3:c0.c31 key=(null)</code> </pre>  The second line tells us that the acpid daemon, with all possible maximum regalia (uid = 0 gid = 0 euid = 0 suid = 0 fsuid = 0 egid = 0 sgid = 0 fsgid = 0), root root and bofh sysop using the context initrc_t (started) addressed (type = SYSCALL) to the socket (syscall = 102), and ( <i>suddenly</i> ) was not recognized, not called, and, as a result, sent (success = no exit = -13).  Although, this should not be surprising, because we all know that root is not the most important in Linux, there are more important :-) <br>  Riddle for inquiring minds - which socket did he turn to? * <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=AVC msg=audit(1383338997.810:233): avc: denied { search } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pid=1470 comm=<span class="hljs-string"><span class="hljs-string">"restorecond"</span></span> name=<span class="hljs-string"><span class="hljs-string">"/"</span></span> dev=<span class="hljs-string"><span class="hljs-string">"tmpfs"</span></span> ino=376 scontext=system_u:system_r:restorecond_t:s0-s3:c0.c31 tcontext=system_u:object_r:var_run_t:s3:c0.c31 tclass=dir</code> </pre>  Well, take the third line from the middle.  Logs AVC (Access Vector Cache) is for us the most interesting.  The above, for example, says that the established policy does not have a permission rule for the source (scontext) with the above tolerance, working in the restorecond_t domain, to perform a search ({search} and tclass = dir) in the directory with the number inode = 376 with context var_run_t.  An illustration of what?  Right, no read up.  What are you looking for?  <b>Find / var / run -inum 376</b> will answer this question.  Just from a similar line, audit2allow will make a resolving rule. <br><br>  And so on.  As you can see, there is nothing difficult in these logs.  SELinux is not difficult <i>qualitatively</i> , it is difficult <i>quantitatively</i> , and at first it is unusual, but no more.  Again, if something is not clear, you can always drive an impersonal line into Google or search <a href="http://selinuxproject.org/page/Main_Page">here</a> . So, we believe that we now know how to read and understand logs. <br><br>  * I will not give a hint, write in the comments. </div></div></li><li><div class="spoiler">  <b class="spoiler_title">How to fix</b> <div class="spoiler_text">  There are two main options you may encounter: <ul><li>  Invalid context </li><li>  No allow rule </li></ul>  They cover 90% of all cases of permission denied, and audit2allow works fine in them.  In many cases, the choice of <i>how to</i> correct, the first option or the second, is yours. <br>  The third option, which is rarely seen but the most unobvious, is a violation of MLS restrictions (policy constraint violation), and adding a permitting rule in this case will not help, you will have to go to the very heart of the MLS and edit the restrictions.  Here every change should be made with full understanding of <i>why</i> it is being done and <i>what exactly</i> it should solve.  Thoughtless changes are guaranteed to reduce your security level.  You have been warned (again). <br>  Now the canvases are about the solution methods, rolled up in a tackle due to the size: <ul><li><div class="spoiler">  <b class="spoiler_title">solution for invalid context</b> <div class="spoiler_text">  Example of invalid context: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># ls -laZ /lib/systemd/systemd-udevd -rwxr-xr-x. 1 root root system_u:object_r:bin_t:s0 210380 Sep 23 12:24 /lib/systemd/systemd-udevd @local$ grep systemd-udevd custom/policy/ -R custom/policy/modules/system/udev.fc:/usr/lib/systemd/systemd-udevd -- gen_context(system_u:object_r:udev_exec_t,s0)</span></span></code> </pre>  In debian / lib, in RefPolicy / usr / lib.  Rule: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># semanage fcontext -m -t udev_exec_t /lib/systemd/systemd-udevd # try to modify /usr/sbin/semanage: File context for /lib/systemd/systemd-udevd is not defined root@sandbox:~# semanage fcontext -a -t udev_exec_t /lib/systemd/systemd-udevd # ok, add root@sandbox:~# grep udev /etc/selinux/custom/contexts/files/file_contexts.local /lib/systemd/systemd-udevd system_u:object_r:udev_exec_t:s0</span></span></code> </pre>  <b>semanage</b> is one way.  Such a change is advisable, but in our case it may not survive the policy update (if we start shipping our <i>/etc/selinux/custom/contexts/files/file_contexts.local</i> ).  Another option is to redefine locally, reassemble the policy, roll in (and at the same time set the policy). </div></div></li><li><div class="spoiler">  <b class="spoiler_title">solution for the absence of an allow rule</b> <div class="spoiler_text">  Let's take this line, for example: <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=AVC msg=audit(1383338997.860:251): avc: denied { module_request } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pid=1524 comm=<span class="hljs-string"><span class="hljs-string">"sshd"</span></span> kmod=<span class="hljs-string"><span class="hljs-string">"net-pf-10"</span></span> scontext=system_u:system_r:sshd_t:s0-s3:c0.c31 tcontext=system_u:system_r:kernel_t:s3:c0.c31 tclass=system</code> </pre>  Deciphering the log is simple, but the constant occupation of this over time tires.  Throw it in the log, and let the machine work for us: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># audit2allow -Rev -i /root/log require { type kernel_t; type sshd_t; class system module_request; } #============= sshd_t ============== # audit(1383338997.860:251): # scontext="system_u:system_r:sshd_t:s0-s3:c0.c31" tcontext="system_u:system_r:kernel_t:s3:c0.c31" # class="system" perms="module_request" # comm="sshd" exe="" path="" # message="type=AVC msg=audit(1383338997.860:251): avc: denied { # module_request } for pid=1524 comm="sshd" kmod="net-pf-10" # scontext=system_u:system_r:sshd_t:s0-s3:c0.c31 # tcontext=system_u:system_r:kernel_t:s3:c0.c31 tclass=system " allow sshd_t kernel_t:system module_request;</span></span></code> </pre>  And here already, we start to think - we ask ourselves simple questions: <ul><li>  What's happening?  sshd asked to load the module into the kernel.  Ok, net-pf-10 is not much needed, because  ipv6 we have not. </li><li>  What have we been offered?  Allow the sshd_t domain to load modules into the kernel.  Of course, if we resolve, there will be no such error.  And if he asks for an enemy module? </li><li>  What do they write on the Internet?  <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D669047">Hehe</a> .  Thank you, but no, we don‚Äôt need the presence of a Boolean variable to resolve this functionality either. </li><li>  What are we doing?  Yes, we prohibit sshd to beg in this direction, let him work on what was given.  When we need ipv6, we will load it ourselves, even before ssh starts. </li></ul>  We solve it by writing our own mini-module, it's simple.  We read the <a href="http://selinuxproject.org/page/NB_RefPolicy">description of the</a> structure.  At the same time we create a framework for all our modules (locally): <pre> <code class="bash hljs">mkdir policy/modules/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> policy/modules/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;summary&gt;Local layer -- differences from reference policy.&lt;/summary&gt;'</span></span> &gt; metadata.xml <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'## &lt;summary&gt;sshd local policy&lt;/summary&gt;'</span></span> &gt; sshd_local.if <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'## no file contexts redefined here'</span></span> &gt; sshd_local.fc cat &gt; sshd_local.te &lt;&lt;EOF &gt; policy_module(sshd_local, 0.0.1) &gt; <span class="hljs-comment"><span class="hljs-comment">################################################################## &gt; require { &gt; type kernel_t; &gt; type sshd_t; &gt; class system module_request; &gt; } &gt; #============= sshd_t ============== &gt; # dont audit requests for module load &gt; # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">NOTE:</span></span></span><span class="hljs-comment"> this may hide some denials in the future &gt; dontaudit sshd_t kernel_t:system module_request; &gt; &gt; EOF</span></span></code> </pre>  As you can see, we changed the rule to <b>dontaudit sshd_t kernel_t: system module_request;</b>  - it means to prohibit, and not to write to the log.  By the way, if you come across the fact that any functionality does not work, and the log is empty, then most likely this is just a dontaudit rule.  Just reassemble the policy without them: <b>semodule -DB</b> , and get ready for the message flow to the log. <br>  We specify our module in modules.conf, we collect policy, we fill in on the server, we look: <pre> <code class="bash hljs">root@sandbox:/tmp<span class="hljs-comment"><span class="hljs-comment"># sesearch --allow -s sshd_t -t kernel_t | grep system root@sandbox:/tmp# sesearch --dontaudit -s sshd_t -t kernel_t | grep system root@sandbox:/tmp# dpkg -i selinux-policy-custom_0.0.1_all.deb (Reading database ... 20371 files and directories currently installed.) Preparing to replace selinux-policy-custom 0.0.1 (using selinux-policy-custom_0.0.1_all.deb) ... Unpacking replacement selinux-policy-custom ... Setting up selinux-policy-custom (0.0.1) ... root@sandbox:/tmp# sesearch --dontaudit -s sshd_t -t kernel_t | grep system dontaudit sshd_t kernel_t : system module_request ; root@sandbox:/tmp# semodule -l | grep sshd_local sshd_local 0.0.1</span></span></code> </pre>  The rule has appeared, the module is loaded.  Complicated?  Yah.  Long and dreary?  Oh yeah. </div></div></li><li><div class="spoiler">  <b class="spoiler_title">solution for MLS restrictions</b> <div class="spoiler_text">  Here‚Äôs the problem (the level of spoilers is over nine thousand !! 1one): <div class="spoiler">  <b class="spoiler_title">the problem</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=AVC msg=audit(1383338997.630:221): avc: denied { sendto } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pid=1351 comm=<span class="hljs-string"><span class="hljs-string">"acpid"</span></span> path=<span class="hljs-string"><span class="hljs-string">"/dev/log"</span></span> scontext=system_u:system_r:initrc_t:s0-s3:c0.c31 tcontext=system_u:system_r:syslogd_t:s3:c0.c31 tclass=unix_dgram_socket <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=SYSCALL msg=audit(1383338997.630:221): arch=40000003 syscall=102 success=no <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>=-13 a0=3 a1=afbe15d0 a2=a779b000 a3=ffffffc8 items=0 ppid=1 pid=1351 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 ses=4294967295 tty=(none) comm=<span class="hljs-string"><span class="hljs-string">"acpid"</span></span> exe=<span class="hljs-string"><span class="hljs-string">"/usr/sbin/acpid"</span></span> subj=system_u:system_r:initrc_t:s0-s3:c0.c31 key=(null)</code> </pre></div></div>  Here is a description: <div class="spoiler">  <b class="spoiler_title">the decription</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># audit2allow -Rev -i /tmp/x require { type syslogd_t; type initrc_t; class unix_dgram_socket sendto; } #============= initrc_t ============== # audit(1383338997.630:221): # scontext="system_u:system_r:initrc_t:s0-s3:c0.c31" tcontext="system_u:system_r:syslogd_t:s3:c0.c31" # class="unix_dgram_socket" perms="sendto" # comm="acpid" exe="" path="" # message="type=AVC msg=audit(1383338997.630:221): avc: denied { sendto } for # pid=1351 comm="acpid" path="/dev/log" # scontext=system_u:system_r:initrc_t:s0-s3:c0.c31 # tcontext=system_u:system_r:syslogd_t:s3:c0.c31 tclass=unix_dgram_socket "#!!!! This avc is a constraint violation. You will need to add an attribute to either the source or target type to make it work. #Constraint rule: # Possible cause source context and target context 'level' differ allow initrc_t syslogd_t:unix_dgram_socket sendto;</span></span></code> </pre></div></div>  Here are the existing rules: <div class="spoiler">  <b class="spoiler_title">the sesearch</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># sesearch --allow -s initrc_t -t syslogd_t -c unix_dgram_socket Found 2 semantic av rules: allow initrc_t syslogd_t : unix_dgram_socket sendto ; allow unconfined_domain_type domain : unix_dgram_socket { ioctl read write create getattr setattr lock relabelfrom relabelto append bind connect listen accept getopt setopt shutdown recvfrom sendto recv_msg send_msg name_bind } ;</span></span></code> </pre></div></div>  As we see, the resolving rule is already there.  Moreover, in the MLS version, this access would be allowed. <br><div class="spoiler">  <b class="spoiler_title">offtopic</b> <div class="spoiler_text">  At the same time you can appreciate the beauty of the unconfined domain.  Everything is possible, then he is ‚Äúunlimited‚Äù.  That is why SELinux testing on something other than strict doesn't make much sense.  And even if you have strict, but the object being tested is unconfined, then, in general, it is a bit early to make conclusions about the usefulness and reliability of SELinux, even if you really want to :-) </div></div>  Decision.  We find the desired restriction, we read: <pre> <code class="bash hljs">mlsconstrain unix_dgram_socket sendto (( l1 eq l2 ) or (( t1 == mlsnetwriteranged ) and ( l1 dom l2 ) and ( l1 domby h2 )) or (( t1 == mlsnetwritetoclr ) and ( h1 dom l2 ) and ( l1 domby l2 )) or ( t1 == mlsnetwrite ) or ( t2 == mlstrustedobject )); <span class="hljs-comment"><span class="hljs-comment"># scontext=system_u:system_r:initrc_t:s0-s3:c0.c31 # tcontext=system_u:system_r:syslogd_t:s3:c0.c31</span></span></code> </pre>  Total, sendto to the socket (t1 writes to t2) is allowed if: <ul><li>  the lower access level t1 is equal to that of t2 (s0! = s3), or </li><li> t1   mlsnetwriteranged (,   <i>seinfo -amlsnetwriteranged -x</i> ),     ,  </li><li> t1   mlsnetwritetoclr (, ),  </li><li> t1   mlsnetwrite (,   setrans_t),  </li><li> t2   mlstrustedobject (, syslogd_t  ,   devlog_t) </li></ul>  ,     . ,     audit2allow      ,       .     /dev/log: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># ls -laZ /dev/log srw-rw-rw-. 1 root root system_u:object_r:devlog_t:s3:c0.c31 0 Nov 1 23:06 /dev/log</span></span></code> </pre> ¬´WTF?!¬ª ‚Äî   .    tcontext~syslogd_t,    devlog_t?  ps: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># ps -auxZ | grep [r]syslog system_u:system_r:syslogd_t:s3:c0.c31 root 1338 0.0 0.3 30784 972 ? Ssl Nov01 0:00 /usr/sbin/rsyslogd</span></span></code> </pre>   : rsyslog,    syslogd_t,  <i></i> ,    ,   /dev/log;  <i></i>   /dev/log   devlog_t     .  ,  sendto    ,   ,     . <a href="http://www.spinics.net/lists/selinux/msg10746.html"> </a>      SELinux, Stephen Smalley.  <a href="http://www.spinics.net/lists/selinux/msg10839.html"></a>    ,   .   <a href="http://oss.tresys.com/pipermail/refpolicy/2010-November/003444.html"></a>     syslogd_t  mlstrustedobject,    /proc/`pidof rsyslog`/   mlstrustedobject. ,   ,  Fedora     . ,    ‚Äî    <i></i>  ,    ,          , ,    .    ,   : <pre> <code class="bash hljs">$ grep <span class="hljs-string"><span class="hljs-string">''</span></span> syslogd_local.* syslogd_local.fc:<span class="hljs-comment"><span class="hljs-comment"># no file contexts redefined here syslogd_local.if:## &lt;summary&gt;syslogd local policy&lt;/summary&gt; syslogd_local.te:policy_module(syslogd_local, 0.0.1) syslogd_local.te:################################################################## syslogd_local.te:require { syslogd_local.te: type syslogd_t; syslogd_local.te:} syslogd_local.te: syslogd_local.te:#============= syslogd_t ============== syslogd_local.te:# mark syslogd_t as mlstrustedobject syslogd_local.te:# this is possible security hole, </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> get some heavy brain augmentation and investigate syslogd_local.te:mls_trusted_object(syslogd_t);</span></span></code> </pre>      .     modules.conf   . </div></div></li></ul></div></div></li><li><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to fix</font></font></b> <div class="spoiler_text">    ,     . ,    permissive (/etc/selinux/config),   ,  audit.log c      ,    , newrole, ssh.    enforcing,     .    auditd         ssh: <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># sestatus SELinux status: enabled SELinuxfs mount: /sys/fs/selinux SELinux root directory: /etc/selinux Loaded policy name: custom Current mode: enforcing Mode from config file: enforcing Policy MLS status: enabled Policy deny_unknown status: denied Max kernel policy version: 28 root@sandbox:~# cat /var/log/audit/audit.log type=DAEMON_START msg=audit(1383360996.062:2774): auditd start, ver=2.3.2 format=raw kernel=3.10.17-vm-slnx auid=4294967295 pid=1278 subj=system_u:system_r:auditd_t:s3:c0.c31 res=success type=CONFIG_CHANGE msg=audit(1383360996.180:20): audit_backlog_limit=320 old=64 auid=4294967295 ses=4294967295 subj=system_u:system_r:auditctl_t:s0-s3:c0.c31 res=1 type=LOGIN msg=audit(1383361036.430:21): login pid=1568 uid=0 old auid=4294967295 new auid=0 old ses=4294967295 new ses=1 type=LOGIN msg=audit(1383361038.410:22): login pid=1571 uid=0 old auid=4294967295 new auid=0 old ses=4294967295 new ses=2 root@sandbox:~# id -Z root:secadm_r:secadm_t:s0-s3:c0.c31</span></span></code> </pre> ,      ,      ,   ,  ,  , ,  -,  .  . </div></div></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we have all configured, the system boots in enforcing mode. </font><font style="vertical-align: inherit;">At this point, as a rule, the attentive reader already has extensive knowledge of modifying the modules, is fluent in the policy structure, sincerely loves (or at least sincerely hates) the m4 syntax, subscribes to the NSA newsletter, knows two dozen sources of information on SELinux and a dozen developers. . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is time to climb a little deeper, on the territory, not much described in the documentation.</font></font><br><br><h4>  Mls </h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are somewhat familiar with all sorts of </font></font><a href="http://en.wikipedia.org/wiki/Common_Criteria"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">criteria for </font></font></a> <a href="http://en.wikipedia.org/wiki/Trusted_Computer_System_Evaluation_Criteria"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">evaluation </font></font></a> <a href="http://en.wikipedia.org/wiki/ITSEC"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of security</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then you already know that they are, first, the big set (c </font></font><a href="http://www.commoncriteriaportal.org/files/ppfiles/lspp.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">individual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (PDF) </font></font><a href="http://www.commoncriteriaportal.org/files/ppfiles/lspp.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">profiles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (PDF), most of which have developed various kinds of paramilitary organizations), and that the output is a </font></font><a href="http://en.wikipedia.org/wiki/Evaluation_Assurance_Level"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certain the number of parrots</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which characterizes the rigidity of the requirements during the passage. </font></font><a href="http://en.wikipedia.org/wiki/Multilevel_security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mls</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adds to the existing SELinux restrictions two more levels of control, vertical (levels) and horizontal (categories). </font><font style="vertical-align: inherit;">The first is nothing more than ‚Äútolerances‚Äù, where the superior permit implies access to a lower level (‚Äútop secret‚Äù can read documents classified as ‚Äúsecret‚Äù), and the second is different categories of the same level, where permission to read one category does not mean permission to read the rest. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since both of these levels of control can be assigned to any objects that SELinux works with, this allows you to implement almost any requirements for classifying information and its flows:</font></font><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hierarchical access, TopSecret -&gt; Secret -&gt; Unclassified, for any objects. </font><font style="vertical-align: inherit;">The full list is in the flask directory;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Marking of both files and, for example, network connections or tables in the database; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prevention of information leakage to lower levels, regardless of the user's rights in the system; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Restriction of access by default for any users (including root), with further differentiation of roles depending on authentication. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And other overkill for 99% of systems. </font></font></li></ul><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, all this requires careful study, first of all, the system architecture, otherwise we then contract workers will lay out documents with the ‚ÄúTop Secret‚Äù stamp on instagrams :-) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this experiment, I used these levels and categories:</font></font><pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># cat /etc/selinux/custom/setrans.conf Domain=Playbox # levels s0=SystemLow s3:c0.c31=SystemHigh s0-s3:c0.c31=SystemLow-SystemHigh s1=Confidential s2=Secret # employee categories s1.c0=Ninjas s1.c1=Pirates s1.c2=Jesuses # secret stuff s2.c0=Aliens s2.c1=BigBrother</span></span></code> </pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we set up our web server, as if it were designed exclusively for internal access, i.e. </font><font style="vertical-align: inherit;">works strictly at the level of s1 (Confidential). </font><font style="vertical-align: inherit;">It is not necessary for demonstration, but useful for general development. </font><font style="vertical-align: inherit;">Of course, we will not configure IPSec and packet marking, otherwise no one will see it, we restrict ourselves to the local context. </font><font style="vertical-align: inherit;">Since we now only have ssh configured on the test machine, let's choose a server that is not described in RefPolicy:</font></font><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx</font></font></b> <div class="spoiler_text">    <a href="https://github.com/simple10/selinux-nginx/tree/master/nginx"></a>  nginx,      ,     MCS ( s0).     NIH     .  ,   ,  <b>dpkg -L</b>  <b>lsof</b> ,    : <pre> <code class="bash hljs">/usr/sbin/nginx -- gen_context(system_u:object_r:nginx_exec_t,s1:c0.c2) /etc/init.d/nginx gen_context(system_u:object_r:nginx_initrc_exec_t,s1:c0.c2) /etc/nginx(/.*)? gen_context(system_u:object_r:nginx_etc_t,s1:c0.c2) /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx(/.*)? gen_context(system_u:object_r:nginx_var_log_t,s1:c0.c2) /var/run/nginx(/.*)? gen_context(system_u:object_r:nginx_var_run_t,s1:c0.c2) /var/www(/.*)? gen_context(system_u:object_r:nginx_var_www_t,s1:c0.c2) /var/lib/nginx(/.*)? gen_context(system_u:object_r:nginx_var_lib_t,s1:c0.c3)</code> </pre> ,    ,    (, ,  ..),     .        s1 (Confidential),       .       ,      .     ,   ,   ( <b>newrole -r secadm_r</b> ),   premissive  ( <b>setenforce 0</b> ),       ( <b>restorecon -RFvv /</b> ),    nginx   sysadm_r ( <b>run_init /etc/init.d/nginx start</b> ).     audit.log  ,   .     modname.if,  ,     ,  ¬´¬ª : <pre> <code class="bash hljs">template(`web_server_template<span class="hljs-string"><span class="hljs-string">',` type $1_t, web_server; allow blah blah; # so we can call web_server_template(nginxN) in modname.te '</span></span>)</code> </pre>    modname.if       ,  ¬´¬ª .      .      ,      ,        : <pre> <code class="bash hljs">root@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># cat nginx_local.te policy_module(nginx_local, 0.0.1) ################################################################## type nginx_t; type nginx_exec_t; type nginx_initrc_exec_t; type nginx_etc_t; type nginx_var_log_t; type nginx_var_run_t; type nginx_var_www_t; type nginx_var_lib_t; corecmd_executable_file(nginx_exec_t); init_script_file(nginx_initrc_exec_t) files_type(nginx_etc_t) logging_log_file(nginx_var_log_t) files_pid_file(nginx_var_run_t) files_type(nginx_var_www_t) files_type(nginx_var_lib_t) init_ranged_daemon_domain(nginx_t, nginx_exec_t, s1:c0.c2)</span></span></code> </pre>        corecommands.if,        .   ‚Äî ,  MLS,     ,   nginx     . <br>  ,   ,     (grep nginx /var/log/audit/audit.log | grep 'sysctl'),    , ,  sysctl: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /read kernel sysctl values require { type sysctl_kernel_t; class dir { search }; class file { open read }; } allow nginx_t sysctl_kernel_t:dir { search }; allow nginx_t sysctl_kernel_t:file { open read };</span></span></code> </pre>  socket: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># socket bind require { type node_t; type http_port_t; class tcp_socket { name_bind setopt bind create listen node_bind }; class capability { net_bind_service setuid setgid }; } allow nginx_t http_port_t:tcp_socket { name_bind }; allow nginx_t node_t:tcp_socket { node_bind }; allow nginx_t self:tcp_socket { bind create setopt listen }; allow nginx_t self:capability { net_bind_service setuid setgid };</span></span></code> </pre>  And so on.     audit2allow,             MLS.       require    ,   ,        ,   .   ,    -  <div class="spoiler">  <b class="spoiler_title">such a</b> <div class="spoiler_text"><pre> <code class="bash hljs">policy_module(nginx_local, 0.0.1) <span class="hljs-comment"><span class="hljs-comment">################################################################## type nginx_t; type nginx_exec_t; type nginx_initrc_exec_t; type nginx_etc_t; type nginx_var_log_t; type nginx_var_run_t; type nginx_var_www_t; type nginx_var_lib_t; corecmd_executable_file(nginx_exec_t); init_script_file(nginx_initrc_exec_t) files_type(nginx_etc_t) logging_log_file(nginx_var_log_t) files_pid_file(nginx_var_run_t) files_type(nginx_var_www_t) files_type(nginx_var_lib_t) init_ranged_daemon_domain(nginx_t, nginx_exec_t, s1:c0.c2) # rules # /sys and /sys/devices/systemcpu/online require { type sysfs_t; class dir { search }; class file { read open }; } allow nginx_t sysfs_t:dir { search }; allow nginx_t sysfs_t:file { read open }; # /read kernel sysctl values require { type sysctl_kernel_t; type sysctl_t; class dir { search }; class file { open read }; } allow nginx_t sysctl_kernel_t:dir { search }; allow nginx_t sysctl_kernel_t:file { open read }; allow nginx_t sysctl_t:dir search; # self configs and symlinks require { type nginx_etc_t; class dir { open read search }; class file { open read getattr }; class lnk_file { read }; } allow nginx_t nginx_etc_t:dir { open read search }; allow nginx_t nginx_etc_t:file { open read getattr }; allow nginx_t nginx_etc_t:lnk_file { read }; # /etc/localtime, /etc/passwc, etc (no pun intended) require { type locale_t; type etc_t; class file { read open getattr }; } allow nginx_t locale_t:file { read open getattr }; allow nginx_t etc_t:file { read open getattr }; # pid file require { type var_run_t; class dir { search write add_name remove_name } ; class file { write read create open unlink }; } allow nginx_t var_run_t: dir { search }; allow nginx_t nginx_var_run_t: file { read write create open unlink }; allow nginx_t nginx_var_run_t: dir { search write add_name remove_name }; # libs require { type var_lib_t; class dir { search getattr }; } allow nginx_t var_lib_t:dir search; allow nginx_t nginx_var_lib_t: dir { search getattr }; # socket bind require { type node_t; type http_port_t; class tcp_socket { name_bind setopt bind create listen node_bind }; class capability { net_bind_service setuid setgid }; } allow nginx_t http_port_t:tcp_socket { name_bind }; allow nginx_t node_t:tcp_socket { node_bind }; allow nginx_t self:tcp_socket { bind create setopt listen }; allow nginx_t self:capability { net_bind_service setuid setgid }; # socket accept require { class tcp_socket { read write accept }; } allow nginx_t self:tcp_socket { read write accept }; # logs require { type var_log_t; class dir { search }; class file { open append }; } allow nginx_t var_log_t:dir { search }; allow nginx_t nginx_var_log_t:dir { search }; allow nginx_t nginx_var_log_t:file { open append }; # www require { class dir { search getattr }; class file { read getattr open }; } allow nginx_t nginx_var_www_t:dir { search getattr }; allow nginx_t nginx_var_www_t:file { read getattr open };</span></span></code> </pre></div></div> ,      . </div></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We get users and roles, for example so: </font></font><pre> <code class="bash hljs">root/sysadm_r@sandbox:~<span class="hljs-comment"><span class="hljs-comment"># adduser alice ...skipped... root/sysadm_r@sandbox:~# adduser bob ...skipped... root/secadm_r@sandbox:~# semanage user -a -R user_r -L s1 -r s1-s1:c0 ninjas root/secadm_r@sandbox:~# semanage user -a -R user_r -L s2 -r s2-s2:c0 aliens root/secadm_r@sandbox:~# semanage login -a -s ninjas alice root/secadm_r@sandbox:~# semanage login -a -s aliens bob # or, ninjas to supervise alice root/secadm_r@sandbox:~# restorecon -RFvv /home/ # thats all, folks.</span></span></code> </pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Total, we get: </font></font><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Both users cannot write data in the directory below their minimum level; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Both users cannot read from objects above their tolerance level; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both users are limited to their category. </font><font style="vertical-align: inherit;">When adding permissive rules for reading other domains, they can only read files with the category c0;</font></font></li><li> root     ,   ; </li><li>     - SELinux ID,    alice,      ( DAC )    ; </li><li>      ,   ,      core ‚Äî       s0,   ‚Äî s1. </li></ul><br><h4> Funky time </h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, now, finally, there will be slides. </font><font style="vertical-align: inherit;">For a full-fledged demonstration, I bought a small Vspku under this article, next to the NSA, and I quickly unfolded everything I had done on it. </font><font style="vertical-align: inherit;">Directly on this system, you can see what SELinux is, go under the root and type rm -rf / * first of all, without fail, start all sorts of scripts / sploits and rootkits, in general, show this to the NSA motherboard. </font><font style="vertical-align: inherit;">But before you do this exciting thing, let's go through both assumptions and limitations:</font></font><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As part of this training course, we: </font></font></h5><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We believe that root access to the server was given to anyone. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We believe that it can log in via ssh and run an interactive shell. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We believe that root is not nezaplen on user_u, as Russell Coker did in his </font></font><a href="http://www.coker.com.au/selinux/play.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play machine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Of course, this assumption is not recommended in production (like all previous ones, of course :-)</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We believe that we did not customize the kernel (no grsec, I decided not to include it in the article and tests) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We believe that we have almost no firewall. </font></font></li></ul><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there is a term in the IB for the state of security, in the description of which there are words ‚Äúpush apart‚Äù and ‚Äúrolls‚Äù, then this is it. </font><font style="vertical-align: inherit;">All that separates from total compromise is SELinux. </font><font style="vertical-align: inherit;">Compromise is inevitable, but it is very interesting how long it takes.</font></font><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But also, there is something for which SELinux is not intended, namely: </font></font></h5><ul><li> SELinux     .     <b>:(){ :|:&amp; };:</b> .        fork bombs,  - ‚Äî  ;   ,        ,   ‚Äî     ‚Äî      ,     . </li><li> SELinux         .         .    ,    SELinux  iptables ‚Äî   ,       .  ,    SELinux,   :-) </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We consider the server in a minimal configuration, there are no compilers / debuggers and everything that is usually not available on the market. </font><font style="vertical-align: inherit;">The full version of the MLS Play Machine will be later, when I deploy it not on a VPS, but on a more controlled infrastructure. </font><font style="vertical-align: inherit;">But there is scp - you can copy the interesting.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And yes, in the best traditions of the organization that developed SELinux, the recording of console sessions is also tested on the server at the same time :-) And you know, the NSA, Arizona, Area51 is not far, and here is the root access. </font><font style="vertical-align: inherit;">It is necessary to write, all of a sudden I get a car there for the central processors. </font><font style="vertical-align: inherit;">Remove the record - you are also a great fellow, and also write in the comments.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0day - at your discretion. </font><font style="vertical-align: inherit;">If it comes up, I will certainly be flattered. </font><font style="vertical-align: inherit;">Although, to whom I tell :-)</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I did not start a domain, this is for toy version 0.0.2. </font><font style="vertical-align: inherit;">Version 0.0.1</font></font><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></b> <div class="spoiler_text">    : http://162.213.198.69 </div></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And yes, a separate request - please behave. </font><font style="vertical-align: inherit;">It is not necessary to kill all root processes and interfere with others, the user is one for all.</font></font><br><h4>  Notes </h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> * Tim Minchin, Lullaby </font></font></div><p>Source: <a href="https://habr.com/ru/post/199202/">https://habr.com/ru/post/199202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199192/index.html">Oriense. Development of devices to help the blind and visually impaired</a></li>
<li><a href="../199194/index.html">How does the mapping of remote territory using drones</a></li>
<li><a href="../199196/index.html">High-performance SUN / ONCRPC server on Java NIO</a></li>
<li><a href="../199198/index.html">Kaspersky rebelled</a></li>
<li><a href="../199200/index.html">The path from idea to layout. Thinking about product concept</a></li>
<li><a href="../199204/index.html">Site UploaderTalk turned out to be an anti-piracy trap</a></li>
<li><a href="../199206/index.html">HTML minimization in Web Essentials 2013</a></li>
<li><a href="../199210/index.html">Some interesting and useful things for a web developer (release 7)</a></li>
<li><a href="../199212/index.html">Interview with C # legend Eric Lippert</a></li>
<li><a href="../199218/index.html">IvBit Conference Report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>