<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>10 bugs in Ruby / Ruby on Rails that are easy to fix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Programmers make mistakes in the code. Some are just annoying (errors, not programmers - approx. Translator), others can be really dangerous for the a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>10 bugs in Ruby / Ruby on Rails that are easy to fix</h1><div class="post__text post__text-html js-mediator-article">  Programmers make mistakes in the code.  Some are just annoying (errors, not programmers - approx. Translator), others can be really dangerous for the application. <br>  I present to you my selection of 10 common Ruby / RoR developer errors and tips on how to avoid them.  I hope they will help you reduce the time to debug the code. <a name="habracut"></a><br><br><h4>  1. Double negation and difficult conditions. </h4><br><pre><code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !user.<span class="hljs-literal"><span class="hljs-literal">nil</span></span>? <span class="hljs-comment"><span class="hljs-comment"># ... end unless user.blank? # ... end unless user.active? || address.confirmed? # ... end</span></span></code> </pre> <br>  Double negatives are hard to read.  Every time I spend a couple of seconds to <i>parse the</i> condition.  Use the Rails API and write user.present?  instead of! user.blank ?. <br><br>  I also rarely find use <b>unless</b> justified, especially with multiple conditions.  How quickly will you understand in which case this condition will be met? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> user.active? <span class="hljs-params"><span class="hljs-params">||</span></span> address.confirmed? ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><h4>  2. Use <b>save</b> instead of <b>save!</b>  without checking the return value. </h4><br><pre> <code class="ruby hljs">user = User.new user.name = <span class="hljs-string"><span class="hljs-string">"John"</span></span> user.save</code> </pre><br>  What is the problem with this code?  You will not learn about the save error if it occurs.  Not a single trace will remain in your logs, and you will spend a lot of time trying to figure out: ‚ÄúWhy are there no users in the database?‚Äù. <br>  If you are sure that the data is always correct and the record should be saved - use <i>bang</i> methods (save! Create! Etc.).  Use save only if you are checking the return value: <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user.save ... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><h4>  3. Use <b>self</b> unnecessarily. </h4><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first_name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">display_name</span></span></span><span class="hljs-class"> "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{self.first_name} #{self.last_name}" end end</span></span></span></span></code> </pre><br>  In the case of self.first_name, it is enough to write first_name, and the result will not change.  But it is rather a matter of style, and does not bear any negative consequences.  However, remember that self must be used when assigning values. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.first_name = <span class="hljs-string"><span class="hljs-string">"John"</span></span></code> </pre><br><br><h4>  4. Problem <b>N + 1</b> request. </h4><br><pre> <code class="ruby hljs">posts = Post.limit(<span class="hljs-number"><span class="hljs-number">10</span></span>) posts.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|post|</span></span> do_smth post.user <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  If you look at the logs when executing this code, you will see that 11 queries are being executed to the database: one for a selection of posts and one for each user.  <i>The rails are</i> not able to predict your desires and make a request for unloading 10 users at once (perhaps even with posts).  In order to <i>direct</i> Rails in the right direction, you can use the <b>includes</b> method (more info <a href="http://guides.rubyonrails.org/active_record_querying.html">here</a> ). <br><br><h4>  5. A boolean field with three values. </h4><br>  It is assumed that a boolean field can have only two values ‚Äã‚Äã- true or false, is it not?  What about <b>nil</b> ?  If you forgot to specify a default value and add the <b>null: false</b> option in your migration, you will have to deal with three <i>Boolean</i> values ‚Äã‚Äã‚Äî true, false and nil.  As a result, we have a similar code: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,      if post.published.nil? # ... end #   if post.published # ... end #   unless post.published # ... end</span></span></code> </pre><br>  If you need to handle three different values, use a text field. <br><br><h4>  6. Lost entries after deletion. </h4><br>  Consider a simple example: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">posts</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates_presence_of</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  If we delete a user, the posts associated with it will cease to be correct (which, most likely, will lead to errors in the application).  In this case, it is necessary to handle the deletion of related objects: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">posts</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delete</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br><h4>  7. Using application code in migrations. </h4><br>  Suppose you have the following model: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ACTIVE</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">after_registration</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  and you want to add a points field to it.  To do this, you create a migration.  You also want to set the points field value for existing users to 10. To do this, you write in the migration: <br><br><pre> <code class="ruby hljs">User.where(<span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> User::ACTIVE).update_all(<span class="hljs-symbol"><span class="hljs-symbol">points:</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre><br>  You start migration, and - Hurray!  - everything worked: existing users have 10 points each.  As time goes by, the code changes, and now you decide to remove the User :: ACTIVE constant.  From now on, your migrations do not work, you cannot start migrations from scratch (you will get an <i>uninitialized constant User :: ACTIVE</i> error). <br><br>  Tip: do not use application code inside migrations.  Use, for example, temporary rake tasks to modify existing data. <br><br>  <b>Translator's Note:</b> <br>  In my opinion, it is much more convenient to use temporary migrations to change values.  Especially when rolling out changes to production: the probability of forgetting to run rake is not zero, and migration will be launched for you by Capistrano. <br>  A temporary migration can be cleaned after the release. <br><br><h4>  8. Ubiquitous <b>puts</b> . </h4><br>  Remaining after debugging puts clogs the logs and output during the test run.  Use Rails.logger.debug, which allows you to filter logs depending on the selected level. <br><br>  <b>Translator's Note:</b> <br><br>  And better learn how to use debugger.  Do not forget to remove binding.pry before commit. <br><br><h4>  9. Forget about the <b>map</b> . </h4><br>  I often see similar code: <br><br><pre> <code class="ruby hljs">users = [] posts.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|post|</span></span> users &lt;&lt; post.user <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  This is the case when you need to use <b>map</b> : concisely and idiomatically. <br><br><pre> <code class="ruby hljs">users = posts.map <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|post|</span></span> post.user <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#      (. ) users = posts.map(&amp;:user)</span></span></code> </pre><br><br><h4>  10. Do not use <b>Hash # fetch</b> . </h4><br><pre> <code class="ruby hljs">name = params[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">:name</span></span>]</code> </pre><br>  What is wrong here?  This code will raise an exception ( <i>NoMethodError: undefined method `[] 'for nil: NilClass</i> ) if the user key is not in the hash.  If you expect the key to be a hash, use Hash # fetch: <br><br><pre> <code class="ruby hljs">name = params.fetch(<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>)[<span class="hljs-symbol"><span class="hljs-symbol">:name</span></span>]</code> </pre><br>  Then you will get a more meaningful exception: <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">KeyError:</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-symbol"><span class="hljs-symbol">found:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span></code> </pre><br><br><h4>  Instead of a conclusion. </h4><br>  What are your <i>favorite</i> mistakes? </div><p>Source: <a href="https://habr.com/ru/post/250007/">https://habr.com/ru/post/250007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249991/index.html">OpenOCD, ThreadX and your processor</a></li>
<li><a href="../249993/index.html">How to advertise an online game</a></li>
<li><a href="../249999/index.html">I used dictation and voice control for a week and this is what happened</a></li>
<li><a href="../250001/index.html">The effect of drip transform in CSS</a></li>
<li><a href="../250005/index.html">Sticky effect</a></li>
<li><a href="../250009/index.html">Writing from scratch a quest for ASP.NET 5 (vNext) and Angular.js</a></li>
<li><a href="../250011/index.html">Automating Android Development: the Beginning</a></li>
<li><a href="../250015/index.html">Stop using passwords in Plesk</a></li>
<li><a href="../250021/index.html">Getting rid of JavaScript in social buttons (Facebook, VK, Twitter, etc.)</a></li>
<li><a href="../250023/index.html">Limiting the number of attempts to enter a password in the authorization web form using Nginx or HAProxy using the example of WordPress</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>