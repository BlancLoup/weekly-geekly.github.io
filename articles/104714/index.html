<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What is worth cleaning datastore from sessions using Mapper API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Those who included session support in their application on GAE know that sessions, first, are recorded in the datastore, and second, they do not autom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What is worth cleaning datastore from sessions using Mapper API</h1><div class="post__text post__text-html js-mediator-article">  Those who included <a href="http://code.google.com/appengine/docs/java/config/appconfig.html">session support</a> in their application on GAE know that sessions, first, are recorded in the datastore, and second, they do not automatically disappear from there.  From rotten sessions, you must somehow get rid of yourself. <br><br>  I somehow did not care about the rotten sessions, and in a year and a half they had accumulated a half million pieces.  Recently, the size of the data stored in the datastore exceeded the free quota and, since 99% of the sessions were occupied, I decided to remove the foul. <br><br><img src="https://habrastorage.org/storage/1ebde615/50d351ea/8adcff31/f83cddc6.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Of course, it was a sin not to use the recently released <a href="http://googleappengine.blogspot.com/2010/07/introducing-mapper-api.html">Mapper API</a> for this purpose.  Nakoryabal simple Mapper.  For a start, I decided to just count, without deleting: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SessionCleanupMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppEngineMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NullWritable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NullWritable</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Key key, Entity value, Context context)</span></span></span><span class="hljs-function"> </span></span>{ Object expiresProperty = value.getProperty(<span class="hljs-string"><span class="hljs-string">"_expires"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expiresProperty <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Long) { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> expiresTimestamp = ((Long)expiresProperty).longValue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expiresTimestamp &lt; System.currentTimeMillis()) { context.getCounter(<span class="hljs-string"><span class="hljs-string">"Session"</span></span>, <span class="hljs-string"><span class="hljs-string">"expired"</span></span>).increment(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// DatastoreMutationPool mutationPool = this.getAppEngineContext(context).getMutationPool(); // mutationPool.delete(value.getKey()); } } } }</span></span></code> </pre> <br><br>  And launched.  Gears spun, GAE in four hands began to stir my sessions.  A few hours later I found that the site is lying, exceeding the quota.  I looked into the console and saw that the CPU quota was exhausted (8.5 CPU hours).  I was surprised.  I increased the quota and the next day I started mapreduce again, now having uncommented the lines deleting entities. <br><br>  Hooray.  In just 2.5 hours of absolute time, cloud megatechnologies coped with the task, consuming 22 CPU hours in the end. <br><br><img src="http://habrastorage.org/storage/3151d4bd/e9dd0bfa/b9713a6a/6ba41df4.png"><br><img src="http://habrastorage.org/storage/82209ac2/a852b388/c438f92f/fab95d30.png"><br><br>  Thought it out.  Something is wrong in the clouds.  I have not tried it, but for some reason I think that even MySQL will cope with <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> _ah_SESSION <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> _expires &lt; <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>()</code> </pre><br>  in a few minutes.  Even with a million lines and even with two millions.  But this is so old-fashioned, everything on one machine, without scalability and redundancy, and so on ... <br><br>  <b>Update:</b> To remove a sessionreduce from the session datastore, it is not necessary to write mapreduce, you can also pull the magic servlet and manually iterate with the cursor.  But in order to calculate how much they are rotten every day (something like SELECT COUNT (*) FROM _ah_SESSION GROUP BY _expires / (86400 * 1000)) nobody wrote the servlet, and most likely you will have to drive mapreduce, with about the same loss of a primitive DBMS. </div><p>Source: <a href="https://habr.com/ru/post/104714/">https://habr.com/ru/post/104714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104702/index.html">Meebo updated interface</a></li>
<li><a href="../104704/index.html">Using git in flash development</a></li>
<li><a href="../104706/index.html">VMware View Client in Russian</a></li>
<li><a href="../104712/index.html">Updated Gmail application on the Android Market</a></li>
<li><a href="../104713/index.html">Talismans of Ubuntu and OpenSUSE Versus Mac OS X Talismans</a></li>
<li><a href="../104715/index.html">Distributed Internet Name System</a></li>
<li><a href="../104717/index.html">Open Source ... filmstrip!</a></li>
<li><a href="../104718/index.html">Canvas transformations in accessible language</a></li>
<li><a href="../104720/index.html">We sue the rogue pharmacists</a></li>
<li><a href="../104721/index.html">The rating of "narrow specialists" on Habr√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>