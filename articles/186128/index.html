<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Badoo offline notification system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In order for users, while being offline, to learn about events on the site, we have created a special notification system. Its task is to accumulate e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Badoo offline notification system</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/caf/455/c64/caf455c64a7d7d18d8b3a34fcbd74f2e.jpg" align="left">  In order for users, while being offline, to learn about events on the site, we have created a special notification system.  Its task is to accumulate events for the user and at the right time to report them via available communication channels, such as email and push notifications to smartphones. <br>  How is event storage organized?  What events are notifications coming from?  At what point are they sent and on what basis?  Today we will try to answer all these and other questions. <br><br>  The article gives a general description of the system architecture with small technical details and will be of interest to those who are only going to or in some way notify their users about everything new that happened during their absence on the site (in the application, service, etc.) <br><br><a name="habracut"></a><br><h4>  What are the events? </h4><br>  All events of our site are generated by the actions of some users in relation to others.  Having found a nice person, you will want to see his profile in more detail, thereby creating the event <i>"Visiting Profile"</i> .  If his profile seemed interesting to you, it is likely that you will want to write to him, thus creating the <i>‚ÄúNew message‚Äù</i> event.  You can <i>add him to your favorites</i> , and also express a desire to <i>meet him</i> .  If he also wants to meet with you, then the <i>‚ÄúMutual Sympathy‚Äù</i> event will happen for each of the users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Evaluating photos of</i> other users, as well as <i>leaving comments</i> , you will create relevant events. <br><br>  While on the site, the user sees new events in the form of numbers in red circles near each section containing contacts.  If it is not on the site now, then it will be able to receive notifications about all updates in sections. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/247/591/26d/24759126dbb59f873fa7a7a203ac8da3.png"></div><br><br><h4>  How are events stored? </h4><br>  In order not to send too many notifications to users, we send a notification not to every event, but group them for a certain period, for example, during the first half hour of the user‚Äôs absence from the site.  After the first dispatch, we again wait and, if there are new events, we send.  However, some particularly important notifications can be sent out of turn. <br><br>  For the aggregation of events, we developed a special DBMS, a demon in C, which is able to: <br><br><ul><li>  Store an array of events for each user.  Each event is characterized by the sender's identifier, numeric type (1 - messages, 2 - visitors, etc.) and an arbitrary string of data to which additional information can be passed, for example, in the form of a serialized array. </li><li>  Monitor time, periods, timeouts and, upon request, return data that is ready to be sent.  As soon as the time comes, the demon gives all the accumulated events for the next user. </li><li>  All communication with the DBMS is carried out using the RPC-like protocol, which transmits data packed using Google Protocol Buffers. </li></ul><br>  Four of these daemons are launched in each of our two data centers to cope with a load that peaks to 25 thousand requests per second without any problems, as well as to minimize downtime if you need to restart / update the daemon, or if .  The load between them is distributed according to a simple principle: <br><br><blockquote>  <i>user_id% 4 = &lt;daemon number&gt;</i> </blockquote><br>  Thus, events for each user always ‚Äúlive‚Äù in the same database.  User data is stored not only in memory, but also stored on disk, so notifications are not lost.  If it is necessary to change the sharding and add a few more demons, then the demons are ‚Äúextinguished‚Äù, the data is moved as needed between the repositories and loaded into memory at startup.  This is an extremely rare situation - for all the time we needed to do this only once. <br><br><h4>  What is the delivery channel? </h4><br>  In order to notify users about new events, we use e-mail, as well as iOS and Android push notifications. <br><br>  It is worth saying a little bit about what push notifications are.  Each iOS application has the ability to send you notifications even when it is not running (of course, if you do not prohibit it).  Delivery of notifications in this case is carried out through the Apple server, and not directly.  When you install an application on your iPhone, Apple tells the developer the identifier of the installed application on your system, which we use as the address for sending messages.  The same system exists for Android-smartphones, but delivery is already carried out through the Google server. <br><br>  If you have several devices on which our application is installed, the notification will be sent to each of them. <br><br><h4>  How are notifications generated? </h4><br>  For each of the channels we use, we have our own mechanism for generating notifications. <br><br>  The general logic is that there are notifications containing information about only one type of event (2 visitors, 5 messages, etc.), and there are group notifications (2 visitors and 1 message; 2 messages and 1 mutual sympathy, etc. ).  For emails there are several separate templates for new messages, visitors, etc.  plus a group letter template, in which each event is represented by a separate line. <br><br>  For push notifications, we compiled texts for each type of event in several variants.  Since the notification cannot contain a lot of information, we selected several basic combinations for groups of events (for example, visitors + messages, messages + mutual sympathies), for which we wrote versions of texts. <br><br><ul><li>  An example of a ‚Äúsingle‚Äù notification in several ways: <br><ul><li>  Option 1: <i>You have &lt;number&gt; new messages from girls!</i> </li><li>  Option 2: The <i>girls wrote you &lt;number&gt; new messages!</i> </li></ul><br></li><li>  Example of "group" notification: <br><ul><li>  <i>You have &lt;number&gt; messages and new people want to meet with you!</i>  <i>Find out who ...</i> </li></ul><br></li></ul><br>  Notifications for iOS are different from Android in that the latter may have a title, text, and image, and the first only text, but of greater length. <br><br><h4>  How is the system architecture? </h4><br>  On the one hand, during the use of the site, users generate events that are immediately added to the database.  On the graph, you can see the ratio of events in 24 hours in one of our two data centers (the exact numbers on the graphs were asked not to publish): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/cc6/7fd/7fc/cc67fd7fc346932698a21b50943f2481.png"></div><br><br>  On the other hand, on several servers a php script is continuously running, which constantly polls the database, whether there are notifications, the sending time of which has already arrived.  Below you can see a graph of the number of users for whom notifications are ready: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/b0d/7a9/4fa/b0d7a94fa72b4d4b6a4d0aaaf018741f.png"></div><br><br>  If you need to send a notification to your smartphone, then the record in the database is marked with a special flag and delayed for 10 minutes.  If the user's time zone is now night, then we will send a notification with the ‚ÄúSilent‚Äù parameter in order not to disturb the user's sleep. <br><br>  If the user has not visited the site within 10 minutes, then we create and send a digest letter containing information about all the accumulated events.  After that, the sent notifications are deleted from the database, and we again expect new events. <br><br>  Each time a page is requested from a registered user, we send a command to the database to clear all its events.  It so happens that the user got on the promo page and, not seeing anything new, left the site.  On such pages, where not all the counters of new events are visible, we indicate which specific events should be cleaned. <br><br>  When the time of the next posting comes, and the user still has the status ‚Äúonline‚Äù, we mark this with a special flag and postpone the record in the database for a while, expecting that he will either continue to be active on the site or will be in the status ‚Äúoffline‚Äù. <br><br><h4>  What does online mean? </h4><br>  How to determine that the user is now on the site, recently was or is already "offline"?  These concepts are quite subjective and selected empirically. <br><br>  Users can be active on the site and in our mobile applications.  In order to store the time of the last activity, we use another DBMS of our own design - Last Access.  This out-of-the-box daemon calculates offline status based on all user activity data: 30 minutes after the last action, the user finally ceases to be "online." <br><br>  In order to send notifications, the more complex logic of determining online status is used.  First, we check Last Access: if it reports that the user status has changed to "offline", then we can safely send, because  a lot of time has already passed.  Otherwise, the following algorithm is used for the site and applications: if a person uses the site, then 15 minutes should pass to send.  If the mobile application is used and less than 15 minutes have passed, then we simply check if there is a connection with the running application, and if not, then send a notification. <br><br>  The described system conveniently and unobtrusively informs users about what's new for them on the site.  We are constantly refining and improving it to make it really useful and necessary for our many users. <br><br>  Alexander <a href="http://habrahabr.ru/users/treg/">Treg</a> Treger, developer. </div><p>Source: <a href="https://habr.com/ru/post/186128/">https://habr.com/ru/post/186128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186118/index.html">I invite you to the hack quest CRC - information security tournament</a></li>
<li><a href="../186120/index.html">Education, work and advanced training</a></li>
<li><a href="../186122/index.html">Iran will distribute state e-mail to all citizens</a></li>
<li><a href="../186124/index.html">Cross-compiling on OS X under Linux using crosstool-ng</a></li>
<li><a href="../186126/index.html">IKEv2 and Flex VPN using Cisco IOS. Syntax and Logic</a></li>
<li><a href="../186132/index.html">Some simple requests instead of one big one for loading links in ORM</a></li>
<li><a href="../186134/index.html">Smartphone Meizu MX2 is becoming more accessible!</a></li>
<li><a href="../186136/index.html">Voyeur.js is a small and attractive library for working with DOM</a></li>
<li><a href="../186142/index.html">In which areas are most popular sites?</a></li>
<li><a href="../186144/index.html">Build 2013: the best reports on the Windows Azure platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>