<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bing + Python Image Search</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes it is necessary to type pictures on a specific topic in order to be able to choose the necessary one from the existing set, etc. Current sea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bing + Python Image Search</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4ff/d29/420/4ffd294205d1f1074eb63eb3c2e498e2.gif" width="200" height="99" alt="Bing + Python" align="left">  Sometimes it is necessary to type pictures on a specific topic in order to be able to choose the necessary one from the existing set, etc.  Current search engines provide such an opportunity, but you need to open the browser, navigate through the pages, work with the mouse and, in general, do it.  I would like to have a console utility ‚Äúlaunched and forgotten‚Äù for a set of necessary images.  We consider the Bing API, getting started in Python and linking them to search for images. <br><a name="habracut"></a><br><br><h3>  Introduction </h3><br>  This is my first more or less large Python program, which I began to study recently (by the way, <a href="http://kossmak.habrahabr.ru/">many</a> thanks to <a href="http://kossmak.habrahabr.ru/">kossmak</a> for his translations of articles).  Examples of use at the end of the article. <br><br><h3>  TK </h3><br>  A console program that accepts a search line as input and the required number of images.  At the output - a subdirectory in the current search results. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Why bing </h3><br>  Some time ago, it was necessary to test an asynchronous loader for ActionScript.  For the load, Google was chosen, however, as a result, it turned out that Google produces no more than 64 results for requests through the API.  This (at that time) was enough, but the sediment remained.  After the search, it was found: Yahoo (with comments that many of the data it issued is outdated) and Bing (which on its page promises up to 1000 results).  Bing was chosen, because, besides the request itself, it allows you to overlay filters on it (see below) <br><br><h3>  Bing </h3><br>  Development for Bing begins with the <a href="http://www.bing.com/developers">Bing Developer Center</a> page.  There you need to get APP_ID for signing each request, registration is minute.  I didn‚Äôt really understand the restrictions imposed (maybe there are simply no them), so I‚Äôm posting my test APP_ID along with the examples (if I‚Äôm going to use it, I recommend that you add and put your APP_ID into the code). <br><br><h3>  Bing API </h3><br>  The API exists for VB / C # / C ++ / F # / JS, but in this example the final http request is used.  API description for image search <a href="http://msdn.microsoft.com/en-us/library/dd250942(v%3DMSDN.10).aspx">here</a> <br>  So, the minimum request for image search and JSON response is as follows: <br>  <a href="http://api.search.live.net/json.aspx%3Fappid%3DAPP_ID%26sources%3Dimage%26query%3DSEARCH_QUERY">api.search.live.net/json.aspx?appid=APP_ID&amp;sources=image&amp;query=SEARCH_QUERY</a> <br>  Request example (search for apple): <br>  <a href="http://api.search.live.net/json.aspx%3Fappid%3D4EFC2F2CA1F9547B3C048B40C33A6A4FEF1FAF3B%26sources%3Dimage%26query%3Dapple">http://api.search.live.net/json.aspx?appid=4EFC2F2CA1F9547B3C048B40C33A6A4FEF1FAF3B&amp;sources=image&amp;query=apple</a> <br><br><h3>  Python </h3><br>  Everything is simple and cross-platform.  The python itself (version 2.6.x) is set <a href="http://www.python.org/download/">from here</a> .  As a development environment, I really liked PyDev.  We put <a href="http://www.eclipse.org/downloads/">Eclipse</a> (if not yet) and from under it we put <a href="http://pydev.org/download.html">PyDev</a> <br><br><h3>  Algorithm </h3><br>  I will not comment block by block, there are a lot of comments in the code, besides, it is not so big as to not put it in one block.  Short: <br><ul><li>  In the main loop, a request is sent to the Bing API and the image.offset parameter is increased until either the required number of images is typed, or the Bing API does not show that the results are over. </li><li>  Each request asks for 8 pictures (stopped at this size, 4 is too small, for 16 it is sometimes long to wait for an answer, maximum 50). </li><li>  For each picture found, the URL is extracted, and a thread is created that downloads the picture to memory and saves it to disk.  Here I ran into a problem - the pictures are very often called the same.  So the save function ‚Äúblocks‚Äù the remaining threads, and adds to the file name "_" in front, until it turns out that there is no such file yet.  Next, save and unlock. </li></ul><br><br><h3>  Code </h3><br><blockquote><code><font color="#408080"><em># import used libraries</em></font> <br> <font color="#008000"><strong>import</strong></font> <font color="#0000FF"><strong>urllib</strong></font> <font color="#666666">,</font> <font color="#0000FF"><strong>json</strong></font> <font color="#666666">,</font> <font color="#0000FF"><strong>sys</strong></font> <font color="#666666">,</font> <font color="#0000FF"><strong>os</strong></font> <font color="#666666">,</font> <font color="#0000FF"><strong>threading</strong></font> <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">load_url</font> (url, filename, filesystem_lock): <br> <font color="#008000"><strong>try</strong></font> : <br> <font color="#408080"><em># open connection to URL</em></font> <br> socket <font color="#666666">=</font> urllib <font color="#666666">.</font> urlopen(url) <br> <font color="#408080"><em># read data</em></font> <br> data <font color="#666666">=</font> socket <font color="#666666">.</font> read() <br> <font color="#408080"><em># close connection</em></font> <br> socket <font color="#666666">.</font> close() <br> <font color="#408080"><em># on all exceptions</em></font> <br> <font color="#008000"><strong>except</strong></font> : <br> <font color="#008000"><strong>print</strong></font> <font color="#BA2121">"error loading"</font> , url <br> <font color="#408080"><em># if no exceptions</em></font> <br> <font color="#008000"><strong>else</strong></font> : <br> <font color="#408080"><em># save loaded data</em></font> <br> save_to_file(data, filename, filesystem_lock) <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">save_to_file</font> (data, filename, filesystem_lock): <br> <font color="#408080"><em># wait for file system and block it</em></font> <br> filesystem_lock <font color="#666666">.</font> acquire() <br> <font color="#008000"><strong>try</strong></font> : <br> <font color="#408080"><em># while already have file with this name</em></font> <br> <font color="#008000"><strong>while</strong></font> os <font color="#666666">.</font> path <font color="#666666">.</font> isfile(filename): <br> <font color="#408080"><em># append '_' to the beginning of file name</em></font> <br> filename <font color="#666666">=</font> os <font color="#666666">.</font> path <font color="#666666">.</font> dirname(filename) <font color="#666666">+</font> <font color="#BA2121">"/_"</font> <font color="#666666">+</font> os <font color="#666666">.</font> path <font color="#666666">.</font> basename(filename) <br> <font color="#408080"><em># open for binary writing</em></font> <br> <font color="#008000"><strong>with</strong></font> <font color="#008000">open</font> (filename, <font color="#BA2121">'wb'</font> ) <font color="#008000"><strong>as</strong></font> f: <br> <font color="#408080"><em># and save data</em></font> <br> f <font color="#666666">.</font> write(data) <br> f <font color="#666666">.</font> close() <br> <font color="#008000"><strong>print</strong></font> filename <br> <font color="#008000"><strong>except</strong></font> : <br> <font color="#008000"><strong>print</strong></font> <font color="#BA2121">"error saving"</font> , filename <br> <font color="#408080"><em># release file system</em></font> <br> filesystem_lock <font color="#666666">.</font> release() <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">main</font> (): <br> <font color="#408080"><em># Bing search URL</em></font> <br> SERVICE_URL <font color="#666666">=</font> <font color="#BA2121">"http://api.search.live.net/json.aspx"</font> <br> <font color="#408080"><em># request parameters dictionary (will append to SERVICE_URL)</em></font> <br> params <font color="#666666">=</font> {} <br> params[ <font color="#BA2121">"appid"</font> ] <font color="#666666">=</font> <font color="#BA2121">"4EFC2F2CA1F9547B3C048B40C33A6A4FEF1FAF3B"</font> <br> params[ <font color="#BA2121">"sources"</font> ] <font color="#666666">=</font> <font color="#BA2121">"image"</font> <br> params[ <font color="#BA2121">"image.count"</font> ] <font color="#666666">=</font> <font color="#666666">8</font> <br> params[ <font color="#BA2121">"image.offset"</font> ] <font color="#666666">=</font> <font color="#666666">00</font> <br> <br> <font color="#408080"><em># try to read command line parameters</em></font> <br> <font color="#008000"><strong>try</strong></font> : <br> params[ <font color="#BA2121">"query"</font> ] <font color="#666666">=</font> sys <font color="#666666">.</font> argv[ <font color="#666666">1</font> ] <br> images_count <font color="#666666">=</font> <font color="#008000">int</font> (sys <font color="#666666">.</font> argv[ <font color="#666666">2</font> ]) <br> <font color="#008000"><strong>if</strong></font> <font color="#008000">len</font> (sys <font color="#666666">.</font> argv) <font color="#666666">&gt;</font> <font color="#666666">3</font> : <br> params[ <font color="#BA2121">"image.filters"</font> ] <font color="#666666">=</font> sys <font color="#666666">.</font> argv[ <font color="#666666">3</font> ] <br> <font color="#408080"><em># if have less than 2 parameters (IndexError) or</em></font> <br> <font color="#408080"><em># if second parameter cannot be cast to int (ValueError)</em></font> <br> <font color="#008000"><strong>except</strong></font> ( <font color="#D2413A"><strong>IndexError</strong></font> , <font color="#D2413A"><strong>ValueError</strong></font> ): <br> <font color="#408080"><em># print usage string</em></font> <br> <font color="#008000"><strong>print</strong></font> <font color="#BA2121">"Bing image search tool"</font> <br> <font color="#008000"><strong>print</strong></font> <font color="#BA2121">"Usage: bing.py search_str images_count [filters]"</font> <br> <font color="#408080"><em># end exit</em></font> <br> <font color="#008000"><strong>return</strong></font> <font color="#666666">1</font> <br> <br> <font color="#408080"><em># make directory at current path</em></font> <br> dir_name <font color="#666666">=</font> <font color="#BA2121">"./"</font> <font color="#666666">+</font> params[ <font color="#BA2121">"query"</font> ] <font color="#666666">+</font> <font color="#BA2121">"/"</font> <br> <font color="#008000"><strong>if</strong></font> <font color="#AA22FF"><strong>not</strong></font> os <font color="#666666">.</font> path <font color="#666666">.</font> isdir(dir_name): <br> os <font color="#666666">.</font> mkdir(dir_name) <br> <br> <font color="#408080"><em># list to store loading threads</em></font> <br> loaders <font color="#666666">=</font> [] <br> <font color="#408080"><em># file system lock object</em></font> <br> filesystem_lock <font color="#666666">=</font> threading <font color="#666666">.</font> Lock() <br> <br> <font color="#008000"><strong>try</strong></font> : <br> <br> <font color="#408080"><em># loop for images count</em></font> <br> <font color="#008000"><strong>while</strong></font> (params[ <font color="#BA2121">"image.offset"</font> ] <font color="#666666">&lt;</font> images_count): <br> <br> <font color="#408080"><em># combine URL string, open it and parse with JSON</em></font> <br> response <font color="#666666">=</font> json <font color="#666666">.</font> load(urllib <font color="#666666">.</font> urlopen(SERVICE_URL <font color="#666666">+</font> <font color="#BA2121">"?</font> <font color="#BB6688"><strong>%s</strong></font> <font color="#BA2121">"</font> <font color="#666666">%</font> urllib <font color="#666666">.</font> urlencode(params))) <br> <font color="#408080"><em># extract image section</em></font> <br> images_section <font color="#666666">=</font> response[ <font color="#BA2121">"SearchResponse"</font> ][ <font color="#BA2121">"Image"</font> ] <br> <br> <font color="#408080"><em># if current search offset greater or equal to returned total files</em></font> <br> <font color="#008000"><strong>if</strong></font> <font color="#BA2121">"Total"</font> <font color="#AA22FF"><strong>not</strong></font> <font color="#AA22FF"><strong>in</strong></font> images_section <font color="#AA22FF"><strong>or</strong></font> params[ <font color="#BA2121">"image.offset"</font> ] <font color="#666666">&gt;=</font> images_section[ <font color="#BA2121">"Total"</font> ]: <br> <font color="#408080"><em># then break search loop</em></font> <br> <font color="#008000"><strong>break</strong></font> <br> <br> <font color="#408080"><em># extract image results section</em></font> <br> results <font color="#666666">=</font> images_section[ <font color="#BA2121">"Results"</font> ] <br> <font color="#408080"><em># loop for results</em></font> <br> <font color="#008000"><strong>for</strong></font> result <font color="#AA22FF"><strong>in</strong></font> results: <br> <font color="#408080"><em># extract image URL</em></font> <br> image_url <font color="#666666">=</font> result[ <font color="#BA2121">"MediaUrl"</font> ] <br> <font color="#408080"><em># create new loading thread</em></font> <br> loader <font color="#666666">=</font> threading <font color="#666666">.</font> Thread(\ <br> target <font color="#666666">=</font> load_url,\ <br> args <font color="#666666">=</font> (\ <br> image_url,\ <br> dir_name <font color="#666666">+</font> os <font color="#666666">.</font> path <font color="#666666">.</font> basename(str(image_url)),\ <br> filesystem_lock)) <br> <font color="#408080"><em># start loading thread</em></font> <br> loader <font color="#666666">.</font> start() <br> <font color="#408080"><em># and add it to loaders list</em></font> <br> loaders <font color="#666666">.</font> append(loader) <br> <font color="#408080"><em># advance search offset</em></font> <br> params[ <font color="#BA2121">"image.offset"</font> ] <font color="#666666">+=</font> <font color="#666666">1</font> <br> <font color="#408080"><em># break if no more images needed</em></font> <br> <font color="#008000"><strong>if</strong></font> params[ <font color="#BA2121">"image.offset"</font> ] <font color="#666666">&gt;=</font> images_count: <br> <font color="#008000"><strong>break</strong></font> ; <br> <br> <font color="#408080"><em># on all exceptions</em></font> <br> <font color="#008000"><strong>except</strong></font> : <br> <font color="#008000"><strong>print</strong></font> <font color="#BA2121">"error occured"</font> <br> <font color="#008000"><strong>return</strong></font> <font color="#666666">1</font> <br> <br> <font color="#408080"><em># wait for all loading threads to complete</em></font> <br> <font color="#008000"><strong>for</strong></font> loader <font color="#AA22FF"><strong>in</strong></font> loaders: <br> loader <font color="#666666">.</font> join() <br> <br> <font color="#408080"><em># all done</em></font> <br> <font color="#008000"><strong>print</strong></font> <font color="#BA2121">"done"</font> <br> <font color="#008000"><strong>return</strong></font> <font color="#666666">0</font> ; <br> <br> <font color="#008000"><strong>if</strong></font> __name__ <font color="#666666">==</font> <font color="#BA2121">'__main__'</font> : <br> status <font color="#666666">=</font> main() <br> sys <font color="#666666">.</font> exit(status) <br></code> </blockquote><h3>  Query examples </h3><br>  To refine the query, you can use <a href="http://msdn.microsoft.com/en-us/library/3af108e9-40ec-4e3a-ace9-36e5a9860297">Bing API filters</a> , separated by a space. <br><ul><li>  <code>bing.py apple 1000</code> - find 1000 pictures for apple. </li><li>  <code>bing.py "obama" 16 "size:large style:graphics face:face"</code> - find 16 portraits of Obama, large in illustration style. </li><li>  <code>bing.py "warhammer wallpaper" 16 "size:width:1280 size:height:1024"</code> - find 16 wallpapers on the topic "warhammer", sizes 1280x1024 </li></ul><br><h3>  Creating single-exe under win32 </h3><br>  To do this, you need py2exe, you can install it <a href="http://sourceforge.net/projects/py2exe/files/">from here</a> .  Next, in the folder with the program, the setup.py file is created with the following contents (the program is in the bing.py file): <br><blockquote> <code><font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>distutils.core</strong></font> <font color="#008000"><strong>import</strong></font> setup <br> <font color="#008000"><strong>import</strong></font> <font color="#0000FF"><strong>py2exe</strong></font> <font color="#666666">,</font> <font color="#0000FF"><strong>sys</strong></font> <font color="#666666">,</font> <font color="#0000FF"><strong>os</strong></font> <br> <br> sys <font color="#666666">.</font> argv <font color="#666666">.</font> append( <font color="#BA2121">'py2exe'</font> ) <br> <br> setup( <br> console <font color="#666666">=</font> [ <font color="#BA2121">'bing.py'</font> ], <br> options <font color="#666666">=</font> { <font color="#BA2121">'py2exe'</font> : { <font color="#BA2121">'bundle_files'</font> : <font color="#666666">1</font> }}, <br> zipfile <font color="#666666">=</font> <font color="#008000">None</font> , <br> ) <br></code> </blockquote><br>  It is launched by the command ‚Äúpython setup.py‚Äù.  As a result of execution, the ‚Äúcompiled‚Äù program appears in the ./dist folder (the w9xpopen.exe file can be erased) <br>  Then you can shake it with <a href="http://upx.sourceforge.net/">UPX</a> (from 5182Kb it‚Äôs down to 4061Kb) <br><br><h3>  What I would like to improve </h3><br><ul><li>  Requests in Russian </li><li>  General progress indicator for all files </li><li>  Download progress for each file </li><li>  Using time-out when trying to download an image (it seems to be minute by default) </li><li>  Normal error handling </li></ul><br><h3>  PS </h3><br>  Strange habra-glitch. <br> <code>&lt;code&gt;&lt;font color="#666666"&gt;0&lt;/font&gt;&lt;/code&gt;</code> <br>  Does not display anything. <br>  Also view links <br> <code>&lt;code&gt;http://api.google.com&lt;/code&gt;</code> <br>  Output without http: // <br><br><h3>  Pps </h3><br>  Compiled exe under Win32 <a href="">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/91012/">https://habr.com/ru/post/91012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91004/index.html">Library of Congress acquires Twitter archive</a></li>
<li><a href="../91005/index.html">Denial of information distributed by Oversan-Mercury</a></li>
<li><a href="../91007/index.html">Netgear DGN3500: a first look at the first in Russia router with ADSL, Gigabit Ethernet and 802.11n support</a></li>
<li><a href="../91009/index.html">Russian startup in The Next Web Startup Rally final</a></li>
<li><a href="../91010/index.html">What project management system do you use in the company?</a></li>
<li><a href="../91013/index.html">"Electronic bracelets" legalized in Russia</a></li>
<li><a href="../91014/index.html">phpDaemon: good news</a></li>
<li><a href="../91015/index.html">IEEE 802.1x + MD5 authorization on OpenWrt</a></li>
<li><a href="../91018/index.html">Repaint the site? Easy!</a></li>
<li><a href="../91019/index.html">StarCraft II: Wings of Liberty - beta testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>