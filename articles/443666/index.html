<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our approach to coloring the flow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We in the company always strive to increase the maintainability of our code using generally accepted practices, including in matters of multithreading...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our approach to coloring the flow</h1><div class="post__text post__text-html js-mediator-article">  We in the company always strive to increase the maintainability of our code using generally accepted practices, including in matters of multithreading.  This does not solve all the difficulties that the ever-increasing workload brings, but it simplifies the support - the readability of the code and the speed of developing new features gains. <br><br>  We now have 47,000 users daily, about 30 servers in production, 2,000 API requests per second and daily releases.  The Miro service has been developing since 2011, and in the current implementation, user requests are processed in parallel by a cluster of heterogeneous servers. <br><br><img src="https://habrastorage.org/webt/al/ef/z0/alefz0rg731nodv93vg78p2hvsa.png"><br><a name="habracut"></a><br><h2>  Competitive Access Management Subsystem </h2><br>  The main value of our product - collaborative custom boards, so the main burden falls on them.  The main subsystem that controls most of the competitive access is the stateful system of user sessions on the board. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For each board being opened on one of the servers, a status is raised.  It stores both application runtime data required for collaboration and content display, as well as system data, such as binding to processing threads.  Information on which server the state is stored in is written into the distributed structure and is available to the cluster as long as the server is running and at least one user is on the board.  We use Hazelcast to make this part of the subsystem work.  All new connections to the board are sent to the server with this status. <br><br>  When connecting to the server, the user enters the receiving stream, the only task of which is to bind the connection to the state of the corresponding board, in the streams of which all further work will occur. <br><br>  There are two threads associated with the board: the network, processing connections, and the ‚Äúbusiness‚Äù one, which is responsible for the business logic.  This allows you to turn the performance of heterogeneous tasks of processing network packets and executing business commands from serial to parallel.  Processed network commands from users form applied business tasks and direct them to the business flow, where they are processed sequentially.  This allows you to avoid unnecessary synchronization in the development of application code. <br><br>  Dividing the code into business / application and system is our internal convention.  It allows you to distinguish between the code responsible for the features and capabilities for users, from the low-level details of communication, sheduling and storage, which are serving tools. <br><br>  If the receiving thread detects that there is no state for the board, the corresponding initialization task is set.  The initialization of the state is handled by a separate stream type. <br><br>  Task types and their direction can be represented as follows: <br><br><img src="https://habrastorage.org/webt/tu/77/0l/tu770l4w53i7wewueqtoytcvdfc.png"><br><br>  This implementation allows us to solve the following problems: <br><br><ol><li>  There is no business logic in the receiving thread that could slow down a new connection.  This type of stream on the server exists in a single copy, so the delays in it immediately affect the time of opening the boards, and if an error occurs in the business code, it can be easily hung up. </li><li>  The state initialization is not performed in the business flow of the boards and does not affect the processing time of business commands from users.  It may take some time, and business streams process several boards at once, so the opening of new boards does not directly affect already working ones. </li><li>  Network command parsing is often faster than direct execution, so the configuration of a pool of network streams may be different from the configuration of a pool of business flows in order to use system resources efficiently. </li></ol><br><h2>  Coloring pages </h2><br>  The subsystem described above in the implementation is quite nontrivial.  The developer has to keep in mind the scheme of the system and take into account the reverse process of closing the boards.  When closing, it is necessary to remove all subscriptions, delete entries from the registry and do it in the same threads in which they were initialized. <br><br>  We noticed that the bugs and complexities of code modification that arose in this subsystem were often associated with a lack of understanding of the execution context.  Juggling with threads and tasks made it difficult to answer the question in which thread a particular code section was executed. <br><br>  To solve this problem, we used the flow coloring method ‚Äî this is a policy aimed at regulating the use of flows in the system.  Threads are assigned colors, and methods define the framework for execution within threads.  The color here is an abstraction, it can be any entity, for example, an enumeration.  In Java, annotations can serve as color markup: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Color</span></span> <span class="hljs-meta"><span class="hljs-meta">@IncompatibleColors</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyColor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Grant</span></span> <span class="hljs-meta"><span class="hljs-meta">@Revoke</span></span></code> </pre> <br>  Annotations are added to the method, using them you can set the validity of the method.  For example, if the annotation of the method allows yellow and red color, then the first stream can call the method, and for the second such call will be erroneous. <br><br><img src="https://habrastorage.org/webt/cv/rt/5x/cvrt5xki24dz6q26dbgitgr1t70.png"><br><br>  You can specify invalid colors: <br><br><img src="https://habrastorage.org/webt/td/zo/cz/tdzoczjxi31awdahg6q0pz_i0ck.png"><br><br>  You can dynamically add and remove thread privileges: <br><br><img src="https://habrastorage.org/webt/ef/tc/o_/eftco_jb_yduvaqnbss7usmpdro.png"><br><br>  The absence of annotation or annotation as in the example below says that the method can run in any stream: <br><br><img src="https://habrastorage.org/webt/9o/_7/h5/9o_7h5adpnmvctotkxwaavzhpdm.png"><br><br>  Android developers may be familiar with this approach from the annotations of MainThread, UiThread, WorkerThread, etc. <br><br>  In the coloring of streams, the principle of self-documentation of the code is used, and the method itself lends itself well to static analysis.  Using static analysis, you can say before the execution of the code whether it was written correctly or not.  If we exclude the Grant and Revoke annotations and assume that the stream already has an immutable set of privileges during initialization, this will be a flow-insensitive analysis ‚Äî a simple version of static analysis that does not take into account the order of calls. <br><br>  At the time of introducing the method of coloring streams in our devops-infrastructure there were no ready-made solutions for static analysis, so we went in a simpler and cheaper way - we introduced our own annotations, which are uniquely associated with each type of streams.  We began to check their correctness using aspects in runtime. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Aspect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThreadAnnotationAspect</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Pointcut</span></span>(<span class="hljs-string"><span class="hljs-string">"if()"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isActive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment">//   ,    . , ,    } @Pointcut("execution(@ThreadAnnotation * *.*(..))") public static void annotatedMethod() { } @Around("isActive() &amp;&amp; annotatedMethod()") public Object around(ProceedingJoinPoint joinPoint) throws Throwable { Thread thread = Thread.currentThread(); Method method = ((MethodSignature) jp.getSignature()).getMethod(); ThreadAnnotation annotation = getThreadAnnotation(method); if (!annotationMatches(annotation, thread)) { throw new ThreadAnnotationMismatchException(method, thread); } return jp.proceed(); } }</span></span></code> </pre><br>  For aspects, we use the aspectj library and the maven plugin, which weaving while compiling the project.  Initially weaving was configured to load-time when loading classes with a ClassLoader.  However, we were faced with the fact that weaver sometimes incorrectly behaved with competitive loading of the same class, as a result of which the source code of the class remained unchanged.  In the end, this resulted in a very unpredictable and difficult to reproduce behavior in production.  Perhaps in the current versions of the library there is no such problem. <br><br>  The solution on aspects allowed us to quickly find most problems in the code. <br><br>  It is important not to forget to always keep the annotations up to date: you can delete them, add some laziness, weaving aspects can be turned off altogether - in this case the coloring will quickly lose its relevance and value. <br><br><h2>  GuardedBy </h2><br>  One of the varieties of coloring includes the abstract GuardedBy from java.util.concurrent.  It differentiates access to fields and methods, indicating which locks are necessary for correct access. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PrivateLock</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object lock = Object(); <span class="hljs-meta"><span class="hljs-meta">@GuardedBy</span></span> (‚Äúlock‚Äù) Widget widget; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (lock) { <span class="hljs-comment"><span class="hljs-comment">//Access or modify the state of widget } } }</span></span></code> </pre><br>  Modern IDEs even support the analysis of this annotation.  For example, IDEA gives the following message if something is wrong in the code: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w1/d_/lg/w1d_lgkgbtnsueqjd6lnva0gsto.png"></div><br>  The threading method itself is not new, but it seems that in languages ‚Äã‚Äãsuch as Java, where often multi-threaded access goes to mutable objects, using it not only as part of documentation, but also at the compilation stage, assembly could greatly simplify the development of multi-threaded code. <br><br>  We still use implementation on aspects.  If you are familiar with a more elegant solution or analysis tool that improves the resilience of this approach to changing the system, please share it in the comments. </div><p>Source: <a href="https://habr.com/ru/post/443666/">https://habr.com/ru/post/443666/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443654/index.html">In the wake of calculators: Qalculate</a></li>
<li><a href="../443658/index.html">Setting up a Kubernetes HA cluster on bare metal, monitoring, logs and usage examples. Part 3/3</a></li>
<li><a href="../443660/index.html">Experts: "3D-scanner will cost 10 times cheaper than the error in the traditional quality control"</a></li>
<li><a href="../443662/index.html">Understanding Clean Code in Android</a></li>
<li><a href="../443664/index.html">Weather Station Arduino</a></li>
<li><a href="../443670/index.html">Error in new version of Google Chrome (73.0.3683.75)</a></li>
<li><a href="../443672/index.html">Risk based testing</a></li>
<li><a href="../443674/index.html">Anonymous prepaid cards - how, to whom and why?</a></li>
<li><a href="../443676/index.html">Vinyl instead of a postage stamp: an unusual rarity</a></li>
<li><a href="../443678/index.html">Code readability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>