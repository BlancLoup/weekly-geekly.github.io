<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bluetooth mesh - the basic components of the network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the topic of the bluetooth mesh network, the announcement and key components of which was written in this article , to understand its topol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bluetooth mesh - the basic components of the network</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/632/7db/fa8/6327dbfa808a46e7b14330a28844f559.png" alt="image"></div><br>  Continuing the topic of the bluetooth mesh network, the announcement and key components of which was written <a href="https://habrahabr.ru/post/333792/">in this article</a> , to understand its topology, we will look at the main set of technical terms and concepts that were previously absent in the world of Bluetooth LE. <br><br>  Who cares, welcome ... <br><a name="habracut"></a><br>  Most BLE devices communicate with each other using a simple point-to-point (p2p) network topology that allows one-to-one communication, which in the Bluetooth core specification is called <i>‚Äúpiconet‚Äù</i> . <br><br>  Imagine a smartphone that has established a point-to-point connection with a heart rate monitor and receives heart rate data from the latter.  Since the Bluetooth specification allows devices to establish several connections at the same time, the same smartphone, already having a p2p connection with a heart rate monitor, can establish another connection of the same type with another device, such as an activity tracker.  In this case, the smartphone can directly communicate with each of these other devices, but the devices themselves cannot directly communicate with each other. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unlike p2p, a mesh network allows each device to communicate with any other device on the network.  Communication is carried out by sending messages, and the devices can both transmit and relay these messages to other devices, thus increasing the communication range far beyond the radio range of each individual node. <br><br><h3>  Devices and nodes </h3><br>  Suppose you have purchased a Bluetooth mesh chandelier.  In order to control it using switches that also use a Bluetooth mesh, the chandelier must first be made part of your mesh network, that is, ‚Äúprepare‚Äù.  In this context, new terms have appeared: <br><br><ul><li>  <i><b>A</b></i> Node is a device that is part of a mesh network. </li><li>  Unprovisioned device (Unprovisioned device) - a device that is not part of the network. </li><li>  <b><i>‚Äú</i></b> Provisioning‚Äù is the process of entering an unprepared device into the network, after which the device will become a node.  These are certain actions in the context of network security, which lead to the device, exchanging a certain set of encryption keys with a device that has the function of registration in the network, to become a member of the network.  A device with network registration is usually a tablet or smartphone.  One of the encryption keys is called a ‚Äúnetwork key‚Äù or, briefly, <i>‚ÄúNetKey‚Äù</i> . <br></li></ul><br>  All nodes of a mesh network have at least one ‚ÄúNetKey‚Äù and the presence of such a key makes the device a member of the network, that is, a node.  There are other requirements that must be met before the node becomes useful, but the secure creation of a ‚ÄúNetKey‚Äù using the initialization process is the first and basic step.  The initialization process will be discussed in more detail below. <br><br><h3>  Items </h3><br><img src="https://habrastorage.org/web/05b/327/756/05b327756d5f4153928ca6efc5b1a405.png" alt="image" align="left">  Some nodes can consist of several parts, each of which can be controlled independently.  In Bluetooth mesh terminology, these parts are called Elements.  The figure on the left shows the LED chandelier, which, when added to the network, is a single <i>node</i> with three <i>elements</i> and each of the elements is an individual light source. <br><br><br><h3>  Messages </h3><br>  If a node needs to request the status of other nodes or, in some way, manage other nodes, it sends a message of a certain type.  If a node must communicate its status to other nodes, it also sends a message.  Thus, the mesh network is based on messages, and many types of messages have already been defined, each of which has its own unique opcode. <br><br>  Messages are divided into 2 categories: <br><br><ul><li>  <i><b>Confirmed</b></i> : messages that imply a response from the nodes, received messages.  Answering, the node confirms that the message was received and returns some data to the sender.  The sender of the acknowledged message can re-send the message if it does not receive the expected response.  That is, the value of a confirmed message arriving at a node several times will be the same as the one that would have been received when sent only once ( <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B4%25D0%25B5%25D0%25BC%25D0%25BF%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">idempotent</a> ). </li><li>  <i><b>unconfirmed</b></i> : messages that do not require a response. </li></ul><br><h3>  Addresses </h3><br>  Messages must be sent from and to the address.  The Bluetooth network has three types of addresses: <br><br><ul><li>  <b><i>unicast</i></b> (individual address): uniquely identifies a single network element.  This type is assigned to the device during the initialization process. <br><br></li><li>  <b><i>multicast</i></b> : represents one or more network elements.  Group addresses are defined by a Bluetooth SIG called ‚ÄúSIG Fixed Group Addresses‚Äù or can be assigned dynamically.  The Bluetooth SIG will identify 4 fixed address groups: ‚ÄúAll-proxies‚Äù, ‚ÄúAll-friends‚Äù, ‚ÄúAll-Relays‚Äù and ‚ÄúAll-nodes‚Äù.  More will be described below.  Dynamic group addresses can be set by the user using the configuration application.  If, for example, dynamic group addresses reflect the physical configuration of a building, then you can define groups of addresses that correspond to each room in the building. <br><br></li><li>  <b><i>virtual address</i></b> : an address that can be assigned to one or more elements covered by one or several nodes.  It has a 128-bit unique identifier (UUID).  Virtual addresses are likely to be generated during device production. </li></ul><br><h3>  Publications and Subscriptions </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/web/04c/193/bae/04c193bae2124568a07fcaa12a918f1d.PNG" alt="image"></div><br>  Publish is the action to send a message. <br>  <b>Subscribe</b> is the selection of specific messages for processing sent to specific addresses. <br><br>  As a rule, messages are addressed to a group of addresses or a virtual address. <br><br>  In the figure above, we see that the node "Switch 1" is published for the group address "Kitchen".  Each of the nodes "Lamp 1", "Lamp 2" and "Lamp 3" is subscribed to the address "Kitchen" and, therefore, receive and process messages published for this address.  In other words, "Lamp 1", "Lamp 2" and "Lamp 3" can be turned on or off with the help of "Switch 1". <br><br>  ‚ÄúSwitch 2‚Äù is published for the dining room group address.  And at this address is only signed "Lamp 3".  It is the only one controlled by Switch 2.  This example illustrates the fact that nodes can subscribe to messages addressed to more than one individual address.  It shows the flexibility of the network.  Notice how both nodes "Switch 5" and "Switch 6" are published for the same address: "Garden". <br><br>  Using group and virtual addresses with the publisher-subscriber model has the added advantage that removing, replacing, or adding new nodes to the network does not require reconfiguration of other nodes.  Imagine what to do when adding a new light source, say, to the dining room: a new device will be added to the network using the preparation process and will set up a subscription to the Dining Room address, and these changes will not affect other nodes.  "Switch 2" as before, will publish messages for the "Dining Room", but now it will react as "Lamp 3", and the new lamp. <br><br><h3>  States and Properties </h3><br>  Elements of the network can be in different states and these states are represented in the network by the concept of ‚Äústate value‚Äù. <br><br>  <b>A state</b> is a value of a certain type contained within an element (within the server model - see below).  As an example, consider a light bulb that can be turned on or off.  In the bluetooth network, the state " <i>Generic OnOff</i> " is <i>defined</i> .  A lamp with this status with the value ‚Äú <i>On</i> ‚Äù will be on, and in the state with the value ‚Äú <i>Off</i> ‚Äù it will not naturally burn. <br><br>  <b>Properties are</b> similar to states, as they contain certain values ‚Äã‚Äãrelated to the element.  But they are significantly different from the states of other signs.  Those who are familiar with BLE are aware of the concept of a ‚Äúcharacteristic of a service‚Äù (something that represents data types in which some values ‚Äã‚Äãdefine the service metadata).  So the " <i>property</i> " provides the context for interpreting the characteristic. <br><br>  To appreciate the importance of using the context, consider, for example, the ‚ÄúTemperature 8‚Äù characteristic ‚Äî an 8-bit type of temperature state that has a number of properties associated with it, including the current internal ambient temperature and the existing outdoor ambient temperature.  These two properties allow the sensor to publish readings so that the receiving client can determine the context that has a temperature value. <br><br>  Properties are divided into two categories: <br><br><ul><li>  <b>category of manufacturer</b> (device): properties can only be read; </li><li>  <b>administrator category</b> : properties have read and write access. </li></ul><br><h3>  Messages, statuses and properties </h3><br>  Any particular type of message is an operation with a state or a collection of several state values.  All messages have three main types, reflecting the types of operations supported by the Bluetooth network: <br><br><ul><li>  <b>GET</b> messages request the value of the current state from one or more nodes.  In response, a message is sent with the STATUS type and contains the corresponding status value. </li><li>  <b>SET</b> messages change the value of a particular state.  Sending a confirmed message of this type requires a response message with the STATUS type, whereas an unconfirmed SET message does not require a response. </li><li>  <b>STATUS</b> messages are sent in response to GET messages, confirmed SET messages, or independently of other messages, for example, controlled by a timer running inside the element that sends the message. </li></ul><br><h3>  Models </h3><br>  <b>A model</b> is a combination of concepts that defines the functionality of an element that is in a network.  Identified 3 categories of models. <br><br><ul><li>  <b>Server model</b> : defines a set of states, state transitions, state bindings, and messages that an element containing this model can send or receive.  This model also defines the behavior associated with messages, states and state transitions. <br><br></li><li>  <b>Client model</b> : does not define any states, but defines messages that can be sent or received. <br><br></li><li>  <b>Management Model</b> : combines a server model in itself that allows you to exchange data with other client models with a client model that allows you to communicate with server models. </li></ul><br>  Models can be created by extending other models.  Models are immutable, which means that they cannot be changed by adding or removing behavior.  The correct and only acceptable approach to adding new model requirements is to extend the existing one. <br><br><h3>  Generalizations </h3><br>  Many different types of devices often have similar states, an example of which is the simple idea of ‚Äã‚Äã‚ÄúOn‚Äù - ‚ÄúOff‚Äù, that is, devices that can be turned on or off.  Therefore, the bluetooth network specification defines a set of generalized states, such as " <i>Generic OnOff</i> " and " <i>Generic Level</i> ".  Similarly, a number of generalized messages are defined that work with such states, for example: " <i>Generic OnOff Get</i> " and " <i>Generic Level Set</i> ".  Generalizations allow the use of a wide range of device types without the need to create new models. <br><br><img src="https://habrastorage.org/web/11c/46d/4ed/11c46d4ed6af4734b9ae46cb0218c2ac.PNG" alt="image"><br><br><h3>  Scenes </h3><br>  A scene is a saved collection of states that can be called or made current when a special type of message is received or at a specific time.  Scenes are identified using the 16-bit scene number " <i>Scene Number</i> ", which is unique in the mesh network.  Scenes allow you to set a number of nodes in a given set of previously saved, complementary states in one coordinated action. <br><br>  Imagine: You want the temperature in the room to be 23 degrees in the evening, six lamps in the chandelier shine with a certain brightness, and the lamp on the table was set to a pleasant warm yellow hue.  After you have manually set the nodes to these states, you can save these states as a scene using the configuration application and later invoke this scene upon request by sending an appropriate message associated with the scene or invoke it automatically at a scheduled time. <br><br><h3>  Initialization </h3><br>  Provisioning, as mentioned earlier, is the process by which a device connects to a mesh network and becomes a node.  The process involves several steps, leads to the creation of various security keys and is in itself a secure process.  Initialization is carried out using an application on the device, such as, for example, a tablet.  The device used to control the initialization process is called the " <i>Provisioner</i> ".  The preparation process consists of five steps, described below. <br><br><ol><li>  " <b>I am a beacon</b> " (Beaconing).  To support various functions of the bluetooth network, new types of GAP profile (GAP AD) advertizing have been added, in particular the ‚ÄúMesh Beacon‚Äù type AD.  An unprepared device indicates its availability on the air using this type in advertizing packets.  In order for the device to start transmitting such data, the user may need to force the device into this mode, for example, by pressing a combination of buttons or holding the button for a certain period of time. <br><br></li><li>  <b>Invitation</b> .  At this stage, the device used to control the initialization process sends an invitation.  The Beacon device, in response to an invitation, sends information about itself. <br><br></li><li>  <b>Exchange of public keys</b> .  Both devices exchange their public keys either directly or using the out-of-band method. <br><br></li><li>  <b>Authentication</b> .  At this stage, the device that is supposed to enter the network in one form or another displays a random number to the user.  The user enters this number into the control device, after which a certain exchange of encrypted data takes place between the two devices.  The result of this exchange is a mutual confirmation of the authenticity of the two devices. <br><br></li><li>  <b>Submission of the data provided</b> .  After authentication is completed, a session key is created that is used to secure the subsequent exchange of data necessary to complete the initialization process, including the generation of the ‚ÄúNetKey‚Äù security key.  After completion of the initialization, the prepared device becomes the owner <br><ul><li>  network key "NetKey"; </li><li>  network security parameter, referred to as the ‚ÄúIV index‚Äù (IV Index); </li><li>  address unicast, dedicated control device. </li></ul><br></li></ol><br>  After which the device becomes a node. <br><br><h3>  Special features </h3><br>  All network nodes can transmit and receive messages from this network, but there are a number of additional functions that a node may have.  A node may not support, support some or all of these additional functions, and any supported function may at some point be turned on or off. <br>  We list these functions: <br><br><ul><li>  <b>Relay</b> : Relay nodes.  Nodes that support the relay function, called relay nodes, can retransmit received messages.  Relaying is a mechanism by which a message can move across the entire network, making several ‚Äúhops‚Äù between devices by means of relay.  The network PDU includes a field called TTL (Time To Live).  It takes an integer value and is used to limit the number of hops.  For example, if the TTL is 3, then a message will be transmitted using 3 ‚Äúhops‚Äù from the source node.  Setting the TTL to 0 will result in the value not being retransmitted, but moving in the area of ‚Äã‚Äãone hop.  Thus, nodes can use the TTL field to more efficiently use the mesh network. <br><br></li><li>  <b>Low Power</b> : <b>Low power</b> nodes.  Some nodes that have power limitations should save energy as much as possible.  In addition, devices of this type can be mainly related to sending messages, but sometimes they have to receive messages.  Take a temperature sensor that is powered by a battery the size of a coin.  It sends temperature readings once per minute, in case the temperature exceeds the set upper and lower thresholds.  If the temperature remains within these thresholds, then the sensor does not send any messages.  This behavior is easily implemented without any special problems associated with energy consumption.  At the same time, the user can send a message to this sensor, which changes the state values ‚Äã‚Äãof the thresholds.  Such an event can occur very rarely, but the sensor must support it.  If the sensor does not skip any messages, it will have increased power consumption, and you can skip configuration messages while saving energy.  For such cases, there is the concept of friendship and the function of a site called ‚ÄúFriend‚Äù.  Nodes, such as a temperature sensor in this example, can be labeled as low energy consuming (LPN) nodes, and in the sensor configuration there will be a function flag denoting the node as such.  An LPN node operates in tandem with another node that does not have power limitations (for example, having a constant AC power source).  This device is called the ‚ÄúFriend‚Äù node. <br><br></li><li>  <b>Friend</b> : Node is a friend.  A node with this function stores messages addressed to the LPN node and delivers them to the LPN whenever the LPN polls a friend about "waiting messages".  An LPN may ask a friend relatively rarely, but so as to balance the amount of energy consumed and the frequency of receiving and processing configuration messages.  When executing a request, all messages stored by a friend are sent to the LPN with the ‚ÄúMD‚Äù (More Data) flag (additional data) indicating to the LPN node whether there are additional messages to be sent from the ‚ÄúFriend‚Äù node.  The relationship between the LPN node and the Friend node is called Frienfship. <br><br></li><li>  <b>Proxy</b> : <b>Proxy</b> nodes.  There are a huge number of devices that support BLE in the world, including most smartphones and tablets, but devices released before the Bluetooth mesh network was announced do not support this network stack.  And since they have a BLE stack, these devices have the ability to connect to other devices and interact with them using the GATT (Generic Attribute Profile) profile.  Proxy nodes provide a GATT interface that can be used to interact with a network.  The protocol, called the proxy protocol, is used with GATT and, with its help, the proxy node converts these device PDUs to / from the network PDUs.  Thus, proxy nodes allow BLE devices that do not have a mesh network stack to communicate with nodes of this network. </li></ul><br>  The figure below shows the interaction with the mesh node through a proxy node of this network. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/1d4/9ed/e8b/1d49ede8b13f42a0a74c17e5c938eb24.PNG" alt="image"></div><br>  System architecture, network security and a description of its work in action, we will look at the final part. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/334478/">https://habr.com/ru/post/334478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334466/index.html">How to start the implementation of ERP</a></li>
<li><a href="../334470/index.html">Play with Docker - an online service for practical acquaintance with Docker</a></li>
<li><a href="../334472/index.html">Working with databases in the 3CX Call Flow Designer development environment</a></li>
<li><a href="../334474/index.html">Pygest # 14. Releases, articles, interesting projects from the world of Python [July 18, 2017 - July 31, 2017]</a></li>
<li><a href="../334476/index.html">Association of .NET communities</a></li>
<li><a href="../334482/index.html">I invite you to summer open lectures on the gaming industry at VSBI</a></li>
<li><a href="../334484/index.html">High-Availability Postgres Clustering</a></li>
<li><a href="../334486/index.html">We have long hands: 7 foreign sites where you can find remote work</a></li>
<li><a href="../334488/index.html">Build AngularJs Bundle Apps With Gulp</a></li>
<li><a href="../334490/index.html">Hackathon during working hours</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>