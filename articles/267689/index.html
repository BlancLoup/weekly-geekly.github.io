<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Activity Control with Google reCAPTCHA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1C-Bitrix is ‚Äã‚Äãthe only system in which there is a proactive protection module. It includes: 


1. A proactive filter (Web Application Firewall *) pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Activity Control with Google reCAPTCHA</h1><div class="post__text post__text-html js-mediator-article">  1C-Bitrix is ‚Äã‚Äãthe only system in which there is a proactive protection module.  It includes: <br><ol><li>  <b>A proactive filter (Web Application Firewall *)</b> provides protection against most known attacks on web applications. </li><li>  <b>Web anti-virus</b> - a system to counter site infection. </li><li>  <b>Two-step authorization</b> . </li><li>  <b>File integrity control</b> . </li><li>  <b>Protection of the administrative part</b> with access to it only from certain IP addresses. </li><li>  <b>Session Security</b> </li><li>  <b>Protecting redirects from phishing.</b> </li><li>  <b>Protection against frames.</b> </li><li>  <b>Activity control.</b> </li></ol><br><br>  And today I wanted to dwell on one method of protection: Activity Control. <br><br><blockquote>  Activity control allows you to set protection from overly active users, software robots, certain categories of DDoS attacks, as well as to cut attempts to brute force. </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When activating this protection method, you specify the parameters at which the user's session will be blocked and the record of it will be recorded in the log.  For example, if a user makes 30 hits in 10 seconds, then his session will be blocked, and a report about it will reach the site administrator and instead of the content of your site an error 503 will be displayed with a message that access is denied. <br><br>  But when this protection method is enabled, the situation is not excluded when people, not ‚Äúrobots‚Äù, fall under the lock.  In the standard version, there is no way to remove this block yourself and continue to browse the content of your site, thus we lose users who are disappointed and simply leave the site. <br><a name="habracut"></a><br>  To prevent this from happening, we in our projects used the Google reCAPTCHA technology to check and disable the blocking of users of the site. <br><br>  Currently, Google reCAPTCHA has a very user-friendly interface.  She does not ask you to recognize a text or a number.  This is extremely inconvenient and a lot of errors are possible.  The minimum that Google reCAPTCHA can ask from you is to tick that you are not a robot: <br><br> <a href="http://itmages.ru/image/view/3031540/0e709c54"><img src="https://habrastorage.org/getpro/habr/post_images/fc1/2e7/c3e/fc12e7c3e45d90e6bf3b6a83784341f4.jpg"></a> <br><br>  Or will offer you to choose pictures with an image such as an orange. <br><br> <a href="http://itmages.ru/image/view/3031541/1d0d1130"><img src="https://habrastorage.org/getpro/habr/post_images/422/06a/1bb/42206a1bb09ca25b27a5fe62a4db4300.jpg"></a> <br><br>  Easy and convenient.  But how to include this functionality in your project?  So easy. <br><br>  (Suppose you already have an account on Google, if not, then go to register) <br>  <b>Log in to <a href="http://www.google.com/">www.google.com</a></b> and then follow the link: <a href="https://www.google.com/recaptcha/admin">www.google.com/recaptcha/admin</a> <br><br>  We are offered to register our site in the reCAPTCHA system.  The registration process is quite simple: <br><ol><li>  Specify the name of your site </li><li>  Specify the domains for which reCAPTCHA will be used.  (One domain per line) </li><li>  Specify the owner.  (Here we indicate your account on GMail for example: habrhabr@gmail.com) </li></ol><br><br>  After registration you will be generated 2 keys.  One key will be used to display reCAPTCHA on the site, and the second will be used to check whether the user has passed the test or not. <br><br>  The keys we got goes now to our site. <br><br>  <b>Adjusting the page lock.</b> <br><br>  In the 1C-Bitrix system in the / bitrix / folder there is an activity_limit.php file in which the page template is displayed when the user is blocked.  You can include your own site design in it, or create a new template just for the blocking page.  (we‚Äôll skip the interface preparation stage because everyone will have their own approach to how to design this page) <br><br>  After we have prepared the main interface of the page, we will connect the Google module reCAPTCHA for this into the body of the HTML document before the tag we need to insert the Google JS scripts <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'https://www.google.com/recaptcha/api.js?hl=ru'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  In the body of the document, we add a verification form and indicate our public key in it to form Google reCAPTCHA: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"g-recaptcha"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-sitekey</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-system"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  We intentionally left the action at the form blank so that the sending was executed in the same file. <br><br>  <b>Check and unlock method.</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">"g-recaptcha-response"</span></span>])) <span class="hljs-comment"><span class="hljs-comment">//       { require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php"); //   $request = new \Bitrix\Main\Web\HttpClient(); //  HttpClient //     Google $post = $request-&gt;post("https://www.google.com/recaptcha/api/siteverify", Array( "secret" =&gt; "_", //    Google "response" =&gt; $_REQUEST["g-recaptcha-response"], //    "remoteip" =&gt; $_SERVER["REMOTE_ADDR"] //IP     )); $post = json_decode($post); //   Google if ($post-&gt;success == 'true') //    { $_SESSION["SESS_GRABBER_STOP_TIME"] = ""; //     }else{ //       reCAPTCHA } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><br>  And you can also make a message in the HTML body of the file about the successful completion of the check: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($post-&gt;success == <span class="hljs-string"><span class="hljs-string">'true'</span></span>){<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;h2&gt;,   .&lt;/h2&gt; &lt;a <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">system</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">href</span></span></span><span class="hljs-class">="&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APPLICATION</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetCurPageParam</span></span></span><span class="hljs-class">("", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">array</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recaptcha</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">"))?&gt;"&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">javascript</span></span></span><span class="hljs-class">"&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">document</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addEventListener</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DOMContentLoaded</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">() </span></span>{ window.location.replace(<span class="hljs-string"><span class="hljs-string">'&lt;?=$APPLICATION-&gt;GetCurPageParam("", array("g-recaptcha-response"))?&gt;'</span></span>); window.location.reload(); }); &lt;/script&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>}<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  This page can be enhanced with a code to automatically block the IP address in the event of frequent session blocking to protect against annoying robots. <br><br>  But regardless of whether the user passed the test or not, you will receive a report stating that measures were taken to block his session.  Will provide an opportunity to analyze his latest hits at the moment of blocking and you will have the opportunity, if necessary, to enter his IP address on the block list. <br><br>  I hope my form will help you reduce the number of "robots" on your sites. <br><br>  <b>PS</b> Do not be afraid that search engines will fall under blocking.  For them there are special methods in the system for which the hits of the search engines will not be taken into account and the indexation of your site will not suffer. </div><p>Source: <a href="https://habr.com/ru/post/267689/">https://habr.com/ru/post/267689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267677/index.html">10 common mistakes novice web developers</a></li>
<li><a href="../267679/index.html">How we did the conversation: from the prototype on the hackathon to the application of Yandex</a></li>
<li><a href="../267681/index.html">Why did Apple come up with and introduced in iOS a new font San Francisco?</a></li>
<li><a href="../267683/index.html">Security Week 39: XcodeGhost, D-Link certificate leak, million for a bug on iOS9</a></li>
<li><a href="../267687/index.html">How to improve application localization using glossaries</a></li>
<li><a href="../267691/index.html">Live broadcast Droidcon Moscow 2015</a></li>
<li><a href="../267697/index.html">Command line utilities can be 235 times faster than your Hadoop cluster</a></li>
<li><a href="../267699/index.html">How yoga kodit and live helps: personal experience</a></li>
<li><a href="../267701/index.html">Playing on bare HTML / CSS</a></li>
<li><a href="../267703/index.html">Putting gnome-screenshot from source to change the format of the screenshot file name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>