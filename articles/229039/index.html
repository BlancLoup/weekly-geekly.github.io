<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Log in via Google to Android and check the token on the server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I wanted to create a personal project on an android, and the main question was: how to uniquely identify a user, forcing him to do as little...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Log in via Google to Android and check the token on the server</h1><div class="post__text post__text-html js-mediator-article">  Recently, I wanted to create a personal project on an android, and the main question was: how to uniquely identify a user, forcing him to do as little gestures as possible?  Of course this is a google account.  I tried to try many examples on the network - however, the API was updated several times during its existence, many methods did not work, my questions on Google+ about this were either not perceived by the environment at all, or were like "I have never done this before." <br>  In this article I will try as simple as possible for beginners (like me) to describe my method of logging into Google for android, getting a token and checking this same token on the server. <a name="habracut"></a><br><br><h4>  Little preparation </h4><br>  For starters, you must have Google Play Services installed in the SDK.  After installing them, you can import all the necessary libraries.  The article is written with the expectation of Android Studio - he himself suggests what you need to import. <br>  You must have created an activation with a button. <br>  To make it more familiar to the user, you can create a standard Google+ button Sing-In <br>  It will look like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/801/d61/ca3/801d61ca317daf6a8911837e769d4e80.png" alt="image"><br>  Just add to your layout: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">com.google.android.gms.common.SignInButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/sign_in_button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><br><h4>  Add an action to the button </h4><br>  We write in our activity: <br><pre> <code class="java hljs">View btn = (View) findViewById(R.id.sign_in_button); btn.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ Intent intent = AccountPicker.newChooseAccountIntent(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"com.google"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); startActivityForResult(intent, <span class="hljs-number"><span class="hljs-number">123</span></span>); } });</code> </pre><br>  Actually assign an action to the button - a call to an intend to select an account.  If you are working in Android Studio, it will tell you which libraries you need to import, so I will not describe this in detail here. <br>  startActivityForResult (intent, 123);  - sets the code with which the return will occur.  123 is the return code, it can be anything.  This is necessary when you do multiple indents, and you need to process them in different ways. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Required access areas </h4><br>  Announce these variables in class.  These are the areas of access we need.  The first is written in google: ‚ÄúAllows you to identify an authenticated user.  To do this, when calling an API, you must specify me instead of a Google+ user ID.  ¬ªWe need the second permission to receive personal user data (Name, Last Name, G + page address, avatar), and the last to receive E-mail.  I found this important, because it is quite a constant identifier for writing to the database. <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String G_PLUS_SCOPE = <span class="hljs-string"><span class="hljs-string">"oauth2:https://www.googleapis.com/auth/plus.me"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String USERINFO_SCOPE = <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/userinfo.profile"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String EMAIL_SCOPE = <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/userinfo.email"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String SCOPES = G_PLUS_SCOPE + <span class="hljs-string"><span class="hljs-string">" "</span></span> + USERINFO_SCOPE + <span class="hljs-string"><span class="hljs-string">" "</span></span> + EMAIL_SCOPE;</code> </pre><br><br><h4>  Register our application. </h4><br>  Originally forgot this item - correct. <br>  We need to go to <a href="https://code.google.com/apis/console/">code.google.com/apis/console</a> to create a project there, go to Credentials and create a new OAuth Client ID by selecting Installed Application -&gt; Android.  There we need to enter the name of our package and the SHA1 amount of our key. <br>  With this, I actually had a lot of problems solved in quite a crutch way. <br>  I found debug.keystore in% USERPROFILE% \. Android \ debug.keystore placed it in the project folder and put it in build.grandle: <br><br><pre> <code class="bash hljs"> signingConfigs { debug { storeFile file(<span class="hljs-string"><span class="hljs-string">"debug.keystore"</span></span>) } myConfig { storeFile file(<span class="hljs-string"><span class="hljs-string">"debug.keystore"</span></span>) storePassword <span class="hljs-string"><span class="hljs-string">"android"</span></span> keyAlias <span class="hljs-string"><span class="hljs-string">"androiddebugkey"</span></span> keyPassword <span class="hljs-string"><span class="hljs-string">"android"</span></span> } }</code> </pre><br>  Then we need to execute the command: <br>  keytool -exportcert -alias androiddebugkey -keystore ~ ‚Äã‚Äã/ .android / debug.keystore -v -list <br>  The keytool itself can be found in the SDK.  From the output we copy SHA1 into the required field. <br>  As I understand the method is temporary, and for normal operation, you need to create a normal key.  But for testing this is enough. <br><br><h4>  Token receipt code </h4><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestCode == <span class="hljs-number"><span class="hljs-number">123</span></span> &amp;&amp; resultCode == RESULT_OK) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String accountName = data.getStringExtra(AccountManager.KEY_ACCOUNT_NAME); AsyncTask&lt;Void, Void, String&gt; getToken = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncTask&lt;Void, Void, String&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... params)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String token = GoogleAuthUtil.getToken(AcrivityName.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, accountName, SCOPES); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (UserRecoverableAuthException userAuthEx) { startActivityForResult(userAuthEx.getIntent(), <span class="hljs-number"><span class="hljs-number">123</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException ioEx) { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"IOException"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (GoogleAuthException fatalAuthEx) { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"Fatal Authorization Exception"</span></span> + fatalAuthEx.getLocalizedMessage()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String token)</span></span></span><span class="hljs-function"> </span></span>{ reg(token); } }; getToken.execute(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre><br>  Where 123 is your code you entered earlier, where AcrivityName is the name of your activitiv.  Roughly speaking - we feed the functions of obtaining a token, the necessary permissions and the name of the account.  And note - this all happens in the background, after which the resulting token is transferred to the reg function I wrote.  She already sends the token and all the necessary data to the server. <br>  Since I am developing it recently, with exceptions, it‚Äôs still a problem, if you have a suggestion - write in a personal or in a comment. <br><br><h4>  Check the token on the server.  (Php) </h4><br>  I want to pay attention, the token received by us has type Online.  And it works only 10 minutes.  To get an offline token (to work with it longer from the server), refer to this instructions. <a href="https://developers.google.com/accounts/docs/CrossClientAuth">Developers.google.com/accounts/docs/CrossClientAuth</a> <br><pre> <code class="php hljs">$mToken = $_POST[<span class="hljs-string"><span class="hljs-string">'plusToken'</span></span>]; $userinfo = <span class="hljs-string"><span class="hljs-string">'https://www.googleapis.com/oauth2/v1/userinfo?alt=json&amp;access_token='</span></span> . $mToken; $json = file_get_contents($userinfo); $userInfoArray = json_decode($json,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $googleEmail = $userInfoArray[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]; $tokenUserId = $userInfoArray[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>];</code> </pre><br>  Actually we feed the token to googleapis and pick up the received JSON response. <br><br><h4>  Conclusion </h4><br>  Perhaps the code is raw and written quite crookedly.  However, I killed a whole week to find a working solution.  I found this solution here: <a href="http://android-developers.blogspot.ru/2012/09/google-play-services-and-oauth-identity.html">android-developers.blogspot.ru/2012/09/google-play-services-and-oauth-identity.html</a> , although it was not fully operational, much has been added to this article. <br>  Suggestions for improving the article is ready to be heard in a personal or in the comments.  I hope to save some time for beginners. </div><p>Source: <a href="https://habr.com/ru/post/229039/">https://habr.com/ru/post/229039/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229027/index.html">COOLRF: Project News Digest # 2</a></li>
<li><a href="../229029/index.html">Using LaTeX instead of HTML in Habrahabr</a></li>
<li><a href="../229031/index.html">Overview of 7 online software localization services</a></li>
<li><a href="../229035/index.html">Strongly typed incomplete data representation</a></li>
<li><a href="../229037/index.html">LG G Watch became available for purchase on Google Play</a></li>
<li><a href="../229041/index.html">Work with data in mobile applications. Implement offline storage and data synchronization using Microsoft Azure and SQLite</a></li>
<li><a href="../229043/index.html">Centos 7 release released</a></li>
<li><a href="../229045/index.html">Game server on Scala + Akka</a></li>
<li><a href="../229047/index.html">As we in PassportVision interface did</a></li>
<li><a href="../229049/index.html">Anyone can hack Tor for $ 3000</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>