<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Format Analysis: Sound in some games on the Unreal Engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The culture of modifying games originated in ancient times. The earliest I remember is Wolfenstein 3D (1992). If I‚Äôm not mistaken, you could draw your...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Format Analysis: Sound in some games on the Unreal Engine</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/de1/3a8/8e1/de13a88e1f3f407c8b3c16a95bc8c3d1.png"><br><br>  The culture of modifying games originated in ancient times.  The earliest I remember is Wolfenstein 3D (1992).  If I‚Äôm not mistaken, you could draw your cards, and then new enemies, replace textures and sounds.  The main obstacle in modding is the parsing of unknown data formats.  Let us leave the moral aspects of this phenomenon for other resources, and dwell on the technical difficulties that may arise in this difficult task. <br><br>  I have accumulated quite a lot of stories of this kind, from the simplest ones, such as parsing the simplest archive, where many thousands of game files are stored in one file, to replacing 3D models, researching and writing custom audio codecs.  I'll tell you one of them, medium difficulty. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose you have a desire to replace certain phrases in the game, or even to wipe the full dubbing in any language for which the developers did not have enough strength or resources.  It would seem that you just need to record the sound, find where it is in the game, and replace the necessary files.  But it is not always easy, for example, in the latest games from the Batman: Arkham series, the wwise sound engine has been used, which has been integrated into the Unreal Engine for quite some time. <br><br>  I have already come across UEs more than once, but as you know, commercial developers have the ability to completely change any part of the engine code, so almost all games are unique in terms of data structures, and it is always interesting to look for. <br><a name="habracut"></a><br>  First, let's look at the sound files.  They usually lie in the audio folder and are assembled into one big package, with an unexpected .WAD extension (hello DOOM).  If you want, you can even extract all the sounds from it, but it will be several thousand nameless files, and finding something among them will be very problematic, unless you listen to them all ‚Äúmanually‚Äù.  I must say that most often it is easier.  Developers, for their own convenience, leave somewhere a file with a list of phrases.  But this is not the case. <br><br>  It is logical to assume that once the game itself somehow finds the necessary sounds and subtitles for them, it means that this information is somewhere in the files, you just need to find it.  Nowhere in the folders for localization the texts are not found, which means they are scattered on separate levels of the game, as is often the case.  Take for example one of the .upk files with a name that looks like a level and unpack it.  Fortunately, the tools for this are available, even with the source code. <br><br>  Inside, files of the type .RDialogueEvent are quickly detected, in which the texts of phrases in 11 languages ‚Äã‚Äãare visible with the naked eye. <br><br><img src="https://habrastorage.org/files/3e9/70e/31e/3e970e31e409481fbd88b8238c1c246c.png"><br><br>  File names are similar to source sound names.  Great, now it only remains to find a match between them and the sound files.  That's just here and the problems begin.  There are of course identifiers in the audio package.  This is a 30-bit hash, which is always used in wwise for sounds, but unfortunately nowhere among the dialogue files they can not be found.  Everywhere there are only incomprehensible numbers, nothing resembling a sound ID, they would be immediately noticeable.  On the other hand, this is understandable, because the engine is not so simple, and you can not just take and play a sound file in the game.  It is contained in an audio bank, it has many properties that impose various effects, etc. <br><br>  And it turns out that in each folder with a dialogue there is a .akbank file - apparently this is the wwise audio bank. <br><br><img src="https://habrastorage.org/files/b72/45a/bd1/b7245abd13774e4591105a122af7cad3.png"><br><br>  Here he has a lot of identifiers inside, having tried them at random, we find that one of them (highlighted in green) is in the audio package.  If we extract data from this identifier from there, then we will get a certain segment of several sounds coaxed together.  Convert these sounds from the internal wwise format to the usual ogg.  Yes, indeed, in one of them, Batman says: ‚ÄúI don‚Äôt have time for this,‚Äù and they answer him in another file.  And the phrases just correspond to the texts of this particular dialogue. <br><br>  Already not bad!  In principle, this could be stopped: all the dialogues are arranged in folders, for each of them there is a bank with reference to the audio segment.  Of course, we don‚Äôt know where the file is, but cutting a segment into parts, listening to it and putting several phrases into places (there are usually only 3-4 of them in dialogs) can be done manually. <br><br>  But we are not looking for easy ways.  To understand, so to the end.  Check just in case, suddenly the sounds go right in order?  Of course not, they are confused.  Like it or not, somewhere there should be information about the connection of sounds in the segment with the text of the dialogue.  I have been digging in different files for quite a long time, hoping to find something, but everything is useless.  Good.  Once such a thing, unpack all the packages of the game.  This is a few gigabytes, well, nothing, the first time what?  Here are just a complete search for all data of the game also did not give anything.  The only place where there are sound identifiers is the audio bank.  It turns out that the connection goes only through it.  Nothing can be done, you have to climb inside and figure out how it works. <br><br>  Now, for fidelity, we will find some dialogue in the game that can be quickly checked.  After a spectacular introduction with a charming girl reporter and mask show, Batman captures Hugo Strange.  He says a couple of phrases starting with ‚ÄúI feel I should thank you‚Äù, then he leaves, and the game begins.  This is where the first save occurs.  This moment will suit us. <br><br><img src="https://habrastorage.org/files/790/168/2c2/7901682c28de4bfabfc4bbb564bc419d.jpg"><br><br>  Find the villain's phrase in the files.  It appears in the OW_E8_Ch1z_Anim package.  So you can‚Äôt guess right away.  Inside there is only one dialogue, which contains all the beginning of the game.  These are as many as 24 phrases, but perhaps it‚Äôs even good, in the jumble of codes it is easier to find the number 24 than 1 or 2. So, we were going to examine the contents of .akBank <br><br>  The wwise bank format is already partially explored.  Let's hope that this information is enough for our purpose.  Judging by the beginning of the .akbank file, there are 5 audio banks for 5 languages ‚Äã‚Äãin it at once, the first is the INT bank (English) - we'll see it. <br><br><img src="https://habrastorage.org/files/f65/eae/b31/f65eaeb3121b4069a768fdfcc57d04d9.png"><br><br>  First, there is an incomprehensible table after the SRRC header, then quite a lot of zeros (as seen in the last picture), then the BKHD segment, and then the HIRC segment, in which, apparently, there is a description of all audio objects.  In this case, we have 79 of them (0x4F highlighted in green).  According to the description, the objects in the segment go one after another, for each type is indicated (1 byte), then 32-bit length, and ID.  The length and content of the object varies depending on the type. <br><br><img src="https://habrastorage.org/files/b78/03e/217/b7803e21719c4556bc8f573af14adca4.png"><br><br>  Objects type 2 are the sounds themselves.  The type is highlighted in red, length - in yellow.  Each of them contains the ID of the object itself (green) and the ID of the sound file (purple) where it is contained.  Below you can see the beginning of the next object of the same type. <br><br><img src="https://habrastorage.org/files/f12/2ff/25a/f122ff25a257411aa6a346fce844986b.png"><br><br>  Objects 3 are sound actions, it looks like each of them is ‚Äúplaying sound‚Äù, with some unknown parameters, but each of them has its own ID (gray) and sound ID that you actually need to play (green). <br><br>  Objects 4 - sound events.  Very short entries, in which there is only that event ID (blue), and also indicates that it contains only one action, and the ID of this action itself (gray). <br><br>  Well, it looks like we have 24 chains of events of the following type: <br><br>  event -&gt; action -&gt; sound <br><br>  They are linked by identifiers, and end up with links to sound files.  How to find the necessary files?  Looking for these codes, we find them just in the very table at the beginning of the bank.  Apparently this is a table in which it is recorded, where there are separate sounds inside the sound segment.  And indeed, there are just 24 elements in it, and for each file is indicated the same ID that we had in the sound object, an offset from the beginning, and a length.  Congratulations!  Now we have a complete connection from audio events in banks to individual sound files: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/60b/524/8e0/60b5248e08d94740b881403accf84496.png"></div><br><br>  To have as source data we have the ID of several events, one for each phrase of the dialogue, and for each of them we can find a sound file.  But how to connect them now with the dialogue itself? <br><br>  Let's try to look for these identifiers somewhere.  There are no dialogs in the files again.  There are some very short .akevent files in the folder - there are 24 of them too.  Obviously, these are audio event files.  There are some small numbers inside, they are all the same, no use for them.  The only thing that is different there is the id of the audio events we found in the bank. <br><br><img src="https://habrastorage.org/files/736/726/436/736726436c52456cb127df41e7703ec6.png"><br><br>  Again a dead end: there are identifiers for all events, but there is no connection between them and the text of the dialogue!  Just in case, we will do a test: change the ID in the desired file and start the game.  Yes, indeed, Hugo opens his mouth, but says nothing.  So this is exactly the data for which the game finds the desired sound.  At the same time, we note that the subtitle is still shown.  So the texts of the dialogues in our case are primary, but the sound is already coming from them. <br><br>  And here I remember that the UE3 engine has a habit of referring to package objects through their sequence number inside the package, that is, directly as they are packed inside it.  Let's look at the export file that is generated when unpacking packages: <br><br><img src="https://habrastorage.org/files/4c9/11e/f9b/4c911ef9b5ad4c16b0dc83b018e51423.png"><br><br>  The numbers here are decimal, and start from zero, in the game they start from 1, so it turns out that the event files in the export are numbered 0x35-0x4.  Let's see if they are somewhere among the dialogues.  We start to look - and it‚Äôs necessary, right at the beginning of the file there is this number! <br><br><img src="https://habrastorage.org/files/4aa/c57/f03/4aac57f03adf44bbbbdd4c0a3c71c6a6.png"><br><br>  Here is the last missing link.  At the same time, next to we find 0x2 - this is the number of the bank file.  If suddenly there are several dialogs in the folder, they can also be distinguished.  Now we fully know how to find the corresponding sound in the text of the dialogue. <br><br><img src="https://habrastorage.org/files/afc/a38/1af/afca381af48046219f6b0d600fd6a0bb.png"><br><br>  Such a rather complex interaction scheme turned out.  It seems that the developers decided not to care about convenience, and simply relied on the internal mechanisms of the engine, which led to this result in this case.  And the cases, as I said, are very different.  The file structure and links between them can be completely different.  Here we have a link to the sound of the dialogue text.  But on the contrary, the primary sound is the sound, and to it the identifier is the text.  Or the event of the script of the game is primary, and links from it go to both sound and text.  It happens that the files are not by name, but by hash.  But in any case, somehow they are all connected, it remains only to find this connection. <br><br>  As a final touch, let's try to check our results.  Find the dialogue file from the phrase ‚ÄúI feel I should thank you‚Äù we need and replace 4B with 4C in it.  We start the game, and our friend Hugo, instead of this phrase, meaningfully says: "I guarantee everyone." <br><br>  Let's leave Batman on this, the study can be considered complete.  In writing, the process looks fast, but in fact, each stage can be accompanied by a long contemplation of 16-digit numbers, without any hope that at some point they will form intelligent chains, and you will understand what they mean.  But sometimes it does happen. </div><p>Source: <a href="https://habr.com/ru/post/257793/">https://habr.com/ru/post/257793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257781/index.html">Vector replacement to sprites - we implant SVG in CSS</a></li>
<li><a href="../257783/index.html">IBM Introduces New Cyber ‚Äã‚ÄãAttack Solution</a></li>
<li><a href="../257787/index.html">Configuring a Pfsense based gateway. Part 1</a></li>
<li><a href="../257789/index.html">But about Sphinx 3.0</a></li>
<li><a href="../257791/index.html">Cisco Company Development History: 1984-2000</a></li>
<li><a href="../257795/index.html">Bitrix24 CRM. Overview</a></li>
<li><a href="../257803/index.html">Another attempt to interest students</a></li>
<li><a href="../257809/index.html">The problem of the two sages. Computer program for solving</a></li>
<li><a href="../257811/index.html">Become a hacker author and get an invite to the PHDays V forum</a></li>
<li><a href="../257813/index.html">Writing Beethoven in Javascript or a bit of MIDI.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>