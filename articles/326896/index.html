<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transfer of intentions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Rust is an elegant language that is somewhat different from many other popular languages. For example, instead of using classes and inheritance, Rust ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transfer of intentions</h1><div class="post__text post__text-html js-mediator-article"><p>  Rust is an elegant language that is somewhat different from many other popular languages.  For example, instead of using classes and inheritance, Rust offers its own type-based type system.  However, I believe that many programmers starting their acquaintance with Rust (like me) are not aware of common design patterns. </p><br><p> In this article, I want to discuss the design pattern of a <em>new type</em> (newtype), as well as the types of <code>From</code> and <code>Into</code> , which help in the type conversion. </p><a name="habracut"></a><br><p>  Let's say you work for a European company that creates great digital thermostats for heaters, ready for use on the Internet of Things.  So that the water in the heaters does not freeze (and thus did not damage the heaters), we guarantee in our software that if there is a danger of freezing, we will pour hot water over the radiator.  Thus, somewhere in our program there is the following function: </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">danger_of_freezing</span></span></span></span>(temp: <span class="hljs-built_in"><span class="hljs-built_in">f64</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">bool</span></span>;</code> </pre> <br><p>  It takes a certain temperature (obtained from the sensors via Wi-Fi) and controls the flow of water accordingly. </p><br><p>  Everything is going fine, the customers are satisfied and not a single heater was hurt in the end.  The management decides to move to the US market, and soon our company finds a local partner who connects its sensors with our wonderful thermostat. </p><br><p>  This is a catastrophe. </p><br><p>  After investigation, it turns out that US sensors transmit temperatures in degrees Fahrenheit, while our software works with degrees Celsius.  The program starts heating as soon as the temperature drops below 3 ¬∞ Celsius.  Alas, 3 ¬∞ Fahrenheit below freezing point.  However, after updating the program, we manage to cope with the problem and the damage amounts to only a few tens of thousands of dollars.  <a href="https://en.wikipedia.org/wiki/Mars_Climate_Orbiter">Others are less fortunate</a> . </p><br><h2 id="novye-tipy">  New types </h2><br><p>  The problem arose from the fact that we used floating-point numbers, meaning something more.  We assigned meaning to these numbers without explicitly pointing to it.  In other words, our intention was to work with units of measure, and not with ordinary numbers. <br>  Types to the rescue! </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Celsius</span></span></span></span>(<span class="hljs-built_in"><span class="hljs-built_in">f64</span></span>); <span class="hljs-meta"><span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fahrenheit</span></span></span></span>(<span class="hljs-built_in"><span class="hljs-built_in">f64</span></span>);</code> </pre> <br><p>  Programmers writing Rust call this a <code> </code> design pattern.  This is a tuple structure containing a single value.  In this example, we created two new types, one for degrees Celsius and Fahrenheit. </p><br><p>  Our function has acquired the following form: </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">danger_of_freezing</span></span></span></span>(temp: Celsius) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">bool</span></span>;</code> </pre> <br><p>  Using it with anything other than degrees Celsius leads to errors during compilation.  Success! </p><br><h3 id="preobrazovaniya">  Transformations </h3><br><p>  All we have to do is to write conversion functions that will convert one unit of measurement to another. </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Celsius { to_fahrenheit(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; Fahrenheit { Fahrenheit(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> * <span class="hljs-number"><span class="hljs-number">9</span></span>./<span class="hljs-number"><span class="hljs-number">5</span></span>. + <span class="hljs-number"><span class="hljs-number">32</span></span>.) } } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Fahrenheit { to_celsius(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; Celsius { Celsius((<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> - <span class="hljs-number"><span class="hljs-number">32</span></span>.) * <span class="hljs-number"><span class="hljs-number">5</span></span>./<span class="hljs-number"><span class="hljs-number">9</span></span>.) } }</code> </pre> <br><p>  And then use them, for example, like this: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> temp: Fahrenheit = sensor.read_temperature(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> is_freezing = danger_of_freezing(temp.to_celsius());</code> </pre> <br><h2 id="from-i-into">  From and Into </h2><br><p>  Conversions between different types are common in Rust.  For example, we can turn <code>&amp;str</code> into a <code>String</code> using <code>to_string</code> , for example: </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// ""   &amp;'static str let s = "".to_string();</span></span></code> </pre> <br><p>  However, it is also possible to use <code>String::from</code> to create strings like this: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::from(<span class="hljs-string"><span class="hljs-string">""</span></span>);</code> </pre> <br><p>  Or even like this: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>.into();</code> </pre> <br><p>  Why all these functions, when they, at first glance, do the same thing? </p><br><h3 id="v-dikoy-prirode">  In wild nature </h3><br><p>  <em>Translator‚Äôs note: this title contained an untranslatable play on words.</em>  <em>The original name <strong>Into the Wild</strong> can be translated as "In the wild", but you can "Magnificent <code>Into</code> "</em> </p><br><p>  Rust offers types that unify conversions from one type to another.  <code>std::convert</code> describes, among others, the types <code>From</code> and <code>Into</code> . </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">From</span></span></span></span>&lt;T&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span></span>(T) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Self</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Into</span></span></span></span>&lt;T&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">into</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; T; }</code> </pre> <br><p>  As you can see above, the <code>String</code> implements <code>From&lt;&amp;str&gt;</code> , and <code>&amp;str</code> implements <code>Into&lt;String&gt;</code> .  In fact, it is enough to implement one of these types to get both, since we can assume that this is the same thing.  More precisely, <a href="https://doc.rust-lang.org/src/core/convert.rs.html">From implements Into</a> . </p><br><p>  So let's do the same for temperatures: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> <span class="hljs-built_in"><span class="hljs-built_in">From</span></span>&lt;Celsius&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Fahrenheit { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span></span>(c: Celsius) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Self</span></span> { Fahrenheit(c.<span class="hljs-number"><span class="hljs-number">0</span></span> * <span class="hljs-number"><span class="hljs-number">9</span></span>./<span class="hljs-number"><span class="hljs-number">5</span></span>. + <span class="hljs-number"><span class="hljs-number">32</span></span>.) } } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> <span class="hljs-built_in"><span class="hljs-built_in">From</span></span>&lt;Fahrenheit&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Celsius { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span></span>(f: Fahrenheit) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Self</span></span> { Celsius((f.<span class="hljs-number"><span class="hljs-number">0</span></span> - <span class="hljs-number"><span class="hljs-number">32</span></span>.) * <span class="hljs-number"><span class="hljs-number">5</span></span>./<span class="hljs-number"><span class="hljs-number">9</span></span>. ) } }</code> </pre> <br><p>  We apply this in our function call: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> temp: Fahrenheit = sensor.read_temperature(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> is_freezing = danger_of_freezing(temp.into()); <span class="hljs-comment"><span class="hljs-comment">//  let is_freezing = danger_of_freezing(Celsius::from(temp));</span></span></code> </pre><br><h3 id="slushayus-i-povinuyus">  I obey and obey </h3><br><p>  You can argue that we received not so many advantages from the type of <code>From</code> , compared with the implementation of the conversion functions manually, as we did before.  You can even say the opposite, that <code>into</code> is much less obvious than <code>to_celsius</code> . </p><br><p>  Let's move the conversion of values ‚Äã‚Äãinside the function: </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// T -  ,       fn danger_of_freezing&lt;T&gt;(temp: T) -&gt; bool where T: Into&lt;Celsius&gt; { let celsius = Celsius::from(temp); ... }</span></span></code> </pre> <br><p>  This function magically accepts both degrees Celsius and Fahrenheit, while remaining type-safe: </p><br><pre> <code class="rust hljs">danger_of_freezing(Celsius(<span class="hljs-number"><span class="hljs-number">20.0</span></span>)); danger_of_freezing(Fahrenheit(<span class="hljs-number"><span class="hljs-number">68.0</span></span>));</code> </pre> <br><p>  We can go even further.  It is possible not only to process many convertible types, but also to return values ‚Äã‚Äãof different types in a similar way. </p><br><p>  Suppose we need a function that returns a freezing point.  It should return degrees Celsius or Fahrenheit, depending on the context. </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">freezing_point</span></span></span></span>&lt;T&gt;() -&gt; T <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: <span class="hljs-built_in"><span class="hljs-built_in">From</span></span>&lt;Celsius&gt; { Celsius(<span class="hljs-number"><span class="hljs-number">0.0</span></span>).into() }</code> </pre> <br><p>  Calling this function is slightly different from other functions, where we know the return type for sure.  Here we must <em>request the</em> type that we need. </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">//     let temp: Fahrenheit = freezing_point();</span></span></code> </pre> <br><p>  There is a second, more explicit way to call a function: </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,     let temp = freezing_point::&lt;Celsius&gt;();</span></span></code> </pre> <br><h3 id="upakovannye-boxed-znacheniya">  Boxed values </h3><br><p>  This technique is not only useful for converting values ‚Äã‚Äãto each other, but also simplifies the processing of packed values, such as results from <a href="https://github.com/sfackler/rust-postgres">databases.</a> </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> = row.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> age: <span class="hljs-built_in"><span class="hljs-built_in">i32</span></span> = row.get(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  let name = row.get_string(0); let age = row.get_integer(1);</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Python has a wonderful <a href="https://www.python.org/dev/peps/pep-0020/">Zen</a> . <br>  His first two lines read: </p><br><blockquote>  Beautiful is better than ugly. <br>  Explicit is better than implicit. </blockquote><p>  Programming is the act of transmitting intent to a computer.  And we must clearly indicate what exactly we mean when we write programs.  For example, a completely inexpressive boolean value to indicate the sort order will not fully reflect our intention.  In Rust, we can simply use an enumeration to get rid of any ambiguity: </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SortOrder</span></span></span></span> { Ascending, Descending }</code> </pre> <br><p>  In the same way, <em>new types</em> help to give meaning to simple values.  <code>Celsius(f64)</code> is different from <code>Miles(f64)</code> , although they may have the same internal representation ( <code>f64</code> ).  On the other hand, using <code>From</code> and <code>Into</code> helps us simplify programs and interfaces. </p><br><p>  <em>Translator's Note:</em> <em><br></em>  <em>Thanks to <a href="https://habrahabr.ru/users/sumproxy/" class="user_link">sumproxy</a> and <a href="https://habrahabr.ru/users/ozkriff/" class="user_link">ozkriff</a> for help with the translation.</em> <em><br></em>  <em>If you are interested in Rust and you have questions, <a href="https://gitter.im/ruRust/general">join us!</a></em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326896/">https://habr.com/ru/post/326896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326884/index.html">‚ÄúDoing more with smaller forces‚Äù - Kirill Tolkachev on the Alpha Laboratory</a></li>
<li><a href="../326886/index.html">How we made a completely new KOMPAS-3D: History in seven chapters ‚Üí part 2</a></li>
<li><a href="../326890/index.html">Rx. We comprehend retryWhen and repeatWhen on examples from Android development</a></li>
<li><a href="../326892/index.html">Research: businesses pay more attention to threats, not data protection</a></li>
<li><a href="../326894/index.html">ITMO University Digest: materials for those who want to join Data Science</a></li>
<li><a href="../326898/index.html">Chat bot for VKontakte on Python on Callback API</a></li>
<li><a href="../326900/index.html">As I made the fastest resize of images. Part 2, SIMD</a></li>
<li><a href="../326902/index.html">Experience implementing Tarantool in the service Calltouch</a></li>
<li><a href="../326904/index.html">To hell with motivation, you need discipline</a></li>
<li><a href="../326906/index.html">What we should build automation. Using the HTTP API in Google Sheets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>