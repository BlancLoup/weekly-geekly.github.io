<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moving time on the fly for JVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone sometimes had to deal with the problem of transferring time on a local computer for testing programs. For example, you need to check...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moving time on the fly for JVM</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone sometimes had to deal with the problem of transferring time on a local computer for testing programs.  For example, you need to check how the server processes payments in a week from today's date. <br><br>  The easiest way to do this is to move the system time.  But he has several flaws.  Some programs, such as Skype, begin to fail, save messages far into the future or into the past.  Also, system policies can be set to synchronize time with the corporate server every 5 minutes. <br><a name="habracut"></a><br>  After having had to deal with these problems for some time, I decided that it was time to come up with something and, after a couple of hours of fierce googling, I wrote a small java-agent that changes the time only for the desired JVM and does not touch the system date of the machine.  The desired date is taken from the file, which every time its last modification date is checked.  Perhaps this is not the best and fastest way, but by taking the source you can fix it as you prefer, for example, adding a shift not only dates but also time.  There is also a version that can move the date programmatically. <br><br>  The principle of the agent is very simple, using Instrumentation, it replaces calls to System.currentTimeMillis with my implementation of MySystem.currentTimeMillis, which returns the required date.  To work with classes, the javassist library is used. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now a little more about how it all works. <br><br>  The main class of the java-agent is MainClass, on startup, the JVM will execute its main method premain: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Instrumentation instrumentation; <span class="hljs-comment"><span class="hljs-comment">// ,      System.currentTimeMillis   private static ClassTransformer transformer; //   ClassFileTransformer public static File FILE = null; // ,       public static void premain(String args, Instrumentation inst) throws Exception { System.out.println("dateshift agent starting"); if (args != null &amp;&amp; args.length() &gt; 0) { //    ,         String path = args; System.out.println("Using dateshift.txt path from args: '" + path + "'"); FILE = new File(path); } else { //   ,  -   dateshift.txt,       bin tomcat-a FILE = new File(new File(System.getenv("CATALINA_HOME"), "bin"), "dateshift.txt"); } System.out.println("Path for dateshift.txt: '" + FILE.getAbsolutePath() + "'"); instrumentation = inst; //  ,   JVM transformer = new ClassTransformer(); instrumentation.addTransformer(transformer, true); //  ,      ClassTransformer    Class[] classes = inst.getAllLoadedClasses(); //     ,    . ,    ,     ArrayList&lt;Class&gt; classList = new ArrayList&lt;Class&gt;(); for (int i = 0; i &lt; classes.length; i++) { if (inst.isModifiableClass(classes[i])) { //    ,     classList.add(classes[i]); } } // Reload classes, if possible. Class[] workaround = new Class[classList.size()]; try { inst.retransformClasses(classList.toArray(workaround)); //    } catch (UnmodifiableClassException e) { System.err.println("MainClass was unable to retransform early loaded classes: " + e); } } }</span></span></code> </pre> <br><br>  Now let's look at how the ClassTransformer class works.  It uses javassist to replace all System.currentTimeMillis calls with MySystem.currentTimeMillis calls.  It is arranged quite simply: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassTransformer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassFileTransformer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] transform(ClassLoader loader, String className, Class classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] classfileBuffer) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> IllegalClassFormatException { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(className.startsWith(<span class="hljs-string"><span class="hljs-string">"ru/javaorca/"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    try { ClassPool pool = ClassPool.getDefault(); CtClass s1 = pool.get("java.lang.System"); CtMethod m11 = s1.getDeclaredMethod("currentTimeMillis"); //  ,     CtClass s2 = pool.get("ru.javaorca.MySystem"); CtMethod m21 = s2.getDeclaredMethod("currentTimeMillis"); //  ,      CodeConverter cc = new CodeConverter(); cc.redirectMethodCall(m11, m21); //        CtClass cl = pool.makeClass(new ByteArrayInputStream(classfileBuffer), false); //  ,    if(cl.isFrozen()) return null; CtConstructor[] constructors = cl.getConstructors(); //     for(CtConstructor constructor : constructors) { constructor.instrument(cc); //   } CtMethod[] methods = cl.getDeclaredMethods(); //     for(CtMethod method : methods) { method.instrument(cc); //   } classfileBuffer = cl.toBytecode(); } catch (Exception ex) { System.out.println("Exception: " + ex); ex.printStackTrace(); } return classfileBuffer; //    } }</span></span></code> </pre><br><br>  The MySystem class, which we will use to replace the system one, is very small: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MySystem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentTimeMillis</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> res = System.currentTimeMillis(); <span class="hljs-comment"><span class="hljs-comment">//     long res1 = DateShift.getTime(res); //     return res1; //    } }</span></span></code> </pre><br><br>  The last DateShift class remains, which loads the time from the file and calculates the required relative time shift for the system date. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateShift</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastModified = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       private static volatile long timeShift = 0; //      private static final long timeFilter = 86400000L; // 1000*60*60*24,        public static long getTime(long currentTime) { // ,    long res = currentTime; if ((lastModified &gt; 0 &amp;&amp; !MainClass.FILE.exists()) || lastModified &lt; MainClass.FILE.lastModified()) { //   ,       System.out.println("File modification detected"); synchronized (MainClass.FILE) { if (MainClass.FILE.exists()) { lastModified = MainClass.FILE.lastModified(); long newTime = readDateFromFile(); //     if (newTime &gt; 0) { timeShift = newTime - ((res / timeFilter) * timeFilter); //          } } else { lastModified = 0; //   ,     timeShift = 0; } } } if (timeShift != 0) { res += timeShift; //   } return res; } private static long readDateFromFile() { // ,     System.out.println("Reading data from file '" + MainClass.FILE.getAbsolutePath() + "'"); long res = 0; BufferedReader br = null; try { br = new BufferedReader(new FileReader(MainClass.FILE)); String line = br.readLine(); //      if (line != null &amp;&amp; !line.trim().isEmpty()) { SimpleDateFormat DATE_FORMAT = new SimpleDateFormat("dd.MM.yyyy", Locale.ROOT); //     dd.MM.yyyy try { Date date = DATE_FORMAT.parse(line); System.out.println("Loaded date from file: " + date); Calendar c = Calendar.getInstance(); c.setTime(date); long offset = c.get(Calendar.ZONE_OFFSET) + c.get(Calendar.DST_OFFSET); //       .   ,    JVM     System.out.println("Offset: " + offset); res = c.getTime().getTime(); res += offset; } catch (ParseException e) { System.out.println("ParseException: " + e); e.printStackTrace(System.out); } } else { System.out.println("File is empty"); } } catch (IOException e) { System.out.println("IOException: " + e); e.printStackTrace(System.out); } finally { if (br != null) { try { br.close(); } catch (IOException e) { System.out.println("IOException: " + e); e.printStackTrace(System.out); } } } return res; } }</span></span></code> </pre><br><br>  The agent is built via Maven, which creates a jar file directly with all dependencies.  I will not paint it in detail, you can see it in the source code for bitbucket. <br><br>  To connect the agent to your program, you need to add an additional parameter for jvm: <br><pre> <code class="bash hljs">-javaagent:D:\development\srv\dateshift-1.4-jar-with-dependencies.jar=D:\development\srv\dateshift.txt</code> </pre><br><br>  That's all.  As you can see there is nothing difficult in this.  The agent is pretty simple and can be easily customized for your needs. <br><br>  The noticed disadvantage is that if you move the time back relative to the current date, then applications can be a bit buggy.  For example, web applications may not display or work correctly.  But they are just as buggy if you move the system date right in the system. <br><br>  Sources are available at <a href="https://bitbucket.org/javaorca/dateshift/src">https://bitbucket.org/javaorca/dateshift/src</a> </div><p>Source: <a href="https://habr.com/ru/post/170401/">https://habr.com/ru/post/170401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170379/index.html">About great bikes, or why sometimes you need to write from scratch</a></li>
<li><a href="../170385/index.html">C # console to run simple "scripts"</a></li>
<li><a href="../170389/index.html">Basics of thin allocation of volumes on storage systems (or anniversary 3PAR thin provisioning)</a></li>
<li><a href="../170391/index.html">Unusual reflections on intellectual property rights</a></li>
<li><a href="../170397/index.html">W3 conference. Video broadcast. Second day</a></li>
<li><a href="../170403/index.html">FaceCode. Plugin for SublimeText2 (Linux OS)</a></li>
<li><a href="../170405/index.html">Announcement of intellectual property value at registration</a></li>
<li><a href="../170407/index.html">Debunking the x32 ABI myths</a></li>
<li><a href="../170409/index.html">Employees of the Internet Archive will receive a salary in bitcoins</a></li>
<li><a href="../170413/index.html">Smalltalk Developer for JVM Raises Funds to Complete Version 1.0 Development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>