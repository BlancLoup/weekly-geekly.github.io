<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>3DO and Android NDK and how not to get into anything ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are probably quite a few applications that are almost impossible to do in Java, due to the large C ++ source code base or performance requiremen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>3DO and Android NDK and how not to get into anything ...</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c02/c43/1d2/c02c431d28219fb6d08aae29fafa8f69.png" alt="image"><br><br>  There are probably quite a few applications that are almost impossible to do in Java, due to the large C ++ source code base or performance requirements.  And it turned out that I was developing one of these applications, namely the 3DO game console emulator - <a href="http://">Real3DOPlayer</a> .  In my case, the role played as a code base, and performance requirements.  The code was based on my desktop project <a href="http://www.arts-union.ru/node/23">‚ÄúPhoenix‚Äù</a> , and it slowed even on medium desktops, not like on embedded processors.  I don‚Äôt remember how many damnations were addressed to Gooogle Corporation, but I gained invaluable experience, which I want to share here. <br><a name="habracut"></a><br><br><h3>  Beginner, beating his forehead against the wall ... </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/f5e/261/46f/f5e26146fb629ae82d81d690c57c8ce4.jpg" alt="Gex">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Despite the fact that I am an experienced programmer (more than 15 years), I felt myself in the shoes of a beginner as soon as I took on the NDK. <br><br>  <b>The cone is the first.</b>  Having installed Android Studio under Windows, I decided to jot down a simple ‚ÄúHello, world!‚Äù With a call to JNI.  Everything is very simple: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">JNIEXPORT jstring JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_ru_arts_union_real3doplayer_NativeCore_stringFromJNI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv* env, jclass clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> env-&gt;NewStringUTF(<span class="hljs-string"><span class="hljs-string">"Hello, World!"</span></span>); }</code> </pre> <br><br>  Compilation error.  Just a compilation error.  Understand, the code is not compiled and a point.  The day I tried to compile the code, actively google the problem, but after the day the code could not be collected.  The next day, I took a laptop with Linux and decided to continue tormenting these two lines, to my surprise, everything gathered right away.  Began to read the forums, why under Windows you can not collect the code?  It turned out - one C / CPP file is not enough for building a project, at least 2 is required! <br><br>  <b>The second bump.</b>  I launch application, and it falls, informing that the stringFromJNI method was not found.  How so not found?  Here he is, right here and in the disassembler is visible!  Do not panic, I watch all the code from and to, thank God, it is not so much.  I look at the prefix in the function name ru_arts_union_real3doplayer, and something tells me that something is wrong here ... Indeed, the name of my package looked like this: ru.arts-union.real3doplayer, and the name of the method encodes the period and the dash equally, this is not good , and it is strange that the medium itself allowed such a name for the package.  We change the name of the package and method, removing the dash.  Hooray!  The method is seen, and two days later, ‚ÄúHello, world!‚Äù Works. <br><br>  <b>The bump is the third.</b>  It does not matter, there will be a lot of files, the name is corrected, we go on, thinking that the worst is over.  We add our source codes, which were tested under Linux / Windows for various processors (including ARM).  Everything compiled perfectly, without a single error.  The application crashes on startup without any warnings.  Continuing to midter over the code, I observe a floating line with a long double, I remember that NEON holds a double maximum, but this code is not even called, it just exists, and I deleted real80 in the type header.  And then, the code was compiled without errors!  Hmm .., than knocking on a tambourine, better drink this code ... Run, and bingo!  The code works, the games run, albeit with wild brakes! <br><br>  Here it is worth mentioning the work with seemingly trivial things - standard C libraries, be careful, it often happens that some methods that are present in one version are missing in another, and your application crashes due to the inability to load the desired method.  Only extensive testing or rejection in favor of STL with static linking will help here.  For example, TinyXML falls on a sufficiently large number of devices due to the lack of functions to convert numbers into a string and back. <br><br>  The less experience you have, the more bumps you will have - be mentally prepared, for sure I did not remember everything ... <br><br><h3>  In pursuit of performance or plunge times ... </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/d63/ff5/9e6/d63ff59e64311004f0add38d295aa189.jpg" alt="BC Racers"><br><br>  How to increase the performance of the emulator, which sometimes strained even the i7?  Very simply, you need to limit yourself to a computing resource, which is what happened with the attempt to port it to Android. <br><br>  In such a difficult situation, we had to implement texture caching with a graphics processor or partly or fully pixel-processed GPUs;  triangulation of square polygons (3DO nonlinear texture mapping);  static recompilation of code, frequently used libraries of OS console;  parallelization of emulation of console subsystems.  All this has reduced hardware requirements by more than three times.  Where else can one save cycles, apart from classical techniques, optimization in assembler and prolonged sitting in the profiler?  Obviously, in what most users will not notice the difference.  So, for example, I saved well on a 16-bit raster, instead of a 24-bit, when filling a frame. <br><br>  The optimization process itself is very entertaining and pulls into a separate article, but all of the above does not apply to Android as such.  And what can the platform and its features give us?  Obviously direct recording to the texture memory, since the CPU and GPU on mobile platforms in the vast majority of devices share it.  But alas, this mechanism, known as GraphicBuffer, is not intended for general use!  Nothing, you can get it through the dlopen.  But this should be done optionally, since this hack may not work everywhere.  Implementation can be found here (it is rather difficult to find through a search): <a href="">android.googlesource.com/platform/external/deqp/+/deqp-dev/framework/platform/android/tcuAndroidInternals.cpp</a> . <br><br>  And what we really do not want to give Android, but really need?  Of course control over the application cycle!  But, if sooo it is necessary, then NativeActivity will help or this one here, which impresses with its simplicity and convenience: <a href="https://github.com/tsaarni/android-native-egl-example">github.com/tsaarni/android-native-egl-example</a> .  Unlike NativeActivity, which is not clear how to work from a normal Activity, this approach allows you to capture the window context and draw in a separate thread, when we need to, and not when Java decides.  And it was here that I plunged, without knowing it. <br><br>  The fact is that this mechanism does not work on all versions of Android (at least according to my tests, version 4.1-4.3 does not support it), and this is about 40% of target devices for my application, judging by Google statistics, i.e. 40% profit off.  And you can find out about it very late, because usually the user having installed the application and seeing that it does not work, immediately demolishes it and does not write a review, it is understandable, because you need to quickly return the money.  Correcting the wrong application cycle is not a pleasant thing, because it is guaranteed to determine on which device it works, and on which not - it‚Äôs impossible, you can set a slower solution by default, but more compatible - it‚Äôs possible, but you spoil your karma, because not everyone will climb check in the settings: ‚ÄúIs it possible to twist something so that it becomes as before and does not slow down?‚Äù It is better to immediately make a more oak version, and then add an option, but in my case it's too late. <br><br><h3>  Cutting down the essence or plunging two ... </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/e78/378/c9f/e78378c9f05627526cc852014806553c.jpg" alt="Bust-a-move"><br><br>  Quite often, the SDK already has functionality that you don‚Äôt want to duplicate in native code, for example, to work with fonts or images, and a lot of things, because Java has a huge library.  And there is a natural desire to make a call to the Java method from C ++.  I just had such a desire, and I did a cool thing - rendering fonts to texture on demand from native code, I tested everything on my devices and a bunch of virtual devices.  Everything worked fine, and once again he fell in love - he made a release ... About 1% of users (who have already purchased the application) started to crash.  It was, to put it mildly - very bad, negative reviews, and the situation itself - the person paid and then bang - he does not work.  What is the reason, it is difficult to say, I suspect some manufacturers use a modified axis or something else.  Of course, I don‚Äôt rule out a mistake, but looking at such a report, I doubt it very much (of course this was the method, in black and white): <br><br><pre> <code class="bash hljs">java.lang.NoSuchMethodError: no method with name=<span class="hljs-string"><span class="hljs-string">'loadConfig'</span></span> signature=<span class="hljs-string"><span class="hljs-string">'(Ljava/lang/String;)Ljava/lang/String;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> class Lru/vastness/altmer/real3doplayer/MainActivity; at dalvik.system.NativeStart.run(Native Method)</code> </pre><br><br>  I had to very quickly cut out this solution and replace it with another.  Cost a little blood.  In itself, the solution is very good (1% incompatibility can be endured, just pass by and not bought), but only before launching the application, then, when many copies have already been sold - I would strongly not advise. <br><br><h3>  Updating arsenal or plunged three ... </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/31b/537/b73/31b537b73766e942e079b3e7a81a07ed.jpg" alt="Poed"><br><br>  Having rearranged the system, I set the SDK to a newer one and, accordingly, targetSdkVersion also changed.  Immediately there was a nuisance.  SD-drives stopped seeing, which is caused by Google‚Äôs strange machinations with access rights.  At the same time, downloading an APK with an older version of the SDK was possible!  It is impossible!  But I got off lightly, the problem was solved by requesting permissions.  And if the problem would not be solved so easily?  What to do then?  The question is very interesting ... <br><br>  The most unpleasant thing that came with updates, which I cannot get rid of to this day, is the unwillingness of the environment to update the APK with changes in the native library, I observe the problem both under Linux and under Windows.  This is annoying, so that the latest freshly assembled APK appears on the device during the debugging process, you need to do the following (Android Studio 2.1.1): <br><br>  1. Rebuild the project. <br>  2. Run the project (in this case, it will be reevaluated again, if you skip the first step, it will not be redefined). <br>  3. Stop the application. <br>  4. Build an APK. <br>  5. Run the application. <br><br>  And you thought, if you made a rebuild, then by running the application you will get the current freshly assembled APK on the device?  Not here it was, check, but rather make yourself a pop-up window or a message in the log with the version of the changes.  Otherwise, you risk losing a lot of time checking your workable code.  And do not expect that the second or third run will. <br><br>  Those who have similar problems, as compensation for time, if this has not already been done, I advise you to specify jobs N for the parallel assembly of native code. <br><br><h3>  The bottom line ... </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/637/d48/400/637d484009b677b34f34b12913bb3e3a.jpg" alt="Robinsons Requiem"><br><br>  In general, I haven't seen such a curvature for ten years in a draft from the development tools on this platform, but I have something to compare with.  Of course, I understand that Java is a priority, but still ... With this all, only the bug found in the Intel compiler that I found many years ago when shifting to zero in a variable, since no, no, yes I will write: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(shift)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x&gt;&gt;shift; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x;</code> </pre><br><br>  Nevertheless, it is worth paying tribute to Google, they did everything to ensure that the salaries of native Android developers were high! <br><br>  For me, as a C ++ developer, the situation with Android applications looks paradoxical, on the one hand, there are necessary mechanisms, but the cumulative amount of problems in the platform is such that when I try to make any improvements, I have to choose between loss of reputation and development applications.  No platform has put me before such a choice. <br><br>  Unwittingly you catch yourself thinking that it is better not to improve anything under this platform, otherwise how could something happen ... <br><br>  PS  Do not think - the emulator will continue to evolve, just boiling over. </div><p>Source: <a href="https://habr.com/ru/post/303888/">https://habr.com/ru/post/303888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303878/index.html">Sewing DB2 JDBC under .NET</a></li>
<li><a href="../303880/index.html">Kirill "isox" Yermakov, chief security officer of QIWI, talks about his work, about black, about anonymity and about adult information security.</a></li>
<li><a href="../303882/index.html">PyCon 2016 in Portland: video of all important reports and master classes</a></li>
<li><a href="../303884/index.html">How could Jack Ma fix the main mistake of his life?</a></li>
<li><a href="../303886/index.html">Siri integration or ‚ÄúThat's what I managed to find in your application‚Äù</a></li>
<li><a href="../303890/index.html">Secrets of the most effective people (part 1)</a></li>
<li><a href="../303894/index.html">Configuring the Overrides URL in Keepass2</a></li>
<li><a href="../303900/index.html">We launch a simple blog on Wagtail CMS (Django) - part 1</a></li>
<li><a href="../303902/index.html">Cooking Open Build Service 2.6</a></li>
<li><a href="../303904/index.html">Apei Gaming - to be a project! (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>