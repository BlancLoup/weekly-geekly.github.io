<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Getting cross-domain data in Google Chrome via user scripts (bypassing a bug)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Chrome and Chromium for 2.5 years, there is a bug of the lack of cross-domain access to another frame from the context script (user script). What w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Getting cross-domain data in Google Chrome via user scripts (bypassing a bug)</h1><div class="post__text post__text-html js-mediator-article">  In Chrome and Chromium for 2.5 years, there is a bug of the lack of cross-domain access to another frame from the context script (user script).  What works normally in a regular page script, for example, intersite data transfer using <i>postMessage</i> and that works without problems in other browsers, is sometimes considered a ‚Äúsecurity restriction‚Äù in Chrome, but in fact it is a common and <a href="http://code.google.com/p/chromium/issues/detail%3Fid%3D20773">recognized bug</a> noted with 4 th version. <br><a name="habracut"></a><br>  It is known that such problems are solved in Chrome extensions, when they are assigned access rights, but the crux of the matter is that additional access rights for such ordinary tasks are not required, all that is needed is to bypass the bug in one browser.  And then we can write the extension working in all browsers that support users scripts in one file.  An example of such a task that cannot be solved by ordinary scripts is getting data on the number of ‚Äúlikes‚Äù from the Google Plus button (without <a href="http://stackoverflow.com/questions/7403553/how-do-i-get-the-counter-of-a-google-plus-1-button">special authorization</a> in Google Apps and without <a href="http://www.tomanthony.co.uk/blog/google_plus_one_button_seo_count_api/">server technologies</a> ).  For such and similar tasks, in which the ‚Äúvendor‚Äù does not provide an API, a user script is necessary (necessary), and it does not have to be individual for each browser, as required by the extension. <br><br>  An example of getting the number of ‚Äúlikes‚Äù from the Google+ button in userscript, which works in all browsers (except IE), is available in <a href="http://userscripts.org/scripts/show/121690">HabrAjax</a> .  There, the value of ‚Äúlikes‚Äù is read inside the frame by the embedded script and is brought out for a more compact display right on the button surface.  Footnote for 4-5-digit numbers about 50 pixels wide.  hiding styles, which greatly saves space on the button.  Below is a screenshot. <br><img src="https://habrastorage.org/getpro/habr/post_images/cca/26a/b56/cca26ab56fa5a720297d612176e00bd4.png"><br><br><h3>  How to get data from a cross-domain frame in other browsers </h3><br>  The data is obtained quite simply using the <i>postMessage</i> method supported in Firefox 3+, IE8 +, Safari4 +, Opera 9.5+, Chrome1 +.  For older browsers use hacks like Iframe hash, Iframe name.  In the receiver window, put the event listener " <i>message</i> ": <br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*Function*/</span></span>receiveMessage, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);</code> </pre> <br>  In the window (or frame) source send a text message: <br><pre> <code class="javascript hljs">(target_window).postMessage(<span class="hljs-comment"><span class="hljs-comment">/*Srting*/</span></span>data, <span class="hljs-comment"><span class="hljs-comment">/*Srting*/</span></span>domainTarget);</code> </pre><br>  The source context must point to the target window, and in the second argument, it is recommended to explicitly indicate the receiver's domain for security purposes, rather than writing a string containing an asterisk (in the sense, ‚Äúany domain‚Äù).  It is then that a bug pops up in Chrome in context scripts - the browser must provide an understanding of the object <i>(target window) .postMessage</i> , and it happens in ordinary scripts in it.  For users, Chrome has an object ambiguity bug <i>(target window) .postMessage</i> if the window contains a different domain - other than the source of the message.  Therefore, a ‚Äúcrutch‚Äù is required for a sufficiently well-shaped message transfer scheme. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Addition of cross-domain transfer for Chrome </h3><br>  On the receiver side, there are no additions, because the problem is not in it.  In the source, we use script loading into the <i>window</i> environment. <br>  In the embedded script in another frame we read, waiting for the appearance, we need the data. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(gPlusFrame){ <span class="hljs-comment"><span class="hljs-comment">/** * check occurrence of third-party event with growing interval * @constructor * @param{Number} t start period of check * @param{Number} i number of checks * @param{Number} m multiplier of period increment * @param{Function} checkOccur event handler * @param{Function} check event condition */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Tout = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">h</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> th = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((h.dat = h.check() )) <span class="hljs-comment"><span class="hljs-comment">//data place h.occur(); else if(hi-- &gt;0) th.ww = setTimeout(arguments.callee, (ht *= hm) ); })(); }; new Tout({t:320, i:6, m: 1.6 ,occur: function(){ var id = location.hash.match(/(\?|#|&amp;)id=([^&amp;]+)/) //frame id [or name] , w = win; id = id &amp;&amp; id.length &amp;&amp; id[2]; var s = w.JSON &amp;&amp; w.JSON.stringify &amp;&amp; w.JSON.stringify( //must supported earlier {likes: this.dat.innerHTML, frme: id}) //data format , pHost = (function(a){ //host extract from parameter (#|&amp;)parent if(!a.match(/^https?\:\/\//)) return''; var b = document.createElement('a'); b.href = a; b.pathname = b.search = b.hash =''; return b.href.replace(/\/\??\#?$/,'') })( decodeURIComponent( (w.location.href.match(/.*(\?|#|&amp;)parent=([^&amp;]+)/) ||[])[2] ||'') ); try{ //'s'.wcl(s) if(!isChrome || w.parent &amp;&amp; w.parent.postMessage){ s &amp;&amp; w.parent.postMessage(s, pHost); //all browsers except Chrome //wcl('postpost') }else if(s) winEval(function(args){ var w = window , p1 = arguments[0] , p2 = arguments[1]; if(w.postMessage &amp;&amp; p1 &amp;&amp; w != w.parent){ function wpm(){ w.parent.postMessage(p1, p2); //msg with a glance Chrome bug } w.document.all ? w.setTimeout(wpm, 0) : wpm(); } }, [s, pHost]); }catch(er){wcl(er)} } ,check: function(){ return document &amp;&amp; document.querySelector('#aggregateCount'); } }); }</span></span></code> </pre><br>  And upon detection of the required data (the number of likes), a part of the above code starts, starting with ‚Äútry {‚Äù.  For all browsers except Chrome, create a postMessage () event in one line.  For Chrome, the bug is performed as described in the winEval () function. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * evaluate script in window scope * @param{Function} fs function or string is body of function * @param{String|Array} s string or array of strings for arguments * @param{Boolean} noOnce not delete script after exec */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> winEval = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fs, s, noOnce</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//exec function/text in other scope s = (s ||[]) instanceof Array? s ||[] : [s]; //wrap by array var fs2 = typeof fs=='function' ? (fs +'').replace(/(^\s*function\s*\([^\)]*\)\s*\{\s*|\s*\}\s*$)/g,'') //clean wrapper : fs , as =''; for(var i =0, sL =s.length; i &lt; sL; i++) //sequential array as += (i?',':'') +"'"+ s[i].replace(/'/g,"\\'").replace(/(\r\n|\r|\n)/g,"\\\n") +"'"; fs = '(function(){'+ fs2 +'}).apply(window,['+ as +']);'; //'fs'.wcl(fs, fs2) var d = document , scr = d.createElement('script'); scr.setAttribute('type','application/javascript'); scr.textContent = fs; var dPlace = d.body || d.getElementsByTagName('head') &amp;&amp; d.getElementsByTagName('head')[0]; dPlace.appendChild(scr); if(!noOnce) dPlace.removeChild(scr); };</span></span></code> </pre><br>  That's all the wisdom of bypassing the bug.  As you can see, an additional 30-40 lines are required.  There is one consolation that these lines are functions that can be useful in other places of user scripts. <br><br>  If you need to transport data to the other side and you also need a user-script (if you can‚Äôt write a regular script on the page), the same addition will be needed for the second domain.  It is logical to use the same procedure and the same script, adding its second domain to the meta-directive. <br><br><h3>  Frame or Script Format Requirements </h3><br>  The <i>postMessage</i> method requires knowledge of the domain and the path to the target window.  Therefore, it is required to transfer these 2 parameters to the user script in some way.  They must be specified either explicitly (for example, <i>parent</i> ), or taken from an accessible environment.  Since the script runs in a cross-domain frame (or window) and does not have (for Chrome) access to other windows, in practice they indicate the domain in the frame URL (this is done, for example, in the Google+ button).  Therefore, suppose that the target window's domain name is written in URl in the format of /. in frame with URL: <br>  <a href="http://some-my-site.com/some-path">http://some-widget-site.com/abcd.php?a=1&amp;b=2&amp;parent=http://some-my-site.com/some-path</a> . <br>  Or the same, but the anchor will be added: <br>  <a href="&amp;xid=17259,15700021,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhg0jdtIRAlWM1dALoJIyawha7SB7A#parent=">http://some-widget-site.com/abcd.php?a=1&amp;b=2#parent=http://some-my-site.com/some-path</a> . <br>  If there is no such possibility to set the domain of the target, the script should be rewritten to specify the domain explicitly or in another way (as an option, use the same <i>postMessage</i> from the top window in the user script to accept the domain name).  In the following, it is assumed that the domain is specified in the <i>parent</i> parameter.  So, in particular, done in the Google+ button. <br><br>  Note that this complex mechanism will work in all browsers, but it requires more resources, because  eval () is implicitly executed, so loading the script in the [window scope] should only be done where necessary, namely, in the Chrome browser, as long as bug 20773 exists. Therefore, in the working script, a branch is made that checks <i>postMessage</i> crossdomain frame and perform a bug bypass if the method is not available. <br><br>  The script has a couple of useful functions that are needed in other places of the user script and could be taken as library functions: <br>  1) loading programs into the [window scope] ([global_scope]) environment; <br>  2) tracking the emergence of independent asynchronous data using a slow down timer. <br><br>  The second procedure is not the best solution, but sometimes there is no other way to learn about the conditions independent of its script, as in the case of checking the results of a third-party widget.  Reading the number of ‚Äúlikes‚Äù in the Google+ frame just applies to this occasion. <br><br>  <b>Ps</b> .  Admins, rename the blog GreaseMonkey, please, finally, in "User scripts". </div><p>Source: <a href="https://habr.com/ru/post/142862/">https://habr.com/ru/post/142862/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142857/index.html">Google Drive against other cloud services</a></li>
<li><a href="../142858/index.html">SysAdmin Anywhere: Using UDP Hole Punching to implement remote desktop</a></li>
<li><a href="../142859/index.html">Architecture Bitrix24 - Inside View</a></li>
<li><a href="../142860/index.html">Google launched Trusted Stores service in test mode</a></li>
<li><a href="../142861/index.html">TSM service for managing NFC SIM applications</a></li>
<li><a href="../142863/index.html">Flickr has undergone major changes.</a></li>
<li><a href="../142864/index.html">Sales funnel: we make an automatically updated report from the database using Excel</a></li>
<li><a href="../142865/index.html">SMS for MTS - in vain on the site I got to them</a></li>
<li><a href="../142867/index.html">Testing Iphone 2g for extreme EMF - a mini lightning strike</a></li>
<li><a href="../142868/index.html">Opera goes to the side of evil: Declared support for properties with the prefix -webkit-</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>