<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HTTP server optimization through resource versioning. Features of the implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Essence of optimization 
2. Page load vs forced refresh 
3. Automation will be required 
4. Server side implementation 
5. Server side optimization...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HTTP server optimization through resource versioning. Features of the implementation</h1><div class="post__text post__text-html js-mediator-article"><ol><li>  Essence of optimization </li><li>  Page load vs forced refresh </li><li>  Automation will be required </li><li>  Server side implementation </li><li>  Server side optimization </li><li>  Features google app engine </li><li>  Source </li><li>  Summary </li></ol><br><br>  We consider an example implementation for Google App Engine / Python. <br><br><a name="habracut"></a><br><h2>  Essence of optimization </h2><br>  Yahoo engineers in their famous article wrote about an interesting technique for optimizing HTTP processing through file versioning.  Its essence is this ... Usually in HTML they write simply: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image.jpg"</span></span></span><span class="hljs-tag"> &gt;</span></span></code> </pre> <br><br>  Having once acquired image.jpg in the cache, after the browser reads the HTML again and again finds a link to the same picture there.  Whether the browser is updated on the server, in general, the browser itself cannot, so he has to send a request to the server. <br><br>  To avoid an extra request, you can specify the version of the resource in its address, making the address unique: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image.v250.jpg"</span></span></span><span class="hljs-tag"> &gt;</span></span></code> </pre> <br><br>  Thus, the browser can be sure that the file version number 250 in the future will not change, and number 251, too;  and if # 250 is in the cache, then you can use it without any questions to the server.  Two HTTP headers will help give the browser this confidence: <br><br><pre> <code class="hljs pgsql">//  ,     Expires: Fri, <span class="hljs-number"><span class="hljs-number">30</span></span> Oct <span class="hljs-number"><span class="hljs-number">2050</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span> GMT //       <span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span>-Control: max-age=<span class="hljs-number"><span class="hljs-number">12345678</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> </pre> <br><br>  Thus, to view a certain page you only need to download HTML for the nth time, and you no longer need to access numerous resources. <br><br><h2>  Page load vs.  Forced Refresh </h2><br>  In the current view, this optimization works for following links and for Ctrl + L, Enter.  But if the user refreshes the current page through F5, the browser forgets that for resources it was indicated ‚Äúno longer disturb‚Äù, and here ‚Äúextra‚Äù requests are rushing to the server, one for each resource.  This behavior of browsers cannot be changed, but what can and should be done is not to give the files in full at every time, but to introduce additional logic, if possible, trying to answer ‚Äúnothing has changed in me, take it from your cache‚Äù. <br><br>  When the browser requests ‚Äúimage.v250.jpg‚Äù, then if it has a copy in the cache, the browser sends the ‚ÄúIf-Modified-Since: Fri, 01 Jan 1990 00:00:00 GMT‚Äù header.  The browser who came for this picture for the first time does <i>not</i> send such a leader.  Accordingly, the north must first say ‚Äúnothing has changed‚Äù, and the second honestly give the picture.  Specifically, in our case, the date can not be analyzed - the fact that there is a picture in the cache is important, and the picture is correct there (due to the versioning of files and unique URLs). <br><br>  But just because the title "If-Modified-Since" on the server will not come, even if the picture is in the cache.  To force the browser to send this header, the (chronologically) previous answer needed to give the header "Last-Modified: Fri, 01 Jan 1990 00:00:00 GMT".  In practice, this only means that this header server should always give.  You can give an honest date of the last file change, and you can specify any date in the past - the same date will then go back to the server, and there she, as it turned out, is not of particular interest. <br><br>  In fact, the optimization described in this section has no direct relationship with Yahoo, but should be used in pairs to avoid unnecessary burdens.  Otherwise, the effect will be incomplete. <br><br><h2>  Automation will be required </h2><br>  The technique is not bad, but in practice it is not possible to arrange file versions manually.  In GAE / django, the problem is solved through custom tags.  In the template code is written: <br><br><pre> <code class="hljs django"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">img</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">static</span></span></span></span></span><span class="hljs-template-tag"> 'image.jpg' %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span></span></code> </pre> <br><br>  HTML converted: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/never-expire/12345678/image.jpg"</span></span></span><span class="hljs-tag"> &gt;</span></span></code> </pre> <br><br>  And the implementation of this tag: <br><br><pre> <code class="hljs objectivec">def <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>(path): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StaticFilesInfo.get_versioned_resource_path(path) <span class="hljs-keyword"><span class="hljs-keyword">register</span></span>.simple_tag(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>)</code> </pre> <br><br><h2>  Server side implementation </h2><br>  Basically, this optimization is convenient for processing static files - images, css, javascript.  But App Engine handles files designated as static itself <s>(not very efficiently)</s> and will not allow to change HTTP headers.  Therefore, in addition to the standard ‚Äústatic‚Äù directory, another one appears - ‚Äúnever-expire‚Äù. <br><br>  First, the GET request handler verifies that the requested version of the file matches the last one.  If it does not match, it redirects to a new address, in order: <br><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> previous <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> resource requested - redirect <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the right <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> correct_path = StaticFilesInfo.get_resource_path(resource) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.request.path != correct_path: self.redirect(correct_path) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre> <br><br>  Then sets the response headers: <br>  - Content-Type according to the file extension <br>  - Expires, Cache-Control, Last-Modified as already described. <br><br>  If the request contains the If-Modified-Since header, do nothing and set the code to 304 ‚Äî the resource has not changed.  Otherwise, the contents of the file are copied to the response body: <br><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'If</span></span>-Modified-Since' <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.request.headers: # This flag means the client has its own copy <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the resource # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> we may <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> it. We won<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span>. # Just set the response code <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> Changed. self.response.set_status(<span class="hljs-number"><span class="hljs-number">304</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) # todo: just making resource loading <span class="hljs-keyword"><span class="hljs-keyword">process</span></span> noticeable abs_file = os.path.join(os.path.split(__file__)[<span class="hljs-number"><span class="hljs-number">0</span></span>], WHERE_STATIC_FILES_ARE_STORED, resource) transmit_file(abs_file, self.response.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>)</code> </pre> <br><br>  Perhaps, if the database in GAE is faster than the file system, it is worthwhile at the first request of the file to copy the contents of the file into the database and then only go there.  The question is open to me. <br><br><h2>  Server side optimization </h2><br>  As a version of the file, you can use both the version from VCS and the time of the last file update - there is no fundamental difference.  I chose the second, and with it, and simpler: <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.getmtime(file)</code> </pre> <br><br>  However, it seems that it‚Äôs not very good to poll the file system for each request - I / O is always slow.  Therefore, you can collect information about the current versions (all) of static files upon the first request and put the information into memcache.  The output is such a hash: <br><br><pre> <code class="hljs cs">{ <span class="hljs-string"><span class="hljs-string">'cover.jpg'</span></span>: <span class="hljs-number"><span class="hljs-number">123456</span></span>, <span class="hljs-string"><span class="hljs-string">'style.css'</span></span>: <span class="hljs-number"><span class="hljs-number">234567</span></span> }</code> </pre> <br><br>  which will be used in the custom tag to find the latest version.  Naturally, you will need something like a singleton just in case memcache gets rotten: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StaticFilesInfo(): @classmethod def __get_static_files_info(cls): <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> = memcache.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(cls.__name__) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> = cls.__grab_info() <span class="hljs-type"><span class="hljs-type">time</span></span> = MEMCACHE_TIME_PRODUCTION <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_production() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> MEMCACHE_TIME_DEV_SERVER memcache.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(cls.__name__, <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>, <span class="hljs-type"><span class="hljs-type">time</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> @classmethod def __grab_info(cls): """ Obtain info about all files in managed 'static' directory. This is done rarely. """ dir = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(os.path.split(__file__)[<span class="hljs-number"><span class="hljs-number">0</span></span>], WHERE_STATIC_FILES_ARE_STORED) hash = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(dir): abs_file = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(dir, file) hash[file] = <span class="hljs-type"><span class="hljs-type">int</span></span>(os.path.getmtime(abs_file)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hash</code> </pre><br><br><h2>  Features of the Google App Engine </h2><br>  You can collect information about all static files, but what if the designer changes the picture?  How does the server know that it is time to update the cached versions of the files?  In general, I don‚Äôt really imagine - you need to either start a daemon listening to file system changes, or remember to run scripts after deployment. <br><br>  But the App Engine is a special case.  In this system, the development is carried out on a local machine, after which the ready code (and static files) are deployed (deployed) to the server.  And, importantly, the files on the server can no longer be changed (until the next deployment).  That is, it is enough to read the versions only once and no longer worry about the fact that they can change. <br><br>  The only thing is that when developing locally, files can change very much, and if in this case the alternative does not work, the browser will, for example, show the developer the old version of the image, which is inconvenient.  But in this case, the performance is not very important, so you can put the data in memcache for a few seconds or not put at all. <br><br><h2>  Source code of the finished example </h2><br>  <a href="&amp;xid=17259,15700022,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhd6KwrhhIw0MVEC4WLpm_7zvezqg#svn%2Ftrunk%2Fnever-expire-">code.google.com/p/investigations/source/browse/#svn%2Ftrunk%2Fnever-expire-http-resources</a> <br><br>  svn checkout <a href="http-resources">investigations.googlecode.com/svn/trunk/never-expire-http-resources</a> investigations <br><br><h2>  Summary </h2><br>  On the appspot, I have not yet filled it, but locally everything works and flies.  People, use the benefits of client-server optimization, do not respond stupidly 200 OK :) <br><br>  <b>UPD.</b>  In the comments they write (and I confirm) that for static files of the same effect it is possible to achieve through standard static.  That is, such ‚Äúmanual‚Äù code is hardly suitable for processing statics - GAE will cope with this better.  However, the <b>approach may be useful for processing dynamically generated resources</b> .  In this context, ETag may be more convenient than Last-Modified for implementation. </div><p>Source: <a href="https://habr.com/ru/post/126083/">https://habr.com/ru/post/126083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126069/index.html">Will Samsung Galaxy Tab 10.1 appear in Russia after the official ban?</a></li>
<li><a href="../126075/index.html">A small or large introspective program in C / C ++</a></li>
<li><a href="../126077/index.html">100 watts USB</a></li>
<li><a href="../126079/index.html">Android App Inventor will give to Open Source</a></li>
<li><a href="../126082/index.html">13 things that you might see in Android 4.0</a></li>
<li><a href="../126084/index.html">Registration on the site can reduce traffic to your site by 80%</a></li>
<li><a href="../126085/index.html">Twitter messages will appear on the actions of other users.</a></li>
<li><a href="../126087/index.html">Unrest in England and Automatic Face Recognition</a></li>
<li><a href="../126088/index.html">iPad as a platform for developing web applications</a></li>
<li><a href="../126089/index.html">Build a Visual Studio project into a single file using ILMerge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>