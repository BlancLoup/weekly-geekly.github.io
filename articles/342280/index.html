<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HistoryAPI: How to write once, and so that the head does not hurt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 The relatively recent html5 HistoryAPI has already become quite popular. On the Internet you can find many articles on how to raise the w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HistoryAPI: How to write once, and so that the head does not hurt</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br><br>  The relatively recent html5 HistoryAPI has already become quite popular.  On the Internet you can find many articles on how to raise the work of HistoryAPI, but at the same time they are mostly the same and there are two nuances: <br><br><ol><li>  They are organized in such a way that they treat all links equally; </li><li>  You can shoot yourself a leg and not understand - why. </li></ol><br>  This article discusses how to organize the work of HistoryAPI so that later not to sell the soul to the devil, so that everything works. <br><a name="habracut"></a><br><h4>  So, what do most articles offer: </h4><br>  Suppose that we have the most starting version of the markup - several navigation links and a block of content: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//&lt;?=$_SERVER['HTTP_HOST']?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/about"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/contact"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content"</span></span></span><span class="hljs-tag">&gt;</span></span> Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatibus, odio. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  And the same averaged minimum suggested js: <br><br><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $(<span class="hljs-string"><span class="hljs-string">'a'</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ e.preventDefault(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'href'</span></span>); $.ajax({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'ajax=true'</span></span>, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,           $('#content').html(data.content); } }); window.history.pushState(null, null, url); return false; }); $(window).bind('popstate', function(){ $.ajax({ url: history.location, data: 'ajax=true', success: function(data){ $('#content').html(data.content); } }); }); });</span></span></code> </pre> <br><h4>  What is already bad here: </h4><br><ol><li>  This js equally handles ALL links: external, local, and even links that do not redirect anywhere (say, you made a link that opens a modal window).  And in the yard, for a minute, 2017.  There are a lot of links that go nowhere on different sites;  External links are completely accepted (good form) in a new tab. </li><li>  As soon as you have a local link in the variable block, you are doomed.  Because it will not be processed by your script, and you will not even understand why. </li></ol><br><h4>  What to do? </h4><br>  Problem 1 is quite easily solved: you only need to catch links with the href attribute (I use links like &lt;a modal_url="/url" modal_header= H Header title title = T Title &lt;&gt; for the links to modal windows&gt;) and with the help of the regular understand local link or not;  and depending on it process it differently. <br><br>  I ran into problem 2 when I was working on raising the HistoryAPI on one of the sites.  By the way, this is an online radio, so traveling around the site without updating the page is a crucially important task.  What was the problem: The first link to the link after updating the page worked fine.  But then some kind of devilishness began: some links continued to work as they should, while others led to a page reload.  Only after 2 months of searching for a solution, I finally found that only those links that were not originally on the page, but were there after loading the page, disappear.  And they will be satane, because the eavesdropping of the click event is not hung on them. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//,  : $(document).ready(function(){ $('a[href]').click(function(e){</span></span></code> </pre> <br>  How this code works: <br><br>  1. You visited the site <br>  2. The script is waiting for the page to load. <br>  3. It scans it and hangs on all links with the href attribute a click event handler. <br>  4. EVERYTHING.  On this his work is finished, and he dies. <br><br>  Suddenly, right?  But after all we need to process ALL links ALWAYS. <br><br>  The first idea is to re-scan the function-update-page - but this does not lead to anything, and the additional code. <br><br>  The second idea is to return to the idea of ‚Äã‚Äãonclick = "foo (this)", but we have already decided that we should not do so. <br><br>  A quick date with Google, and we have a <a href="https://ru.stackoverflow.com/a/219708">solution</a> : <br><br><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-string"><span class="hljs-string">'a[href]'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{</code> </pre> <br>  This code works a little differently: here the script is looking in the document ... document.  And then it will catch all the clicks, responding only to clicks on links with the href attribute.  It sounds strange and inexplicably similar to the first option, but it works. <br><br><h4>  The final option: </h4><br>  This solution will allow you to write a link handler once and forget about the need to add attributes to links when creating new posts;  and from the need to explain to everyone who can create new entries on the site, how to insert links correctly. <br><br><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pattern = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">"^(https:\/\/"</span></span>+location.host+<span class="hljs-string"><span class="hljs-string">"\/|http:\/\/"</span></span>+location.host+<span class="hljs-string"><span class="hljs-string">"\/|\/\/"</span></span>+location.host+<span class="hljs-string"><span class="hljs-string">"\/|"</span></span>+location.host+<span class="hljs-string"><span class="hljs-string">"\/|\/(?!\/))"</span></span>), <span class="hljs-comment"><span class="hljs-comment">// "^\/(?!\/)" - "  /,   -  /" pattern_protocol = new RegExp("^(http:\/\/|https:\/\/|\/\/)"), // , "  "   pattern_lochost = new RegExp("^("+location.host+")"); $(document).on('click', 'a[href]', function(e){ e.preventDefault(); if(!$(this).attr('href')){console.log('no href'); return false;} var url = $(this).attr('href'), isLocal = (pattern.test(url)) ? true : false; if(isLocal){ console.log('Local link: '+url); if(pattern_protocol.test(url)){url = url.replace(pattern_protocol, '');} if(pattern_lochost.test(url)){url = url.replace(pattern_lochost, '');} //     ,    . .., , "https://domain.com/page" -&gt; "/page". //  ,       domain.com/page,     isLocal, //     - domain.com/domain.com/page $.ajax({ //    :      //string data.title //string data.url // bool data.isErrorPage // bool data.hideSidebar //     ,    $('selector').load(data.url+' selector')    . //    -  . url: url, data: 'ajax=true', success: function(data){ reload_page($.parseJSON(data)); } }); window.history.pushState(null, null, url); return false; }else{ console.log('External link: '+url); //       ,    ,     ,   location.href/url (, domain.com/google.com) // http://.    ,   https:// -  . url = (pattern_protocol.test(url)) ? url : 'http://'+url; window.open(url, '_blank'); } }); $(window).bind('popstate', function(){ $.ajax({ url: location.pathname+location.search, data: 'ajax=true', success: function(data){reload_page(data)} }); }); });</span></span></code> </pre> <br>  If you can get links to ftp: // or ssh: // etc.  - need to take care of the processing of these links.  I did not care, because  They will not come across from me. <br><br>  That's all.  Hope it was helpful. </div><p>Source: <a href="https://habr.com/ru/post/342280/">https://habr.com/ru/post/342280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342268/index.html">Digital power industry</a></li>
<li><a href="../342270/index.html">The office writes: adult chatting on the site</a></li>
<li><a href="../342272/index.html">Intel processor frequency control rakes</a></li>
<li><a href="../342276/index.html">Weekdays tester, or what's the Pyramid of Maslow</a></li>
<li><a href="../342278/index.html">Storage. Multi-tier software-defined storage. Why, why, and how is implemented using the example of the MIRhosting cloud</a></li>
<li><a href="../342282/index.html">Question: Does the software really use the new instruction sets?</a></li>
<li><a href="../342284/index.html">New release Oh, My Code - Cloud, Perl and good programmers</a></li>
<li><a href="../342286/index.html">Bible movements doom. Part 2</a></li>
<li><a href="../342288/index.html">SparrowHub Plugin Overview</a></li>
<li><a href="../342290/index.html">November 29, Kharkiv: Report "Analytics in a Gaming Company: Big Data Architecture and Tools"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>