<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NIO: between Scylla and Charybdis?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the widely discussed properties of the java.NIO framework is non-blocking, which means the ability to perform I / O operations and computations...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NIO: between Scylla and Charybdis?</h1><div class="post__text post__text-html js-mediator-article">  One of the widely discussed properties of the java.NIO framework is non-blocking, which means the ability to perform I / O operations and computations in parallel.  If an application that has requested to read a file has a computational task that can be processed before receiving data from the file, then it becomes possible to simultaneously perform these operations.  In the case of deferred writing, the possibilities for concurrency are even greater, since when writing, unlike reading, the application does not expect data to arrive. <a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/042/b0f/9c8/042b0f9c878726d652cf0dec6ad72be2.png" align="left" width="180">  <b>Note</b>  <i>I would like to headline this article ‚ÄúNIO: performance <s>or</s> compatibility?‚Äù, But due to well-known limitations it is necessary to quote the names of these ancient Greek old women.</i> <br><br>  The success factor here is hardware support.  Mass storage device controllers such as SATA AHCI (Advanced Host Controller Interface) and NVMe (Non-Volatile Memory Interface for PCI Express) are capable of processing rather long I / O sequences and transfer data between the RAM and the drive in the bus-master mode, without participation of the program executed by the central processor. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/937/df7/ea7/937df7ea72b64e7c683231efefb59956.png" width="640" alt=" ,   AHCI       " title="A list of commands generated by the AHCI driver in RAM and hardware-interpreted by the controller"></div><br>  <b>Fig.1</b> <i>A list of commands generated by the AHCI driver in RAM and hardware-interpreted by the controller can contain up to 32 I / O operation descriptors.</i>  <i>Illustration from AHCI Specification</i> <br><br><h2>  Contradictions and solutions </h2><br>  Here we come to another, less obvious, but at the same time very important characteristic of the NIO framework, which is based on two mutually contradictory criteria: <br><br><ol><li>  On the one hand, Java, as a cross-platform programming language, is abstracted from the hardware characteristics of the computing system, architecture, and even the capacity of the central processor.  Compatibility requires a set of abstractions that reliably separate the application programmer from the low-level details.  Suffice it to recall the absence of <i>pointers</i> in Java. </li><li>  On the other hand, the performance requires a detailed code optimization, its adaptation to the peculiarities of a specific execution environment and the type of hardware used. </li></ol><br><br><h2>  Java Native Interface </h2><br>  One alternative solution is to pair Java classes and libraries written in C or assembler.  Not to mention here are the native classes that implement the <b>JNI</b> ( <i>Java Native Interface</i> ) <i>interface</i> , based on classical calling conventions standardized for each operating system and supplemented by a mechanism that provides interaction between the JVM and native code.  By the way, having mastered the JNI technology, you can get access to pointers, the absence of which in Java sometimes brings inconvenience. <br><br>  At the same time, the use of such a radical method as the integration of native code, eliminates the cross-platform advantages of Java, dramatically increases the complexity of application development and the likelihood of errors.  Multiple platform support, for a JNI solution, will inevitably mean fork constructs with the need to write and maintain a set of libraries, the number of which is equal to the number of supported systems. <br><br>  Admittedly, there are situations where the use of JNI is necessary.  For example, support for some special devices, such as hardware random number generator. <br><br><h2>  Nio </h2><br>  As it turned out, high-performance code can also be developed in Java, if we optimally design a system of abstractions that encapsulate the hardware resources of the platform. <br><br>  Consider the operation of reading a file from disk.  Obviously, there are two participants in the process: the source of the data (drive or file) and the recipient (buffer in RAM).  Everything said below is true for writing a file to disk, only the direction of information transfer is different, the source and the receiver are swapped. <br><br>  For user applications, the <i>drive or file</i> is represented by OS functions of disk I / O API.  We will not consider the possibility of direct programming of disk controller registers by a user application, which has fallen into the past since the days of MS-DOS, for obvious reasons of compatibility and security. <br><br>  <i>The buffer</i> is the specified memory range in the address space of the application.  If to be completely <s>tedious</s> , in a number of high-level platforms, the recipient buffer can be physically located in the cache memory of the central processor, but with the observance of the classic caching rules, without losing the association with the specified range of RAM addresses. <br><br>  So, the considered objects of the hardware platform are: <br><br><ul><li>  Communication channel with the drive or file (OS API). </li><li>  RAM range, buffer. </li></ul><br>  By implementing Java classes that directly correspond to the two named components of ‚Äúobjective reality‚Äù, you can get a high-performance solution by minimizing the number of auxiliary operations, which the developers of the NIO framework, based on the concept of <i>channels and buffers,</i> did. <br><br>  Of course, such a tool cannot be implemented without low-level hardware-dependent programming.  We say only that the use of this tool eliminates the need for an application programmer. <br><br><h2>  NIOBench utility </h2><br>  The <a href="http://cit.odessa.ua/news/novosti_sajta/niobench_v042_uzhe_v_seti.html">NIOBench</a> utility, developed by IC Book Labs and designed to measure the mass storage performance of the subsystem, illustrates this using channels and buffers when performing file operations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/51d/adb/484/51dadb48410ebeefc0a8adb09f72be55.png" alt=" NIOBench,     ,       " title="Utility NIOBench, displaying the results of measuring the speed of reading, writing and copying files on the hard disk"></div><br>  <b>Fig.2</b> <i>Utility NIOBench, the output results of measuring the speed of reading, writing and copying files on the hard disk of the laptop ASUS N750JK (the data processing uses the median and the arithmetic average)</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a2a/fbb/ddf/a2afbbddf20951b6d42e153c4f0c7176.png" alt="   NIOBench    " title="Text report utility NIOBench with detailed logging of results"></div><br>  <b>Fig.3</b> <i>Text report of the NIOBench utility with detailed logging of results: the effect of caching is obvious</i> <br><br>  The input-output methods, in particular, the operations of reading, writing and copying files, which are the object of benchmarks, are based on the following architectural elements. <br><br><ul><li>  The <i>FileChannel</i> object corresponds to the channel created from the file being read or written.  Along with the simplest read and write operations, the <i>transferTo (), transferFrom ()</i> methods are supported, for which the filesystem objects can be a source and a receiver.  This feature is very important because it allows you to copy the contents of files with one java-operator, gracefully getting rid of unnecessary data transfers between multiple buffers.  We must admit that the efficiency of copying methods optimization, typical for the NIO framework, played a cruel joke during the development and debugging of benchmarks: the measured copying speed sometimes turned out to be higher than the recording speed. <br><br></li><li>  <i>Buffer</i> object corresponds to the range of RAM.  For all the obviousness of this concept, we note that in order to minimize the number of transit movements of data, it is recommended to create a direct buffer using the <i>ByteBuffer.allocateDirect ()</i> method <i>;</i> </li></ul><br>  Failure to comply with this recommendation may lead to performance degradation due to the need to convert Java abstractions into native objects that are passed to the OS OS functions for processing.  The JNI interface is also used in the NIOBench project to connect the libraries supporting the hardware random number generator based on the RDRAND processor instruction ( <a href="https://habrahabr.ru/post/308754/">an article about this</a> ‚ÄúJava benchmarks: random patterns and regular results‚Äù in the writing process). <br><br><h2>  Summary </h2><br>  The concept of channels and buffers underlying the NIO technology exactly corresponds to the architecture of the storage subsystems, the main functionality of which is reduced to the movement of information between the RAM (buffers) and various drives (channels). <br><br>  At the same time, no miracle happened, and the low-level work, from which any framework frees the application programmers, is only transferred to the framework developers and system programmers ... <br><br><h3>  Links </h3><br><ul><li>  <a href="http://composter.com.ua/content/konvencii-vyzova-microsoft-vs-linux-2016-01-17">About call conventions</a> </li><li>  <a href="http://composter.com.ua/content/nvme-vs-ahci-obzor-razlichiy-2016-01-31">About mass storage devices</a> </li><li>  <a href="http://composter.com.ua/content/ssd-diski-novye-trebovaniya-k-platformam-2014-12-24">Platform Requirements</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/309826/">https://habr.com/ru/post/309826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309808/index.html">From blacklist to machine learning. Antiphishing in Yandex Browser</a></li>
<li><a href="../309810/index.html">Case OZON.ru: How to make shipping billing transparent and manageable</a></li>
<li><a href="../309812/index.html">Fatal binary arithmetic errors when working with floating point numbers</a></li>
<li><a href="../309814/index.html">GSOC totals</a></li>
<li><a href="../309822/index.html">Demand analysis: by what criteria do virtual servers select</a></li>
<li><a href="../309828/index.html">17% of the websites of Ukrainian schools are hosted in Germany, and 20% in Russia</a></li>
<li><a href="../309830/index.html">JetBrains Night in Moscow on September 29</a></li>
<li><a href="../309832/index.html">Blue-green warm</a></li>
<li><a href="../309834/index.html">Understanding Go: the encoding package</a></li>
<li><a href="../309836/index.html">Setting and using speed limit for Open vSwitch with DPDK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>