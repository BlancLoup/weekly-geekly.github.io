<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse "Neuromant". Part 4: Sound, Animation, Huffman, Github</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, as you already understood, this is a continuation of my history of reverse engineering and porting of Neuromant. 

 Reverse "Neuromant". Part 1: S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse "Neuromant". Part 4: Sound, Animation, Huffman, Github</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, as you already understood, this is a continuation of my history of reverse engineering and porting of Neuromant. </p><br><img src="https://habrastorage.org/webt/-g/ru/d_/-grud_xhetuzh4znt4rbkeakxyi.png"><br><blockquote>  <a href="https://habr.com/post/352050/">Reverse "Neuromant".</a>  <a href="https://habr.com/post/352050/">Part 1: Sprites</a> <br>  <a href="https://habr.com/post/357972/">Reverse "Neuromant".</a>  <a href="https://habr.com/post/357972/">Part 2: Render the Font</a> <br>  <a href="https://habr.com/post/415555/">Reverse "Neuromant".</a>  <a href="https://habr.com/post/415555/">Part 3: Finished Rendering, Making the Game</a> </blockquote><p>  Today we start with two good news: </p><br><ul><li>  Firstly, I am no longer alone - the user <a href="https://habr.com/users/viiri/" class="user_link">viiri has</a> joined the project and has already managed to make a tangible contribution; </li><li>  secondly, we now have an open repository on <a href="https://github.com/HenadziMatuts/Reuromancer"><em>github</em></a> . </li></ul><br><p>  In general, things are going very well and, perhaps, soon we will get at least some playable build.  And under the cut, as usual, let's talk about what and <em>how we</em> managed to achieve at the moment. </p><a name="habracut"></a><br><hr><br><p>  Began to deal with the sound.  Alas, among the game resources there was nothing like audio, and since I had no idea how music works in <em>MS-DOS</em> , it was extremely incomprehensible where to start.  After reading a bit about any <em>SoundBlaster</em> , the best I thought of was to scroll the disassembled code in the hope of seeing some familiar signatures.  And whoever searches, he usually finds, even if not exactly what he was looking for (comments are stamped by <em>Ida</em> ): </p><br><pre><code class="hljs vhdl">sub_20416: ... mov ax, [si+<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ; <span class="hljs-number"><span class="hljs-number">8253</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov bx, [si+<span class="hljs-number"><span class="hljs-number">0</span></span>Ah] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bl, <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ; PC/XT PPI <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> B bits: ; <span class="hljs-number"><span class="hljs-number">0</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> gate ‚ïê‚ï¶‚ïê‚ñ∫ <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>H=spkr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> data ‚ïê‚ïù <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>fcH=spkr OFF ; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>=read high switches ; <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable RAM parity checking ; <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable I/O channel check ; <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=hold keyboard clock low ; <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable kbrd <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">0</span></span>FCh <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, bl <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ; PC/XT PPI <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> B bits: ; <span class="hljs-number"><span class="hljs-number">0</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> gate ‚ïê‚ï¶‚ïê‚ñ∫ <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>H=spkr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> data ‚ïê‚ïù <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>fcH=spkr OFF ; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>=read high switches ; <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable RAM parity checking ; <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable I/O channel check ; <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=hold keyboard clock low ; <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable kbrd</code> </pre> <br><p>  Googling this <em>Timer 8253-5</em> I came across <a href="http://www.intel-assembler.it/portale/5/make-sound-from-the-speaker-in-assembly/8255-8255-8284-asm-program-example.asp">an article</a> that became the first key to understanding what was happening.  Below I will try to explain what's what. </p><br><p>  So, in the era of <em>IBM-PC</em> , before the availability of sound cards, the most common audio playback device was the so-called <em>PC Speaker</em> , also known as "beeper."  This device is nothing more than a normal speaker, connected to the motherboard, in most cases, through a four-pin connector.  Beeper, as planned, allowed to reproduce a two-level rectangular pulse (corresponding to two voltage levels, usually 0V and + 5V) and was controlled via the 61st port of the <em>PPI</em> controller <em>(Programmable Peripheral Interface)</em> .  Specifically, the first two bits of the value sent to the port are responsible for controlling the ‚Äúspeaker‚Äù (see comments to the strings <code>in al, 61h</code> and <code>out 61h, al</code> ). </p><br><p>  As I said (in a few other words), our speaker can be in two states - <em>‚Äúin‚Äù</em> and <em>‚Äúout‚Äù</em> ( <em>‚Äúlow‚Äù - ‚Äúhigh‚Äù</em> , <em>‚Äúoff‚Äù - ‚Äúon‚Äù</em> , <em>‚Äúoff‚Äù - ‚Äúon‚Äù</em> , as you wish).  To create a <em>single</em> pulse, you need to change the current state to the opposite and, after some time, back.  This can be done directly by manipulating the first bit (counting from scratch) of port 61, for example, like this: </p><br><pre> <code class="hljs vhdl">PULSE: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b ;    ... <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000010</span></span>b ;     ... ; ,        <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;    <span class="hljs-number"><span class="hljs-number">61</span></span>-  mov cx, <span class="hljs-number"><span class="hljs-number">100</span></span> ;   DELAY: <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> DELAY ;    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b ;     <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;    <span class="hljs-number"><span class="hljs-number">61</span></span>- </code> </pre> <br><p>  The result of the execution of this code will look as follows: </p><br><pre> <code class="hljs delphi"> loop DELAY +<span class="hljs-number"><span class="hljs-number">5</span></span>V +----------------------+ ! ! <span class="hljs-number"><span class="hljs-number">0</span></span>V ---+ +-------------------------- <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000010</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al</code> </pre> <br><p>  Repeating <em>PULSE</em> with a delay, we get a square wave: </p><br><pre> <code class="hljs erlang-repl"> mov dx, <span class="hljs-number"><span class="hljs-number">100</span></span> ;  <span class="hljs-number"><span class="hljs-number">100</span></span>  PULSE: ... mov cx, <span class="hljs-number"><span class="hljs-number">100</span></span> WAIT: loop WAIT dec dx jnz PULSE PULSE +<span class="hljs-number"><span class="hljs-number">5</span></span>V +---------+ +---------+ +---------+ ! ! ! ! ! ! <span class="hljs-number"><span class="hljs-number">0</span></span>V ---+ +---------+ +---------+ +--- loop WAIT</code> </pre><br><p>  If in the first case we would hardly have heard something, then in the second we will get a tone of frequency depending on the speed of the machine at which this code is executed.  This is great, but it is associated with certain difficulties.  In any case, there is a more convenient way to control the speaker. </p><br><p>  Here a programmable three-channel timer comes into play - the <em>Intel 8253</em> , the second channel of which (starting from zero) is connected to the beeper.  This timer receives a signal from the <em>Intel 8254</em> clock chip, sending 1193180 pulses per second (~ 1.193 MHz), and can be programmed for a specific reaction after the specified number of pulses.  One of these reactions is sending a square pulse to a speaker.  In other words, the <em>8253</em> can operate in the mode of a rectangular signal generator with an adjustable frequency; this makes it relatively easy to synthesize various sound effects on a speaker.  And here's what you need to do: </p><br><ol><li>  Set the second channel of the timer to generate a square wave.  To do this, write a special single-byte value to port 43 ( <em>8253 Mode / Command register</em> ).  In my case, this is <code>10110110B</code> (more <code>10110110B</code> <a href="https://wiki.osdev.org/Programmable_Interval_Timer">here</a> ): </li></ol><br><pre> <code class="markdown hljs">Bits Usage 6 and 7 Select channel : 1 0 = Channel 2 4 and 5 Access mode : 1 1 = Access mode: lobyte/hibyte 1 to 3 Operating mode : 0 1 1 = Mode 3 (square wave generator) 0 BCD/Binary mode: 0 = 16-bit binary</code> </pre> <br><ol><li><p>  Set the desired frequency on the second channel.  To do this, byte-by-byte, from low to high, we send to the 42nd port ( <em>8253 Channel 2 data port</em> ) a value of <code>1193180 / freq</code> , where <code>freq</code> is the required frequency value in Hertz. </p><br></li><li><p>  Allow the speaker to receive impulses from the timer.  To do this, set to the first two bits of the value in port 61 ( <em>PPI</em> ).  The fact is that if the zero bit is set to 1, then the first is interpreted as a ‚Äúswitch‚Äù: </p><br></li></ol><br><pre> <code class="markdown hljs">Bit 0 Effect ----------------------------------------------------------------- 0 The state of the speaker will follow bit 1 of port 61h 1 The speaker will be connected to PIT channel 2, bit 1 is used as switch ie 0 = not connected, 1 = connected.</code> </pre> <br><p>  As a result, we have the following picture: </p><br><pre> <code class="hljs vhdl"> mov al, <span class="hljs-number"><span class="hljs-number">10110110</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>h, al ;   mov ax, <span class="hljs-number"><span class="hljs-number">02E9</span></span>Bh ; <span class="hljs-number"><span class="hljs-number">1193180</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span> = ~<span class="hljs-number"><span class="hljs-number">0</span></span>x2E9B <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ;      mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ;      <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000011</span></span>b ;      <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;   ... ;       ~<span class="hljs-number"><span class="hljs-number">100</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;  </code> </pre> <br><p>  And this is exactly what the code I did at the very beginning does (except for initialization, but I found it in another function): at <code>si + 8</code> there is a frequency divider sent to port 42, and at <code>si + 0Ah</code> - the state of the speaker ( <em>"on" - "off"</em> ), recorded in port 61. </p><br><p>  The playback mechanism is simple and clear, but then it was necessary to deal with the timings.  Having studied the nearby code, I saw that in the same function in which the timer is initialized ( <code>sub_2037A</code> , then - <code>init_8253</code> ), the <a href="http://assemblytutorial.blogspot.com/2010/09/interrupt-8-time-of-day.html">eighth interrupt</a> handler <a href="http://assemblytutorial.blogspot.com/2010/09/interrupt-8-time-of-day.html">( <em>Time of Day</em> ) is</a> <code>sub_20416</code> function (hereafter - <code>play_sample</code> ).  It soon became clear that this interrupt is generated approximately 18.2 times per second and serves to update the system time.  Replacing this interrupt handler is a common practice if you need to perform some action 18 times per second (in fact, you must also call the original handler inside the hook, otherwise the system time will stop).  Based on this, it turns out that the next frequency is charged to the generator every <code>(1 / 18.2) * 1000 ~ 55</code> . </p><br><p>  The plan was: </p><br><ul><li>  put a breakpoint in the <code>play_sample</code> function, on the line where the next frequency divider is extracted; </li><li>  calculate the frequency using the formula <code>freq = 1193180 / divisor</code> ; </li><li>  generate 55ms of freq square wave signal in some audio editor (I used <em>Adobe Audition</em> ); </li><li>  repeat the first three steps to accumulate at least 3 seconds. </li></ul><br><p>  So I got the beginning of the melody from the main menu, but playing times 10 times slower than necessary.  Then I shortened the sample duration from 55 ms to 5 ms - it became much better, but still not that.  The issue with timings remained open until I found <a href="https://books.google.by/books%3Fid%3DaAtUrtU87kQC%26lpg%3DPT422%26dq%3Dplaying%2520music%2520with%25208253%2520timer%26pg%3DPT422">this article</a> .  It turned out that the eighth interrupt is generated from the filing of the same <em>8253</em> , the zero channel of which is connected to the interrupt controller ( <em>PIC</em> ).  During machine boot, the <em>BIOS</em> sets the zero channel to generate pulses with a frequency of ~ 18.2 Hz (that is, an interrupt is generated every ~ 54.9 ms).  However, the zero channel can be reprogrammed so that it generates pulses with a higher frequency. To do this, by analogy with the second channel, the 40th port needs to write a value equal to <code>1193180 / freq</code> , where <code>freq</code> is the required frequency value in Hertz.  This is what happens in the function <code>init_8253</code> , just initially I did not pay enough attention to this: </p><br><pre> <code class="hljs objectivec">init_8253: ... mov al, <span class="hljs-number"><span class="hljs-number">0</span></span>B6h ; <span class="hljs-number"><span class="hljs-number">10110110</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov ax, <span class="hljs-number"><span class="hljs-number">13</span></span>B1h <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>).</code> </pre> <br><p>  <code>13B1h</code> translate the <code>13B1h</code> value into the frequency: <code>1193180 / 13B1h ~ 236.7</code> , then we get approximately <code>(1 / 236.7) * 1000 ~ 4.2</code> to the ‚Äúsample‚Äù.  The puzzle has developed. </p><br><p>  Next is the case of technology - to implement a function that extracts sound tracks from the game.  But here's the thing, the values ‚Äã‚Äãof frequency dividers recorded in the 42nd port are not stored explicitly.  They are calculated by a certain cunning algorithm, the input data and the working area of ‚Äã‚Äãwhich lie directly in the executable file of the game (in the seventh segment according to <em>Ida</em> ).  Also, among the features, there is no indication of the end of the track, when there is nothing more to play, the algorithm infinitely produces the zero state of the speaker.  But I did not bother, and, as in the case of the decompression algorithm ( <a href="https://habr.com/post/352050/">first part</a> ), I simply ported to 64-bit assembler the function of setting the track for playback and the algorithm for obtaining the next frequency (I took the seventh segment as a whole). </p><br><p>  And it worked.  After that, I implemented the soundtrack generation functions for the selected track ( <em>PCM, 44100 Hz, 8 bit, mono</em> ; I did something like a generator used in a speaker emulator in <em>DosBox</em> ).  I solved the problem with the termination sign with a simple silence counter: counted a second ‚Äî we complete the algorithm.  Wrapping the resulting track into a <em>WAV</em> header, and saving the result to a file, I got exactly the track from the main menu.  And 13 more tracks that you can listen to below <em>[or in the resource viewer, which now has a built-in player and the ability to save any track to .WAV]</em> : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://w.soundcloud.com/player/" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>[Studying the question, I also learned about the more advanced ‚Äúbeeper playing‚Äù techniques, such as using pulse-width modulation for low-quality PCM audio playback.</em>  <em>At the end of this article I will give a list of materials from which you can learn more.]</em> </p><br><hr><br><p>  In the <a href="https://habr.com/post/357972/">second part</a> , when different resource formats were considered, I assumed that in <em>.ANH</em> files there are animations for backgrounds of locations (that is, for images stored in <em>.PIC</em> ).  <em>[This is so.]</em> Having finished with the sound, I decided to check it out.  Purely based on the assumption that the animation is applied directly to the image of the backdrop stored in memory (not in <em>video memory</em> , but in <em>sprite-chain</em> ), I decided to make dumps of this memory, respectively, before and after applying the animation (look where the cursor points - at the top the string of the letter 'S'): </p><br><p><img src="https://habrastorage.org/webt/zp/9a/qn/zp9aqnvcvi-gn3pp0t1puzvhpti.gif" width="32%" height="32%"><img src="https://habrastorage.org/webt/jz/9l/ig/jz9ligummo9j_xwwatid-s0vcri.png" width="32%" height="32%"><img src="https://habrastorage.org/webt/sz/pd/uy/szpduyzc7lgsqum_np9sbvrq4qo.png" width="32%" height="32%"></p><br><pre> <code class="markdown hljs">3DE6:0E26 03 B4 44 B3 ... ;   3DE6:0E26 03 BC CC B3 ... ;  </code> </pre> <br><p>  Exactly what I expected - dark red color (0x4) changed to bright red (0xC).  Now you can try to set a breakpoint to change the value at the address, for example, <code>3DE6:0E28</code> and, if you're lucky, do a reverse trace.  <em>[I was lucky.]</em> The breakpoint led me to a line that directly changes the value at a given address: <code>xor es:[bx], al</code> .  After examining the surroundings, I easily built a chain of calls from the main loop of the level up to this point: <code>sub_1231E (xor es:[bx], al) &lt;- sub_12222 &lt;- sub_105F6 &lt;- sub_1038F ( )</code> . </p><br><p>  I will not go into details about how I reverse the animation process.  This is a fairly routine and methodical work, but not very difficult if the boundaries are clearly defined (the backtrack obtained is these boundaries).  But I can not tell you about what happened in the end. </p><br><p>  First about the <em>.ANH</em> format.  In fact, it is a set of containers, and the first word in the <em>.ANH</em> file is the number of containers inside: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> anh_entries; <span class="hljs-comment"><span class="hljs-comment">/* first entry hdr */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>;</code> </pre> <br><p>  By itself, a container is a separately taken animation of the background element.  The container can have a header that contains its byte size and the number of frames in the animation it represents.  Following the header, the duration (delay) of the next frame and the byte offset of the frame itself, relative to the bytes of the first frame, go in pairs.  The number of such pairs is obviously equal to the number of frames: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_entry_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> entry_size; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> total_frames; <span class="hljs-comment"><span class="hljs-comment">/* anh_frame_data_t first_frame_data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* another frames data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* anh_frame_hdr first_frame_hdr */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* another frames */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_frame_data_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_sleep; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_offset; } <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>*)anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span> *entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)(anh + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; anh-&gt;anh_entries; u++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)entry; <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *first_frame_data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)(p + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_bytes = p + (entry-&gt;total_frames * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; entry-&gt;total_frames; k++) { <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *frame_data = first_frame_data + k; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *frame_bytes = first_frame_bytes + frame_data-&gt;frame_offset; ... } <span class="hljs-comment"><span class="hljs-comment">/* plus 2 bytes of padding */</span></span> p += (entry-&gt;entry_size + <span class="hljs-number"><span class="hljs-number">2</span></span>); entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)p; }</code> </pre><br><p>  A separate frame consists of a four-byte header containing its linear dimensions and displacements relative to the background image, and frame pixels encoded by the <em>Run Length</em> algorithm I already know: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_frame_hdr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bg_x_offt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bg_y_offt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_width; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_height; <span class="hljs-comment"><span class="hljs-comment">/* rle encoded frame bytes */</span></span> };</code> </pre> <br><p>  "Overlay" frame on the backdrop may look like this: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *level_bg; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_pix[<span class="hljs-number"><span class="hljs-number">8192</span></span>]; anh_frame_hdr *hdr = (anh_frame_hdr*)frame_bytes; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_len = hdr-&gt;frame_width * hdr-&gt;frame_height; decode_rle(frame + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(anh_frame_hdr), frame_len, frame_pix); <span class="hljs-comment"><span class="hljs-comment">/* 0xFB4E - some magic value, have no idea what is it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bg_offt = (hdr-&gt;bg_y_offt * <span class="hljs-number"><span class="hljs-number">152</span></span>) + hdr-&gt;bg_x_offt + <span class="hljs-number"><span class="hljs-number">0xFB4E</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bg_skip = <span class="hljs-number"><span class="hljs-number">152</span></span> - hdr-&gt;frame_width; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p1 = frame_pix, *p2 = level_bg; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> i = hdr-&gt;frame_height; i != <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> j = hdr-&gt;frame_width; j != <span class="hljs-number"><span class="hljs-number">0</span></span>; j--) { *p2++ ^= *p1++; } p2 += bg_skip; }</code> </pre> <br><p>  This is the <em>.ANH format</em> , but there is another structure that makes it all work: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bg_animation_control_table_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> total_frames; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_data; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_bytes; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sleep; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> curr_frame; } <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span>;</code> </pre> <br><p>  In the game itself, an array of at least four structures of this type is globally declared.  After loading the next <em>.ANH</em> file, the number of animations inside is also saved to the global variable, and the array elements are initialized as follows: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *anh; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> g_anim_amount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span> g_anim_ctl[<span class="hljs-number"><span class="hljs-number">4</span></span>]; ... <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>*)anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span> *entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)(anh + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>)); g_anim_amount = hdr-&gt;anh_entries; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; g_anim_amount; u++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)entry; g_anim_ctl[u].total_frames = entry-&gt;total_frames; g_anim_ctl[u].first_frame_data = p + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>); g_anim_ctl[u].first_frame_bytes = g_anim_ctl[u].first_frame_data + (entry-&gt;total_frames * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>)); g_anim_ctl[u].sleep = *(<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>*)(g_animation_control[u].first_frame_data); g_anim_ctl[u].curr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* plus 2 bytes of padding */</span></span> p += (entry-&gt;entry_size + <span class="hljs-number"><span class="hljs-number">2</span></span>); entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)p; }</code> </pre><br><p>  Finally, apply animations: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; g_anim_amount; u++) { <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span> *anim = &amp;g_anim_ctl[u]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anim-&gt;sleep-- == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)anim-&gt;first_frame_data + anim-&gt;curr_frame; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (++anim-&gt;curr_frame == anim-&gt;total_frames) { anim-&gt;curr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)anim-&gt;first_frame_data; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { data++; } anim-&gt;sleep = data-&gt;frame_sleep; } }</code> </pre> <br><p>  And we get the following <em>[much more can be viewed in the resource viewer]</em> : </p><br><div class="spoiler">  <b class="spoiler_title">R2.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p7/lv/fn/p7lvfn5ytpjm5nsoctsumdncuaa.gif"></div></div><br><div class="spoiler">  <b class="spoiler_title">R6.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/j6/nb/xp/j6nbxpj29jlrikbmjl8f62s4xmc.gif"></div></div><br><p>  There are a couple of problems with animation at the moment.  The first is that in my code I play all the available animations, but the original checks for some global flags, indicating whether to scroll through the next one.  And the second, due to the fact that some animations add objects to the screen that are not there initially.  And since the frames are ‚Äúciting‚Äù on the background, then with cyclic scrolling, the object simply disappears on every second lap.  Here, for example, how it might look like: </p><br><div class="spoiler">  <b class="spoiler_title">R53.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d3/5l/iu/d35liujvu6ash9gcdrecvoq9kuc.gif"></div></div><br><p>  But for now, let's leave it at that. </p><br><hr><br><p>  Remember the unknown decompression algorithm from the <a href="https://habr.com/post/352050/">first part</a> ?  Having barely connected to the development, <a href="https://habr.com/users/viiri/" class="user_link">viiri</a> not only determined what kind of algorithm it was, but also wrote his own version of the decoder, replacing the awful three-lined piece of Assembler in the codebase.  In this regard, I asked <a href="https://habr.com/users/viiri/" class="user_link">viiri</a> to write a short essay on the work done.  What was done, but before I give it, a few words need to be said about the theory. </p><br><p>  To compress resources, <em>Neuromant</em> developers used <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25B4_%25D0%25A5%25D0%25B0%25D1%2584%25D1%2584%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0"><em>Huffman code</em></a> .  This is one of the first effective methods for encoding information using <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D1%2584%25D0%25B8%25D0%25BA%25D1%2581%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4"><em>prefix codes</em></a> .  In coding theory, <em>prefix</em> codes are codes with a word of variable length and those in which no code word is a prefix of another.  That is, if the word <em>‚Äúa‚Äù</em> is part of the prefix code, then the word <em>‚Äúab‚Äù</em> does not exist in the code.  This property allows you to uniquely break into words the message encoded by such code. </p><br><p>  The idea of ‚Äã‚Äãthe Huffman algorithm is that, knowing the probabilities of the appearance of symbols of a certain alphabet in a message, one can describe the procedure for constructing codes of variable length, consisting of an integer number of bits.  Characters with a higher probability of occurrence are assigned shorter codes, while characters with a lower probability are, on the contrary, longer codes.  In general, the coding procedure is reduced to the construction of an optimal code tree and, based on it, the mapping of the message symbol to the corresponding code.  The prefix property of the resulting code allows you to uniquely decode the compressed message. </p><br><div class="spoiler">  <b class="spoiler_title">Huffman.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fa/is/hb/faishbcvf0flxiao-mfmnx3llvu.gif"></div></div><br><p>  The algorithm has one major drawback (in fact, not one, but now only this one is important).  The fact is that in order to restore the contents of a compressed message, the decoder must know the table of frequency of appearance of characters used by the encoder.  In this regard, together with the encoded message, either the probability table or the code tree itself must be transmitted (the variant used in the game).  The size of the additional data can be relatively large, and this significantly increases the compression efficiency. </p><br><p>  Something about how to deal with this, as well as about your decoder and the one that is implemented in the game, tells <a href="https://habr.com/users/viiri/" class="user_link">viiri</a> : </p><br><blockquote>  Immediately it is worth mentioning that the whole game was completely written in Assembler, by hand, so the code contains interesting solutions, tricks and optimizations. <br><br>  According to the procedures.  The <code>sub_1ff94</code> ( <code>build_code_table</code> ) function is needed to load a Huffman tree from a file.  To decode a static Huffman (sometimes a <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B4%25D0%25B0%25D0%25BF%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%25A5%25D0%25B0%25D1%2584%25D1%2584%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">dynamic one</a> , and this requirement does not apply to it), along with the message, you must pass a code tree, which is the mapping of Huffman codes to real character codes.  This tree is big enough and therefore it would be nice to store it somehow.  The most correct way is to use <a href="https://www.sciencezero.org/index.php%3Ftitle%3DHuffman_coding">canonical codes</a> ( <a href="https://en.wikipedia.org/wiki/Canonical_Huffman_code">MOAR</a> ).  Due to their properties, there is a very interesting and efficient way to store a tree (used in the implementation of the <em>Deflate</em> compression method of the archiver <em>PKZip</em> ).  But in the game, canonical codes are not used, instead a <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2585%25D0%25BE%25D0%25B4_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25B0">direct traversal of the tree is</a> performed and for each vertex bit 0 is written to the output stream if the node is not a leaf, or bit 1 if the node is a leaf, then the next 8 bits are the character code in this the node.  When decoding a similar traversal of the tree, which we see in the game.  <a href="https://stackoverflow.com/questions/759707/efficient-way-of-storing-huffman-tree">There</a> is an example and some explanation. </blockquote><br><div class="spoiler">  <b class="spoiler_title">build_code_table</b> <div class="spoiler_text"><pre> <code class="hljs sql">build_code_table proc near <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getbit ;     jb short loc_1FFA9 ;   ... shl dx, 1 inc bx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> build_code_table ;  build_code_table    or dl, 1 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> build_code_table ;  build_code_table    shr dx, 1 dec bx ret loc_1FFA9: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> sub_1FFC2 ;      (8 ) ... ;     ret sub_1FF94 endp sub_1FFC2 proc near sub di, di mov ch, 8 loc_1FFC6: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getbit rcl di, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dec</span></span> ch jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_1FFC6 retn sub_1FFC2 endp</code> </pre> </div></div><br><blockquote>  <code>getbit</code> ( <code>sub_1ffd0</code> ) reads a bit from the input stream.  Her analysis allows us to conclude that the individual bits are allocated from the 16-bit register <code>ax</code> , the value of which is loaded from memory with the <code>lodsw</code> instruction, which loads two bytes from the stream, but since the <em>Intel processor</em> is in <em>little-endian</em> byte order, <code>xchg</code> half of the register.  Further, the order of bits in the stream looks somewhat illogical - the first is not the youngest, but the high bit.   ,   <code>shl</code>      ,        <code>jb</code> . </blockquote><br><div class="spoiler"> <b class="spoiler_title">getbit</b> <div class="spoiler_text"><pre> <code class="hljs delphi">getbit proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> cl, cl jz short loc_1FFD9 dec cl <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn loc_1FFD9: cmp si, <span class="hljs-number"><span class="hljs-number">27</span></span>B6h jz short loc_1FFE7 ;   lodsw xchg al, ah mov cl, <span class="hljs-number"><span class="hljs-number">0</span></span>Fh <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn loc_1FFE7: call sub_202FC ;      lodsw xchg al, ah mov cl, <span class="hljs-number"><span class="hljs-number">0</span></span>Fh <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn getbit endp</code> </pre> </div></div><br><p>    <a href="https://habr.com/users/viiri/" class="user_link">viiri</a>  ,    : </p><br><div class="spoiler"> <b class="spoiler_title">huffman_decompress</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> value; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node_t</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">left</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">right</span></span></span><span class="hljs-class">;</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *g_src = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getbits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numbits)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getl_le</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*       4-    */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> node_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_tree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *node = (<span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>*)<span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getbits(<span class="hljs-number"><span class="hljs-number">1</span></span>)) { node-&gt;right = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; node-&gt;left = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; node-&gt;value = getbits(<span class="hljs-number"><span class="hljs-number">8</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { node-&gt;right = build_tree(); node-&gt;left = build_tree(); node-&gt;value = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">huffman_decompress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length, i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *root, *node; g_src = src; length = getl_le(); node = root = build_tree(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (i &lt; length) { node = getbits(<span class="hljs-number"><span class="hljs-number">1</span></span>) ? node-&gt;left : node-&gt;right; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!node-&gt;left) { dst[i++] = node-&gt;value; node = root; } } ... }</code> </pre></div></div><br><p>       : </p><br><blockquote>    <code>build_code_table</code>    .     ,         ,                .     ,                 .     ,           ,    ,       ‚Äî   (    <code>huffman_decompress</code> ). <br><br>     ?  Right!       !  <a href="http://commandlinefanatic.com/cgi-bin/showarticle.cgi%3Farticle%3Dart007"></a> ,   .       ( <em> </em> ):          . ,         3- ,         <em>N</em>  ,  <em>(3 ‚Äî N)</em>     . </blockquote><p>       <code>ABCD</code> : <code>A - 0b, B - 10b, C - 110b, D - 111b</code> .       (  ),      ,     : </p><br><table><thead><tr><th>  Code </th><th>  Length </th><th>  Symbol </th></tr></thead><tbody><tr><td> <strong>0</strong> 00b </td><td>  one </td><td>  A </td></tr><tr><td> <strong>10</strong> 0b </td><td>  2 </td><td>  B </td></tr><tr><td> <strong>110</strong> b </td><td>  3 </td><td>  C </td></tr><tr><td> <strong>111</strong> b </td><td>  3 </td><td>  D </td></tr></tbody></table><br><p>       ,               .  , , ,      <code>010b</code> ‚Äî     .       .  ,   'A'   <code>0b</code> ,     <em> </em>  ,    .     : </p><br><table><thead><tr><th>  Index </th><th>  Code </th><th>  Length </th><th>  Symbol </th></tr></thead><tbody><tr><td>  0 </td><td> <strong>0</strong> 00b </td><td>  one </td><td>  A </td></tr><tr><td>  one </td><td> <strong>0</strong> 01b </td><td>  one </td><td>  A </td></tr><tr><td>  2 </td><td> <strong>0</strong> 10b </td><td>  one </td><td>  A </td></tr><tr><td>  3 </td><td> <strong>0</strong> 11b </td><td>  one </td><td>  A </td></tr><tr><td>  four </td><td> <strong>10</strong> 0b </td><td>  2 </td><td>  B </td></tr><tr><td>  five </td><td> <strong>10</strong> 1b </td><td>  2 </td><td>  B </td></tr><tr><td>  6 </td><td> <strong>110</strong> b </td><td>  3 </td><td>  C </td></tr><tr><td>  7 </td><td> <strong>111</strong> b </td><td>  3 </td><td>  D </td></tr></tbody></table><br><p> ,    <code>011010111b</code> : </p><br><ul><li>     : <code>011b</code> ; </li><li>  ,   <code>011b (3)</code> ,   <code>A</code> ,     ; </li><li>   <code>011b</code>    1, ,                 : <code>110b</code> ; </li><li>  ,   <code>110b (6)</code> ,   <code></code> ,     ; </li><li>   ,     . </li></ul><br><p>  ¬´¬ª     8- .      256 .          8 .   ,    ,  : </p><br><blockquote>           :      ‚Äî  ,          .   ,    .   4 ‚Äî   32- . </blockquote><p>     ,   .  . </p><br><hr><br><p>       ,      <a href="https://github.com/HenadziMatuts/Reuromancer"><em>github</em></a> .     ,       ,     ,   -   <em>[ ,    README.md]</em> . </p><br><p>  ,    ,     2015- : </p><br><ul><li> <em>LibNeuroRoutines (, MASM)</em> ‚Äî ,       ,    .    ( <code>neuro_routines.h</code> )           ,   .     , : <br><ul><li>   ( <code>huffman_decompression.c</code> , <code>decompression.c</code> ); </li><li>    ( <code>cp437.c</code> ); </li><li>     ( <code>dialog.c</code> ); </li><li>    ( <code>audio.c</code> ). </li></ul></li><li> <em>NeuromancerWin64 ()</em> ‚Äî     .                .     ,       <em>¬´¬ª</em> ,    ,       .       <em>CSFML</em> ( <em>SFML</em>   <em>C</em> ). </li><li> <em>ResourceBrowser (C++)</em> ‚Äî  .    <em>MFC</em> -,         <em>.DAT</em> -.    : <br><ul><li>     <em>BMP (8bpp)</em>  ( <em>IMH</em> , <em>PIC</em> ); </li><li>   ( <em>ANH</em> ); </li><li>     <em>WAV (PCM, 44100Hz, 8bps, mono)</em>  ( <em>SOUND</em> ). </li></ul></li></ul><br><p>    <em>LibNeuroRoutines</em>   .    <em>LibNeuroRoutines</em>  <em>CSFML</em> ( <em>ResourceBrowser</em>   <em>SFML</em>   ). </p><br><p>       64- <em>Windows</em>     .   ,   <em>LibNeuroRoutines</em>  64- <em>MASM (Microsoft Macro Assembler)</em> .   ‚Äî    ,      64- . ,      <em>NASM</em>  <em>FASM</em> ,    ,             .      <em>VS 2015</em> ‚Äî <em>MASM</em>   . </p><br><p>      ,   .         <em>C</em> .     ,           (  ,   <em>MFC</em> ). </p><br><p>   ,       .   - ,      . </p><br><hr><br><p>           .  ? ,  .            ,   .    - ,      . ,    ,     ,     .  (). </p><br><ol><li> <a href="http://www.intel-assembler.it/portale/5/make-sound-from-the-speaker-in-assembly/8255-8255-8284-asm-program-example.asp">Make sound from the speaker using assembly</a> </li><li> <a href="http://www.intel-assembler.it/portale/5/Programming-the-PC-Speaker/Programming-the-PC-Speaker-8253-8254.asp">Programming the PC Speaker</a> </li><li> <a href="https://wiki.osdev.org/PC_Speaker">PC Speaker</a> </li><li> <a href="https://wiki.osdev.org/Programmable_Interval_Timer">Programmable Interval Timer</a> </li><li> <a href="https://books.google.by/books%3Fid%3DaAtUrtU87kQC%26lpg%3DPT422%26dq%3Dplaying%2520music%2520with%25208253%2520timer%26pg%3DPT422">Making C Sing</a> </li><li> <a href="https://bumbershootsoft.wordpress.com/2016/12/10/beyond-beep-boop-mastering-the-pc-speaker/">Beyond Beep-Boop: Mastering the PC Speaker</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/417639/">https://habr.com/ru/post/417639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417621/index.html">What happened when we hacked the show?</a></li>
<li><a href="../417627/index.html">Hyper CRM or mini ERP? Business is confused</a></li>
<li><a href="../417629/index.html">Delphi and C ++ Builder Community Edition</a></li>
<li><a href="../417631/index.html">CSS Grid Video Tutorial</a></li>
<li><a href="../417637/index.html">Development of an editor for creating web sites / landing pages (experience)</a></li>
<li><a href="../417641/index.html">10 summer courses for machine learning</a></li>
<li><a href="../417643/index.html">Knights of the cloak and rootkits: what to see about hackers. TV series</a></li>
<li><a href="../417645/index.html">Programming Contest: Trading (interim results and announcements)</a></li>
<li><a href="../417647/index.html">Belarus has a draft law on the protection of personal data - what is ‚Äúinside‚Äù?</a></li>
<li><a href="../417649/index.html">OpenAI has overcome significant limitations in Dota 2 AI games.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>