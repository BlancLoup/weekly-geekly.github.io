<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your Cocaine. Yandex cloud platform</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We already told on Habr√© about the cloud infrastructure of Yandex. Today came the turn from words to action - we want to show in steps how to deploy y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your Cocaine. Yandex cloud platform</h1><div class="post__text post__text-html js-mediator-article">  We already <a href="http://habrahabr.ru/company/yandex/blog/209324/">told</a> on Habr√© about the cloud infrastructure of Yandex.  Today came the turn from words to action - we want to show in steps how to deploy your own cloud on Elliptics and Cocaine. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/214069/"><img src="https://habrastorage.org/getpro/habr/post_images/e40/0ef/ca5/e400efca5a67bf741ae2ee2468bffbbd.jpg"><br></a> <br><h2>  Scheme </h2><br>  Let's take a look at installing a small cloud in which you can run a <a href="https://github.com/cocaine/cocaine-framework-python/tree/v0.11/examples/flask">test application</a> using <b>flask</b> . <br><br>  This cloudlet consists of the following elements: <br><ul><li>  <b>cocaine-runtime</b> , which runs applications in Docker; </li><li>  <b>Docker-registry</b> for storing images of applications; </li><li>  <b>Elliptics</b> as a distributed application repository, as well as a cloud configuration; </li><li>  <b>aggregating node cocaine-runtime</b> - a single point of entry into the cloud for the client cocaine code; </li><li>  <b>HTTP frontend</b> as an alternative way to access applications. </li></ul><br><a name="habracut"></a><br>  At each stage we will carry out checks that test the success of the stage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/e88/65b/73f/e8865b73fa8aec9dc83ac2d38b3b8120.jpg"><br><br>  As you can see, we will need <b>5</b> (possible virtual) machines with a kernel of at least <b>3.8</b> to support <b>Docker</b> .  Required packages can be found in the <a href="http://repo.reverbrain.com/">repository</a> . <br><br><div class="spoiler">  <b class="spoiler_title">How to add a repository</b> <div class="spoiler_text">  Create <b>/etc/apt/sources.list.d/reverbrain.list as</b> follows: <br><pre><code class="bash hljs">deb http://repo.reverbrain.com/precise/ current/amd64/ deb http://repo.reverbrain.com/precise/ current/all/</code> </pre> <br>  Pull up the key: <br><pre> <code class="bash hljs">curl -O http://repo.reverbrain.com/REVERBRAIN.GPG sudo apt-key add REVERBRAIN.GPG</code> </pre><br>  Let's see which cocaine-related packages have become available: <br><pre> <code class="bash hljs">apt-get update apt-cache search cocaine</code> </pre></div></div><br><br><h4>  5 minutes on elliptics </h4><br>  I will have to briefly describe how to deploy the <b>Elliptics</b> installation from <i>one</i> machine to demonstrate the work of our cluster.  Immediately, I note that this can in no way be considered as a guide for deploying this Elliptics for combat use.  This is sure to tell you the guys who are engaged in the development of Elliptics.  Also information can be found in the <a href="http://doc.reverbrain.com/elliptics:server-tutorial">documentation</a> . <br><br>  In a couple of commands, it looks like this: <br><pre> <code class="bash hljs">sudo apt-get install elliptics=2.24.14.31 elliptics-client=2.24.14.31 mkdir /tmp/<span class="hljs-built_in"><span class="hljs-built_in">history</span></span>/ &amp;&amp; mkdir /tmp/root cp /usr/share/doc/elliptics/examples/ioserv.conf ./tst_ioserv.conf</code> </pre><br><br>  Further, in <b>tst_ioserv.conf</b> we will have to change literally 3 lines.  So: <br><pre> <code class="bash hljs">group = 1 addr = localhost:1025:2-0 192.168.50.201:1025:2-1 //    IP indexes_shard_count = 16</code> </pre><br>  After this, run: <br><pre> <code class="bash hljs">dnet_ioserv -c tst_ioserv.conf</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/c14/887/b0e/c14887b0eef5ee9265ede751c4ff4c86.png"><br><br><h4>  Setup cocaine-runtime + Docker </h4>  Let's start the implementation of our mini-cloud with the configuration of machines that directly run the code of our application.  The core of the installation will definitely be <b>cocaine-runtime</b> .  You also need to install <b>Docker</b> itself and <b>cocaine-plugin</b> to work with <b>Docker</b> . <br><br>  I‚Äôll clarify that although our goal is to run the application in a docker container, we will also start the application as a normal process. <br><br>  Containerization is a blessing.  It solves environmental problems for the application: <br><ul><li>  dependences are always with us; </li><li>  no conflicts between dependencies of two applications; </li><li>  invariance of the environment in dev, test, prod environments. </li></ul><br>  Running without a container is applicable and convenient when there are no dependencies (for example, an application for go) or technical ability to use containers (for example, the kernel is lower than the required version and cannot be updated). <br><br>  After connecting the repository, install the necessary packages: <br><pre> <code class="bash hljs">sudo apt-get install cocaine-runtime libcocaine-core2 libcocaine-plugin-docker2 libcocaine-plugin-elliptics=2.24.14.31 elliptics-client=2.24.14.31</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/bbd/ed0/deb/bbded0debaf6d1d5b59710d07d94a9fb.png"><br><br>  To manage the applications, we need the <b>cocaine-tool</b> utility.  The easiest way to install it is from <b>PyPI</b> , the standard repository of Python packages. <br><br>  It is necessary to set the binding in Python for <b>msgpack</b> . <br><pre> <code class="bash hljs">sudo apt-get install msgpack-python</code> </pre><br><br>  And then <b>cocaine-tools</b> . <br><pre> <code class="bash hljs">sudo pip install cocaine-tools</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">And why is msgpack-python not from PyPI?</b> <div class="spoiler_text">  Msgpack-python has two implementations.  One is pure-Python, the second is on Cython.  When installing from PyPI, an attempt is made to compile the binary version, and in case of failure a pure implementation is put.  The bad thing is that these implementations are incompatible with each other.  We took the standard Cython version.  Most often, some of the necessary dependencies are missing and a clean implementation is established, which - depending on the version - leads to incomprehensible errors.  This was not always the case, and perhaps the situation will improve in the future. </div></div><br><br>  Docker is installed according to the description in the official <a href="http://docs.docker.io/en/latest/installation/ubuntulinux/">documentation in</a> any convenient way.  The following path is used: <br><pre> <code class="bash hljs">curl -s https://get.docker.io/ubuntu/ | sudo sh</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/36c/4e4/1c2/36c4e41c2097f95c3cd036451a21b701.png"><br><br>  After successful installation of packages, <b>cocaine-runtime</b> starts with the default configuration, which we need to change. <br>  Stop the <b>cocaine-runtime</b> and proceed to the configuration modification. <br><pre> <code class="bash hljs">sudo service cocaine-runtime stop</code> </pre><br><br>  The default configuration file is located in <b>/etc/cocaine/cocaine-default.conf</b> and looks like this: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"paths"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"plugins"</span></span>: <span class="hljs-string"><span class="hljs-string">"/usr/lib/cocaine"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"runtime"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/run/cocaine"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"logging"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"logging"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"storage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"storage"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"backend"</span></span>: <span class="hljs-string"><span class="hljs-string">"core"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"node"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"node"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"runlist"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"storages"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"core"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"files"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/lib/cocaine"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"cache"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"files"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/cache/cocaine"</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"loggers"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"core"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"syslog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"identity"</span></span>: <span class="hljs-string"><span class="hljs-string">"cocaine"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verbosity"</span></span>: <span class="hljs-string"><span class="hljs-string">"info"</span></span> } } } }</code> </pre><br><br>  Make the configuration cloudy.  To do this, you need to configure <b>2</b> entities: <br><ol><li>  Configure work with distributed storage (in our example - <b>Elliptics</b> ).  The thing is, <b>cocaine-runtime</b> reads from the storage a list of running applications, application launch profiles, application manifests.  If you use the out-of-the-box file storage, you will have to maintain the consistency of this data on each node, which is extremely inconvenient.  In the case of a distributed stack, this issue is resolved by itself. </li><li>  To force <b>runtime</b> to inform the information on itself to aggregating cloud nodes. </li></ol><br>  For experiments, it is convenient to modify the copy of the provided config ‚Äúby default‚Äù (for example, <b>/etc/cocaine/cocaine-cloud.conf</b> ). <br><br>  To <b>force cocaine-runtime</b> to inform aggregating nodes about applications and services running on it, by adding the network section to the configuration at the same nesting level with <b>services</b> . <br><br><pre> <code class="bash hljs"> <span class="hljs-string"><span class="hljs-string">"network"</span></span> : { <span class="hljs-string"><span class="hljs-string">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"224.168.2.9"</span></span> }, <span class="hljs-string"><span class="hljs-string">"services"</span></span>: { ... }</code> </pre><br><br>  The only <b>group</b> parameter describes the address of the multicast group to which alerts will be sent. <br>  The <b>storage</b> configuration is performed by modifying the <b>services / storage</b> and <b>storages / core</b> sections: <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"storage"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"elliptics"</span></span> }, <span class="hljs-string"><span class="hljs-string">"storages"</span></span> : { <span class="hljs-string"><span class="hljs-string">"core"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"elliptics"</span></span>, <span class="hljs-string"><span class="hljs-string">"args"</span></span>: { <span class="hljs-string"><span class="hljs-string">"nodes"</span></span> : { <span class="hljs-string"><span class="hljs-string">"192.168.50.201"</span></span> : <span class="hljs-number"><span class="hljs-number">1025</span></span> }, <span class="hljs-string"><span class="hljs-string">"io-thread-num"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"wait-timeout"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-string"><span class="hljs-string">"check-timeout"</span></span> : <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"net-thread-num"</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"groups"</span></span> : [<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"verbosity"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> } } }</code> </pre><br><br>  Implementing storage on <b>Elliptics</b> technology is provided by the appropriate plug-in.  By the way, all the plugins from our packages are placed in / usr / lib / cocaine, where <b>cocaine-runtime is</b> looking for them by default. <br><br>  Now let's make cocaine start with this config by default.  Create <br>  <code>/etc/default/cocaine-runtime</code> : <br>  CONFIG_PATH = "/ etc / cocaine / cocaine-cloud.conf" <br><br>  Run <b>cocaine-runtime</b> with the new config, make sure that the process works. <br><img src="https://habrastorage.org/getpro/habr/post_images/100/ba6/5b0/100ba65b0a38f73bfdea562aefc8d724.png"><br><br>  After starting on port <b>10053, the</b> service locator of this node will wait for requests about the availability of the application.  This is a kind of DNS for cloud applications and services, that is, by the name of the service or application you will know where to send the requests so that they are processed. <br><br>  You can request information about applications on this node using the command <code>cocaine-tool info</code> .  The output of this command does not shake the imagination, but remember it - it will change very soon. <br><br>  Recall that in addition to <b>cocaine-runtime</b> and plug-ins, we installed <b>Docker</b> .  Check that it also started successfully: <br><img src="https://habrastorage.org/getpro/habr/post_images/1e4/337/0f8/1e43370f80c0376d6b0e2bfee89778d2.png"><br><br>  We assume that similar actions will be performed on the second machine.  In total, we have <b>2</b> cars running <b>cocaine-runtime</b> that look into shared <b>storage</b> - that's great! <br><br>  At this point, it is already possible to run applications.  This, of course, is not a cloud at all, but still.  Roll up the sleeves, let's start. <br><br>  First of all, we need to deliver the application code to the cocaine storage.  This problem is solved with ease using the <b>cocaine-tool</b> . <br><br>  Clone the repository with an example and go into the directory. <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:cocaine/cocaine-framework-python.git -b v0.11 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> cocaine-framework-python/examples/flask/</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/46a/310/a46/46a310a465b1552d8d327b036848fa18.png"><br><br>  You may notice that in addition to the application code, <b>manifest.json</b> is located here: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"slave"</span></span>: <span class="hljs-string"><span class="hljs-string">"main.py"</span></span> }</code> </pre><br><br>  The main purpose of this file is to tell the platform what to run.  You can also pass the <b>environment</b> . <br><br>  To upload the application code that we want to run as a process to the cloud, run the following command: <br><pre> <code class="bash hljs">cocaine-tool app upload --name example</code> </pre><br>  <b>cocaine-tool will</b> pack your application to the archive and upload it to the cloud storage.  And then we look at the list of downloaded applications. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b24/594/b87/b24594b87804db79016d49f41e12161c.png"><br><br>  Here it is, our application!  The main thing is not to forget to install <b>flask</b> , which is required by our application.  Here is the disadvantage of running without a container. <br><pre> <code class="bash hljs">sudo apt-get install python-flask</code> </pre><br><br>  Next, you need to configure the resources allocated for the application, the type of isolation, the number of workers and so on.  For this purpose, serve profiles.  A profile can be associated with multiple applications. <br><br>  The simplest profile is empty JSON <code>{}</code> .  In this case, the default settings are used. <br><br>  A description of all available options can be found in the <a href="https://github.com/cocaine/cocaine-core/wiki/profile">description</a> .  A more interesting example will be considered later when we run the application in a container. <br><br>  Let's name our profile <b>default</b> and upload it to the cloud storage.  Check that it boots correctly. <br><img src="https://habrastorage.org/getpro/habr/post_images/d6b/584/2cb/d6b5842cb31c7863af0d38b80d7578fc.png"><br><br>  Finally, the time has come when you can pull the switch and the application will start: <br><pre> <code class="bash hljs">cocaine-tool app start --name example --profile default</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/b53/140/4f1/b531404f191d0ac8708d4a2e243fb681.png"><br><br>  Now the output of the <code>cocaine-tool info</code> command has changed.  It shows which applications are running on this node and statistics about applications. <br><br>  Let's try to send a message to our application.  For this purpose, such a small python script is sufficient: <pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from cocaine.services import Service app = Service("example") print(app.enqueue("write", "DATA").get()) print(app.enqueue("read", "DATA").get())</span></span></code> </pre><br><br>  The application is still running only on one node, but you can go to the second one and run it there.  Now you can continue to build the infrastructure for applications in <b>Docker</b> . <br><br><h2>  Docker-registry </h2><br>  <b>Docker-registry</b> is your private repository of images (containers) of applications.  You can read more about it in the <a href="http://docs.docker.io/en/latest/reference/api/registry_index_spec/">docker</a> official <a href="http://docs.docker.io/en/latest/reference/api/registry_index_spec/">documentation</a> . <br><br>  <b>Docker-registry</b> supports many backends for storing images.  The assortment starts with writing the images to the local file system and extends to storing the images in <b>Elliptics</b> . <br><br>  The easiest way to run the <b>Docker registry</b> is to use Docker.  To do this, we need to put <b>Docker</b> (see above) and give the command to run the desired image. <br><pre> <code class="bash hljs">sudo docker run -p 5000:5000 registry</code> </pre><br><br>  The image of the <b>registry</b> for the first time will be loaded from the repository, cached and the next time it will run quickly. <br><img src="https://habrastorage.org/getpro/habr/post_images/ba6/265/205/ba6265205da8913343a5f70b65de85c5.png"><br>  After starting the <b>Docker-registry</b> will listen to port <b>5000</b> .  Ping it: <br><pre> <code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">"http://192.168.50.4:5000/_ping"</span></span></code> </pre><br>  This completes the setup. <br><br><h2>  Build and Deploy Container Applications </h2><br>  The application application in the case of a container will differ little from a non-container one.  The most important difference is that <b>Dockerfile is</b> required to build the image.  In essence, it consists of a set of shell commands that must be executed to form the internal state of the image.  After that, the image is poured in the Docker-registry. <br><br>  Then any <b>Docker</b> that wants to run the container can download an image from the registry.  <b>Dockerfile</b> syntax, available commands can be found here.  Instead of a Dockerfile, you can provide a Chef recipe or Puppet manifest that will be executed inside the container during assembly. <br><br>  The profile for this application must specify the Docker isolation type.  To do this, create a new profile. <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"queue-limit"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">"pool-limit"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"isolate"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker"</span></span>, <span class="hljs-string"><span class="hljs-string">"args"</span></span>: { <span class="hljs-string"><span class="hljs-string">"memory_limit"</span></span>: <span class="hljs-number"><span class="hljs-number">1000000000</span></span>, <span class="hljs-string"><span class="hljs-string">"endpoint"</span></span>: <span class="hljs-string"><span class="hljs-string">"unix:///var/run/docker.sock"</span></span>, <span class="hljs-string"><span class="hljs-string">"registry"</span></span>: <span class="hljs-string"><span class="hljs-string">"registry.cloud.net:5000"</span></span>, <span class="hljs-string"><span class="hljs-string">"cpu_shares"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } }, <span class="hljs-string"><span class="hljs-string">"concurrency"</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span> }</code> </pre><br>  We have placed the profile in the file named docker-profile.json, we will load it with the name docker-profile <br><pre> <code class="bash hljs">cocaine-tool profile upload --name docker-profile --profile=docker-profile.json</code> </pre><br><br>  In this example, we have a ready Dockerfile, and the application is downloaded to the cloud as follows: <br><pre> <code class="bash hljs">sudo cocaine-tool app upload --docker=unix:///var/run/docker.sock --registry=registry.cloud.net:5000 --manifest manifest-docker.json --name example-docker --timeout 20000</code> </pre><br>  This is not an instant process, it all depends on the size of your image and network.  But as a result, you should see a similar inscription.  Next, the application starts. <br><img src="https://habrastorage.org/getpro/habr/post_images/f33/8cf/998/f338cf9980c765b798629917a1d7d4fa.png"><br><br>  One moment is lost sight of what applications cocaine-runtime starts at startup and how it finds out about it.  For this there is a <b>runlist</b> .  In essence, this associative array of applications and their profiles, which <b>cocane-runtime</b> reads at startup.  It is located, as well as profiles, in <b>storage</b> .  Since the sets of running applications on different nodes of the cloud may differ, then the runlists on them may be different.  The ranlist name is specified in the <b>cocaine-runtime</b> config in the runlist parameter of the node service. <br><br><h2>  Configuring the aggregation node </h2><br>  In essence, this part of the configuration is very similar to the item ‚ÄúConfiguring cocaine-runtime‚Äù.  This is natural, since <b>cocaine-runtime</b> acts as an aggregating node.  All the work on balancing in it is performed by the <b>gateway plugin</b> . <br><br>  We have two implementations of this plugin.  The first is called <b>adhoc</b> .  It is available out of the box and does not require the installation of additional packages.  The second implementation we use in combat is called <b>ipvs</b> .  As the name implies, it uses the same technology.  Adhoc is reasonable to use when it is not possible to use <b>ipvs</b> .  And of course, you can write your own implementation of this plugin to use the technology you like to balance it. <br><br>  From words to deeds.  Install the packages: <br><pre> <code class="bash hljs">sudo apt-get install cocaine-runtime libcocaine-core2 libcocaine-plugin-ipvs2 libcocaine-plugin-elliptics=2.24.14.31 elliptics-client=2.24.14.31</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/a1d/dc5/2d5/a1ddc52d565b092445b61b47d7b1ebea.png"><br><br>  If it is not possible to use <b>ipvs</b> , then there is no need to install the last of the above packages.  The differences in the base configuration will be minor and will be listed separately. <br><br>  To make <b>runtime an</b> aggregating node will allow adding a <b>network</b> section with a subsection of the <b>gateway</b> .  We assume that, as before, we correct the copy of the ‚Äúdefault‚Äù config.  The <b>storage</b> service is configured in the same way as the previous item - it will be needed soon. <br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"network"</span></span>: { <span class="hljs-string"><span class="hljs-string">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"224.168.2.9"</span></span>, <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ipvs"</span></span> <span class="hljs-comment"><span class="hljs-comment">// adhoc } }, "services"...</span></span></code> </pre><br><br>  After restarting <code>sudo service cocane-runtime restart</code> should start the process: <br><pre> <code class="bash hljs">cocaine /usr/bin/cocaine-runtime --daemonize --configuration /etc/cocaine/cocaine-gateway.conf --pidfile /var/run/cocaine/runtime.pid</code> </pre><br><br>  In fact, the <b>gateway</b> takes a number of parameters (you can read about them in the documentation). <br><br>  Let's open the log (by default it is written to syslog).  You may notice that the connection was registered two nodes, and then one of them turned off.  You can do similar operations with your backends and make sure <b>discovery</b> works. <br><img src="https://habrastorage.org/getpro/habr/post_images/516/1b1/b44/5161b1b441b3c1d8a0fa0aacebc5bd65.png"><br><br><h2>  Cocaine-native-proxy </h2><br>  Cocaine-native-proxy allows you to go to cloud applications via HTTP.  Installing and configuring it is extremely simple. <br><pre> <code class="bash hljs">apt-get install cocaine-native-proxy</code> </pre><br><br>  Then we need to specify a list of aggregating nodes in the <b>locators</b> section.  In our case, such a node is one.  Strictly speaking, it is possible to specify the addresses of locators and nodes that do not work in the aggregation mode.  This is bad for the reason that such a node knows nothing about services and applications on other nodes, which means you will not have access to them.  A more detailed description of the parameters can be found at <a href="">github.com/cocaine/cocaine-native-proxy/blob/master/README.md</a> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"endpoints"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span> ], <span class="hljs-string"><span class="hljs-string">"backlog"</span></span>: <span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-string"><span class="hljs-string">"threads"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"application"</span></span>: { <span class="hljs-string"><span class="hljs-string">"locators"</span></span>: [<span class="hljs-string"><span class="hljs-string">"192.168.50.103:10053"</span></span>], <span class="hljs-string"><span class="hljs-string">"service_pool"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"reconnect_timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-string"><span class="hljs-string">"request_timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> } }</code> </pre><br><br>  The point of entry into the cloud in our installation is a machine with an aggregate node.  Despite the fact that the HTTP interface is brought out through <b>cocaine-native-proxy</b> , in fact, this proxy also uses an aggregation node.  We pointed it out in the config in the locators section.  Let's try to call our applications in two ways.  The HTTP client will use the <b>http</b> event handler, and from the Python client code, we will handle the <b>write</b> and <b>read</b> events. <br><br>  The client code now indicates the address of the entry point to the cloud.  In my case - 192.168.50.103. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from cocaine.services import Service app = Service("example", host="192.168.50.103") print(app.enqueue("write", "DATA").get()) print(app.enqueue("read", "DATA").get())</span></span></code> </pre><br><br>  As an event handler for the http event, an application is called on flask.  Currently, HTTP-proxy supports two ways of determining which application to send which event to.  The first method assumes that the passed URL is patterned: <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2 .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code></code> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> <pre> <code class="hljs ruby"><code>/<span class="hljs-regexp"><span class="hljs-regexp">//tail</span></span>?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span>.  URL   .       /tail?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span></code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/read"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Service: example"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Event: http"</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/example/http/read"</span></span></code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, <span class="hljs-number"><span class="hljs-number">5</span></span>%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b><span class="hljs-number"><span class="hljs-number">1000</span></span></b> .      .        <br> <code class="javascript">service/<span class="hljs-symbol"><span class="hljs-symbol">locator:</span></span> adding group <span class="hljs-string"><span class="hljs-string">'exampleGroup'</span></span></code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    <span class="hljs-symbol"><span class="hljs-symbol">hello:</span></span> <br> <code class="python">@app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name=None)</span></span></span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"HELLO! I'm version #2"</span></span></code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/exampleGroup/http/"</span></span></code> <br> <br>   ,      .    <b>example2</b>  <b><span class="hljs-number"><span class="hljs-number">0</span></span></b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> </pre> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> <h2> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> </h2> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> <pre> <code class="hljs ruby"><code class="javascript"><code>/<span class="hljs-regexp"><span class="hljs-regexp">//tail</span></span>?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span>.  URL   .       /tail?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span></code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/read"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Service: example"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Event: http"</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/example/http/read"</span></span></code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, <span class="hljs-number"><span class="hljs-number">5</span></span>%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b><span class="hljs-number"><span class="hljs-number">1000</span></span></b> .      .        <br> service/<span class="hljs-symbol"><span class="hljs-symbol">locator:</span></span> adding group <span class="hljs-string"><span class="hljs-string">'exampleGroup'</span></span> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    <span class="hljs-symbol"><span class="hljs-symbol">hello:</span></span> <br> <code class="python">@app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name=None)</span></span></span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"HELLO! I'm version #2"</span></span></code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/exampleGroup/http/"</span></span></code> <br> <br>   ,      .    <b>example2</b>  <b><span class="hljs-number"><span class="hljs-number">0</span></span></b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code></code> </pre> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> <pre> <code class="hljs ruby"><code>/<span class="hljs-regexp"><span class="hljs-regexp">//tail</span></span>?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span>.  URL   .       /tail?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span></code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/read"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Service: example"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Event: http"</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/example/http/read"</span></span></code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, <span class="hljs-number"><span class="hljs-number">5</span></span>%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b><span class="hljs-number"><span class="hljs-number">1000</span></span></b> .      .        <br> <code class="javascript">service/<span class="hljs-symbol"><span class="hljs-symbol">locator:</span></span> adding group <span class="hljs-string"><span class="hljs-string">'exampleGroup'</span></span></code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    <span class="hljs-symbol"><span class="hljs-symbol">hello:</span></span> <br> <code class="python">@app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name=None)</span></span></span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"HELLO! I'm version #2"</span></span></code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/exampleGroup/http/"</span></span></code> <br> <br>   ,      .    <b>example2</b>  <b><span class="hljs-number"><span class="hljs-number">0</span></span></b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> </pre> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> <pre> <code class="hljs ruby"><code class="bash"><code>/<span class="hljs-regexp"><span class="hljs-regexp">//tail</span></span>?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span>.  URL   .       /tail?arg=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;args=<span class="hljs-number"><span class="hljs-number">2</span></span></code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/read"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Service: example"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Cocaine-Event: http"</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/example/http/read"</span></span></code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, <span class="hljs-number"><span class="hljs-number">5</span></span>%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b><span class="hljs-number"><span class="hljs-number">1000</span></span></b> .      .        <br> <code class="javascript">service/<span class="hljs-symbol"><span class="hljs-symbol">locator:</span></span> adding group <span class="hljs-string"><span class="hljs-string">'exampleGroup'</span></span></code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    <span class="hljs-symbol"><span class="hljs-symbol">hello:</span></span> <br> <code class="python">@app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name=None)</span></span></span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"HELLO! I'm version #2"</span></span></code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/exampleGroup/http/"</span></span> <br> <br>   ,      .    <b>example2</b>  <b><span class="hljs-number"><span class="hljs-number">0</span></span></b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code></code> </pre> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> <h2> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> </h2> <code><code>///tail?arg=1&amp;args=2.  URL   .       /tail?arg=1&amp;args=2</code> .      . <br> <br>          <b>X-Cocaine-Service, X-Cocaine-Event</b> .      <b>nginx</b> . <br> <br>  ,       : <br> <code class="bash">curl "http://localhost:8080/read" -H "X-Cocaine-Service: example" -H "X-Cocaine-Event: http" curl "http://localhost:8080/example/http/read"</code> <br> <br>     <br> <br>               .    ,               .           ,    .          .    .  ,       ,       (, 5%).     .        .        ,       ,       . <br> <br>    .       <b>example</b> ,  <b>exampleGroup</b> .     <b>example</b>   <b>1000</b> .      .        <br> <code class="javascript">service/locator: adding group 'exampleGroup'</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/eb0/f31/75a/eb0f3175aa4ff104ba55e555836eca0b.png"> <br> <br>           <b>exampleGroup</b> .    ,    ,   app.py    hello: <br> <code class="python">@app.route('/') def hello(name=None): return "HELLO! I'm version #2"</code> <br> <br>           ,   <b>example2</b> . <br> <img src="https://habrastorage.org/getpro/habr/post_images/506/3fb/239/5063fb239fc7da008bd2ceed7fa65be7.png"> <br> <br>    <br> <code class="bash">curl "http://localhost:8080/exampleGroup/http/"</code> <br> <br>   ,      .    <b>example2</b>  <b>0</b> ,      HTTP-proxy     .   ,   HTTP-proxy    .   ,   . <br> <br>   <br>     ,     ,    .        ,     Cocaine   ,    c,   .      .</code> </div><p>Source: <a href="https://habr.com/ru/post/214069/">https://habr.com/ru/post/214069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../21405/index.html">Discrimination Dialapchikov</a></li>
<li><a href="../214053/index.html">We invite you to take part in the Siberian Hackath 1-2 March</a></li>
<li><a href="../214055/index.html">Ban on continents</a></li>
<li><a href="../21406/index.html">Security of data stored in Google services</a></li>
<li><a href="../214063/index.html">Angular boilerplate. Simplicity - the trend of youth</a></li>
<li><a href="../21407/index.html">Apple and Habr</a></li>
<li><a href="../214071/index.html">Adaptive images without shamanism</a></li>
<li><a href="../214075/index.html">DSM 5.0 Beta is a new OS version for Synology NAS. Part 1 - For home, for family</a></li>
<li><a href="../214079/index.html">Atom: the new code editor from Github</a></li>
<li><a href="../214081/index.html">E-commerce trends: Work on order</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>