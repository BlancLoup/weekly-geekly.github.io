<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to quickly and easily write DSL in Ruby</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The presented text is a translation of an article from the official blog of the ZenPayroll company. Despite the fact that in some issues I do not agre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to quickly and easily write DSL in Ruby</h1><div class="post__text post__text-html js-mediator-article">  <i>The presented text is a translation of an article from the official blog of the ZenPayroll company.</i>  <i>Despite the fact that in some issues I do not agree with the author, the general approach and methods shown in this article may be useful to a wide range of people writing in Ruby.</i>  <i>I apologize in advance for the fact that some bureaucratic terms could be translated incorrectly.</i>  <i>Hereafter, my notes and comments are in italics.</i> <br><br>  In ZenPayroll we try to hide the complexity of the problem being solved as much as possible.  Salary accrual has traditionally been a bureaucratic wasp nest, and implementing a modern and convenient solution in such an unfriendly atmosphere is an attractive technical problem that is very difficult to solve without <br>  automation. <br><br>  ZenPayroll is now creating a nationwide service (already implemented in 24 states), which means that we meet a variety of requirements unique to each state.  At first, we noticed that we spend a lot of time writing template code instead of concentrating on what makes each state unique.  Soon we realized that we could solve this problem, using the advantages of creating a <abbr title="Domain Selected Language">DSL</abbr> to speed up and simplify the development process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we will create DSL as close as possible to what we use ourselves. <br><a name="habracut"></a><br><h1>  When do we need DSL? </h1><br>  Writing a DSL is a huge amount of work, and it can not always help you in solving a problem.  In our case, however, the advantages outweighed the disadvantages: <br><br><ol><li>  <b>All specific code is collected in one place.</b> <br>  There are several models in our Rails application in which we need to implement state-specific code.  We need to generate forms, tables, and manipulate mandatory information related to employees, companies, submission schedules, and tax rates.  We make payments to government agencies, submit the generated forms, calculate income tax and much more.  The DSL implementation allows us to collect all code specific for the marquee in one place. <br></li><li>  <b>Standardization of states.</b> <br>  Instead of creating every new state from scratch, the use of DSL allows us to automate the creation of common things for states and, at the same time, allows us to flexibly configure each state. <br></li><li>  <b>Reducing the number of places where you can make a mistake.</b> <br>  Having a DSL that creates classes and methods for us, we shorten the template code and have fewer places where developers intervene.  Having tested DSL qualitatively and protected it from incorrect input data, we will greatly reduce the likelihood of an error. <br></li><li>  <b>The possibility of rapid expansion.</b> <br>  We create a framework that facilitates the implementation of unique requirements for new states.  DSL is a toolkit that saves us time for this and allows development to move on. <br></li></ol><br><h1>  Spelling dsl </h1><br>  In this article, we will focus on creating a DSL that will allow us to store company identification numbers and payroll parameters (used to calculate taxes).  Although this is just a quick glance at what DSL can provide us, it is still a full introduction to the topic.  Our final code, written using the generated DSL, will look something like this: <br><br><pre><code class="ruby hljs">StateBuilder.build(<span class="hljs-string"><span class="hljs-string">'CA'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> company <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> edd { format <span class="hljs-string"><span class="hljs-string">'\d{3}-\d{4}-\d'</span></span> } sos { format <span class="hljs-string"><span class="hljs-string">'[AZ]\d{7}'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> filing_status { options [<span class="hljs-string"><span class="hljs-string">'Single'</span></span>, <span class="hljs-string"><span class="hljs-string">'Married'</span></span>, <span class="hljs-string"><span class="hljs-string">'Head of Household'</span></span>] } withholding_allowance { max <span class="hljs-number"><span class="hljs-number">99</span></span> } additional_withholding { max <span class="hljs-number"><span class="hljs-number">10000</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Fine!  This is a clean, clear and expressive code that uses an interface designed to solve our problem.  Let's start. <br><br><h2>  Parameter Definition </h2><br>  First of all, let's define what we want to get in the end.  First question: what information do we want to store? <br><br>  Each state requires companies to register with local authorities.  When registering in most states, companies are given identification numbers that are required to pay taxes and submit documents.  At the company level, we must be able to store different identification numbers for different states. <br><br>  Withholding taxes are calculated based on the amount of benefits received by the employee.  These are values ‚Äã‚Äãthat are defined in the W-4 forms for each state.  For each state, there are many questions asked to determine tax rates: your taxpayer status, related benefits, disability benefits, and more.  For employees, we need a flexible method for defining different attributes for each state in order to correctly calculate tax rates. <br><br>  The DSL we write will handle company identification numbers and basic payroll information for employees.  Next we use this tool to describe California.  Since California has some additional conditions that need to be taken into account when calculating salaries, we will focus on them in order to show how to develop DSL. <br><br>  I provide a <a href="https://github.com/nikhilmat/DSL-Tutorial">link</a> to a simple Rails application so that you can follow the steps to be taken in this article. <br><br>  The application uses the following models: <br><br><ul><li>  <b>Company.</b>  Describes the essence of "company".  Stores information about the name, type and date of foundation. <br></li><li>  <b>Employee.</b>  Describes an employee working for a company.  Stores information about the name, payments and the date of receipt for work. <br></li><li>  <b>CompanyStateField.</b>  Each company is associated with many <u>CompanyStateField</u> , each of which stores specific information associated with the company and state-specific, for example, an identification number.  In California, an employer requires two numbers: the number in the Department of Employment Development (EDD) and the number in the State Secretariat (SoS).  More information on this subject can be found <a href="http://help.zenpayroll.com/customer/portal/articles/1084488-what-is-a-california-edd-number-">here</a> . <br></li><li>  <b>EmployeeStateField.</b>  Each employee is associated with many <u>EmployeeStateField</u> , each of which stores employee-specific employee information.  This is information that can be found in the W-4 state forms, for example, tax rebates or taxpayer status.  The <a href="http://www.edd.ca.gov/pdf_pub_ctr/de4.pdf">DE4 form in California</a> requires a tax rebate, a dollar amount withheld, and taxpayer status (single, married, head of household). <br></li></ul><br>  We create successor models from the <u>CompanyStateField</u> and <u>EmployeeStateField</u> models that will use the same tables as the <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">single table inheritance</a> base classes.  This allows us to identify their state-specific heirs and use only one table to store all of these models.  To do this, both tables contain serialized hashes, which we will use to store specific data.  Although it will be impossible to conduct queries using these data, this allows us not to inflate the database with unused columns. <br>  <i>Note</i>  <i>translator.</i>  <i>When using Postgres, this data can be stored in natively supported JSON.</i> <br><br>  Our application is prepared for working with the states, and now our DSL must create specific classes that implement the required functionality for California. <br><br><h2>  What will help us? </h2><br>  Metaprogramming is an area where Ruby can show itself in all its glory.  We can create methods and classes right at the time of program execution, as well as use a huge number of metoprogramming methods, which makes creating DSL in Ruby a pleasure.  Rails itself is <br>  DSL for creating web applications and a huge amount of its ‚Äúmagic‚Äù is based on Ruby's metaprogramming capabilities.  Below I will give a small list of methods and objects that will be useful for metaprogramming. <br><br><h4>  <a href="http://rubymonk.com/learning/books/1-ruby-primer/chapters/34-lambdas-and-blocks-in-ruby/lessons/78-blocks-in-ruby">Blocks</a> </h4><br>  Blocks allow us to group code and pass it as an argument to a method.  They can be described using <u>do end</u> or curly braces.  Both options are identical. <br>  <i>Note</i>  <i>translator.</i>  <i>According to the accepted style, the syntax <u>do end is</u> used in multi-line constructions, and curly brackets in single-line ones.</i>  <i>There are also <a href="http://habrahabr.ru/post/241265/">some differences</a> (thanks to <a href="https://habrahabr.ru/users/mudasobwa/" class="user_link">mudasobwa</a> ) that are irrelevant in this case, but that can give you quite a few funny debugging minutes.</i> <br><div class="spoiler">  <b class="spoiler_title">Recycled original comment</b> <div class="spoiler_text"><blockquote>  Blocks allow us to group code and pass it as an argument to a method.  They can be described using do end or curly braces.  Both options are identical. <br>  Note  translator.  According to the accepted style, the syntax do end is used in multi-line constructions, and curly brackets in single-line ones. </blockquote><br><br>  Both of you are wrong :) <br><br>  In fact, there is a difference, and it can lead to an error in the code, from which it is easy to turn gray, but which is extremely difficult to catch, if you don‚Äôt know what it is.  See: <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'benchmark'</span></span> puts Benchmark.measure { <span class="hljs-string"><span class="hljs-string">"a"</span></span>*<span class="hljs-number"><span class="hljs-number">1_000_000</span></span> } <span class="hljs-comment"><span class="hljs-comment"># =&gt; 0.000000 0.000000 0.000000 ( 0.000427) puts Benchmark.measure do "a"*1_000_000 end # =&gt; LocalJumpError: no block given (yield) # =&gt; from IRRELEVANT_PATH_TO_RVM/lib/ruby/2.0.0/benchmark.rb:281:in `measure' # =&gt; from (irb):9</span></span></code> </pre><br><br>  Cool, right? <br><br><div class="spoiler">  <b class="spoiler_title">Think before clicking:</b> <div class="spoiler_text">  Due to the different priority of the operators, the code of the second example is actually executed in the following sequence: <br><pre> <code class="ruby hljs">(puts Benchmark.measure) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment"># irrelevant code end</span></span></code> </pre><br></div></div><br><br>  Correct the note in the code, please.  People read :) <br></div></div><br>  You almost certainly used them if you used a method like <u>each</u> : <br><pre> <code class="ruby hljs">[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>].each { <span class="hljs-params"><span class="hljs-params">|number|</span></span> puts number*<span class="hljs-number"><span class="hljs-number">2</span></span> }</code> </pre><br>  This is a great thing for creating DSLs, because they allow us to create code in one context and execute it in another.  This gives us the opportunity to create a readable DSL by moving method definitions to other classes.  Many examples of this we will see below. <br><br><h4>  <a href="http://ruby-doc.org/core-2.1.2/Object.html">send</a> </h4><br>  The <u>send</u> method allows us to call object methods (even private ones), passing it the name of the method as a symbol.  This is useful for calling methods that are usually called inside a class definition or for interpolating variables for dynamic method calls. <br><br><h4>  <a href="http://www.ruby-doc.org/core-2.1.2/Module.html">define_method</a> </h4><br>  In Ruby, <u>define_method</u> gives us the ability to create methods without using a normal procedure when describing a class.  It takes as its argument a string that will be the name of the method and a block that will be executed when the method is called. <br><br><h4>  <a href="http://www.ruby-doc.org/core-2.1.2/BasicObject.html">instance_eval</a> </h4><br>  This thing is necessary when creating a DSL is almost the same as blocks.  It takes a block and executes it in the context of the receiver object.  For example: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyClass</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">say_hello</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">puts</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hello!</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyClass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_eval</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">say_hello</span></span></span><span class="hljs-class"> } </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; 'Hello!'</span></span></span></span></code> </pre><br>  In this example, the block contains a call to the method <u>say_hello</u> , despite the fact that there is no such method in its context.  The instance of the class returned from <u>MyClass.new</u> is the receiver for <u>instance_eval</u> and the call to <u>say_hello</u> occurs in its context. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyOtherClass</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_eval</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">say_goodbye</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">puts</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Goodbye</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyOtherClass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">say_goodbye</span></span></span><span class="hljs-class"> } </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; 'Goodbye!'</span></span></span></span></code> </pre><br>  We again describe a block that calls a method that is undefined in its context.  This time we pass the block to the constructor of the class <u>MyOtherClass</u> and execute it in the context of the <u>self</u> receiver, which is an instance of <u>MyOtherClass</u> .  Fine! <br><br><h4>  <a href="http://www.ruby-doc.org/core-2.1.2/BasicObject.html">method_missing</a> </h4><br>  This is the magic that Rails <u>find_by_ *</u> methods work with.  Any call to an undefined method falls into <u>method_missing</u> , which takes as input the name of the method called and all arguments passed to it.  This is another great thing for DSL, because it allows you to create methods dynamically when we do not know what can really be caused.  This gives us the opportunity to create a very flexible syntax. <br><br><h2>  Design and Implementation of DSL </h2><br>  Now that we have some knowledge of our toolkit, it's time to think about how we want to see our DSL and how we will continue to work with it.  In this case, we will work ‚Äúbackwards‚Äù: instead of starting with the creation of classes and methods, we will develop an ideal syntax and we will build everything else around it.  We will consider this syntax as a sketch of what we want to receive.  Let's look again at how everything should look as a result: <br><br><pre> <code class="ruby hljs">StateBuilder.build(<span class="hljs-string"><span class="hljs-string">'CA'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> company <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> edd { format <span class="hljs-string"><span class="hljs-string">'\d{3}-\d{4}-\d'</span></span> } sos { format <span class="hljs-string"><span class="hljs-string">'[AZ]\d{7}'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> filing_status { options [<span class="hljs-string"><span class="hljs-string">'Single'</span></span>, <span class="hljs-string"><span class="hljs-string">'Married'</span></span>, <span class="hljs-string"><span class="hljs-string">'Head of Household'</span></span>] } withholding_allowance { max <span class="hljs-number"><span class="hljs-number">99</span></span> } additional_withholding { max <span class="hljs-number"><span class="hljs-number">10000</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Let's break it apart and gradually write code that wraps our DSL into the classes and methods we need to describe California. <br><br><hr>  If you want to follow me using the provided code, you can do <u>git checkout step-0</u> and add the code with me during the reading process. <br><hr><br>  Our DSL, which we called <u>StateBuilder,</u> is a class.  We begin the creation of each state by calling the <u>build</u> class method with the abbreviation of the state name and the block describing it as parameters.  In this block, we can call the methods that we call <u>company</u> and <u>employee</u> and pass each of them our own configuration block, which will customize our specialized models ( <u>CompanyStateField :: CA</u> and <u>EmployeeStateField :: CA</u> ) <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># app/states/ca.rb StateBuilder.build('CA') do company do #  CompanyStateField::CA end employee do #  EmployeeStateField::CA end end</span></span></code> </pre><br>  As mentioned earlier, our logic is encapsulated in the <u>StateBuilder</u> class.  We call the block passed to <u>self.build</u> in the context of a new instance of <u>StateBuilder</u> , so the <u>company</u> and <u>employee</u> must be defined and each of them must take a block as an argument.  Let's start the development by creating a class pig that fits these conditions. <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># app/models/state_builder.rb class StateBuilder def self.build(state, &amp;block) #    ,   raise "You need a block to build!" unless block_given? StateBuilder.new(state, &amp;block) end def initialize(state, &amp;block) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span><span class="hljs-comment"> = state #         StateBuilder instance_eval &amp;block end def company(&amp;block) #  CompanyStateField::CA end def employee(&amp;block) #  EmployeeStateField::CA end end</span></span></code> </pre><br>  Now we have a base for our <u>StateBuilder</u> .  Since the <u>company</u> and <u>employee</u> methods will define the <u>CompanyStateField :: CA</u> and <u>EmployeeStateField :: CA</u> classes, let's define what the blocks that we will pass to these methods should look like.  We must define each attribute that our models will have, as well as some information about these attributes.  What is especially nice about creating your own DSL is that we don‚Äôt have to use standard Rails syntax for getter and setter methods, as well as validations.  Instead, let's implement the syntax we described earlier. <br>  <i>Note</i>  <i>translator.</i>  <i>Controversial thought.</i>  <i>I would still try to minimize the zoo syntax within the application, albeit at the expense of some redundancy code.</i> <br><br><hr>  It's time to do <u>git checkout step-1</u> . <br><hr><br>  For Californian companies, we must store two identification numbers: a number issued by the California Department of Employment (EDD) and a number issued by the State Secretariat (SoS). <br><br>  The format of the number is EDD: "### - #### - #", and the format of the number of SoS is "@ #######", where @ means "any letter" and # is "any digit". <br><br>  Ideally, we should use the name of our attribute as the name of the method to which to pass a block as a parameter, which will determine the format of this field (It seems the time has come for <u>method_missing</u> !). <br>  <i>Note</i>  <i>translator.</i>  <i>Maybe something is wrong with me, but the syntax of the form</i> <pre> <code class="ruby hljs">field name, params</code> </pre>  <i>seems to me more understandable and logical than the one proposed by the author (compare with standard migrations).</i>  <i>When using the author's syntax at first glance, it is not at all obvious that it is permissible to write any names in blocks describing a company or an employee, and you also get an excellent grenade launcher for shooting in the leg (see below).</i> <br>  Let's write what the calls to these methods will look like for EDD and SoS numbers. <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/states/ca.rb StateBuilder.build('CA') do company do edd { format '\d{3}-\d{4}-\d' } sos { format '[AZ]\d{7}' } end employee do #  EmployeeStateField::CA end end</span></span></code> </pre><br>  Notice that here, when describing a block, we changed the syntax from <u>do end</u> to curly braces, but the result did not change - we still pass the executable block of code to the function.  Now let's do the same for employees. <br><br>  According to the Californian Certificate of Benefits in calculating taxes, workers are asked about their tax status, the number of benefits and any other additional withheld sums they may have.  Taxpayer status can be Single, Married or Head of Family;  tax benefits should not exceed 99, and for additional withheld amounts, let's set a maximum of $ 10,000.  Now let's describe them in the same way as we did for the company fields. <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/states/ca.rb StateBuilder.build('CA') do company do edd { format '\d{3}-\d{4}-\d' } sos { format '[AZ]\d{7}' } end employee do filing_status { options ['Single', 'Married', 'Head of Household'] } withholding_allowance { max 99 } additional_withholding { max 10000 } end end</span></span></code> </pre><br>  Now we have the final implementation for California.  Our DSL describes attributes and validations for <u>CompanyStateField :: CA</u> and <u>EmployeeStateField :: CA</u> using our own syntax. <br><br>  All we have to do is translate our syntax into classes, getters / setters, and validations.  Let's implement the <u>company</u> and <u>employee</u> methods in the <u>StateBuilder</u> class and get working code. <br><br><hr>  The third part of Marlezonsky ballet: <u>git checkout step-2</u> <br><hr><br>  We implement our methods and validations by defining what to do with each of the blocks in the <u>StateBuilder # company</u> and <u>StateBuilder # employee</u> methods.  Let's use an approach similar to the one we used when defining a <u>StateBuilder</u> : create a ‚Äúcontainer‚Äù that will contain these methods and execute the transferred block using its <u>instance_eval</u> in its context. <br><br>  Let's call our containers <u>StateBuilder :: CompanyScope</u> and <u>StateBuilder :: EmployeeScope</u> and create in the <u>StateBuilder</u> methods that create instances of these classes. <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/models/state_builder.rb class StateBuilder def self.build(state, &amp;block) #    ,   raise "You need a block to build!" unless block_given? StateBuilder.new(state, &amp;block) end def initialize(state, &amp;block) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span><span class="hljs-comment"> = state #         StateBuilder instance_eval &amp;block end def company(&amp;block) StateBuilder::CompanyScope.new(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span><span class="hljs-comment">, &amp;block) end def employee(&amp;block) StateBuilder::EmployeeScope.new(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span><span class="hljs-comment">, &amp;block) end end</span></span></code> </pre><br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/models/state_builder/company_scope.rb class StateBuilder class CompanyScope def initialize(state, &amp;block) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@klass</span></span></span><span class="hljs-comment"> = CompanyStateField.const_set state, Class.new(CompanyStateField) instance_eval &amp;block end end end</span></span></code> </pre><br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/models/state_builder/employee_scope.rb class StateBuilder class EmployeeScope def initialize(state, &amp;block) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@klass</span></span></span><span class="hljs-comment"> = EmployeeStateField.const_set state, Class.new(EmployeeStateField) instance_eval &amp;block end end end</span></span></code> </pre><br>  We use <u>const_set</u> to define the subclasses <u>CompanyStateField</u> and <u>EmployeeStateField</u> with the name of our state.  This will create us the <u>CompanyStateField :: CA</u> and <u>EmployeeStateField :: CA</u> classes, each of which is inherited from the corresponding parent. <br><br>  Now we can focus on the last stage: the blocks passed to each of our created attributes ( <u>sos</u> , <u>edd</u> , <u>additional_witholding</u> , etc.).  They will be executed in the context of <u>CompanyScope</u> and <u>EmployeeScope</u> , but if we try to execute our code now, we will get errors about calling unknown methods. <br><br>  We use the method <u>method_missing</u> to handle these cases.  In the current state, we can assume that any method called is an attribute name, and the blocks passed to them describe how we want to configure it.  This gives us a "magic" ability to define the necessary attributes and save them. <br>  to the database. <br><br><blockquote>  Attention!  Using <u>method_missing in</u> such a way that it does not provide a situation in which <u>super</u> can be called can lead to unexpected behavior.  Errata will be difficult to track, since they will all fall into <u>method_missing</u> .  Be sure to create options where <u>method_missing</u> will call <u>super</u> when you write something based on these principles. <br>  <i>Note</i>  <i>translator.</i>  <i>In general, it is better to keep the use of <u>method_missing</u> to a minimum, because it slows down the program very much.</i>  <i>In this case, this is not critical, since all this code is executed only when the application starts.</i> </blockquote><br><br>  We define the method <u>method_missing</u> and pass these arguments to the last container we create, <u>AttributesScope</u> .  This container will call <u>store_accessor</u> and create validations based on the blocks we pass to it. <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/models/state_builder/company_scope.rb class StateBuilder class CompanyScope def initialize(state, &amp;block) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@klass</span></span></span><span class="hljs-comment"> = CompanyStateField.const_set state, Class.new(CompanyStateField) instance_eval &amp;block end def method_missing(attribute, &amp;block) AttributesScope.new(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@klass</span></span></span><span class="hljs-comment">, attribute, &amp;block) end end end</span></span></code> </pre><br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#app/models/state_builder/employee_scope.rb class StateBuilder class EmployeeScope def initialize(state, &amp;block) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@klass</span></span></span><span class="hljs-comment"> = EmployeeStateField.const_set state, Class.new(EmployeeStateField) instance_eval &amp;block end def method_missing(attribute, &amp;block) AttributesScope.new(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@klass</span></span></span><span class="hljs-comment">, attribute, &amp;block) end end end</span></span></code> </pre><br>  Now, every time we call the method in the <u>company</u> block in app / states / ca.rb, it will fall into the <u>method_missing</u> function we <u>defined</u> .  Its first argument will be the name of the method called, the name of the attribute being defined.  We create a new <u>AttributesScope</u> instance, passing it a class to change, the name of the attribute being defined and the block that configures the attribute.  In <u>AttributesScope,</u> we will call <u>store_accessor</u> , which will determine the getters and setters for the attribute, and use the serialized hash to store the data. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttributesScope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">klass</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">klass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">store_accessor</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_eval</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  We also need to define the methods that we call inside the blocks that configure the attributes ( <u>format</u> , <u>max</u> , <u>options</u> ) and turn them into validators.  We do this by converting the calls to these methods to the validation calls that Rails expects. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttributesScope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">klass</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validation_options</span></span></span><span class="hljs-class"> = [] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">klass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">store_accessor</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_eval</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">klass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute</span></span></span><span class="hljs-class">, *@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validation_options</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regex</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validation_options</span></span></span><span class="hljs-class"> &lt;&lt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Regexp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regex</span></span></span><span class="hljs-class">) } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validation_options</span></span></span><span class="hljs-class"> &lt;&lt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numericality</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">greater_than_or_equal_to</span></span></span><span class="hljs-class">: 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">less_than_or_equal_to</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">values</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validation_options</span></span></span><span class="hljs-class"> &lt;&lt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inclusion</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">values</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Our DSL is ready for battle.  We have successfully identified the <u>CompanyStateField :: CA</u> model, which stores and validates the EDD and SoS numbers, as well as the <u>EmployeeStateField :: CA</u> model, which stores and validates tax benefits, taxpayer status, and additional fees for employees.  despite the fact that our DSL was created <br>  for automation of fairly simple things, each of its components can be easily extended.  We can easily add new hooks in DSL, define more methods in models and develop it further, based on the functionality that we have implemented now. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our implementation noticeably reduces repetitions and template code in the backend, but still requires each state to have its own client-side views. </font><font style="vertical-align: inherit;">We have expanded our internal development so that it covers the client side for new states, and if there is interest in the comments, I will write another post telling how this works for us. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article shows only part of how we use our own DSL as a tool for expanding staff. </font><font style="vertical-align: inherit;">Such tools have shown tremendous utility in expanding our payroll service for the rest of the United States, and if such tasks interest you, then </font></font><a href="https://zenpayroll.com/careers"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we can work together</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Happy metaprogramming!</font></font></div><p>Source: <a href="https://habr.com/ru/post/241265/">https://habr.com/ru/post/241265/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241255/index.html">Pooling database connections on node.js</a></li>
<li><a href="../241257/index.html">Make an anonymous access point based on Raspberry Pi and TOR</a></li>
<li><a href="../241259/index.html">Traffic generation by our subscribers exceeded 256 Gbit / s! Sale of servers with a channel of 10 Gb / s</a></li>
<li><a href="../241261/index.html">Microsoft Azure Cloud Hot Announcements: Bigger, Faster, and More Open</a></li>
<li><a href="../241263/index.html">Rushim Captcha SilkRoad 2.0</a></li>
<li><a href="../241267/index.html">Ciklum Java Subbotnik in Kiev, November 1</a></li>
<li><a href="../241269/index.html">GenerationS named the best technological startups in Russia</a></li>
<li><a href="../241271/index.html">Creating custom OIDs for monitoring systems on Cach√© using SNMP</a></li>
<li><a href="../241273/index.html">Published ranking of countries most affected by hackers</a></li>
<li><a href="../241275/index.html">Ecmascript 6 - what you can use now</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>