<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How did you optimize work with MongoDB using an outdated api or what its specification is silent about ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I ran into a task: mongoDb was used as a cache / buffer between the backend in Java and the frontend on node.js. Everything was fine, until a bus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How did you optimize work with MongoDB using an outdated api or what its specification is silent about ...</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f92/c5c/217/f92c5c217b9f46e9ae721e113cdbaec2.png" alt="image"><br><br>  Once I ran into a task: mongoDb was used as a cache / buffer between the backend in Java and the frontend on node.js.  Everything was fine, until a business requirement appeared to transfer large volumes in a short time through mongoDb (up to 200 thousand records in no more than a couple of minutes).  What is not so important, it is important that such a task appeared.  And here it was necessary to understand the guts of Mongi ... <br><br><a name="habracut"></a><br>  <b>Round 0:</b> <br>  Just write in Mongu with <a href="http://docs.mongodb.org/manual/core/write-concern/">Write Concern</a> = Acknowledged.  The most banal and easy way to the forehead.  In this case, Mongo guarantees that everything has been recorded without errors and in general everything will be fine.  Everything is perfectly written, but ... at 200 thousand dies for twenty or more minutes.  Does not fit.  Cross-stitch way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/d32/6ad/e6a/d326ade6a649470f8e8045289811a696.png" alt="image"><br>  <b>Round 1:</b> <br>  We try <a href="http://docs.mongodb.org/manual/core/bulk-write-operations/">Bulk write operations</a> with the same <a href="http://docs.mongodb.org/manual/core/write-concern/">Write Concern</a> = Acknowledged.  It became better, but not much.  Writes ten to fifteen minutes.  Strange, in fact, greater acceleration was expected.  Okay, go ahead. <br><br><img src="https://habrastorage.org/files/43f/1a5/e7b/43f1a5e7bed1450da4414a5f9de7257b.png" alt="image"><br>  <b>Round 2:</b> <br>  We try to change <a href="http://docs.mongodb.org/manual/core/write-concern/">Write Concern</a> to Unacknowledged and use <a href="http://docs.mongodb.org/manual/core/bulk-write-operations/">Bulk write operations</a> until the heap.  In general, this is not the best solution, since if something goes wrong in Mong, we will never know about it, since it will only report that the data reached it, but whether it is recorded in the database or not is unknown.  On the other hand, according to the business requirements, the data are not banking transactions, a single loss is not so critical, and if everything is bad in a mongee, we will already learn from the monitoring.  We try.  On the one hand, it was recorded in just a minute, which is good (without Bulk write operations, a minute and a half is also quite good), on the other hand, a problem arose: immediately after writing java gives node.js a go-ahead, and when it starts to read, the data comes completely or not at all , then half is read, half is not.  The fault is asynchronous - with this Write Concern, Monga still writes, and node.js already reads, respectively, the client manages to read before the record is guaranteed to end.  Poorly. <br><br><img src="https://habrastorage.org/files/55a/533/699/55a533699145484ca0c6a0bda7ff6b13.png"><br>  <b>Round 3:</b> <br>  We started to think, the idea to write Thread.sleep (60 seconds) or to write some control object to Mong, which showed that all data was loaded, looks very crooked.  We decided to see why Bulk write operations accelerate so badly, because in theory Write Concern should slow down the last entry during Bulk write operations, and not everything.  Somehow it is illogical that waiting for the recording of the last portion takes so much time.  We are looking at the driver code for Mongi in Java, stumble upon that packages of bulk operations are limited to a certain parameter maxBatchWriteSize.  Debug shows that this parameter is only 500, that is, in fact, the whole bulk is cut by requests of only 500 records, and therefore such results, Acknowledged every time waits for the full record of these 500 records before sending a new request and so four thousand times maximum volume, and it wildly slows down. <br><br><img src="https://habrastorage.org/files/a96/55e/ddf/a9655eddfb534df2b64060d618aa4790.png"><br>  <b>Round 4</b> <br>  Trying to understand where this maxBatchWriteSize parameter comes from, we find that the driver of the monga makes a getMaxWriteBatchSize () request to the server of the monga.  There was a thought to increase this parameter in the Mongi config and bypass this restriction.  Attempts to find this parameter or query in the specification gave a zero result.  All right, we search in the Internet, we find source codes on C ++.  This parameter is a banal constant, hard-wired in the source code, that is, it cannot be increased.  Dead end. <br><br><img src="https://habrastorage.org/files/581/d65/14b/581d6514b83e42a68d4ae94d97a2b2f0.png"><br>  <b>Round 5</b> <br>  We are looking for more options in the internet.  We decided not to try the option of uploading through hundreds of parallel streams, it‚Äôs banal to have your own server with Monga for DDos (especially since Monga itself can parallel incoming requests).  And then we found such a command as <a href="http://docs.mongodb.org/manual/reference/command/getLastError/">getLastError</a> , the essence of it is to wait until all operations are saved to the database and return an error code or a successful completion.  The specification reinforces trying to convince that the method is outdated and should not be used; in the Monga driver, it is marked as depricated.  But we try sending requests with <a href="http://docs.mongodb.org/manual/core/write-concern/">Write Concern</a> = Unacknowledged and <a href="http://docs.mongodb.org/manual/core/bulk-write-operations/">Bulk write</a> in ordered mode, and then we call <a href="http://docs.mongodb.org/manual/reference/command/getLastError/">getLastError ()</a> and yes, in one and a half minutes we recorded all the records synchronously, now the client starts reading exactly after the complete record of all objects, as getLastError () waits end of the last record, while the packages do not inhibit each other.  In addition, if an error occurs, we will know about it with getLastError ().  That is, we received exactly fast Bulk write with Acknowledged, but waiting for only the last packet (or almost error handling will probably be worse than the real Acknowledged mode, probably this command will not show the error that occurred only in the first packets, on the other hand the probability that The first package will fall with an error, and the last one will be successful - not so great). <br><br><img src="https://habrastorage.org/files/63f/5b3/0f0/63f5b30f0f3041b1a30ba96882954107.png" alt="image"><br>  So, what is the Mongi specification for: <br>  1. <a href="http://docs.mongodb.org/manual/core/bulk-write-operations/">Bulk write</a> operation is not very bulk and is strictly limited to a ceiling of 500-1000 requests in a packet.  <b>Update</b> : in fact, as I have now discovered, the mention of the ceiling in 1000 operations <a href="http://docs.mongodb.org/manual/core/bulk-write-operations/">appeared</a> after all, there was no mention of the magic constant <a href="https://docs.mongodb.org/v2.4/core/bulk-inserts/">more than a year ago in version 2.4</a> , when the analysis was performed, <br><br>  2. Alas, the mechanism with <a href="http://docs.mongodb.org/manual/reference/command/getLastError/">getLastError</a> was somewhat more successful and the new Write Concern mechanism does not completely replace it yet, or rather you can use an outdated command to speed up work, so the logical behavior is ‚Äúwait for the successful recording of only the last package from the large ordered bulk request "In the monge is not implemented, <br><br>  3. The Write Concern = Unacknowledged problem is not even that the data can be lost and the error is not returned, but the fact that the data is written asynchronously and the client‚Äôs attempt to immediately access the data can easily lead to the fact that he does not receive data or only a part of them (it is important if the read command is given immediately after the recording). <br><br>  4. In Mongi, query performance suffers from such a limited bulk, and the Acknowledged Write Concern is implemented not quite correctly, it is correct to wait until the end of the recording of the last packet. <br><br>  <b>PS</b> In general, it turned out to be an interesting optimization experience using non-standard methods, when the specs do not contain all the information. <br><br>  <b>PPS</b> I also advise you to look at my opensource project [useful-java-links] (https://github.com/Vedenin/useful-java-links/tree/master/link-rus) - perhaps the most comprehensive collection of useful Java libraries, frameworks and Russian-language instructional videos.  There is also a similar [English version] (https://github.com/Vedenin/useful-java-links/) of this project and start the opensource subproject [Hello world] (https://github.com/Vedenin/useful-java -links / tree / master / helloworlds) for preparing a collection of simple examples for different Java libraries in one maven project (I will be grateful for any help). </div><p>Source: <a href="https://habr.com/ru/post/261105/">https://habr.com/ru/post/261105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261089/index.html">Infrastructure: What is behind the pictures on the Internet</a></li>
<li><a href="../261091/index.html">HP StormRunner Load. A practical guide. Part III</a></li>
<li><a href="../261093/index.html">Report on the Google RISE Summit and Programming Kids Learning Services</a></li>
<li><a href="../261097/index.html">Towards the right SQL transactions (Part 1)</a></li>
<li><a href="../261101/index.html">Towards proper SQL transactions (Part 2)</a></li>
<li><a href="../261111/index.html">A simple algorithm for finding all matching sub-texts in two texts</a></li>
<li><a href="../261113/index.html">K-Meleon 75: Reached the final</a></li>
<li><a href="../261115/index.html">Porting OpenWRT to a new device on the example of ASUS DSL N12U</a></li>
<li><a href="../261117/index.html">The electronic teacher for blind on Arduino</a></li>
<li><a href="../261119/index.html">Western bestsellers in our book market. Career IT Project Manager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>