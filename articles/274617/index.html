<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Disable the bomb with Radare2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day,% username%! Today we will go to study the countless possibilities of the framework for the reverse - radare2. In the form of the test subjec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Disable the bomb with Radare2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0f6/894/09e/0f689409e9a246c1b214c3a2fd9402f2.png"><br>  Good day,% username%!  Today we will go to study the countless possibilities of the framework for the reverse - radare2.  In the form of the test subject, I took the first bomb that fell from the <a href="">site</a> of Carnegie Mellon University. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Hashes</b> <div class="spoiler_text">  Since  Binary can change leave just in case hashsum: <br>  md5sum: 1f38d04188a1d08f95d8c302f5361e9f <br>  sha1sum: 31022a4baa524f6275209f7424c616226bc9814b <br>  sha256sum: 8849e033691d51426c0c91a76eeb0c346eddd37e8fdf21cd93acd16669f1b461 <br></div></div><br><h3>  What is it all about? </h3><br>  <a href="https://en.wikipedia.org/wiki/Radare2">Radare2</a> (aka r2) is an <a href="https://github.com/radare/radare2">open source</a> cross-platform framework for exploring binary files (initially, by the way, a hex editor).  The main competitor of this is the well-known IDA Ilfak, but, alas, for the student it is expensive, and the free version with x86-64 is not friendly.  And the radar seems to be <a href="http://rada.re/r/cmp.html">cooler</a> . <br>  A binary bomb or just a bomb is an executable file for training that receives a certain number of lines, and, in case all lines are tested, congratulates the young analyst.  These are the so-called levels or phases, we have 6 of them. <br><br><h3>  A little more about the framework </h3><br>  Radare2, as already mentioned, is a framework, not just a disassembler.  It includes a bunch of different tools like debugger, hex editor, compiler, search for <a href="https://en.wikipedia.org/wiki/Return-oriented_programming">ROP</a> gadgets and much more.  For non console lovers, it also has two raw frontends, the WebUI ( <code>$ r2 -c "=H" file</code> ) and <a href="http://www.bokken.re/">Bokken</a> . <br>  Manual as usual is in man, as well as for each command by adding after it "?".  For example, ‚Äúpd?‚Äù Will give descriptions of commands starting with pd. <br><br>  Some links on the topic: <br><ul><li>  <a href="http://www.radare.org/r/">Off</a>  <a href="http://www.radare.org/r/">site</a> </li><li>  <a href="https://github.com/radare/radare2book">Free book</a> </li><li>  <a href="https://github.com/radare/radare2">Github</a> </li><li>  <a href="http://radare.today/">Blog</a> </li><li>  <a href="">Cheatsheet</a> .  <b>UPD:</b> and another <a href="https://github.com/radare/radare2book/blob/master/refcard/radare2_rc.pdf">one</a> in pdf </li><li>  <a href="https://github.com/radare/radare2/wiki/Migration-from-ida-or-gdb">Migration guide for hard-core ideas</a> </li><li>  <a href="http://irc//irc.freenode.net/">IRC channel on freenode</a> </li></ul><br><h3>  Here we go! </h3><br>  In addition to the executable file itself, we were kindly provided with a file with source codes.  However, all that is there - initialization of input, call phases, and funny comments.  The remaining functions are drawn from the corresponding headers, which we do not have. <br><div class="spoiler">  <b class="spoiler_title">The same file and it is big enough</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*************************************************************************** * Dr. Evil's Insidious Bomb, Version 1.1 * Copyright 2011, Dr. Evil Incorporated. All rights reserved. * * LICENSE: * * Dr. Evil Incorporated (the PERPETRATOR) hereby grants you (the * VICTIM) explicit permission to use this bomb (the BOMB). This is a * time limited license, which expires on the death of the VICTIM. * The PERPETRATOR takes no responsibility for damage, frustration, * insanity, bug-eyes, carpal-tunnel syndrome, loss of sleep, or other * harm to the VICTIM. Unless the PERPETRATOR wants to take credit, * that is. The VICTIM may not distribute this bomb source code to * any enemies of the PERPETRATOR. No VICTIM may debug, * reverse-engineer, run "strings" on, decompile, decrypt, or use any * other technique to gain knowledge of and defuse the BOMB. BOMB * proof clothing may not be worn when handling this program. The * PERPETRATOR will not apologize for the PERPETRATOR's poor sense of * humor. This license is null and void where the BOMB is prohibited * by law. ***************************************************************************/</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include "support.h" #include "phases.h" /* * Note to self: Remember to erase this file so my victims will have no * idea what is going on, and so they will all blow up in a * spectaculary fiendish explosion. -- Dr. Evil */ FILE *infile; int main(int argc, char *argv[]) { char *input; /* Note to self: remember to port this bomb to Windows and put a * fantastic GUI on it. */ /* When run with no arguments, the bomb reads its input lines * from standard input. */ if (argc == 1) { infile = stdin; } /* When run with one argument &lt;file&gt;, the bomb reads from &lt;file&gt; * until EOF, and then switches to standard input. Thus, as you * defuse each phase, you can add its defusing string to &lt;file&gt; and * avoid having to retype it. */ else if (argc == 2) { if (!(infile = fopen(argv[1], "r"))) { printf("%s: Error: Couldn't open %s\n", argv[0], argv[1]); exit(8); } } /* You can't call the bomb with more than 1 command line argument. */ else { printf("Usage: %s [&lt;input_file&gt;]\n", argv[0]); exit(8); } /* Do all sorts of secret stuff that makes the bomb harder to defuse. */ initialize_bomb(); printf("Welcome to my fiendish little bomb. You have 6 phases with\n"); printf("which to blow yourself up. Have a nice day!\n"); /* Hmm... Six phases must be more secure than one phase! */ input = read_line(); /* Get input */ phase_1(input); /* Run the phase */ phase_defused(); /* Drat! They figured it out! * Let me know how they did it. */ printf("Phase 1 defused. How about the next one?\n"); /* The second phase is harder. No one will ever figure out * how to defuse this... */ input = read_line(); phase_2(input); phase_defused(); printf("That's number 2. Keep going!\n"); /* I guess this is too easy so far. Some more complex code will * confuse people. */ input = read_line(); phase_3(input); phase_defused(); printf("Halfway there!\n"); /* Oh yeah? Well, how good is your math? Try on this saucy problem! */ input = read_line(); phase_4(input); phase_defused(); printf("So you got that one. Try this one.\n"); /* Round and 'round in memory we go, where we stop, the bomb blows! */ input = read_line(); phase_5(input); phase_defused(); printf("Good work! On to the next...\n"); /* This phase will never be used, since no one will get past the * earlier ones. But just in case, make this one extra hard. */ input = read_line(); phase_6(input); phase_defused(); /* Wow, they got it! But isn't something... missing? Perhaps * something they overlooked? Mua ha ha ha ha! */ return 0; }</span></span></span></span></code> </pre><br></div></div><br>  After starting r2, he meets us with a random phrase.  Then he sets the current <a href="https://en.wikipedia.org/wiki/Entry_point">entry-point</a> pointer and waits for the command.  The <b>-A</b> flag when opening a file immediately analyzes it. <br>  The same can be done with a block of commands starting with <b>a</b> ), for example <b>afl</b> - gets a list of functions from a binary.  <b>~</b> - analogue grep-a (filter).  We will look for our functions from him. <br><pre> <code class="bash hljs">$ r2 -A bomb -- In soviet Afghanistan, you debug radare2! [0x00400c90]&gt; afl~phase 0x00400ee0 28 3 sym.phase_1 0x004015c4 149 8 sym.phase_defused 0x00400efc 71 8 sym.phase_2 0x00400f43 139 8 sym.phase_3 0x0040100c 86 7 sym.phase_4 0x00401062 146 9 sym.phase_5 0x004010f4 272 26 sym.phase_6 0x00401242 81 5 sym.secret_phase</code> </pre><br><h3>  Level 1 </h3><br>  Miraculously, all the functions from the source in place, but at the same time also found the secret phase.  Let's finally see the contents of the first level.  You can do this by moving the pointer to a specific address of the function, and then output the required number of opcodes for disassembling. <br><pre> <code class="bash hljs">[0x00400c90]&gt; s 0x00400ee0 <span class="hljs-comment"><span class="hljs-comment">#    's' -   [0x00400ee0]&gt; pd 8 #  8    </span></span></code> </pre><br>  Since  The output of r2 from the box is just perfect, for clarity, I will post assembler listings in the form of pictures. <br><img src="https://habrastorage.org/files/a2d/592/716/a2d5927162ce4826af22215b6a0b75ad.png"><br>  Please note that the radar provided us with XREFs (that‚Äôs where the control can be transferred from) with jump mnemonics.  In addition, I substituted a line at the specified address and, most importantly, in the form of ascii arrows, showed transitions in the block. <br><div class="spoiler">  <b class="spoiler_title">For comparison, the output from objdump</b> <div class="spoiler_text"><pre> <code class="hljs xml">0000000000400ee0 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase_1</span></span></span><span class="hljs-tag">&gt;</span></span>: 400ee0: 48 83 ec 08 sub rsp,0x8 400ee4: be 00 24 40 00 mov esi,0x402400 400ee9: e8 4a 04 00 00 call 401338 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strings_not_equal</span></span></span><span class="hljs-tag">&gt;</span></span> 400eee: 85 c0 test eax,eax 400ef0: 74 05 je 400ef7 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase_1+0x17</span></span></span><span class="hljs-tag">&gt;</span></span> 400ef2: e8 43 05 00 00 call 40143a <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">explode_bomb</span></span></span><span class="hljs-tag">&gt;</span></span> 400ef7: 48 83 c4 08 add rsp,0x8 400efb: c3 ret retq</code> </pre><br></div></div><br>  Even without delving into it, it becomes clear that the first line we need is ‚ÄúBorder relations with Canada‚Äù.  And by itself, when fed to her bomb, she lets us into the second phase. <br><pre> <code class="bash hljs">$ ./bomb Welcome to my fiendish little bomb. You have 6 phases with <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> to blow yourself up. Have a nice day! Border relations with Canada have never been better. Phase 1 defused. How about the next one?</code> </pre><br><h3>  Level 2 </h3><br>  The second variant of the output of the disassembled function is using absolute addressing / labels.  For example, the second phase - it will look like this: <br><pre> <code class="bash hljs">[0x00400ee0]&gt; pdf @ 0x00400efc</code> </pre><br>  or if the address is not known: <br><pre> <code class="bash hljs">[0x00400ee0]&gt; pdf @ sym.phase_2</code> </pre><br><img src="https://habrastorage.org/files/f6d/c00/ac3/f6dc00ac3f454a23b71ce243777cf3b3.png"><br>  Our ultimate goal is not to detonate a bomb, i.e.  Do not make calls to <b>call sym.explode_bomb</b> , so we will make a start from this.  Therefore, both je jumps should always work with us. <br>  The first thing that stands in our way is a <b>call to sym.read_six_numbers</b> .  Accordingly, after this call at the top of the stack should be one.  Let's see what happens in this function. <br><img src="https://habrastorage.org/files/244/a0a/79f/244a0a79f19141af8bb2215df44a0531.png"><br>  Previously, r2 parsed files for functions based on the <b>ret</b> opcode, which often led to the output of several functions (for example, if there are exit () system calls).  In such cases, when the radar incorrectly determines the function, you can do it manually. <br><pre> <code class="bash hljs">[0x00400ee0]&gt; s 0x0040149e <span class="hljs-comment"><span class="hljs-comment">#       [0x0040149e]&gt; af+ sym.read_six_numbers `?vi $$-sym.read_six_numbers` rsn #   rsn,    sym.read_six_numbers   .</span></span></code> </pre><br>  By the way, in this example, another command was used as the argument of the first one using paired brackets <b>``</b> . <br>  Nothing interesting happens in the function itself; it takes 6 numbers from the read string and writes them in order to the passed pointer.  Then makes sure that the numbers are greater than 5. <br>  In C, it would look something like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_six_numbers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(str, <span class="hljs-string"><span class="hljs-string">"%d %d %d %d %d %d"</span></span>, p, p+<span class="hljs-number"><span class="hljs-number">1</span></span>, p+<span class="hljs-number"><span class="hljs-number">2</span></span>, p+<span class="hljs-number"><span class="hljs-number">3</span></span>, p+<span class="hljs-number"><span class="hljs-number">4</span></span>, p+<span class="hljs-number"><span class="hljs-number">5</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">5</span></span>) explode_bomb(); }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's go back to our <b>phase_2</b> function.  A pointer to an array is passed a pointer to the top of the stack ( <b>mov rsi, rsp</b> ).  Therefore, the first number in the line should be - 1. <br>  As you can see there are a lot of transitions.  The IDA user would most likely press the space bar and look at the transition graph.  You will not believe, but here they are too.  Like vim, there is visual-mode (command <b>V</b> ) and in it there is the same transition graph, also on command <b>V</b> (or <b>VV at</b> once).  Exit from each mod - <b>q</b> <br><div class="spoiler">  <b class="spoiler_title">The output will be such a cute ASCII graph</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/02c/8c4/b0b/02c8c4b0beaf45e8b9fa607f98fff4a5.png"><br></div></div><br>  It is displayed perfectly, with a minimum of intersections (compared to previous versions).  You can move this miracle with arrows, or vim-like <b>'hjkl'</b> .  If you do not like the location of the blocks, you can also move the hotkeys <b>Shift + 'hjkl'</b> .  This moves the selected block (blue), you can select it <b>Tab</b> / <b>Shift-Tab</b> . <br>  In the first block, a pointer to the second number is written in <b>rbx</b> , and in <b>rbp</b> - at the end of the array of numbers.  And control is thrown on a cycle in which neighboring numbers are compared in pairs. <br><pre> <code class="hljs 1c">mov eax, dword [rbx - <span class="hljs-number"><span class="hljs-number">4</span></span>] ;   <span class="hljs-built_in"><span class="hljs-built_in"></span></span>  eax add eax, eax ;   cmp dword [rbx], eax ;    je <span class="hljs-number"><span class="hljs-number">0</span></span>x400f25 ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>, <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  call sym.explode_bomb ;  , <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  add rbx, <span class="hljs-number"><span class="hljs-number">4</span></span> ;     <span class="hljs-built_in"><span class="hljs-built_in"></span></span> cmp rbx, rbp ; ,      jne <span class="hljs-number"><span class="hljs-number">0</span></span>x400f17 ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,     jmp <span class="hljs-number"><span class="hljs-number">0</span></span>x400f3c ;  <span class="hljs-keyword"><span class="hljs-keyword"></span></span></code> </pre><br>  It turns out that we need to enter a sequence of powers of two from 1 to 32. Excellent, but still check that this is what you need. <br><pre> <code class="bash hljs">$ ./bomb ... Phase 1 defused. How about the next one? 1 2 4 8 16 32 That<span class="hljs-string"><span class="hljs-string">'s number 2. Keep going!</span></span></code> </pre><br><h3>  Level 3 </h3><br><img src="https://habrastorage.org/files/b13/5d9/a4b/b135d9a4b7394707a5d1074428a249e1.png"><br>  Probably now a person far from an assembler, in epileptic seizures, is trying to get a cross on the edge of the window.  In fact, there is nothing to be afraid of, just like this is the most common switch-case block. <br>  Numbers are read in the same way as in the previous case, only without calling a function and only two.  They are stored in <b>[rsp + 8]</b> and <b>[rsp + 0xc],</b> respectively. <br>  Then there are checks that both numbers are read successfully, as well as the first argument is not more than 7. After that, the switch <b>goes</b> to the address <b>0x402470</b> with an offset (the number entered) * 8. <br>  It is not difficult to guess that the addresses of the case tags are there.  In order not to be unfounded, let's see what really lies there.  This can be done using the <b>px</b> command groups.  In this case, we are interested in 8-byte words ( <b>Q</b> uad-word). <br><pre> <code class="bash hljs">[0x0040149e]&gt; pxQ 72 @ 0x402470 0x00402470 0x0000000000400f7c sym.phase_3+57 0x00402478 0x0000000000400fb9 sym.phase_3+118 0x00402480 0x0000000000400f83 sym.phase_3+64 0x00402488 0x0000000000400f8a sym.phase_3+71 0x00402490 0x0000000000400f91 sym.phase_3+78 0x00402498 0x0000000000400f98 sym.phase_3+85 0x004024a0 0x0000000000400f9f sym.phase_3+92 0x004024a8 0x0000000000400fa6 sym.phase_3+99</code> </pre><br>  Actually, as expected, although not quite consistently.  Next comes the verification of our second number with the magic one that was written in <b>eax</b> with the switch.  Since the input in decimal basis will have to be converted from hex.  You can calculate it using <b>rax2</b> (analog calculator) through a shell call, as well as directly, through the built-in calculator (hotkey - <b>?</b> ), Without creating new programs.  And, in order not to constantly press enter, you can group commands just like in a bash. <br><pre> <code class="bash hljs">[0x0040149e]&gt; !rax2 0xcf 207 [0x0040149e]&gt; ?vi 0x2c3; ?vi 0x100; ?vi 0x185; ?vi 0xce; ?vi 0x2aa; ?vi 0x147; ?vi 0x137 707 256 389 206 682 327 311</code> </pre><br>  Total possible solutions will be: <br><ul><li>  0 207 </li><li>  1,311 </li><li>  2,707 </li><li>  3,256 </li><li>  4,389 </li><li>  5,206 </li><li>  6,682 </li><li>  7,327 </li></ul><br>  And once again make sure, on an arbitrary version, that everything works: <br><pre> <code class="bash hljs">$ ./bomb ... That<span class="hljs-string"><span class="hljs-string">'s number 2. Keep going! 4 389 Halfway there!</span></span></code> </pre><br><h3>  Level 4 </h3><br><div class="spoiler">  <b class="spoiler_title">sym.phase_4</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7c0/f3c/449/7c0f3c44994e42d699230fb9c24e1143.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">sym.func4</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/aa9/404/86f/aa940486fda041729bfa2728c4d52780.png"><br></div></div><br>  Recursion appears at this level.  In addition to the built-in ASCII-graphs, it is also possible to get graphs as files for the dot utility, and then, for example, convert to png. <br><pre> <code class="bash hljs">[0x0040149e]&gt; ag sym.func4 &gt; func4.dot [0x0040149e]&gt; dot -Tpng -o func4.png func4.dot</code> </pre><br><img src="https://habrastorage.org/files/7e8/547/095/7e85470951c1422080a2668a4f6f5415.png"><br>  If all this is translated into C, it will look <i>almost</i> not so scary. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phase_4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, y; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(str, <span class="hljs-string"><span class="hljs-string">"%d %d"</span></span>, &amp;x, &amp;y) != <span class="hljs-number"><span class="hljs-number">2</span></span> || x &gt; <span class="hljs-number"><span class="hljs-number">14</span></span> || func4(x, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>) || y != <span class="hljs-number"><span class="hljs-number">0</span></span>) explode_bomb(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> diff = (z - y)/<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p = y + diff; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p &gt; x) { func4(x, y, p<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> diff * <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p &lt; x) { func4(x, p + <span class="hljs-number"><span class="hljs-number">1</span></span>, z); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> diff * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  The simplest and most obvious solution is that the func4 function returns 0 when it does not go inside an else-if.  User input controls only <b>x</b> , and <b>p = 7</b> at the first entry.  Accordingly, when <b>x = 7, the</b> function simply returns 0, without recurrent calls.  The second variable is strictly set to zero.  We will see this. <br><pre> <code class="bash hljs">$ ./bomb in.tmp ... Halfway there! 7 0 So you got that one. Try this one.</code> </pre><br><h3>  Level 5 </h3><br><img src="https://habrastorage.org/files/d4c/46b/e90/d4c46be90750481eafcba9ff0ffeb3e9.png"><br>  It will be more difficult with this, a lot of code is piled up here. <br>  In <b>0x00401073 the</b> <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow">canary is</a> written on the stack.  Similar information about the binary can be obtained using the <b>i</b> command.  For example, <b>i ~ canary</b> will return <b>true</b> in this case. <br>  After that, the return value of string_length is compared with 6 and the hard-to-analyze spaghetti code begins.  Dealing without a debugger with this is long and difficult, so it would be a sin not to use it.  To do this, open the file with the debug flag or at startup: <br><pre> <code class="bash hljs">$ r2 -Ad bomb</code> </pre><br>  or simply reopening the file: <br><pre> <code class="bash hljs">[0x0040149e]&gt; ood</code> </pre><br>  The address of the pointer will automatically change to the first opcode in the entry-point, which is already loaded into memory.  As usual we set breakpoints and continue execution to them. <br><pre> <code class="bash hljs">[0x7f2960b99d80]&gt; db sym.phase_5 <span class="hljs-comment"><span class="hljs-comment">#  s sym.phase_5; db $$ [0x7f2960b99d80]&gt; dc #    1 </span></span></code> </pre><br>  Then there are 2 ways to analyze: the first is to use the <b>d</b> / <b>db</b> command block, the second is to switch to Visual-mode.  The first method is not so visual, so let's stop on the second. <br>  As before, go to Visual-mode, and then select the required debug-layout for debugging hotkeys <b>p</b> / <b>P.</b> <br>  You can mix by code using <b>n</b> / <b>N</b> - next / previous function;  <b>j</b> / <b>k</b> is the next previous opcode. <br>  And the most interesting: <b>b</b> / <b>F2</b> - set breakpoint, <b>s</b> / <b>F7</b> - step in 1 opcode, <b>S</b> / <b>F8</b> - step in 1 opcode without entering the call, <b>F9</b> - continue until breakpoint. <br><div class="spoiler">  <b class="spoiler_title">This is how it all looks.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c71/628/348/c7162834889e4ef8b1b932ffb8e02791.gif"><br></div></div><br>  In total, after feeding several lines to the debugger, it is not difficult to guess what is happening there. <br>  For each character from our string modulo 16, the corresponding character is taken from the string <code>char *s = "maduiersnfotvbyl"</code> and the resulting string is compared to "flyers". <br>  Actually, our task is to find such characters whose indices in str give the search string. <br>  A string of flyers can be obtained uniquely: {s [0x9], s [0xe], s [0xf], s [0x5], s [0x6], s [0x7]}.  I think that not everyone keeps the ASCII table in his head, so you can again refer to the rax2 utility for help.  With the <b>-s option,</b> it converts from hex to string.  Since  characters are taken modulo 16, then for aesthetics, you can choose printable values. <br><pre> <code class="bash hljs">$ rax2 -s 49 4e 4f 45 46 47 INOEFG</code> </pre><br><pre> <code class="bash hljs">$ ./bomb ... So you got that one. Try this one. INOEFG Good work! On to the next...</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Line digression</b> <div class="spoiler_text">  I have been thinking for a very long time and still think that there can be some meaningful word.  So if suddenly someone will find I will be extremely grateful :) <br></div></div><br><h3>  The last one </h3><br>  Since the article was too big, I will not consider all the phases.  In particular, I will omit the 6th phase, because there is a lot of painstaking understanding without the direct participation of the framework.  Let it remain the most inquisitive homework. <br>  Getting into the secret phase is not so easy, so simplify your life by patching the binary.  We will have to reopen the file, issuing write permissions with the <b>-w</b> flag, or rediscover it using <b>oo +</b> without leaving r2. <br><pre> <code class="bash hljs">$ r2 -Aw bomb -- Did you ever ordered a pizza using radare2? [0x00400c90]&gt; s 0x00400ec6 <span class="hljs-comment"><span class="hljs-comment"># call sym.phase_6 [0x00400ec6]&gt; wa call sym.secret_phase #    [0x00400ec6]&gt; pdf @ sym.secret_phase; pdf @ sym.fun7</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">secret_phase</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/ef3/0bb/17a/ef30bb17a8384842ae0cc1040a222a7e.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">fun7</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f25/e99/164/f25e9916405a41e9b15f82481d73588a.png"><br></div></div><br>  Again, a recursive function appears and this time it is not so easy to bypass it, because without recursive calls the desired value is as simple as it was last time, not to receive.  ASCII graph can simplify life again. <br><img src="https://habrastorage.org/files/c35/2cc/c8d/c352ccc8d0254c8b9b06e7fb4d2eb565.png"><br>  The analysis gives <abbr title="By the way, I did not quite translate correctly.">approximately the</abbr> following analogue in C: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">secret_phase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> num = strtol(read_line()) - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (num &gt; <span class="hljs-number"><span class="hljs-number">0x3e8</span></span> || fun7((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>*)(<span class="hljs-number"><span class="hljs-number">0x6030f0</span></span>), num) != <span class="hljs-number"><span class="hljs-number">2</span></span>) explode_bomb(); <span class="hljs-built_in"><span class="hljs-built_in">puts</span></span>(<span class="hljs-string"><span class="hljs-string">"Wow! You've defused the secret stage!"</span></span>); phase_defused(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun7</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">array</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> num)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">array</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*<span class="hljs-built_in"><span class="hljs-built_in">array</span></span> &lt;= num) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*<span class="hljs-built_in"><span class="hljs-built_in">array</span></span> == num) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 else { return 2 * fun7(array + 1, num); // 2 } } else { return 2 * fun7(array + 2, num) + 1; // 3 } }</span></span></code> </pre><br>  So, to get exactly two at the output of <b>fun7</b> , we need to first call ret on line <b>2</b> , then at <b>3</b> and finally at <b>1</b> .  There remains only one mystery - that is stored at <b>0x6030f0</b> . <br><div class="spoiler">  <b class="spoiler_title">480 bytes</b> <div class="spoiler_text"><pre> <code class="bash hljs">[0x00401204]&gt; px 480 @ 0x6030f0 - offset - 0 1 2 3 4 5 6 7 8 9 ABCDEF 0123456789ABCDEF 0x006030f0 2400 0000 0000 0000 1031 6000 0000 0000 $........1`..... 0x00603100 3031 6000 0000 0000 0000 0000 0000 0000 01`............. 0x00603110 0800 0000 0000 0000 9031 6000 0000 0000 .........1`..... 0x00603120 5031 6000 0000 0000 0000 0000 0000 0000 P1`............. 0x00603130 3200 0000 0000 0000 7031 6000 0000 0000 2.......p1`..... 0x00603140 b031 6000 0000 0000 0000 0000 0000 0000 .1`............. 0x00603150 1600 0000 0000 0000 7032 6000 0000 0000 ........p2`..... 0x00603160 3032 6000 0000 0000 0000 0000 0000 0000 02`............. 0x00603170 2d00 0000 0000 0000 d031 6000 0000 0000 -........1`..... 0x00603180 9032 6000 0000 0000 0000 0000 0000 0000 .2`............. 0x00603190 0600 0000 0000 0000 f031 6000 0000 0000 .........1`..... 0x006031a0 5032 6000 0000 0000 0000 0000 0000 0000 P2`............. 0x006031b0 6b00 0000 0000 0000 1032 6000 0000 0000 k........2`..... 0x006031c0 b032 6000 0000 0000 0000 0000 0000 0000 .2`............. 0x006031d0 2800 0000 0000 0000 0000 0000 0000 0000 (............... 0x006031e0 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x006031f0 0100 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603200 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603210 6300 0000 0000 0000 0000 0000 0000 0000 c............... 0x00603220 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603230 2300 0000 0000 0000 0000 0000 0000 0000 <span class="hljs-comment"><span class="hljs-comment">#............... 0x00603240 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603250 0700 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603260 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603270 1400 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603280 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x00603290 2f00 0000 0000 0000 0000 0000 0000 0000 /............... 0x006032a0 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x006032b0 e903 0000 0000 0000 0000 0000 0000 0000 ................ 0x006032c0 0000 0000 0000 0000 0000 0000 0000 0000 ................</span></span></code> </pre><br></div></div><br>  Here 8-byte variables are stored in blocks of 4. The first is used to compare with our number;  the second and third are pointers to the following characters for comparison;  the fourth is just padding, not used. <br>  Now you can expand all the conditions and find the desired variable. <br><ul><li>  <abbr title="0x006030f0">2 ret</abbr> : num &lt;0x24 </li><li>  <abbr title="0x00603110">3 ret</abbr> : num&gt; 0x08 </li><li>  <abbr title="0x00603150">1 ret</abbr> : num == 0x16 </li></ul><br><pre> <code class="bash hljs">$ ./bombSec in.tmp ... Good work! On to the next... 22 Wow! You<span class="hljs-string"><span class="hljs-string">'ve defused the secret stage! Congratulations! You'</span></span>ve defused the bomb!</code> </pre><br><br>  Ehu, we made it!  <s>Humanity can live in peace</s> .  Despite the fact that the article came out a bit too big, quite a lot of framework features were not covered, so those interested can still discover a lot for themselves.  Also, I will be glad to hear ideas for possible continuation. </div><p>Source: <a href="https://habr.com/ru/post/274617/">https://habr.com/ru/post/274617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274603/index.html">PROLOG for programmers</a></li>
<li><a href="../274605/index.html">Low-level optimization of parallel algorithms or SIMD in .NET</a></li>
<li><a href="../274611/index.html">Use apply, sapply, lapply in R</a></li>
<li><a href="../274613/index.html">Wi-Fi Alliance announced a new type of Wi-Fi for IoT and low-power devices</a></li>
<li><a href="../274615/index.html">The pitfalls of using Excel Power Query and MySQL to automate reporting</a></li>
<li><a href="../274619/index.html">Some sugar in combinatorics</a></li>
<li><a href="../274621/index.html">Tools for hacking, flashed in the TV series Mr Robot</a></li>
<li><a href="../274625/index.html">Creating game levels: tips and tricks (part 2)</a></li>
<li><a href="../274629/index.html">The first build of Vivaldi 1.0.365.3 in the coming year</a></li>
<li><a href="../274631/index.html">Pagekit: Symfony Modular CMS Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>