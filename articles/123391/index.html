<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using MySQL events in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For those who actively use MySQL, it is not a secret that since version 5.1, MySQL supports events (events). If you need to perform queries or separat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using MySQL events in practice</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2f7/3f4/bf4/2f73f4bf486e539a960f5e2148a23eac.png" alt="how does events work" align="left">  For those who actively use MySQL, it is not a secret that since version 5.1, MySQL supports events (events).  If you need to perform queries or separate procedures on a schedule, and <s>there was no laziness</s> to switch from the console launch to the built-in MySQL functionality, <a name="habracut"></a>  welcome under cat. <br><br>  To begin with, let us remind ourselves what events in MySQL are and how to prepare them? <br>  First of all, events provide cross-platform, since they do not require any external applications.  Inside the event, you can run SQL commands or simply call pre-written procedures. <br>  In our case, we will be engaged in the archiving of a rapidly swelling table, in which user requests are logged. <br><br><h3>  Turn on the scheduler </h3><br>  The event variable is <b>handled by the</b> global variable <b>event_scheduler</b> .  For MySQL later than 5.1.11, it can take one of 3 values: <br>  <b>OFF</b> (can also be <b>0</b> ): Scheduler stopped.  The scheduler thread is not executed and is not shown in the output of SHOW PROCESSLIST.  No scheduled events are executed.  OFF is the default for event_scheduler. <br>  <b>ON</b> (can also be <b>1</b> ): Scheduler is working.  The scheduler thread runs itself and executes all scheduled events.  The event scheduler thread is listed in the output of SHOW PROCESSLIST as a background process. <br>  <b>DISABLED</b> : value makes the scheduler inactive.  The scheduler thread is not executed and is not displayed in the output of SHOW PROCESSLIST. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We are interested in the enabled state, so you need to register in the config <br><br> <code>event_scheduler=1</code> <br> <br>  or execute the command <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> event_scheduler=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>;</code> </pre> <br><br><h3>  Create event </h3><br>  I liked just calling the procedure inside the event.  It is also possible because it was already created and started by the application itself;) So, let's create a procedure: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER = <span class="hljs-string"><span class="hljs-string">'root'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-string"><span class="hljs-string">`new_proc`</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DETERMINISTIC</span></span> CONTAINS <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECURITY</span></span> DEFINER <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> tbl_tmp,tbl_logarch <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- tbl_log     --       tbl_log_&lt;&gt;_&lt;&gt; SET tbl_logarch=DATE_FORMAT(CURRENT_TIMESTAMP, '%Y%m%d_%H%i'); SET tbl_tmp=CONCAT("tbl_log_", tbl_logarch); --  SQL     ; SET @archive_query:=CONCAT("CREATE TABLE ", tbl_tmp, " ENGINE=ARCHIVE AS (SELECT * FROM tbl_log)"); --    PREPARE archive_query FROM @archive_query; EXECUTE archive_query; DEALLOCATE PREPARE archive_query; --     ,       DELETE FROM tbl_log; END;</span></span></code> </pre> <br><br>  Now run the procedure and see if it works. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">call</span></span> new_proc();</code> </pre> <br><br>  If everything is in order, then continue.  Create an event directly.  The simplified syntax is: <br> <code>CREATE EVENT event_name ON SCHEDULE AT {DATE AND TIME} DO {SQL COMMAND}; <br></code> <br>  or <br> <code>CREATE EVENT event_name ON SCHEDULE EVERY {X} {SECOND|MINUTE|HOUR|DAY|MONTH|YEAR|WEEK} DO {SQL COMMAND}; <br></code> <br><br>  I needed to archive once a week, so my DDL looks like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EVENT</span></span> <span class="hljs-string"><span class="hljs-string">`new_event`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> SCHEDULE EVERY <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WEEK</span></span> STARTS <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> COMPLETION <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRESERVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> new_proc();</code> </pre><br><br><h3>  Observe the result </h3><br>  Having played around with time, I made sure that the event created does exactly what I expected.  One more step to automation is made.  As a bonus, studied several additional materials on the topic. <br><br>  PS Just in case, pay attention that I tried to present only the practical part.  Therefore, I deliberately omitted the description of the extended syntax, user privileges, restrictions, depending on the versions of MySQL.  If you, dear habrachelovek, failed to create and use the event according to the above instructions, you can always write about it in habrakoment (I will try to answer) or find a solution on other useful resources. <br><br>  In the process of writing materials used: <br>  <a href="http://dev.mysql.com/doc/refman/5.1/en/events.html">dev.mysql.com/doc/refman/5.1/en/events.html</a> <br>  <a href="http://www.rldp.ru/mysql/mysqlpro/events.htm">www.rldp.ru/mysql/mysqlpro/events.htm</a> <br><br>  <b>UPD:</b> They say that it is possible to organize interaction between the event scheduler and the operating system using federated table and MySQL Proxy.  I have not tried it myself.  Who in the subject, write pliz komenty. </div><p>Source: <a href="https://habr.com/ru/post/123391/">https://habr.com/ru/post/123391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123382/index.html">Course on training idiots (quotes from the book "The Art of website design")</a></li>
<li><a href="../123383/index.html">During the year the number of spam decreased by 82.22%</a></li>
<li><a href="../123385/index.html">The architecture of the Aggregation-Access network of large providers</a></li>
<li><a href="../123386/index.html">Storage format for sharing in the cloud</a></li>
<li><a href="../123388/index.html">Sony is going to put into operation the Playstation Network and Qriocity by July 6</a></li>
<li><a href="../123394/index.html">Working with ShapeFile (* .shp) in Delphi</a></li>
<li><a href="../123395/index.html">Accounting system based on the OCR system</a></li>
<li><a href="../123396/index.html">Czech! Who is to blame and what should an IT specialist do abroad !?</a></li>
<li><a href="../123397/index.html">Determining GPS availability in Android</a></li>
<li><a href="../123400/index.html">Three.js - 3D do it yourself browser or WebGL gets closer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>