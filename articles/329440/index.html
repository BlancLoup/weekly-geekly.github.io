<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerating WSUS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A freshly installed WSUS update server after a few years of operation turns into a cumbersome monster. Clients update slowly and look for updates for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerating WSUS</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/c91/596/84a/c9159684a2504a0881b9616a57cc914d.png"></div><br>  A freshly installed WSUS update server after a few years of operation turns into a cumbersome monster.  Clients update slowly and look for updates for a long time, WindowsUpdate.log logs are full of HTTP errors, and the administrator is depressed. <br>  Here are some tips that can speed up a server in many cases. <br><a name="habracut"></a><br>  <a href="https://habrahabr.ru/post/329440/">1. Configure IIS</a> <br>  <a href="https://habrahabr.ru/post/329440/">2. Cleaning the base</a> <br>  <a href="https://habrahabr.ru/post/329440/">3. Reindexing</a> <br>  <a href="https://habrahabr.ru/post/329440/">4. Configure TempDB</a> <br><br><h4><a name="1"></a>  Configure Internet Information Server </h4><br>  In the default configuration, the ‚ÄúWsusPool‚Äù application pool is undeservedly deprived of memory.  This is the main cause of HTTP server errors in client logs. <br><br>  To add memory to the process, launch the IIS snap-in and open the Advanced settings: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/3dd/4af/7be/3dd4af7beda540acbfd6845020a5ccfa.png"><br><br><img src="https://habrastorage.org/web/97f/d00/e33/97fd00e330bf4b43890c07c6a37ed63d.png"><br><br>  Set the limit to 0. <br><br><img src="https://habrastorage.org/web/bdf/a30/c6d/bdfa30c6d0a24ffea864e9ee584a794d.png"><br><br><h4><a name="2"></a>  Base cleaning </h4><br>  You can run the Server Cleanup Wizard in the WSUS console.  The main secret is that it should be run regularly, at least once a month. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/0fd/712/258/0fd7122588c84002ba6b254bc455124e.PNG"></div><br>  Approved a fresh pack of updates - clean the server.  If this is not done, the wizard stops working normally.  After starting it hangs for several hours, after which the console crashes. <br><br>  For starters, you can try to run each item separately, from top to bottom: <br><br><img src="https://habrastorage.org/web/4a3/1ae/8c6/4a31ae8c61894911a5fe58458940bdd6.png"><br><br>  If this does not help, you need to perform cleaning directly in the database.  To do this, you need to connect to an instance of SQL Server with Management Studio.  Management Studio has become a separate product.  It can be downloaded from this <a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms">link</a> . <br><br>  If you are using the Windows Internal Database, you must put Management Studio on a server with WSUS.  To connect to the instance, use the string: <br><br><pre><code class="hljs tex"><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>.<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pipe</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MICROSOFT</span></span></span></span>##WID<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tsql</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">query</span></span></span></span></code> </pre> <br><img src="https://habrastorage.org/web/32a/f18/d79/32af18d79ccb48138d6e7d1882d9390c.png"><br><br>  To clear the base, execute 4 magic commands: <br><br><pre> <code class="sql hljs">EXEC SUSDB.dbo.spDeclineExpiredUpdates;1</code> </pre> <br><pre> <code class="sql hljs">EXEC SUSDB.dbo.spDeclineSupersededUpdates;1</code> </pre> <br>  For the <b>spCompressUpdate command</b> , a ‚Äúwrapper‚Äù is used: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> SUSDB <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @var1 <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @curitem <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @totaltodelete <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @msg <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#results (Col1 INT) INSERT INTO #results(Col1) EXEC spGetUpdatesToCompress SET @totaltodelete = (SELECT COUNT(*) FROM #results) SELECT @curitem=1 DECLARE WC Cursor FOR SELECT Col1 FROM #results OPEN WC FETCH NEXT FROM WC INTO @var1 WHILE (@@FETCH_STATUS &gt; -1) BEGIN SET @msg = cast(@curitem as varchar(5)) + '/' + cast(@totaltodelete as varchar(5)) + ': Compressing ' + CONVERT(varchar(10), @var1) + ' ' + cast(getdate() as varchar(30)) RAISERROR(@msg,0,1) WITH NOWAIT EXEC spCompressUpdate @localUpdateID=@var1 SET @curitem = @curitem +1 FETCH NEXT FROM WC INTO @var1 END CLOSE WC DEALLOCATE WC DROP TABLE #results</span></span></code> </pre><br>  The same wrapper for <b>spDeleteUpdate</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> SUSDB <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @var1 <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @curitem <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @totaltodelete <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @msg <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#results (Col1 INT) INSERT INTO #results(Col1) EXEC spGetObsoleteUpdatesToCleanup SET @totaltodelete = (SELECT COUNT(*) FROM #results) SELECT @curitem=1 DECLARE WC Cursor FOR SELECT Col1 FROM #results OPEN WC FETCH NEXT FROM WC INTO @var1 WHILE (@@FETCH_STATUS &gt; -1) BEGIN SET @msg = cast(@curitem as varchar(5)) + '/' + cast(@totaltodelete as varchar(5)) + ': Deleting ' + CONVERT(varchar(10), @var1) + ' ' + cast(getdate() as varchar(30)) RAISERROR(@msg,0,1) WITH NOWAIT EXEC spDeleteUpdate @localUpdateID=@var1 SET @curitem = @curitem +1 FETCH NEXT FROM WC INTO @var1 END CLOSE WC DEALLOCATE WC DROP TABLE #results</span></span></code> </pre><br>  During the work of "wrappers" customers stop receiving updates.  You can at any time interrupt the execution of the script without losing progress.  In order to continue the process, do not forget to delete the temporary table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#results</span></span></code> </pre> <br>  In the cleaning wizard of 5 commands, we have completed 4 of them.  The <b>"Delete computers not contacting server"</b> command should be executed from the wizard. <br><br><h4><a name="3"></a>  Reindex database </h4><br>  To re-index the database, use the following <a href="https://gallery.technet.microsoft.com/scriptcenter/6f8cde49-5c52-4abd-9820-f1d270ddea61">script</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Reindex script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/****************************************************************************** This sample T-SQL script performs basic maintenance tasks on SUSDB 1. Identifies indexes that are fragmented and defragments them. For certain tables, a fill-factor is set in order to improve insert performance. Based on MSDN sample at http://msdn2.microsoft.com/en-us/library/ms188917.aspx and tailored for SUSDB requirements 2. Updates potentially out-of-date table statistics. ******************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> SUSDB; GO <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- Rebuild or reorganize indexes based on their fragmentation levels DECLARE @work_to_do TABLE ( objectid int , indexid int , pagedensity float , fragmentation float , numrows int ) DECLARE @objectid int; DECLARE @indexid int; DECLARE @schemaname nvarchar(130); DECLARE @objectname nvarchar(130); DECLARE @indexname nvarchar(130); DECLARE @numrows int DECLARE @density float; DECLARE @fragmentation float; DECLARE @command nvarchar(4000); DECLARE @fillfactorset bit DECLARE @numpages int -- Select indexes that need to be defragmented based on the following -- * Page density is low -- * External fragmentation is high in relation to index size PRINT 'Estimating fragmentation: Begin. ' + convert(nvarchar, getdate(), 121) INSERT @work_to_do SELECT f.object_id , index_id , avg_page_space_used_in_percent , avg_fragmentation_in_percent , record_count FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL , NULL, 'SAMPLED') AS f WHERE (f.avg_page_space_used_in_percent &lt; 85.0 and f.avg_page_space_used_in_percent/100.0 * page_count &lt; page_count - 1) or (f.page_count &gt; 50 and f.avg_fragmentation_in_percent &gt; 15.0) or (f.page_count &gt; 10 and f.avg_fragmentation_in_percent &gt; 80.0) PRINT 'Number of indexes to rebuild: ' + cast(@@ROWCOUNT as nvarchar(20)) PRINT 'Estimating fragmentation: End. ' + convert(nvarchar, getdate(), 121) SELECT @numpages = sum(ps.used_page_count) FROM @work_to_do AS fi INNER JOIN sys.indexes AS i ON fi.objectid = i.object_id and fi.indexid = i.index_id INNER JOIN sys.dm_db_partition_stats AS ps on i.object_id = ps.object_id and i.index_id = ps.index_id -- Declare the cursor for the list of indexes to be processed. DECLARE curIndexes CURSOR FOR SELECT * FROM @work_to_do -- Open the cursor. OPEN curIndexes -- Loop through the indexes WHILE (1=1) BEGIN FETCH NEXT FROM curIndexes INTO @objectid, @indexid, @density, @fragmentation, @numrows; IF @@FETCH_STATUS &lt; 0 BREAK; SELECT @objectname = QUOTENAME(o.name) , @schemaname = QUOTENAME(s.name) FROM sys.objects AS o INNER JOIN sys.schemas as s ON s.schema_id = o.schema_id WHERE o.object_id = @objectid; SELECT @indexname = QUOTENAME(name) , @fillfactorset = CASE fill_factor WHEN 0 THEN 0 ELSE 1 END FROM sys.indexes WHERE object_id = @objectid AND index_id = @indexid; IF ((@density BETWEEN 75.0 AND 85.0) AND @fillfactorset = 1) OR (@fragmentation &lt; 30.0) SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE'; ELSE IF @numrows &gt;= 5000 AND @fillfactorset = 0 SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD WITH (FILLFACTOR = 90)'; ELSE SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD'; PRINT convert(nvarchar, getdate(), 121) + N' Executing: ' + @command; EXEC (@command); PRINT convert(nvarchar, getdate(), 121) + N' Done.'; END -- Close and deallocate the cursor. CLOSE curIndexes; DEALLOCATE curIndexes; IF EXISTS (SELECT * FROM @work_to_do) BEGIN PRINT 'Estimated number of pages in fragmented indexes: ' + cast(@numpages as nvarchar(20)) SELECT @numpages = @numpages - sum(ps.used_page_count) FROM @work_to_do AS fi INNER JOIN sys.indexes AS i ON fi.objectid = i.object_id and fi.indexid = i.index_id INNER JOIN sys.dm_db_partition_stats AS ps on i.object_id = ps.object_id and i.index_id = ps.index_id PRINT 'Estimated number of pages freed: ' + cast(@numpages as nvarchar(20)) END GO --Update all statistics PRINT 'Updating all statistics.' + convert(nvarchar, getdate(), 121) EXEC sp_updatestats PRINT 'Done updating statistics.' + convert(nvarchar, getdate(), 121) GO</span></span></code> </pre><br></div></div><br><h4><a name="4"></a>  TempDB Setup </h4><br>  Microsoft <a href="https://support.microsoft.com/ru-ru/help/2154845/recommendations-to-reduce-allocation-contention-in-sql-server-tempdb-database">recommends</a> : <br><blockquote>  If the number of data processors is less than or equal to 8, it is  If the number of the processors is greater than 8, it can be used as the number of logical processors. changes to the workload / code. </blockquote><br><img src="https://habrastorage.org/web/2dd/b3e/b29/2ddb3eb29a1c4c27838910d5a5195130.png"><br><br>  This recommendation should not be ignored.  I stop at four files.  The initial file size should be the same.  After that, expectations usually disappear. <br><br>  Thanks for attention.  You know some more chips - share! </div><p>Source: <a href="https://habr.com/ru/post/329440/">https://habr.com/ru/post/329440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329430/index.html">Business: how to understand that it‚Äôs time to tie it up</a></li>
<li><a href="../329432/index.html">We make previews of WebRTC video stream in PNG images</a></li>
<li><a href="../329434/index.html">Wannacry - X-team, at the exit</a></li>
<li><a href="../329436/index.html">How IT professionals work. Savva Mikhalevsky, front-end architect Grabr</a></li>
<li><a href="../329438/index.html">Check Point Security CheckUP - R80.10. Part 2</a></li>
<li><a href="../329444/index.html">How does Roketbank know your name</a></li>
<li><a href="../329446/index.html">Execution Threads and PHP</a></li>
<li><a href="../329448/index.html">Reverse engineering game Lost Vikings</a></li>
<li><a href="../329450/index.html">IT digest of events of the end of May-June</a></li>
<li><a href="../329452/index.html">Vue.js for doubters. All you need to know</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>