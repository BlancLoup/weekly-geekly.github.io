<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A tale about how a good young man fought a three-headed snake, or How to embed SVG graphics in Adobe InDesign documents - part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continued here this post , authored by viklequick . 

 Step Five, or Apply the Drunken Master at Work Style 
 Now, since we already have primitives, l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A tale about how a good young man fought a three-headed snake, or How to embed SVG graphics in Adobe InDesign documents - part two</h1><div class="post__text post__text-html js-mediator-article">  Continued <a href="http://habrahabr.ru/blogs/svg/122746/">here this post</a> , authored by <a href="http://habrahabr.ru/users/viklequick/" class="user_link">viklequick</a> . <br><br>  <b>Step Five, or Apply the Drunken Master at Work Style</b> <br>  Now, since we already have primitives, let's apply colors, alpha channel and line styles. <br><br><a name="habracut"></a><pre>  private void applyStroke (Shape shape) {
   Stroke stroke = getStroke ();
   Transform t = getTransform ();
   if (stroke! = null) {
     if (stroke instanceof BasicStroke) {
       BasicStroke currStroke = (BasicStroke) stroke;
       float [] ff = currStroke.getDashArray ();
       if (ff! = null) setdash (ff.length, ff, currStroke.getDashPhase ());
       float width = (float) (currStroke.getLineWidth () * Math.max (t.getScaleX (), t.getScaleY ()));
       if (width &lt;0.7f) width = 0.7f;
       setlinewidth (width);
     }
     else {
       setlinewidth (1.0f);
       Shape strokedShape = stroke.createStrokedShape (shape);
       fill (strokedShape);
     }
   }
   else 
     setlinewidth (1.0f);
 }
</pre>  Go <br><img src="https://habrastorage.org/getpro/habr/post_images/c9c/393/2cc/c9c3932cc2d59e48e49793f364c817d7.png" alt="image">  The code in general does not contain anything complicated, just a parsing of BasicStroke.  If it is something else, then it can be represented in the form of a Shape and can be drawn like this. <br>  Next, we get the alpha channel level for subsequent shapes, and pass it to InDesign - the code is also quite simple. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre>  private void applyAlpha () {
   float alpha = 1.0f;
   Composite comp = getComposite ();
   if (comp! = null &amp;&amp; comp instanceof AlphaComposite) {
     AlphaComposite alcomp = (AlphaComposite) comp;
     alpha = alcomp.getAlpha ();
   }
   setopacity (alpha, true);
 } </pre>  Go <br>  But with custom paints and composites the situation is much sadder.  You have to rasterize them yourself. <br><br><pre>  private boolean applyStyles (Shape shape) {
   Paint paint = getPaint ();
   if (paint instanceof Color) {
     Color cc = (Color) paint;
     setrgbcolor (cc.getRed () / 255.0f, cc.getGreen () / 255.0f, cc.getBlue () / 255.0f);
     if (cc.getAlpha ()! = 0 &amp;&amp; cc.getAlpha ()! = 255) setopacity (cc.getAlpha () / 255.0f, true);
     else applyAlpha ();
   }
   else if (paint! = null &amp;&amp; shape! = null) {
     applyAlpha ();
     drawGradientAsBackground (shape, paint);
     return false;
   }

   Composite comp = getComposite ();
   if (comp! = null &amp;&amp;! (comp instanceof AlphaComposite) &amp;&amp; shape! = null) {
     drawCustomComposite (shape, comp);
     return false;
   }
   return true;
 } </pre>  Go <br>  The situation with color is fairly obvious (unless the color can be clearly defined alpha channel), but everything else requires explanation.  Note that the function returns true / false.  True means that no tricks have been applied, and the current shape must be drawn through fill ().  But false means that shape is already rasterized as a picture and you don‚Äôt need to draw it over the picture. <br>  The gradient itself had to be drawn like this: <br><br><pre>  private void drawGradientAsBackground (Shape shape, Paint paint) {
   GraphicsConfiguration conf = getDeviceConfiguration ();
   PaintContext pctx = paint.createContext (
     conf.getColorModel (), conf.getBounds (), shape.getBounds2D (),
     getTransform (), getRenderingHints ());

   Rectangle r = getTransform (). CreateTransformedShape (shape) .getBounds ();
   Raster raster = pctx.getRaster (rx, ry, r.width, r.height);
   ColorModel cmodel = pctx.getColorModel ();
   BufferedImage bfi = new BufferedImage (cmodel, raster.createCompatibleWritableRaster (),
     cmodel.isAlphaPremultiplied (), null);
   bfi.setData (raster);
  
   int [] argbBuf = getBuf (bfi, r.width, r.height);
   if (argbBuf! = null) {
     applyClip (shape);
     drawImage (argbBuf, rx, ry, r.width, r.height, new AffineTransform ());
     restoreClip ();
   }
   pctx.dispose ();
 } </pre>  Go <br>  In this function, the gradient is drawn on an offscreen image, and the image clipping is the shape itself.  Similarly, we draw and non-standard Composite: <br><br><pre>  private void drawCustomComposite (Shape shape, Composite comp) {
   Rectangle r = getTransform (). CreateTransformedShape (shape) .getBounds ();
   BufferedImage bfi = new BufferedImage (r.width, r.height, BufferedImage.TYPE_INT_ARGB);
   Graphics2D g2 = (Graphics2D) bfi.getGraphics ();
   g2.setTransform (getTransform ());
   g2.setComposite (comp);
   g2.fill (shape);
   g2.dispose ();
  
   int [] argbBuf = getBuf (bfi, r.width, r.height);
   if (argbBuf! = null) {
     applyClip (shape);
     drawImage (argbBuf, rx, ry, r.width, r.height, new AffineTransform ());
     restoreClip ();
   }
 } </pre>  Go <br>  Since we draw an already transformed shape, we set an empty AffineTransform in drawImage. <br><br>  <b>Step Six, or achieve the foe</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/f2e/068/046/f2e068046b52b26b5e1b820bf50e4ea9.png" alt="image">  Finally we got to the most interesting.  If for other cases the native implementation is essentially a single-line code, in the case of pictures this is not the case.  First, here‚Äôs the code for drawing the image: <br><br><pre>  public boolean drawImage (Image img, int x, int y, int width, int height, Color bgcolor, ImageObserver observer) {
   int [] argbBuf = getBuf (img, width, height);
   if (argbBuf == null) return false;
    
   applyClip (getClip ());
   applyAlpha ();
   drawImage (argbBuf, x, y, width, height, getTransform ());
   restoreClip ();
   return true;
 } </pre>  Go <br>  The code is very simple - sets the clipping, alpha channel, gets the bit matrix - and passes it all to InDesign.  Obtaining bits is obvious: <br><br><pre>  private int [] getBuf (Image img, int width, int height) {
   int [] argbBuf = new int [width * height];
   PixelGrabber pg = new PixelGrabber (img, 0, 0, width, height, argbBuf, 0, width);
   try {
     if (! pg.grabPixels ()) return null;
   }
   catch (InterruptedException e) {return null;  }
   if ((pg.getStatus () &amp; ImageObserver.ABORT)! = 0) return null;
   return argbBuf;
 } </pre>  Go <br>  But the transfer to InDesign has some features.  Consider them. <br><br><pre>  private void drawImage (int [] argbBuf, int x, int y, int width, int height, AffineTransform transform) {
   double [] transMatr = new double [6];
   transform.getMatrix (transMatr);
   this.image (argbBuf, x, y, width, height, transMatr);
 } </pre>  Go <br>  It is easy to notice, this is the only function that transforms the transformation matrix to InDesign, and does not work out on its own.  It would be possible to go a different way, and always transfer the transformation matrix to Indesign, and not work with transformed shapes.  But, to my regret, the inability to draw gradients by means of Indizayn led to this decision. <br>  Now back to C ++ and consider the nuances of the plugin.  There is a lot of code here, so I will cite only the most interesting excerpts, removing trivialities and error handling. <br>  The beginning is obvious: <br><br><pre>  JNIEXPORT void JNICALL Java _..._ image
   (JNIEnv * env, jobject obj, 
   jintArray imageARGBBuff, jint x, jint y, jint width, jint height,
   jdoubleArray transformMatrix) {

   K2 :: scoped_array &lt;uint8&gt; maskBuffer (new uint8 [imageARGBBuff.length]);
   K2 :: scoped_array &lt;uint8&gt; pictBuffer (new uint8 [3 * imageARGBBuff.length]);
</pre>  Go <br>  // fill buffers in our ARGB <br><br>  But then begin dancing with a tambourine. <br>  The thing is - if we have blending color space = RGB, then Indizayn wants a picture in CMYK.  Otherwise, it falls down once, causing a terrible spiritual wound to the bogatyr, so much so that this bogatyr cannot even eat.  And vice versa - if blending color space = CMYK, then the picture must be in RGB.  It was found by experience, and why everything happens that way - I find it difficult to explain.  Therefore, we need to find out what color space we have now set: <br><br><pre>  Utils &lt;IXPUtils&gt; xpUtils;
 InterfacePtr &lt;IXPManager&gt; xpManager (xpUtils-&gt; QueryXPManager (db));
 InterfacePtr &lt;IDocument&gt; doc (db, db-&gt; GetRootUID (), UseDefaultIID ());
 AGMColorSpace * blendingSpace = xpManager-&gt; GetDocumentBlendingSpace ();
</pre>  Go <br>  and convert if necessary: <br><br><pre>  uint8 * outBuff = nil;
 int16 compCnt = 3, space = kRGBColorSpace;

 if (IsBeingFlattened (env, obj)) {
   TransformRGB2CMYKifNeeded (doc, blendingSpace, pictBuffer.get (), &amp; outBuff, imageARGBBuff.length);
   compCnt = 4;  space = kCMYKColorSpace;
   pictBuffer.reset (outBuff);
 } 
</pre>  Go <br>  Now we are ready to set both the image and the alpha mask to it: <br><br><pre>  AGMImageRecord imgR;
 memset (&amp; imgR, 0, sizeof (AGMImageRecord));

 imgR.bounds.xMin = x;
 imgR.bounds.yMin = y;
 imgR.bounds.xMax = x + width;
 imgR.bounds.yMax = y + height;
 imgR.byteWidth = compCnt * width;
 imgR.colorSpace = space;
 imgR.bitsPerPixel = compCnt * 8;
 imgR.baseAddr = (void *) pictBuffer.get ();

 AGMImageRecord maskR;
 memset (&amp; maskR, 0, sizeof (AGMImageRecord));
 maskR.bounds.xMin = x;
 maskR.bounds.yMin = y;
 maskR.bounds.xMax = x + width;
 maskR.bounds.yMax = y + height;
 maskR.byteWidth = width;
 maskR.colorSpace = kGrayColorSpace;
 maskR.bitsPerPixel = 8;
 maskR.baseAddr = (void *) maskBuffer.get ();
</pre>  Go <br>  It remains only to overtake the transformation matrix from the Java format to the InDesign format: <br><br><pre>  PMMatrix transform (nativeTransformData [0], nativeTransformData [1],
 nativeTransformData [2],
    	 nativeTransformData [3], 
 nativeTransformData [4], 
 nativeTransformData [5]); 
</pre>  Go <br>  The final touch is to bring knowledge of the alpha channel mask to Indizayn: <br><br><pre>  AGMPaint * alphaServer = xpUt-&gt; CreateImagePaintServer (&amp; maskR, &amp; transform, 0, nil);
 PMRect bounds (x, y, width + x, height + y); </pre><br><br><pre>  port-&gt; SetAlphaServer (alphaServer, kTrue, stub); </pre><br><br><pre>  port-&gt; starttransparencygroup (bounds, blendingSpace, kFalse, kFalse); </pre><br>  And you can finally draw a picture.  We did it! <br><br><pre>  port-&gt; image (&amp; imgR, transform, drawFlags); 
</pre>  Go <br>  The code for cleaning alpha servers and other things I don‚Äôt cite, as it is trivial. <br><br>  <b>Part last, or We take out the treasures of the defeated monster</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/a9b/191/2df/a9b1912df306aca9d8fe92f8d218bbbf.jpg" alt="image">  In this way, it was still possible for the good fellow to overcome the three-headed snake, and for the author to <s>cross a hedgehog with a snake to</s> draw one of the most poorly documented types of plug-ins in the Adobe InDesign SDK.  Unfortunately, there was still room for improvement, for example, the same gradients, but the final result was quite satisfactory. <br>  Here and the fairy tale is over, and who listened - well done! </div><p>Source: <a href="https://habr.com/ru/post/127574/">https://habr.com/ru/post/127574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127564/index.html">IBM bought Algorithmics</a></li>
<li><a href="../127566/index.html">Interception of user accounts in Wi-Fi networks with Android</a></li>
<li><a href="../127567/index.html">Programming in the cloud: A small overview of the online IDE</a></li>
<li><a href="../127568/index.html">Qt 4.7.4 release</a></li>
<li><a href="../127569/index.html">Instant search in 75 gigabytes</a></li>
<li><a href="../127575/index.html">Bicycle liquidator: reusable code</a></li>
<li><a href="../127576/index.html">Intel Capital provided security system developer investments for smart devices</a></li>
<li><a href="../127579/index.html">Orchard CMS extension: packaging and publishing modules</a></li>
<li><a href="../127581/index.html">A look at Lenovo's Honeycomb tablets at IFA 2011</a></li>
<li><a href="../127582/index.html">AviSynth + VirtualDub: Extract Audio from the Command Line</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>