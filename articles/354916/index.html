<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience using Mikrotik CHR for organizing virtual routing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article gives the result of solving the problem of organizing routing between virtual machines on VMware using MikroTik CHR, and with accessing vi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience using Mikrotik CHR for organizing virtual routing</h1><div class="post__text post__text-html js-mediator-article"><p>  The article gives the result of solving the problem of organizing routing between virtual machines on VMware using MikroTik CHR, and with accessing via VPN to virtual machines from an external network. </p><a name="habracut"></a><br><h2>  Introduction </h2><br><p>  Define the original task: </p><br><ol><li>  Available server with a memory capacity of 96 GB, 24 CPU and 22 TB of disk space </li><li>  2 lines are connected to the server: </li></ol><br><ul><li>  one is for managing and managing VMware; </li><li>  from the second come two VLANs - one for access to the organization‚Äôs internal network and with Internet access, from the second come real addresses. </li></ul><br><ol><li><p>  In order to no longer use the address space of the organization, it is necessary within the server for a resource of 3 virtual machines to define its own address space and close the resource to access other resources from 3 machines. </p><br></li><li><p>  You need to block traffic from virtual machines that are not going to the proxy organization. </p><br></li><li><p>  Each resource of the three virtual machines is designed for one person, he also needs to provide access to work from home. </p><br></li><li><p>  VMware ESXi 6 is installed on the server. MikroTik CHR 6.42 will be used for routing. </p><br></li></ol><br><h2>  VMware setup </h2><br><p>  As already defined, two VLANs come to the server, one will serve to access virtual machines to the organization's network and access to the Internet through the organization's proxy, the second is necessary for having a real address and access to virtual machines from outside. </p><br><p>  Using VMware on the virtual switch, we will create separate interfaces: </p><br><p><img src="https://habrastorage.org/webt/tl/k6/yn/tlk6ynjjbyx-r8jm0y2cp0qmaak.png"></p><br><p>  Each created interface is tied to a virtual machine with MikroTik CHR and to 3 virtual machines from the pool.  For example, for machines with ID Student # 8, a virtual interface is assigned to VM Vlan 25. </p><br><p>  As a result, we get the following setting for a virtual machine with MikroTik CHR: </p><br><p><img src="https://habrastorage.org/webt/on/rz/np/onrznp37rm9usjkd3piy7pfrrse.png"></p><br><p>  As you can see the interface <strong>Class8-509</strong> for access to the internal network and <strong>Real_Outside</strong> for the real address. </p><br><h2>  Setting MikroTik CHR </h2><br><p>  Initially, we will define clear interface names and give comments for understanding which interface is intended for which pool of virtual machines. </p><br><div class="spoiler">  <b class="spoiler_title">Part of the interface configuration</b> <div class="spoiler_text"><pre><code class="hljs pgsql">/interface ethernet <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [ find <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=ether1 ] <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="VLAN ID 111 Uplink to Company" <span class="hljs-type"><span class="hljs-type">name</span></span>=\ Class8_509_VM <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [ find <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=ether4 ] <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Interface VM Vlan 12 for Student #1" \ <span class="hljs-type"><span class="hljs-type">name</span></span>=Int_VM_Vlan12 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [ find <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=ether6 ] <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Interface VM Vlan 14 for Student #3" \ <span class="hljs-type"><span class="hljs-type">name</span></span>=Int_VM_Vlan14 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [ find <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=ether7 ] <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Interface VM Vlan 15 for Student #4" \ <span class="hljs-type"><span class="hljs-type">name</span></span>=Int_VM_Vlan15 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [ find <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=ether8 ] <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Interface VM Vlan 16 for Student #5" \ <span class="hljs-type"><span class="hljs-type">name</span></span>=Int_VM_Vlan16 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [ find <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=ether2 ] <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Interface Vlan 1111 Real_Outside" \ <span class="hljs-type"><span class="hljs-type">name</span></span>=Real_Outside</code> </pre> </div></div><br><p>  Assign an IP address to each interface, including an interface that will have a real address. </p><br><div class="spoiler">  <b class="spoiler_title">Interface IP addresses</b> <div class="spoiler_text"><pre> <code class="hljs cs">/ip address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=*.*.*.*/<span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Class8_509_VM network=*.*.*.* <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Int_VM_Vlan11 network=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Int_VM_Vlan12 network=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Int_VM_Vlan13 network=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=*.*.*.*/<span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Real_Outside network=*.*.*.*</code> </pre> </div></div><br><p>  <em>Define a set of networks.</em>  In each pool of machines on one virtual machine, Windows Server 2012 is installed on which AD and DNS are configured, so for each network the IP address of this virtual machine will act as a DNS. </p><br><div class="spoiler">  <b class="spoiler_title">Network</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">/ip dhcp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> network <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span> dns-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span> dns-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span> dns-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> gateway=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre> </div></div><br><p>  For each interface, we will define an address pool that will issue a DHCP server and activate <strong>Add ARP For Leases</strong> .  Thereby preventing the manual assignment of IP addresses for the virtual machine. </p><br><blockquote>  Add ARP For Leases - Creates a MAC - IP mapping for clients that have been leased from DHCP in the ARP table and allows you to organize MAC filtering on a microtic in conjunction with IP / ARP. </blockquote><p>  Since it is necessary to provide access to virtual machines from the Internet, we will immediately prepare an address pool for clients when they connect via L2TP / IPsec. </p><br><div class="spoiler">  <b class="spoiler_title">DHCP server</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">/ip pool <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=dhcp_pool_for_vm_vlan11 ranges=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=dhcp_pool_for_vm_vlan12 ranges=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=dhcp_pool_for_vm_vlan13 ranges=<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> #   l2tp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=student1_l2tp_pool ranges=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-10.1</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=student2_l2tp_pool ranges=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-10.1</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=student3_l2tp_pool ranges=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-10.1</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> /ip dhcp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-arp=yes address-pool=dhcp_pool_for_vm_vlan11 disabled=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> interface=\ Int_VM_Vlan11 lease-<span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>h <span class="hljs-type"><span class="hljs-type">name</span></span>=dhcp_for_vm_vlan11 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-arp=yes address-pool=dhcp_pool_for_vm_vlan12 disabled=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> interface=\ Int_VM_Vlan12 lease-<span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>h <span class="hljs-type"><span class="hljs-type">name</span></span>=dhcp_for_vm_vlan12 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-arp=yes address-pool=dhcp_pool_for_vm_vlan13 disabled=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> interface=\ Int_VM_Vlan13 lease-<span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>h <span class="hljs-type"><span class="hljs-type">name</span></span>=dhcp_for_vm_vlan13</code> </pre> </div></div><br><p>  In new versions of RouterOS, it is possible to create lists, so we will combine all local interfaces into one list to facilitate firewall settings. </p><br><div class="spoiler">  <b class="spoiler_title">Interface List</b> <div class="spoiler_text"><pre> <code class="hljs cs">/<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">list</span></span> <span class="hljs-title"><span class="hljs-title">member</span></span> <span class="hljs-title"><span class="hljs-title">add</span></span> <span class="hljs-title"><span class="hljs-title">interface</span></span>=Int_VM_Vlan11 list=local_vm <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Int_VM_Vlan12 list=local_vm <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Int_VM_Vlan13 list=local_vm</code> </pre> </div></div><br><p>  Define a list of proxy IP addresses and specify in the firewall rules that traffic from all local interfaces, if it does not go to the proxy addresses, will be blocked.  Immediately specify the rule to prohibit ICMP and block traffic between local interfaces. </p><br><div class="spoiler">  <b class="spoiler_title">Firewall rules</b> <div class="spoiler_text"><pre> <code class="hljs sql">/ip firewall address-list add address=192.168.3.3 list=Proxy add address=192.168.3.1 list=Proxy add address=192.168.3.5 list=Proxy add address=192.168.3.7 list=Proxy /ip firewall filter add action=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=forward <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Block If Not Proxy Address"</span></span> \ dst-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=!Proxy <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=local_vm <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Block ping"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=local_vm protocol=icmp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=forward <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Block ping between interface"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=local_vm <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=local_vm</code> </pre> </div></div><br><p>  We will also define NAT, in which all traffic from local addresses will go through the interface that looks to the organization‚Äôs network. </p><br><h3>  Configuring MikroTik CHR: L2TP / IPsec </h3><br><p>  To organize access from the external network, we activate the L2TP server and create for each user their own credentials and their own interface.  Each user will be able to create only one connection at a time.  Since some users use Windows 10, in the security settings we additionally activate the 3DES encryption algorithm. <br>  In the firewall settings, we point out that each user can only access his network (to a specific local interface) on certain ports (RPD and SSH) and block all other traffic.  Additionally allow access for l2tp from the interface that has a real address. <br>  To ease the workload on the organization‚Äôs network, we will make a speed limit for each user. <br>  As a result, we obtain the following settings, I will give some of the settings for one user. </p><br><div class="spoiler">  <b class="spoiler_title">L2TP</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">/interface l2tp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Interface L2TP for Student#1" <span class="hljs-type"><span class="hljs-type">name</span></span>=int_l2tp_student1 <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=student1 /ppp profile <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> change-tcp-mss=yes <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Student1 Profile for L2TP, Rate Limits 3M/3M" \ <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=student1_l2tp_profile <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>-one=yes rate-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=\ <span class="hljs-number"><span class="hljs-number">3</span></span>M/<span class="hljs-number"><span class="hljs-number">3</span></span>M remote-address=student1_l2tp_pool use-compression=yes use-encryption=\ required use-upnp=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip firewall <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=accept chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=Real_Outside port=<span class="hljs-number"><span class="hljs-number">1701</span></span>,<span class="hljs-number"><span class="hljs-number">500</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span> \ protocol=udp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=accept chain=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=Real_Outside protocol=ipsec-esp #  l2tp      <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=accept chain=forward <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Student #1 L2TP to Vlan 12" \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=int_l2tp_student1 <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-interface=Int_VM_Vlan12 port=<span class="hljs-number"><span class="hljs-number">3389</span></span>,<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=accept chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=Int_VM_Vlan12 <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-interface=\ int_l2tp_student1 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=int_l2tp_student1 /ppp secret <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>="Student1 Auth Data" <span class="hljs-type"><span class="hljs-type">name</span></span>=student1 <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=******** profile= student1_l2tp_profile service=l2tp</code> </pre></div></div><br><p>  In addition to setting up the connection on the client‚Äôs home machine, the client additionally registers the route to the network allowed to him, however, thanks to the firewall rules, if the client specified a route not to his network, he cannot access the virtual machines of the specified network. </p><br><h3>  Traffic marking </h3><br><p>  Since we have two Internet connections, we need to send the incoming traffic correctly through the correct interface.  Therefore, we use the capabilities of Mikrotik in traffic marking. </p><br><div class="spoiler">  <b class="spoiler_title">Traffic marking</b> <div class="spoiler_text"><pre> <code class="hljs sql">/ip firewall mangle add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Mangle Real_Outside traffic"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Real_Outside <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=realOutMark passthrough=yes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=mark-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Mangle Class8_509_VM Traffic"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>=Class8_509_VM <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=classVmMark passthrough=yes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=mark-routing <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Rout out Real_Outside"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=realOutMark <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-routing-mark=routReakOut passthrough=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=mark-routing <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"Rout out Class8-509 VM"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-mark=classVmMark <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-routing-mark=routClass8<span class="hljs-number"><span class="hljs-number">-509</span></span>VM passthrough=\ <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">195.69</span></span><span class="hljs-number"><span class="hljs-number">.204</span></span><span class="hljs-number"><span class="hljs-number">.161</span></span> routing-mark=routReakOut <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.145</span></span><span class="hljs-number"><span class="hljs-number">.30</span></span> routing-mark=routClass8<span class="hljs-number"><span class="hljs-number">-509</span></span>VM <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping distance=<span class="hljs-number"><span class="hljs-number">1</span></span> gateway=Class8_509_VM</code> </pre> </div></div><br><h3>  SSH block list </h3><br><p>  Since our MikroTik has a real address, there are attempts to find a password from the Internet using the SSH protocol, therefore we will add a number of rules to the firewall to block such IP addresses. </p><br><div class="spoiler">  <b class="spoiler_title">Ssh block</b> <div class="spoiler_text"><pre> <code class="hljs sql">add action=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"drop ssh brute forcers"</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp src-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=ssh_blacklist <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-src-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=ssh_blacklist \ address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-number"><span class="hljs-number">14</span></span>w2d <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-state=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-src-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=ssh_stage3 \ address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-number"><span class="hljs-number">10</span></span>m <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-state=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-src-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=ssh_stage2 \ address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-number"><span class="hljs-number">10</span></span>m <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-state=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-src-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=ssh_stage1 \ address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-number"><span class="hljs-number">10</span></span>m <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-state=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=forward <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"drop ssh brute downstream"</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span> \ protocol=tcp</code> </pre> </div></div><br><p>  At the time this article was created, there were about 400 addresses in the block lists. </p><br><h2>  Total </h2><br><p>  As a result, we get a configured virtual mikrotik, which performs traffic routing, provides connectivity from the Internet via l2tp / ipsec and has firewall settings for distinguishing users and interfaces. </p><br><h3>  UPD </h3><br><p>  Thank you <a href="https://habr.com/users/gecube/" class="user_link">gecube</a> .  For MikroTik CHR, you must purchase a license, otherwise each interface is limited to 1 Mbps, or you can activate a trial for 60 days with full functionality.  <a href="https://wiki.mikrotik.com/wiki/Manual:CHR">Cost and grading of licenses.</a>  .  Unlimited license is limited only by the speed of your interfaces. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354916/">https://habr.com/ru/post/354916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354902/index.html">As I wrote a graphic bot and what it turned into</a></li>
<li><a href="../354906/index.html">Distribution of programs on Go. Part 1</a></li>
<li><a href="../354910/index.html">By the Day of Radio. Oh connection, you are the world</a></li>
<li><a href="../354912/index.html">PyTorch Tour</a></li>
<li><a href="../354914/index.html">Setting security for applications on the SAP Cloud Platform cloud platform</a></li>
<li><a href="../354930/index.html">BigInt - long arithmetic in javascript</a></li>
<li><a href="../354934/index.html">Plausible reconstruction of Instagram-like filters</a></li>
<li><a href="../354936/index.html">(Akin's laws) laws of space engineering</a></li>
<li><a href="../354938/index.html">Loud sound of the fire extinguishing system knocked out the drives in the Nasdaq data center</a></li>
<li><a href="../354940/index.html">Extreme Performance Virtual Server (VPS / VDS)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>