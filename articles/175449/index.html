<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to tie a BitTorrent tracker to a Python site: integration with XBT Tracker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose you have a certain site written in Python and you want to attach a BitTorrent tracker to it, like rutracker.org. 

 Task separation 
 The task...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to tie a BitTorrent tracker to a Python site: integration with XBT Tracker</h1><div class="post__text post__text-html js-mediator-article">  Suppose you have a certain site written in Python and you want to attach a BitTorrent tracker to it, like rutracker.org. <br><br><h4>  Task separation </h4><br>  The task can be divided into two big functionalities: <br><ol><li>  The directory of torrent distributions on the site (historically usually implemented as a forum), </li><li>  Tracker itself, directly involved in the process of distribution. </li></ol><br>  <a href="http://ru.wikipedia.org/wiki/BitTorrent-%25D1%2582%25D1%2580%25D0%25B5%25D0%25BA%25D0%25B5%25D1%2580">The tracker</a> is an http-application, according <a href="http://wiki.theory.org/BitTorrentSpecification">to</a> the BitTorrent protocol <a href="http://wiki.theory.org/BitTorrentSpecification">specification</a> , informing the client about all the distribution participants on request.  Since clients send requests constantly periodically, the Tracker should be productive: the response time should be minimal. <br><br>  In the PHP world, the Directory and Tracker are often not divided into two dedicated applications.  For example, the popular <a href="http://bit-torrent.kiev.ua/">TBDev Tracker</a> exists as an application combining Directory-Forum and Tracker.  (The author seems so tired of the popularity of his application that the site has not been updated for a long time and it‚Äôs impossible to download an application from it. However, many clones can be found on the Web.) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some tracker implementations were originally written in Python, but then rewritten in C ++ for performance reasons.  So nowadays there are no Python trackers (at least I could not find it).  Therefore, the only thing that remains is to install a separate Tracker application and integrate it with the Python-Directory. <br><br><a name="habracut"></a><h4>  Control and protection </h4><br>  If you do not need any control, that is: <br><ul><li>  You do not care what distributions your tracker will support - an anonymous user can add his distribution to your Tracker, </li><li>  and you consider in the order of things that an anonymous user can access any existing distribution, </li></ul><br>  then you just need to install one of the <a href="http://en.wikipedia.org/wiki/BitTorrent_tracker_software">programs</a> , choosing the easiest and most productive among them. <br>  Further, you simply enable your users to create directory entries and upload and download .torrent files created by themselves.  Preliminarily informing them of the correct announce-address of your tracker, which they will record in the .torrent file when creating the distribution. <br><br>  If you want to establish at least some control, and even more so, as in my case, you want to limit the access of some user groups to some distributions, then for this you will need a so-called <a href="http://ru.wikipedia.org/wiki/BitTorrent-%25D1%2582%25D1%2580%25D0%25B5%25D0%25BA%25D0%25B5%25D1%2580">‚Äúprivate tracker‚Äù</a> . <br><br>  In theory, this is done as follows: <br><ul><li>  Prevention of adding anonymous distributions: the tracker should support only those distributions that your authorized users have added to the directory.  When creating a Directory entry and attaching a .torrent file to it, the code of your site should add a distribution to the list of allowed distributions for the tracker. </li><li>  Preventing an .torrent file from being received by an anonymous user is implemented by means of the Directory </li><li>  Restriction of user access to distribution (as well as tracking users participating in the distribution) is performed according to the principle: if someone can see the directory entry and download the attached .torrent file, then participation in the distribution is allowed.  In this case, the tracker must identify the user.  And this is done by flashing the unique user code in the announce tracker URL - on the fly, when the user downloads a .torrent file.  That is, the Directory code must do this. </li><li>  Prohibition of broadcast sharing protocols: Distribute Hash Table (DHT), Peer EXchange (PEX), Local Service Discovery (LSD), which allow you to work without Tracker at all, and therefore without access control.  Implemented by setting the <a href="http://www.bittorrent.org/beps/bep_0027.html">flag ‚Äúprivate = 1‚Äù</a> in the .torrent file. </li></ul><br><h4>  Implementation </h4><br>  Considering the above, my choice fell on <a href="http://xbtt.sourceforge.net/tracker/">XBT Tracker</a> , as the only implementation of a private Tracker designed for integration with any Directory site. <br>  XBT Tracker is written in C ++ and is installed by building from source.  On Ubuntu Server 12.04, 64-bit is built the first time. <br><br><h5>  Dependencies </h5><br>  Interacting with XBT Tracker is supposed through the MySQL database Tracker, so our Python-Directory will need to be able to write-read the MySQL database.  For this, I used the <code>pymysql</code> package. <br>  To parse and modify .torrent files, you also need the <code>BitTorrent-bencode</code> package. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bencode, pymysql</code> </pre><br><h5>  Functions </h5><br>  Adding an authorized user, if there is no such yet.  Here, the <code>torrent_pass</code> field of the <code>torrent_pass</code> table <code>xbt_users</code> used to bundle your site's user ID and XBT Tracker user ID.  Previously, torrent_pass was used to authorize a user by the key specified in the announce URL, but now XBT Tracker uses a different algorithm - see below.  The <code>uid</code> field is auto-increment. <br><pre> <code class="python hljs"> c = db.cursor() c.execute(<span class="hljs-string"><span class="hljs-string">"SELECT uid, torrent_pass, torrent_pass_version, downloaded, uploaded FROM xbt_users WHERE torrent_pass = %s"</span></span>, (request.user.id,)) rec = c.fetchone() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> rec: <span class="hljs-comment"><span class="hljs-comment"># insert a new user c.execute("INSERT INTO xbt_users(torrent_pass) VALUES(%s)", (request.user.id)) c.execute("SELECT uid, torrent_pass, torrent_pass_version, downloaded, uploaded FROM xbt_users WHERE torrent_pass = %s", (request.user.id,)) #rowcount =0 rec = c.fetchone() db.commit() uid, torrent_pass, torrent_pass_version, downloaded, uploaded = rec</span></span></code> </pre><br>  Reading and parsing a .torrent file: <br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(fpath, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: buf = f.read() bt = bencode.bdecode(buf)</code> </pre><br>  Forcibly set a private flag and calculate info_hash (private flag is included in the info section and affects its hash): <br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> xbt_force_private: bt[<span class="hljs-string"><span class="hljs-string">'info'</span></span>][<span class="hljs-string"><span class="hljs-string">'private'</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span> info_hash_obj = hashlib.sha1(bencode.bencode(bt[<span class="hljs-string"><span class="hljs-string">'info'</span></span>]))</code> </pre><br>  Registration of distribution in the <code>xbt_files</code> table if not already present. <br><pre> <code class="python hljs"> sha = info_hash_obj.hexdigest() c = db.cursor() c.execute(<span class="hljs-string"><span class="hljs-string">"SELECT flags FROM xbt_files WHERE info_hash=UNHEX(%s)"</span></span>, (sha,)) flag = c.fetchone() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: c.execute(<span class="hljs-string"><span class="hljs-string">"INSERT INTO xbt_files(info_hash, mtime, ctime) VALUES(UNHEX(%s), UNIX_TIMESTAMP(), UNIX_TIMESTAMP())"</span></span>, (sha,)) db.commit() <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> flag[<span class="hljs-number"><span class="hljs-number">0</span></span>] % <span class="hljs-number"><span class="hljs-number">2</span></span> : error_msg(pagename, request, _(<span class="hljs-string"><span class="hljs-string">"Torrent is marked for deletion!"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre><br><h6>  Calculate authorization key for announce URL </h6><br>  XBT Tracker uses a very clever key calculation algorithm.  A set of values ‚Äã‚Äãis taken: <br><ul><li>  User ID: <code>xbt_users.uid</code> , </li><li>  user key version: <code>xbt_users.torrent_pass_version</code> , </li><li>  server's secret key (generated automatically when XBT Tracker is first <code>xbt_config</code> ): <code>xbt_config</code> table, <code>xbt_config</code> value, </li><li>  The value of the info_hash of this distribution: <code>xbt_files.info_hash</code> . </li></ul><br>  All this is magically mixed by the principle ‚ÄúI twist-twist, I want to confuse‚Äù: <br><pre> <code class="python hljs"> c.execute(<span class="hljs-string"><span class="hljs-string">"select value from xbt_config where name = 'torrent_pass_private_key'"</span></span>) torrent_pass_private_key = c.fetchone()[<span class="hljs-number"><span class="hljs-number">0</span></span>] s = <span class="hljs-string"><span class="hljs-string">"%s %d %d %s"</span></span> % (torrent_pass_private_key, torrent_pass_version, uid, info_hash_obj.digest()) sha = hashlib.sha1(s).hexdigest()[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>] pwd = <span class="hljs-string"><span class="hljs-string">"%08x%s"</span></span> % (uid, sha) bt[<span class="hljs-string"><span class="hljs-string">'announce'</span></span>] = <span class="hljs-string"><span class="hljs-string">'http://xbt.host:port/%s/announce'</span></span> % pwd <span class="hljs-comment"><span class="hljs-comment"># remove other trackers if bt.has_key('announce-list'): del bt['announce-list']</span></span></code> </pre><br>  From here it becomes clear the purpose of <code>xbt_users.torrent_pass_version</code> : by changing this value, you can make all previously downloaded .torrent files invalid.  That is, it is - some kind of analog password reset. <br>  And finally, we encode the .torrent file back into the string, which we will send to the client: <br><pre> <code class="python hljs"> buf = bencode.bencode(bt)</code> </pre><br><h6>  Deleting a hand </h6><br>  When deleting an attached file, we must remove the distribution from the list of registered distributions ( <code>xbt_files</code> tables). <br>  There is a polite deletion method in which we mark the distribution as deleted, but in reality it is deleted by the tracker when it is downloaded completely by the last lich. <br><pre> <code class="python hljs">c.execute(<span class="hljs-string"><span class="hljs-string">"update xbt_files set flags = 1 where info_hash = UNHEX(%s)"</span></span>, (info_hash, ))</code> </pre><br><br>  Well that's all.  Further spinning of the site: displaying the number and the list of distributors, counting the rating, displaying the list of files in the distribution, I refer to decorations.  They are implemented quite obviously: all the necessary information, including statistics, is available in the tracker database, - and I, after Pierre Fermat, feel sorry for spending space on them. <br><br>  The solution outlined is embodied as a <a href="http://moinmo.in/ActionMarket/AttachTorrent">plug-in</a> to the popular wiki engine: <a href="http://moinmo.in/">MoinMoin</a> <br><br>  It should be noted that the proposed solution has a significant drawback: virtual hosting with Python support is generally relatively rare, and I haven‚Äôt met with the opportunity to build a C ++ application in nature.  The only alternative, as I see it, is to take some TBDev Tracker clone and bite out the code that directly implements the Tracker functions. <br><br>  I hope my experience will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/175449/">https://habr.com/ru/post/175449/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175435/index.html">Punk smartphone</a></li>
<li><a href="../175437/index.html">Mobile Timeline of corporate life for the iPhone. We invite you to speak!</a></li>
<li><a href="../175439/index.html">Mail.Ru rating: visits in reports</a></li>
<li><a href="../175445/index.html">Intel provides new opportunities for game developers</a></li>
<li><a href="../175447/index.html">The largest Bitcoin exchange Mt. Gox under DDoS attack - owners suspect that attackers want to provoke panic</a></li>
<li><a href="../175451/index.html">GPS monitoring auto or homework for the evening</a></li>
<li><a href="../175453/index.html">Using design patterns in javaScript: Spawning patterns</a></li>
<li><a href="../175457/index.html">Admin in 10 minutes</a></li>
<li><a href="../175459/index.html">Data migration from MySQL to PostgreSQL</a></li>
<li><a href="../175461/index.html">How it works: CAPTCHA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>