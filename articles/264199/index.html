<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Triggers and Background Jobs in Windows Store Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Your application, even in its inactive state, can react to events generated by the system. To do this, you must register the background job using the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Triggers and Background Jobs in Windows Store Applications</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/f0a/5ea/caf/f0a5eacaf8c44f82a92748124c470f91.jpg"></div><br><br>  Your application, even in its inactive state, can react to events generated by the system.  To do this, you must register the background job using the SystemTrigger class. <br><br>  For example, you can ‚Äúcatch‚Äù the event of the appearance of the Internet, receiving SMS, changing the time zone or some other. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition to this, you can add a check for compliance of the state of the device / system with certain conditions.  In case of triggering, all specified conditions will be checked. <br><br>  In addition to system triggers, there are various other triggers that can be triggered by a timer or as a result of special events. <br><a name="habracut"></a><br>  So, I list the possible types of triggers that are used in Windows 8.1 applications: <br>  <b>SystemTrigger</b> - The most popular trigger.  Fires if a system event occurs. <br>  Triggers that do not require registration on the lock screen are: <br>  <b><i>InternetAvailable</i></b> - the background task runs when the Internet becomes available. <br>  <b><i>NetworkStateChange</i></b> - the background task is launched when the network state changes <br>  <b><i>OnlineIdConnectedStateChange</i></b> - the background task is launched when the Microsoft account connected to this account is changed <br>  <b><i>SmsReceived</i></b> - background task starts when a new SMS is received <br>  <b><i>TimeZoneChange</i></b> - background task starts when the time zone on the device changes <br>  <b><i>ServicingComplete</i></b> - background task starts when the system completes the application update <br><br>  If the application is registered on the lock screen, the following triggers are also available: <br>  <b><i>UserPresent</i></b> - the background task is started when the user returns <br>  <b><i>UserAway</i></b> - the background task runs when the user is idle <br>  <b><i>ControlChannelReset</i></b> - the background task starts when the control channel is cleared <br>  <b><i>SessionConnected</i></b> - the background task is started when the session is connected <br>  <b><i>BackgroundWorkCostChange</i></b> - the background task is activated when the assessment of the background work changes <br><br>  If you use these triggers without registering on the lock screen, then the registration line for the background job <br><br><pre><code class="cs hljs">BackgroundTaskRegistration task = bgTaskBuilder.Register();</code> </pre> <br>  will cause an access denied exception. <br><br>  In order to react to the events of the registration of the application on the lock screen, there are 2 more triggers: <br>  <b><i>LockScreenApplicationAdded</i></b> - background task starts when a tile is added to the lock screen <br>  <b><i>LockScreenApplicationRemoved</i></b> - the background task starts when the tile is removed from the lock screen <br><br>  In Windows 10, a new system trigger was introduced: <br>  <b><i>PowerStateChange</i></b> - background task starts when battery status changes <br><br>  System triggers are over, consider other available triggers. <br><br>  <b>MaintenanceTrigger</b> - The easiest and coolest trigger.  Works like a timer.  You set your own interval, which must be at least 15 minutes and, if the PC is connected to AC power, the trigger will work.  What is good is the fact that this trigger does not require registration of the application on the lock screen!  All that is required is that the PC must be plugged in. <br>  If the <i>FreshnessTime</i> interval time is set to a value less than 15 minutes, then an attempt will be thrown when attempting to register a trigger. <br><br>  <b>TimeTrigger</b> is almost the same as MaintenanceTrigger, but does not require power from the network, but it requires registration of the application on the lock screen. <br><br>  <b>PushNotificationTrigger</b> - can be used to receive raw notifications.  Requires registration of the application on the lock screen. <br><br>  <b>ControlChannelTrigger</b> - for specialized networking capabilities.  Requires registration of the application on the lock screen. <br><br>  <b>DeviceUseTrigger</b> - provides access to sensors and peripherals in the background.  Unlike other triggers, it is executed only if the application is suspended.  Does not support execution conditions. <br><br>  <b>Conditions - Performance Conditions</b> <br>  When a trigger is triggered, you can check the following conditions: <br>  <i>InternetAvailable / InternetNotAvailable</i> <i><br></i>  <i>SessionConnected / SessionDisconnected</i> <i><br></i>  <i>UserNotPresent / UserPresent</i> <i><br></i> <br>  With the release of Windows 10 triggers significantly increased.  A complete list can be found among the classes. <br>  <a href="https://msdn.microsoft.com/en-us/library/windows/apps/br229871.aspx">Windows.ApplicationModel.Background</a> <br><br>  Here are some new triggers that have become available in Windows UAP applications: <br>  <b>ApplicationTrigger</b> - with the help of this trigger, you can start the execution of background task from anywhere in the code (at the touch of a button, for example) <br>  <b>ToastNotificationActionTrigger</b> - occurs when the user <b>performs</b> an action with toast notifications <br>  <b>ToastNotificationHistoryChangedTrigger</b> - Allows you to track changes to the history of notifications.  It can be used, for example, in order to ‚Äúcatch‚Äù the moment of clearing messages in the notification center. <br>  <b>LocationTrigger</b> - a location change event that triggers a background job (used for Geofencing) <br>  <b>DeviceServicingTrigger</b> - an event that is triggered during a long update operation (firmware or parameters) of the device <br>  <b>DeviceWatcherTrigger</b> - happens when some changes happen with the list of connected devices <br><br>  Below is just a list of the remaining new triggers (there are a lot of them, right?): <br>  <b>AppointmentStoreNotificationTrigger</b> <b><br></b>  <b>ActivitySensorTrigger</b> <b><br></b>  <b>BluetoothLEAdvertisingPublisherTrigger</b> <b><br></b>  <b>BluetoothLEAdvertisingWatcherTrigger</b> <b><br></b>  <b>CachedFileUpdaterTrigger</b> <b><br></b>  <b>ChatMessageNotificationTrigger</b> <b><br></b>  <b>ChatMessageReceivedNotificationTrigger</b> <b><br></b>  <b>CommunicationBlockingAppSetAsActiveTrigger</b> <b><br></b>  <b>ContactStoreNotificationTrigger</b> <b><br></b>  <b>ContentPrefetchTrigger</b> <b><br></b>  <b>DeviceConnectionChangeTrigger</b> <b><br></b>  <b>DeviceManufacturerNotificationTrigger</b> <b><br></b>  <b>EmailStoreNotificationTrigger</b> <b><br></b>  <b>GattCharacteristicNotificationTrigger</b> <b><br></b>  <b>MediaProcessingTrigger</b> <b><br></b>  <b>MobileBroadbandDeviceServiceNotificationTrigger</b> <b><br></b>  <b>MobileBroadbandPinLockStateChangeTrigger</b> <b><br></b>  <b>MobileBroadbandRadioStateChangeTrigger</b> <b><br></b>  <b>MobileBroadbandRegistrationStateChangeTrigger</b> <b><br></b>  <b>NetworkOperatorNotificationTrigger</b> <b><br></b>  <b>NetworkOperatorHotspotAuthenticationTrigger</b> <b><br></b>  <b>Phonetrigger</b> <b><br></b>  <b>RcsEndUserMessageAvailableTrigger</b> <b><br></b>  <b>RfcommConnectionTrigger</b> <b><br></b>  <b>SmartCardTrigger</b> <b><br></b>  <b>SmsMessageReceivedTrigger</b> <b><br></b>  <b>StorageLibraryContentChangedTrigger</b> <b><br></b>  <b>SocketActivityTrigger</b> <br><br>  Apparently, some triggers do not work under certain conditions, and are designed to run background tasks with a specific goal.  Take, for example, the <b>MediaProcessingTrigger</b> trigger - as described, it allows an application to transcode multimedia as part of a background task.  Thanks to this, the transcoding can continue even when the foreground application has completed its work. <br><br>  If an application registers a background job, then it is necessary that this feature be documented in the manifest.  This can be done simply by using the manifest graphical editor: <br><br><img src="https://habrastorage.org/files/e5e/b43/7ac/e5eb437ac37c4a318a2a6568c65b3fe3.PNG"><br><br><img src="https://habrastorage.org/files/f32/f79/2f8/f32f792f8e844576b35e29d49ef5b402.PNG"><br><br>  In case you need to register several background tasks, add as many tasks as you need in the graphical editor of the manifest: <br><br><img src="https://habrastorage.org/files/7c2/881/92e/7c288192eea14152984592dcad9f0e67.PNG"><br><br>  Or, you can manually open the manifest with any XML editor and add a similar construct inside the Application tag: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Category</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"windows.backgroundTasks"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">EntryPoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BGTaskMD.ExampleBackgroundTask"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BackgroundTasks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Task</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"timer"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BackgroundTasks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Extension</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Category</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"windows.backgroundTasks"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">EntryPoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BGTaskMD.AppUpdateServicingCompleteTask"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BackgroundTasks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Task</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"systemEvent"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BackgroundTasks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Extension</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  A Windows 8.1 application can automatically register itself on the lock screen using: <br><br><pre> <code class="cs hljs"> BackgroundAccessStatus accessresult = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> BackgroundExecutionManager.RequestAccessAsync();</code> </pre><br>  as a result, the user will be prompted to add the App on the Lock Screen. <br>  This method returns a <a href="https://msdn.microsoft.com/ru-ru/library/windows/apps/windows.applicationmodel.background.backgroundaccessstatus">BackgroundAccessStatus</a> enumeration. <br><br>  Windows 10 and Windows Phone 8.1 applications do not require registration on the lock screen, but calling RequestAccessAsync before registering a Task is mandatory for them. <br><br>  There are 2 options for registering the application on the lock screen - the badge and badgeAndTileText.  Only badge and badge with text.  The option can be selected both through the graphic editor of the manifest, and through editing the XML code.  In addition to the choice of options, you must specify a badge image - BadgeLogo: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uap:VisualElements</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DisplayName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Background Task example"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Square150x150Logo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Assets\Square150x150Logo.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Square44x44Logo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Assets\Square44x44Logo.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BGTaskExample"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BackgroundColor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transparent"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uap:LockScreen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Notification</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"badgeAndTileText"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BadgeLogo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Assets\BadgeLogo.png"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uap:DefaultTile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Wide310x150Logo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Assets\Wide310x150Logo.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ShortName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Background Task example"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uap:DefaultTile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uap:SplashScreen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Assets\SplashScreen.png"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uap:VisualElements</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Through the graphical editor of the manifest, of course, it is more convenient to do this: <br><br><img src="https://habrastorage.org/files/596/f85/48b/596f8548b8d341278660968204d530d3.PNG"><br><br><img src="https://habrastorage.org/files/529/766/ff6/529766ff6dca4202ae78590bbba79399.PNG"><br><br>  In order for the application to register on the lock screen in the badgeAndTileText mode, you need to check that it also has a picture for a wide tile - WideLogo. <br><br>  The application can display various information on the lock screen, such as: badge, text from the last tile notification, toast notification.  No special action is required for this. <br>  A maximum of 7 applications can be registered on the lock screen.  And only one of them can display a wide tile. <br><br>  Applications that are registered on the lock screen have more privileges in relation to other applications.  They can use more resources. <br>  Limits on the use of resources are necessary so that the user's device does not ‚Äúcatch the brakes‚Äù from constantly running tasks in the background and does not put the battery on. <br><br>  For example: <br>  If the application is registered on the lock screen, it can use 2 seconds of CPU time every 15 minutes. <br>  If the application is not registered on the lock screen, then it can only use one second of CPU time every 2 hours. <br>  If this app is for Windows Phone, then it can use 2 seconds every 15 minutes. <br><br>  If the device is not connected to AC power, but is powered by a battery, the quota for using network data is automatically turned on (to save the amount of energy consumed by the network interface). <br><br>  In Windows Phone, when the battery saving feature is on, background tasks will not start if the device is not connected to an external power source and the battery charge is less than a certain level. <br>  More details on the link: <a href="https://msdn.microsoft.com/ru-ru/library/windows/apps/xaml/hh977056.aspx">Application support using background tasks (XAML)</a> <br><br>  After updating the application, it is necessary to update the background task (unregister and re-register).  The ‚ÄúServicingComplete trigger‚Äù mentioned earlier will help us ‚Äúcatch‚Äù the moment of the application update.  Use this trigger complies with the rules of good tone (almost must use). <br>  You can check out this way: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> BackgroundTaskRegistration.AllTasks) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_task.Value.Name == <span class="hljs-string"><span class="hljs-string">"My demo task"</span></span>) { _task.Value.Unregister(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }</code> </pre><br>  If the value of the Unregister method is true, then all currently running instances of the background task will be canceled.  If set to false, then tasks will be given the opportunity to complete their work. <br>  By the way, even after restarting the computer, the triggers are still working. <br><br>  When the trigger is initialized, the second parameter is the so-called OneShot parameter, which indicates whether the trigger will be executed only once or many times.  For example: <br><br><pre> <code class="cs hljs"> SystemTrigger taskTrigger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SystemTrigger(SystemTriggerType.ServicingComplete,<span class="hljs-literal"><span class="hljs-literal">false</span></span>);</code> </pre><br><br>  <b>A little guide to action.</b> <br>  Create a project like Blank App (Universal Windows) <br>  We add another project of the Windows Runtime Component (Universal Windows) type to the solution. <br>  In the first draft, add a link to the second.  You can do it like this: <br>  in Solution Explorer, on the project name, we call the context menu, select Add / Add - then Reference ... / Link ... and in the window, select Projects / Projects and put a check mark next to our second project <br><img src="https://habrastorage.org/files/00e/f1b/d8e/00ef1bd8e1994697839d24e0a2079f4b.PNG"><br><br>  In this file, the class code of the background job should be something like this: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleBackgroundTask</span></span> : <span class="hljs-title"><span class="hljs-title">IBackgroundTask</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IBackgroundTaskInstance taskInstance</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// - ,      } }</span></span></code> </pre><br>  Add a namespace: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Windows.ApplicationModel.Background;</code> </pre><br>  Before registering, it is necessary to check whether the trigger is already registered, otherwise we will receive a set of registrations of the same trigger. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> BackgroundTaskRegistration.AllTasks) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_task.Value.Name == <span class="hljs-string"><span class="hljs-string">"My demo task"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } }</code> </pre><br>  If the trigger requires registration on the initial screen, then before registering the trigger, you need to insert a similar snippet: <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//      BackgroundAccessStatus accessresult = await BackgroundExecutionManager.RequestAccessAsync(); if ((accessresult == BackgroundAccessStatus.Denied)||(accessresult == BackgroundAccessStatus.Unspecified)) { return; }</span></span></code> </pre><br>  You can register a trigger like this: <br><br><pre> <code class="cs hljs"> TimeTrigger taskTrigger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeTrigger(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bgTaskBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BackgroundTaskBuilder(); bgTaskBuilder.Name = <span class="hljs-string"><span class="hljs-string">"My demo task"</span></span>; bgTaskBuilder.TaskEntryPoint = <span class="hljs-string"><span class="hljs-string">"BGTaskMD.ExampleBackgroundTask"</span></span>; bgTaskBuilder.SetTrigger(taskTrigger); <span class="hljs-comment"><span class="hljs-comment">// ,          SystemCondition internetCondition = new SystemCondition(SystemConditionType.InternetAvailable); bgTaskBuilder.AddCondition(internetCondition); BackgroundTaskRegistration task = bgTaskBuilder.Register(); task.Completed += task_Completed; // -   void task_Completed(BackgroundTaskRegistration sender, BackgroundTaskCompletedEventArgs args) { // -    }</span></span></code> </pre><br>  The Completed event occurs if the application is currently running.  If the application is suspended (suspended) and then terminated, the event does not occur.  If the application is paused and then resumed, then Completed is triggered after resuming. <br><br>  In addition to Completed, you also need to handle the cancellation of the background task - Canceled.  But it is not processed when registering a task, but when it is implemented, that is, in the class of our WinMD file. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleBackgroundTask</span></span> : <span class="hljs-title"><span class="hljs-title">IBackgroundTask</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _cancelRequested = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IBackgroundTaskInstance taskInstance</span></span></span><span class="hljs-function">)</span></span> { taskInstance.Canceled += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BackgroundTaskCanceledEventHandler(OnCanceled); <span class="hljs-comment"><span class="hljs-comment">//        } private void OnCanceled(IBackgroundTaskInstance sender, BackgroundTaskCancellationReason reason) { //      sender.Task.Name _cancelRequested = true; } }</span></span></code> </pre><br>  If an asynchronous code is executed during a background task, in order for the code to terminate correctly if the application is interrupted, defferal must be used.  In this case, the Run method would get something like this: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IBackgroundTaskInstance taskInstance</span></span></span><span class="hljs-function">)</span></span> { BackgroundTaskDeferral _deferral = taskInstance.GetDeferral(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> someAsyncTask(); _deferral.Complete(); }</code> </pre><br>  It is recommended to write short tasks that do not interfere with the operation of the system. <br><br>  While the background task is running, you can write process status values ‚Äã‚Äãto settings ‚Äî Windows.Storage.ApplicationData.Current.LocalSettings and read them if necessary. <br><br>  User interaction in background tasks is not used.  No user interface elements, except for notifications, tiles and updates of the event indicators from the background task code, are not recommended. <br><br>  Debugging the background task runs the risk of becoming a tedious task if you perform an event triggered by a trigger, treyt it or even wait at least 15 minutes for the MaintenanceTrigger or TimeTrigger to work (although some developers probably dream of such debugging). <br>  In order for VS to have the opportunity to call a trigger, the code of our background task must be transferred to the metadata file - WinMD.  We did just that, so when debugging we can see our background task in the events of the application life cycle. <br><img src="https://habrastorage.org/files/ed3/bd3/cf3/ed3bd3cf3da243fcbffa7f80294bab28.png"><br>  In order for this to work, the background task must already be registered and wait for the launch. <br>  If you register the background task with the OneShot parameter, then after it works, the debugging of the task through Visual Studio will no longer be available. <br>  Debugging via Visual Studio is not available for triggers such as ControlChannelTrigger, PushNotificationTrigger, as well as for background tasks using SystemTrigger with trigger type SmsReceived. <br><br>  My example of implementing TimeTrigger and ServicingComplete can be found on <a href="https://github.com/programmersommer/Background-Task-example">GitHub</a> <br><br>  As for working with the Internet, the background tasks are not intended for downloading large amounts of data.  But they are convenient for something like a news update or event monitoring.  If you want to download large files, you need to use the <b>BackgroundDownloader</b> class. <br>  Consider a simple example of loading data: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Windows.Networking.BackgroundTransfer; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Windows.Storage; <span class="hljs-comment"><span class="hljs-comment">// -  ... Uri source = new Uri("https://habrastorage.org/files/f0a/5ea/caf/f0a5eacaf8c44f82a92748124c470f91.jpg"); StorageFile destinationFile = await KnownFolders.PicturesLibrary.CreateFileAsync( "imagefromhabr.jpg", CreationCollisionOption.GenerateUniqueName); BackgroundDownloader downloader = new BackgroundDownloader(); DownloadOperation download = downloader.CreateDownload(source, destinationFile); await download.StartAsync();</span></span></code> </pre><br>  Finally, and even so removed from the topic, I will add that for short-term operations involving the downloading of small resources, you can or even need to use the <b>Windows.Web.Http</b> namespace <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"http://habrahabr.ru/post/264199/"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-comment"><span class="hljs-comment">//   exceptions   async  { var result = await httpClient.GetStringAsync(uri); } catch { } httpClient.Dispose();</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/264199/">https://habr.com/ru/post/264199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264189/index.html">Implementation of the wave algorithm for finding the shortest path to dynamically moving objects in unity3d on C # in a 2d game</a></li>
<li><a href="../264191/index.html">Interpolation of data: we connect points so that it was beautiful</a></li>
<li><a href="../264193/index.html">How to find out the year of release of the song on the set of audio characteristics?</a></li>
<li><a href="../264195/index.html">Hybrid Conf - the first conference on programmatic-advertising in Russia</a></li>
<li><a href="../264197/index.html">HDD sled - cost effective grain</a></li>
<li><a href="../264201/index.html">Intervals in C ++, part 1: Intervals with limiters</a></li>
<li><a href="../264207/index.html">Is there a problem with the MTS mobile traffic in some regions, or the skis do not travel?</a></li>
<li><a href="../264209/index.html">PHP library for integration with the New Mail API</a></li>
<li><a href="../264213/index.html">Are you still using CJSON?</a></li>
<li><a href="../264217/index.html">Apply correlation in retail</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>