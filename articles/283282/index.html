<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Drupal: ajax_facets and history API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably every web developer faced with the need to implement a search on the site. Quite a common solution - Apache Solr. In the world of Drupal deve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Drupal: ajax_facets and history API</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/167/631/cbb/167631cbbccd44e19f157e5bd68081a8.jpg" align="left">  Probably every web developer faced with the need to implement a search on the site.  Quite a common solution - Apache Solr.  In the world of Drupal development, this is no exception.  For the integration of Solr with Drupal and the implementation of faceted search, there are modules <a href="https://www.drupal.org/project/search_api">search_api</a> , <a href="https://www.drupal.org/project/search_api_solr">search_api_solr</a> and <a href="https://www.drupal.org/project/facetapi">facetapi</a> .  But in most cases, we would like the search results and the facet filters to be updated without reloading the page, that is, ajax.  And, as usual in the Drupal world, on <a href="https://www.drupal.org/">d.org</a> there is some time and user-tested module (or maybe not proven, as lucky) that does what we need.  In this case, <a href="https://www.drupal.org/project/ajax_facets">ajax_facets</a> . <a name="habracut"></a><br><br>  Ajax facets is a module that provides several types of widgets that can be used in faceted search filters.  These are ‚Äúrange slider‚Äù, ‚Äúmultiple checkboxes‚Äù, ‚Äúselectbox‚Äù and ‚Äúlinks‚Äù.  When values ‚Äã‚Äãin these ‚Äúwidgets‚Äù change, the filters and the search result are updated with ajax.  Great.  But it would be even better if the module were friends with the history API.  That is, it would save every filter state in the history, which would allow users to go through the search history with the back and forth buttons in the browser, again, without reloading the page. <br><br><h4>  Task </h4><br>  Of course, the need for this feature and the interest in implementation did not arise by itself.  One of the projects was tasked with making ajax_facets friends with the history API.  What I want to tell you. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Decision </h4><br>  As is usually the case, solving a problem begins with finding a complete solution or at least a patch.  There was no ready solution, but <a href="https://www.drupal.org/files/ajax_facets-push_state_support-0.patch">a patch was found</a> .  Judging <a href="https://www.drupal.org/node/2105177">by the description</a> on the issue tracker of the project, he did just what he needed.  But, unfortunately, the patch was old and valid only for the old branch of the module (7.x-2.x).  The idea is very simple: save the current state of the filters to the browser history at the moment when ajax_facets receives a successful response from the server to update the search result and the filters themselves.  And by clicking on the ‚Äúback‚Äù and ‚Äúforward‚Äù buttons, retrieve the saved state of filters from the history and send a request to update the filters and search results with parameters from the saved state. <br><br>  To test the idea as such, I <a href="https://www.drupal.org/node/2105177">ported the</a> found patch to the current module branch (7.x-3.x).  Everything worked.  However, it required improvements.  Namely, I would like this feature to work in old browsers that do not support the history API.  The task is simple.  There is a <a href="https://github.com/browserstate/history.js/">history.js</a> that emulates the history API.  On the other hand, I didn‚Äôt want to add a hard dependency on this library, since this would mean adding a <a href="https://www.drupal.org/project/libraries">libraries</a> module to the dependencies.  Such a patch just no one would have accepted.  Imagine, you update the ajax_facets module, and in dependencies it has got libraries, which you don‚Äôt need.  You don‚Äôt need the support of old browsers in the form of history.js either (you simply don‚Äôt support old browsers, for example).  To avoid such situations, I decided to make everything a bit more flexible: <br><br><ol><li>  On the server side, we check the availability of the libraries module and the history.js library.  If dependencies are found, then we pass the flag ‚Äúhistory.js is available to the front-end side; you can use the history API‚Äù. </li><li>  On the client side, we check if the browser supports the history API (natively or through history.js).  If yes, then we do everything as expected.  Otherwise, we get the standard behavior of ajax_facets (as it was before the patch). </li></ol><br><br><h4>  Implementation </h4><br>  The first item is achieved as follows: <br>  We give out hints on the ‚ÄúStatus report‚Äù page if the dependencies are not found. <br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Implements hook_requirements(). */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_facets_requirements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($phase)</span></span></span><span class="hljs-function"> </span></span>{ $requirements = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $t = get_t(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($phase) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'runtime'</span></span>: $description = $t(<span class="hljs-string"><span class="hljs-string">'For now browser ajax history feature works only in HTML5 browsers. If you want to get this feature on HTML4 browsers you need to install libraries module and download history.js library.'</span></span>); $value = $t(<span class="hljs-string"><span class="hljs-string">'Libraries module not installed.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (module_exists(<span class="hljs-string"><span class="hljs-string">'libraries'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!libraries_get_path(<span class="hljs-string"><span class="hljs-string">'history.js'</span></span>)) { $description = $t(<span class="hljs-string"><span class="hljs-string">'For now browser ajax history feature works only in HTML5 browsers. If you want to get this feature on HTML4 browsers you need to download history.js library.'</span></span>); $value = $t(<span class="hljs-string"><span class="hljs-string">'Library history.js not found.'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $description = $t(<span class="hljs-string"><span class="hljs-string">'For now browser ajax history feature works both in HTML4 and HTML5 browsers.'</span></span>); $value = $t(<span class="hljs-string"><span class="hljs-string">'Works with history.js library'</span></span>); } } $requirements[<span class="hljs-string"><span class="hljs-string">'ajax_facets_message'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; $t(<span class="hljs-string"><span class="hljs-string">'Ajax Facets'</span></span>), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; $description, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; $value, <span class="hljs-string"><span class="hljs-string">'severity'</span></span> =&gt; REQUIREMENT_INFO, ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $requirements; }</code> </pre> <br><br>  And we forward the flag to the front-end side in case history.js library is found. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Add required JS and handle single inclusion. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_facets_add_ajax_js</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($facet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $included = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$included) { ... <span class="hljs-comment"><span class="hljs-comment">// Add history.js file if exists. if (module_exists('libraries')) { $history_js_path = libraries_get_path('history.js'); if ($history_js_path) { $history_js_exists = TRUE; drupal_add_js($history_js_path . '/scripts/bundled/html4+html5/jquery.history.js', array('group' =&gt; JS_LIBRARY)); } } ... $facet = $facet-&gt;getFacet(); $setting['facetapi'] = array( .... 'isHistoryJsExists' =&gt; $history_js_exists, ); drupal_add_js($setting, 'setting'); drupal_add_library('system', 'drupal.ajax'); } }</span></span></code> </pre><br><br>  The implementation of the second item is shown on the example of the pushState wrapper function: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Pushes new state to browser history. * * History.js library fires "statechange" event even on API push/replace calls. * So before pushing new state to history we should unbind from this event and after bind again. */</span></span> Drupal.ajax_facets.pushState = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, title, stateUrl</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// If history.js available - use it. if (Drupal.settings.facetapi.isHistoryJsExists) { var $window = $(window); $window.unbind('statechange', Drupal.ajax_facets.reactOnStateChange); History.pushState(state, title, stateUrl); $window.bind('statechange', Drupal.ajax_facets.reactOnStateChange); } else { // Fallback to HTML5 history object. if (typeof history.pushState != 'undefined') { history.pushState(state, title, stateUrl); } } };</span></span></code> </pre><br><br>  By the way, there is one interesting feature in history.js that needs to be taken into account: the <b>statechange</b> event <b>is</b> triggered when the browser history buttons are pressed, as well as when the history is programmatically updated, for example by calling the History.pushState () method.  In the native implementation of the history API by browsers, there is an <b>onpopstate</b> event that is triggered only when clicking on the browser history buttons.  To avoid unnecessary triggering of the statechange, you need to unsubscribe from this event before updating the browser history, and then subscribe to it again. <br><br><h4>  Conclusion </h4><br>  It is not always possible to find and apply a ready-made solution.  But this is very cool.  This makes it possible to understand, to see how the module that was used before, works inside.  And, in the end, it's just nice when the solution you proposed is commited to a popular project.  This means the next time someone else will not have such a problem. <br><br>  Full diff can be viewed <a href="https://www.drupal.org/files/issues/ajax_facets-html5-states-history-js-2105177-35.patch">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/283282/">https://habr.com/ru/post/283282/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283270/index.html">Analysis of the tasks of the first qualifying round of the RCC 2016</a></li>
<li><a href="../283274/index.html">There are no hares under Android - the history of creation</a></li>
<li><a href="../283276/index.html">Veeam Backup & Replication: workaround for one problem with backup job metadata</a></li>
<li><a href="../283278/index.html">[PF] Print PDF under .NET, vector approach, theory</a></li>
<li><a href="../283280/index.html">Product design digest, April 2016</a></li>
<li><a href="../283284/index.html">Natural animation in interfaces</a></li>
<li><a href="../283286/index.html">Happy Birthday, Edsger Vibe Dijkstra«É</a></li>
<li><a href="../283288/index.html">Kui releases while hot - pre-release testing version 0.4.1</a></li>
<li><a href="../283290/index.html">Stop repeating the "ponderous"</a></li>
<li><a href="../283294/index.html">Test. Checking the entry point in an arbitrary polygon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>