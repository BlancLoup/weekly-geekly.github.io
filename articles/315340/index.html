<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating and testing a firewall in Linux, Part 1.1 Virtual Lab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to write an article in the wake of the course that I did last semester at the institute. Of course, here I will describe only the most impor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating and testing a firewall in Linux, Part 1.1 Virtual Lab</h1><div class="post__text post__text-html js-mediator-article">  I decided to write an article in the wake of the course that I did last semester at the institute.  Of course, here I will describe only the most important fundamentals and simplify everything as much as possible.  I will try to give a little theoretical information, but mostly more links, pictures and practice. <br><br>  So, we will talk about writing a firewall in a Linux environment.  I will divide the whole article into several parts.  What you are reading now is the first part, it is divided into three parts.  Some topics are well known and documented, so I will try to separately give a minimum of theory on them and a separate practice.  To all was interesting.  And also links for deepening (often these will be English articles). <br><br>  <b>Content of the first part:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b><b>1.1</b> - Creating a virtual lab (so that we have where to work, I'll show you how to create a virtual network on your computer. The network will consist of 3 Linux ubuntu machines).</b> <br>  <a href="https://habrahabr.ru/post/315350/"><b>1.2</b> - Writing a simple module in Linux.</a>  <a href="https://habrahabr.ru/post/315350/">Introducing Netfilter and intercepting traffic with it.</a>  <a href="https://habrahabr.ru/post/315350/">We combine everything together, we test.</a> <br>  <b>1.3</b> - <a href="https://habrahabr.ru/post/315454/">Writing a simple char device.</a>  <a href="https://habrahabr.ru/post/315454/">Adding a virtual file system - sysfs.</a>  <a href="https://habrahabr.ru/post/315454/">Writing user interface.</a>  <a href="https://habrahabr.ru/post/315454/">We combine everything together, we test.</a> <br><br>  <b>The content of the second part:</b> <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  <a href="https://habrahabr.ru/post/316086/"><b>2.1</b> - Introduction to the second part.</a>  <a href="https://habrahabr.ru/post/316086/">We look at the network and protocols.</a>  <a href="https://habrahabr.ru/post/316086/">Wireshark.</a> <br>  <a href="https://habrahabr.ru/post/316756/"><b>2.2</b> - Firewall Tables.</a>  <a href="https://habrahabr.ru/post/316756/">Transport Layer.</a>  <a href="https://habrahabr.ru/post/316756/">TCP structures, UDP.</a>  <a href="https://habrahabr.ru/post/316756/">Extend the firewall.</a> <br>  <a href="https://habrahabr.ru/post/316778/"><b>2.3</b> - Expanding functionality.</a>  <a href="https://habrahabr.ru/post/316778/">We process the data in user space.</a>  <a href="https://habrahabr.ru/post/316778/">libnetfilter_queue.</a> <a href="https://habrahabr.ru/post/316778/"><br></a>  <b>2.4</b> - (* Optionally) We study the real Buffer Overflow attack and prevent it with the help of our Firewall. <br></div></div><br><br><a name="habracut"></a><br>  <i>Part 2.</i> Not ready yet, but I think to cover the following topics: a brief introduction to the firewall tables.  Stateless vs statefull firewall.  Adding another module to load the rule tables (via the virtual sysfs file system from the first part, maybe I‚Äôll just give the source code, because there‚Äôs basically nothing new here).  Add a small proxy program in the user space and send the necessary traffic from the kernel to the proxy, work with the content of the traffic and on this basis make decisions about its future (add the ability to block individual sites).  And also take a real known attack based on buffer overflow, take control over a remote computer with its help and see how our firewall can protect against this. <br><br>  Perhaps the second part will be split into two, or changed.  I would be very happy for your comments and suggestions both in the first part and in the second. <br><br><h3>  Introduction </h3><br>  Our goal in this part is to write a program that will control all traffic at a very simple level.  Namely, we will determine which packets can be skipped and which ones can be deleted.  We will create a simple logging system to track the results, as well as a program for the user of course, through which you can read these results and manage the program a little.  Such a trivial <i>firewall</i> or in Russian is the <i>Firewall, the firewall</i> is a complex of hardware and software on a computer network that monitors and filters the non-network packets passing through in accordance with specified rules.  ( <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D1%2581%25D0%25B5%25D1%2582%25D0%25B5%25D0%25B2%25D0%25BE%25D0%25B9_%25D1%258D%25D0%25BA%25D1%2580%25D0%25B0%25D0%25BD">Wikipedia</a> ). <br><br>  In our case, the firewall function will be performed by a separate computer.  It will look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ea0/7d0/360/ea07d03602074aadacbaee986c40ea9b.png" width="90%"></div><br><br>  Let's watch.  We will make a network in which there will be three virtual computers - host1, host2, fw and connect them as in the picture above. <br><br>  host1 - will get a static IP address - 10.0.1.1.  We will defend him. <br>  host2 - which will be attacking in the last part and will have a static IP - 10.0.2.2 <br>  fw - will track all traffic, configure it as the interface for accessing the Internet, so that you can, when ( <s>read VC and news</s> ) need to download the necessary software. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9b2/620/bcf/9b2620bcfa614b4d98148e1b70028248.PNG" width="80%"></div><br><br>  In a nutshell, <i>DHCP</i> (Dynamic Host Configuration Protocol) is a network protocol that allows computers to automatically obtain an IP address and other parameters necessary for working on a TCP / IP network.  (Wikipedia). <br><br>  That is, he will receive various settings himself, including IP, in order to be able, through this network interface, to go online without any headaches. <br><br><h3>  Creating a virtual environment.  Theory </h3><br>  A little about virtual machines.  In our case, a virtual machine is a program that will emulate a computer, so that we can run three operating systems on our computer at once.  For those who are not at all familiar with the topic, they can start <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D0%25B0">here</a> . <br><br>  We will use the free <i>VirtualBox</i> program, which allows you to create virtual networks on one computer.  Of course, it doesn‚Äôt matter how to use it, the main thing is to be able to configure the network.  The program is free, we search, download, set. <br>  The next step is to add virtual machines.  I will work with Linux Ubuntu 12, for "historical reasons".  You can download the latest version.  Especially if your computer is powerful enough.  An image of Ubuntu can be found <a href="https://virtualboxes.org/images/ubuntu/">here</a> . <br><br>  I hope that the reader will cope with the addition of the image in the virtualbox and now you have something similar to the picture.  I advise using the ‚Äúclone‚Äù function in the virtualbox to quickly create two more machines.  In my role as host1, host2 I‚Äôve specially cut down the ‚Äúlight‚Äù versions of ubuntu, without a graphical interface (there‚Äôs not enough RAM for full-fledged ones). <br><br>  Something like this should look like at the end <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0cf/5ef/f22/0cf5eff22ad74ddfad0812a459343495.png" width="90%"></div><br><br><h3>  Creating a virtual environment.  Practice </h3><br>  And so, I assume that you already have three virtual linux machines that we will now configure into one network and check that everything works before starting to write a program. <br><br>  Go to settings and configure as in the photo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7f1/6f5/7ae/7f16f57ae43f4c35967999dc941a3f86.png" width="60%"></div><br><br>  Add a network device: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cec/738/7af/cec7387afbf244b79b970e0f6b5140aa.png" width="70%"></div><br><br>  Now, linux "will think" that our computer has a network card, and if you look in Advanced, you will see that the cable is also inserted into it.  Fine.  Now you need to configure this card in the operating system.  To do this, run host1. <br><br>  At this stage, I assume that the reader is aware of what an IP address is as it looks and why it is needed.  I will edit in vi, you can in any other editor, but do not forget to give administrator rights (run from sudo) to be able to save. <br><br><pre><code class="bash hljs">$ sudo vi /etc/network/interfaces</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/742/5d0/6ac/7425d06ac9b246beb2e641154bd5b2e7.png" width="70%"></div><br><br>  ‚ÄúWe ask‚Äù the system to re-read the configuration file (in order not to reboot the machine): <br><br><pre> <code class="bash hljs">$ sudo ifdown eth0 &amp;&amp; sudo ifup eth0</code> </pre><br>  We <i>run ifconfig</i> and check that we have a network card under the name <i>eth0</i> , with <i>IP</i> == 10.0.1.1, a mask, etc., and so on. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7a1/445/67e/7a144567e0254f088f011c2a2f802b43.png" width="70%"></div><br><br>  We do the same with host2, only set IP to 10.0.2.2, gateway 10.0.2.3 and don‚Äôt forget to ‚Äúadd‚Äù the network card in the virtualbox settings (after changing settings in virtualbox, the machine hung up for a couple of minutes and wrote waiting for network configuration ... This is due to the fact that by default, the network interface is configured as dhcp, that is, the operating system is waiting to dynamically obtain network settings, but in virtualbox, for this it must be configured as NAT, but we changed it, therefore The OS is trying to understand what is wrong. You can first load the OS,  activate interfaces, then turn off the computer, change settings and restart). <br><br>  Host2: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/74a/f79/1a5/74af791a5d3e4f87997a0c24f2ed9dc6.png" width="70%"></div><br><br>  Now it's the turn of the main machine that will act as a firewall.  I remind you that we will need three network cards, through one we will be able to go online if necessary, so it will be defined as NAT.  The other two will be responsible for forwarding traffic from host1 -&gt; host2 and back from host2 -&gt; host1. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/606/c94/ad6/606c94ad62ea47138bd52069c2e75252.png" width="70%"></div><br><br>  Adapter1 - should be set as NAT.  The settings for Adapter2, Adapter3, are the same as in the previous examples (Internal network).  We start, we begin to configure network cards.  This is how the interfaces file should look. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/070/14c/866/07014c86650d43f8a9aaf972514a0d40.png" width="70%"></div><br><br>  And here is the final result of the configuration, after the restart: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ad1/858/ed8/ad1858ed8aa548f688ca470c451cdfad.png" width="70%"></div><br><br>  The last thing left to do is to allow <i>packet forwarding</i> , so that the computer can take packets from one network interface (10.0.2.3) to which packets from host2 come and transfer them to another 10.0.1.3 network interface connected to host1, respectively. <br><br>  <a href="http://www.ducea.com/2006/08/01/how-to-enable-ip-forwarding-in-linux/">Here</a> everything is described in detail.  To make the setting permanent, you need to change the following line in <i>/etc/sysctl.conf</i> : <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.ip_forward = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  You can do this in any convenient way, do not forget sudo.  A lot of information about the configuration of the interfaces can be read <a href="http://www.cyberciti.biz/faq/setting-up-an-network-interfaces-file/">here</a> . <br><br><h3>  Check </h3><br>  It remains to verify that everything is connected with each other and works.  We will check the classic <i>ping</i> <br><br><img src="https://habrastorage.org/files/30a/1a2/1b3/30a1a21b30a04d62849fb79ac45be2d6.png"><br><br>  As can be seen in the picture, ping "passed" with host1 -&gt; host2, host2 -&gt; host1, fw -&gt; host1, fw -&gt; host2.  Done, the lab is set up for future experiments. <br><br><h3>  References: </h3><br>  ¬ª <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D1%2581%25D0%25B5%25D1%2582%25D0%25B5%25D0%25B2%25D0%25BE%25D0%25B9_%25D1%258D%25D0%25BA%25D1%2580%25D0%25B0%25D0%25BD">Network Screens</a> <br>  ¬ª <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D0%25B0">Virtual Machines</a> <br>  <a href="http://www.ducea.com/2006/08/01/how-to-enable-ip-forwarding-in-linux/">How to allow forwarding</a> <br>  ¬ª <a href="http://www.cyberciti.biz/faq/setting-up-an-network-interfaces-file/">Interface configuration</a> </div><p>Source: <a href="https://habr.com/ru/post/315340/">https://habr.com/ru/post/315340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315330/index.html">Developer: Airbag</a></li>
<li><a href="../315332/index.html">How to lose a few million, working incomprehensibly with whom</a></li>
<li><a href="../315334/index.html">A bit about Windows VM disk performance in Proxmox VE. Results of ZFS and MDADM + LVM benchmarks</a></li>
<li><a href="../315336/index.html">Why companies with well-described business processes are doomed to extinction</a></li>
<li><a href="../315338/index.html">Easter eggs solution from CTF announcement from Bi.Zone</a></li>
<li><a href="../315342/index.html">How we tested interface usability</a></li>
<li><a href="../315344/index.html">The first winners of the Telegram BotPrize will receive $ 200,000</a></li>
<li><a href="../315346/index.html">Due to skinny fonts the internet becomes unreadable.</a></li>
<li><a href="../315348/index.html">We catch someone else's WiFi at a distance of 1 km</a></li>
<li><a href="../315350/index.html">Creating and testing a firewall in Linux, Part 1.2. Simple interception of traffic with Netfilter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>