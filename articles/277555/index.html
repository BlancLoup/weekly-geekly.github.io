<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From the black rectangle in Yandex. Browser to the acceleration of the whole Chromium</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will tell you a story about an interesting bug in Yandex. Browser, the correction of which led to a significant acceleration of rendering thr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From the black rectangle in Yandex. Browser to the acceleration of the whole Chromium</h1><div class="post__text post__text-html js-mediator-article">  Today we will tell you a story about an interesting bug in Yandex. Browser, the correction of which led to a significant acceleration of rendering throughout the Chromium project.  And Kirill <a href="https://habrahabr.ru/users/drbasic/" class="user_link">drBasic</a> Pleshivtsev and Vadim <a href="https://habrahabr.ru/users/lof/" class="user_link">Lof</a> Petrov, specialists from our team, who are fortunate enough to deal with the problem, will help me in this.  Give them the word. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ab0/adf/fb0/ab0adffb0a2543dab6e194278cd2c736.jpg"></div><br><br>  <b>One not absolutely normal bug</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My name is Kirill, I work in the group of internal components of Yandex. Browser in Novosibirsk.  On one not-so-beautiful day, colleagues from testing Yandex Browser reproduced the problem with playing the video through Flash Player.  And since it is our group that is responsible for this part of the browser (media, codecs, that's all), the task went to me.  Bug, let's say, did not claim to originality.  Clicking the Play button led to a black rectangle instead of correctly playing the video.  I have met this symptom before, so I expected to locate the problem fairly quickly.  But I was wrong. <br><a name="habracut"></a><br>  Literally in the very first minutes, we managed to find out that a black rectangle does not always appear, but only for flash-elements with the type transparent, i.e.  translucent.  Great, there is already something to catch on when debugging.  I collect the debug-version of the browser, I launch it, there is no bug.  And this is a wake-up call.  Differences in the work of the debug and release versions - it is always a lot of fun.  Therefore, I decide to collect more and release version.  Collected, I start, there is no bug. <br><br>  Thought it out.  What is the difference between my release build and the one that the server builds?  Immediately remembered the library layout.  Developers compile browser in shared_library mode.  This increases the amount of dll, but it greatly saves layout time.  The browser distributed in the static_library mode is distributed, in which only a few large dlls are collected.  I expose a flag static_library, I do full assembly.  I watch as link.exe slowly eats up all the RAM, but no, 16 GB of RAM is enough for everyone, the layout is completed without doping in the form of a paging file.  I'm running.  There is no bug. <br><br>  Seriously thought.  I remembered that the assembly server collects the release of Yandex. The browser with the official flag, which slightly changes the behavior (more about this later).  I collect with this flag.  With a shaking hand, I launch the browser.  Have you already guessed?  There is no bug. <br><br>  Then I was really alarmed and began to think with all my might.  After a while, I noticed that the server collects Yandex Browser using Visual Studio 2013. And I used the 2015 version.  I collect in the 2013 version.  I'm running.  There is a bug!  Who would have thought that I would be so happy about the mistake. <br><br>  If you now thought that the whole problem was only in the VS version, then you are mistaken.  The bug really did not reproduce in the debug version of the browser.  Experimentally it was possible to establish that in order for an error with a black rectangle to appear, the browser should be compiled not only with VS 2013, but also in a static layout with the official flag.  The reasons for this strange behavior, you will learn later. <br><br>  The next two days were no less interesting.  During debugging, I managed to understand that the Flash Player plugin itself performs its task correctly: the video plays.  Its integration with the browser issues also did not cause.  The result of his work was transmitted for rendering, but for some reason we saw something completely different on the screen.  This means that the bug had to be searched in the part of the browser that is responsible for rendering.  And here I give the word to Vadim. <br><br>  <b>Optimize it</b> <br><br>  As you already understood, now Vadim is in touch.  I work in the development group of the rendering engine Yandex. Browser in Moscow.  A few words about how the rendering in Yandex Browser or Chromium occurs in general.  Everything that you see in the browser window is the result of combining different layers (web page, interface), almost like in Photoshop.  Compositor component (or Chrome's Compositor == CC) is responsible for working with these layers.  But to draw each layer of SS already, it calls the special open source <a href="https://skia.org/">Skia</a> library. <br><br>  Together with Cyril, we realized that traces of the bug go to Skia.  It remained to understand exactly where.  Fortunately, I had a valuable hint.  Almost at the very beginning, Cyril mentioned it.  The point is that the problem occurs only in the case of flash-elements with transparency.  To draw such elements on the screen, the browser needs to combine the video image with the background.  And for this, Skia has a special function SrcATop, which is responsible for blending.  A few minutes of searching, and now I have already found a <a href="https://bugs.chromium.org/p/chromium/issues/detail%3Fid%3D543583">bug report</a> with a similar problem in Chrome, which finally dispelled all doubts. <br><br>  Hooray.  We localized the source of the problem down to a specific function.  And now, attention.  This piece of code did not contain any errors.  Not at all.  And it worked perfectly for any builds except the final one, which is sent to users.  And only for Visual Studio 2013. And at that moment I understood why Cyril called this bug "merry." <br><br>  I begin to understand the other differences that affect the reproducibility of the error.  The time has come to recall the official flag, which is used only at the very end.  Among other things, this flag affects the optimization, or rather the <a href="https://msdn.microsoft.com/en-us//library/xbf3tbeh.aspx">/ LTCG</a> parameter.  When it is specified, the compiler produces a fairly serious optimization of the entire program.  It takes a lot of time, so these assemblies are not just assembled.  But how can optimization lead to an error?  To understand this, we need a small flashback. <br><br><img src="https://habrastorage.org/files/a14/f98/24d/a14f9824de3d48e9a58e880404c4d6bd.png"><br><br>  In 2011, the Chromium project became so large and complex that the Visual Studio 2010 linker once <a href="https://bugs.chromium.org/p/chromium/issues/detail%3Fid%3D108167">failed to</a> link it with all the optimizations due to lack of resources.  To get around the problem, the developers decided by default to optimize all the subprojects (and there are more than a thousand) not by the speed of operation (/ O2), but by the size of the code (/ O1).  And only for the elite and the most critical, or for those whose owners did not oversleep this situation, turned on / O2 back.  For example, this was done for CC and Skia.  That's just in 2013 when refactoring in Skia optimization accidentally lost.  And no one would have noticed anything if in another two years another refactoring did not occur in Chromium, as a result of which a part of the code was made template and transferred to the header.  And here it all began. <br><br>  And that's what began.  When a release browser is assembled with the official flag, libraries with different goals for optimization (in speed, in size) are in the same dll.  In itself, this is not a sign of something bad.  For example, in Visual Studio 2015 it does not cause any problems.  The studio puffs an hour over optimization and gives out quite a working code.  But if we replace it with the 2013 version, everything breaks down.  Why? <br><br>  The SrcATop function, which is responsible for the blending in Skia, takes two parameters through the xmm0 and xmm1 registers.  And almost always it works correctly.  But as I was able to figure out during debugging, it is worth adding VS 2013 and a difficult optimization, and the function degenerates to such an extent that it starts to return the contents of the first register in response.  Hence, there was a constant black background instead of video.  All the fault was the wrong code generation in VS 2013. <br><br>  <b>We accelerate web surfing</b> <br><br>  With a strong desire, the bug could be ‚Äúfixed‚Äù locally, by slightly twisting SrcATop.  But it seemed to me wrong that such a component important for rendering as Skia does not have speed optimization.  Therefore, I have assembled a new assembly in which I set speed optimization for Skia.  The bug, of course, was gone.  It would seem that you can close the task and go to drink tea, but no.  I needed to do something else. <br><br>  The Yandex. Browser team has been involved in the development of Chromium for more than a year.  And this concerns not only the correction of errors.  At one time, colleagues helped with server push implementation for HTTP / 2 and with the project build system for Windows.  Therefore, this time I offered a solution to the problem and sent a ready <a href="https://chromium.googlesource.com/chromium/src/%2B/1b08081a7a1f438999aa401417538d73afbcdf89">commit</a> for consideration, which was adopted after a brief discussion. <br><br>  The developers from Chromium, as well as me, were interested in looking at the changes in terms of browser performance.  Therefore, they drove a whole set of performance tests.  Almost all indicators for Windows have grown up.  Some low-level tests showed improvements by a factor of 2-3.  The integrated FPS test for key sites (in other words, everyday web surfing) grew by 6.5%.  Responsiveness to input improved by 20-30%.  In the Chromium project, it is not every day that optimization of this level happens. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/92b/76a/277/92b76a2779b84dd8bda5ed3d7ddcce95.png"></div><br><br>  Considering that VS 2010 has not been used for a long time, I suggested trying to turn on speed optimization for the entire project.  Moreover, the usual release build (without the official flag) has always been optimized for speed, and there have never been any problems with testing.  But that's another story. <br><br>  PS This single issue has affected only two offices.  In fact, the development of Yandex. Browser is conducted not only in Moscow and Novosibirsk.  We also have teams in St. Petersburg, Yekaterinburg, Nizhny Novgorod, Minsk and Kiev.  And if you would be interested to join them, then look at <a href="https://yandex.ru/jobs/vacancies/dev/%3Fservices%3Dbrowser">yandex.ru/jobs</a> . </div><p>Source: <a href="https://habr.com/ru/post/277555/">https://habr.com/ru/post/277555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277543/index.html">Clean code architecture and development through testing in PHP</a></li>
<li><a href="../277545/index.html">Game design f2p games or how not to make mistakes</a></li>
<li><a href="../277547/index.html">How to choose a framework for frontend-development</a></li>
<li><a href="../277549/index.html">MEGA Accelerator - a look into the future. Monologues of the participants</a></li>
<li><a href="../27755/index.html">Last.fm API</a></li>
<li><a href="../277559/index.html">How Relap.io is organized - a service that issues 30 billion recommendations per month</a></li>
<li><a href="../27756/index.html">Form Spam Bot Blocker: Protecting Web Forms Without CAPTCHA!</a></li>
<li><a href="../277563/index.html">Word2Vec: classification of text documents</a></li>
<li><a href="../277565/index.html">Framer Animation for Beginners</a></li>
<li><a href="../277567/index.html">Windows 10 application with data in the cloud using Azure Mobile Apps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>