<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Change UID & GID user and his files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I got here the task to change the user's UID and GID and correctly change the owner of all files. 
 The fact is that I work on two computers alternate...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Change UID & GID user and his files</h1><div class="post__text post__text-html js-mediator-article"><img src="http://www.picamatic.com/show/2010/01/23/05/19/6370900_bigthumb.png" alt="reuid.png - image uploaded to Picamatic" title="reuid.png" width="300" height="134" align="right"><br>  I got here the task to change the user's UID and GID and correctly change the owner of all files. <br>  The fact is that I work on two computers alternately, and the mysql files are on my flash drive.  It turned out that the user id of mysql on both computers is different and the muscle cannot access its files.  Assigning permissions to 0666 is boring, and on this occasion I decided to learn how to correctly change the user's uid :) <br><br>  It would seem that everything is simple, but there are two nuances that must be considered: <ol><li>  UID and GID are not always the same for a user and his group. </li><li>  Not all files belong simultaneously to the user mysql and the mysql group: files for chown need to be looked for separately </li></ol>  The article is written for those who have not done anything like this yet, and also who want to learn the advanced use of the find command and find out what xargs is. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Change user id and group </h5><br>  The first step is the simplest and much has been written about it on the Internet.  In the first two lines, we store useful data in variables: the name, the new id, and the old id for the user and for the group.  This will be useful to us later when searching files, as well as simplify the reuse of the script.  Everything is indicated separately in view of the first nuance: the UID and GID may differ. <br>  Next is a trivial change of identifiers with standard Linux commands: <br><blockquote>  <font color="#007800">user</font> = mysql <font color="#007800">new_uid</font> = <font color="#000000">600</font> <font color="#007800">old_uid</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">id</font> <font color="#660033">-u</font> <font color="#007800">$ user</font> <font color="#7a0874">)</font> <br>  <font color="#007800">group</font> = mysql <font color="#007800">new_gid</font> = <font color="#000000">600</font> <font color="#007800">old_gid</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">id</font> <font color="#660033">-g</font> <font color="#007800">$ user</font> <font color="#7a0874">)</font> <br>  <font color="#c20cb9">sudo</font> usermod <font color="#660033">-u</font> <font color="#007800">$ new_uid</font> <font color="#007800">$ user</font> <br>  <font color="#c20cb9">sudo</font> groupmod <font color="#660033">-g</font> <font color="#007800">$ new_gid</font> <font color="#007800">$ group</font> <br></blockquote><br><br><h5>  Search for orphaned files </h5><br>  If we now look at one of the folders with the mysql files (for example, <code>ls -lah /var/lib/mysql</code> ), we will see that the files belong to the suspicious user 112 and the suspicious group 127. We will look for such files in order to adopt them :) <br><br>  The first thing that comes to mind is to find all the files belonging to the user <code>$old_uid</code> <b>or the</b> group <code>$old_group</code> , and collect all the found files (using xargs) as arguments to the <code>chown $user:$group</code> .  <code>find</code> is executed from root to ensure that it can get into all even the most severely protected folders and find everything it needs.  <code>xargs</code> collects strings from pipe and passes them to the command specified in the argument (chown).  I note that <code>xargs</code> can execute a command several times to avoid an argument string that is too long. <br>  For example: <br><blockquote>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> <font color="#660033">-user</font> <font color="#007800">$ old_uid</font> <font color="#660033">-or</font> <font color="#660033">-group</font> <font color="#007800">$ old_gid</font> <font color="#660033">-print0</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> <font color="#007800">$ user</font> : <font color="#007800">$ group</font> </blockquote><br>  Immediately pay attention to the flags <code>find -print0</code> and <code>find -print0</code> <code>xargs -0</code> : this is such a struggle with possible spaces in the file names.  Such files can be perceived <code>chown</code> 'ohm as two different.  The first flag causes <code>find</code> to display every found file with zero at the end (the end-of-line character in C), and the second flag tells <code>xargs</code> that it needs to separate files from each other not by line breaks, but by this very zero, which guarantees correct processing of even the most tricky file names :) <br><br>  However, this method will not bring the desired result: some files owned by 'mysql: root' will belong to 'mysql: mysql'.  After all, we agreed to do everything perfectly right :) Therefore, the search by user and by group must be conducted separately. <br><br>  You can execute two find commands in succession: <br><blockquote>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> <font color="#660033">-user</font> <font color="#007800">$ old_uid</font> <font color="#660033">-print0</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> <font color="#007800">$ user</font> <br>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> <font color="#660033">-group</font> <font color="#007800">$ old_gid</font> <font color="#660033">-print0</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> : <font color="#007800">$ group</font> </blockquote><br>  and it will be much closer to the truth, but then <code>find</code> 'u will have to rustle twice over the entire hard disk. <br><br>  There is a way to force the <code>find</code> to perform two operations for us in parallel, reducing the number of reads from the disk exactly twice.  To do this, we use the grouping of conditions and <code>find</code> commands with parentheses (not forgetting to screen them: otherwise the shell will be taken for them) and sending the operator ‚Äúcomma‚Äù between them: then both brackets will be executed for each file. <br>  We will create two separate files: in the first there will be a list of files with <code>-user=$old_uid</code> , and in the second - with <code>-group=$old_gid</code> , and we will process these files separately.  The search condition is now divided into two brackets for each file, and if the condition is met, the <code>-fprint0</code> command writes the path to the found orphaned file to the corresponding temporary file. <br><blockquote>  <font color="#007800">chownlist</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">tempfile</font> <font color="#7a0874">)</font> <font color="#007800">chgrplist</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">tempfile</font> <font color="#7a0874">)</font> <br>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> \ <br>  \ <font color="#7a0874">(</font> <font color="#660033">-user</font> <font color="#007800">$ old_uid</font> <font color="#660033">-fprint0</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> \ <font color="#7a0874">)</font> , \ <font color="#7a0874">(</font> <font color="#660033">-group</font> <font color="#007800">$ old_gid</font> <font color="#660033">-fprint0</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> \ <font color="#7a0874">)</font> </blockquote><br>  After a short search all files will be found. <br><br>  The last moment of the search: the forums often ask the question how to exclude folders from the <code>find</code> list so that it does not climb there at all.  This is done using a combination of the <code>-path "folder"</code> condition and the <code>-prune</code> , which prevents <code>find</code> climbing into folders in the condition.  We exclude from the search the folders '/ proc' and '/ sys'. <br>  To do this, add another grouping in brackets to the conditions, separating them from the already existing brackets with the <code>-or</code> operator.  This operator will fulfill the first condition, and the second only if the first one does not work.  So, <code>find</code> will check if the directory excluded from the listing (in which it will not search) has got to it, and if it does not, it will make lists of files. <br>  This is done like this: <br><blockquote>  <font color="#007800">chownlist</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">tempfile</font> <font color="#7a0874">)</font> <font color="#007800">chgrplist</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">tempfile</font> <font color="#7a0874">)</font> <br>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> \ <br>  \ <font color="#7a0874">(</font> \ <font color="#7a0874">(</font> <font color="#660033">-path</font> <font color="#ff0000">"/ proc"</font> <font color="#660033">-or</font> <font color="#660033">-path</font> <font color="#ff0000">"/ sys"</font> \ <font color="#7a0874">)</font> <font color="#660033">-prune</font> \ <font color="#7a0874">)</font> <font color="#660033">-or</font> \ <font color="#666666"># exclude folders</font> <br>  \ <font color="#7a0874">(</font> \ <font color="#7a0874">(</font> <font color="#660033">-user</font> <font color="#007800">$ old_uid</font> <font color="#660033">-fprint0</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> \ <font color="#7a0874">)</font> , \ <font color="#7a0874">(</font> <font color="#660033">-group</font> <font color="#007800">$ old_gid</font> <font color="#660033">-fprint0</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> \ <font color="#7a0874">)</font> \ <font color="#7a0874">)</font> </blockquote><br><br>  Also in the exceptions, you can make the path to the disk with backup (because you have it, right?;), Mounted network spheres, and so on. <br><br><h5>  The finish </h5><br>  Everything lists are compiled.  Now for each list of files we execute <code>chown</code> .  Let me remind you that we tried to fully retain the owner of the files, taking into account the possibly different user and group. <br><blockquote>  <font color="#c20cb9">cat</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> <font color="#007800">$ user</font> <br>  <font color="#c20cb9">cat</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> : <font color="#007800">$ group</font> <br>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">rm</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> <font color="#666666"># Do not forget to clean up</font> </blockquote><br><br><h5>  Check </h5><br>  Finally, let's check if there are any files with unknown UIDs or GIDs left somewhere.  There are two useful conditions for this: <code>find -nouser</code> and <code>find -nogroup</code> .  It is also useful to refine the search by excluding the notorious '/ proc' and '/ sys' from the search: <br><blockquote>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> <font color="#660033">-nouser</font> <font color="#660033">-or</font> <font color="#660033">-nogroup</font> <font color="#660033">-print</font> </blockquote><br>  If everything was done correctly (and there were no orphaned files in the system), the team should not output anything. <br><br><h4>  Full script code </h4><br>  I hope the article will be useful.  I recommend closer familiarization with the syntax of this command: it is much more powerful than you think :) <br>  Finally, I will provide the full script code for changing the UID &amp; GID of the user and his files: <br><br><blockquote>  <font color="#666666"># === Settings</font> <br>  <font color="#007800">user</font> = mysql <font color="#007800">new_uid</font> = <font color="#000000">600</font> <font color="#007800">old_uid</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">id</font> <font color="#660033">-u</font> <font color="#007800">$ user</font> <font color="#7a0874">)</font> <font color="#666666"># name, new and old UID</font> <br>  <font color="#007800">group</font> = mysql <font color="#007800">new_gid</font> = <font color="#000000">600</font> <font color="#007800">old_gid</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">id</font> <font color="#660033">-g</font> <font color="#007800">$ user</font> <font color="#7a0874">)</font> <font color="#666666"># name, new and old GID</font> <br>  <font color="#666666"># === UID &amp; GID change</font> <br>  <font color="#c20cb9">sudo</font> usermod <font color="#660033">-u</font> <font color="#007800">$ new_uid</font> <font color="#007800">$ user</font> <br>  <font color="#c20cb9">sudo</font> groupmod <font color="#660033">-g</font> <font color="#007800">$ new_gid</font> <font color="#007800">$ group</font> <br>  <font color="#666666"># === Search for files</font> <br>  <font color="#007800">chownlist</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">tempfile</font> <font color="#7a0874">)</font> <font color="#007800">chgrplist</font> = $ <font color="#7a0874">(</font> <font color="#c20cb9">tempfile</font> <font color="#7a0874">)</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">find</font> <font color="#000000">/</font> \ <br>  \ <font color="#7a0874">(</font> \ <font color="#7a0874">(</font> <font color="#660033">-path</font> <font color="#ff0000">"/ proc"</font> <font color="#660033">-or</font> <font color="#660033">-path</font> <font color="#ff0000">"/ sys"</font> \ <font color="#7a0874">)</font> <font color="#660033">-prune</font> \ <font color="#7a0874">)</font> <font color="#660033">-or</font> \ <br>  \ <font color="#7a0874">(</font> \ <font color="#7a0874">(</font> <font color="#660033">-user</font> <font color="#007800">$ old_uid</font> <font color="#660033">-fprint0</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> \ <font color="#7a0874">)</font> , \ <font color="#7a0874">(</font> <font color="#660033">-group</font> <font color="#007800">$ old_gid</font> <font color="#660033">-fprint0</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> \ <font color="#7a0874">)</font> \ <font color="#7a0874">)</font> <br>  <font color="#666666"># === chown and brush</font> <br>  <font color="#c20cb9">cat</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> <font color="#007800">$ user</font> <br>  <font color="#c20cb9">cat</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> <font color="#000000">|</font>  <font color="#c20cb9">xargs</font> <font color="#660033">-0</font> <font color="#c20cb9">sudo</font> <font color="#c20cb9">chown</font> : <font color="#007800">$ group</font> <br>  <font color="#c20cb9">sudo</font> <font color="#c20cb9">rm</font> <font color="#ff0000">" <font color="#007800">$ chownlist</font> "</font> <font color="#ff0000">" <font color="#007800">$ chgrplist</font> "</font> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/81715/">https://habr.com/ru/post/81715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../81701/index.html">Linux Mint: we continue the conversation</a></li>
<li><a href="../81704/index.html">Steve Ballmer left autograph on MacBook Pro</a></li>
<li><a href="../81706/index.html">Motorola will have its Android Market</a></li>
<li><a href="../81711/index.html">Arrested the seller of "magic" explosives detectors</a></li>
<li><a href="../81713/index.html">Published system requirements for Office 2010</a></li>
<li><a href="../81716/index.html">Asynchronous http-client, or why multithreading is superfluous</a></li>
<li><a href="../81718/index.html">Wikipedia's FLOSS Weekly page faces deletion</a></li>
<li><a href="../81721/index.html">Believing you can be smarter is making you smarter.</a></li>
<li><a href="../81724/index.html">Linux security, think about the future</a></li>
<li><a href="../81725/index.html">What will tell your personal experience: how to twitter in different languages?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>