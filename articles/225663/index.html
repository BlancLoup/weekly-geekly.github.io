<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a bot for the Stronghold Kingdoms</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="History of writing bot for Stronghold Kingdoms 
 For a long time I approached the question of writing a bot for this game, but I didn‚Äôt have enough ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a bot for the Stronghold Kingdoms</h1><div class="post__text post__text-html js-mediator-article"><h5>  History of writing bot for Stronghold Kingdoms </h5><br>  For a long time I approached the question of writing a bot for this game, but I didn‚Äôt have enough experience, I was too lazy, I tried to come from the wrong side. <br>  As a result, having gained experience in writing and reverse developing C # code, I decided to achieve my goal. <br><br>  Yes, as you may have noticed, C # is not casual - the game is written on it, using .net 2.0, which later put some sticks in my wheels. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/20f/ad3/1e9/20fad31e952cfe8b26369ea8676bbace.png"><br>  Initially, I thought of writing a socket bot, which would only emulate a network protocol (which is not encrypted in any way), and having ‚Äúsource codes‚Äù (the result of il-code decompilation) is easily restored in a third-party application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But it seemed to me tedious and dreary, because why fence the bike, if there are those "source codes". <br><br>  Armed with Reflector, I started to deal with the entry point of the game (the code of which has not been obfuscated at all for more than three years, I wonder developers) - nothing special. <br><a name="habracut"></a><br><h6>  Analysis and partly wrong decision. </h6><br>  Obviously, the game project was originally created as a console application: <br><br>  private static void Main (string [] args) as an entry point and its Program class hint at this, a class, by the way, is also private. <br><br>  First of all, I rushed to make the class and method public, again with Reflexor‚Äôs forces, with Reflexil added to it, without knowing what to expect. <br><br>  But suddenly I ran into a launcher who was downloading the modified file. <br>  Without briefly fighting with him with the same Reflector and carrying out an autopsy, I pulled out the installation code of the arguments passed to the executable game file: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DDText.getText(<span class="hljs-number"><span class="hljs-number">0x17</span></span>) == <span class="hljs-string"><span class="hljs-string">"XX"</span></span>) parameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"-InstallerVersion"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"st"</span></span> }; <span class="hljs-comment"><span class="hljs-comment">// st == steam else parameters = new string[] { "-InstallerVersion", "", "" }; parameters[1] = SelfUpdater.CurrentBuildVersion.ToString(); parameters[2] = DDText.getText(0); // ,     ,   ‚Äúru‚Äù, ‚Äúde‚Äù, ‚Äúen‚Äù  ..    local.txt   . UpdateManager.SetCommandLineParameters(parameters); //        System.Diagnostics.Process UpdateManager.StartApplication();</span></span></code> </pre> <br><br>  Parse: <br><br>  <code>if (DDText.getText(0x17) == "XX")</code> - A string from the local.txt file next to the launcher. <br>  So they have a strange test on steam / no-steam version: X - not Steam, XX - Steam.  : \ <br>  <code>parameters[1] = SelfUpdater.CurrentBuildVersion</code> - The launcher version is quietly twitching from it, although the check in the client is strange, as I learned later, and you can simply specify a number much larger than the current one, ‚Äúin reserve‚Äù, since  The check goes only to obsolescence, so skazat, versions through the comparison of numbers "less-more". <br>  <code>parameters[2] = DDText.getText(0)</code> - Having forged the version, I learned that it is the language of the game, in the format of ‚Äúru‚Äù, ‚Äúde‚Äù, ‚Äúen‚Äù, etc. <br>  It is also loaded from the local.txt file. <br><br>  By the way, the version of the launcher looks something like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelfUpdater</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { currentBuildVersion = <span class="hljs-number"><span class="hljs-number">0x75</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 117, .. 1.17   . }</span></span></code> </pre><br><br>  And he made a magic batch file: <br><br> <code>StrongholdKingdoms.exe -InstallerVersion 117 ru</code> <br> <br>  Although it is possible and so: <br><br> <code>StrongholdKingdoms.exe -InstallerVersion 100500 ru</code> <br> <br>  What I said a little higher. <br><br>  So, what we have: a slightly modified client and launcher bypass system, if you can call it that. <br>  Having tried to start it all, I see that the game works and my patches did not harm it (although why would they harm them). <br><br>  After that, I tried to connect the executable file of the game to the project as a class library and connect the namespace of the game - Kingdoms. <br><br>  Then I cracked a lot of code: I tried to call Main, and emulate the Programm class, but for some reason the game crashed with a runtime that wasn‚Äôt enough for the framework when I tried to make it work. <br>  He referred to the fact that the game uses many non-C # libraries and a lot of unsafe code.  I did not find any real reasons. <br><br><h6>  The right decision </h6><br>  Having tormented for a long time and not finding a solution, I already spat.  But for some reason I remembered the fork of the Terraria server - TShock (yeah, fork, as well - the guys also had fun with the decompiler) and its loading of modules (mods \ plug-ins) from the DLL. <br><br>  This idea seemed interesting to me.  Googling and found a way and code. <br>  Having slightly penetrated into it and having checked it in my own project, I was horrified to find that it works (suddenly!). <br>  Actually, the code: <br><br><pre> <code class="cs hljs">System.Reflection.Assembly A = System.Reflection.Assembly.LoadFrom(System.Windows.Forms.Application.StartupPath + <span class="hljs-string"><span class="hljs-string">@"\BotDLL.dll"</span></span>); Type ClassType = A.GetType(<span class="hljs-string"><span class="hljs-string">"BotDLL.Main"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Obj = Activator.CreateInstance(ClassType); System.Reflection.MethodInfo MI = ClassType.GetMethod(<span class="hljs-string"><span class="hljs-string">"Inject"</span></span>); MI.Invoke(Obj, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br><br>  Let's sort the code: <br>  <code>System.Reflection.Assembly</code> - This is the thing that is responsible for creating links to files when connecting them to the project, only from code.  And it also stores information about the versions of your project and copyrights (yes, the same AssemblyInfo.cs in all your projects). <br>  <code>Assembly.LoadFrom(System.Windows.Forms.Application.StartupPath + @"\BotDLL.dll")</code> - Load our library. <br>  Then we call the function inside this class Inject (), which is essentially the beginning of the bot.  =) <br>  I tried the code that I sketched in a third-party application - inject worked. <br><br><h6>  Client patching </h6><br>  Now we come to the most interesting part - we introduce the calling code into the game. <br>  Having tried to stick it into the impudent one into Main through the replacement of the code with the help of Reflexil, the patch that was not patched as a result of decompilation was successfully sent.  Well, or I just was lazy, it does not matter. <br>  I went to search in this very Main for guaranteed calling of third-party functions (outside the main if branches, etc.) rather quickly found a call to the MySettings.load () function, which loaded the settings of the game when it started. <br>  But again, there was a mountain of code that did not want to compile without tambourines. <br>  But by luck, next to it is the hasLoggedIn () boolean function which returns the only bool value just when the game is started: <br> <code>return (this.HasLoggedIn || (this.Username.Length &gt; 0));</code> <br>  I was immediately delighted and this function was immediately converted to this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsStarted) { System.Reflection.Assembly A = System.Reflection.Assembly.LoadFrom(System.Windows.Forms.Application.StartupPath + <span class="hljs-string"><span class="hljs-string">@"\BotDLL.dll"</span></span>); Type ClassType = A.GetType(<span class="hljs-string"><span class="hljs-string">"BotDLL.Main"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Obj = Activator.CreateInstance(ClassType); System.Reflection.MethodInfo MI = ClassType.GetMethod(<span class="hljs-string"><span class="hljs-string">"Inject"</span></span>); MI.Invoke(Obj, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); IsStarted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.HasLoggedIn || (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Username.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre><br><br>  We will deal with it. <br>  if (! IsStarted) - we had to add this check, and for this we need to add an additional field to the MySettings class, since our function is called more than once, and we don‚Äôt really need several bot threads.  This is done all the same Reflexil'om. <br>  Well, the main code we have already disassembled a little higher. <br>  And in the end we return what was there to be.  =) <br><br><h6>  So - the bot itself </h6><br>  Inject function: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Inject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AllocConsole(); Console.Title = <span class="hljs-string"><span class="hljs-string">"SHKBot"</span></span>; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"DLL !"</span></span>); Thread Th = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(SHK); Th.Start(); BotForm FBot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BotForm(); FBot.Show(); } ‚Ä¶ [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>: MarshalAs(UnmanagedType.Bool)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllocConsole</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br><br>  First we call the open console window function - it will be easier for debugging. <br>  After we launch the stream with our main bot cycle - SHK (); <br>  And at the same time we open the bot control form for convenience. <br><br>  Next thing is small - to implement the functionality you need. <br>  Here is the rest of my code - here I implemented an automated trading system. <br>  In order for it to work, you first need to ‚Äúcache‚Äù the villages in each session ‚Äî open each of the villages you are going to trade. <br>  This code helps doubtfully, and I haven‚Äôt got to the bottom of other ways of automatically downloading villages: <br><br><pre> <code class="cs hljs">InterfaceMgr.Instance.selectVillage(VillageID); GameEngine.Instance.downloadCurrentVillage();</code> </pre><br><br>  Here is the SHK function code: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SHK</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">" !"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!GameEngine.Instance.World.isDownloadComplete()) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"   !"</span></span>); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 5 sec Console.Clear(); } Console.WriteLine(" !    ."); Console.WriteLine("\n======| DEBUG INFO |======"); Console.WriteLine(RemoteServices.Instance.UserID); Console.WriteLine(RemoteServices.Instance.UserName); List&lt;int&gt; VillageIDs = GameEngine.Instance.World.getListOfUserVillages(); foreach (int VillageID in VillageIDs) { WorldMap.VillageData Village = GameEngine.Instance.World.getVillageData(VillageID); Console.WriteLine("[] " + Village.m_villageName + " - " + VillageID); InterfaceMgr.Instance.selectVillage(VillageID); GameEngine.Instance.downloadCurrentVillage(); } Console.WriteLine("======| ========== |======\n"); while (true) { try { //   -   } catch (Exception ex) { Console.WriteLine("\n======| EX INFO |======"); Console.WriteLine(ex); Console.WriteLine("======| ======= |======\n"); } } }</span></span></code> </pre><br></div></div><br>  Code of control form: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Drawing; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Kingdoms; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.CodeDom.Compiler; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.CSharp; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BotDLL</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BotForm</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { Thread TradeThread; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsTrading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Text</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(Text); richTextBox_Log.Text = Text + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> + richTextBox_Log.Text; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BotForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CheckForIllegalCrossThreadCalls = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; InitializeComponent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Show(); Log(<span class="hljs-string"><span class="hljs-string">"  ."</span></span>); listBox_ResList.SelectedIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; Log(<span class="hljs-string"><span class="hljs-string">"  ..."</span></span>); TradeThread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(Trade); TradeThread.Start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button_Trade_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         if (GameEngine.Instance.World.isDownloadComplete() &amp;&amp; textBox_TradeTargetID.Text.Length &gt; 0) { try { if (!IsTrading) //    { button_Trade.Text = ""; IsTrading = true; //   } else //   { button_Trade.Text = ""; IsTrading = false; } } catch (Exception ex) { Console.WriteLine("\n======| EX INFO |======"); Log(ex.ToString()); Console.WriteLine("======| ======= |======\n"); } } } public void Trade() { Log("  !"); int Sleep = 0; while (true) //   { Sleep = 60 + new Random().Next(-5, 60); if (IsTrading) { Log("[" + DateTime.Now + "]   \"" + listBox_ResList.SelectedItem.ToString() + "\""); //  ID    int ResID = int.Parse(listBox_ResList.SelectedItem.ToString().Replace(" ", "").Split('-')[0]); int TargetID = int.Parse(textBox_TradeTargetID.Text); //  ID - List&lt;int&gt; VillageIDs = GameEngine.Instance.World.getListOfUserVillages(); //     foreach (int VillageID in VillageIDs) //   { //    (       ) if (GameEngine.Instance.getVillage(VillageID) != null) { //       WorldMap.VillageData Village = GameEngine.Instance.World.getVillageData(VillageID); VillageMap Map = GameEngine.Instance.getVillage(VillageID); //    int ResAmount = (int)Map.getResourceLevel(ResID); // -    int MerchantsCount = Map.calcTotalTradersAtHome(); // -    Log("  " + VillageID + "  " + MerchantsCount + " "); //  int SendWithOne = int.Parse(textBox_ResCount.Text); // -    int MaxAmount = MerchantsCount * SendWithOne; // -   if (ResAmount &lt; MaxAmount) //        MerchantsCount = (int)(ResAmount / SendWithOne); //      if (MerchantsCount &gt; 0) //     { TargetID = GameEngine.Instance.World.getRegionCapitalVillage(Village.regionID); //   ,  textBox_TradeTargetID.Text = TargetID.ToString(); //        GameEngine.Instance.getVillage(VillageID).stockExchangeTrade(TargetID, ResID, MerchantsCount * SendWithOne, false); AllVillagesPanel.travellersChanged(); //   ( )  GUI- } } } Log("    " + Sleep + "   " + DateTime.Now.AddSeconds(Sleep).ToString("HH:mm:ss")); Console.WriteLine(); } Thread.Sleep(Sleep * 1000); // ,   .   . } } private void BotForm_FormClosing(object sender, FormClosingEventArgs e) { try { TradeThread.Abort(); } catch {} } private void button_MapEditing_Click(object sender, EventArgs e) { button_MapEditing.Text = (!GameEngine.Instance.World.MapEditing).ToString(); GameEngine.Instance.World.MapEditing = !GameEngine.Instance.World.MapEditing; } private void button_Exec_Click(object sender, EventArgs e) { if (richTextBox_In.Text.Length == 0 || !GameEngine.Instance.World.isDownloadComplete()) return; richTextBox_Out.Text = ""; // *** Example form input has code in a text box string lcCode = richTextBox_In.Text; ICodeCompiler loCompiler = new CSharpCodeProvider().CreateCompiler(); CompilerParameters loParameters = new CompilerParameters(); // *** Start by adding any referenced assemblies loParameters.ReferencedAssemblies.Add("System.dll"); loParameters.ReferencedAssemblies.Add("System.Data.dll"); loParameters.ReferencedAssemblies.Add("System.Windows.Forms.dll"); loParameters.ReferencedAssemblies.Add("StrongholdKingdoms.exe"); // *** Must create a fully functional assembly as a string lcCode = @"using System; using System.IO; using System.Windows.Forms; using System.Collections.Generic; using System.Text; using Kingdoms; namespace NSpace { public class NClass { public object DynamicCode(params object[] Parameters) { " + lcCode + @" return null; } } }"; // *** Load the resulting assembly into memory loParameters.GenerateInMemory = false; // *** Now compile the whole thing CompilerResults loCompiled = loCompiler.CompileAssemblyFromSource(loParameters, lcCode); if (loCompiled.Errors.HasErrors) { string lcErrorMsg = ""; lcErrorMsg = loCompiled.Errors.Count.ToString() + " Errors:"; for (int x = 0; x &lt; loCompiled.Errors.Count; x++) lcErrorMsg = lcErrorMsg + "\r\nLine: " + loCompiled.Errors[x].Line.ToString() + " - " + loCompiled.Errors[x].ErrorText; richTextBox_Out.Text = lcErrorMsg + "\r\n\r\n" + lcCode; return; } Assembly loAssembly = loCompiled.CompiledAssembly; // *** Retrieve an obj ref ‚Äì generic type only object loObject = loAssembly.CreateInstance("NSpace.NClass"); if (loObject == null) { richTextBox_Out.Text = "Couldn't load class."; return; } object[] loCodeParms = new object[1]; loCodeParms[0] = "SHKBot"; try { object loResult = loObject.GetType().InvokeMember( "DynamicCode", BindingFlags.InvokeMethod, null, loObject, loCodeParms); //DateTime ltNow = (DateTime)loResult; if (loResult != null) richTextBox_Out.Text = "Method Call Result:\r\n\r\n" + loResult.ToString(); } catch (Exception ex) { Console.WriteLine("\n======| EX INFO |======"); Console.WriteLine(ex); Console.WriteLine("======| ======= |======\n"); } } } }</span></span></code> </pre><br></div></div><br><br>  Initially, I wanted to plug into the NLua bot (Lua library for C #), but since it supports only 3.5+ frameworks, I for some reason did not want to use the old versions so I did: <br>  For convenience, I entered the execution of the code in real time at the Sharp itself - I was tired of restarting the game after recompiling time after time. <br>  Used <a href="http://www.west-wind.com/presentations/dynamicCode/DynamicCode.htm">this tutorial</a> . <br><br><h6>  Total </h6><br>  Advantages of such a decision: <br><ol><li>  Access to all game code, as if you have its source code. </li><li>  You can make your own premium card system with a queue of buildings, studying research without restrictions and even more: <br><ul><li>  The algorithm for the resale of goods among the regions surrounding you. </li><li>  Autobuilding the village "on the layout" removed from the already existing, as an example. </li><li>  Auto-time of various units. </li><li>  Avtopochinki castle while you are not. </li><li>  Automatic collection of guaranteed cards for the time. </li></ul><br></li><li>  And of course the dynamic execution of the code. </li><li>  Funny detection protection.  Well, a couple of conditions in order not to send suspicious requests-dummy. </li></ol><br>  Minuses: <br><ol><li>  We'll have to patch the client with each version handles.  Or, you can write a patcher using Mono.Cecil or an analogue in the framework. </li><li>  Unlike premium cards, you have to keep the client always on and online. </li><li>  The game is rather big, so it‚Äôs definitely not an hour to learn the ‚ÄúAPI‚Äù.  Although if desired, and tools versed in years - there would be a desire.  And in any case, better than messing with packages. </li></ol><br><br>  Here is the whole thing: <br><img src="https://habrastorage.org/getpro/habr/post_images/891/718/f32/891718f328c638f31b8ced5c36a62c86.png"><br><br>  Interested recommend to look at the following classes of the game: <br><div class="spoiler">  <b class="spoiler_title">Class list</b> <div class="spoiler_text"><ul><li>  Gameengine </li><li>  GameEngine.Instance </li><li>  GameEngine.Instance.World </li><li>  Worldmap </li><li>  WorldMap.VillageData </li><li>  Remoteservice </li><li>  RemoteServices.Instance </li><li>  AllVillagesPanel </li><li>  Villagemap </li></ul><br></div></div><br><br>  At the time of this writing, the game version was 2.0.18.6. <br>  You can download this particular version with the executable file of the game and the bot <a href="http://rghost.ru/56224163">here</a> . <br>  Do not worry, do not steal personal data.  =) I'm tired of the game, so I share with the community experience. <br><br>  Source codes are available <a href="https://github.com/Riketta/Stronghold-Kingdoms-Bot">here</a> . <br>  If you are thinking of using source codes - use a clean executable file (not patched by you) as a class library, and also disable copying this link to the final directory, so as not to accidentally replace the patched one. <br><br>  I apologize for the writing style of the article - I am writing for the first time.  Perhaps I‚Äôm jumping a lot from topic to topic, or I‚Äôm describing few technical aspects. <br>  It may seem to you that there is a lot of water here, but this article was originally conceived as a small story - probably therefore. </div><p>Source: <a href="https://habr.com/ru/post/225663/">https://habr.com/ru/post/225663/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225653/index.html">MIDI Wavy: make controlled color music using Arduino and MIDI</a></li>
<li><a href="../225655/index.html">Syncthing sync + installer review on Raspberry Pi and Macbook</a></li>
<li><a href="../225657/index.html">How to legalize income from Google AdSense for PI</a></li>
<li><a href="../225659/index.html">AngularJS. Data organization</a></li>
<li><a href="../225661/index.html">Space cycles in radioactive decay</a></li>
<li><a href="../225665/index.html">WWDC 2014: personal experience</a></li>
<li><a href="../225667/index.html">Installing the latest RedMine + Apache + nginx</a></li>
<li><a href="../225669/index.html">Interactive online game of HTML, CSS and JavaScript</a></li>
<li><a href="../225671/index.html">Seeedstudio Wifi Bee Engine Management</a></li>
<li><a href="../225673/index.html">NASA in search of innovative ideas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>