<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Infrastructure with Kubernetes as an affordable service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes has become for us the technology that fully meets the stringent requirements for resiliency, scalability and quality service of the project...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Infrastructure with Kubernetes as an affordable service</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/fc/n2/kn/fcn2knccivnf6xi_btlln_0tbxg.jpeg"><br><br>  Kubernetes has become for us the technology that fully meets the stringent requirements for resiliency, scalability and quality service of the project.  Despite the fact that today K8s is <a href="https://habrahabr.ru/company/flant/blog/340270/">more common</a> in large organizations and projects, we have learned how to use it in small applications.  Reducing the cost of service has become possible for us due to the unification and generalization of all components that are found in virtually every client.  This article is a look at the experience gained from business needs and their technical implementation, which allows us to offer customers a quality solution and support for reasonable money. <a name="habracut"></a><br><br><h2>  "Rocket science" as the norm </h2><br>  I will begin with general words about how we came to this in general, and an overview of the technical details on the proposed infrastructure, read below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For about 10 years, ‚ÄúFlant‚Äù has been involved in the system administration of GNU / Linux and countless related technologies and software.  All this time we have been improving our work processes, often <b>comparing a company with a plant</b> that goes from manual labor (the need to ‚Äúmanually‚Äù go to the server when a lot of the same problems occur) to stream production (typical configurations, centralized management, automatic deployment, etc. .).  Even in spite of the fact that many of the projects we serve, are very different (in the stack of the applied technologies, requirements for performance and scaling ...), they have a foundation that needs to be systematized.  This fact makes it possible to turn quality service into a standard service, providing the client with additional benefits for reasonable money. <br><br>  Growing the best practices within the company based on the experience of working with different projects, summarizing them and, if possible, ‚Äúprogramming‚Äù them, we extend these results to other existing installations.  Previously, the configuration management system served as the key tool (we preferred Chef).  Gradually introducing the Docker-containers into the infrastructure, we went to the logical step of integrating their settings with the capabilities of Chef (implemented this as part of our <a href="https://habrahabr.ru/company/flant/blog/333682/">dapp</a> tool) ... <br><br>  But with the advent of Kubernetes, much has changed.  Now we describe the configurations in Kubernetes and <b>obtain (offer to customers) an infrastructure</b> that: <br><br><ul><li>  centrally controlled, </li><li>  quickly turns around </li><li>  easily complemented by new services, </li><li>  does not depend on the resource provider (cloud provider, data center), </li><li>  scaled in cases of project complexity or increasing loads, </li><li>  simply integrates with modern processes and technologies for continuous integration and application delivery (CI / CD). </li></ul><br>  This approach to infrastructure is the result of our long search for an optimal solution, countless trial and error, a truly multifaceted experience in servicing IT systems.  This is our current vision of a reasonable "norm" for projects of different scales. <br><br>  The frequent feeling that then arises from business owners: ‚ÄúWell, that sounds cool, but this is some kind of rocket science, and it‚Äôs not for us, because it‚Äôs too complicated and expensive.‚Äù  However, our experience shows that this ‚Äúrocket science‚Äù is ideal even for those who think that they are still ‚Äúnot at that level‚Äù for the implementation of Kubernetes: <br><br><ol><li>  <b>Benefit</b> - an infrastructure that not only just works, is repaired in case of accidents and gradually (as required) improves ... This is an infrastructure that by its ‚Äúnature‚Äù covers all needs for resiliency, scalability and development support (any test circuits, deploy, CI / Cd).  It is built on the best practices of DevOps and Open Source components that are industry standard. </li><li>  <b>Complexity</b> is our area of ‚Äã‚Äãresponsibility, which lies precisely in, on the contrary, making the result as simple as possible for users, i.e.  developers. </li><li>  <b>Cost</b> - the usual monthly subscription fee for servicing such a typical infrastructure for a small project ranges from 80 to 120 thousand rubles, which is comparable to hiring one ‚Äúconditionally average‚Äù Linux engineer. </li></ol><br>  What we understand by a small project and what are its needs are described in the next paragraph, from which the story about the structure of a typical infrastructure begins. <br><br><h2>  Technical details </h2><br><h3>  What a "small project"? </h3><br>  The architecture considered in the article has already been implemented in a variety of projects of various kinds: media, online stores, online games, social networks, blockchain platforms, etc. <br><br>  What is a small project for which it is designed?  The criteria are not very strict, but indicate the main trends and requirements: <br><br><ul><li>  This is a project that already has more than 1 server (the upper bound is incorrect to call, since the architecture can be deployed on multiple servers). </li><li>  The project already requires resiliency, as it is a business tool and makes a profit. </li><li>  The project should be ready for high loads, and there is a real need for the possibility of rapid scaling (for example, an online store should temporarily increase server capacity before Black Friday). </li><li>  The project already requires a system administrator, because without it, nothing happens. </li></ul><br>  If we briefly describe the architecture as a whole, then we can say that it is ‚Äúa fault-tolerant and scalable Docker-container cloud that is managed by Kubernetes‚Äù.  And that's what it is ... <br><br><h3>  Kubernetes app </h3><br>  Hereinafter I will take as an example a typical online store.  Imagine that there are 3 servers on which a Kubernetes cluster is deployed.  Kubernetes is the main component of the architecture, it is the component that deals with the orchestration and management of Docker containers.  It is responsible for the reliable, fault-tolerant and scalable operation of the containers within which the client application runs.  Those.  in essence, this is a cloud of containers running on three servers.  If one of the servers on which the cloud runs fails, then Kubernetes automatically throws the fallen containers (running on the fallen server) onto the remaining two servers - this happens very quickly, within a few seconds. <br><br><img src="https://habrastorage.org/webt/88/5q/3y/885q3ybgmqdui3j59sjeh2y6s6s.png"><br><br>  Our goal - the fall of a single server or even two servers in the cloud should be an imperceptible event.  This is achieved due to the fact that each component is duplicated at least once and, within the cloud, instances of the same component are located on different servers.  In this case, the backup component is ready to instantly take the load on itself.  If the application supports, then it is possible that all instances of the component are working at the same time, and not in the main-reserve mode.  It is also possible to click on the button ‚Äúscale‚Äù and get another one-two-three or more additional copies of this component. <br><br>  Imagine that an online store is written in PHP and has the following components *: <br><br><ul><li>  MySQL database; </li><li>  PHP backend; </li><li>  caching in memcached; </li><li>  RabbitMQ queue; </li><li>  order storage in Redis; </li><li>  consumer accountant </li><li>  cron tasks </li></ul><br>  <i>* In fact, it‚Äôs not so important, an online store or media site, and even the components themselves may be completely different, but the essence will remain the same.</i> <br><br>  As you might have guessed, part of our work is to pack the application (in this case, the online store) into Docker containers, and then launch these containers in the Kubernetes cloud.  In addition to the application itself (PHP backend), other components work in the cloud: memcached, RabbitMQ, etc. <br><br>  <i><b>Note</b> : We still do not install RDBMS in production inside the Kubernetes cloud for some technological reasons.</i>  <i>However, they began to make the first such installations for small projects and applications not in production (dev circuits, etc.).</i> <br><br><img src="https://habrastorage.org/webt/_s/a3/rb/_sa3rbhxxcqs7q_lobhoevedhcm.png"><br><br>  All projects often have about the same component stack, and the differences are more likely to be in programming languages ‚Äã‚Äãand databases.  The implementation of Kubernetes gave us a good opportunity to implement a typical configuration of each of these components, which is suitable for any project.  At the same time, such a typical component is itself fault tolerant, easily scaled, and also placed in any Kubernetes cluster within 5 minutes.  For example, consider each of the components separately. <br><br><h4>  Database </h4><br>  DBMS are separated into a separate entity, since in most cases they are outside of Kubernetes and usually represent 2 or 3 servers that operate in the master-slave mode (MySQL, PostgreSQL, ...) or master-master (Percona XtraDB), with automatic or manual failover in case of emergency. <br><br><h4>  PHP backend </h4><br>  A backend is an application code that is packaged in a Docker container.  The necessary libraries and software for the application are installed in this container (for example, PHP 7).  The same container is used to run consumer and cron tasks.  In Kubernetes, we run several instances of the backend, one crowns and several consumer items. <br><br><h4>  Memcached </h4><br>  With memcached, we have historically developed two options for implementation that are used in various situations: <br><br><ul><li>  N separate memcached instances (usually 3).  The application knows about all three memcached and writes to all three, itself provides failover. </li><li>  <a href="https://github.com/facebook/mcrouter">Mcrouter</a> is a universal option that will suit any application.  The logic of the distributed record and failover is removed from the application to the mcrouter side. </li></ul><br><h4>  RabbitMQ </h4><br>  We use the RabbitMQ regular cluster of three or more nodes with automatic failover at the Kubernetes level. <br><br><h4>  Redis </h4><br>  At the heart of this component, we use the regular Redis Sentinel cluster, which has some binding, which saves the application from having to implement the sentinel protocol. <br><br><h4>  Other application services </h4><br>  Similarly, we have ready-to-use and tested components in our arsenal, such as minio, sphinxsearch, elasticsearch, and many others.  Almost any software can be installed inside Kubernetes - the main thing is to approach this process wisely. <br><br><h4>  Utility Components </h4><br>  Each project also has the following service components Kubernetes: <br><br><ul><li> A control panel (dashboard), which gives developers the ability to control components.  You can also get into containers through it - almost as in SSH. </li><li>  Centralized log storage.  Logs are collected in real time from all components in all circuits, logs are written into a single database.  A web interface is available with the ability to view all logs in real time, search and filter by various parameters.  <i>To do this, use its own Open Source solution loghouse, more about which read in <a href="https://habrahabr.ru/company/flant/blog/341386/">this announcement</a> .</i> </li><li>  Monitoring on Prometheus + Okmeter.  Prometheus is installed inside Kubernetes and collects statistics from all components.  In addition to the standard parameters (memory, disk, CPU), metrics are also removed from Apache / php-fpm, RabbitMQ, Redis, etc.  - each component is separately monitored.  Okmeter stands outside Kubernetes and monitors the servers themselves from the outside. </li></ul><br><h3>  Architecture and stateless consulting </h3><br>  As a rule, projects that come to us initially have problems with the architecture - first of all, with scaling due to the storage of files or intermediate data on disk, local storage of sessions and many other reasons.  The biggest and hardest part of the job is to help developers redo the application so that it becomes stateless. <br><br>  If it is completely ‚Äúon the fingers‚Äù, it means that each component of the application does not store intermediate data, or this data is of little importance and can be lost without serious consequences.  This is necessary so that you can run several backends and if one of them suddenly fails, nothing would break, no files uploaded by users would be deleted, etc. <br><br>  The most common reasons that prevent a stateless application from being made are: <br><br><ol><li>  Local storage of sessions on the backend (in files).  This issue is almost always solved by simply rendering sessions to fail-safe memcached (either through PHP settings or through application settings). </li><li>  Local storage of boot files on the backend.  The issue is resolved by using dedicated file storage (for example, Amazon S3 or file storage from Selectel) or options with storage on client servers implemented on minio or Ceph (S3 / Swift API). </li></ol><br>  The answer to the emerging concerns about such a stateless future (yes, you really have to spend the resources of developers on changes in the application for this) is that it is inevitable anyway (for applications that need scaling) and that you can approach it step by step. <br><br><h3>  Other problems and features </h3><br><h4>  CI / CD </h4><br>  Finally, a logical question arises: how is the application code deployed to such an infrastructure?  It is arranged as follows: <br><br><ol><li>  The code is under control of the versioning system (Git). </li><li>  We use GitLab * to invoke the Docker container after a code commit. </li><li>  After the build phase in GitLab, a ‚Äúroll out to production‚Äù button appears. </li><li>  We press this button - the new version of the application rolls out and starts, the old version stops, the rollout happens seamlessly and seamlessly for the site user.  Also during rollout, database migrations are performed. </li></ol><br>  There are namespaces in Kubernetes.  They can be thought of as separate, isolated contours or environments that run in a single cluster.  That is, we have the opportunity to make a separate contour for staging, for the master branch ... or, in general, for each branch to make our own separate contour.  The contour is a complete copy of production: there are all the same components (MySQL, backends, Redis, RabbitMQ, etc.).  This is achieved due to the fact that the entire infrastructure configuration (configuration of all components) is described in special YAML files and lies in the repository, that is, we are able to quickly and completely recreate the production environment in any other namespace. <br><br><img src="https://habrastorage.org/webt/qj/iw/sn/qjiwsnda4vosbjdaqmrmsjnpavo.png"><br><br>  <i>* An example of our pipeline in GitLab CI and technical details of its implementation can be found in <a href="https://habrahabr.ru/company/flant/blog/332712/">this article</a> .</i> <br><br><h4>  Servers </h4><br>  The most typical installation is 3 hypervisor servers that have approximately the following configuration: E5-1650v4, 128G RAM, 2 √ó 500 GB SSD.  Servers are interconnected by a local network.  The resources of each server are divided by virtual machines (Linux KVM + QEMU) into the following parts: <br><br><ul><li>  production loop; </li><li>  dev contours; </li><li>  Kubernetes utility services (masters and fronts); </li><li>  database. </li></ul><br><h4>  Backup </h4><br>  We will back up everything that is required in the project: databases, upload-files, etc.  There is no downtime during the backup (for the DBMS, the data is removed from the slave server, etc.).  The backup plan and its monthly testing is consistent with the client - the personal project manager is responsible for this. <br><br><h4>  Monitoring and Interaction </h4><br>  These are not always technical issues, but they are important for understanding the full picture of the support being implemented: <br><br><ul><li>  Thanks to our monitoring tools, all alerts flock to a centralized interface for engineers on duty.  Each incident must be processed, each must have a summary.  We guarantee a reaction to alerts within 15 minutes, while our average response time to an alert is 1 minute (and 10 minutes for a triage).  Duty engineers around the clock in touch by phone, Slack, mail, ticket system (Redmine). </li><li>  Each of our projects has a dedicated manager, as well as a dedicated team of engineers, which includes both a leading engineer and ordinary engineers, and junior engineers.  These people do not change - they ‚Äúlive‚Äù with the project from the very beginning and fully understand how it works. </li><li>  We offer SLA guarantees implying fines for a simple business critical infrastructure. </li></ul><br><h2>  Summarizing </h2><br>  We believe that modern infrastructure solutions of the cloud native category can work for the benefit now and for all, and the cost of their use should not be comparable to the price of a spacecraft.  You can draw an analogy with mobile communication: if before cellular communication was available only to the elect, today it is commonplace and a given, and the price for communication is low. <br><br>  Having traveled from ‚Äúmanual‚Äù administration of ‚Äúeverything on Linux‚Äù to supporting modern infrastructure based on Kubernetes, we are striving to ensure that the service, which we consider to be a reasonable ‚Äúnorm‚Äù, is accessible to clients with any budget.  Therefore, we offer a dedicated team of specialists to implement / maintain such infrastructure according to DevOps principles (in close cooperation with developers) with round-the-clock support and guarantees on SLA within the budget at the salary level of the system administrator / DevOps engineer hired for staff. <br><br>  Many technical aspects of the infrastructure discussed here (and related best practices) are subject to considerable detail, but this is a story for individual articles: and if some of them have already been published on our blog, then requests for new ones are welcome in the comments.  We will be happy and questions not on technology, but on the processes we use in our work and / or to our clients as part of our service. <br><br><h2>  PS </h2><br>  Read also in our blog: <br><br><ul><li>  " <a href="https://habrahabr.ru/company/flant/blog/331188/">Our experience with Kubernetes in small projects</a> " <i>(video of the report, which includes an introduction to the technical device Kubernetes);</i> </li><li>  Cycle about the success stories of Kubernetes in production: ‚Äú <a href="https://habrahabr.ru/company/flant/blog/334140/"># 1: 4200 pods and TessMaster from eBay</a> ‚Äù, ‚Äú <a href="https://habrahabr.ru/company/flant/blog/334770/"># 2: Concur and SAP</a> ‚Äù, ‚Äú <a href="https://habrahabr.ru/company/flant/blog/335814/"># 3: GitHub</a> ‚Äù, ‚Äú <a href="https://habrahabr.ru/company/flant/blog/339724/"># 4: SoundCloud (by Prometheus)</a> ‚Äù; </li><li>  <a href="https://habrahabr.ru/company/flant/blog/340270/">Statistics The New Stack on the Difficulties of Implementing Kubernetes</a> ; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/327338/">Why do you need Kubernetes and why is it more than PaaS?</a>  " </li></ul></div><p>Source: <a href="https://habr.com/ru/post/341760/">https://habr.com/ru/post/341760/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341746/index.html">High Performance Computing: Microsoft Project and Cray</a></li>
<li><a href="../341748/index.html">Video on the e-book. Attempt to use e-ink reader as a second monitor in linux</a></li>
<li><a href="../341750/index.html">JPoint 2018 Java Conference Announcement: JDK 9, High Load and JVM Performance</a></li>
<li><a href="../341752/index.html">How I found vulnerabilities in Google's bug tracking system and got $ 15,600</a></li>
<li><a href="../341756/index.html">Unreal Engine: QuickStart in Qt Creator under Arch Linux</a></li>
<li><a href="../341764/index.html">Linux package managers almanac</a></li>
<li><a href="../341766/index.html">How I learned to directly reboot into the correct OS via UEFI</a></li>
<li><a href="../341768/index.html">An easy-to-use status container for a Restore application called Xstore.</a></li>
<li><a href="../341772/index.html">Is it time to save the web?</a></li>
<li><a href="../341774/index.html">Analysis of robots.txt files of the largest sites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>