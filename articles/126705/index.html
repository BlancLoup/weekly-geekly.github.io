<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing spamming your Exim accounts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has historically happened to us that we pay more attention to filtering spam in the incoming mail, almost completely forgetting about outgoing mail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing spamming your Exim accounts</h1><div class="post__text post__text-html js-mediator-article">  It has historically happened to us that we pay more attention to filtering spam in the incoming mail, almost completely forgetting about outgoing mail. <br>  Starting to analyze this situation, we are confronted with the fact that we cannot really say who is ‚Äúshit‚Äù in our mail traffic, because addresses are given dynamically.  spamassassin doesn‚Äôt help much either (for now), as outgoing spam has almost 2 times lower marks than incoming spam. <br>  And for a start, it was decided to conduct a small study which is described under the cut. <br><a name="habracut"></a><br><h4>  Initial data </h4><br>  As the initial data we will have: <br><ul><li>  billing system.  In our case: <a href="http://abills.net.ua/">Abills</a> .  But this example can be adapted for any billing </li><li>  Exim is configured for almost any of the configs found on the Internet using mysql </li><li>  Actually MySQL DBMS.  in our case, these were 2 separate servers.  One for billing the 2nd for the statistics server that we will collect </li></ul><br><h4>  What we want </h4><br>  The main task of course is to find out which user is ‚Äúspamming‚Äù through us.  For this <br><ol><li>  We find out the IP-address that sends mail </li><li>  By IP-address we find the user who is currently using this address. </li><li>  We write the necessary information for subsequent analysis in the table (login, ip, email_from, email_to, email_time, spam_score) </li></ol><br>  So the points: <br><ol><li>  The IP address is determined via the exim variable - <b>$ sender_host_address</b> </li><li>  Since in the abills table, the dv_calls table contains the current online sessions, we find the user who occupied this address on request: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">concat</span></span>(<span class="hljs-string"><span class="hljs-string">"login="</span></span>,user_name) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dv_calls <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INET_NTOA</span></span>(framed_ip_address)=<span class="hljs-string"><span class="hljs-string">'${quote_mysql:$sender_host_address}'</span></span>;</code> </pre> <br>  Note the return result as a pair of <i>parameter</i> = <i>value</i> <i><br></i>  .  In the Exim config, it looks like this: <br> <code>GET_LOGIN = SELECT concat("login=",user_name) FROM dv_calls WHERE INET_NTOA(framed_ip_address)='${quote_mysql:$sender_host_address}'; <br></code> <br>  - this is the macro that we will run during the scan of the letter with anti-spam. <br></li><li>  well, the actual insertion of data through the insert will also be performed during the anti-spam check <br> <code>ADD_STATISTICS = INSERT INTO statistics VALUES ('$acl_m1','${quote_mysql:$sender_host_address}',\ <br> '${quote_mysql:$sender_address}','${quote_mysql:$acl_m4}',NOW(),$spam_score_int); <br></code> <br></li></ol><br><h4>  Exim </h4><br>  Let's go over the Exim configuration shortly: <br><ol><li>  Definition of 2 macros: <br> <code>ADD_STATISTICS = INSERT INTO statistics VALUES ('$acl_m1','${quote_mysql:$sender_host_address}',\ <br> '${quote_mysql:$sender_address}','${quote_mysql:$acl_m4}',NOW(),$spam_score_int); <br> <br> GET_LOGIN = SELECT concat("login=",user_name) FROM dv_calls WHERE INET_NTOA(framed_ip_address)='${quote_mysql:$sender_host_address}'; <br></code> <br></li><li>  In acl_smtp_rcpt we add the very first item: <br> <code>warn <br> hosts = LOCAL_NETS <br> set acl_m4 = $local_part@$domain <br></code> <br>  - this is some kind of hack, because as we will write in the table both the sender's address and the recipient's address.  But in the place where we will do this, the variables <b>$ local_part</b> and <b>$ domain</b> will already be undefined (I don‚Äôt know this from me anyway or in general in Exim, so I am waiting for your comments on this). <br></li><li>  At the very beginning we add the following to acl_smtp_data: <br> <code>warn <br> hosts = LOCAL_NETS <br> set acl_m0 = ${lookup mysql{GET_LOGIN}{$value}{login=unknown}} <br> set acl_m1 = ${extract{login}{$acl_m0}{$value}{unknown}} <br> <br> warn <br> hosts = LOCAL_NETS <br> spam = nobody:true <br> set acl_m2 = ${lookup mysql{servers=localhost; ADD_STATISTICS}{$value}{0}} <br></code> <br>  here in the 1st half of the code - we define the login by the address of the sender and writing it into the variable acl_m1.  Moreover, if we are unable to unambiguously determine the client's login, then we write unknown (in our case these will be server and monitoring service messages). <br>  In the 2nd half we check mail with anti-spam for all OUR clients.  And pay attention to the record <b>servers = localhost;</b>  <b>ADD_STATISTICS</b> here we explicitly indicate that it is necessary to execute the query on the local server and not on the billing server, such an Exim record allows using an arbitrary number of different connections to the DBMS. <br></li></ol><br>  Restart exim and have a result. <br><h4>  Preliminary findings </h4><br>  During the day of operation of this algorithm, we found 2 spam hotbed users.  Which sent 181 letters from fake addresses with an average spam rate of 24 (according to our antispam scale).  And since our antispam was tuned to a completely different order of ratings (50 is a warning) (70 is cut-off), he naturally missed them. <br>  Eventually.  Organizational conclusions are made, the list of perpetrators was submitted to the relevant authorities for clarification in the future (fines, blocking, massacre, etc., etc.) <br><br>  PS <br>  Almost all the information we draw from the <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/index.html">specification</a> <br>  I came up with the idea of ‚Äã‚Äãworking with the DBMS, <a href="http://lug.ivanovo.ru/f/topic_show.pl%3Ftid%3D259">this note</a> - though it‚Äôs about greylisting which we plan to introduce later </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/126705/">https://habr.com/ru/post/126705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126693/index.html">Some Python-like functions in C ++ 11</a></li>
<li><a href="../126697/index.html">Amazon seriously took up the video</a></li>
<li><a href="../126701/index.html">Bash scripts interaction with user</a></li>
<li><a href="../126703/index.html">Chrome with Yandex search</a></li>
<li><a href="../126704/index.html">Draw graphs (diagrams) in Django</a></li>
<li><a href="../126707/index.html">Forwarding COM Ports from Linux to Windows</a></li>
<li><a href="../126708/index.html">Silicon Valley Infrastructure Overview</a></li>
<li><a href="../126710/index.html">About modern methods of near-earth astronomy</a></li>
<li><a href="../126711/index.html">Mi-one new smartphone Xiaomi</a></li>
<li><a href="../126714/index.html">Bootstrap toolkit for creating web applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>