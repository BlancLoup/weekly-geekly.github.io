<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Turla Cybergroup Outlook Backdoor Analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Turla (Snake, Uroboros) is a cyber spy group that gained fame in 2008 after breaking into protected objects, including the network of the US Central C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Turla Cybergroup Outlook Backdoor Analysis</h1><div class="post__text post__text-html js-mediator-article"><p>  Turla (Snake, Uroboros) is a cyber spy group that gained fame in 2008 after breaking into protected objects, including the network <a href="https://www.nytimes.com/2010/08/26/technology/26cyber.html%3F_r%3D1%26ref%3Dtechnology">of the US Central Command</a> .  Since then, specializes in attacks on military facilities and diplomatic departments around the world.  Among the notable victims are the <a href="https://yle.fi/uutiset/osasto/news/russian_group_behind_2013_foreign_ministry_hack/8591548">Ministry of Foreign Affairs of Finland</a> in 2013, the <a href="https://www.melani.admin.ch/melani/en/home/dokumentation/reports/technical-reports/technical-report_apt_case_ruag.html">Swiss Defense Corporation RUAG</a> from 2014 to 2016.  and <a href="https://www.theguardian.com/world/2018/mar/01/german-government-intranet-under-ongoing-attack">the German government</a> in late 2017 - early 2018. </p><br><p>  After the last incident, several media outlets published information about the methods of attackers - the use of e-mail attachments to manage malware and transfer stolen data from the system.  However, no technical information was provided on the backdoor.  In this report, we publish the results of the Turla backdoor analysis, which was managed using PDF attachments in email. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l_/db/ws/l_dbws8skuoavwqn1vorwdhobgo.jpeg"></div><a name="habracut"></a><br><p>  According <a href="http://www.sueddeutsche.de/digital/it-sicherheit-hackerangriff-gegen-regierung-war-teil-weltweiter-spaehaktion-1.3890332">to media reports</a> , several computers of the German Foreign Ministry were infected with a backdoor.  Apparently, the attack began in 2016 and was discovered by security services at the end of 2017. The attackers initially compromised the Federal Higher School of Public Administration (Hochschule des Bundes), after which they moved within its network until they got access to the MFA network in March 2017 .  Turla operators had access to some confidential data (for example, e-mail of employees of the German Foreign Ministry) for about a year. </p><br><p>  Our investigation also shows that this malware, aimed at Microsoft Outlook, was used against various political and military departments.  We were convinced that the foreign ministries of two other European countries and a major defense contractor were also compromised.  Our investigation allowed us to identify dozens of email addresses registered by Turla operators for this campaign, and used to obtain exfiltered victim data. </p><br><h2>  1. Basic Theses </h2><br><p>  The Turla group's Outlook backdoor has two functions. </p><br><p>  First, it is the theft of outgoing emails that are sent by the attacker.  It mainly affects Microsoft Outlook, but it is also relevant for The Bat !, which is popular in Eastern Europe. </p><br><p>  Secondly, the use of letters as the transport level of its C &amp; C protocol.  Files requested by the backdoor command are exfiltered in specially created PDF documents attached to letters.  Backdoor commands are also sent as PDF attachments.  This allows for secrecy.  It is important to note that attackers do not exploit any vulnerabilities in PDF readers or Microsoft Outlook.  Malicious software can decode data from PDF documents and interpret them as commands. </p><br><p>  Campaign goals are typical for Turla.  We identified several European government agencies and defense companies compromised by this backdoor.  It is likely that attackers use it to ensure persistence in restricted access networks, where well-configured firewalls or other network security tools effectively block traditional communications with C &amp; C servers via HTTP (S).  The figure below lists the lines of the backdoor code that mention some top-level government domains.  mfa is the MFA domain, .gouv is a subdomain of the French government (.gouv.fr), ocse is the Organization for Security and Cooperation in Europe. </p><br><img src="https://habrastorage.org/webt/xt/ix/e9/xtixe9vxop-os9ktobaea5qqdbu.png"><br><p>  <i>Figure 1. Domains related to civil services found in the code of Malvari</i> </p><br><p>  Based on the analysis and telemetry data, we found that this backdoor has been distributed in the wild at least since 2013.  As always with Turla, we cannot focus on the compilation timestamps, since they are usually faked.  However, we believe that the first versions were compiled before 2013, since this year‚Äôs version was already quite advanced.  After that we found a version more similar to the base one, the compilation of which was dated 2009.  To determine the exact release date is not yet possible.  The chronology below is based on our telemetry and open source data: </p><br><p>  <b>2009</b> : Compile timestamp (maybe fake) of the basic version of the Outlook backdoor.  Only a snapshot of email content. <br>  <b>2013</b> : Improved: backdoor can execute commands.  They are sent by email in XML format. <br>  <b>2013</b> : The latest known version focused on The Bat! .. <br>  <b>2016</b> : Improved: commands are sent as attachments in specially created PDF documents. <br>  <b>2017</b> : Improved: backdoor is able to create PDF documents for exfiltration of data by an attacker. <br>  <b>March 2018</b> : Report on the compromise of the German government network. <br>  <b>April 2018</b> : Improved: the backdoor can execute PowerShell commands using Empire PSInject. </p><br><h2>  2. Global architecture </h2><br><p>  In the latest versions, the backdoor is a standalone DLL, which has code for self-installation and interaction with Outlook and The Bat! Email clients, even if only the installation for Outlook is implemented.  It can easily be reset by any Turla component that allows for additional processes. </p><br><p>  In this section, our analysis is based on a sample released in the first half of 2017.  Information on older or newer patterns may be included. </p><br><h3>  2.1.  Installation </h3><br><p>  To install the backdoor, attackers export a DLL called Install or register it using regsvr32.exe.  The argument is the target mail client.  The figure below shows the possible values.  In recent versions, only installation for Outlook is implemented. </p><br><img src="https://habrastorage.org/webt/9g/8r/qm/9g8rqm3z7keq_phkhvlztwzwtyo.png"><br><p>  <i>Figure 2. Possible arguments for installation</i> </p><br><p>  Because the hard-coded path is missing, the DLL file can be located anywhere on the disk. </p><br><h4>  2.1.1.  Microsoft Outlook </h4><br><p>  Turla developers rely on COM object capture (COM object hijacking) to ensure the persistence of malware.  This is a well-known method used in the wild for many years, <a href="https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence">including by the Turla group</a> .  The essence of the method is to redirect the COM object used by the target application by modifying the corresponding CLSID entry in the Windows registry. </p><br><p>  In our case, the following changes were made in the Windows registry: </p><br><pre><code class="hljs tex">HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Software</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Classes</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CLSID</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">{</span></span></span></span>49CBB1C7-97D1-485A-9EC1-A26065633066} = Mail Plugin HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Software</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Classes</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CLSID</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">{</span></span></span></span>49CBB1C7-97D1-485A-9EC1-A26065633066}<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">InprocServer</span></span></span></span>32 = [Path to the backdoor DLL] HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Software</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Classes</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CLSID</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">{</span></span></span></span>49CBB1C7-97D1-485A-9EC1-A26065633066}<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">InprocServer</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ThreadingModel</span></span></span><span class="hljs-tag"> = </span></span>Apartment HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Software</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Classes</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CLSID</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">{</span></span></span></span>84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TreatAs</span></span></span><span class="hljs-tag"> = </span></span>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> </pre> <br><p>  <code>{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}</code> - the captured CLSID.  It corresponds to the Outlook Protocol Manager and in theory loads the legitimate DLL DLL Outlook <code>OLMAPI32.DLL</code> .  <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> not associated with any known software.  This CLSID value is arbitrary and is used only as a placeholder for redirecting COM. </p><br><p>  When the modification is completed, the backdoor DLL will be loaded each time Outlook loads its COM object.  According to our observations, this happens during the launch of Outlook. </p><br><p>  COM forwarding does not require administrator privileges, since it applies only to the current user.  To prevent such malicious redirects, protection measures are provided.  According to <a href="https://msdn.microsoft.com/en-us/library/bb756926.aspx">MSDN</a> : "With Windows Vista and Windows Server 2008, if the integrity level of the process is above average, the COM runtime environment ignores the user's COM configuration and gets access only to the COM configuration for each machine." </p><br><p>  The Outlook process runs at medium integrity, as shown in the figure below.  Thus, it is not protected from COM forwarding for each user. </p><br><img src="https://habrastorage.org/webt/q4/uq/zt/q4uqzt_g3c6vgonoluf_7ttrqpw.png"><br><p>  <i>Figure 3. The integrity level of the Outlook process</i> </p><br><p>  Finally, using the COM object capture allows the backdoor to avoid detection, since the path to the backdoor ( <code>C:\Users\User\Documents\mapid.tlb</code> in our example) is not displayed in the plug-in list, as shown in the following figure. </p><br><img src="https://habrastorage.org/webt/4l/cj/s3/4lcjs3tai1gd5gopfekwd7skjra.png"><br><p>  <i>Figure 4. Outlook plugins list - mapid.tlb is not displayed</i> </p><br><p>  Even if the malware is not displayed in the list of add-ons, the standard Microsoft API, MAPI (Messaging Application Programming Interface), is used to interact with Outlook. </p><br><h4>  2.1.2.  The Bat! </h4><br><p>  As specified in the chronology, the latest versions of the backdoor no longer include the code for registering The Bat! Plugin. However, all the code for managing mailboxes and messages still exists.  If necessary, it can be configured manually. </p><br><p>  To register as a plugin for The Bat!  the malicious program modified the <code>%appdata%\The Bat!\Mail\TBPlugin.INI</code> .  This is a legitimate way to register a plugin for The Bat !, some plugins (like antispam) also use it. </p><br><p>  After registering each time The Bat!  Backdoor DLL is called.  The figure below shows how the DLL implements the export necessary for plugins. </p><br><img src="https://habrastorage.org/webt/xq/x7/zs/xqx7zsv5pwjjmhonegcsmpmnwx0.png"><br><p>  <i>Figure 5. Standard export for The Bat!</i> </p><br><h3>  2.2.  Interaction with the mail client </h3><br><p>  Interaction with the mail client depends on the purpose. </p><br><h4>  2.2.1.  Microsoft Outlook </h4><br><p>  Microsoft supports the Messaging Application Programming Interface (MAPI), which allows applications to <a href="https://docs.microsoft.com/en-us/office/client-developer/outlook/mapi/outlook-mapi-reference">interact with Outlook</a> .  The Turla backdoor uses this API to access and manage the mailboxes of the compromised system users / users. </p><br><p>  First, the backdoor connects to the messaging system using MAPILogonEx, as shown in the figure. </p><br><img src="https://habrastorage.org/webt/nf/fp/u1/nffpu1duhw9u7rmxytdm1chwpey.png"><br><p>  <i>Figure 6. MAPI logon</i> </p><br><p>  The second parameter (lpszProfileName) is empty, the <code>MAPI_USE_DEFAULT</code> flag is <code>MAPI_USE_DEFAULT</code> .  According to the documentation: "The messaging subsystem should replace the default profile name for the lpszProfileName parameter. The <code>MAPI_EXPLICIT_PROFILE</code> flag <code>MAPI_EXPLICIT_PROFILE</code> ignored, unless lpszProfileName is NULL or empty." </p><br><p>  In contrast, the <code>MAPI_NEW_SESSION</code> flag <code>MAPI_NEW_SESSION</code> not set.  According to the documentation: "The <code>lpszProfileName</code> parameter <code>lpszProfileName</code> ignored if there is a previous session called MapiLogonEx with the specified <code>MAPI_ALLOW_OTHERS</code> flag and if the <code>MAPI_NEW_SESSION</code> flag <code>MAPI_NEW_SESSION</code> not set." </p><br><p>  In our opinion, Outlook opens a default session with the <code>MAPI_ALLOW_OTHERS</code> flag.  Thus, the backdoor will use the previously open session to access the default mailbox profile.  This explains the lack of a prompt for a username and password when initializing the backdoor plugin. </p><br><p>  By doing this, the backdoor will gain access to the mailbox and will be able to easily manage it using other MAPI functions.  It will iterate through various message repositories, analyze letters, and add callbacks to incoming and outgoing messages.  The log file displays this process (changed the username and address): </p><br><pre> <code class="hljs pgsql">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ========= Analyzing msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Service <span class="hljs-type"><span class="hljs-type">name</span></span>:MSUPST MS Pst <span class="hljs-type"><span class="hljs-type">path</span></span>:C:\Users\[username]\Documents\Outlook Files\[email address].pst Wait main <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> count = <span class="hljs-number"><span class="hljs-number">46</span></span> This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> message store PUSH store <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> list &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _____________ FOLDERS _____________ Setting sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> folders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> stores. ========Process msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Account: [email address] Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Outbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store. Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Inbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store.</code> </pre> <br><p>  It sets up a callback in each inbox and <code>HrAllocAdviseSink</code> using the <code>HrAllocAdviseSink</code> function, as shown in the figure. </p><br><img src="https://habrastorage.org/webt/ud/df/js/uddfjs5ub7qj9n3gxlxslirppcq.png"><br><p>  <i>Figure 7. Register a callback in the Outbox</i> </p><br><p>  <b>2.2.1.1.</b>  <b>Callback in your inbox</b> </p><br><p>  The callback in the inbox records the incoming metadata, including sender and recipient addresses, subject and attachment names.  Example below (developer spelling is kept): </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">RECIVE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt;{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: sender@example.com To: receiver@example.net Cc: Bcc: Subj: Mail subject Att: an_attachment.pdf }</code> </pre> <br><p>  Then he analyzes the letter and attachments for commands from the attackers.  This feature is described in section 2.3. </p><br><p>  Finally, it intercepts bounce reports by checking incoming messages with the operator‚Äôs email address.  Any letter containing the address of the operator will be rejected.  This can cause problems if the victim suspects that something is wrong and will contact the support service without seeing the answers. </p><br><p>  <b>2.2.1.2.</b>  <b>Callback in outbox</b> </p><br><p>  As in the inbox, the outbox records the metadata of all emails sent.  The following entry is generated (operator's address is changed): </p><br><pre> <code class="hljs css">21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SEND</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: To: recipient@example.com Cc: Bcc: Subj: My title Att: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"last_presentation.pdf"</span></span> } 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sending</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ENTRYID</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Message ENTRYID]</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">send</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[redacted]</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">gmx</span></span>[.]<span class="hljs-keyword"><span class="hljs-keyword">com</span></span> From: Subj: My title <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Set last time. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Spawned thread for cleaning up outgoing messages (id <span class="hljs-number"><span class="hljs-number">2848</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Ending work, client: Outlook <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of messages to remove: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Message ENTRYID: [Message ENTRYID] <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> DeleteMessages executed successfully. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of not removed messages: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  You may notice that he forwards every outgoing message to the address of the attackers, <code>[‚Ä¶]@gmx[.]com</code> .  GMX is a popular free email service;  the attackers probably chose it because organizations usually do not block the gmx.com domain. </p><br><p>  This email address is hard-coded in the sample we studied, as shown in the figure below.  However, it can be updated using one of the backdoor functions.  It seems that attackers register at least one email address for each target. <br>  organizations using the format <code>firstname.lastname@gmx[.]com</code> with the name of a real employee.  This avoids detection, since it is often difficult to distinguish such an address from an employee‚Äôs actual personal box.  At the time of analysis of the sample in June 2018, the address was unavailable. </p><br><img src="https://habrastorage.org/webt/9c/tr/-d/9ctr-dcusp0p35kcuhiqw4pypns.png"><br><p>  <i>Figure 8. Hard-coded operator address</i> </p><br><p>  The backdoor sends reports at certain intervals to the address of the operators.  The report includes unique identifiers, including the MAC address, the complete log file and the results of command execution, if any.  It then encrypts the data using MISTY1, as described later in section 2.3.2.2, and creates a valid PDF file with encrypted content.  Before this encrypted data blob, the document contains a white 1x1 image in jpeg, hard-coded in malware.  This allows you to create a valid PDF that, when opened, displays only one blank page. </p><br><p>  Finally, the backdoor attaches a PDF and sends an email to the attackers address.  The figure below is an example of a PDF file created by a backdoor. </p><br><img src="https://habrastorage.org/webt/d4/6f/yx/d46fyxd9n7e-ziu9jwjxdtedqke.png"><br><p>  <i>Figure 9. Beginning PDF document created by backdoor for exfiltration of data</i> </p><br><p>  The report is sent using the callback function in the outbox.  This means that the letter will leave at the same time as sending the user's legitimate messages.  The backdoor cannot send emails with stolen data at uncharacteristic time for the user and therefore avoids detection.  Due to its secrecy, this control and monitoring mechanism is very difficult to detect in the wild. </p><br><h4>  2.2.2.  Disguise malicious behavior from the user </h4><br><p>  Since the backdoor is valid when the user is working with the computer and Outlook, the malware tries to hide malicious activity, for example, incoming letters from operators. </p><br><p>  First of all, the backdoor always deletes mail sent to operators or received from them.  As shown in the figure below, within a few seconds you can see that a new message has appeared, which, however, does not appear in the mailbox. </p><br><img src="https://habrastorage.org/webt/o7/pc/wh/o7pcwhrtwemk2qfqrfdtgjb6p0o.png"><br><p>  <i>Figure 10. Unread message</i> </p><br><p>  Secondly, the backdoor intercepts the <code>CreateWindowsEx</code> , as shown in the figures below.  This prevents the creation of windows of type NetUIHWND, used by Outlook for notifications, which are displayed in the lower right part of the screen. </p><br><img src="https://habrastorage.org/webt/7y/wn/xq/7ywnxqshbevin9-ncsw8lhprkvo.png"><br><p>  <i>Figure 11. Configuring the CreateWindowsEx function interception</i> </p><br><img src="https://habrastorage.org/webt/ki/1_/zr/ki1_zrks5vaspkm-bpz2j-z9asu.png"><br><p>  <i>Figure 12. Capturing CreateWindowsEx</i> </p><br><p>  The figure below shows an example of the NetUIHWND window, which is usually displayed on the desktop when a new message is received.  As a result of the <code>CreateWindowEx</code> interception, the notification is not displayed when the attackers send a letter to the backdoor. </p><br><img src="https://habrastorage.org/webt/bd/5n/3b/bd5n3bq_pijmhlosvf6muvjcyjq.png"><br><p>  <i>Figure 13. Notification of a new message</i> </p><br><h4>  2.2.3.  The Bat! </h4><br><p>  Despite the fact that the registration function of the plugin for The Bat!  It no longer exists, there is an inherited code that performs the same functions as for Outlook using the API The Bat! .. </p><br><p>  As shown in the following figure, the backdoor uses the communication channel with The Bat! To receive information from users, read and send letters.  However, all other functions, such as those used for logging letters or executing commands, are identical to Outlook. </p><br><img src="https://habrastorage.org/webt/iy/qb/ub/iyqbubrelp4uwudy8n4gby7n6lq.png"><br><p>  <i>Figure 14. The Bat!</i> </p><br><h3>  2.3.  Backdoor </h3><br><p>  As shown in the previous section, the malware can process and exfilter messages.  However, it is a full-featured backdoor, managed via email, which can work independently of any other Turla component.  The backdoor does not need a permanent Internet connection and can work on any computer that sends messages to external addresses.  This is useful in tightly-controlled networks, for example, using Internet traffic filtering.  Moreover, even if the email address of the attackers is inactive, they can regain control by sending a command from another address.  In this case, the letter will also be hidden from the user, since it will contain commands interpreted by the backdoor.  Thus, the backdoor is as fault-tolerant as the rootkit checking incoming network traffic. </p><br><h4>  2.3.1.  PDF format </h4><br><p>  In early 2018, several media outlets stated that Turla operators use email attachments to manage infected computers.  The media were right.  Turla's Outlook backdoor analysis revealed how it sends and interprets commands. </p><br><p>  Commands are emailed using specially created PDF attachments.  We were unable to find a real PDF sample with commands, but these are probably valid PDF documents, as well as PDF files created by the backdoor for exfiltration. </p><br><p>  From PDF documents, a backdoor can restore what operators call containers in magazines.  This is a blob with a special format that contains encrypted commands for the backdoor.  The figure below shows the procedure for retrieving this container.  Technically, the application should not be a valid PDF document.  The only requirement is that it includes the container in the correct format. </p><br><img src="https://habrastorage.org/webt/hb/r_/yf/hbr_yfy47qewou5f_tqbrpdn5ck.png"><br><p>  <i>Figure 15. Extract command container from PDF</i> </p><br><p>  The container has a complex structure with many different checks.  It could be designed to prevent communication errors, but we believe that the structure was created primarily to counteract reverse engineering.  The structure of the container is shown in the figure below. </p><br><img src="https://habrastorage.org/webt/ud/aa/6w/udaa6wvubnjskhmfrgsoalfke70.png"><br><p>  <i>Figure 16. Structure of the command container</i> </p><br><p>  Immediately before the initialization vector there is a list of command descriptors.  Different ID values ‚Äã‚Äãare presented in the table: </p><br><img src="https://habrastorage.org/webt/jy/sg/5o/jysg5opuoyhwir5hre-xi9quhxq.png"><br><p><br>  ID 2 and 4 descriptors are used to extract encryption and decompression functions, as shown in the following figure.  However, the malicious program implements only one encryption algorithm and one compression algorithm.  Thus, the only purpose of these fields is to complicate the analysis of the backdoor. </p><br><img src="https://habrastorage.org/webt/h8/sh/gu/h8shgunmwafcbx6h1shccn9-ndo.png"><br><p>  <i>Figure 17. Offset decompression and decryption functions</i> </p><br><p>  The teams are in the last part of the structure.  They are encrypted using MISTY1 and compressed with bzip2.  There can be many different commands in the same PDF file, and each can have several arguments. </p><br><h4>  2.3.2.  Cryptography </h4><br><p>  Here we describe the encryption algorithms used. </p><br><p>  <b>2.3.2.1.</b>  <b>XOR encryption</b> </p><br><p>  Part of the container (starting with the first CRC32) is encrypted with XOR with a byte stream generated by the user function.  A seed is required, which is transmitted to <code>srand</code> to generate the second number by calling rand.  The second seed is used in the function shown below as an argument with the data in the XOR. </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">int</span></span> __usercall F_bytestream_xor@&lt;eax&gt;(unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> len@&lt;edx&gt;, <span class="hljs-type"><span class="hljs-type">int</span></span> ciphertext@&lt;ecx&gt;, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> seed) { unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> v3; // ebx <span class="hljs-type"><span class="hljs-type">int</span></span> v4; // esi unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> v5; // edi <span class="hljs-type"><span class="hljs-type">int</span></span> result; // eax unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> v7; // ecx <span class="hljs-type"><span class="hljs-type">char</span></span> *v8; // edx unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> v9; // esi byte key[<span class="hljs-number"><span class="hljs-number">512</span></span>]; // [esp+Ch] [ebp<span class="hljs-number"><span class="hljs-number">-204</span></span>h] <span class="hljs-type"><span class="hljs-type">char</span></span> *v11; // [esp+<span class="hljs-number"><span class="hljs-number">20</span></span>Ch] [ebp<span class="hljs-number"><span class="hljs-number">-4</span></span>h] v3 = len; v11 = (<span class="hljs-type"><span class="hljs-type">char</span></span> *)ciphertext; srand(seed); v4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; v5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { result = rand(); *(_DWORD *)&amp;key[<span class="hljs-number"><span class="hljs-number">4</span></span> * v5++] = result; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v5 &lt; <span class="hljs-number"><span class="hljs-number">128</span></span> ); v7 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !v3 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; v8 = v11; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { v8[v7] ^= key[v4]; v9 = v4 + <span class="hljs-number"><span class="hljs-number">1</span></span>; result = -(v9 &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>); v4 = result &amp; v9; ++v7; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v7 &lt; v3 ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  <strong>2.3.2.2.</strong>  <strong>MISTY1</strong> </p><br><p>  Turla developers prefer to use less common or modified encryption algorithms in their backdoors: </p><br><ul><li>  in <a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">Carbon and Snake</a> - CAST-128 </li><li>  in <a href="https://www.welivesecurity.com/wp-content/uploads/2017/08/eset-gazer.pdf">Gazer</a> - custom implementation of RSA </li><li>  in <a href="https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf">Mosquito</a> - Blum Blum Shub as a random number generator for the XOR byte stream </li><li>  in the Uroburos <a href="https://exatrack.com/public/Uroburos_EN.pdf">rootkit</a> - a modified version of ThreeFish </li></ul><br><p>  In the Outlook backdoor, they implemented MISTY1, a symmetric encryption algorithm developed by Mitsubishi Electric cryptographers in 1995.  It has the following properties: </p><br><ul><li>  is symmetrical </li><li>  has a 128-bit key </li><li>  uses two pre-computed tables: s7 (128 bytes) and s9 (2048 bytes) </li><li>  uses three functions: FL, FO, FI <br>  o FL performs some XOR operations between byte writing and the extended key <br>  o FO performs XOR operations between the record and the extended key, and also uses FI <br>  o FI performs non-linear substitution using s7 and s9 </li><li>  operates in blocks of 64 bits </li><li>  performs eight cycles (loop - calling the FO function) </li><li>  uses the Feistel cipher </li></ul><br><img src="https://habrastorage.org/webt/jf/d4/_i/jfd4_iplej2iexnsc2pkxkeracy.png"><br><p>  <em>Figure 18. MISTY1</em> </p><br><img src="https://habrastorage.org/webt/08/qc/_h/08qc_hxb2xju1yxbfsqmizuocwy.png"><br><p>  <em>Figure 19. Eight cycles for block encryption</em> </p><br><p>  Turla developers slightly modified the algorithm: </p><br><ul><li>  Added two XOR operations to the FI function, as shown in the figure below. </li><li>  128-bit key is generated from two hard-coded 1024-bit keys plus a 2048-bit initialization vector </li><li>  changed the tables s7 and s9.  This disrupts the operation of all tools that recognize cryptographic algorithms based on the values ‚Äã‚Äãof s-tables.  Both modified and original s-tables contain the same values, they were just shuffled </li></ul><br><img src="https://habrastorage.org/webt/74/ge/qg/74geqg_tqugk_mgizdhn07hrcp0.png"><br><p>  <em>Figure 20. Comparison of FI functions (on the left is the original, on the right is Turla development)</em> </p><br><h4 id="233-funkcii">  2.3.3.  Functions </h4><br><p>  The backdoor implements many functions - from exfiltration of files to the execution of commands.  A description of the various functions is in the table below. </p><br><img src="https://habrastorage.org/webt/zk/ij/od/zkijodwltfd9en0cxuya189_758.png"><br><p><br>  For the 0x29 function, Turla developers copied code from the Empire <a href="https://github.com/EmpireProject/PSInject">PSInject</a> project.  This allows you to run PowerShell code in a special executable file called PowerShell Runner without calling <code>powershell.exe</code> .  The main advantage is that malware can still execute PowerShell commands, even if the <code>powershell.exe</code> file is blocked on a compromised computer. </p><br><p>  After analyzing the backdoor, we were able to create a PDF document that can be successfully interpreted by malware.  The following figure shows the MessageBox running and calculator ( <code>calc.exe</code> ) running after Outlook received an email containing this PDF document.  This demonstrates that the backdoor, probably intended for receiving commands in PDF attachments, is functional and can be managed by anyone who understands this custom format. </p><br><img src="https://habrastorage.org/webt/-t/xc/lr/-txclr3f050ahxdxykqgnimnr5g.png"><br><p>  <em>Figure 21. Execution of commands specified in a PDF document</em> </p><br><h3 id="24-dopolnitelnye-funkcii">  2.4.  Additional functions </h3><br><p>  In addition to the backdoor features implemented as a plug-in for the mail client, the malware has other functions. </p><br><h4 id="241-virtualnaya-faylovaya-sistema">  2.4.1.  Virtual file system </h4><br><p>  The malicious program does not use any configuration files, but it supports a small virtual file system in the Windows registry section <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> .  Other Turla backdoors, such as <a href="https://www.welivesecurity.com/wp-content/uploads/2017/08/eset-gazer.pdf">Gazer</a> , also save the virtual file system in the Windows registry.  We were able to determine some registry values, as shown in the following table. </p><br><img src="https://habrastorage.org/webt/gi/g-/wt/gig-wt39jwfeznw0kpe7qjzvhpm.png"><br><h4 id="242-zhurnaly">  2.4.2.  Magazines </h4><br><p>  As mentioned earlier, the program saves a journal, which is regularly sent to the operator by e-mail in a specially created PDF-document.  It is stored in <code>%appdata%/Microsoft/Windows/scawrdot.db</code> and is encrypted with a hard-coded 512-byte XOR key.  The log file is cleared after each exfiltration to the operators.  Thus, during the forensic examination it would be impossible to see all the past actions of the backdoor, only the latter. </p><br><p>  The logs are quite informative, they allow Turla operators to track backdoor actions.  The figure below shows an example of a decrypted log. </p><br><img src="https://habrastorage.org/webt/yo/q_/z6/yoq_z6lfqy5b3ozw3f4lh6reqr4.png"><br><p>  <em>Figure 22. Decrypted log file</em> </p><br><h2 id="3-vyvody">  3. Conclusions </h2><br><p>  The report showed that Turla developers have enough ideas when they develop backdoors.  As far as we know, Turla is the only cyber spy group that currently uses a backdoor, fully managed via email, more precisely, PDF attachments. </p><br><p>  Turla's backdoor is not the first to use the victim's real mailbox to receive commands and exfiltrate data.  However, this is the first studied backdoor using the standard API (MAPI) to interact with Microsoft Outlook.  This is a significant improvement over the previous version that <a href="https://www.welivesecurity.com/2016/07/01/espionage-toolkit-targeting-central-eastern-europe-uncovered/">we studied</a> , which used Outlook Express.  In contrast, the new Turla backdoor works even with the latest versions of Outlook. </p><br><p>  Thanks to the ability to control the seemingly legitimate communications of the infected workstation, as well as independence from any specific email address, the Turla backdoor is hidden and fail-safe.      ,   Uroburos,      . </p><br><p>   ,         Turla,  ,    .     ,  ,     .  ,      -   ,        . </p><br><p>    ,     PDF-,     Turla,      ,     . </p><br><p>  ESET     Turla,        . </p><br><p>      <a href="https://github.com/eset/malware-ioc/tree/master/turla">GitHub</a> . </p><br><h2 id="4-indikatory-komprometacii"> 4.   </h2><br><h3 id="41-heshi">  4.1.  Hashes </h3><br><p> 8A7E2399A61EC025C15D06ECDD9B7B37D6245EC2 ‚Äî  Win32/Turla.N;   (GMT) 2013-06-28 14:15:54 <br> F992ABE8A67120667A01B88CD5BF11CA39D491A0 ‚Äî  Win32/Turla.AW; GMT 2014-12-03 20:50:08 <br> CF943895684C6FF8D1E922A76B71A188CFB371D7 ‚Äî  Win32/Turla.R; GMT 2014-12-03 20:44:27 <br> 851DFFA6CD611DC70C9A0D5B487FF00BC3853F30 ‚Äî  Win32/Turla.DA; GMT 2016-09-15 08:14:47 </p><br><h3 id="42-imena-faylov">  4.2.   </h3><br><p> %appdata%/Microsoft/Windows/scawrdot.db <br> %appdata%/Microsoft/Windows/flobcsnd.dat <br> mapid.tlb </p><br><h3 id="43-klyuchi-reestra">  4.3.   </h3><br><p> HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\ <br> HKCU\Software\Classes\CLSID{49CBB1C7-97D1-485A-9EC1-A26065633066} <br> HKCU\Software\Classes\CLSID{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D} </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421399/">https://habr.com/ru/post/421399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421389/index.html">Separation of administrative authority in Zimbra</a></li>
<li><a href="../421391/index.html">HackThings - a big hackathon on the Internet of things September 7-9 in Skoltech</a></li>
<li><a href="../421393/index.html">Mailchimp dump basket: a guide for the lazy</a></li>
<li><a href="../421395/index.html">Rome Club Report 2018, Chapter 3.7: ‚ÄúClimate: good news, but big problems‚Äù</a></li>
<li><a href="../421397/index.html">Launch Mini AI Cup # 3. Battle machines in tight closed spaces</a></li>
<li><a href="../421401/index.html">Anatomy of recommendation systems. Part two</a></li>
<li><a href="../421403/index.html">Security Week 32: Fortnite Android Drama</a></li>
<li><a href="../421407/index.html">Technical mitap in Petersburg on September 13 - How to make big changes on the backend</a></li>
<li><a href="../421409/index.html">Spy stuff: stay secret</a></li>
<li><a href="../421411/index.html">Introduction to the Go Module System</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>