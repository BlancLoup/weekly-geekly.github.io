<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AMQP-php chat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here, I came to the first practical embodiment of my first two articles. Further, only ideas will be presented ... Ideas already embodied and ideas th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AMQP-php chat</h1><div class="post__text post__text-html js-mediator-article"> Here, I came to the first practical embodiment of my <a href="http://akalend.habrahabr.ru/blog/70757/" title="AMQP is now in PHP">first two articles.</a>  Further, only ideas will be presented ... Ideas already embodied and ideas that are embodied ... <br><br>  Unlike other messaging <a title="XMPP (Jabber)" href="http://xmpp.org/">protocols</a> ( <a title="XMPP (Jabber)" href="http://xmpp.org/">XMPP</a> <a href="http://stomp.codehaus.org/Protocol" title="STOMP protocol">STOMP</a> or Memcache (MemcacheQ)), AMQP is more flexible. <br><a name="habracut"></a><br>  A bit of theory or go back to the basics of <a href="http://amqp.org/" title="off site AMQP Protocol">AMQP</a> .  Described in more detail &lt;a href=1 <a href="http://habrahabr.ru/blogs/webdev/62502/">habrahabr.ru/blogs/webdev/62502</a> "title" The practice of using AMQP"&gt; here <br><br>  <b>The publication is</b> carried out by transfer of the <b>Message</b> (Message) in individual <b>Exchange</b> (Exchange) <br>  <b>Subscriber</b> (Consumer) reads messages from the individual queue (Queue) <br>  With bind, Queue and Exchange are connected through the routing key system. <br>  Each publication of a Message to Exchange is accompanied by a route key, in accordance with which it is sent to the corresponding queue.  There are three types of Exchange: funout, direct, topic.  We need the latter, since it allows us to distribute messages among queues in accordance with key patterns. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To implement a chat, each chat room needs its own Exchange.  Let us have three chat rooms open: php, mysql &amp; hiload with the names of exchanges of the same name. <br><br>  If you go back to the PHP AMQP API, then when you initiate a chat with a PHP theme, we must declare the exchange: <br> <code>// exchange declare exchange.php <br> $rabbit = new Rabbit(); // connection <br> $rabbit-&gt;exchange('php', "topic"); // declade exchange <br></code> <br>  The type of exchange should be a topic, since it is supposed to use key pattern routing (which is what we decipher next). <br><br>  When a User enters a chat (registration of a user's session), he is a Subscriber and a Publicist at the same time, we should see our messages, shouldn‚Äôt we? <br>  For this it is necessary to declare a queue of incoming messages.  For each member of the chat should be their own line, if we simultaneously participate in several chat rooms, then there should be in turn for each chat room. <br><br>  In principle, if WEB allowed to keep a permanent long-term connection, then one queue for each chat would be enough.  This is real when creating a separate chat client, such as ICQ or a mail agent: opened a connection, sent a request, waited for as long as necessary events ‚Äî received an alert ‚Äî transmitted an answer ‚Äî closed the connection.  But when organizing the exchange over HTTP, it is assumed that the exchange is asynchronous: they opened the connection, sent the request, received a response, maybe even an empty connection, after some time we query the server again. <br><br>  When registering for a chat, we declare a queue: <br> <code>// login.php <br> $rabbit = new Rabbit(); // connection <br> $rabbit-&gt;queue('php.fanat', AMQP_DURABLE); // declade queue <br></code> <br>  AMQP_DURABLE - a flag that indicates that messages when the AMQP broker is restarted should be stored in the database <br><br>  If Mr. fanat wants to participate in the mysql chat at the same time, you will need to declare a new queue: <br>  $ rabbit-&gt; queue ('mysql.fanat', AMQP_DURABLE); <br><br>  The next step is to bind the ‚Äúphp.fanat‚Äù queue to the ‚Äúphp‚Äù exchange: <br> <code>$rabbit-&gt; bind( 'php', 'php.fanat', 'fanat' ); // binding exchange to queue where routing_key <br></code> <br>  also done on the client side of each of the participants. <br><br>  Let there be three participants in the chat: fanat, fisher, fixxxer.  To publish a message, for example from a member, fanat, you must run the code: <code>// sendMessage.php <br> $rabbit = new Rabbit(); // connection <br> <br> $msg = "      "; <br> $rabbit-&gt;publish('php','*',$msg); //   <br></code> <code>// sendMessage.php <br> $rabbit = new Rabbit(); // connection <br> <br> $msg = "      "; <br> $rabbit-&gt;publish('php','*',$msg); //   <br></code> <br>  This instruction publishes in exchange 'php' with the key '*'.  Since we have the type of exchange 'topic', it is possible <br>  publication of messages on a pattern.  For example, publishing in exchange 'php' with the key 'fanat' will send a message to the 'php.fanat' queue, and publishing a message in the exchange of 'mysql' with the key 'fisher' will send the message to the 'mysql.fisher' queue (chat via mysql ).  This is the so-called direct type of exchange.  But, we need to send a message to all chat participants, here‚Äôs what the pattern will be used: if instead of the participant‚Äôs name you specify '*', it means to send a message to all signed (connected by bind) queues.  For the organization of a private chat, for example: fisher - fixxer, you can just publish using the direct key: <br> <code>// sendPrivateMessage.php <br> $rabbit = new Rabbit(); // connection <br> <br> $msg = "       ,    ..."; <br> $rabbit-&gt;publish('php','fisher',$msg); //   <br></code> <br>  the most interesting thing is that apart from changing the key, you don‚Äôt have to do anything else, AMQP broker will do everything for you. <br>  Technically, the publication is carried out by sending an AJAX POST request from the chat WEB page to the url: sendMessage.php. You can define privacy by an additional parameter. <br><br>  If we didn‚Äôt have a WEB client, then as I mentioned above, there would be a different approach. <br>  According to this, the classic subscription to the queue in this case is not suitable.  We have to organize constant asynchronous polling of queues.  In general, the principle of any chat is a constant polling of the server for new messages and, if they are there, their display.  Here, too, nothing new has been invented.  From the WEB chat page, we are making an AJAX request for a queue quiz script: <code>define("MSGCOUNT", 5); <br> $rabbit = new Rabbit(); // connection <br> $countMessage = $rabbit-&gt;queue('php.fisher'); // -    <br> <br> $msg = array(); <br> if (!$countMessage) <br> return json_encode( $msg ); //   <br> <br> for ($i=0;$i&lt; MSGCOUNT) { <br> $res = $rabbit-&gt;getQueueItem('php'); <br> if ($res['count'],0) break; <br> $msg[] = $res['msg']; <br> } <br> return json_encode( array( 'msg' =&gt; $msg , <br> 'count'=&gt;$res['count'], <br> )); //    <br></code> <code>define("MSGCOUNT", 5); <br> $rabbit = new Rabbit(); // connection <br> $countMessage = $rabbit-&gt;queue('php.fisher'); // -    <br> <br> $msg = array(); <br> if (!$countMessage) <br> return json_encode( $msg ); //   <br> <br> for ($i=0;$i&lt; MSGCOUNT) { <br> $res = $rabbit-&gt;getQueueItem('php'); <br> if ($res['count'],0) break; <br> $msg[] = $res['msg']; <br> } <br> return json_encode( array( 'msg' =&gt; $msg , <br> 'count'=&gt;$res['count'], <br> )); //    <br></code> <br>  This code reads MSGCOUNT or all if they are smaller and returns JSON with the messages received from the queue (msg key) and the rest of the 'count' key <br><br>  There are some open questions <br>  For example, we want to leave a short message history in the chat, let it be the last five to be on the tank ... <br>  You can use the AMQP_NOASK flag, then the message is marked as unread.  When we enter the chat, it reads all messages as read, except for the last fifteen.  There is another field for thinking, for example - is it worth it to store a bunch of messages in the queue.  Or organize a temporary queue of the last five to ten messages for new incoming.  In general, there is a place for experimentation. </div><p>Source: <a href="https://habr.com/ru/post/70997/">https://habr.com/ru/post/70997/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70988/index.html">FSB will be able to cancel the domain call?</a></li>
<li><a href="../70989/index.html">Faulty pixel</a></li>
<li><a href="../70993/index.html">GOOGLEMAILI phishing</a></li>
<li><a href="../70995/index.html">iPhone SDK on PC</a></li>
<li><a href="../70996/index.html">Tactile virtuality (the feeling of virtual objects in space) ...</a></li>
<li><a href="../70999/index.html">Dropbox now on iphone</a></li>
<li><a href="../71001/index.html">Why is Russian Yandex the fastest growing search engine?</a></li>
<li><a href="../71005/index.html">nVidia launches GT300 marketing campaign</a></li>
<li><a href="../71006/index.html">Use of industrial robots in construction</a></li>
<li><a href="../71009/index.html">Hyperlinks: Building Model Contest, Google Wave</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>