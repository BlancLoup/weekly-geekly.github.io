<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make the online store withstand the load of 280,000 visitors per hour?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Unfortunately, at this stage of web programming development in our country, project refactoring is often perceived as a programmer‚Äôs work...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make the online store withstand the load of 280,000 visitors per hour?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/8b1/711/45d/8b171145d87c9b1b037ee65609ab9cd4.jpg"><br>  Hi, Habr! <br><br>  Unfortunately, at this stage of web programming development in our country, project refactoring is often perceived as a programmer‚Äôs work in the ‚Äúall bad‚Äù mode and is carried out only at the moment when the site is already in a critical state.  We had to deal with a similar situation in 2012, when one large Russian online store came to our service with the following problem: starting from 10 am, the site fell every half hour for 5-10 minutes and rose either with great difficulty or after a hard reboot .  After the reboots, the site worked a little, and then fell again.  The fact that the New Year was approaching, the high season for all selling websites, and in this case the phrase ‚Äúin 10 minutes the company loses tens of thousands of dollars‚Äù was not a joke, gave particular urgency to the problem. <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage2/a3c/d04/846/a3cd04846c6ccd8e5b6f5256ca4a9bca.jpg"><br>  Let's digress from our story a bit and talk about the fact that developers are now exceptionally happy people.  Finally, server capacities have become so cheap that any system with a shortage of resources can be easily scaled to the desired size.  Is something wrong programmed?  Increased the load on the percent?  Great, let's add a proc server.  Not enough operatives?  Let's add operatives.  The problem of lack of resources is not a problem. <br><br>  Many of you remember very well the time when people sat on a dial-up, thoughtfully listened to the sound of the modem, determining from the first notes whether it was possible to connect or to reconnect.  At that time, the slow site simply closed in a minute, because it was very expensive to wait for it (in the literal sense of the word).  Today, a slow site is a site that opens <b>for more than 3 seconds</b> without taking into account the speed of the channel.  The world is increasing speed, time is expensive.  And what if the site does not have enough speed?  There are wonderful accelerators and more powerful and very cheap servers, there is a web cluster from the same 1C-Bitrix, for example, and as a last resort and a sea of ‚Äã‚Äãsoftware for the same purposes.  It seems that you can no longer monitor the quality of the code, dramatically lower the level of developers and significantly save the company's budget. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, it only seems.  In our reality, the reality of web developers, on any of the most powerful hardware there is an endless cycle and a wonderful framework.  <b>And often there are situations when even the most powerful hardware does not pull the written code.</b> <br><br>  This was the case with our client, a large online store mentioned at the beginning.  We saw six powerful servers, each of which could be freely scaled.  The most logical and quick action at that moment was to add another pair of servers, which we immediately did.  However, the site still continued to fall as scheduled. <br><br>  In order to get some time out for normal operation, we decided to somehow stabilize the project first so that it could survive the New Year, and then conduct its global reengineering and refactoring. <br><br><h2>  What did we have at the entrance? </h2><br>  We knew that the graphs of the load on different parts of the system should be fairly smooth.  For example, such: <br><br><img src="https://habrastorage.org/storage2/649/0f5/73a/6490f573aae1387c53c026d438f0b260.jpg"><br><br>  This is due to the fact that very rarely in one second there are zero users on the site, and the next - all 110,000 peak load users. <br><br>  However, what we saw on the client‚Äôs project contradicted our entire practice: all the charts jumped and led erratic lives. <br>  It looked like this: <br><br>  Apache: <br><img src="https://habrastorage.org/storage2/61b/f4d/e63/61bf4de63a5f7a4b7d8041fffd7d126f.jpg"><br><br>  Perhaps it would be worthwhile to enjoy the increased load on schedules - more visitors, more money - but Google Analytics said that the number of visitors not only did not grow, but even fell. <br><br>  As a rule, in a stable and correct system state, an increase in Apache load is correlated with an increase in MySQL load.  But in our case everything looked different. <br><br>  MySQL: <br><img src="https://habrastorage.org/storage2/3a0/36b/6d2/3a036b6d2f9292ddef503131dd954036.jpg"><br><br>  And now let's compare the MySQL and Apache graphics: <br><img src="https://habrastorage.org/storage2/bd2/2d0/8b1/bd22d08b1dbd36e7f63fdeb5a05d0814.jpg"><br><br>  Something obviously went wrong.  And we started looking for a problem. <br><br><h2>  What did we discover? </h2><br>  First, we found the modified core CMS "1C-Bitrix", and it was changed in those parts that work with the cache, which meant a potentially incorrect work with it.  In principle, there was some logic to this - if the cache fails and is reset, then there will be surges on Apache at these moments.  But then there should have been a surge in MySQL, but there were none. <br>  Secondly, due to the changed CMS core, the project has not been updated for several years, since any update has broken the site. <br>  Thirdly, the server was configured incorrectly.  Since our story is about refactoring, we will not dwell on this point in detail. <br>  Fourth, the project was created around 2005-2006 and was calculated on a completely different load - 10 times less than the current one.  The project architecture and code were not designed at all for the increased load.  Requests that, under the old load, were performed within the tolerable 0.5 - 1 seconds, with the new load, were performed already 4‚Äì15 seconds and fell into the slow log. <br>  And fifthly: in the process of customer cooperation with different contractors over the years of the project, there appeared a lot of duplicate code in it, unnecessary cycles and an inefficient cache. <br><br>  Actually, a little debugger, a couple of gigabytes of logs, a live analyst weighing at least 60 kg, salt, pepper, mix - there we got an excellent recipe for quick stabilization of the project.  He was able to survive the peak of the new year and acquired a small, but still a margin of safety. <br><img src="https://habrastorage.org/storage2/f45/d98/f9e/f45d98f9e319531d46cf24e9a5416a0d.jpg"><br><br><h2>  How to fix everything else? </h2><br>  Recall that the project was on the "1C-Bitrix."  First, we updated the CMS version to the last one, which led, as we assumed at the beginning, to the fact that a significant part of the functionality stopped working, it had to be restored.  After basic analytics, it turned out that more than 1000 files were changed in the kernel and in standard components.  After the upgrade, the first stage we had to restore the site to a fully functional version.  But this allowed us to connect the Web Cluster module with all the buns. <br><br>  At the second stage, we analyzed the project architecture, database queries and code, and found that, due to the specific architecture, from one catalog page, from 3000 to 4000 queries were generated to the database without a cache, with a cache ‚Äî about two hundred queries.  At the same time, it was dropped non-optimally and with any content update. <br><br>  To optimize queries to the database, we had to modify the structure of information blocks: to denormalize part of the data and transfer part of the data to separate tables.  This made it possible to get rid of the most difficult joins with the execution speed of 30-40s and replace them with several quick selects.  We also put down the indices on the most used data and removed the excess, remaining from the old structure.  All this has significantly increased the overall speed of query execution. <br><br>  We also added a bonus for subsequent developers of the project: in order to make the code easy to read in the future, we scattered thousands of sheets of code into separate classes and files, commented on them and cleaned outdated obsolete files. <br><br><h2>  What is the result? </h2><br>  It took us about 6 months to consistently carry out all the works listed.  Then we conducted load testing on the site.  The tests were from both the external network and the inside of the cluster (to level the effect of the channel speed on the test). <br><br>  On the test graphs from the outside it can be seen that before refactoring and reengineering the system with a load of 25 simultaneous users, the page is loaded for about 8s, and after that - only 4.2s. <br>  Before: <br><img src="https://habrastorage.org/storage2/f04/98b/ac9/f0498bac92969a60efc834d72e8e38e7.jpg"><br>  After: <br><img src="https://habrastorage.org/storage2/62a/5ec/502/62a5ec502b70c06c59ffa1c1d038394e.jpg"><br><br>  On the test graphs from the inside of the cluster, it can be seen that, for example, the main page before refactoring with 200,000 visitors loaded 40s, and began to load 1.9s. <br>  Before: <br><img src="https://habrastorage.org/storage2/708/973/548/70897354816a4d9d5aa26bb5cea4051a.jpg"><br>  After: <br><img src="https://habrastorage.org/storage2/975/58d/c3e/97558dc3e08d72bacf8abe3e1c073c31.jpg"><br><br><h2>  What we have pleased their developers? </h2><br>  We have reduced the number of queries to the database with and without cache.  Increased code readability.  Simplified the internal structure of the project.  Removed obsolete data.  Changed over 14,000 files.  Simplified project scaling.  And in the final - gave a significant margin to the project to increase the load. <br><br><h4>  So that we want to complete the article to advise all web developers: </h4><br><ul><li>  Use server status monitoring.  Usually everything is visible there. </li><li>  Use debuggers, watch out for the most demanding operations and cycles. </li><li>  Cache everything that is used constantly.  Flush the cache in parts, not completely. </li><li>  Keep track of the number of queries to the database as with the cache, and without a cache </li><li>  Profile queries, monitor the amount of data transferred from the database to the Apache.  Follow the logic and optimal execution of the request. </li><li>  Arrange the indexes on the tables in the database. </li><li>  Update CMS. </li></ul><br>  <b>Natalya Chilikina, head of bitrix-development department ADV / web-engineering</b> </div><p>Source: <a href="https://habr.com/ru/post/189016/">https://habr.com/ru/post/189016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189006/index.html">What PHPShop Monitor is made of</a></li>
<li><a href="../189008/index.html">MikroTik - 6in4 or IPv6 without provider support</a></li>
<li><a href="../189010/index.html">Xerox scanners and copiers can change the numbers in documents when copying</a></li>
<li><a href="../189012/index.html">OpenStack Measurements with a Ceilometer</a></li>
<li><a href="../189014/index.html">Design for BFM.ru applications: the general and the particular in the line of native mobile applications for the news portal</a></li>
<li><a href="../189018/index.html">STAR: a miniature all-terrain robot for office buildings</a></li>
<li><a href="../189020/index.html">The role of morphology in computational linguistics</a></li>
<li><a href="../189024/index.html">Is there life without Resharper?</a></li>
<li><a href="../189026/index.html">MPAA hires "Internet analytics" to monitor social networks and forums</a></li>
<li><a href="../189032/index.html">DKIM in Yandex.Mail for Domains - how is email security evolving</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>