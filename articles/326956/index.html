<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The uWSGI Spooler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When designing scalable systems, where you have to access a variety of external components, for example, using a third-party API, sending mail or conv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The uWSGI Spooler</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/23b/7ee/67b/23b7ee67b05e4556818a59a6d7578856.png"><br><p><br>  When designing scalable systems, where you have to access a variety of external components, for example, using a third-party API, sending mail or converting video, the best way to implement is an asynchronous model with a queue system that is the link to the interaction of all system components. </p><br><p>  The most popular queuing system in Python is Celery, it has a wide range of task management capabilities.  Unfortunately, Celery-based systems are difficult to maintain in a healthy state, and when something goes wrong, it is not easy to find a problem.  You can ask any devops about your experience with Celery, but be prepared to hear not very pleasant words. </p><br><p>  Fortunately, there is an alternative solution - uWSGI Spooler, and in this article I will tell about it in more detail. </p><br><a name="habracut"></a><br><p>  The main difference from Celery is that it does not need to use additional components (Celery itself and storage, for example Redis), so the number of points of failure is reduced by two.  As a repository of tasks can be used a directory, external directory or network pool. </p><br><p>  To control Python programs, we often use uWSGI.  Why?  Because it is easy to configure, reliable, flexible and meets most requirements. </p><br><p>  In addition to serving Python code in the form of providing continuous access to a web application, uWSGI includes a <a href="http://uwsgi-docs.readthedocs.io/en/latest/Spooler.html" rel="nofollow">Spooler</a> component that implements a queuing system.  Spooler has some features, and the documentation on it is quite scarce. </p><br><p>  Using uWSGI Spooler is easy, just one-two-three!  But there are a few nuances. <br>  The uwsgi module cannot be imported from the code, and the code cannot be tested from the console accordingly, you need to run the uwsgi worker every time, for which you need to create a config: </p><br><pre><code class="hljs pgsql">[uwsgi] socket = /var/run/mysite.sock master = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> processes = <span class="hljs-number"><span class="hljs-number">4</span></span> project_dir = /home/myuser/mysite chdir = %(project_dir) spooler = /var/uwsgi_spools/mysite_spool spooler-<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> = <span class="hljs-type"><span class="hljs-type">path</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>.spool.package # (package <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> spool file) spooler-frequency = <span class="hljs-number"><span class="hljs-number">10</span></span> # Frequency <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> scanning spool max-requests = <span class="hljs-number"><span class="hljs-number">5000</span></span> module = wsgi:application touch-reload = wsgi.py</code> </pre> <br><p>  Worker file: </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uwsgidecorators <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> spool, uwsgi @spool <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args)</span></span></span><span class="hljs-function">:</span></span> print(args) <span class="hljs-comment"><span class="hljs-comment"># do some job</span></span></code> </pre> <br><p>  Setting a problem from your code: </p><br><pre> <code class="hljs haskell"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uwsgi_spools.mysite_spool <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mysite_spool mysite_spool.my_func.spool(<span class="hljs-title"><span class="hljs-title">test</span></span>=<span class="hljs-type"><span class="hljs-type">True</span></span>)</code> </pre> <br><p>  As you can see from the example, the threshold for entering is very low. </p><br><p>  Inside the task there is a single argument that contains a dictionary with three service keys (function name <b>ud_spool_func</b> , <b>task</b> name spooler_task_name, <b>task</b> status <b>ud_spool_ret</b> ) and all the parameters that were passed when creating the task, for example, the <b>test</b> key. </p><br><p>  Task can return three statuses: </p><br><ul><li>  -2 (SPOOL_OK) - task completed, will be removed from the queue; </li><li>  -1 (SPOOL_RETRY) - something went wrong, the task will be recalled; </li><li>  0 (SPOOL_IGNORE) - ignore task. </li></ul><br><p>  All other values ‚Äã‚Äãwill be interpreted as -1 (SPOOL_RETRY). </p><br><p>  Feature: the <code>@spool</code> decorator <code>@spool</code> executed once (returns SPOOL_OK) if the function did not fall with the exception. <br>  In order to manage the life cycle you need to use <code>@spoolraw</code> . </p><br><p>  Special keys (auxiliary) when creating a task: </p><br><ul><li>  <b>spooler</b> - the absolute path to the spooler that will perform the task; </li><li>  <b>at</b> - unix time, when the task should be executed (more correctly, it will not be executed earlier than this value); </li><li>  <b>priority</b> - indicates a subfolder in the task folder (a greater number of workers can be allocated to such a subfolder), using --spooler-ordered, you can set priorities; </li><li>  <b>body</b> - this key is used for values ‚Äã‚Äãgreater than 64 KB, the task will be available in serialized form. </li></ul><br><p>  In addition to the <code>@spool</code> decorator, the <code>@spool</code> decorator is <code>@timer</code> , which takes the number of seconds as an argument and allows you to perform the function to be decorated at a specified interval. </p><br><pre> <code class="hljs ruby">@timer(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args)</span></span></span></span>: print(args) <span class="hljs-comment"><span class="hljs-comment"># do some job every 30 sec</span></span></code> </pre> <br><p>  Similar to <code>@timer</code> there is the <code>@timer</code> decorator, which will restart the execution of the function (completion of the task with the status SPOOL_RETRY). </p><br><pre> <code class="hljs ruby">@spoolforever <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args)</span></span></span></span>: print(args) <span class="hljs-comment"><span class="hljs-comment"># do some job and repeat</span></span></code> </pre> <br><p>  To set up workers to work over the network, you need to add the address where it will be available in the ini-file: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">socket</span></span> = <span class="hljs-number"><span class="hljs-number">127.0.0.1:10001</span></span></code> </pre> <br><p>  When creating a task, specify the address of the recipient of the task: </p><br><pre> <code class="hljs cmake">uwsgi.send_message(‚Äú<span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>:<span class="hljs-number"><span class="hljs-number">10001</span></span>‚Äù, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  uwsgi.spool(test=True, spooler=‚Äú127.0.0.1:10001‚Äù)</span></span></code> </pre> <br><p>  Thus, uWSGI Spooler can be used as a substitute for queues, but if you still lack opportunities or want some sugar, you can use <a href="https://pypi.python.org/pypi/uwsgi-tasks" rel="nofollow">uwsgi-tasks</a> , which implements the missing. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326956/">https://habr.com/ru/post/326956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326944/index.html">Video marketing in social networks: the most important indicators in 2017</a></li>
<li><a href="../326946/index.html">Microsoft and Rambus cool memory to cryogenic temperature</a></li>
<li><a href="../326948/index.html">Bad advice on setting up a backup and a few tales</a></li>
<li><a href="../326952/index.html">Brainstorming for the lazy or Individual intellectual activity, or Basics of divergent thinking in practice</a></li>
<li><a href="../326954/index.html">Open broadcast of the main conference room Mobius 2017: Let's talk about the architecture of mobile applications and something else</a></li>
<li><a href="../326958/index.html">From weekly sysadmin: unpack NetApp FAS 9000</a></li>
<li><a href="../326960/index.html">Duck says ‚Äúquack-krya‚Äù, the cow says ‚Äúmu-mu‚Äù, ‚ÄúRunn Me!‚Äù - another PHP framework * tells us. Part 1</a></li>
<li><a href="../326962/index.html">Reactive applications with the RxPM pattern. Goodbye MVP and MVVM</a></li>
<li><a href="../326964/index.html">Mobile Device Manager Plus - long-awaited perfection or is it still not?</a></li>
<li><a href="../326966/index.html">Hallucinate like Trump, or mini-analysis of Recurrent Neural Networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>