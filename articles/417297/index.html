<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fear and Loath Threat Intelligence or 8 TI Practical Tips</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We had two commercial APT subscriptions, ten information exchanges, about ten free feeds, and a Torah exit-node list. And also heels of strong reverse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fear and Loath Threat Intelligence or 8 TI Practical Tips</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/31/k_/ho/31k_hosvjz67wnrm9qu0rrd_pp0.jpeg"><br><br>  We had two commercial APT subscriptions, ten information exchanges, about ten free feeds, and a Torah exit-node list.  And also heels of strong reversers, master powershell scripts, loki-scanner and a paid subscription to virustotal.  Not that without this the monitoring center does not work, but if you are used to catching complex attacks, then you have to go to this hobby to the end.  Most of all, we were worried about the potential automation of checking for indicators of compromise.  There is nothing more immoral than artificial intelligence, replacing a person at work, where you have to think.  But we understood that with an increase in the number of customers, sooner or later we will plunge into it. <br><a name="habracut"></a><br>  Many say that Threat Intelligence is tasty, but not everyone fully understands how to prepare it.  Even fewer of those who understand what processes need to be built for TI to work and bring profit.  And very few people know how to choose a feed provider, where to check the indicator for fols, and whether it is necessary to block the domain that the colleague sent to WhatsApp. <br><br>  For several years of constant work with TI, we managed to go through different rakes and today we want to give some practical tips that will help newcomers avoid mistakes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Council number 1.  Do not feed high hopes to catch something in the hash: most of the malware has long been polymorphic </h3><br>  <a href="https://habr.com/company/solarsecurity/blog/343574/">In the last article,</a> we talked about what TI is and gave a few examples of how the work process is organized.  Let me remind you that information about threats (threat intelligence) comes in different formats and views: these can be both IP addresses of botnet control centers, email addresses of senders of phishing emails, and articles describing circumvention techniques that APT groups have -He will begin to use.  In general, a lot of things happen. <br><br>  To streamline all this mess, a few years ago, David Bianco proposed the so-called <a href="http://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html">"pyramid of pain</a> . <a href="http://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html">"</a>  It describes quite well the relationship between the types of indicators that you use to detect an attacker and how much pain you give an attacker if you can detect a specific type of indicator. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/ix/mv/lzixmvhlrhcdqpcjwi63chisyzq.png"></div><br><br>  For example, if you know the MD5 hash of a malicious file, it can be quite easily and accurately detected.  However, this will bring very little pain to the attacker - just add 1 bit of information to the file, and the hash is different. <br><br><h3>  Council number 2.  Try to use those indicators, the change of which will be technically difficult or uneconomical for an attacker. </h3><br>  Anticipating the question of how to find out if there is a file with this hash on the workstations of our enterprise, I answer: there are different ways.  One of the easiest is to install Kaspersky Security Center, which contains the database of MD5 hashes of all executable files in an enterprise, to which you can make a SELECT. <br><br>  Let's go back to the pyramid of pain.  In contrast to hash detection, it will be more productive if you can detect the attacker's TTP (tactics, technique, procedure).  It is more complicated and requires more effort, but then you will deliver more pain. <br><br>  For example, if you know that the APT-group, aimed at your sector of the economy, distributes phishing emails with * .HTA files, developing a detection rule that searches for files in mail with similar attachments will hit the attacker a lot.  He will have to change the tactics of mailing, perhaps even by investing hard-earned $ in the purchase of 0-day or 1-day exploits, but this is not cheap ... <br><br><h3>  Council number 3.  Do not have high hopes regarding the detection rules that you did not develop, you will have to check for false positives and refine </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lb/fi/gx/lbfigxu0qc_msq7-qwn3hng6svw.jpeg"></div><br>  When designing detection rules, there is always a temptation to use ready-made rules.  A free example is the <a href="https://github.com/Neo23x0/sigma">Sigma</a> repository - a SIEM-independent format of detection rules, which allows translating rules from the Sigma language into ElasticSearch requests and Splunk or Arcsight rules.  At the same time, the repository contains about 200 rules, of which ~ 130 describe attacks on Windows.  At first glance, very cool, but the devil, as always, in the details. <br><br>  Let's take a closer look at <a href="">one of the rules for</a> detecting mimikatz: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/sw/eu/cgsweugcondwgea0klgqmwafznw.png"></div><br>  The rule detects processes that have attempted to read the memory of the lsass.exe process.  Mimikatz does this when trying to get NTLM hashes, and the rule detects the malware. <br><br>  However, we, as specialists who deal not only with detection, but also with incident response, it is extremely important that this really be a mimikatz.  Unfortunately, in practice there are many other legitimate processes that read lsass.exe memory with the same masks (some antiviruses, for example).  Therefore, in a real combat environment, such a rule will bring more false positives than good. <br><br>  There are even more interesting incidents associated with the automatic translation of rules from Sigma to SIEM rules: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xu/0t/9l/xu0t9lchwgmepeu0hh9xnp92yko.png"></div><br>  At one of the webinars, colleagues from SOC Prime, who supply paid detection rules, showed a non-working example of such a translation: the deviceProduct field in the SIEM should be equal to both Sysmon and Microsoft Windows, which is impossible. <br><br>  I do not want to blame anyone and poke a finger - everyone folsyat, this is normal.  However, Threat Intelligence consumers need to understand that re-checking and refinement of the rules obtained from both public and private sources is still necessary. <br><br><h3>  Tip # 4. Check domain names and IP addresses for damage not only on the proxy server and the firewall, but also in the DNS server logs, paying attention to both successful and unsuccessful resolution attempts. </h3><br>  Malicious domains and IP addresses are the best indicator in terms of ease of detection and the amount of pain you give an attacker.  But with them, everything is simple only at first glance.  At a minimum, it is worth wondering where to get the domain log. <br><br>  If we confine ourselves to checking only the proxy server logs, you can miss out on malicious software that tries to contact the network directly or requests a non-existent domain name generated via DGA, not to mention DNS tunnels - all this will not be in the corporate proxy logs. <br><br><h3>  Council number 5.  ‚ÄúMonitor cannot be blocked‚Äù - put a comma only after you have learned what kind of indicator it is and you have realized the possible consequences of blocking </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0x/cl/hi/0xclhi5dr1fohibe7rbsjseyze4.jpeg"></div><br>  Before each practitioner by the security officer there was a difficult question: to block the threat or monitor and, if there are any signs of trouble, start an investigation?  In some regulations and instructions they directly write - block, and sometimes this action is wrong. <br><br>  If the indicator is the domain name used by the APT grouping, <u>do not put it on the lock</u> , but start monitoring.  Modern tactics of targeted attacks imply the presence of an additional covert backup communication channel, which can only be revealed during a detailed investigation.  Automatic blocking in this case will impede the search for this channel, and comrades on the other side of the barricades will quickly understand what you have learned about their activities. <br><br>  On the other hand, if the indicator is the domain of the cryptographer, then it <u>should</u> already <u>be put on block</u> .  But do not forget to monitor unsuccessful attempts to contact blocked domains - several management server addresses can be embedded in the cryptographer configuration.  Some of them may be missing in the feeds and, accordingly, will not be blocked.  Sooner or later, the malware will contact them to obtain the key, which will instantly encrypt the host.  To ensure that you have blocked all the addresses of the management server, only the sample can reverse-analyze. <br><br><h3>  Council number 6.  Check all incoming indicators for relevance before putting them on monitoring or blocking. </h3><br>  Remember that information about threats is created by people who are prone to make mistakes, or machine learning algorithms, which suffer from it all the more.  We have already witnessed how various providers of paid reports on the activities of APT-groups accidentally add quite legitimate samples to the lists of malicious MD5.  Even if paid reports on threats contain poor-quality indicators, what can we say about indicators obtained by means of intelligence from open sources.  TI analysts do not always check the indicators they create for false positives; as a result, such a check falls on the shoulders of the consumer. <br><br>  For example, if you received the IP address of a regular Zeus or Dimnie modification, before using it in detection systems, <u>check whether it is part of the hosting or a service that says your IP</u> .  Otherwise it will be unpleasant to disassemble a huge number of false positives, when users of the site hosted on this hosting will go to completely non-malicious sites.  This check can be easily performed using: <br><br><ol><li>  Categorization services that will tell you about the site‚Äôs activities.  For example, ipinfo.io directly writes type: ‚Äúhosting‚Äù. </li><li>  Reverse IP services that tell you how many domains are registered on this IP address.  If a lot of them, with a high probability in front of you hosting sites. </li></ol><br>  So, for example, the result of testing the indicator, which is an indicator of the Cobalt APT-grouping (according to the report of a respected TI-vendor), looks like: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qa/f-/dw/qaf-dw_6qr6st4mkhd6ju0owzzs.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bc/dk/gy/bcdkgys-vierrjaj2san0gjz79k.png"></div><br>  We, the response specialists, understand that the gentlemen from Cobalt must have used this IP address.  However, there is no benefit from this indicator - it is irrelevant because it gives too many false positives. <br><br><h3>  Council number 7.  Automate all the processes for dealing with information about threats.  Start simple - fully automate testing for false positives through a stop-list with further setting of non-expansive indicators for monitoring in SIEM </h3><br>  Preventing a large number of false positives related to intelligence and obtained from open sources can be a preliminary search for these indicators in stop lists (warning lists).  Such lists can be formed based on Alexa rating (top 1000), addresses of internal subnets, domains of major service providers like Google, Amazon AWS, MS Azure and other hosts.  Also, a solution that dynamically changes stop-lists consisting of top domains / IP addresses visited by employees in the last week or month will be extremely effective. <br><br>  Developing such lists and a verification system can be difficult for an average SOC, so it makes sense here to think about implementing so-called Threat Intelligence platforms.  About half a year ago Anti-malware.ru had a good <a href="https://www.anti-malware.ru/practice/methods/threat-intelligence-platform">overview of</a> paid and free solutions of this class. <br><br><h3>  Council number 8.  Scan the host indicators for the entire enterprise, not just the hosts that are connected to the SIEM. </h3><br>  Due to the fact that, as a rule, not all enterprise hosts are connected to SIEM, it is not possible to check them for the presence of a malicious file with a specific name or path using only standard SIEM functionality.  Get out of this situation in the following ways: <br><br><ol><li> Use IoC scanners like <a href="https://github.com/Neo23x0/Loki">Loki</a> .  You can run it on all hosts of the enterprise through the same SCCM, and redirect the output to a shared network folder. </li><li>  Use vulnerability scanners.  Some of them have compliance-regimes in which you can check the availability of a specific file for a specific path. </li><li>  Write the powershell script and run it through WinRM.  If you write laziness yourself, you can use one of the numerous scripts, for example, this <a href="https://cyberforce.be/2016/03/31/remote-ioc-scanning-powershell/">one</a> . </li></ol><br>  As I said at the beginning, this article does not imply comprehensive information on how to work correctly with Threat Intelligence.  However, in our experience, compliance with even these simple rules will allow beginners not to step on the rake and begin immediately with effective work with various indicators of compromise. </div><p>Source: <a href="https://habr.com/ru/post/417297/">https://habr.com/ru/post/417297/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417285/index.html">Where to insert quotation mark in IPv6</a></li>
<li><a href="../417287/index.html">"Calendar of the tester" for July. Analytics testing</a></li>
<li><a href="../417289/index.html">Internship Diary: Day 1. From intern to junior</a></li>
<li><a href="../417293/index.html">Password recovery and primary storage in the cloud, or What's new in Zimbra 8.8.9</a></li>
<li><a href="../417295/index.html">As I wrote the standard C ++ 11 library or why the boost is so scary. Chapter 3</a></li>
<li><a href="../417299/index.html">Online, offline and P2P: how to buy bitcoin in Russia</a></li>
<li><a href="../417301/index.html">Smooth release recipe: PMy to note</a></li>
<li><a href="../417303/index.html">Hack to support buttons Android-headset under Windows</a></li>
<li><a href="../417305/index.html">Ultima Online: a look from behind the scenes</a></li>
<li><a href="../417307/index.html">Glaucoma - not heard of it? Meet the serial silent view killer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>