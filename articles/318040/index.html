<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Angular2 + Websocket + RxJS + Rails5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! This article is about how to connect the Angular2 client application with a Rails 5 server using Websocket. 

 Rails 
 For example, we need the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Angular2 + Websocket + RxJS + Rails5</h1><div class="post__text post__text-html js-mediator-article"><img src="http://swagger.websters.com.ua/cover.jpg" alt="image"><br><br>  Hello!  This article is about how to connect the Angular2 client application with a Rails 5 server using Websocket. <br><a name="habracut"></a><br><h2>  Rails </h2><br>  For example, we need the simplest ApplicationCable :: Channel: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatChannel</span></span></span><span class="hljs-class"> &lt; ApplicationCable::Channel </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscribed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream_from</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chat_channel</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActionCable</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">broadcast</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chat_channel</span></span></span><span class="hljs-class">', { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">serialize_all</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> ) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">[ '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">' ], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">[ '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">' ] );</span></span> ActionCable.server.broadcast <span class="hljs-string"><span class="hljs-string">'chat_channel'</span></span>, { <span class="hljs-symbol"><span class="hljs-symbol">messages:</span></span> Message.serialize_all( Message.all ) } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unsubscribed</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Angular2 </h2><br><h3>  WebSocketService </h3><br>  First we need a service that will provide our application data exchange with the server: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Injectable } from <span class="hljs-string"><span class="hljs-string">"@angular/core"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Subject, Observable, Subscription } from <span class="hljs-string"><span class="hljs-string">'rxjs/Rx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { WebSocketSubject } from <span class="hljs-string"><span class="hljs-string">"rxjs/observable/dom/WebSocketSubject"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Injectable()</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebSocketService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ws: WebSocketSubject&lt;Object&gt;; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> socket: Subscription; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> url: string; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> message: Subject&lt;Object&gt; = new Subject(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> opened: Subject&lt;boolean&gt; = new Subject(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> close():void{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.socket.unsubscribe(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ws.complete(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> sendMessage( message:string ):void{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ws.next( message ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> start( url: string ):void{ let self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url = url; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ws = Observable.webSocket( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.socket = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ws.subscribe( { next: ( <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:MessageEvent ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>[ <span class="hljs-string"><span class="hljs-string">'type'</span></span> ] == <span class="hljs-string"><span class="hljs-string">'welcome'</span></span> ){ self.opened.next( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.message.next( <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> ); }, error: () =&gt; { self.opened.next( <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.message.next( { type: <span class="hljs-string"><span class="hljs-string">'closed'</span></span> } ); self.socket.unsubscribe(); setTimeout( () =&gt; { self.start( self.url ); }, <span class="hljs-number"><span class="hljs-number">1000</span></span> ); }, complete: () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.message.next( { type: <span class="hljs-string"><span class="hljs-string">'closed'</span></span> } ); } } ); } }</code> </pre><br>  This service has 3 private and 2 public variables, as well as 3 public functions. <br><br><pre> <code class="ruby hljs">private <span class="hljs-symbol"><span class="hljs-symbol">ws:</span></span> WebSocketSubject&lt;Object&gt;; private <span class="hljs-symbol"><span class="hljs-symbol">socket:</span></span> Subscription; private <span class="hljs-symbol"><span class="hljs-symbol">url:</span></span> string;</code> </pre><br>  ws is the observed WebSocketSubject variable. <br>  socket is a variable for subscribing to ws. <br>  url - link to the socket. <br><br><pre> <code class="ruby hljs">public <span class="hljs-symbol"><span class="hljs-symbol">message:</span></span> Subject&lt;Object&gt; = new Subject(); public <span class="hljs-symbol"><span class="hljs-symbol">opened:</span></span> Subject&lt;boolean&gt; = new Subject();</code> </pre><br>  message - an observable variable to which all data from the socket is translated. <br>  opened - an observable variable that monitors the opening / closing of the connection with the socket. <br><br><pre> <code class="ruby hljs">public close()<span class="hljs-symbol"><span class="hljs-symbol">:void</span></span>{ this.socket.unsubscribe(); this.ws.complete(); }</code> </pre><br>  Function to close the socket. <br><br><pre> <code class="ruby hljs">public sendMessage( <span class="hljs-symbol"><span class="hljs-symbol">message:</span></span>string )<span class="hljs-symbol"><span class="hljs-symbol">:void</span></span>{ this.ws.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( message ); }</code> </pre><br>  Function to send data to the socket. <br><br><pre> <code class="ruby hljs">public start( <span class="hljs-symbol"><span class="hljs-symbol">url:</span></span> string )<span class="hljs-symbol"><span class="hljs-symbol">:void</span></span>{ let <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = this; this.url = url; this.ws = Observable.webSocket( this.url ); this.socket = this.ws.subscribe( { <span class="hljs-symbol"><span class="hljs-symbol">next:</span></span> ( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span>MessageEvent ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'type'</span></span> ] == <span class="hljs-string"><span class="hljs-string">'welcome'</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.opened.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); } this.message.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( data ); }, <span class="hljs-symbol"><span class="hljs-symbol">error:</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.opened.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); this.message.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( { <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'closed'</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.socket.unsubscribe(); setTimeout( () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.start( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.url ); }, <span class="hljs-number"><span class="hljs-number">1000</span></span> ); }, <span class="hljs-symbol"><span class="hljs-symbol">complete:</span></span> () =&gt; { this.message.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( { <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'closed'</span></span> } ); } } ); }</code> </pre><br>  This function opens a connection with the socket by writing its object to the observed variable and subscribes to the broadcast from it.  When the connection is lost every second tries to restore the connection. <br><br><h3>  ChannelWebsocketService </h3><br>  Inherited service for subscribing to Rails5 Action Cable channels: <br><br><pre> <code class="ruby hljs">import { Injectable } from <span class="hljs-string"><span class="hljs-string">"@angular/core"</span></span>; import { Subject } from <span class="hljs-string"><span class="hljs-string">"rxjs/Subject"</span></span>; import { WebSocketService } from <span class="hljs-string"><span class="hljs-string">"./websocket.service"</span></span>; @Injectable() export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelWebsocketService</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">socketStarted</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">boolean</span></span></span><span class="hljs-class">;</span></span> public <span class="hljs-symbol"><span class="hljs-symbol">observableData:</span></span> Subject&lt;Object&gt; = new Subject(); public <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span>Object = {}; public <span class="hljs-symbol"><span class="hljs-symbol">identifierStr:</span></span> string; public <span class="hljs-symbol"><span class="hljs-symbol">subscribed:</span></span> Subject&lt;boolean&gt; = new Subject(); constructor( private <span class="hljs-symbol"><span class="hljs-symbol">websocketService:</span></span> WebSocketService ){ this.observeOpened(); this.observeMessage(); } private static encodeIdentifier( <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span>string )<span class="hljs-symbol"><span class="hljs-symbol">:Object</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JSON.parse( identifier ); } private static getDataString( <span class="hljs-symbol"><span class="hljs-symbol">parameters:</span></span>Object )<span class="hljs-symbol"><span class="hljs-symbol">:string</span></span>{ let first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, result = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( let key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parameters ){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( first ){ first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; result += <span class="hljs-string"><span class="hljs-string">`\"${ key }\":\"${ parameters[ key ] }\"`</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result += <span class="hljs-string"><span class="hljs-string">`, \"${ key }\":\"${ parameters[ key ] }\"`</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`{ ${ result } }`</span></span>; } private getSubscribeString()<span class="hljs-symbol"><span class="hljs-symbol">:string</span></span>{ this.identifierStr = ChannelWebsocketService.getDataString( this.identifier ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JSON.stringify( { <span class="hljs-symbol"><span class="hljs-symbol">command:</span></span> <span class="hljs-string"><span class="hljs-string">'subscribe'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span> this.identifierStr } ); }; private isThisChannel( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span>Object )<span class="hljs-symbol"><span class="hljs-symbol">:boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'identifier'</span></span> ] ){ let identifier = ChannelWebsocketService.encodeIdentifier( data[ <span class="hljs-string"><span class="hljs-string">'identifier'</span></span> ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( JSON.stringify( identifier ) === JSON.stringify( this.identifier ) ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } private observeMessage(){ let <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = this; this.websocketService.message.subscribe( ( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> Object ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isThisChannel( data ) ){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'type'</span></span> ] &amp;&amp; data[ <span class="hljs-string"><span class="hljs-string">'type'</span></span> ] == <span class="hljs-string"><span class="hljs-string">'confirm_subscription'</span></span> ){ this.subscribed.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( data[ <span class="hljs-string"><span class="hljs-string">'message'</span></span> ] ){ this.observableData.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'message'</span></span> ] ); } } } ); } private observeOpened(){ let <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = this; this.websocketService.opened.subscribe( ( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> boolean ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.socketStarted = data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data ){ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscribe(); } } ); } private subscribe(){ this.websocketService.sendMessage( this.getSubscribeString() ); } public send( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> Object ){ this.websocketService.sendMessage( JSON.stringify( { <span class="hljs-symbol"><span class="hljs-symbol">command:</span></span><span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span> this.identifierStr, <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> ChannelWebsocketService.getDataString( data ) } ) ); } public unsubscribe(){ this.websocketService.sendMessage( JSON.stringify( { <span class="hljs-symbol"><span class="hljs-symbol">command:</span></span> <span class="hljs-string"><span class="hljs-string">'unsubscribe'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span> this.identifierStr } ) ); this.subscribed.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); } }</code> </pre><br>  This service has 2 private and 3 public variables, as well as 7 private and 2 public functions. <br><br><pre> <code class="ruby hljs">private <span class="hljs-symbol"><span class="hljs-symbol">socketStarted:</span></span> boolean; private <span class="hljs-symbol"><span class="hljs-symbol">identifierStr:</span></span> string;</code> </pre><br>  socketStarted - a variable in which the state of the subscription to the socket is broadcast. <br>  identifierStr is a specially prepared string identifier for the Rails5 Action Cable channel. <br><br><pre> <code class="ruby hljs">public <span class="hljs-symbol"><span class="hljs-symbol">observableData:</span></span> Subject&lt;Object&gt; = new Subject(); public <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span>Object = {}; public <span class="hljs-symbol"><span class="hljs-symbol">subscribed:</span></span> Subject&lt;boolean&gt; = new Subject();</code> </pre><br>  observableData - the observable variable in which the message is written from the socket for the channel. <br>  identifier - object identifier for the Rails5 Action Cable channel. <br>  subscribed - an observable variable in which the subscription state is written. <br><br><pre> <code class="ruby hljs">constructor( private <span class="hljs-symbol"><span class="hljs-symbol">websocketService:</span></span> WebSocketService ){ this.observeOpened(); this.observeMessage(); } ... private observeMessage(){ let <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = this; this.websocketService.message.subscribe( ( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> Object ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isThisChannel( data ) ){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'type'</span></span> ] &amp;&amp; data[ <span class="hljs-string"><span class="hljs-string">'type'</span></span> ] == <span class="hljs-string"><span class="hljs-string">'confirm_subscription'</span></span> ){ this.subscribed.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( data[ <span class="hljs-string"><span class="hljs-string">'message'</span></span> ] ){ this.observableData.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'message'</span></span> ] ); } } } ); } private observeOpened(){ let <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = this; this.websocketService.opened.subscribe( ( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> boolean ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.socketStarted = data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data ){ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscribe(); } } ); }</code> </pre><br>  In the constructor of this service, we call 2 functions: observeMessage and observeOpened, which track the data sent by the socket and the state of the socket, respectively. <br><br><pre> <code class="ruby hljs">private static encodeIdentifier( <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span>string )<span class="hljs-symbol"><span class="hljs-symbol">:Object</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JSON.parse( identifier ); } private static getDataString( <span class="hljs-symbol"><span class="hljs-symbol">parameters:</span></span>Object )<span class="hljs-symbol"><span class="hljs-symbol">:string</span></span>{ let first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, result = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( let key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parameters ){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( first ){ first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; result += <span class="hljs-string"><span class="hljs-string">`\"${ key }\":\"${ parameters[ key ] }\"`</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result += <span class="hljs-string"><span class="hljs-string">`, \"${ key }\":\"${ parameters[ key ] }\"`</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`{ ${ result } }`</span></span>; }</code> </pre><br>  encodeIdentifier - the static private function decodes the identifier string that the socket returned to identify the message as belonging to the channel. <br>  getDataString - converts an object to a string format that accepts Rails5 Action Cable. <br><br><pre> <code class="ruby hljs">private getSubscribeString()<span class="hljs-symbol"><span class="hljs-symbol">:string</span></span>{ this.identifierStr = ChannelWebsocketService.getDataString( this.identifier ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JSON.stringify( { <span class="hljs-symbol"><span class="hljs-symbol">command:</span></span> <span class="hljs-string"><span class="hljs-string">'subscribe'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span> this.identifierStr } ); };</code> </pre><br>  Returns a string to subscribe to a Rails5 Action Cable channel. <br><br><pre> <code class="ruby hljs">private isThisChannel( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span>Object )<span class="hljs-symbol"><span class="hljs-symbol">:boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data[ <span class="hljs-string"><span class="hljs-string">'identifier'</span></span> ] ){ let identifier = ChannelWebsocketService.encodeIdentifier( data[ <span class="hljs-string"><span class="hljs-string">'identifier'</span></span> ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( JSON.stringify( identifier ) === JSON.stringify( this.identifier ) ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  Determines the message belonging to the channel to the socket. <br><br><pre> <code class="ruby hljs">private subscribe(){ this.websocketService.sendMessage( this.getSubscribeString() ); }</code> </pre><br>  Signs to the channel. <br><br><pre> <code class="ruby hljs">public send( <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> Object ){ this.websocketService.sendMessage( JSON.stringify( { <span class="hljs-symbol"><span class="hljs-symbol">command:</span></span><span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span> this.identifierStr, <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> ChannelWebsocketService.getDataString( data ) } ) ); }</code> </pre><br>  Sends data to the Rails5 Action Cable; <br><br><pre> <code class="ruby hljs">public unsubscribe(){ this.websocketService.sendMessage( JSON.stringify( { <span class="hljs-symbol"><span class="hljs-symbol">command:</span></span> <span class="hljs-string"><span class="hljs-string">'unsubscribe'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">identifier:</span></span> this.identifierStr } ) ); this.subscribed.<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>( <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); }</code> </pre><br>  Unsubscribes from the channel. <br><br><h3>  ChatChannelService </h3><br>  The service inherited from ChannelWebsocketService to subscribe to the ChatChannel channel: <br><br><pre> <code class="ruby hljs">import { Injectable } from <span class="hljs-string"><span class="hljs-string">"@angular/core"</span></span>; import { ChannelWebsocketService } from <span class="hljs-string"><span class="hljs-string">"./channel.websocket.service"</span></span>; import { WebSocketService } from <span class="hljs-string"><span class="hljs-string">"./websocket.service"</span></span>; @Injectable() export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatChannelService</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelWebsocketService</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">constructor</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">websocketService</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebSocketService</span></span></span><span class="hljs-class"> ){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">websocketService</span></span></span><span class="hljs-class"> );</span></span> this.identifier = { <span class="hljs-symbol"><span class="hljs-symbol">channel:</span></span> <span class="hljs-string"><span class="hljs-string">'ChatChannel'</span></span> }; } }</code> </pre><br>  In the constructor of this service, the identifier variable is redefined to identify the channel. <br><br><h3>  Chatcomponent </h3><br>  Component that using ChatChannelService accepts / sends data to the channel. <br>  I don't give an example of code, it is in GitHub, the link to which is given below <br><br><h2>  Example </h2><br>  <a href="https://github.com/Scorpionsc/Angular2-RxJS-Websocket-Rail5">Here</a> you can download an example. <br><br>  To start the client application, go to the ‚Äúclient‚Äù folder and call: <br><br><pre> <code class="hljs sql">npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> gulp</code> </pre><br>  I hope this article will help to clarify this issue. </div><p>Source: <a href="https://habr.com/ru/post/318040/">https://habr.com/ru/post/318040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318028/index.html">Lord of Wi-Fi: Aruba ClearPass</a></li>
<li><a href="../318030/index.html">New Year's Release SBM 11.2</a></li>
<li><a href="../318032/index.html">Agile in work with outsourcing</a></li>
<li><a href="../318034/index.html">Native advertising: How much it costs, where it is located, what result</a></li>
<li><a href="../318038/index.html">A systematic approach to improving the efficiency of a working web project</a></li>
<li><a href="../318042/index.html">Five powerful F2P monetization patterns that use behavioral economics in UX design</a></li>
<li><a href="../318044/index.html">MyOffice editors toolbar</a></li>
<li><a href="../318046/index.html">About using and understanding the Lerp function in Unity3D</a></li>
<li><a href="../318048/index.html">The story of my startup: 500,000 users in 5 days on a hundred dollar server</a></li>
<li><a href="../318050/index.html">Vulnerability in Nagios monitoring system allows privilege escalation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>