<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DIY digital tachometer on AVR ATtiny2313, KR514ID2 and optocoupler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DIY digital tachometer on AVR ATtiny2313, KR514ID2 and optocoupler 
 Good day. 
 I am issuing for your consideration a simple digital tachometer circu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DIY digital tachometer on AVR ATtiny2313, KR514ID2 and optocoupler</h1><div class="post__text post__text-html js-mediator-article"><h4>  DIY digital tachometer on AVR ATtiny2313, KR514ID2 and optocoupler </h4><br>  Good day. <br>  I am issuing for your consideration a simple digital tachometer circuit on the <b>AVR ATtiny2313</b> , <b>KR514ID2</b> , and an optocoupler designed by me. <br>  Immediately make a reservation: there are many similar schemes on the Internet.  Each implementation has its pros and cons.  Perhaps someone will suit my option more. <br><br>  I will begin, perhaps, with <b>those.</b>  <b>tasks.</b> <br>  <b>Task</b> : you need to make a digital tachometer to control the speed of the electric motor of the machine. <br>  <b>Introductory conditions</b> : There is a ready reference disk for 20 holes from a laser printer.  In the presence of a lot of optocouplers from broken printers.  Average (working) speed 4 000-5 000 revolutions / minute.  The accuracy of the displayed results should not exceed ¬± 100 revolutions. <br><a name="habracut"></a><br>  <b>Restriction</b> : the power supply for the control unit is 36V (the tachometer will be installed in one case with the control unit - more on this below). <br><br>  <b>A small lyrical digression.</b>  This is my friend's machine.  The machine is equipped with an electric motor PIK-8, which revolutions are controlled according to the scheme found on the Internet and modified.  At the request of a friend, a simple tachometer was developed for the machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Initially, it was planned to use ATMega16 in the scheme, but having considered the conditions, it was decided to confine to ATtiny2313, operating from an internal (RC) generator at a frequency of 4 MHz. <br><br>  <b>The general scheme is</b> as follows: <br><br><img src="https://habrastorage.org/storage2/30c/03b/672/30c03b672a6df614f945c503c93c356b.png"><br><br>  As you can see, nothing complicated.  To convert a binary code into a seven-segment one, I used the decoder CR514ID2, this gives three pluses at once. <br><ul><li>  Firstly, it saves space in the memory of ATtiny2313 by reducing the working code (since the procedure for programmatically converting binary to seven-segment code is absent in the firmware as unnecessary). </li><li>  Secondly: reducing the load on the outputs ATtiny2313, t. To.  the LEDs ‚Äúlight up‚Äù the KR514ID2 (when displaying the number 8, the maximum consumption will be 20-30 mA (typical for one LED) * 7 = 140-210 mA, which is ‚Äúmuch‚Äù for ATtini2313 with its full passport maximum (loaded) consumption of 200 mA). </li><li>  Thirdly, the number of ‚Äúbusy‚Äù legs of the microcontroller has been reduced, which gives us the opportunity in the future (if necessary) to modernize the circuit by adding new features. </li></ul><br><br>  <b>The device</b> is <b>assembled</b> on a breadboard.  For this, the charge from the non-working microwave oven, which was lying in the bins, was dismantled.  Digital LED indicator, key transistors (VT1-VT4) and limiting resistors (R1 - R12) were taken as a set and transferred to a new board.  The entire device is assembled, with the necessary components, with smoke breaks for half an hour.  <u><b>I draw attention:</b> the KR514ID2 chip has a plus power supply leg - 14, and a minus - 6 (marked on the diagram)</u> .  Instead of 5142, you can use any other binary code decoder in the seven-segment with 5V power supply.  I took what was at hand. <br>  Conclusions "h" and "i" of the digital LED indicator are responsible for two points in the center between the numbers, not connected as unnecessary. <br>  After assembly and firmware, provided there are no installation errors, the device starts working immediately after switching on and does not need to be configured. <br><br>  If it is necessary to make changes to the tachometer firmware, an ISP connector is provided on the board. <br><br>  In the diagram, the pull-up resistor R12, with a nominal value of 30 kOhm, is chosen empirically for a specific optocoupler.  As practice shows, it may differ for different optocouplers, but the average value of 30 kŒ© should ensure stable operation for most printer optocouplers.  According to the documentation for ATtiny2313, the size of the internal pull-up resistor is from 20 to 50 kŒ© depending on the implementation of a particular batch of microcontrollers (page 177 of the passport to ATtiny2313), which is not quite suitable.  If anyone wants to repeat the circuit, it can start with an internal pull-up resistor, maybe you will work for your optocouplers and your MK.  It didn't work for me. <br><br>  It looks like a typical optocoupler from the printer. <br><img src="https://habrastorage.org/storage2/906/12d/e9f/90612de9f937a794a0951cd9396ec015.jpg"><br><br>  The optocoupler LED is powered through a 1K limiting resistor, which I placed directly on the board with the optocoupler. <br>  To filter the voltage ripple on the circuit, two capacitors, electrolytic at 220 microfarads x 25V (which was at hand) and ceramic at 0.1 microfarads, (the general circuit for switching on the microcontroller is taken from the ATtiny2313 passport). <br><br>  To protect against dust and dirt, the tachometer board is covered with a thick layer of automotive lacquer. <br><br>  <b>Replacing components.</b> <br>  You can use any LED indicator on four digits, or two doubles, or four single.  At the worst, collect the indicator on separate LEDs. <br><br>  Instead of KP514ID2, KP514ID1 (which contains current-limiting resistors inside), either 564ID5, K155PP5, K155ID9 (when the legs of one segment are connected in parallel), or any other binary to seven-segment converter (with corresponding changes in the connection of the output circuits) can be used. <br><br>  If the installation is properly transferred to the ATMega8 / ATMega16 MK, this firmware will work as on ATtiny2313, but you need to tweak the code (change the names of the constants) and recompile.  For other AVR MK comparison was not conducted. <br><br>  VT1-VT4 transistors - any low-current, operating in the key mode. <br><br>  <b>The principle of operation is</b> based on counting the number of pulses received from the optocoupler in one second and recalculating them to display the number of revolutions per minute.  For this, an internal Timer / Counter1 counter operating in the pulse counting mode at the input of T1 (PD5 pin of 9 MK pin) was used.  For ensuring stability of work, the mode of a software chatter suppression is included.  The countdown of seconds is performed by Timer / Counter0 plus one variable. <br><br>  <b>The calculation of revolutions</b> , on what I would like to dwell upon, occurs according to the following formula: <br> <code>M = (N / 20) *60,</code> <br>  where M is the calculated revolutions per minute (60 seconds), N is the number of pulses from the optocoupler per second, 20 is the number of holes in the reference disk. <br>  Total, simplifying the formula we get: <br> <code>M = N*3.</code> <br>  But!  ATtiny2313 microcontroller is missing a hardware multiplication function.  Therefore, summation with offset was applied. <br>  For those who do not know the essence of the method: <br>  The number 3 can be expanded as <br>  3 = 2 + 1 = 2 <sup>1</sup> + 2 <sup>0</sup> . <br>  If we take our number N, move it to the left by 1 byte and add one more N shifted to the left by 0 byte - we get our number N multiplied by 3. <br>  In the firmware, the code on AVR ASM for a double-byte multiply operation is as follows: <br><br> <code>Mul2bytes3:</code> <br> <code>CLR LoCalcByte //  </code> <br> <code>CLR HiCalcByte</code> <br> <code>mov LoCalcByte,LoInByte //    Timer/Counter1</code> <br> <code>mov HiCalcByte,HiInByte</code> <br> <code>CLC //  </code> <br> <code>ROL LoCalcByte //   </code> <br> <code>ROL HiCalcByte</code> <br> <code>CLC</code> <br> <code>ADD LoCalcByte,LoInByte //    </code> <br> <code>ADC HiCalcByte,HiInByte</code> <br> <code>ret</code> <br> <br>  <b>Verification and accuracy measurement</b> was carried out as follows.  A cardboard disc with twenty holes was glued to the fan of the computer cooler.  The speed of the cooler was monitored via the motherboard BIOS and compared with the tachometer readings.  The deviation was about 20 revolutions at a frequency of 3200 revolutions / minute, which is 0.6%. <br><br><img src="https://habrastorage.org/storage2/ac9/4e5/01c/ac94e501c9ad1aa91fa886b1768bb75f.jpg"><br><br>  It is possible that the real discrepancy is less than 20 revolutions, since  measurements of the motherboard are rounded within 5 revolutions (according to personal observations for one particular board). <br>  The upper limit of measurement is 9,999 revolutions per minute.  The lower limit of measurement, theoretically from ¬± 10 revolutions, but in practice was not measured (one pulse from the optocoupler per second gives 3 revolutions per minute, which, given the error, should theoretically correctly measure the speed from 4 revolutions per minute and higher, but in practice figure must be overestimated at least twice). <br><br>  <b>Separately focus on the issue of nutrition.</b> <br>  The whole circuit is powered from a 5V source, the estimated consumption of the entire device does not exceed 300 mA.  But, according to the terms of the TZ, the tachometer should be located inside the engine speed control unit, and a constant voltage of 36V is supplied to the unit from LATR, in order not to pull a separate power wire, LM317 is installed inside the unit in passport mode, in power down mode to 5V ( limiting resistor and zener diode for protection against accidental overvoltage).  It would be more logical to use a PWM controller in the step-down mode of the converter, similar to MS34063, but in our city it is problematic to buy such things, so they used what they could find. <br><br>  <b>Photos</b> of the tachometer board and the finished device. <br><img src="https://habrastorage.org/storage2/700/797/e1b/700797e1b830ceefa49d32bd91310150.jpg"><br><div class="spoiler">  <b class="spoiler_title">More photos</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/9c4/18d/6ff/9c418d6ff051bbf4619c0675ed669f4d.jpg"><br><img src="https://habrastorage.org/storage2/6f3/be0/3d0/6f3be03d05e4ca88d8768d6db76b5eff.jpg"><br><img src="https://habrastorage.org/storage2/20d/365/bac/20d365bacc4729b8cdaef4ee710afa2e.jpg"><br></div></div><br>  Unfortunately, now there is no opportunity to photograph on the machine. <br><br>  After the layout of the boards and the first test assembly, the box with the device went for painting. <br><br>  <b>The source code,</b> on AVR ASM, the AVR Studio4 project files and the compiled .HEX file are located here: <a href="">http://djkiridza.org.ua/ldd/taho-v029.zip</a> . <br>  The mirror is here: <a href="">http://fileobmen.org.ua/DJ_Kiridza/taho-v029.zip</a> <br><br>  <b>In the event that your tachometer did not start</b> immediately after switching on, with a deliberately correct installation: <br><br>  1) Check the operation of the microcontroller, make sure that it works from the internal generator.  If the circuit is assembled correctly, four zeros should be displayed on the dial. <br><br>  2) Check the level of the pulses from the optocouplers, if necessary, select the value of resistor R12 or replace the wiring diagram of the optocouplers.  It is possible to reverse the connection of the optotransistor with a pull-up to the negative, with the internal pull-up resistor MK turned on or not.  It is also possible to use a transistor in a key (inverting) mode of operation. <br><br>  <b>PS</b> at the request of the customer a tachometer displays not one zero, but four in the absence of pulses from an optocoupler. <br><br>  <b>PPS The</b> tachometer was very sensitive to engine speed.  Minor voltage ripples cause speed deviation, which is immediately displayed on the tachometer screen.  In the future, I plan to do the processing for rounding up the displayed results within ¬± 50 revolutions, if required by the customer. </div><p>Source: <a href="https://habr.com/ru/post/153125/">https://habr.com/ru/post/153125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153115/index.html">Problem on the topic of numbers</a></li>
<li><a href="../153117/index.html">Watch DLink IP Camera on iPhone and Android</a></li>
<li><a href="../153119/index.html">JavaScript is BASIC today! (In a good way.)</a></li>
<li><a href="../153121/index.html">A quick note about feature detection</a></li>
<li><a href="../153123/index.html">Habr-lance</a></li>
<li><a href="../153127/index.html">TypeScript: static analysis, autocompletion and a little ES6 for JavaScript</a></li>
<li><a href="../153129/index.html">‚ÄúSimple Business‚Äù version 1.7.4.0 - more elements of social communications for quick business management</a></li>
<li><a href="../153133/index.html">Pirate Machine: Future Propaganda Against 3D Printers</a></li>
<li><a href="../153135/index.html">What java thread loads my processor</a></li>
<li><a href="../153137/index.html">Another music system from the old "iron"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>