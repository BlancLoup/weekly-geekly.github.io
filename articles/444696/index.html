<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increasing the density of containers on a node using PFCACHE technology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the goals of the hosting provider is the maximum possible utilization of existing equipment to provide quality service to end users. The resour...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increasing the density of containers on a node using PFCACHE technology</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/a-/fc/i7/a-fci74gdtqxnzgdn7b_q41lr3k.jpeg"><br><br>  One of the goals of the hosting provider is the maximum possible utilization of existing equipment to provide quality service to end users.  The resources of the end servers are always limited, but the number of hosted client services, and in our case, a VPS, may vary significantly.  How to get on the Christmas tree and eat a burger, read under the cut. <a name="habracut"></a><br><br>  Sealing a VPS on a node so that clients do not feel this at all greatly helps to improve the economic performance of any hosting provider.  Of course, the node should not crack at the seams if it is crammed with containers to the eyeballs, and any surge in the load is immediately felt by all customers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>How many VPS can be placed on one node depends on many factors, such obvious as:</b> <br><br><ol><li>  Characteristics of the iron itself node </li><li>  VPS size </li><li>  The nature of the load on the VPS </li><li>  Software technologies to help optimize density </li></ol><br>  In this case, we will share the experience of using Pfcache technology for Virtuozzo. <br>  We use the 6th branch, but everything said is true for the 7th. <br><br>  <a href="http://download.parallels.com/doc/pcs/html/Parallels_Cloud_Server_Command_Line_Reference_Guide/35207.htm">Pfcache</a> is a Virtuozzo engine that helps to de-duplicate IOPS and RAM in containers by allocating identical files in containers into a separate common area. <br><br>  <b>In fact, it consists of:</b> <br><br><ol><li>  Kernel code </li><li>  Daemon user-space </li><li>  User-space utilities </li></ol><br>  On the side of the node, we select a whole section in which files will be created, which will be directly used by all the VPS on the node.  In this section, the block device is mounted ploop.  Further, when starting the container, it receives a reference to this section: <br><br><pre><code class="plaintext hljs">[root@pcs13 ~]# cat /proc/mounts ... /dev/ploop62124p1 /vz/pfcache ext4 rw,relatime,barrier=1,data=ordered,balloon_ino=12 0 0 ... /dev/ploop22927p1 /vz/root/418 ext4 rw,relatime,barrier=1,data=ordered,balloon_ino=12,pfcache_csum,pfcache=/vz/pfcache 0 0 /dev/ploop29642p1 /vz/root/264 ext4 rw,relatime,barrier=1,data=ordered,balloon_ino=12,pfcache_csum,pfcache=/vz/pfcache 0 0 ...</code> </pre> <br>  Here are the approximate statistics of the number of files on one of our nodes: <br><br><pre> <code class="plaintext hljs">[root@pcs13 ~]# find /vz/pfcache -type f | wc -l 45851 [root@pcs13 ~]# du -sck -h /vz/pfcache 2.4G /vz/pfcache 2.4G total</code> </pre><br>  <b>The principle of pfcache is as follows:</b> <br><br><ul><li>  User-space daemon Pfcached writes the sha-1 file hash to the xattr attribute of this file.  Files are processed not all, but only in directories / usr, / bin, / usr / sbin, / sbin, / lib, / lib64 </li><li>  Most likely, the files in these directories will be ‚Äúshared‚Äù and will be used by several containers; </li><li>  Pfcached periodically collects statistics reading files from the kernel, analyzes it, and adds files to the cache, if their use is frequent; </li><li>  These directories can be different, and are configured in configuration files. </li><li>  When reading a file, it is checked whether it contains the specified hash in the extended xattr attributes.  If contains, the ‚Äúshared‚Äù file is opened, instead of the container file.  This substitution occurs unnoticed by the container code, and is hidden in the kernel; </li><li>  When writing to a file, the hash is invalid.  Thus, the next time you open it, the container file itself will be opened, and not its cache. </li></ul><br>  Keeping common files from / vz / pfcache in page cache, we achieve saving of this cache, as well as saving of IOPS. Instead of reading ten files from the disk, we read one that goes to the page cache immediately. <br><br><pre> <code class="plaintext hljs">struct inode { ... struct file *i_peer_file; ... }; struct address_space { ... struct list_head i_peer_list; ... }</code> </pre><br>  The VMA list for the file remains the same (deduplicating the memory) and reading it from the disk less often (saving iops).  Our "obshchak" posted on the SSD - an additional gain in speed. <br><br>  An example for caching the / bin / bash file: <br><br><pre> <code class="plaintext hljs">[root@pcs13 ~]# ls -li /vz/root/2388/bin/bash 524650 -rwxr-xr-x 1 root root 1021112 Oct 7 2018 /vz/root/2388/bin/bash [root@pcs13 ~]# pfcache dump /vz/root/2388 | grep 524650 8e3aa19fdc42e87659746f6dc8ea3af74ab30362 i:524650 g:1357611108 f:CP [root@pcs13 ~]# sha1sum /vz/root/2388/bin/bash 8e3aa19fdc42e87659746f6dc8ea3af74ab30362 /vz/root/2388/bin/bash [root@pcs13 /]# getfattr -ntrusted.pfcache /vz/root/2388/bin/bash # file: vz/root/2388/bin/bash trusted.pfcache="8e3aa19fdc42e87659746f6dc8ea3af74ab30362" [root@pcs13 ~]# sha1sum /vz/pfcache/8e/3aa19fdc42e87659746f6dc8ea3af74ab30362 8e3aa19fdc42e87659746f6dc8ea3af74ab30362 /vz/pfcache/8e/3aa19fdc42e87659746f6dc8ea3af74ab30362</code> </pre><br>  Efficiency is calculated using a <a href="https://gist.github.com/vps2fast/eb15c7de0dd7ff38a30e">ready-made script</a> . <br><br>  This script goes through all the containers on the node, calculating the cached files of each container. <br><br><pre> <code class="plaintext hljs">[root@pcs16 ~]# /pcs/distr/pfcache-examine.pl ... Pfcache cache uses 831 MB of memory Total use of pfcached files in containers is 39837 MB of memory Pfcache effectiveness: 39006 MB</code> </pre><br>  Thus, from memory we save about 40 gigabytes of files in containers, they will be loaded from the cache. <br><br>  In order for this mechanism to work even better, it is necessary to place the most ‚Äúidentical‚Äù VPS on the node.  For example, those for which the user has no root access and for which the environment from the deployed image is configured. <br><br>  You can pncache work through the config file <br>  /etc/vz/pfcache.conf <br><br>  MINSIZE, MAXSIZE - minimum / maximum file size for caching <br>  TIMEOUT - timeout between caching attempts <br><br>  A complete list of parameters can be found <a href="https://docs.openvz.org/openvz_command_line_reference.webhelp/_memory_and_iops_deduplication_configuration_file.html">at the link</a> . </div><p>Source: <a href="https://habr.com/ru/post/444696/">https://habr.com/ru/post/444696/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444686/index.html">Waves Smart Assets: Black and White Lists, Interval Trading</a></li>
<li><a href="../444688/index.html">Please stop talking about the repository template with Eloquent</a></li>
<li><a href="../444690/index.html">How researchers at Uber apply and scale knowledge about human behavior</a></li>
<li><a href="../444692/index.html">MOSDROID # 16 Sulfur at Redmadrobot</a></li>
<li><a href="../444694/index.html">As we predicted an outflow, approaching it as a natural disaster.</a></li>
<li><a href="../444700/index.html">Random databases. Oracle Enterprise Data Quality Quality - Corporate Vault Shield and Sword</a></li>
<li><a href="../444702/index.html">New vulnerabilities have been discovered in Android and Google Photos, allowing users to steal data</a></li>
<li><a href="../444704/index.html">Opportunities nanoCAD SPDS Construction site in construction and reconstruction projects in cramped conditions</a></li>
<li><a href="../444710/index.html">We understand the protocol of consensus Stellar</a></li>
<li><a href="../444712/index.html">‚ÄúAtypical attitude to finance‚Äù - that if employees themselves will manage income. Conversation with the flan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>