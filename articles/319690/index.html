<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simplify working with Tableau via Telegram</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Providing access to ready-made reports is often a separate issue. The issue of convenience and prompt access to the results of data processing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simplify working with Tableau via Telegram</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/65c/b07/6b9/65cb076b9328432e9b30e03623372689.jpg" alt="image"><br><br>  Hello.  Providing access to ready-made reports is often a separate issue.  The issue of convenience and prompt access to the results of data processing for management largely determines the fate of their further use.  <a href="http://www.tableau.com/">Tableau</a> system (or simply Tablo) is not in vain popular for such tasks, allowing you to quickly analyze data from many sources, publish online reports on the server, set up automatic distribution of PDF versions of reports and much more. <br><br>  However, even when everything is set up, published and distributed, colleagues face problems: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Regular reports to the mail are lost in the flow of work letters and finding the right does not always work right away. </li><li>  As a rule, online access to reports is protected by corporate VPNs.  In some situations, this is a problem. </li><li>  It is often required to receive a report without waiting for its regular mailing.  For example, a plan-fact for a project for the current month may be required on any given day. </li><li>  sometimes the password from your account on the server is trivially forgotten or the desired report is difficult to find among the other 100500 folders and reports. </li></ul><br>  One of the solutions to such problems is the Telegram bot, which can export PDF reports from the Scoreboard server at the touch of a button and send them to the user.  In this article we will look at the code and examples of the work of the simplest version of such a bot. <br><a name="habracut"></a><br>  We will proceed from the following simplifications: <br><br><ul><li>  The keyboard of the bot consists of the names of the reports that it will send to this user.  The presence of nested menus in the current version is not implied. </li><li>  The bot processes all messages independently of each other, i.e. it does not ‚Äúremember‚Äù the user's previous messages. </li><li>  The presence or absence of access to the report is determined by the chat_id parameter assigned to each user when starting work with the bot (pressing the START button). </li><li>  The bot has one admin who will receive requests for access to reports. </li></ul><br>  For this article, we used the version of Tableau Server 10.1.3 installed on the Amazon Web Services virtual machine: Windows Server 2016 64-bit, RAM 16GB (yes, the Scoreboard server only works on Windows Server).  Examples from the Tableau Samples project, which are installed by default with the Scoreboard server, were taken as exported reports.  For example, such: <br><br><img src="https://habrastorage.org/files/bd4/f06/7ed/bd4f067edcfc40189c0adf1e29fae3ba.jpg" alt="image"><br><br>  There are a lot of excellent examples of how to create a bot in Telegram, but you can just use the <a href="https://core.telegram.org/bots">documentation</a> .  To work with the Telegram API, we use a ready-made <a href="https://github.com/python-telegram-bot/python-telegram-bot">Python library</a> .  We use <a href="https://www.continuum.io/downloads">Python 2.7 Anaconda</a> . <br><br>  <b>B - Security</b> <br><br>  Using Telegram means that we are sending reports from the corporate server somewhere outside.  Accordingly, we need to keep a registry of accesses so that everyone receives only reports submitted to him.  Moreover, it would be necessary to add users / rights without restarting the script.  Find out the user's chat_id at the beginning of work with the bot and immediately give him the necessary access. <br><br>  When a user starts working with a bot, we need to find out his chat_id.  To do this, in the handler of the / start command (the start function in the code), send it to the chat_id to the bot admin who can create a keyboard for the user (that is, chat_id) with reports. <br><br>  When you click the START button, user Ivan Ivanov will receive the message: <br>  Hi, at the moment you do not have access to reports.  Your application has been accepted, access will be provided in the near future. <br><br>  Admin bot will receive a message: <br><br>  Application for access iivanov Ivan Ivanov 123456789 <br><br>  For such a procedure, we will get a YAML file, in which in the users section for each user we will compose a ‚Äúkeyboard‚Äù with the necessary reports.  This format is then quite easy to read in the script and send to the Telegram as a keyboard: <br><br><div class="spoiler">  <b class="spoiler_title">User Access Configuration File</b> <div class="spoiler_text"><pre><code class="python hljs">users: <span class="hljs-number"><span class="hljs-number">123456789</span></span>: keyboard: - <span class="hljs-comment"><span class="hljs-comment">#  ,      - buttonText: 'Global Temperatures' #  ,     reportName: 'Global Temperatures' #      report: '/views/Regional/GlobalTemperatures' #  ,      - buttonText: 'College Admissions' #  ,     reportName: 'College Admissions' #      report: '/views/Regional/College' - #  ,      - buttonText: 'Regional FlightDelays' #  ,     reportName: 'Regional FlightDelays' #      report: '/views/Regional/FlightDelays'</span></span></code> </pre> <br></div></div><br>  In this embodiment, the keyboard will contain two lines: <br><br><img src="https://habrastorage.org/files/f93/a3b/cc4/f93a3bcc4725402ca3944958d5964d09.jpg" alt="image"><br><br>  Converting such a keyboard entry into a Telegram format will be a special function: <br><br><div class="spoiler">  <b class="spoiler_title">Formation of the keyboard for Telegram</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeCustomKeyboard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( userKeyboard )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     .     keyboard    privacy.yaml. """</span></span> custom_keyboard = map( <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> z: [ telegram.KeyboardButton(x[<span class="hljs-string"><span class="hljs-string">'buttonText'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> z ], userKeyboard ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> telegram.ReplyKeyboardMarkup(custom_keyboard, resize_keyboard=<span class="hljs-string"><span class="hljs-string">'True'</span></span>)</code> </pre><br></div></div><br>  The address of the configuration file in the script code is specified by the CONFIG_FILE variable.  To update these parameters during bot operation, use the updateSettings () function. <br><br>  The processing functions of the / start command and messages will update the access registry each time. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateSettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> load( file( CONFIG_FILE ) )</code> </pre><br>  In addition to the file with access for working with the Tablo server, we will need the following parameters: <br><br><div class="spoiler">  <b class="spoiler_title">Bot token and server settings</b> <div class="spoiler_text"><pre> <code class="python hljs">config: <span class="hljs-comment"><span class="hljs-comment">#   botToken: '111222333:AAO4L0Ttt1tt01-1TtT1t_t22tT' #   tabcmd.exe   tabcmdLocation: 'C:\Program Files\Tableau\Tableau Server\10.1\bin\' #     reportsLocation: 'C:\Users\Administrator\Documents\bot\reports\' #    logsLocation: 'C:\Users\Administrator\Documents\bot\logs\' admin: #   chat id      id: 198765432</span></span></code> </pre><br></div></div><br>  Everything is ready, you can define the processing function of the / start command.  We also need the function logs, which simply writes a user‚Äôs action with the bot to a text file with the user's chat_id.  Such a simple option in case of an error will prompt on which line it occurred. <br><br><div class="spoiler">  <b class="spoiler_title">Processing the start command</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bot, update)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   /start  .        ( privacy.yaml,  users).  ,       .         """</span></span> <span class="hljs-comment"><span class="hljs-comment"># chat_id  chat_id = update.message.chat_id #      config = updateSettings() #        if chat_id in config['users']: logs(update, 'Received /start command from user in privacy.yaml') #           reply_markup = makeCustomKeyboard(config['users'][int(chat_id)]['keyboard']) bot.sendMessage(chat_id=chat_id, text=',    ', reply_markup=reply_markup) logs(update, 'List of available reports sent') #       else: logs(update, 'Received /start command from user NOT IN privacy.yaml') #    bot.sendMessage(chat_id=chat_id, text=',         . ' + \ '  ,      ') #         u = ast.literal_eval(str(update)) bot.sendMessage(chat_id=config['admin']['id'], text='   ' + str(u['message']['from']['username'].encode('utf-8')) + ' ' + str(u['message']['from']['first_name'].encode('utf-8')) + ' ' + str(u['message']['from']['last_name'].encode('utf-8')) + ' ' + str(chat_id)) logs(update, 'Request for access sent')</span></span></code> </pre><br></div></div><br>  Ok, we sent the user a keyboard with reports available to him.  Now, in our variant, we simply need to compare the incoming messages with the report names in the privacy.yaml access file for this chat_id.  If the received message matches one of the reports, then we send the Tablo server a command to export this report.  And then we send the generated report to the user. <br><br>  The command to export reports from the server in PDF format can be sent via the command line using "get" or "export" ( <a href="https://onlinehelp.tableau.com/current/server/en-us/tabcmd_cmd.htm">link</a> to the documentation). <br><br>  To do this, first open a session with the Tablo server (instead of localhost, admin and adminPassword, specify the Tablo server domain, your login and password) <br><br>  Before exporting a ‚Äúheavy‚Äù report, it would be nice to warn the user: <br><br><pre> <code class="python hljs">bot.sendMessage(chat_id=chat_id, text=<span class="hljs-string"><span class="hljs-string">' ,  ...'</span></span>, reply_markup=reply_markup) executeFile = os.path.join( tabcmdLocation, <span class="hljs-string"><span class="hljs-string">'tabcmd.exe'</span></span> ) subprocess.call([ executeFile, <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'-s'</span></span>, <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'-u'</span></span>, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, <span class="hljs-string"><span class="hljs-string">'-p'</span></span>, <span class="hljs-string"><span class="hljs-string">'adminPassword '</span></span>])</code> </pre><br>  Export the report to a folder on disk <br><br><pre> <code class="python hljs">subprocess.call([ executeFile, <span class="hljs-string"><span class="hljs-string">'get'</span></span>, reportAddress, <span class="hljs-string"><span class="hljs-string">'-f'</span></span>, reportsLocation + reportName + <span class="hljs-string"><span class="hljs-string">'.pdf'</span></span>])</code> </pre><br>  We close the session on the server <br><br><pre> <code class="python hljs">subprocess.call([ executeFile, <span class="hljs-string"><span class="hljs-string">'logout'</span></span>])</code> </pre><br>  It remains only to send the generated report to the user. <br><br><pre> <code class="python hljs">bot.send_document(chat_id=chat_id, document=open(reportsLocation + reportName.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'.pdf'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>))</code> </pre><br>  Check how it works: <br><br><img src="https://habrastorage.org/files/d2d/002/7d7/d2d0027d7c6b4a22bafd58101fc02312.jpg" alt="image"><br><br>  Exported PDF report from server: <br><br><img src="https://habrastorage.org/files/7bb/a4e/1fc/7bba4e1fcc384f13939f3d05cf7579d2.jpg" alt="image"><br><br>  That's all, I hope this approach will help you to simplify access to reports and improve work efficiency.  Full version of the code: <br><br><div class="spoiler">  <b class="spoiler_title">Configuration file</b> <div class="spoiler_text"><pre> <code class="python hljs">users: <span class="hljs-number"><span class="hljs-number">123456789</span></span>: keyboard: - <span class="hljs-comment"><span class="hljs-comment">#  ,      - buttonText: 'Global Temperatures' #  ,     reportName: 'Global Temperatures' #      report: '/views/Regional/GlobalTemperatures' #  ,      - buttonText: 'College Admissions' #  ,     reportName: 'College Admissions' #      report: '/views/Regional/College' - #  ,      - buttonText: 'Regional FlightDelays' #  ,     reportName: 'Regional FlightDelays' #      report: '/views/Regional/FlightDelays' config: #   botToken: '111222333:AAO4L0Ttt1tt01-1TtT1t_t22tT' #   tabcmd.exe   tabcmdLocation: 'C:\Program Files\Tableau\Tableau Server\10.1\bin\' #     reportsLocation: 'C:\Users\Administrator\Documents\bot\reports\' #    logsLocation: 'C:\Users\Administrator\Documents\bot\logs\' admin: #   chat id      id: 198765432</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- CONFIG_FILE = r'C:\Users\Administrator\Documents\bot\privacy.yaml' #     API  import telegram from telegram.ext import Updater from telegram.ext import MessageHandler, Filters from telegram.ext import CommandHandler import sys import subprocess from yaml import load import ast import os.path def updateSettings(): """     """ return load( file( CONFIG_FILE ) ) #     config = updateSettings() #   token = config['config']['botToken'] #   tabcmd.exe   tabcmdLocation = config['config']['tabcmdLocation'] #     reportsLocation = config['config']['reportsLocation'] #    logsLocation = config['config']['logsLocation'] def makeCustomKeyboard( userKeyboard ): """     .     keyboard    privacy.yaml. """ custom_keyboard = map( lambda z: [ telegram.KeyboardButton(x['buttonText']) for x in z ], userKeyboard ) return telegram.ReplyKeyboardMarkup(custom_keyboard, resize_keyboard='True') def logs(update, comment): """   .  comment    logs  ,   chat id . """ u = ast.literal_eval(str(update)) with open( os.path.join(logsLocation, str(update.message.chat_id) + '.txt'), 'a') as f: f.write( str(u['message']['from']['username'].encode('utf-8')) + '\t' + str(u['message']['from']['first_name'].encode('utf-8')) + '\t' + str(u['message']['from']['last_name'].encode('utf-8')) + '\t' + str(u['message']['text'].encode('utf-8')) + '\t' + str(comment) + '\n') def start(bot, update): """   /start  .        ( privacy.yaml,  users).  ,       .         """ # chat_id  chat_id = update.message.chat_id #      config = updateSettings() #        if chat_id in config['users']: logs(update, 'Received /start command from user in privacy.yaml') #           reply_markup = makeCustomKeyboard(config['users'][int(chat_id)]['keyboard']) bot.sendMessage(chat_id=chat_id, text=',    ', reply_markup=reply_markup) logs(update, 'List of available reports sent') #       else: logs(update, 'Received /start command from user NOT IN privacy.yaml') #    bot.sendMessage(chat_id=chat_id, text=',         . ' + \ '  ,      ') #         u = ast.literal_eval(str(update)) bot.sendMessage(chat_id=config['admin']['id'], text='   ' + str(u['message']['from']['username'].encode('utf-8')) + ' ' + str(u['message']['from']['first_name'].encode('utf-8')) + ' ' + str(u['message']['from']['last_name'].encode('utf-8')) + ' ' + str(chat_id)) logs(update, 'Request for access sent') def echo(bot, update): """    ,  .            ,     """ # chat_id   chat_id=update.message.chat_id #    response = update.message.text #      config = updateSettings() #     (    greenLight = True) greenLight = False #         for line in config['users'][chat_id]['keyboard']: #        for button in line: if button['buttonText'] == response: logs(update, 'Menu found, generating current keyboard and reports') #        reply_markup = makeCustomKeyboard( config['users'][chat_id]['keyboard'] ) logs(update, 'Current keyboard generated') #    greenLight = True #    reportName = button['reportName'] reportAddress = button['report'] + '?:refresh=yes' if greenLight: logs(update, 'Starting to generate report') #       (   ) bot.sendMessage(chat_id=chat_id, text=' ,  ...', reply_markup=reply_markup) logs(update, 'Message about report generation sent') #       executeFile = os.path.join( tabcmdLocation, 'tabcmd.exe' ) #     subprocess.call([ executeFile, 'login', '-s', 'localhost', '-u', 'admin', '-p', 'adminPassword']) #     PDF subprocess.call([ executeFile, 'get', reportAddress, '-f', reportsLocation + reportName + '.pdf']) #   subprocess.call([ executeFile, 'logout']) logs(update, 'Report generated, sending document') #    bot.send_document(chat_id=chat_id, document=open(reportsLocation + reportName.encode('utf-8') + '.pdf', 'rb')) logs(update, 'Report sent') elif response == token: updater.stop() #  ,     else: logs(update, 'Bad message, no access to this report') #          reply_markup = makeCustomKeyboard(config['users'][chat_id]['keyboard']) bot.sendMessage(chat_id=chat_id, text='       . ' + \ ',  admin@tableau.mycompany.ru   ', reply_markup=reply_markup) logs(update, 'Main menu keyboard sent after bad message') #     updater = Updater(token=token) dispatcher = updater.dispatcher updater.start_polling() #   /start start_handler = CommandHandler('start', start) dispatcher.add_handler(start_handler) #    echo_handler = MessageHandler([Filters.text], echo) dispatcher.add_handler(echo_handler)</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/319690/">https://habr.com/ru/post/319690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319680/index.html">Scala.js is easy and simple</a></li>
<li><a href="../319682/index.html">Notify user with 99% probability</a></li>
<li><a href="../319684/index.html">Welcome to Moscow Python Meetup January 19</a></li>
<li><a href="../319686/index.html">Software developer must have sysadmin experience</a></li>
<li><a href="../319688/index.html">Second Generation Cloud Computing: CLAVIRE System</a></li>
<li><a href="../319692/index.html">Auto compiler objects</a></li>
<li><a href="../319694/index.html">The continuation of the epic with a USB stack</a></li>
<li><a href="../319696/index.html">How to iterate over all permutations and about factorial decomposition of natural numbers</a></li>
<li><a href="../319698/index.html">Windows has an internal list of undelete root certificates.</a></li>
<li><a href="../319700/index.html">Introduction to the 8pt mesh system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>