<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC integration with Sharepoint 2013. Part 1: High-Trusted provider-hosted APP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 My name is Denis and I work as a senior developer at DoxVision. With this post I want to start a series of articles related to development i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC integration with Sharepoint 2013. Part 1: High-Trusted provider-hosted APP</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  My name is Denis and I work as a senior developer at DoxVision.  With this post I want to start a series of articles related to development in the field of SharePoint 2013. They will touch on various aspects of this topic, starting with the capabilities of the basic integration of a Web application and ending with publication in the SharePoint Store.  Knowledge of the nuances and pitfalls that I encountered may be useful to those who will face a similar task for the first time. <br><img src="https://habrastorage.org/files/c84/9b2/5b0/c849b25b0394493782479959695dffb7.jpg"><br><a name="habracut"></a><br>  So, following the chronology, I‚Äôll start by describing how I solved the first task I set: on the basis of the existing ASP.NET MVC application ‚ÄúDocsvision Light Client‚Äù to create a new one - ‚ÄúDocsvision client for SharePoint‚Äù, which would integrate into SharePoint 2013 and expand Easy client capabilities. <br><br>  In SharePoint 2013, a new model of Apps has appeared, which is fundamentally different from the old Solutions model.  However, you should not be afraid - Solutions have not disappeared anywhere.  First of all, you should choose what to use: Solutions or App.  The <a href="http://msdn.microsoft.com/en-us/library/office/dn268593(v%3Doffice.15).aspx">article on MSDN</a> can help with this issue. <br>  Our choice fell on the Sharepoint App, because  requirements for integration at that time it was possible to implement through the App.  Later, when we decided to integrate into the Sharepoint store, it turned out that it is absolutely correct, because, as you will see in the following articles, Solutions cannot be placed in the Sharepoint store. <br>  Despite all this, no one forbids the use of both approaches.  In the following articles I will definitely tell you how we managed to connect the App and Solutions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let us dwell on our choice - the SharePoint App.  According to the <a href="http://msdn.microsoft.com/en-us/library/office/fp179930(v%3Doffice.15).aspx">documentation,</a> there are several integration options: SharePoint-hosted, Auto-hosted, Provider-hosted.  Considering that our application is not the Web API, but the MVC in the classic version and the fact that the application will be delivered on-premises - we decided to use the High-Trusted Provider-Hosted App.  High-Trusted means that our Web application communicates with SharePoint through a one-to-one certificate.  There is also the so-called Low-Trusted mode - it is used for the SharePoint Store or in the company's local corporate application directory. <br><br>  So, we all decided, we installed a test site with SharePoint 2013 - and here we are met by the first surprise from Microsoft - it‚Äôs impossible to simply create an App and implement it in SharePoint.  First we need to prepare SharePoint to use the App.  The preparation process is described <a href="http://msdn.microsoft.com/en-us/library/office/fp179923(v%3Doffice.15).aspx">in</a> detail <a href="http://msdn.microsoft.com/en-us/library/office/fp179923(v%3Doffice.15).aspx">on MSDN</a> .  I will briefly go over the points: <br><ol><li>  Verify that the following SharePoint services are running: User Profile Service Application, App Management Service </li><li>  check the presence of at least one SharePoint user profile and create if there is none </li><li>  create an isolated application domain </li><li>  configure DNS for application domain address </li></ol><br>  At the 3rd point you need to stop in more detail.  What is an application domain?  When you install an application (APP) in SharePoint, it is allocated a unique address at which you can access this App-application.  The address looks like this: <b>http: // [app prefix] - [app id]. [Domain name] / [site collection path] / [app path] /pages/default.aspx</b> , where app prefix is ‚Äã‚Äãthe application prefix for the entire farm SharePoint;  app id - unique identifier for the application;  domain name - application domain.  The actual domain configuration of the application is the setting of the app prefix and domain name values, and they could be set via Central Administration (Apps -&gt; Configure App URLs), if not for one but - you must first create two new services SubscriptionSettingsServiceApplication and SPAppManagementServiceApplication.  Below I will provide a slightly improved PowerShell script for creating these services and configuring application domain settings: <br><pre><code class="hljs php">$appDomain = <span class="hljs-string"><span class="hljs-string">"your app domain"</span></span> $appPrefix = <span class="hljs-string"><span class="hljs-string">"your app prefix"</span></span> $accountName = <span class="hljs-string"><span class="hljs-string">"your account name"</span></span> $accountPassword = <span class="hljs-string"><span class="hljs-string">"your account password"</span></span> net start spadminv4 net start sptimerv4 $existedAppDomain = Get-SPAppDomain $existedAppPrefix = Get-SPAppSiteSubscriptionName <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!existedAppDomain || !existedAppPrefix) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$existedAppDomain) { Set-SPAppDomain $appDomain -ea:Stop } Get-SPServiceInstance | where{$_.GetType().Name -eq <span class="hljs-string"><span class="hljs-string">"AppManagementServiceInstance"</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $_.GetType().Name -eq <span class="hljs-string"><span class="hljs-string">"SPSubscriptionSettingsServiceInstance"</span></span>} | Start-SPServiceInstance Get-SPServiceInstance | where{$_.GetType().Name -eq <span class="hljs-string"><span class="hljs-string">"AppManagementServiceInstance"</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $_.GetType().Name -eq <span class="hljs-string"><span class="hljs-string">"SPSubscriptionSettingsServiceInstance"</span></span>} $User = $accountName $account = Get-SPManagedAccount -Identity $User -ea:Silently <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$account) { $PWord = ConvertTo-SecureString ‚ÄìString $accountPassword ‚ÄìAsPlainText -Force $Credential = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object ‚ÄìTypeName System.Management.Automation.PSCredential ‚ÄìArgumentList $User, $PWord $account = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPManagedAccount -Credential $Credential -ea:Stop } $appPoolSubSvc = Get-SPServiceApplicationPool -Identity SettingsServiceAppPool <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$appPoolSubSvc) { $appPoolSubSvc = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPServiceApplicationPool -Name SettingsServiceAppPool -Account $account } $appPoolAppSvc = Get-SPServiceApplicationPool -Identity AppServiceAppPool <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($appPoolAppSvc!) { $appPoolAppSvc = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPServiceApplicationPool -Name AppServiceAppPool -Account $account } $appSubSvc = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPSubscriptionSettingsServiceApplication ‚ÄìApplicationPool $appPoolSubSvc ‚ÄìName SettingsServiceApp ‚ÄìDatabaseName SettingsServiceDB $proxySubSvc = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPSubscriptionSettingsServiceApplicationProxy ‚ÄìServiceApplication $appSubSvc $appAppSvc = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPAppManagementServiceApplication -ApplicationPool $appPoolAppSvc -Name AppServiceApp -DatabaseName AppServiceDB $proxyAppSvc = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SPAppManagementServiceApplicationProxy -ServiceApplication $appAppSvc Set-SPAppSiteSubscriptionName -Name $appPrefix -Confirm:$false -ea:Stop }</code> </pre> <br>  I want to warn you that the last command is for some reason very resource-intensive and may require all the minimum SharePoint requirements for the physical components of the server (‚Äúhardware‚Äù).  In my case, the command was not executed several times, because  there was not enough free memory in the virtual machine.  If you have previously reinstalled SharePoint, you will need to delete the existing SettingsServiceDB and AppServiceDB database files. <br><br>  So, SharePoint is installed and configured for our applications.  Now we need SharePoint to report that our web application will be trusted.  This process is described in detail <a href="http://msdn.microsoft.com/en-us/library/office/fp179901(v%3Doffice.15).aspx">here</a> . <br>  In short, it is necessary <br><ol><li>  create a self-signed IIS certificate (this certificate is only suitable for the debug stage, full solutions will require a domain or commercial certificate) </li><li>  unload pfx and cer files </li><li>  upload the certificate to SharePoint and link it to our web application </li></ol><br>  At the last point I will stop and sign for more.  Essentially, you need to run the following PowerShell script: <br><pre> <code class="hljs bash"><span class="hljs-variable"><span class="hljs-variable">$publicCertPath</span></span> = <span class="hljs-string"><span class="hljs-string">"publicCertPath *.cer"</span></span> <span class="hljs-variable"><span class="hljs-variable">$appId</span></span> = <span class="hljs-string"><span class="hljs-string">"app Id Guid"</span></span> <span class="hljs-variable"><span class="hljs-variable">$spurl</span></span> =<span class="hljs-string"><span class="hljs-string">"SharePoint site url"</span></span> <span class="hljs-variable"><span class="hljs-variable">$appPrincipalDisplayName</span></span> = <span class="hljs-string"><span class="hljs-string">"your app pricipal name"</span></span> <span class="hljs-variable"><span class="hljs-variable">$spweb</span></span> = Get-SPWeb <span class="hljs-variable"><span class="hljs-variable">$spurl</span></span> <span class="hljs-variable"><span class="hljs-variable">$realm</span></span> = Get-SPAuthenticationRealm -ServiceContext <span class="hljs-variable"><span class="hljs-variable">$spweb</span></span>.Site <span class="hljs-variable"><span class="hljs-variable">$certificate</span></span> = Get-PfxCertificate <span class="hljs-variable"><span class="hljs-variable">$publicCertPath</span></span> <span class="hljs-variable"><span class="hljs-variable">$fullAppIdentifier</span></span> = <span class="hljs-variable"><span class="hljs-variable">$appId</span></span> + <span class="hljs-string"><span class="hljs-string">'@'</span></span> + <span class="hljs-variable"><span class="hljs-variable">$realm</span></span> <span class="hljs-variable"><span class="hljs-variable">$principal</span></span> = Get-SPAppPrincipal ‚ÄìNameIdentifier <span class="hljs-variable"><span class="hljs-variable">$fullAppIdentifier</span></span> -Site <span class="hljs-variable"><span class="hljs-variable">$spweb</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-variable"><span class="hljs-variable">$principal</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$issuer</span></span> = Get-SPTrustedSecurityTokenIssuer | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.NameId -eq <span class="hljs-variable"><span class="hljs-variable">$fullAppIdentifier</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$issuer</span></span>) { Remove-SPTrustedSecurityTokenIssuer -Identity <span class="hljs-variable"><span class="hljs-variable">$issuer</span></span>.Id -Confirm:<span class="hljs-variable"><span class="hljs-variable">$False</span></span> -ea:Stop } New-SPTrustedSecurityTokenIssuer -Name <span class="hljs-variable"><span class="hljs-variable">$appPrincipalDisplayName</span></span> -Certificate <span class="hljs-variable"><span class="hljs-variable">$certificate</span></span> -RegisteredIssuerName <span class="hljs-variable"><span class="hljs-variable">$fullAppIdentifier</span></span> -Confirm:<span class="hljs-variable"><span class="hljs-variable">$False</span></span> -ea:Stop <span class="hljs-variable"><span class="hljs-variable">$principal</span></span> = Register-SPAppPrincipal -NameIdentifier <span class="hljs-variable"><span class="hljs-variable">$fullAppIdentifier</span></span> -Site <span class="hljs-variable"><span class="hljs-variable">$spweb</span></span> -DisplayName <span class="hljs-variable"><span class="hljs-variable">$appPrincipalDisplayName</span></span> } Set-SPAppPrincipalPermission -Site <span class="hljs-variable"><span class="hljs-variable">$spweb</span></span> -AppPrincipal <span class="hljs-variable"><span class="hljs-variable">$principal</span></span> -Scope Site -Right FullControl iisreset</code> </pre><br>  After executing this script, any remote application with the $ appId identifier will be able to access the SharePoint elements through a certificate with a private key (pfx). <br>  It is worth remembering the app id.  This is the ID of our Web application.  It will be used later in the web.config of the Web application as IssuerId. <br><br>  The final step is to create a SharePoint App application.  This process is described <a href="http://msdn.microsoft.com/en-us/library/office/fp179901(v%3Doffice.15).aspx">in</a> detail <a href="http://msdn.microsoft.com/en-us/library/office/fp179901(v%3Doffice.15).aspx">later in the article</a> .  When creating a project, the Wizard will offer to fill in a number of parameters: Issuer Id (app id generated by us), path to the pfx certificate, password to the certificate.  The created Web application can be replaced with a solution that already exists in Visual Studio in the project properties.  After the SharePoint project and the web application are connected to the web application, the following parameters are populated in the web.config file: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IssuerId"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"your app id"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ClientSigningCertificatePath"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"your pfx file path"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ClientSigningCertificatePassword"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pfx password"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appSettings</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Also in the Web application project, useful classes SharePointContext.cs and TokenHelper.cs will appear.  These classes provide quite a few possibilities for interacting with SharePoint. <br><br>  This integration is complete.  If you further start a SharePoint project App through debug - SharePoint will first request permissions for our App.  After accepting permissions, after going through a special SharePoint page (appredirect.aspx), we will get to the root of our Web application.  It is believed that the integration process is completed on this, however, as will be seen later, we will face many pitfalls. <br><br>  In the following articles I will discuss in more detail <a href="http://habrahabr.ru/company/docsvision/blog/269499/">how to organize interaction with SharePoint (search and read documents and other SharePoint elements), create app-parts, localize the App</a> , create your RibbonTab, automate the installation of App &amp; Solution and how to prepare for publishing on the SharePoint Store. </div><p>Source: <a href="https://habr.com/ru/post/242325/">https://habr.com/ru/post/242325/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242313/index.html">ProductCamp Minsk 2014 - video and conference review</a></li>
<li><a href="../242315/index.html">Projector on the knee</a></li>
<li><a href="../242317/index.html">100 tricks for managing time, attention and energy</a></li>
<li><a href="../242319/index.html">ZeroNights 2014: hack and get</a></li>
<li><a href="../242323/index.html">Programming for beginners - an example of creating Morse code based on the visual system Snap!</a></li>
<li><a href="../242331/index.html">What is missing engineering education</a></li>
<li><a href="../242333/index.html">False correlations from the open data of the Perm region</a></li>
<li><a href="../242335/index.html">FLProg is an alternative Arduino programming environment. Project Description</a></li>
<li><a href="../242337/index.html">Testing the performance of forks Mysql on real data</a></li>
<li><a href="../242339/index.html">WGDC Competition: Final Close</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>