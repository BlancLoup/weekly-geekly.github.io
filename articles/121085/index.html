<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GeoIP, unconventional use attempts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It was done in the evening, there was nothing to do ... 
 Prehistory 
 At one point, accidentally stumbled upon an old service that allows you to hang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GeoIP, unconventional use attempts</h1><div class="post__text post__text-html js-mediator-article">  <i>It was done in the evening, there was nothing to do ...</i> <br><h4>  Prehistory </h4><br>  At one point, accidentally stumbled upon an old service that allows you to hang a picture on your website, which shows the geographical position of visitors.  There are many and different. <br>  The thing itself is not so useful, I like the data of awstats'a enough for the eyes. <br>  But for demonstrating to the visitor that he is not a random <s>idiot, a</s> passer-by who has wandered onto a dead site is a suitable case. <br>  Further, as it should be, I spread my brains on the topic, but how do they do it, figured it out and sort of calmed down ... <br><br>  But the patient's head doesn‚Äôt give rest to his hands, so now I will show you one funny experiment that does not carry the meaningful load. <br><img src="https://habrastorage.org/getpro/habr/post_images/d13/0aa/97e/d130aa97e15485c82a3f2eee40466963.png" alt="image"><br>  This is a sample of all possible coordinates of IP-Schnick (from rounded to integer). <br>  It can be said that this is a <s>photograph of the Internet</s> habitat TCP / IP <br><br>  <i>Attention, the author is not a coder in a good sense of the word, therefore, those who can be shocked by the codec, please leave.</i> <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From where to get the data, it immediately became clear, this is all known to GeoIP, which has rescued us more than once, since GeoLiteCity has such a vital important thing as coordinates. <br> <code>#geoiplookup -f /usr/local/share/GeoIP/GeoLiteCity.dat 90.155.128.74 <br> GeoIP City Edition, Rev 1: RU, 48, Moscow, N/A, 55.752201, 37.615601, 0, 0</code> <br>  True, she believes that I moved from Butovo to <a href="http://maps.google.ru/maps%3Ff%3Dq%26source%3Ds_q%26hl%3Dru%26geocode%3D%26q%3D55.752201,%2B37.615601%26sll%3D55.354135,40.297852%26sspn%3D37.949407,83.935547%26ie%3DUTF8%26z%3D16">Alexander Garden</a> .  But nothing, we do not need such accuracy. <br><br>  Inspection of the GeoLiteCity.dat file showed that it is very similar to a binary tree, but unfortunately I have not yet lit up how to parse it quickly and painlessly. <br>  The first thought immediately came the option of iterating over all possible ip addresses in the entry in the database of unique coordinates. <br>  256 ^ 4 = 4294967296 even minus backup, local, etc.  still leads to estimated time, which does not please.  <i>We finish in six months, this is already good.</i> <br>  After an active approach to the task, I remembered that GeoIP had other options for storing their data, and the bingo CSV format saved the father of Russian democracy. <br><br>  Sample file: <br> <code>5751,"US","NY","Albany","12209",42.6390,-73.7890,532,518 <br> 5752,"US","NY","Hillsdale","12529",42.2164,-73.5413,532,518 <br> 5753,"US","NY","Albany","12225",42.6706,-73.7791,532,518</code> <br> <br>  Total 310070 entry. <br>  As it‚Äôs not kosher to generate a picture for all 300 hundred points, we make a script that will parse the CSV file and enter unique rounded positions in the database, and then select the database and draw the image. <br>  Why rounded, I did not need high accuracy, so that the point of length and breadth was sufficient. <br>  If you want to do something like the size of 3600 by 1800, then nothing prevents <s>you from repeating this experiment</s> to finish reading the post to the end. <br><br>  Selection of tools. <br>  <b>MySQL</b> is already at hand.  one table is created there, with 4 columns (x, y, kol, two were enough, but I added the last one to see where the records are most concentrated) <br>  <b>Perl</b> is for writing the CSV parser and entering it into the database. It is also at hand, plus it is more convenient to write it to joe via SSH from the communicator.  Proffesionalov perlistov please do not look at the code. <br>  <b>PHP</b> with the GD library, actually for generating the actual image.  Why?  Experience with the GD library from php is great. <br><br>  So, download the <a href="http://geolite.maxmind.com/download/geoip/database/GeoLiteCity_CSV/">latest CSV file</a> . <br><br>  Create a database and a table: <br> <code>CREATE DATABASE IF NOT EXISTS `geo`; <br> CREATE TABLE IF NOT EXISTS `all` ( <br> `x` int(3) NOT NULL, <br> `y` int(3) NOT NULL, <br> `kol` int(64) NOT NULL <br> );</code> <br> <br>  <b>Making a parser:</b> <br>  #! / usr / local / bin / perl <br>  use Mysql; <br>  print "start \ n"; <br>  my $ host = "localhost"; <br>  my $ database = "geo"; <br>  my $ user = "geo"; <br>  my $ table = "all"; <br>  my $ password = "ololoparolko"; <br>  my $ db = Mysql-&gt; Connect ($ host, $ database, $ user, $ password); <br>  $ sql = "SELECT * FROM` $ table` "; <br>  $ sth = $ db-&gt; Query ($ sql); <br>  <a href="https://habrahabr.ru/users/arr/" class="user_link">arr</a> = $ sth-&gt; FetchRow; <br>  my $ vsego = 0; <br>  my $ unik = 0; <br>  my $ ok = 0; <br>  # open the file, throw the data into the array and process it. <br>  open (GL, "/home/klef/geo/GeoLiteCity-Location.csv"); <br>  @ geo_arr =; <br>  close (GL); <br>  $ max = $ # geo_arr; <br>  for ($ i = 0; $ i &lt;= $ # geo_arr; $ i ++) { <br>  $ vsego ++; <br>  @ geo_a = split (",", $ geo_arr [$ i]); <br>  if ($ # geo_a&gt; 6) { <br>  $ ok ++; <br>  $ x = sprintf ("%. 0f", $ geo_a [5]); <br>  $ y = sprintf ("%. 0f", $ geo_a [6]); <br>  # are we looking for any such coordinates? <br>  $ sql = "SELECT * FROM` $ table` WHERE x = $ x AND y = $ y "; <br>  $ sth = $ db-&gt; Query ($ sql); <br>  <a href="https://habrahabr.ru/users/arr/" class="user_link">arr</a> = $ sth-&gt; FetchRow; <br>  if ($ # arr&gt; = 0) { <br>  #there is?  fine we change the counter <br>  $ nov_s = $ arr [3] +1; <br>  $ sql = "UPDATE` $ database`.` $ table` SET `kol` = '$ nov_s' WHERE` $ table`.`x` = $ x AND `$ table`.`y` = $ y AND` $ table``kol` = $ arr [3] LIMIT 1; "; <br>  $ db-&gt; Query ($ sql); <br>  } else { <br>  # no, well, it's fixable <br>  $ sql = "INSERT INTO` $ database`.` $ table` (`x`,` y`, `kol`) VALUES ('$ x', '$ y', '1');"; <br>  $ db-&gt; Query ($ sql); <br>  print "New"; <br>  $ unik ++; <br>  } <br>  } <br>  } <br>  # this is so that in the end we were happily shown how much he otlapatil <br>  $ vsego_p = sprintf ("%. 2f", $ vsego * 100 / $ max); <br>  $ ok_p = sprintf ("%. 2f", $ ok * 100 / $ max); <br>  $ unik_p = sprintf ("%. 2f", $ unik * 100 / $ max); <br>  $ itog = "\ nObrabotano: $ vsego_p% ($ vsego) \ nNormalnih: $ ok_p% ($ ok) \ nUnikalnih: $ unik_p% ($ unik) \ n"; <br>  print $ itog; <br>  print "END \ n"; <br><br><br>  <i>And it started, the</i> main problem in processing time was, not in the fact that there is a lot of data, but the fact that we are sorting them out in order and without beautiful solutions. <br><br>  <b>php script for image generation:</b> <br>  #! / usr / local / bin / php <br>  &lt;? php <br>  $ host = "localhost: 3306"; <br>  $ user = "geo"; <br>  $ data = "geo"; <br>  $ pass = "again parolko"; <br>  // where to save the picture <br>  $ patch = "/ data / web / geo.ip.png"; <br>  $ z = 0; <br>  // create image and color <br>  $ img = imagecreatetruecolor (600, 400); <br>  $ ink = imagecolorallocate ($ img, 0, 255, 0); <br>  // access the database and select the data <br>  $ db = mysql_connect ($ host, $ user, $ pass) or die (‚ÄúBolt MySQL‚Äû); <br>  $ db_sel = mysql_select_db ($ data, $ db) or die (‚ÄúBolt BD‚Äû); <br>  $ sql = mysql_query (‚ÄúSELECT * FROM` all`; ") or die (" Bolt zapros "); <br>  $ num_rows = mysql_num_rows ($ sql) or die ("Bolt Num Stroki"); <br>  $ vib = mysql_num_rows ($ sql) or die ("Bolt Stroki"); <br>  for ($ i = 1; $ i &lt;= $ num_rows; $ i ++) { <br>  $ tmp = mysql_fetch_array ($ sql); <br>  $ y = $ tmp ['x']; <br>  $ x = $ tmp ['y']; <br>  // put a point with the desired coordinates <br>  imagesetpixel ($ img, 300 + $ x, 200- $ y, $ ink); <br>  } <br>  mysql_close ($ db); <br>  // finally put a mark and save the file <br>  ImageString ($ img, 2, 10, 5, "Geo IP:" .date ("YM j H: i"). "Kolvo:". $ Num_rows. ", $ Ink); <br>  imagetruecolortopalette ($ img, true, 255); <br>  imagepng ($ img, $ patch); <br>  imagedestroy ($ img); <br>  ?&gt; <br><br><br>  <b>Total parser:</b> <br>  Total 310072 lines in file <br>  unique coordinates (rounded) 8226, which is only 2.65% <br>  Size table 384 kilobytes :) <br>  Time of processing: <br>  To fill the database: about a couple of hours. <br>  On the formation of images in the aisle of milliseconds. <br><br>  ps later re-processed, but rounded to the first decimal point, the result is <a href="">a resolution of 3600 by 1800</a> <br>  When resizing to the desired resolution of the desktop, we get a good wallpaper. <br><br>  pps later tried to generate a file size of 36,000 by 18,000 (respectively, rounding to two decimal places), but php paired up with GD a little overstrained with such a resolution, why and why there was no longer any desire or strength. </div><p>Source: <a href="https://habr.com/ru/post/121085/">https://habr.com/ru/post/121085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121077/index.html">Ipv6 Day at UA-IX: first results</a></li>
<li><a href="../121078/index.html">Anonymous networks and timing attacks: Low-cost attack</a></li>
<li><a href="../121079/index.html">How to turn off the recognition of your face in other people's photos</a></li>
<li><a href="../121080/index.html">Clodo.ru and another mysterious fall</a></li>
<li><a href="../121083/index.html">Do you use SMS mailings?</a></li>
<li><a href="../121087/index.html">"Sulfuric" beekeeping or the game of humanism</a></li>
<li><a href="../121088/index.html">Afisha-Mir has opened a service for travelers</a></li>
<li><a href="../121090/index.html">Codemasters.com hacked</a></li>
<li><a href="../121091/index.html">Anonymous appeal to NATO</a></li>
<li><a href="../121092/index.html">On Habr√© it is impossible to conduct market research!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>