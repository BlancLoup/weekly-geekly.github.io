<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>vSAN in VMware based cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The tasks of data storage and access are a pain point for any information system. Even a well-designed storage system (hereinafter SHD) during operati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>vSAN in VMware based cloud</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/pl/tj/to/pltjtoutsishswrt2dgxaktv5ka.png"><br><br>  The tasks of data storage and access are a pain point for any information system.  Even a well-designed storage system (hereinafter SHD) during operation identifies problems associated with reduced performance.  The complex of scaling problems deserves special attention when the amount of resources involved approaches the established limits set by the storage system developers. <br><br>  The fundamental cause of these problems is the traditional architecture, based on a tight connection to the hardware characteristics of the used storage devices.  Most customers still choose the method of storing and accessing data based on the characteristics of physical interfaces (SAS / SATA / SCSI), rather than the actual needs of the applications used. <br><a name="habracut"></a><br>  A dozen years ago, this was a logical decision.  System administrators carefully selected storage devices with the required specification, for example, SATA / SAS, and expected to receive a performance level based on the hardware capabilities of the disk controllers.  The battle was both for the volume of RAID controller caches and for options that prevent data loss.  Now this approach to solving the problem is not optimal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the current environment, when choosing a storage system, it makes sense not to build on physical interfaces, but on performance, expressed in IOPS (number of I / O operations per second).  Using virtualization allows you to flexibly use existing hardware resources and guarantee the required level of performance.  For our part, we are ready to provide resources with the characteristics that the application really needs. <br><br><h2>  Storage virtualization </h2><br>  With the development of virtualization systems, it was necessary to find an innovative solution for storing and accessing data, while at the same time providing fault tolerance.  This was the starting point for the creation of SDS (Software-Defined Storage).  To meet business needs, such storage facilities were designed with the separation of software and hardware. <br><br>  The SDS architecture is completely different from the traditional one.  The storage logic has become abstract at the software level.  The organization of storage has become easier due to the unification and virtualization of each of the components of such a system. <br><br>  What is the main factor hindering the implementation of SDS everywhere?  This factor most often turns out to be an incorrect assessment of the needs of the applications used and an incorrect assessment of risks.  For businesses, the choice of solution depends on the cost of implementation, based on the current resources consumed.  Few people think - what will happen when the amount of information and the required performance exceed the capabilities of the selected architecture.  Thinking on the basis of the methodological principle ‚Äúone should not multiply existing without need‚Äù, better known as ‚ÄúOckham's blade‚Äù, determines the choice in favor of traditional solutions. <br><br>  Only a few understand that the need for scaling and reliability of data storage is more important than it seems at first glance.  Information is a resource, and therefore, the risk of its loss must be insured.  What happens when a traditional storage system fails?  You will need to use the warranty or buy new equipment.  And if the storage system is discontinued or has its ‚Äúlifespan‚Äù (the so-called EOL - End-of-Life) ended?  This could be a ‚Äúblack day‚Äù for any organization that cannot continue to use its own personal services. <br><br>  There are no systems that would not have a single point of failure.  But there are systems that can easily survive the failure of one or more components.  Both virtual and traditional storage systems were created taking into account the fact that sooner or later a failure will occur.  Here are just the ‚Äúlimit of durability‚Äù of traditional storage systems laid down by hardware, but in virtual storage systems it is defined in the software layer. <br><br><h2>  Integration </h2><br>  Drastic changes in the IT-infrastructure is always an undesirable phenomenon, fraught with downtime and loss of funds.  Only a smooth introduction of new solutions makes it possible to avoid negative consequences and improve the work of services.  That is why Selectel has developed and <a href="https://blog.selectel.ru/selectel-vmware-cloud">launched a cloud based on VMware</a> , a recognized leader in the virtualization market.  The service created by us will allow each company to solve the whole complex of infrastructure problems, including data storage. <br><br>  We will talk about how we decided the issue with the choice of storage system, as well as what advantages this choice gave us.  Of course, both traditional storage systems and SDS were considered.  In order to clearly understand all aspects of exploitation and risks, we suggest delving into the topic in detail. <br><br>  At the design stage, the following requirements were imposed on the storage system: <br><br><ul><li>  <strong>fault tolerance;</strong> </li><li>  <strong>performance;</strong> </li><li>  <strong>scaling;</strong> </li><li>  <strong>the ability to guarantee the speed of work;</strong> </li><li>  <strong>correct work in the VMware ecosystem.</strong> </li></ul><br>  The use of traditional hardware solutions could not provide the required level of scaling, since it is impossible to constantly increase the storage capacity due to the limitations of the architecture.  Also of great difficulty was the reservation at the level of the whole data center.  That is why we paid attention to SDS. <br><br>  There are several software solutions on the SDS market that would be suitable for building a cloud based on VMware vSphere.  Among these solutions include: <br><br><ul><li>  <strong>Dell EMC ScaleIO;</strong> </li><li>  <strong>Datacore Hyper-converged Virtual SAN;</strong> </li><li>  <strong>HPE StoreVirtual.</strong> </li></ul><br>  These solutions are suitable for use with VMware vSphere, but are not embedded in the hypervisor and run separately.  Therefore, the choice was made in favor of VMware vSAN.  Let us consider in detail what the virtual architecture of such a solution looks like. <br><br><h3>  Architecture </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hb/hu/nr/hbhunruzcic-pa1ggjw_-winfcg.png"></div><br>  <sup><i>Image taken from <a href="https://docs.vmware.com/en/VMware-vSAN/index.html">official documentation.</a></i></sup> <br><br>  Unlike traditional storage systems, all information is not stored at any one point.  Virtual machine data is evenly ‚Äúspread‚Äù between all hosts, and scaling is done by adding hosts or installing additional disk drives on them.  Two configuration options are supported: <br><br><ul><li>  <strong>AllFlash configuration</strong> (only solid-state drives, both for data storage and for cache); </li><li>  <strong>Hybrid configuration</strong> (magnetic storage media and solid-state cache). </li></ul><br>  The procedure for adding disk space does not require additional settings, for example, creating a LUN (Logical Unit Number, logical disk numbers) and setting up access to them.  As soon as a host is added to the cluster, its disk space becomes available for all virtual machines.  This approach has several significant advantages: <br><br><ul><li>  <strong>lack of binding to the equipment manufacturer;</strong> </li><li>  <strong>increased fault tolerance;</strong> </li><li>  <strong>ensure data integrity in case of failure;</strong> </li><li>  <strong>single control center from the vSphere console;</strong> </li><li>  <strong>convenient horizontal and vertical scaling.</strong> </li></ul><br>  However, this architecture places high demands on the network infrastructure.  To ensure maximum throughput, the network in our cloud is built on the Spine-Leaf model. <br><br><h3>  Network </h3><br>  The traditional three-level network model (core / aggregation / access) has several significant drawbacks.  A striking example is the limitations of Spanning-Tree protocols. <br><br>  The Spine-Leaf model uses only two levels, with the following advantages: <br><br><ul><li>  <strong>predictable distance between devices;</strong> </li><li>  <strong>traffic goes on the best route;</strong> </li><li>  <strong>ease of scaling;</strong> </li><li>  <strong>exclusion of restrictions of protocols of the L2 level.</strong> </li></ul><br>  The key feature of this architecture is that it is optimized to the maximum for ‚Äúhorizontal‚Äù traffic.  Data packets pass through only one hop, which makes it possible to clearly estimate delays. <br><br>  The physical connection is provided with several 10GbE links per server, the bandwidth of which is combined using an aggregation protocol.  Thus, each physical host gets high speed access to all storage objects. <br><br>  Data exchange is implemented using a proprietary protocol created by VMware, which allows for fast and reliable storage network operation on Ethernet transport (from 10GbE and higher). <br><br>  The transition to an object-based data storage model made it possible to flexibly adjust the use of storage in accordance with the requirements of customers.  All data is stored in the form of objects that are distributed in a certain way to the cluster hosts.  Specify the values ‚Äã‚Äãof some parameters that can be controlled. <br><br><h3>  fault tolerance </h3><br><ol><li>  <strong>FTT (Failures To Tolerate).</strong>  Indicates the number of failures of hosts that the cluster is able to handle without interrupting normal operation. </li><li>  <strong>FTM (Failure Tolerance Method).</strong>  The method of ensuring fault tolerance at the disk level. <br><br>  a.  <strong>Mirroring</strong> . <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jb/kv/lw/jbkvlwsmyvua7jrw2f8jj0820am.png"></div><br>  <sup><i>Image taken from <a href="https://blogs.vmware.com/virtualblocks/2017/11/09/understanding-vsan-rebuilds/">the VMware blog.</a></i></sup> <br><br>  It is a complete duplication of an object, and the replicas are always on different physical hosts.  The closest analogue of this method is RAID-1.  Its use allows the cluster to regularly handle up to three failures of any components (disks, hosts, network loss, etc.).  This parameter is configured by setting the FTT option. <br><br>  By default, this option is set to 1, and 1 replica is created for the object (only 2 instances on different hosts).  As the value increases, the number of instances will be N + 1.  Thus, with a maximum value of FTT = 3, there will be 4 instances of the object on different hosts. <br><br>  This method allows you to achieve maximum performance to the detriment of efficient use of disk space.  It is allowed to use both in the hybrid and AllFlash configurations. <br><br>  b.  <strong>Erasure Coding</strong> (analog RAID 5/6). <br><img src="https://habrastorage.org/webt/72/zq/hh/72zqhhyrlncoqga9qlzg0wdfgco.png"><br><br>  <sup><i>Image taken from the blog <a href="https://cormachogan.com/2016/02/15/vsan-6-2-part-2-raid-5-and-raid-6-configurations/">cormachogan.com</a></i></sup> <br><br>  This method is supported exclusively on AllFlash configurations.  In the process of writing each object, the corresponding parity blocks are calculated, which make it possible to unambiguously recover data when a failure occurs.  This approach saves disk space significantly compared to Mirroring. <br><br>  Of course, the work of this method increases the overhead costs, which are expressed in reduced productivity.  However, given the performance of the AllFlash configuration, this flaw is leveled, making the use of Erasure Coding an acceptable option for most tasks. <br><br>  In addition, VMware vSAN introduces the concept of ‚Äúfailure domains‚Äù, which is a logical grouping of server racks or disk baskets.  As soon as the necessary elements are grouped, this leads to the distribution of data among different nodes, taking into account the failure domains.  This allows the cluster to survive the loss of the whole domain, since all corresponding object replicas will be located on other hosts in another failure domain. <br><br>  The minimum failure domain is a disk group, which are logically related disk drives.  Each disk group contains two types of media - cache and capacity.  The system allows using only solid-state disks as cache-carriers, and both magnetic and solid-state disks can act as capacity-carriers.  Caching media helps speed up the operation of magnetic disks and reduce latency when accessing data. </li></ol><br><h2>  Implementation </h2><br>  Let's talk about what limitations exist in the architecture of VMware vSAN and why they are needed.  Regardless of the hardware platforms used, the architecture has the following limitations: <br><br><ul><li>  <strong>no more than 5 disk groups per host;</strong> </li><li>  <strong>no more than 7 capacity-carriers in a disk group;</strong> </li><li>  <strong>no more than 1 cache in a disk group;</strong> </li><li>  <strong>no more than 35 capacity-carriers per host;</strong> </li><li>  <strong>no more than 9000 components per host (including witness components);</strong> </li><li>  <strong>no more than 64 hosts in a cluster;</strong> </li><li>  <strong>no more than 1 vSAN-datastore per cluster.</strong> </li></ul><br>  Why do you need it?  As long as these limits are not exceeded, the system will operate with the declared capacity, maintaining a balance between capacity and storage.  This ensures the correct operation of the entire virtual storage system as a whole. <br><br>  In addition to these limitations, there is one important feature to keep in mind.  It is not recommended to fill more than 70% of the total storage.  The fact is that when 80% is reached, the rebalancing mechanism starts automatically, and the storage system begins to redistribute data across all cluster hosts.  The procedure is quite resource-intensive and can seriously affect the performance of the disk subsystem. <br><br>  To meet the needs of a wide variety of customers, we have implemented three storage pools for ease of use in various scenarios.  Let's look at each of them in order. <br><br><h3>  Fast drive pool </h3><br>  The priority for creating this pool was to obtain a storage that will provide maximum performance for hosting high-load systems.  The servers in this pool use a pair of Intel P4600 as cache and 10 Intel P3520 for data storage.  The cache in this pool is used in such a way that data is read directly from the media, and write operations occur through the cache. <br><br>  To increase usable capacity and ensure fault tolerance, a data storage model called Erasure Coding is used.  This model is similar to a regular RAID 5/6 array, but at the level of object storage.  To eliminate the possibility of data corruption, vSAN uses a checksum calculation mechanism for each data block, 4K in size. <br><br>  The check is performed in the background during read / write operations, as well as for ‚Äúcold‚Äù data, access to which was not requested during the year.  If there is a mismatch of checksums and, consequently, data corruption, vSAN will automatically restore the files by overwriting. <br><br><h3>  Hybrid drive pool </h3><br>  In the case of this pool, its main task is to provide a large amount of data, while providing a good level of fault tolerance.  For many tasks, the speed of access to data is not a priority, the volume and storage cost are much more important.  Using solid-state drives as such storage will be of unreasonably high cost. <br><br>  This factor was the reason for the creation of a pool, which is a hybrid of the caching solid-state drives (as in other pools is Intel P4600) and hard drives of corporate level, developed by HGST.  A hybrid workflow accelerates access to frequently requested data by caching read and write operations. <br><br>  At the logical level, data is mirrored to eliminate loss in case of equipment failure.  Each object is divided into identical components and the system distributes them to different hosts. <br><br><h3>  Disaster Recovery Pool </h3><br><img src="https://habrastorage.org/webt/hz/ne/xi/hznexild-sq7oxyvy6m9yvr-xm4.png"><br><br>  The main objective of the pool is to achieve the maximum level of fault tolerance and performance.  The use of <strong>Stretched vSAN</strong> technology allowed us to spread the storage between the data centers Flower-2 in St. Petersburg and Dubrovka-3 in the Leningrad region.  Each server in this pool is equipped with a pair of high-capacity and high-speed Intel P4600 drives for cache operation and 6 pieces of Intel P3520 for data storage.  At the logical level, these are 2 disk groups per host. <br><br>  AllFlash configuration lacks a serious drawback - a sharp drop in IOPS and an increase in the queue of disk queries with an increased volume of random access data operations.  Just like in a pool with fast disks, write operations go through the cache, and reading is done directly. <br><br>  Now about the main difference from the other pools.  The data of each virtual machine is mirrored inside one data center and at the same time synchronously replicated to another data center belonging to us.  Thus, even a serious accident, such as a complete breakdown of connectivity between data centers will not become a problem.  Even a complete loss of the data center will not affect the data. <br><br>  An accident with a complete failure of the site - the situation is quite rare, but vSAN with honor can survive it without losing data.  The guests of the <a href="https://blog.selectel.ru/selecteltechday-3/">SelectelTechDay 2018</a> event, which we held, were able to see for themselves how the Stretched vSAN cluster experienced a complete site failure.  Virtual machines became available within one minute after all the servers at one of the sites were turned off on power.  All mechanisms worked exactly as planned, and the data remained intact. <br><br>  The rejection of the usual data storage architecture entails a lot of changes.  One of these changes was the emergence of new virtual "entities", which include the witness appliance.  The point of this decision is to monitor the process of recording data replicas and determine which one is relevant.  At the same time, the data itself is not stored on the witness components, only the metadata about the recording process. <br><br>  This mechanism comes into effect in the event of a crash, when the replication process fails, which results in unsynchronized replicas. <br><br>  To determine which of them contains relevant information, a quorum determination mechanism is used.  Each component has a ‚Äúright to vote‚Äù and is assigned a number of votes (1 or more).  The same ‚Äúright to vote‚Äù has the witness components, which play the role of arbiters, in the event of a dispute. <br><br>  A quorum is achieved only when a full replica is available for the object and the number of current ‚Äúvotes‚Äù is more than 50%. <br><br><h2>  Conclusion </h2><br>  The choice of VMware vSAN as a data storage system has become quite an important decision for us.  This option passed load testing and failover testing before it was included in our VMware-based cloud project. <br><br>  According to the test results, it became clear that the declared functionality works as expected and satisfies all the requirements of our cloud infrastructure. <br><br>  Is there something to tell based on your own experience with vSAN?  Welcome to the comments. </div><p>Source: <a href="https://habr.com/ru/post/418753/">https://habr.com/ru/post/418753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418737/index.html">Laser ablation, tellurite glass and Er2O3 dopant</a></li>
<li><a href="../418739/index.html">Center for Additive Technology: Industrial 3D Printers 3D Systems, Stratasys, SLM, EOS</a></li>
<li><a href="../418743/index.html">The history of first place on the ML Boot Camp VI</a></li>
<li><a href="../418747/index.html">Problem Solving: how to effectively solve problems in a team?</a></li>
<li><a href="../418751/index.html">Dexp brazen chinese spy</a></li>
<li><a href="../418755/index.html">How e-commerce survive major promotions. Getting ready for peak loads on the web [Part 1]</a></li>
<li><a href="../418757/index.html">Thinning timeframes (cryptocurrency, forex, stock exchange)</a></li>
<li><a href="../418759/index.html">How much does it cost for a student to release a microcircuit?</a></li>
<li><a href="../418761/index.html">The book "Pure Python. Subtleties programming for pros</a></li>
<li><a href="../418763/index.html">Middle / senior: how to escape from the swamp?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>