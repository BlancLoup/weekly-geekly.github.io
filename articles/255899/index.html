<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Where to look if the site is constantly hacked, or how I caught the malware on the site of one of the clients</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began quite prosaic. One of the clients began to complain that on his website, working on the CMS Bitrix, the module settings or the websit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Where to look if the site is constantly hacked, or how I caught the malware on the site of one of the clients</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e5c/8e1/428/e5c8e14289eed6309698c6127bce23d3.jpg" alt="image"><br><br>  This story began quite prosaic.  One of the clients began to complain that on his website, working on the CMS Bitrix, the module settings or the website generally stop working with ‚Äúspitting up errors‚Äù where they should not be.  I changed the passwords to the client, restored the site from the night backup and calmly went about their business, writing off the situation to the usual password compromise and vandalism. <br><br>  But not after a few hours, the symptoms reoccurred again, with chunks of PHP code being erased in random places, which made it possible to believe that they were trying to turn off the site on purpose.  Conclusions who would need to extinguish a typical state site of a small settlement with an attendance of 5-6 people per day will be left to the staff of the competent authorities, I will tell you briefly for beginners how to act in this case. <br><a name="habracut"></a><br>  1) We look at <a href="http://www.2ip.ru/">2ip.ru</a> or another similar service with our external ip address, and also ask all site administrators to send ip from which they are now connected to the Internet.  Here the rule is simple - access to the administrative folders 1C-Bitrix should come only from these addresses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2) Open the web server access log file, for apache web server, it usually lies on the server along the path <b>/var/log/apache2/access.log</b> .  We are looking for requests for admin files from addresses not owned by site administrators.  In my particular case, I was embarrassed by this line: <br><pre><code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">xxx</span></span>.xxx.xxx.xxx - -<span class="hljs-meta"><span class="hljs-meta"> [xx/xx/2015:xx:xx:xx +0300] "POST /bitrix/admin/htmleditor2/bitrix_log.php HTTP/1.0" 200 4 "http://xxxxxxxxxxxxx/bitrix/admin/htmleditor2/bitrix_log.php" "Mozilla/5.0 (Windows NT 6.1; rv:31.0) Gecko/20100101 Firefox/31.0"</span></span></code> </pre> <br>  Here it is not only that access to the admin file comes from an IP address that is not in the list from the first item, but also to the file that was not originally in the CMS delivery of Bitrix!  When working with logs and files, it is advisable to deploy a separate reference copy of the CMS, on which the site works, so that you can compare files for changes or not. <br><br>  3) Open the file /bitrix/admin/htmleditor2/bitrix_log.php.  Eyes appears following a jumble of characters: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $auth_pass = <span class="hljs-string"><span class="hljs-string">"b1248f5dde2d214b74ef121288b61801"</span></span>; $color = <span class="hljs-string"><span class="hljs-string">"#df5"</span></span>; $default_action = <span class="hljs-string"><span class="hljs-string">'FilesMan'</span></span>; $default_use_ajax = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; $default_charset = <span class="hljs-string"><span class="hljs-string">'Windows-1251'</span></span>; $o=<span class="hljs-string"><span class="hljs-string">'HZzFksNKuoQ'</span></span>;<span class="hljs-comment"><span class="hljs-comment">//   20    ,      //eval("\x65\x76\x61\x6C\x28\x67\x7A\x69\x6E\x66\x6C\x61\x74\x65\x28\x62\x61\x73\x65\x36\x34\x5F\x64\x65\x63\x6F\x64\x65\x28\x24\x6F\x29\x29\x29\x3B");</span></span></code> </pre><br>  I immediately commented out the eval () function, which the attacker tried to hide behind a bunch of characters (as it turned out later, this text view of the zip archive). <br><br>  In principle, for ordinary administrators, you could simply delete the file, search for the eval function for the remaining scripts, and where it should not be - delete it and finish your research.  But I decided to see what this folk art work does with the site and the server. <br><br>  First, pay attention to the line: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(<span class="hljs-string"><span class="hljs-string">"\x65\x76\x61\x6C\x28\x67\x7A\x69\x6E\x66\x6C\x61\x74\x65\x28\x62\x61\x73\x65\x36\x34\x5F\x64\x65\x63\x6F\x64\x65\x28\x24\x6F\x29\x29\x29\x3B"</span></span>);</code> </pre><br><br>  HEX symbol substitutes are visible to the naked eye.  Any HEX decoder will help to turn them into readable text with the naked eye, I used <a href="http://ddecode.com/hexdecoder/">it</a> . <br>  After feeding the <s>pants to the</s> decoder, the characters turn into: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(gzinflate(base64_decode($o)))</code> </pre><br>  in <s>elegant family pants the</s> execution of the code, which is decoded and unzipped from the <b>$ o</b> variable (which contains a bunch of "unknowns", or rather just contains archived information).  The developer of this creation tried very hard to protect it from deobfuscation, namely, when trying to decrypt the variable <b>$ o</b> , we stumble again with <b>eval (gzinflate (base64_decode ([CLEAR OF SYMBOLS])))</b> .  But this can be circumvented. <br><br>  The code was rewritten a bit, after the mash of the characters I add the decryption code: <br><br><pre> <code class="php hljs">$string = gzinflate(base64_decode($o));</code> </pre><br>  after that we know that the code cyclically unzips itself and runs the unzipped piece, i.e.  you can simply go through the same cycle, but without executing the code, but dropping it into any of the variables until you completely unzip it.  because  in each ‚Äúiteration‚Äù of the archive, the code contains the initial string <b>eval (gzinflate (base64_decode (</b> after the unarchived version does not have this string, you can stop the cycle). Unpacked code is merged into some kind of file for further analysis. <br><br>  Here is the implementation of this PHP code: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (substr_count($string,<span class="hljs-string"><span class="hljs-string">"eval(gzinflate(base64_decode("</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { $string = str_replace(<span class="hljs-string"><span class="hljs-string">"eval(gzinflate(base64_decode('"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,$string); $string = str_replace(<span class="hljs-string"><span class="hljs-string">"')));"</span></span>,<span class="hljs-string"><span class="hljs-string">");"</span></span>,$string); $string =gzinflate(base64_decode($string)); } file_put_contents(<span class="hljs-string"><span class="hljs-string">"unpacked.dat"</span></span>,$string);</code> </pre><br>  After the end of the script, open unpacked.dat and see the typical php shell (which sea) with the file manager and other "gingerbread".  On the server, the site of each client operates under the rights of the user of this client, which are quite severely curtailed, plus the exec () command is prohibited.  Therefore, the attacker sneered only at this site and could not crawl to the others. <br><br>  And he chose a not very good method of obfuscating his shell - the eval function is used quite rarely in the bitrix, and this one was very easy to find using this function, plus ‚Äúrandom symbols‚Äù immediately suggest suspicion.  Because of this, the shell stands out in the overall structure of the site as a clown at a funeral. <br><br>  The shell hit path also turned out to be quite non-trivial - earlier, the client had 2 copies of the site on the server, one of which was the old version of the site on the old and ‚Äúleaky-sieve‚Äù version of Joomla.  This version of the site was left for easy transfer of content to the new site.  At that moment, a shell was loaded through a hole in Joomla (the sites were located under one user in neighboring folders). <br><br>  Therefore, I always place old versions of sites on a separate virtual machine, which is not a pity.  As I advise you. <br><br>  UPD Removed the wording ‚Äúgovnosimvoly‚Äù, so as not to offend particularly impressionable. </div><p>Source: <a href="https://habr.com/ru/post/255899/">https://habr.com/ru/post/255899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255889/index.html">The Foundation for Independent Studies at DevCon 2015: a master class from Dmitry Kalaev and Artem Azevich</a></li>
<li><a href="../255891/index.html">Deploying video surveillance in a hurry, or we do not need wires</a></li>
<li><a href="../255893/index.html">How to create a powerful game achievement system</a></li>
<li><a href="../255895/index.html">10 major mistakes when developing on Node.js</a></li>
<li><a href="../255897/index.html">Why I could not switch from Firefox to Chrome and how I managed to do it</a></li>
<li><a href="../255903/index.html">Logiblocs Spytech kit overview</a></li>
<li><a href="../255913/index.html">Managing server disk space on the fly: 1cloud experience</a></li>
<li><a href="../255915/index.html">HP OpenStack Helion First Meet</a></li>
<li><a href="../255917/index.html">Build Embedded Linux from Yocto for QEMU x86 and the first application to it</a></li>
<li><a href="../255921/index.html">Eco Driving: an overview of the driver behavior assessment tool.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>