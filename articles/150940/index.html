<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Delivery of fresh press using Python directly to the mailbox</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will highlight the following features of python: 


- parsing a web page using a simple regular expression; 
- downloading a file from a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Delivery of fresh press using Python directly to the mailbox</h1><div class="post__text post__text-html js-mediator-article">  This article will highlight the following features of python: <br><ul><li>  parsing a web page using a simple regular expression; </li><li>  downloading a file from a web page; </li><li>  sending the downloaded file through an smtp server; </li><li>  writing a small generalizing script. </li></ul><br>  All this will be accompanied by working examples. <br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  Many people remember the standard movie scene from a typical morning in the American commuter posolka: the guy on a cycling box rides and throws away a newspaper.  And then a kind, big, shaggy dog ‚Äã‚Äãbrings a newspaper to the head of the family.  But progress is being made and newspapers can now be obtained in digital format, you can even order their delivery by mail.  On some sites this opportunity is provided for money, on my favorite, but terribly far from the world of IT Sport Express, this opportunity is absent altogether.  But it is possible to download pdf. <br>  In this connection, every morning you had to go to the site, follow the link there, continue to download to your computer, then send to your kindle-box, then turn on wifi on Kindle - and now you can read the newspaper in the subway and electric train <br><br><h4>  Simple web page analysis </h4><br>  To work with the web, the urllib2 module is used.  This module allows you to get the contents of the pages, as well as a lot more.  But in this case we have enough of one of its functions: the page view. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">download_by_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, link)</span></span></span><span class="hljs-function">:</span></span> content = urllib2.urlopen(link).read() <span class="hljs-comment"><span class="hljs-comment">#  html,    link link_on_file, filename = self.get_filename(content) #   html    fullname = self.get_dir_name() + filename if self.is_new_version(fullname): with open(fullname, 'w') as fd: content = urllib2.urlopen(link_on_file).read() #   fd.write(content) return self.get_prepared_files(fullname)</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      with is the equivalent of using in C # and try in Java 7. In short, with guarantees that the resources captured in this block will be released as soon as we go beyond its limits (in the case of a normal exit or, for example, an exception). <br><br>  In order to get a link to the archive with a fresh issue of a newspaper, we use the re module, which implements all the power of regular expressions.  However, as in the case of urllib2, we again do not need anything supernatural: <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_filename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text)</span></span></span><span class="hljs-function">:</span></span> pattern = <span class="hljs-string"><span class="hljs-string">r'(?P&lt;link&gt;http:\/\/archive\.sport\-express\.ru\/pdf\/(?P&lt;filename&gt;[0-9]+\.zip))'</span></span> match = re.search(pattern, text) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> match.group(<span class="hljs-string"><span class="hljs-string">'link'</span></span>), match.group(<span class="hljs-string"><span class="hljs-string">'filename'</span></span>)</code> </pre><br><br>  (? P) - this is how the named group is defined in the regular schedule.  This way we get the link and file name. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SportExpress</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_from</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'username@mail.ru'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_title</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Sport Express subscribe'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Good morning! Don't be lazy - read newspaper!"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_prepared_files</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, archive)</span></span></span><span class="hljs-function">:</span></span> directory_to_extract = archive[:archive.rfind(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)] zipfile.ZipFile(archive).extractall(directory_to_extract) <span class="hljs-comment"><span class="hljs-comment">#      res = glob.glob(directory_to_extract+'/*.*') return res def get_dir_name(self): dir_name = 'archive/sport-express/' if not os.path.exists(dir_name): os.mkdir(dir_name) return dir_name def is_new_version(self, filename): return os.path.exists(self.get_dir_name() + filename)</span></span></code> </pre><br><br><h4>  Create a letter </h4><br>  Now that we have content that we plan to send, it would be nice to create an ‚Äúenvelope‚Äù for it. <br>  To work with letters in python, the module is used ... the module is used ... the email module is used. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> email, email. encoders, email.mime.text, email.mime.base <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageBase</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, subscriber)</span></span></span><span class="hljs-function">:</span></span> self.__to_addresses = subscriber.get_subscribers() self.__from_address = subscriber.get_from() self.__message = self.__create_message(subscriber.get_title(), subscriber.get_text())</code> </pre><br>  To begin with we will create the simple text letter.  Details about MIME are available, of course, <a href="http://en.wikipedia.org/wiki/MIME">here</a> . <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__create_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, subject, text)</span></span></span><span class="hljs-function">:</span></span> email_msg = email.MIMEMultipart.MIMEMultipart(<span class="hljs-string"><span class="hljs-string">'mixed'</span></span>) email_msg[<span class="hljs-string"><span class="hljs-string">'Subject'</span></span>] = subject email_msg[<span class="hljs-string"><span class="hljs-string">'From'</span></span>] = self.get_from() email_msg[<span class="hljs-string"><span class="hljs-string">'To'</span></span>] = <span class="hljs-string"><span class="hljs-string">', '</span></span>.join(self.get_to()) email_msg.attach(email.mime.text.MIMEText(text,<span class="hljs-string"><span class="hljs-string">'text'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> email_msg</code> </pre><br>  It's time to create a function to attach a file.  If you want your email client to open attachments, you must specify a file_type. <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attach_file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, filename, file_link, file_type = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'unknown'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> file_message = email.mime.base.MIMEBase(<span class="hljs-string"><span class="hljs-string">'application'</span></span>, file_type) file_message.set_payload(file(file_link).read()) email.encoders.encode_base64(file_message) file_message.add_header(<span class="hljs-string"><span class="hljs-string">'Content-Disposition'</span></span>,<span class="hljs-string"><span class="hljs-string">'attachment;filename='</span></span>+filename) self.__message.attach(file_message) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br><br>  In order to get the message from the message to send, call the method as_string (). <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__message.as_string()</code> </pre><br><br><h4>  We send the letter </h4><br>  Now when there is a letter, you need to be able to send it.  Smtplib is responsible for sending emails to Python. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> smtplib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageBase <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SmtpBase</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, serverhost)</span></span></span><span class="hljs-function">:</span></span> self.__smtp_server = serverhost <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.__server = smtplib.SMTP(self.__smtp_server) self.__server.login(<span class="hljs-string"><span class="hljs-string">'&lt;enter your smtp login&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'&lt;enter your smtp password&gt;'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.__server.quit()</code> </pre><br><br>  Imagine that we have a Message class with the get_from (), get_to (), and get_text () methods. <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_mail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> message_to <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> message.get_to(): self.__server.sendmail(message.get_from(), message_to, message.get_text())</code> </pre><br><br>  To maintain 'with' you need to add a couple of methods: <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__enter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.open() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__exit__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, type, value, traceback)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> type: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'%s: %s %s'</span></span> % (type, value, traceback) self.close()</code> </pre><br><br><h4>  Generalize </h4><br>  Now we have everything we need. <br>  My final script script looks like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> subscriber_sex <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SportExpress <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> smtp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SmtpBase <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageBase b = SportExpress() filenames = b.download_by_link(<span class="hljs-string"><span class="hljs-string">'http://www.sport-express.ru'</span></span>) msg = MessageBase(b) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filenames: msg.attach_file(file[file.rfind(<span class="hljs-string"><span class="hljs-string">'/'</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>:], file, <span class="hljs-string"><span class="hljs-string">'pdf'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SmtpBase(<span class="hljs-string"><span class="hljs-string">'smtp.yandex.ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> s: s.send_mail(msg)</code> </pre><br>  After each launch of this script, the latest release of Sport Express goes straight to your inbox!  I propose to share in the comments, what other publications distribute free pdf versions of magazines.  In principle, it is possible and not pdf, as long as it is possible to receive fresh issues on a regular basis. <br><br>  And so, in order to download a new magazine - you just need to change 3 functions. <br><br>  I hope that the material was useful and pleasant for the reader. </div><p>Source: <a href="https://habr.com/ru/post/150940/">https://habr.com/ru/post/150940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150932/index.html">Free groups on C ++ and web programming in Moscow for high school students!</a></li>
<li><a href="../150933/index.html">Interception of video in a browser or TCP sniffer under Windows on the knee (part two)</a></li>
<li><a href="../150934/index.html">Mobile editions - is it still future or is it already present? Interview with Vitaliy Dubinin</a></li>
<li><a href="../150935/index.html">Digest of Moscow vacancies</a></li>
<li><a href="../150936/index.html">Games of operators of communication with fire: for what and how does FAS penalize</a></li>
<li><a href="../150941/index.html">Ruby NoName Podcast S04E17</a></li>
<li><a href="../150942/index.html">Notes on MODX Revo from newbie</a></li>
<li><a href="../150943/index.html">Where should Delphi develop instead of where it is developing now?</a></li>
<li><a href="../150944/index.html">Neutrino - a tiny js framework with full inheritance and events</a></li>
<li><a href="../150946/index.html">Add Bundling and Minification to ASP.NET Web Pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>