<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Free network security audit with Fortinet. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we covered the topic of network security auditing with Fortinet ( Part 1 ). We discussed the main features and reviewed the s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Free network security audit with Fortinet. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the previous article, we covered the topic of network security auditing with Fortinet ( <a href="https://habrahabr.ru/company/tssolution/blog/335184/">Part 1</a> ).  We discussed the main features and reviewed the sample report.  Now we will look directly at installation and configuration.  We agreed that we will use <b>FortiGate VM</b> and <b>FortiAnalyzer</b> virtual solutions for auditing.  Those.  first you need to <a href="">request</a> these images and demo licenses.  Unfortunately we can not provide a direct link to the images (licensing restrictions).  The implementation scheme looks pretty simple: <br><br><img src="https://habrastorage.org/web/068/bff/697/068bff6975fb48dab37f923141662163.png"><br><br>  Those.  on the existing virtualization server, two virtual machines are ‚Äúraised‚Äù.  In our case, we will use ESXi, but there is support for Hyper-V and KVM.  FortiGate VM with one adapter is connected to a common network (vSwitch0).  This link will be used to manage and access the Internet.  The second interface connects to another vSwitch1, which in turn is connected to the server‚Äôs free physical port (eth2).  It is on this port that the traffic should be mirrored for analysis.  Note that Promiscuous mode (Accept) must be enabled for the vSwitch1 switch.  More details can be found <a href="https://habrahabr.ru/company/tssolution/blog/329438/">here</a> . <br><a name="habracut"></a><br>  Nearby, FortiAnalyzer is also installed, which is sufficient to connect only one interface to your network (vSwitch0). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Import Images </h2><br>  As you understand, the first thing you need to import images.  They are delivered in the form of ovf, so no problems should arise. <br><br>  Import FortiGate VM: <br><br><img src="https://habrastorage.org/web/fcb/725/393/fcb725393a9c4db5b0bd629df9a5fa75.png"><br><br>  Now you need to select a file.  There are several of them in the archive, but we just need <b>FortiGate-VM64.ovf</b> : <br><br><img src="https://habrastorage.org/web/fe7/861/9a5/fe78619a57a54263be3201ef5a1193d9.png"><br><br>  Further, when configuring the interfaces, you need to select the VM Network for the first adapter (which corresponds to the network management - vSwitch0), and for the second - the VM Network 2 (which corresponds to the SPAN port - vSwitch1).  The rest of the ports can be left by default: <br><br><img src="https://habrastorage.org/web/847/432/952/8474329523344d10a661db6b6949e08e.png"><br><br>  By default, 1 GB of RAM and 1 core are set in the virtual machine properties.  Do not try to change these parameters, otherwise the trial license is not activated and you will not be able to connect to this device.  We'll fix it later. <br><br>  The FortiAnalyzer virtual machine is imported in the same way.  You must select the <b>FortiAnalyzer-VM64.ovf file</b> : <br><br><img src="https://habrastorage.org/web/53d/81b/cf3/53d81bcf35b34706a25f0018ad4886d3.png"><br><br>  When setting up a network, it is enough to enable the first interface in the VM Network (i.e. network management): <br><br><img src="https://habrastorage.org/web/f55/10b/f71/f5510bf71589470e82375a0bc4daa0ea.png"><br><br>  This virtual machine has 4GB of RAM and 2 cores by default.  As a rule, these parameters are always enough. <br><br><h2>  Startup and initial setup </h2><br>  After successful import of images, you can start both "machines".  First of all, we need to configure the ip-address and default route so that you can connect to the devices already through the web-interface. <br><br>  The login is admin, and the password is empty (just press enter): <br><br><img src="https://habrastorage.org/web/7d6/855/f99/7d6855f990d645f5857ed45d45d4f586.png"><br><br>  The ip address setting is performed using the following commands: <br><br> <code><b>config system interface</b> <br> <b>edit port1</b> //   <br> <b>set ip 10.10.10.112/24</b> //IP     <br> <b>end</b></code> <br> <br>  Setting the default gateway: <br><br> <code><b>config router static</b> <br> <b>edit 1</b> //    <br> <b>set gateway 10.10.10.254</b> <br> <b>set device port1</b> <br> <b>end</b></code> <br> <br><img src="https://habrastorage.org/web/104/999/94c/10499994c04c4d778fe4eab89445b118.png"><br><br>  To check the settings, you can use the following commands: <br><br>  <b>show system interface</b> (output port settings) <br>  <b>show router static</b> (display of router settings) <br><br>  Settings for FortiAnalyzer are similar: <br><br> <code><b>config system interface</b> <br> <b>edit port1</b> //   <br> <b>set ip 10.10.10.113/24</b> //IP     <br> <b>end</b></code> <br> <br>  The configuration of the gateway is slightly different: <br><br> <code><b>config system route</b> <br> <b>edit 1</b> //    <br> <b>set gateway 10.10.10.254</b> <br> <b>set device port1</b> <br> <b>end</b></code> <br> <br>  After configuring the interfaces, it is very important to check that the Internet is available on the devices, otherwise the licenses are not activated.  To verify, use the <b>execute ping</b> command. <br><br><img src="https://habrastorage.org/web/7df/80c/aa1/7df80caa1db24a289356bf279b110068.png"><br><br><h2>  Connect and activate licenses </h2><br>  After configuration, we can connect via the web-interface and activate the licenses that your partner should provide.  Let's start with FortiAnalyzer: <br><br><img src="https://habrastorage.org/web/f4c/d67/c48/f4cd67c487ed4abea5577073ec71de3b.PNG"><br><br>  Login <b>admin</b> and empty password.  After logging in, the start page will open: <br><br><img src="https://habrastorage.org/web/a46/84a/6e3/a4684a6e3de547fd88202f730b53eca9.PNG"><br><br>  We are interested in System Settings: <br><br><img src="https://habrastorage.org/web/9f9/f11/940/9f9f119404c24a0f9a6794b3d5242d52.PNG"><br><br>  In the upper right corner we will see the license information.  Currently the trial version is active, but we will add a new one by clicking on the Upload License.  After that, the device will reboot with a new license. <br><br>  FortiGate is a similar procedure.  When connecting, please note that the http version of the portal will open, and if you try to connect via https, the browser will generate an error ERR_SSL_VERSION_OR_CIPHER_MISMATCH.  This is a normal situation due to the trial mode.  After the license is activated, we will be able to connect via HTTPS.  The login window looks like this: <br><br><img src="https://habrastorage.org/web/153/5f0/612/1535f0612c554d5c9117caf7b60ec13f.png"><br><br>  Login - <b>admin</b> , password - empty.  After logging in we will see the FortiGate main page: <br><br><img src="https://habrastorage.org/web/bde/7f1/a46/bde7f1a46c414f5d812455eeacb4eedf.png"><br><br>  You need to activate the license by clicking on FGVMEV License and then throw a new one: <br><br><img src="https://habrastorage.org/web/baa/e31/f54/baae31f5433140e49626b0f57466202e.png"><br><br>  After that, the license activation process will begin, which may take some time: <br><br><img src="https://habrastorage.org/web/904/9b7/ea2/9049b7ea2f8a408f90739300834d2cab.png"><br><br>  After activation, the gateway will reboot.  Now for a virtual machine, you can set 2 cores and 4 GB of RAM (depending on the license that you generated).  As a result, you should see something like the following: <br><br><img src="https://habrastorage.org/web/58e/b07/e75/58eb07e751724294befe32393a276825.PNG"><br><br>  Please note that IPS, Anti-Virus, Web-filtering services may not be activated immediately, but after a while. <br><br><h2>  Configure One-Arm Sniffer </h2><br>  Now you can proceed directly to setting up a One-Arm Sniffer.  To do this, open the interface settings: <br><br><img src="https://habrastorage.org/web/874/dbf/c25/874dbfc25edf4d33bc741029d53b5e89.PNG"><br><br>  We are interested in <b>port2</b> , because  it is he who is connected to the SPAN port.  Double click on its properties and set the settings as in the picture below: <br><br><img src="https://habrastorage.org/web/d39/a5f/62a/d39a5f62a7a6442b93e5524e1d758c9a.PNG"><br><br>  It is important to remember to click <b>OK</b> to apply the settings.  After that, you need to go into the <b>port2</b> settings <b>again</b> , and in turn open the settings of the AntiVirus, Web Filter, Application Control and IPS profiles. <br><br>  Let's start with <b>AntiVirus</b> ( <b>Edit Sniffer Profile</b> ).  The settings should look like this: <br><br><img src="https://habrastorage.org/web/d54/b44/0ef/d54b440ef43647de91ff5891ae93f163.PNG"><br><br>  Do not forget to click <b>Apply</b> .  <b>Web Filter</b> Settings ( <b>Edit Sniffer Profile</b> ): <br><br><img src="https://habrastorage.org/web/6cd/202/d06/6cd202d066244630bb9fe8d97d76d941.PNG"><br><br>  Settings <b>Application Control</b> ( <b>Edit Sniffer Profile</b> ): <br><br><img src="https://habrastorage.org/web/5b3/530/f1d/5b3530f1d83849b28a5216454d9577af.PNG"><br><br>  <b>IPS</b> settings ( <b>Edit Sniffer Profile</b> ): <br><br><img src="https://habrastorage.org/web/fe3/5fc/c6f/fe35fcc6f6634d7ab5490869b415d3cd.png"><br><br>  As you can see, the profile includes signatures with the importance level <b>Critical</b> and <b>High</b> by default.  You need to add <b>Medium</b> : <br><br><img src="https://habrastorage.org/web/d65/81a/315/d6581a315bde4c20968067697860d1e3.png"><br><br>  Also for this profile as an action you need to install the <b>Monitor</b> : <br><br><img src="https://habrastorage.org/web/1f2/af3/65a/1f2af365a9394c1f8d93d37c10bc2cbb.png"><br><br>  Do not forget to save the settings by clicking <b>Apply</b> . <br>  This completes the configuration of the <b>One-Arm Sniffer</b> and then you need to configure the integration with FortiAnalyzer. <br><br><h2>  Integration with FortiAnalyzer </h2><br>  To integrate with FortiAnalyzer, you need to properly configure logging.  Go to <b>Log Settings</b> : <br><br><img src="https://habrastorage.org/web/976/cde/584/976cde58455a4bbf9bf94a5434b40985.PNG"><br><br>  Logging to Disk can be turned off and specify the ip-address of our FortiAnalyzer, as in the figure above.  Clicking on <b>Test Connectivity</b> we will see that the device needs to be registered on FortiAnalyzer.  Click <b>Apply</b> and go to the FortiAnalyzer settings in the <b>Device Manager</b> section: <br><br><img src="https://habrastorage.org/web/2fa/54c/1a7/2fa54c1a7de1447f9d669618bf61c752.PNG"><br><br>  Go to the section <b>Unregistered</b> : <br><br><img src="https://habrastorage.org/web/ded/7d5/664/ded7d56647af4c23beb5578d74a5036b.PNG"><br><br>  Here we will see our FortiGate.  Select it and click <b>Add</b> : <br><br><img src="https://habrastorage.org/web/424/868/325/42486832579c49f3a6bdc74d26ca7288.PNG"><br><br>  Click <b>OK</b> : <br><br><img src="https://habrastorage.org/web/365/094/9ca/3650949ca5b147078afc44424507dae0.PNG"><br><br>  From this point on, FortiGate is registered: <br><br><img src="https://habrastorage.org/web/b46/f7f/d99/b46f7fd99eee45b6863e375499abd743.PNG"><br><br>  We return to the FortiGate settings in <b>Log Settings</b> .  Check the <b>Test Connectivity</b> again and set the <b>Upload option</b> to <b>Real Time</b> : <br><br><img src="https://habrastorage.org/web/994/fe5/0cc/994fe50cc67b4df39d65aca74228b06b.PNG"><br><br>  For <b>Event Logging, we</b> set <b>All</b> , and in the <b>Display Logs</b> field, set <b>FortiAnalyzer</b> : <br><br><img src="https://habrastorage.org/web/d58/1b2/198/d581b2198e2149f3a63506758998afa6.PNG"><br><br>  Do not forget to apply the setting ( <b>Apply</b> ).  But this setting FortiGate and FortiAnalyzer is fully completed. <br><br><h2>  Report generation </h2><br>  Before generating the report, you need to make sure that the logs actually come to FortiAnalyzer.  To do this, go to the <b>Log View</b> : <br><br><img src="https://habrastorage.org/web/8d3/980/cba/8d3980cbaf494964a2837387e0150a73.PNG"><br><br>  You should see the FortiGate logs: <br><br><img src="https://habrastorage.org/web/ab8/f58/215/ab8f58215408469bb62aa9ba075f8198.PNG"><br><br>  Logs come.  Now for the collection of statistics it takes a long time ( <b>preferably 2-4 weeks</b> ).  However, you can generate reports at any time.  To do this, go to the Reports section: <br><br><img src="https://habrastorage.org/web/4ee/55f/efa/4ee55fefab81423ca93d850527de3e01.PNG"><br><br>  A large number of reports are available here, but we are interested in <b>Cyber ‚Äã‚ÄãThreat Assessment</b> .  Select it and click <b>Run Report</b> : <br><br><img src="https://habrastorage.org/web/8a3/253/8d0/8a32538d0f2e4e6796eb1d22a14ab21a.PNG"><br><br>  The finished report will be found in the <b>Generated Reports</b> section: <br><br><img src="https://habrastorage.org/web/7d2/6aa/5aa/7d26aa5aac9a4f63a1505ad565a95a70.PNG"><br><br>  Before generating the report, it is recommended to wait at least one hour in order to gain at least some statistics.  An example of the report can be found <a href="https://drive.google.com/file/d/0B-5kZl7ixcSKN3JXdllOYktiMG8/view%3Fusp%3Dsharing">here</a> . <br><br><h2>  Conclusion </h2><br>  Although the procedure is simple (it takes a maximum of 30 minutes of time) there are quite a few pictures.  Perhaps somewhere not entirely obvious are our actions.  That is why in the near future we <a href="https://www.youtube.com/channel/UCKOESE8nBWQPuQmi994_YMA">will publish small video tutorials</a> , where, step by step, we <a href="https://www.youtube.com/channel/UCKOESE8nBWQPuQmi994_YMA">will</a> go through the whole setup procedure. <br><br>  As we already wrote in the <a href="https://habrahabr.ru/company/tssolution/blog/335184/">first part</a> , this audit is a good opportunity to analyze the current state of its network.  The reports are very detailed and informative.  And given the simplicity of the whole process, everyone can do it. <br><br>  More information on Fortinet can be found <a href="http://tssolution.ru/fortinet-overview/">here</a> . <br><br>  If you are interested in such a ‚Äúpilot‚Äù project, you can feel free <b><a href="">to contact us</a></b> for licenses and images or simply for help with Fortinet products.  Thank. <br><br>  PS I would like to thank Yuri Zakharov (Fortinet system engineer) for help in preparing this article. </div><p>Source: <a href="https://habr.com/ru/post/335402/">https://habr.com/ru/post/335402/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335390/index.html">1C-like interpreter on Go</a></li>
<li><a href="../335392/index.html">Recognize and neutralize. Search for unorthodox backdoors</a></li>
<li><a href="../335394/index.html">School of Data: we have done better</a></li>
<li><a href="../335398/index.html">Electronic voting protocol: my version</a></li>
<li><a href="../335400/index.html">Good code is our best documentation.</a></li>
<li><a href="../335404/index.html">How I started to create a text MMO RPG</a></li>
<li><a href="../335406/index.html">Will AR / VR replace tourism and travel?</a></li>
<li><a href="../335408/index.html">Social Organism - as a form of effective team interaction. Part 1</a></li>
<li><a href="../335410/index.html">Monitoring as a service: a modular system for microservice architecture</a></li>
<li><a href="../335414/index.html">Passive device, routing and Barcode-Print</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>