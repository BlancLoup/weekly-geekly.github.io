<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of the development of mobile MMO RTS. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Most recently, I began to talk about how we are working on Stormfall: Rise of Balur and writing the client part of the project on Unity. Today ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of the development of mobile MMO RTS. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Most recently, I began to talk about how we are working on Stormfall: Rise of Balur and writing the client part of the project on Unity.  Today we will talk about the approach to skinning, multithreading, networking with a poor connection and query caching. <br><br><img src="https://habrastorage.org/files/12c/08d/7bb/12c08d7bbeed4543899fe254ea3e57a7.jpg"><br><a name="habracut"></a><br><h2>  Skins and work with them </h2><br>  The genre of RTS adapts well to different settings based on the same engine.  We have several such games.  When writing a project, a lot of things change: UI, UX, gameplay logic.  Sometimes there may be specific requirements for the integration of libraries and social services.  When designing the game, we had to lay the requirements in the architecture, while maintaining the maximum possible sharing of the code. <br><br>  In order to customize the behavior of the UI, we decided to make the operation of UI objects begin with the dynamic loading of prefabs from resources.  After that, a specific View script is run, which is tied to special classes from the ViewModel.  The model itself is written to support all features, because it is a reflection of the server and is configured when logging in from the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/a7c/16f/8d8/a7c16f8d8c4841f0ba25bb556c155196.png"><br><br>  In Unity there is no file with a description of the project: all the code that is in the Assets folder gets into the build.  Under such conditions, it is difficult to create several projects with a common code base.  We decided that we would use a common repository, in which the project is not in the form of a Unity project, but in the form we need. <br><br>  Using the script that creates the symlinks on the folder with the code, we expand the Unity project.  If necessary, deploy the dev-build.  It has all the code, including from other projects.  This is needed, for example, to refactor, but the gameplay will not affect in any way. <br><br><h2>  Multithreading in Stormfall: Rise of Balur </h2><br>  When the mobile market only gained momentum, the developers discussed whether multithreading is needed for their applications.  Now it is no longer a matter for discussion.  Multithreading we solve several problems: <br><br><ol><li>  Perform callback requests to the server in threads from ThreadPool.  The commands themselves, in addition to performing WebRequest, serialize the data sent to the JSON format and deserialize the response.  They also carry out the process of updating the model with new data that comes in response. </li><li>  Execution of the mechanism for updating the model in a separate thread.  The mechanism is triggered once a second and can run for quite a long time. </li></ol><br>  The data access mechanism of the model works through the monitor and supports various data blocking policies.  It gives read access to a number of objects at the same time, but does not allow the possibility of combining this with writing data to the Model. <br><br>  Unity does not allow to work with the engine from a minor stream.  Keep this in mind when designing your application, and try to unload the main thread while taking non-UI data processing to other threads. <br><br><img src="https://habrastorage.org/files/374/a9a/dc4/374a9adc4f734496ab913a79a3b78555.png"><br><br><h2>  Work with the network with a bad connection </h2><br>  In Stormfall: Rise of Balur, interaction with the server occurs via HTTP requests.  In the event of a request error, we cannot always determine at what stage the error occurred and whether the request was executed on the server.  It must be remembered that mobile games work through the mobile Internet, which is not always stable.  To provide users with a comfortable gameplay, we have implemented several approaches: <br><br><ol><li>  Optimistic query execution. </li><li>  Overrun user request.  This method protects against double execution of commands if the request was for changing data and terminated on return to the client. </li></ol><br>  Now in more detail about each approach. <br><br><h2>  Optimistic query execution </h2><br>  We implemented a mechanism in the query commands that allows you to avoid UI locks when they are executed.  After the request begins to execute, we change the model so that the server returns a successful response.  If the answer was really successful, we do not change or supplement the model with a response from the server.  If the server returns an error, call the rollback method of the changes that were executed at the initial stage and notify the user of the error. <br><br>  What exactly have we done for this: <br><br><ol><li>  They implemented a separate type of command that describes the ability to pre-execute the request, without waiting for the server to respond. </li><li>  We made it so that requests are executed strictly sequentially using a queue.  It can contain 2 requests: active and waiting.  There are so few of them, because we don‚Äôt want the user to be able to plan many actions.  If the first command returns an error, then all other commands must be canceled, otherwise their execution will lead to inconsistency of data.  We do not exclude that the user can quit the game, and the command queue will not be sent to the server for execution.  If the queue is full, the user is shown a wait window. </li><li>  We have ensured that in the event of an error in executing the request for it, all actions taken are rolled back, and the next request in the queue, if present, is canceled.  Rollback of actions is programmed manually. </li></ol><br><h2>  Caching server-side editing queries </h2><br>  Let us turn to the implementation of the second approach: <br><br><ol><li>  If the client receives a network error when requesting a server, it tries to resend the request. </li><li>  Each request has its own identifier. </li><li>  If the request is exceeded, the attempt number is also recorded in the header. </li><li>  For each subsequent request, the timeout increases from 10 seconds to 20. We did this for cases when the user has a poor Internet connection and does not have enough speed in the allotted time to download a large response from the server.  It may seem that this makes no sense, you can immediately put the maximum value.  In practice, it turns out that the request, which was dropped for network reasons, will repeat at the minimum interval.  This is better than waiting for a maximum timeout and retry request. </li><li>  If all requests fail, we show the user information about the error, and when the maximum number of network errors is reached, we consider that the session cannot be continued, and we suggest the user to restart the game. </li><li>  On the server side, several recent edit requests for each user are briefly cached.  Upon receiving a request with an identifier that has already been executed, the cached result is returned - of course, if it exists.  If not, the server returns an error. </li><li>  Requests for reading are not cached and are always processed by the server for a new one. </li></ol><br>  According to statistics, 0.76% of requests get out of the cache, and this is every 130th user request. <br><br>  See you in the third part!  If you missed the beginning of the cycle on creating MMO RTS on Unity, look for it <a href="https://habrahabr.ru/company/plarium/blog/317976/">here</a> . <br><br><h2>  Other articles from the series: </h2><br><ul><li>  <a href="https://habrahabr.ru/company/plarium/blog/317976/">Part 1</a> ; </li><li>  <a href="https://habrahabr.ru/company/plarium/blog/320814/">Part 3</a> ; </li><li>  <a href="https://habrahabr.ru/company/plarium/blog/323448/">Part 4</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/318966/">https://habr.com/ru/post/318966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318954/index.html">Processing preprocessor directives in Objective-C</a></li>
<li><a href="../318958/index.html">json-api-normalizer: an easy way to make friends with Redux and the JSON API</a></li>
<li><a href="../318960/index.html">Scala type classes (with a little overview of the cats library)</a></li>
<li><a href="../318962/index.html">About string formatting in modern C ++</a></li>
<li><a href="../318964/index.html">Towers of Hanoi - a theoretical solution without recursion</a></li>
<li><a href="../318968/index.html">Security in IoT: Security Architecture</a></li>
<li><a href="../318970/index.html">Neural network optimization methods</a></li>
<li><a href="../318972/index.html">Adaptive jQuery without window.matchMedia</a></li>
<li><a href="../318976/index.html">How IT professionals work. Ilya Safonov, Senior Research Scientist at Schlumberger</a></li>
<li><a href="../318980/index.html">Theoretical Foundations of VMware Virtual SAN 6.5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>