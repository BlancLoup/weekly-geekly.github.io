<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Method Swizzling and Swift: but there is a nuance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes for convenience, sometimes in order to get around a bug in the framework, and sometimes just because of despair, you may need to override th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Method Swizzling and Swift: but there is a nuance</h1><div class="post__text post__text-html js-mediator-article">  Sometimes for convenience, sometimes in order to get around a bug in the framework, and sometimes just because of despair, you may need to override the behavior of some method of a class created by someone else.  Method Swizzling allows you to replace your method right at runtime, while leaving the original implementation available. <br><br>  The <a href="http://habrahabr.ru/post/177421/">Objective-C Runtime</a> article <a href="http://habrahabr.ru/post/177421/">.</a>  <a href="http://habrahabr.ru/post/177421/">Theory and practical application of</a> this process is well described.  But with the transition to Swift some nuances appear. <br><a name="habracut"></a><br>  Let's start with an example.  For example, in the third-party framework <i>Charts</i> , there is some class <i>ChartRenderer</i> , in which there is a method <i>drawDots</i> , which on the chart draws a circle in the nodal points.  And we really want not a circle, but an asterisk.  And we don‚Äôt really want to climb inside the framework either, because from time to time its updates come out and losing them is a pity. <br><br>  Therefore, we will create an extension of the <i>ChartRenderer</i> class, which will replace the <i>drawDots</i> method with our <i>drawStars</i> method right at runtime.  No need to worry as the other objects in the <i>Charts</i> call the <i>ChartRenderer</i> , each time the <i>drawStars</i> method <i>call is</i> answered by the <i>drawStars</i> method. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs bash">extension ChartRenderer { public override class func <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span></span>() { struct Static { static var token: dispatch_once_t = 0 } // ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self !== UIViewController.self { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> } dispatch_once(&amp;Static.token) { <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> originalSelector = Selector(<span class="hljs-string"><span class="hljs-string">"drawDots:"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> swizzledSelector = Selector(<span class="hljs-string"><span class="hljs-string">"drawStars:"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> originalMethod = class_getInstanceMethod(self, originalSelector) <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> swizzledMethod = class_getInstanceMethod(self, swizzledSelector) <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> didAddMethod = class_addMethod(self, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> didAddMethod { class_replaceMethod(self, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod) } } } //  func drawStars(color: CGColor) { //  // ,     drawStars(...), //    drawDots(...),    <span class="hljs-string"><span class="hljs-string">"drawStars:"</span></span> } }</code> </pre> <br>  In all materials on Objective-C they write that methods need to be substituted in <i>load ()</i> , and not in <i>initialize ()</i> , because the first is called only once for the class, and the second is also called for all subclasses.  But since runtime, when using Swift, does not call <i>load ()</i> at all, we have to make sure that this <i>initialize () is</i> called by the class, and not by any of the heirs, and that the replacement will be performed only once using <i>dispatch_once</i> . <br><br>  It is worth noting that there is an alternative option, which is simpler but less visual: instead of an extension, perform all these operations in the <i>AppDelegate</i> <i>application (_: didFinishLaunchingWithOptions :)</i> . <br><br>  If the <i>ChartRenderer is</i> written in Objective-C, everything should work this way.  Good article is on NSHipster ( <a href="http://nshipster.com/swift-objc-runtime/">English</a> ). <br><br>  And now about the nuance, because of which you can break your head.  When using method swizzling in the case when both the project and the class with the replaceable method are written in Swift, this one must meet two requirements: <br><br><ul><li>  he must be NSObject's heir </li><li>  substitution method must have a dynamic attribute </li></ul><br>  Like that: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChartRenderer</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawDots</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  } }</span></span></code> </pre><br>  The nature of this nuance is explained in the article <a href="https://developer.apple.com/library/ios/documentation/Swift/Conceptual/BuildingCocoaApps/InteractingWithObjective-CAPIs.html">Using Swift with Cocoa and Objective-C</a> : <br><blockquote><h5>  Requiring Dynamic Dispatch </h5><br>  It is <a href="https://habrahabr.ru/users/objc/" class="user_link">not a</a> problem for the Objective-C run-time API, it doesn‚Äôt guarantee the dispatch of a property, method, subscript, or initializer.  The Swift compiler may still be devirtualize or inline a member of the code, bypassing the Objective-C runtime.  Dynamically dispatched.  Because of the fact that they are dispatched using the Objective-C runtime, they are marked with the <a href="https://habrahabr.ru/users/objc/" class="user_link">objc</a> attribute. <br>  Requiring dynamic dispatch is rarely necessary.  <b>However, you must replace the API.</b>  For example, you can use the method while the app is running.  It‚Äôs not a problem. </blockquote><br><br>  In addition to the above articles, the English problem is well described in a certain Bartek Hugo <a href="http://blog.untitledkingdom.co/obj-c-vs-swift/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/274545/">https://habr.com/ru/post/274545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274527/index.html">Solving the puzzle Galakub on Python</a></li>
<li><a href="../274529/index.html">Sound Manager for small games and prototypes on Unity</a></li>
<li><a href="../274533/index.html">Deanonymization of a programmer is possible not only through the source code, but also through a compiled binary file</a></li>
<li><a href="../274535/index.html">Animation of falling snow on Canvas is more effective than animation on DOM several times.</a></li>
<li><a href="../274539/index.html">Configure logrotate + access to collect logs via SFTP</a></li>
<li><a href="../274547/index.html">IBM has released more than 100 business applications with Apple</a></li>
<li><a href="../274549/index.html">Results of 2015 for C ++</a></li>
<li><a href="../274555/index.html">PayPal API Go Client</a></li>
<li><a href="../274557/index.html">Sitemap.xml or ‚ÄúThere was nothing to do ...‚Äù</a></li>
<li><a href="../274559/index.html">Google fixed Android vulnerabilities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>