<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to keep 20 thousand VPN clients on servers for $ 5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A month ago, my friends and I made a free service to bypass site blockages in Ukraine Zaborona.Help . During this time, the service has become quite p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to keep 20 thousand VPN clients on servers for $ 5</h1><div class="post__text post__text-html js-mediator-article">  A month ago, my friends and I made a free service to bypass site blockages in Ukraine <a href="https://zaborona.help/">Zaborona.Help</a> .  During this time, the service has become quite popular, the audience has grown to 20,000 users.  The number of simultaneous connections at peak hours is ‚âà6,000 clients. <br><br>  The main feature of our service is that through VPN traffic is only routed to blocked networks, other sites work directly.  This does not affect the speed of the Internet and does not replace the IP address for other sites. <br><br>  The article describes the details of setting up OpenVPN for a large number of clients on cheap VPS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  How to choose a suitable hosting.  Distinguishing features of bad hosting.  The story of how we have been looking for and found hosting in Russia. </li><li>  Why IPv6 is good.  Correctly configuring IPv6 addresses for VPN clients. </li><li>  Changing OpenVPN configuration on the fly, without restarting the server and disconnecting clients. </li><li>  Load balancing between servers and OpenVPN processes </li><li>  Tweaking Linux for a large number of connections </li><li>  Features of curved operating systems and user routers </li></ul><br>  Our experience will be useful for those who are going to deploy a VPN for personal needs, and those who want to create a service with a large number of clients. <br><a name="habracut"></a><br><h2>  Hosting </h2><br>  At first, we used several servers in Europe from Scaleway, Linode, DigitalOcean providers.  These were the cheapest VPS, for $ 3-5.  Immediately, users began to complain that due to the European IP addresses, Yandex.Music and VK.com music is not available.  We began to look for a suitable hosting in the CIS. <br><br>  It turned out that domestic hosters, comparable in level of services to European ones, do not exist.  Almost always, this is a low quality of services at a high price, a complicated order procedure, outdated technologies.  During the search, we managed to create a list of the distinctive features of bad hosting. <br><br><h3>  Distinctive features of a poor hosting </h3><br><ul><li>  <b>Use the term VDS</b> instead of VPS.  Although there is nothing terrible in the abbreviation itself, it is a kind of black label that practically guarantees a low level of service and a control panel interface from the 90s. <br><br></li><li>  <b>Panel BillManager, ISPmanager, etc.</b>  - the standard of the advanced interface with a bunch of buttons, incomprehensible menus.  The process of ordering a server in such panels is carried out in several stages.  The control panel of the server itself is usually located on a subdomain separate from the order panel, with a separate login-password, which is not transferred in the most obvious way.  The process of ordering or modifying a service becomes real torment, often requiring recourse to technical support.  If the procedure for ordering a server takes more than a few clicks and takes more than two minutes - this is bad hosting. <br><br></li><li><img src="https://habrastorage.org/getpro/habr/post_images/6f0/496/7a2/6f04967a2f02968327c60007f416461a.png" width="500" alt="Interface control panel BillManager"><br>  <i><font color="99999">The interface of the control panel BillManager - a distinctive feature of outdated hosting</font></i> <br><br></li><li>  <b>Misunderstanding of IPv6 principles.</b>  Many hosters allocate one IPv6-address and require a fee for each additional.  Net / 64 will cost quintillons dollars. <br><br></li><li>  <b>OpenVZ Virtualization.</b>  Most commercial OpenVZ VPS providers use the venet interface, and panels that do not allow assigning IPv6 address subnets to a separate container, but only to one separate address (/ 128) per interface.  Such addresses can not normally be distributed to VPN clients. </li></ul><br>  Having tried several hosting sites, we almost despaired.  It seemed that in Russia there simply wasn‚Äôt a normal hosting provider for our needs.  I sent a letter to all the hosters that I could find on the hosting aggregator sites, in which I described our requirements, and asked for free to provide us with a site in exchange for advertising on our site. <br><br><h3>  Our requirements for VPS servers </h3><br><ul><li>  <b>XEN or KVM virtualization.</b>  OpenVZ in most cases does not allow IPv6 addresses to be managed normally, it has restrictions on configuring kernel variables (sysctl).  For some needs, OpenVZ is quite suitable, but not for a large and heavily loaded VPN server. <br><br></li><li>  <b>Powerful server processor.</b>  Some providers, like Scaleway, offer low-cost VPS servers on low-power ARM or Intel Atom processors.  There are even servers on VIA processors.  On such systems, OpenVPN works slowly, but not because of encryption, as one might expect.  The tun module, which is used by OpenVPN to create a network interface, is not optimized for high loads: it accepts or gives only one packet per system call, which causes a large number of context switches between kernel mode and user mode.  The slower the memory frequency and the cheaper the processor, the slower the switching occurs.  In addition, the OpenVPN code uses the recv and send system calls that operate on single network packets, which is why the sending of encrypted packets also does not occur in the most optimal way.  Therefore, for normal operation of OpenVPN, it is important to have a fast processor and memory. <br><br></li><li>  <b>Unlimited traffic</b> and good channels.  Users consume a lot of media content in social networks, the traffic is consumed very quickly.  Tariffs with a low traffic quota (1TB) are spent per day. <br><br></li><li>  <b>A separate, routable IPv6 network is</b> needed to directly allocate real addresses to clients.  Most hosters do not even understand what this means, and simply assign the required subnet to the network interface of the hypervisor, rather than creating an entry in the routing table via the existing (or via link-local-address).  It does not allow, without crutches, to assign the issued range to the VPN network interface and issue IPv6 addresses directly to the clients: the hoster hypervisor sends an NDP request (ARP equivalent for IPv6) to the virtual machine, the virtual machine does not find this address, does not respond to the request will not work.  There are <a href="https://github.com/DanielAdolfsson/ndppd">NDP proxies</a> that allow you to work around this problem, but this is inconvenient, and this can create additional load on the hypervisor and hoster routers. </li></ul><br>  About a dozen companies responded to our request, but almost all of them had signs of poor hosting and did not fit.  As a result, we did find the <b>ONLY</b> hosting provider that satisfies all our needs. <br><br>  It sounds strange, but I am ready to prove with conviction in the comments that 99% of domestic hosts are bullshit, not reaching the level of Europe.  I will especially be glad to talk with representatives of large companies, such as MasterHost, REG.ru, 1GB.ru, Timeweb. <br><br><h3>  How we made friends with Veesp.com </h3><br>  A real discovery for us was the hoster <a href="https://veesp.com/">Veesp.com</a> with a data center in St. Petersburg.  This is the only hoster who knew how to properly prepare IPv6.  Network / 64 is allocated for each VPS server and / 56 upon request. <br><br>  They have two lines of VPS tariffs.  We use the <a href="https://veesp.com/ru/products/storage-vps">‚ÄúStorage 1‚Äù</a> tariff, with unlimited traffic.  The servers at this rate have an Intel Xeon X5650 processor.  There is also a line of tariffs <a href="https://veesp.com/ru/products/vps">"Compute"</a> , with an SSD drive, a powerful Intel Xeon E5v4 processor and DDR4 memory. <br><br> <a href="https://veesp.com/ru/products/vps"><img src="https://habrastorage.org/getpro/habr/post_images/115/1ba/30e/1151ba30e007b388baeeafb273c807b9.png" width="700" alt="Tariff line Compute VPS provider Veesp.com"><br></a>  <font color="99999">Tariff line Compute VPS provider Veesp.com</font> <br><br>  The control panel is comparable in convenience with DigitalOcean.  There is even a payment through Bitcoin! <br><br>  At the moment we have completely moved to the Veesp.com site and use six Storage 1 servers for OpenVPN.  Music in VK and Yandex works again, users are happy. <br><br><h2>  IPv6 </h2><br>  I really love IPv6.  It allows you to get rid of heaps of unnecessary entities, such as NAT and port forwarding.  For VPN, it is convenient because each client goes to the Internet with his real IP address.  Unfortunately, many hosting providers and system administrators resist and dislike this protocol, because of this, it is incorrectly configured and used. <br><br>  The most common mistake is to issue one IPv6 address per server. <br>  Site <a href="http://slash64.net/">slash64.net</a> dedicated to this misconception. <br><br><h3>  Why do I need to allocate a minimum of / 64 for each end node </h3><br><ul><li>  For simplicity.  According to <a href="https://tools.ietf.org/html/rfc6177">RFC 6177</a> , the / 64 network is the recommended block for all end nodes, be it home Internet or hosting.  This is 2‚Å∂‚Å¥, or eighteen quintillion IP addresses.  This approach will eliminate confusion and guessing how the network is configured on each individual node. <br><br></li><li>  Less memory consumption on routers.  It is enough for the network administrator to route to your one large subnet, and not a few smaller ones. <br><br></li><li>  Does not break the <a href="https://en.wikipedia.org/wiki/IPv6">SLAAC</a> auto configuration <a href="https://en.wikipedia.org/wiki/IPv6">protocol</a> .  If you suddenly want to make a full local area network (L2) over the Internet, IPv6 will work correctly in it. <br><br></li><li>  According to the logic of Email-providers, large sites like Google and Facebook, one client is one / 64 network.  Therefore, if the hoster gives different clients addresses from the same / 64 range, you can be blocked for actions that the neighbors in the range have committed. <br><br></li><li>  IPv6 addresses should not be sold by the piece.  This is nonsense, because the minimum recommended block / 64, which should be issued free of charge, will cost a quintillion of money, even if the price for one IP address is one ruble. </li></ul><br>  To give VPN clients IPv6 addresses directly without crutches, you need to have a separate routed network via the IPv6 address on the server, that is, the subnet from which you plan to distribute addresses to clients should not be assigned to the server interface, but should be routed through any address on the network interface of the server. <br><br>  There are two common distribution options for routable networks. <br><br>  The first option: one / 64 on the network interface, and / 56 routed through the first / 64.  You can beat / 56 as you want, or assign the entire / 56 to the VPN interface. <br><br>  The second option: one or several / 64 (or more) routed through a link-local-address. <br><br>  Most hosters have a dedicated network ordered separately.  <a href="https://veesp.com/">Veesp.com</a> issues a / 56 block to each server for free.  Unfortunately, even advanced hosters, like DigitalOcean, do not provide such a service.  Here is a list of hosters that provide this service <a href="https://version6.ru/vps">version 6.ru/vps</a> , from @rm. <br><br><h2>  NAT and Firewall </h2><br>  On servers, there are more than two hundred iptables rules, several for each range <a href="https://zaborona.help/ips.txt">from the list of prohibited networks in Ukraine</a> . <br><br>  It is inconvenient to maintain a complex set of rules using the standard <code>iptables-save</code> and <code>iptables-restore</code> tools, because if one rule is changed, it will be necessary to edit hundreds of lines of the same type. <br><br><h3>  Simplify writing firewall rules with ferm </h3><br>  <a href="http://ferm.foo-projects.org/">Ferm</a> is a utility for managing complex iptables rules with its syntactic sugar.  It allows you to create a readable iptables configuration, use variables, arrays and cycles, but does not limit you, unlike other add-ins over iptables: you can do absolutely everything, use all the features and modules of netfilter. <br><br>  A simple example: we want to block incoming connections from several thousand networks on three eth0, eth1, eth2 network interfaces.  Normally, you would have to write thousands of identical rules for each interface. <br><br>  Here is how this problem is solved through ferm: <br><br><pre> <code class="hljs perl">@def $WAN_0 = eth<span class="hljs-number"><span class="hljs-number">0</span></span>; @def $WAN_1 = eth1; @def $WAN_2 = eth2; @def $BLOCKED_NETWORKS = ( <span class="hljs-number"><span class="hljs-number">123.123</span></span>.<span class="hljs-number"><span class="hljs-number">123.123</span></span> <span class="hljs-number"><span class="hljs-number">234.234</span></span>.<span class="hljs-number"><span class="hljs-number">234.234</span></span> .... ); chain INPUT { saddr $BLOCKED_NETWORKS of ($WAN_0 $WAN_1 $WAN_2) DROP; }</code> </pre><br>  As a result, a rule will be created for each address from $ BLOCKED_NETWORKS to each network interface.  Such a record is easy to read and takes three times less lines.  Its easier to edit. <br><br>  In our case, iptables performs three functions: NAT for IPv4 connections, restricting access to other networks and load balancing between OpenVPN processes.  Let us examine each task in detail. <br><br><h4>  NAT for IPv4 connections </h4><br>  Clients are given a "gray" IP address from the range 192.168. *. *, So it cannot be routed directly to the Internet.  In order to release clients to IPv4 Internet, you must use <a href="https://ru.wikipedia.org/wiki/NAT">network address translation (NAT)</a> . <br><br>  Your home WiFi router does the same thing.  For each outgoing client connection, a translation is created in the server's memory, which stores information about who owns which connection.  Despite the fact that this operation requires few server resources, with a huge number of connections (tens of thousands), this can become a resource-intensive task for a weak server. <br><br>  This problem does not exist in IPv6, since each VPN client is given a real IP address that is directly routed to the Internet.  The server needs only to transfer packets from one interface to another, without creating translations and storing information about each connection. <br><br><h4>  Restricting access to other networks </h4><br>  Any user can add the <i>redirect-gateway</i> option to the OpenVPN config and use our servers as the default route.  It is necessary to close access to all networks except those blocked in Ukraine. <br><br><h4>  Load balancing between OpenVPN processes </h4><br>  The OpenVPN architecture is single-threaded, so one OpenVPN daemon process uses only one processor core.  For better utilization of all processor cores, the number of processes should be equal to the number of cores on the server.  Inter-process balancing is performed using the <b>statistic</b> module, which randomly redirects incoming connections to different internal ports. <br><br><h2>  Balancing between servers </h2><br>  We use the easiest balancing method ‚Äî using multiple A-DNS records.  All clients connect to the server through the domain name <b>vpn.zaborona.help</b> .  This domain has six A-records that are sent to all servers.  As a result, at the time of connection, the client selects a random server from the available ones.  So the total number of connections is evenly distributed between all servers.  The OpenVPN configuration on all servers is identical, except for the ranges of IPv6 addresses issued to clients. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/198/d7a/5ab/198d7a5abcfb4809235c1acbad6cb133.png" width="600" alt="image"><br>  <i><font color="99999">DNS control panel.</font></i>  <i><font color="99999">Balancing with multiple A-records.</font></i>  <i><font color="99999">A small TTL value allows you to quickly remove addresses from the general list.</font></i> <br><br>  You can quickly see which IP addresses the domain <a href="https://www.host-tracker.com/">resolves</a> from around the world using the <a href="https://www.host-tracker.com/">host-tracker.com</a> service by selecting any of the tests, such as http or ping. <br><br>  The result for the domain vpn.zaborona.help: <a href="https://www.host-tracker.com/InstantCheck/ResultComplete/ec0e5a90-ed56-e711-b124-0003ff7328cc">www.host-tracker.com/InstantCheck/ResultComplete/ec0e5a90-ed56-e711-b124-0003ff7328cc</a> <br><br><h2>  Recursive DNS resolvers </h2><br>  Many Ukrainian providers block DNS requests to forbidden domains, intercepting requests to third-party DNS servers, such as 8.8.8.8.  Therefore, it is important that customers send DNS requests through a VPN tunnel, where the provider cannot modify them. <br>  This is not so easy to do, because in new versions of Windows queries can go to all DNS servers in the system, and the one that responds faster will be used.  The provider's DNS server is physically closer to the client, so it‚Äôs likely that the system will get the provider‚Äôs spoofed response faster, rather than the correct DNS answer inside the VPN, and the site will remain blocked. <br><br>  To solve this problem, <a href="https://habrahabr.ru/users/valdikss/" class="user_link">ValdikSS</a> wrote a <a href="https://habrahabr.ru/post/268173/">patch for OpenVPN that blocks DNS leaks in Windows</a> .  It uses the Windows Filtering Platform, a special layer of the Windows firewall that allows blocking requests to third-party DNS while OpenVPN is running. <br><br><h2>  Server deployment </h2><br>  In the comments to the previous article I was blamed for the fact that some stages that seemed obvious to me were not described.  Here I will describe the complete set of commands for deploying the server fence. <br><br>  Configs are maximally unified and can be deployed without changes on the server.  This is convenient when using automatic deployment tools, such as Ansible. <br><br>  The only unique data for each server is the IPv6 subnet, which is signed in the OpenVPN configuration file. <br><br>  The servers use <b>Ubuntu 16.04 LTS</b> with kernel 4.4.0. <br><br><h4>  Package installation </h4><br>  The distribution repository contains an outdated version of OpenVPN 2.3, therefore we add the official project repositories with OpenVPN 2.4.  All other packages are set from the standard delivery. <br><br><pre> <code class="bash hljs">wget -O - https://swupdate.openvpn.net/repos/repo-public.gpg|apt-key add - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://build.openvpn.net/debian/openvpn/release/2.4 xenial main"</span></span> &gt; /etc/apt/sources.list.d/openvpn-aptrepo.list apt update apt upgrade apt install openvpn dnsmasq ferm</code> </pre><br><h4>  OpenVPN configuration </h4><br>  Since all servers are configured identically, we simply copy the configs along with the key files and certificates to the <b>/ etc / openvpn</b> folder.  No key / certificate generation is performed.  The number of processes OpenVPN configures by the number of cores on the server, in our case 2. Each individual process has its own config: zaborona1.conf and zaborona2.conf. <br><br>  To avoid confusion, I will call OpenVPN processes as demons, but essentially they are several separate servers running inside a single VPS. <br><br>  List of files in <code>/etc/openvpn</code> <br><br><pre> <code class="bash hljs">/etc/openvpn/zaborona1.conf <span class="hljs-comment"><span class="hljs-comment">#    /etc/openvpn/zaborona2.conf #    /etc/openvpn/ccd/DEFAULT #          /etc/openvpn/ccd2/DEFAULT #          /etc/openvpn/logs #    /etc/openvpn/ca.crt #   /etc/openvpn/zaborona.help.crt #   /etc/openvpn/zaborona.help.key #   /etc/openvpn/dh2048.pem #   Diffie-Hellman  (  )</span></span></code> </pre><br>  File Contents: <br><br><div class="spoiler">  <b class="spoiler_title">zaborona1.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">mode server <span class="hljs-comment"><span class="hljs-comment">#   ,   UDP ,   TCP       c,     UDP     keep-alive ,   NAT-    CGNAT. proto tcp #   L3,   ip .    L2 . dev-type tun #  tun-   dev zaborona1 #      /24,      /30. topology subnet #  "" ipv4-,  . server 192.168.224.0 255.255.252.0 #   ipv6-,  .    . server-ipv6 2a00:1838:32:200::/112 txqueuelen 250 keepalive 300 900 persist-tun persist-key cipher AES-128-CBC ncp-ciphers AES-128-GCM #user nobody duplicate-cn log logs/zaborona1.log status logs/status1.log 30 #      .         .       ,       . client-config-dir ccd ca ca.crt cert zaborona.help.crt key zaborona.help.key dh dh2048.pem</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">zaborona2.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">mode server port 1195 proto tcp dev-type tun dev zaborona2 topology subnet server 192.168.228.0 255.255.252.0 server-ipv6 2a00:1838:32:280::/112 txqueuelen 250 keepalive 300 900 persist-tun persist-key cipher AES-128-CBC ncp-ciphers AES-128-GCM <span class="hljs-comment"><span class="hljs-comment">#user nobody duplicate-cn log logs/zaborona2.log status logs/status2.log 30 client-config-dir ccd2 ca ca.crt cert zaborona.help.crt key zaborona.help.key dh dh2048.pem</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ccd / DEFAULT</b> <div class="spoiler_text"><pre> <code class="bash hljs">push <span class="hljs-string"><span class="hljs-string">"dhcp-option DNS 192.168.224.1"</span></span> push <span class="hljs-string"><span class="hljs-string">"dhcp-option DNS 74.82.42.42"</span></span> <span class="hljs-comment"><span class="hljs-comment"># HE.net DNS push "route 74.82.42.42" # Route to HE.net DNS push "route 77.88.8.8" # Route to Yandex DNS push "dhcp-option DNS6 2001:4860:4860::8888" # Google IPv6 dns push "route-ipv6 2001:4860:4860::8888" push "dhcp-option DNS6 2001:4860:4860::8844" # Google IPv6 dns push "route-ipv6 2001:4860:4860::8844" #Persist TUN push "persist-tun" # Routes # Yandex network push "route 5.45.192.0 255.255.192.0" push "route 5.255.192.0 255.255.192.0" push "route 37.9.64.0 255.255.192.0" push "route 37.140.128.0 255.255.192.0" push "route 77.75.152.0 255.255.248.0" push "route 77.88.0.0 255.255.192.0" push "route 84.201.128.0 255.255.192.0" push "route 87.250.224.0 255.255.224.0" push "route 93.158.128.0 255.255.192.0" push "route 95.108.128.0 255.255.128.0" push "route 100.43.64.0 255.255.224.0" push "route 109.235.160.0 255.255.248.0" push "route 130.193.32.0 255.255.224.0" push "route 141.8.128.0 255.255.192.0" push "route 178.154.128.0 255.255.128.0" push "route 185.32.185.0 255.255.255.0" push "route 185.32.186.0 255.255.255.0" push "route 185.71.76.0 255.255.252.0" push "route 199.21.96.0 255.255.252.0" push "route 199.36.240.0 255.255.252.0" push "route 213.180.192.0 255.255.224.0" push "route-ipv6 2001:678:384::/48" push "route-ipv6 2620:10f:d000::/44" push "route-ipv6 2a02:6b8::/32" push "route-ipv6 2a02:5180::/32" # Mail.ru network push "route 5.61.16.0 255.255.248.0" push "route 5.61.232.0 255.255.248.0" push "route 79.137.157.0 255.255.255.0" push "route 79.137.183.0 255.255.255.0" push "route 94.100.176.0 255.255.240.0" push "route 95.163.32.0 255.255.224.0" push "route 95.163.248.0 255.255.248.0" push "route 128.140.168.0 255.255.248.0" push "route 178.22.88.0 255.255.248.0" push "route 178.237.16.0 255.255.240.0" push "route 185.5.136.0 255.255.252.0" push "route 185.16.148.0 255.255.252.0" push "route 185.16.244.0 255.255.252.0" push "route 188.93.56.0 255.255.248.0" push "route 194.186.63.0 255.255.255.0" push "route 195.211.20.0 255.255.252.0" push "route 195.211.128.0 255.255.252.0" push "route 195.218.168.0 255.255.255.0" push "route 208.87.92.0 255.255.252.0" push "route 217.20.144.0 255.255.240.0" push "route 217.69.128.0 255.255.240.0" push "route 185.6.244.0 255.255.252.0" push "route 185.30.176.0 255.255.252.0" push "route 195.218.190.0 255.255.254.0" push "route-ipv6 2a00:1148::/32" push "route-ipv6 2a00:a300::/32" push "route-ipv6 2a00:b4c0::/32" push "route-ipv6 2a04:4b40::/29" # VK.com network push "route 87.240.128.0 255.255.192.0" push "route 93.186.224.0 255.255.240.0" push "route 95.142.192.0 255.255.240.0" push "route 95.213.0.0 255.255.192.0" push "route 185.29.130.0 255.255.255.0" push "route 185.32.248.0 255.255.252.0" # Kaspersky network push "route 77.74.176.0 255.255.252.0" push "route 77.74.181.0 255.255.255.0" push "route 77.74.183.0 255.255.255.0" push "route 93.159.228.0 255.255.252.0" push "route 185.54.220.0 255.255.254.0" push "route 185.85.12.0 255.255.255.0" push "route 185.85.14.0 255.255.254.0" push "route 77.74.176.0 255.255.248.0" push "route 91.103.64.0 255.255.248.0" push "route 93.159.224.0 255.255.248.0" push "route-ipv6 2a03:2480::/33" # DrWeb push "route 178.248.232.183 255.255.255.255" push "route 178.248.233.94 255.255.255.255" push "route 195.88.252.0 255.255.254.0"</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ccd2 / DEFAULT</b> <div class="spoiler_text"><pre> <code class="bash hljs">push <span class="hljs-string"><span class="hljs-string">"dhcp-option DNS 192.168.228.1"</span></span> push <span class="hljs-string"><span class="hljs-string">"dhcp-option DNS 74.82.42.42"</span></span> <span class="hljs-comment"><span class="hljs-comment"># HE.net DNS push "route 74.82.42.42" # Route to HE.net DNS push "route 77.88.8.8" # Route to Yandex DNS push "dhcp-option DNS6 2001:4860:4860::8888" # Google ipv6 dns push "route-ipv6 2001:4860:4860::8888" push "dhcp-option DNS6 2001:4860:4860::8844" # Google ipv6 dns push "route-ipv6 2001:4860:4860::8844" #Persist TUN push "persist-tun" # Routes # Yandex network push "route 5.45.192.0 255.255.192.0" push "route 5.255.192.0 255.255.192.0" push "route 37.9.64.0 255.255.192.0" push "route 37.140.128.0 255.255.192.0" push "route 77.75.152.0 255.255.248.0" push "route 77.88.0.0 255.255.192.0" push "route 84.201.128.0 255.255.192.0" push "route 87.250.224.0 255.255.224.0" push "route 93.158.128.0 255.255.192.0" push "route 95.108.128.0 255.255.128.0" push "route 100.43.64.0 255.255.224.0" push "route 109.235.160.0 255.255.248.0" push "route 130.193.32.0 255.255.224.0" push "route 141.8.128.0 255.255.192.0" push "route 178.154.128.0 255.255.128.0" push "route 185.32.185.0 255.255.255.0" push "route 185.32.186.0 255.255.255.0" push "route 185.71.76.0 255.255.252.0" push "route 199.21.96.0 255.255.252.0" push "route 199.36.240.0 255.255.252.0" push "route 213.180.192.0 255.255.224.0" push "route-ipv6 2001:678:384::/48" push "route-ipv6 2620:10f:d000::/44" push "route-ipv6 2a02:6b8::/32" push "route-ipv6 2a02:5180::/32" # Mail.ru network push "route 5.61.16.0 255.255.248.0" push "route 5.61.232.0 255.255.248.0" push "route 79.137.157.0 255.255.255.0" push "route 79.137.183.0 255.255.255.0" push "route 94.100.176.0 255.255.240.0" push "route 95.163.32.0 255.255.224.0" push "route 95.163.248.0 255.255.248.0" push "route 128.140.168.0 255.255.248.0" push "route 178.22.88.0 255.255.248.0" push "route 178.237.16.0 255.255.240.0" push "route 185.5.136.0 255.255.252.0" push "route 185.16.148.0 255.255.252.0" push "route 185.16.244.0 255.255.252.0" push "route 188.93.56.0 255.255.248.0" push "route 194.186.63.0 255.255.255.0" push "route 195.211.20.0 255.255.252.0" push "route 195.211.128.0 255.255.252.0" push "route 195.218.168.0 255.255.255.0" push "route 208.87.92.0 255.255.252.0" push "route 217.20.144.0 255.255.240.0" push "route 217.69.128.0 255.255.240.0" push "route 185.6.244.0 255.255.252.0" push "route 185.30.176.0 255.255.252.0" push "route 195.218.190.0 255.255.254.0" push "route-ipv6 2a00:1148::/32" push "route-ipv6 2a00:a300::/32" push "route-ipv6 2a00:b4c0::/32" push "route-ipv6 2a04:4b40::/29" # VK.com network push "route 87.240.128.0 255.255.192.0" push "route 93.186.224.0 255.255.240.0" push "route 95.142.192.0 255.255.240.0" push "route 95.213.0.0 255.255.192.0" push "route 185.29.130.0 255.255.255.0" push "route 185.32.248.0 255.255.252.0" # Kaspersky network push "route 77.74.176.0 255.255.252.0" push "route 77.74.181.0 255.255.255.0" push "route 77.74.183.0 255.255.255.0" push "route 93.159.228.0 255.255.252.0" push "route 185.54.220.0 255.255.254.0" push "route 185.85.12.0 255.255.255.0" push "route 185.85.14.0 255.255.254.0" push "route 77.74.176.0 255.255.248.0" push "route 91.103.64.0 255.255.248.0" push "route 93.159.224.0 255.255.248.0" push "route-ipv6 2a03:2480::/33" # DrWeb push "route 178.248.232.183 255.255.255.255" push "route 178.248.233.94 255.255.255.255" push "route 195.88.252.0 255.255.254.0"</span></span></code> </pre><br></div></div><br>  Configs of different daemons differ only in the port number for incoming connections and the range of IP addresses issued to clients. <br><br><h4>  Change settings on the fly using client-config-dir </h4><br>  At first, we constantly edited the list of blocked networks, because of this we had to restart the OpenVPN daemons every time the configs changed.  Because of this, the clients lost their connection to the server. <br><br>  The solution to this problem was the <b>client-config-dir</b> option.  It is used to assign individual settings to each user name.  Since we all connect on behalf of one <b>public</b> client, the file is one for all &lt; <i>b&gt; ccd / DEFAULT</i> .  The trick is that the file is re-read each time the client connects and does not require a server restart to apply the settings. <br><br>  As a result, we can edit the server settings without disconnecting clients.  and to get rid of the new settings, the user simply reconnects to the server.  Since users sooner or later in any case are connected, the new settings are eventually applied to all clients. <br><br><h4>  Ferm </h4><br>  The firewall settings are identical on all servers, so we copy the /etc/ferm/ferm.conf file without changes.  By default, after installation, the ferm package immediately activates the standard set of rules in which all connections are prohibited, except for SSH on port 22.  So if your SSH server is on a different port, be careful not to block yourself. <br><br><div class="spoiler">  <b class="spoiler_title">/etc/ferm/ferm.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  tun-   OpenVPN. zaborona1, zaborona2    zaborona+. @def $VPN = ( zaborona+ ); #  ,    @def $WAN_4 = eth0; @def $WAN_6 = eth0; #  "" ,   @def $VPN_ADDR_4 = ( 192.168.224.0/22 192.168.228.0/22 ); @def $ALLOW_SSH = (  ,      SSH ); @def $ALLOWED_NETWORKS_V4 = (  ipv4-,    ); @def $ALLOWED_NETWORKS_V6 = (  ipv6-,    ); table filter { chain ZABORONA_V4 { daddr $ALLOWED_NETWORKS_V4 ACCEPT; } chain FORWARD { policy DROP; mod conntrack ctstate INVALID DROP; if $WAN_4 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT; if $VPN of $WAN_4 jump ZABORONA_V4; } chain INPUT { saddr $ALLOW_SSH protocol tcp dport 22 ACCEPT; protocol tcp dport 22 REJECT reject-with icmp-port-unreachable; } } table nat { chain POSTROUTING { saddr $VPN_ADDR_4 of $WAN_4 MASQUERADE; } #    OpenVPN chain PREROUTING { interface $WAN_4 protocol tcp dport 1194 mod conntrack ctstate NEW mod statistic mode random probability 0.50000000000 REDIRECT to-ports 1195; } } # IPv6: domain ip6 { table filter { chain ZABORONA_V6 { daddr $ALLOWED_NETWORKS_V6 ACCEPT; } chain FORWARD { policy DROP; mod conntrack ctstate INVALID DROP; if $WAN_6 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT; if $VPN of $WAN_6 jump ZABORONA_V6; } } }</span></span></code> </pre><br></div></div><br>  For comparison, here‚Äôs what the same set of rules obtained through iptables-save looks like: <br><br><div class="spoiler">  <b class="spoiler_title">iptables-save</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Generated by iptables-save v1.6.0 on Fri Jun 23 19:44:10 2017 *filter :INPUT ACCEPT [54622:15244109] :FORWARD DROP [50:2520] :OUTPUT ACCEPT [59291:85277655] :ZABORONA_V4 - [0:0] -A INPUT -s 1.2.3.4/32 -p tcp -m tcp --dport 22 -j ACCEPT -A INPUT -p tcp -m tcp --dport 22 -j REJECT --reject-with icmp-port-unreachable -A FORWARD -m conntrack --ctstate INVALID -j DROP -A FORWARD -i eth0 -o zaborona+ -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT -A FORWARD -i zaborona+ -o eth0 -j ZABORONA_V4 -A ZABORONA_V4 -d 87.240.128.0/18 -j ACCEPT -A ZABORONA_V4 -d 93.186.224.0/20 -j ACCEPT -A ZABORONA_V4 -d 95.142.192.0/20 -j ACCEPT -A ZABORONA_V4 -d 95.213.0.0/18 -j ACCEPT -A ZABORONA_V4 -d 185.29.130.0/24 -j ACCEPT -A ZABORONA_V4 -d 185.32.248.0/22 -j ACCEPT -A ZABORONA_V4 -d 5.45.192.0/18 -j ACCEPT -A ZABORONA_V4 -d 5.255.192.0/18 -j ACCEPT -A ZABORONA_V4 -d 37.9.64.0/18 -j ACCEPT -A ZABORONA_V4 -d 37.140.128.0/18 -j ACCEPT -A ZABORONA_V4 -d 77.75.152.0/21 -j ACCEPT -A ZABORONA_V4 -d 77.88.0.0/18 -j ACCEPT -A ZABORONA_V4 -d 84.201.128.0/18 -j ACCEPT -A ZABORONA_V4 -d 87.250.224.0/19 -j ACCEPT -A ZABORONA_V4 -d 93.158.128.0/18 -j ACCEPT -A ZABORONA_V4 -d 95.108.128.0/17 -j ACCEPT -A ZABORONA_V4 -d 100.43.64.0/19 -j ACCEPT -A ZABORONA_V4 -d 109.235.160.0/21 -j ACCEPT -A ZABORONA_V4 -d 130.193.32.0/19 -j ACCEPT -A ZABORONA_V4 -d 141.8.128.0/18 -j ACCEPT -A ZABORONA_V4 -d 178.154.128.0/17 -j ACCEPT -A ZABORONA_V4 -d 185.32.185.0/24 -j ACCEPT -A ZABORONA_V4 -d 185.32.186.0/24 -j ACCEPT -A ZABORONA_V4 -d 185.71.76.0/22 -j ACCEPT -A ZABORONA_V4 -d 199.21.96.0/22 -j ACCEPT -A ZABORONA_V4 -d 199.36.240.0/22 -j ACCEPT -A ZABORONA_V4 -d 213.180.192.0/19 -j ACCEPT -A ZABORONA_V4 -d 5.61.16.0/21 -j ACCEPT -A ZABORONA_V4 -d 5.61.232.0/21 -j ACCEPT -A ZABORONA_V4 -d 79.137.157.0/24 -j ACCEPT -A ZABORONA_V4 -d 79.137.183.0/24 -j ACCEPT -A ZABORONA_V4 -d 94.100.176.0/20 -j ACCEPT -A ZABORONA_V4 -d 95.163.32.0/19 -j ACCEPT -A ZABORONA_V4 -d 95.163.248.0/21 -j ACCEPT -A ZABORONA_V4 -d 128.140.168.0/21 -j ACCEPT -A ZABORONA_V4 -d 178.22.88.0/21 -j ACCEPT -A ZABORONA_V4 -d 178.237.16.0/20 -j ACCEPT -A ZABORONA_V4 -d 185.5.136.0/22 -j ACCEPT -A ZABORONA_V4 -d 185.16.148.0/22 -j ACCEPT -A ZABORONA_V4 -d 185.16.244.0/22 -j ACCEPT -A ZABORONA_V4 -d 188.93.56.0/21 -j ACCEPT -A ZABORONA_V4 -d 194.186.63.0/24 -j ACCEPT -A ZABORONA_V4 -d 195.211.20.0/22 -j ACCEPT -A ZABORONA_V4 -d 195.218.168.0/24 -j ACCEPT -A ZABORONA_V4 -d 217.20.144.0/20 -j ACCEPT -A ZABORONA_V4 -d 217.69.128.0/20 -j ACCEPT -A ZABORONA_V4 -d 195.211.128.0/22 -j ACCEPT -A ZABORONA_V4 -d 208.87.92.0/22 -j ACCEPT -A ZABORONA_V4 -d 77.74.176.0/22 -j ACCEPT -A ZABORONA_V4 -d 77.74.181.0/24 -j ACCEPT -A ZABORONA_V4 -d 77.74.183.0/24 -j ACCEPT -A ZABORONA_V4 -d 93.159.228.0/22 -j ACCEPT -A ZABORONA_V4 -d 185.54.220.0/23 -j ACCEPT -A ZABORONA_V4 -d 185.85.12.0/24 -j ACCEPT -A ZABORONA_V4 -d 185.85.14.0/23 -j ACCEPT -A ZABORONA_V4 -d 77.74.176.0/21 -j ACCEPT -A ZABORONA_V4 -d 91.103.64.0/21 -j ACCEPT -A ZABORONA_V4 -d 93.159.224.0/21 -j ACCEPT -A ZABORONA_V4 -d 8.8.8.8/32 -j ACCEPT -A ZABORONA_V4 -d 8.8.4.4/32 -j ACCEPT -A ZABORONA_V4 -d 74.82.42.42/32 -j ACCEPT -A ZABORONA_V4 -d 77.75.152.0/21 -j ACCEPT -A ZABORONA_V4 -d 185.71.72.0/21 -j ACCEPT -A ZABORONA_V4 -d 185.6.244.0/22 -j ACCEPT -A ZABORONA_V4 -d 185.30.176.0/22 -j ACCEPT -A ZABORONA_V4 -d 195.218.190.0/23 -j ACCEPT -A ZABORONA_V4 -d 195.88.252.0/23 -j ACCEPT -A ZABORONA_V4 -d 178.248.232.183/32 -j ACCEPT -A ZABORONA_V4 -d 178.248.233.94/32 -j ACCEPT COMMIT # Completed on Fri Jun 23 19:44:10 2017 # Generated by iptables-save v1.6.0 on Fri Jun 23 19:44:10 2017 *nat :PREROUTING ACCEPT [917:61256] :INPUT ACCEPT [430:26400] :OUTPUT ACCEPT [122:8320] :POSTROUTING ACCEPT [122:8320] -A PREROUTING -i eth0 -p tcp -m tcp --dport 1194 -m conntrack --ctstate NEW -m statistic --mode random --probability 0.50000000000 -j REDIRECT --to-ports 1195 -A POSTROUTING -s 192.168.224.0/22 -o eth0 -j MASQUERADE -A POSTROUTING -s 192.168.228.0/22 -o eth0 -j MASQUERADE COMMIT # Completed on Fri Jun 23 19:44:10 2017</span></span></code> </pre><br></div></div><br>  Balancing between demons fulfills this rule: <br><br><pre> <code class="bash hljs">-A PREROUTING -i eth0 -p tcp -m tcp --dport 1194 -m conntrack --ctstate NEW -m statistic --mode random --probability 0.50000000000 -j REDIRECT --to-ports 1195</code> </pre><br>  With a 50% chance of connecting to port 1194, they are redirected to port 1195. So, connections are evenly distributed between two OpenVPN processes.  If there were more processes, it would be necessary to add additional rules to each process and change the probability of each rule to trigger. <br><br><h4>  Dnsmasq caching resolver </h4><br>  By default, dnsmasq accepts requests only from the local interface 127.0.0.1, so we resolve requests from VPN client addresses and set the size of the DNS cache. <br><br>  <b>/etc/dnsmasq.d/zaborona</b> <br><br><pre> <code class="bash hljs">listen-address=127.0.0.1,192.168.224.1,192.168.228.1 cache-size=1000</code> </pre><br><h4>  sysctl </h4><br>  The systctl.conf file with the kernel settings.  It includes forwarding IP packets and other options for optimizing the system for a VPN server. <br><br><div class="spoiler">  <b class="spoiler_title">/etc/sysctl.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ipv4  ipv6  net.ipv4.ip_forward=1 net.ipv6.conf.all.forwarding=1 net.netfilter.nf_conntrack_max=65535 net.netfilter.nf_conntrack_generic_timeout = 600 net.netfilter.nf_conntrack_icmp_timeout = 30 net.netfilter.nf_conntrack_tcp_timeout_close = 10 net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60 net.netfilter.nf_conntrack_tcp_timeout_established = 1800 net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120 net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30 net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300 net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60 net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120 net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120 net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300 net.netfilter.nf_conntrack_udp_timeout = 60 net.netfilter.nf_conntrack_udp_timeout_stream = 180 net.ipv4.tcp_slow_start_after_idle = 0 net.ipv4.tcp_fastopen = 3 net.ipv4.tcp_rmem = 4096 262143 4194304 net.core.rmem_max = 4194304 net.core.rmem_default = 262143 net.ipv4.tcp_wmem = 4096 262143 4194304 net.core.wmem_max = 4194304 net.core.wmem_default = 262143 net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_intvl = 90 net.ipv4.tcp_keepalive_probes = 5 net.ipv4.tcp_congestion_control=bbr net.ipv6.conf.default.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 net.ipv4.conf.default.send_redirects = 0 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.all.send_redirects = 0 net.ipv4.conf.all.accept_redirects = 0 net.ipv4.conf.all.secure_redirects = 0 net.ipv4.conf.default.secure_redirects = 0 net.ipv4.conf.all.rp_filter = 1 net.ipv4.conf.default.rp_filter = 1 net.ipv4.icmp_ignore_bogus_error_responses = 1 net.ipv4.conf.all.accept_source_route = 0 net.ipv4.conf.default.accept_source_route = 0 net.ipv6.conf.all.accept_source_route = 0 net.ipv6.conf.default.accept_source_route = 0 net.ipv6.conf.all.use_tempaddr = 2</span></span></code> </pre><br></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Start services </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After all services are configured, you can add their start to autoload. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preliminarily, we increase the limit on the number of open file descriptors for OpenVPN processes, otherwise, with a large number of clients, we will exceed them and get the error </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Too many open files</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> due to the large number of open sockets.</font></font><br><br><pre> <code class="bash hljs">systemctl edit openvpn@.service [Service] LimitNOFILE=8192</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,     . systemctl daemon-reload #         OpenVPN. systemctl enable --now openvpn@zaborona1 systemctl enable --now openvpn@zaborona2 #   dnsmasq  ferm.        . systemctl restart dnsmasq systemctl restart ferm</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To check the correctness of the settings, you can restart the server and make sure that all services are running. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Broken user OS </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A significant proportion of users turned out to be outdated, broken OS. </font><font style="vertical-align: inherit;">Very often, IPv6 support is broken in the system, for example, in many Windows 7 builds ‚Äúfrom Vasyan with rutracker,‚Äù where automatic system updates are disabled. </font><font style="vertical-align: inherit;">We started a </font></font><a href="https://github.com/zhovner/zaborona_help/wiki"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Github, to which users can add instructions on their own. </font><font style="vertical-align: inherit;">It describes solutions to some common problems. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here are the most typical cases of user environment curve:</font></font><br><br><h3>  Windows xp </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that support for this OC ended EIGHT years ago, it is still used. </font><font style="vertical-align: inherit;">It does not work a lot of modern programs, web browsers, as well as the latest version of OpenVPN 2.4. </font><font style="vertical-align: inherit;">This topic is devoted to a </font></font><a href="https://github.com/zhovner/zaborona_help/wiki/Windows-XP"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">separate article in our Wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windows 7 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many users have disabled automatic Windows updates. </font><font style="vertical-align: inherit;">For some reason, in such a configuration on Windows 7 IPv6 often breaks. </font><font style="vertical-align: inherit;">When connecting to the OpenVPN logs, this error appears:</font></font><br><br><pre> <code class="bash hljs"> NETSH: C:\WINDOWS\system32\netsh.exe interface ipv6 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> address interface=32 2a00:1838:30:7280::1149 store=active ERROR: netsh <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> failed: returned error code 1</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The cause of this anomaly could not be found out. </font><font style="vertical-align: inherit;">But Microsoft has a special utility for this case - </font></font><a href="https://support.microsoft.com/en-us/help/929852/how-to-disable-ipv6-or-its-components-in-windows"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPv6 Re-enabler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Download link below with the caption </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Re-enable IPv6 on nontunnel interfaces and on IPv6 tunnel interfaces"</font></font></i> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Android 4.4 and others </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each vendor breaks the VPN framework in Android in its own way. </font><font style="vertical-align: inherit;">Many Android builds have problems that cannot be explained, for example, they often complain that when a VPN is connected, DNS queries are executed for a few seconds. </font><font style="vertical-align: inherit;">In Android 4.4, the </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> completely </font><a href=""><font style="vertical-align: inherit;">broken</font></a><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microtik </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RouterOS has support for OpenVPN. </font><font style="vertical-align: inherit;">Unfortunately, it often does not work, than it works. </font><font style="vertical-align: inherit;">An article devoted to the </font></font><a href="https://github.com/zhovner/zaborona_help/wiki/Mikrotik"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">problem Mikrotik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We refused to break our servers to make them compatible with the Mikrotik bugs, and suggested that users write bug reports to Miktorik. </font><font style="vertical-align: inherit;">As a result, several fixes were released in the version of RouterOS 6.40rc24.</font></font><br><br><pre> <code class="hljs vhdl">What<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">6.40</span></span>rc24 (<span class="hljs-number"><span class="hljs-number">2017</span></span>-Jun-<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>): *) ovpn - added support <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> topology subnet <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> IP mode; *) ovpn - added support <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-string"><span class="hljs-string">"push-continuation"</span></span>; *) ovpn - fixed duplicate <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> gateway presence <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> receiving extra routes;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Although according to users, the problem has not been completely solved. </font><font style="vertical-align: inherit;">I advise all interested parties to continue sending bug reports to Mikrotik until the problem is completely resolved.</font></font></div><p>Source: <a href="https://habr.com/ru/post/331178/">https://habr.com/ru/post/331178/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331166/index.html">About Qt licenses (and a little about the company)</a></li>
<li><a href="../331168/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ267 (June 12 - 18, 2017)</a></li>
<li><a href="../331170/index.html">How to do static code analysis in Swift</a></li>
<li><a href="../331174/index.html">Fuzzy search by name</a></li>
<li><a href="../331176/index.html">Interactive credit card for payment input</a></li>
<li><a href="../331180/index.html">Cloud security: reality or myth?</a></li>
<li><a href="../331182/index.html">The first selection of materials on the digitalization of insurance</a></li>
<li><a href="../331184/index.html">Entertaining layout with viewing area units</a></li>
<li><a href="../331186/index.html">Artem Gavrichenkov's report on TLS scaling</a></li>
<li><a href="../331188/index.html">Our experience with Kubernetes in small projects (review and video report)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>