<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vulnerability in MACROSCOP (removed from version 1.9.72)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long been fond of information security, but one thing is an understanding of the surface logic of software operation, and a completely differen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vulnerability in MACROSCOP (removed from version 1.9.72)</h1><div class="post__text post__text-html js-mediator-article"> I have long been fond of information security, but one thing is an understanding of the surface logic of software operation, and a completely different thing is an understanding of the logic of its internal implementation.  Outwardly, any program can look great and harmonious, creating the illusion of complete security and security, but it‚Äôs worth going deeper, digging deeper, and on the surface are unpleasant facts that can lead to system hacking and, ultimately, to leakage or data loss, as well as temporary and financial losses.  The reason for the presence of vulnerabilities in the application can be as a banal inattention, a catastrophic lack of time, algorithmic or architectural complexity, ignorance of the features of the work or the implementation of third-party API, and self-serving intent.  It is often difficult to judge exactly what could have caused this or that vulnerability, but the more important point is the speed of the developers' reaction to its elimination. <br><br>  Today we will talk about the vulnerability that I discovered in the process of familiarizing myself with the software package for MAC-cameras MACROSCOP from the resident of the Skolkovo technopark of the company Satellite LLC (Perm).  MACROSCOP is a software package, as the solution includes a number of applications: the server and all-in-one parts for Microsoft Windows operating systems (the developers have recently abandoned the development of Linux solutions), the client part for Windows, Android, iOS and Windows Phone, configurator, Web camera connection program, native format file player, local archive viewer and backup program, system state monitoring program, various intelligent modules, as well as integration applications  with some third-party systems and wide possibilities for integration with any software through the SDK.  There are many advantages in MACROSCOP and, nevertheless, it is not without flaws, a separate article can be devoted to this: after all, developers do not always advertise the negative aspects of their product. <br><br><a name="habracut"></a>  The discovered vulnerability is in the use of a weak username and password for an undocumented superuser account, as well as the ability to make some requests to the server using this record.  When testing MACROSCOP, it became necessary to check how securely the accounts for the cameras and the program itself are stored, and my attention eventually attracted the configuration file ‚ÄúCurrent.CmnConf‚Äù.  As it turned out, the passwords to the cameras are stored in clear text, and the passwords for program accounts are in the form of md5 hash, and also, most likely, in a reversibly encrypted form.  When studying the configuration file, I came across the lines SuperUser and SuperPass, as well as two consecutive lines, remotely resembling a hash.  Attempting to use this pair for authorization using the client application and the configurator did not bring the proper result, but the thought did not leave me that it needed something and should work somewhere.  The user documentation did not contain a word about this account, so I decided to study the documentation on using the MACROSCOP SDK for developing external modules, where I also did not find any information, but I was interested in the description of using the HTTP interface to receive data streams from the program.  What was my surprise when I tried to check the use of this pair for the query of the form: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><a href="http://server/"></a> server:8080/video?channel=""&amp;login=superuser&amp;password=superpass</code> <br> <br>  Checking this request met my expectations: the browser offered to save the data on the specified link, and this is nothing more than a video stream in real time from the channel under the name "Street".  Next in order, I had a question about how to get the names of all the channels of the video system.  This question is answered by the developers themselves in their SDK, where in order to get the names of channels, their identifiers and settings in MACROSCOP, you need to run the following query: <br><br> <code><a href="http://server/"></a> server:8080/configex?login=superuser&amp;password=superpass</code> <br> <br>  The answer to the request comes in xml-format.  Based on this response, you can form a request for receiving video in real time from any channel.  At first glance, it seemed to me that there is nothing special in the fact that developers use an undocumented account for the internal purposes of the program, but I was tormented by vague doubts, and I decided not to stop there. <br><br>  I decided to figure out how this account is formed.  Since the MACROSCOP programs and libraries are mostly written under the .NET software platform, I had to use the .NET Reflector program to research them.  A keyword search did not take long to wait, and the code of interest was found in the Common.dll library in the implementation of the CommonConfig class: <br><br><pre> <code class="cs hljs">Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">21</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">21</span></span>]; random.NextBytes(buffer); random.NextBytes(buffer2); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SuperUser = SDKCommon.MD5Hash(Encoding.UTF8.GetString(buffer)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SuperPass = SDKCommon.MD5Hash(Encoding.UTF8.GetString(buffer2));</code> </pre><br>  In MACROSCOP, this code is used when applying the first configuration, then the superuser account is created, which is inaccessible from the program settings, has certain privileges and always remains the same.  From the code you can see that the instance of the Random class is being initialized, then getting two arrays of arbitrary data of a certain length, then getting the strings from them and eventually md5 hash.  It seems to be no dirty trick: the use of an arbitrary sequence of data and irreversible transformations, but there would be no vulnerability in this article, if it were not for the use of the Random class, in essence, the whole problem lies. <br><br>  The root cause of the vulnerability in MACROSCOP lies precisely in the use of the standard Random class of the .NET environment, which leads to the generation of an account that can be picked up in a reasonable time.  The fact is that this class for initializing an array of pseudo-random numbers uses a 32-time value obtained by calling the system function GetTickCount: the number of milliseconds that have elapsed since the computer was turned on.  Thus, based on this number, a pair of username and password is formed.  This pair can be detected by enumerating all possible values ‚Äã‚Äãof the time elapsed from the moment the computer was turned on until the first configuration was applied.  The problem is also aggravated by the fact that from the moment the computer is turned on until the first configuration is applied, in most cases very little time may pass.  For example, if the first configuration was applied an hour after the computer was turned on, then only 3.6 million combinations would need to be checked (1 h * 60 min * 60 s * 1000 ms).  Even if the computer was turned on for a very long time, then this will not make the brute force attack much more difficult, because  The class Random uses the value of a 32-bit signed number for initialization, then the number of input values ‚Äã‚Äãis ultimately limited to a 31-bit number.  Thus, the maximum number of combinations for enumeration is 2 ^ 31 (2147483648) values, which is about 25 days from the moment the computer is turned on until the first configuration is applied, after which the time begins from the beginning.  The search is carried out using the previously specified request for receiving channel names, their identifiers and settings.  Under ideal conditions (outgoing server channel speed of at least 50 Mbit / s, multi-core processor, low processor load), the search speed can reach about 5000 accounts per second.  So, if the first configuration was applied an hour after the computer was turned on, then the account search time would be no more than 12 minutes.  It is also possible to reduce the search time, taking into account the expected time of turning on the computer during working hours, for example, if the computer could be turned on during workdays and hours, then the search time can be reduced by 3.7 times. <br><br>  Selected account can be used in the future for certain purposes.  From what I found, this, as previously noted, is the ability to view video on all channels in real time, as well as the ability to apply any configuration to the server.  The latter possibility represents the greatest threat, since  full control of the server can be obtained.  In a simple view, a configuration change attack is implemented as follows: an attacker can prepare a configuration change request, in which, for example, a script will be executed for one of the cameras to provide remote access to the server.  This request will use the previously received account, as well as take into account such moments as the revision number, identifier and date of the configuration change.  After an intruder penetrates the server, a backdoor can be installed, the log files are changed, and the old configuration is restored from the backup. <br><br>  According to preliminary verification, the superuser account cannot be used, for example, to access the archive of channel records and the current configuration (although I may be mistaken), but with a high degree of probability it can be used for other purposes, which developers should be better known. <br><br>  The developers were notified about the vulnerability in MACROSCOP, and after 2 weeks (March 12, 2014) they closed it with the release of version 1.9.72 of the program.  Now the code for generating the built-in account is as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">21</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">21</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { RNGCryptoServiceProvider provider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RNGCryptoServiceProvider(); provider.GetBytes(data); provider.GetBytes(buffer2); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exception) { b1x.a(exception, <span class="hljs-string"><span class="hljs-string">"dsfimdfsmsdfdkfskfds"</span></span>); Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(Guid.NewGuid().GetHashCode()); random.NextBytes(data); random.NextBytes(buffer2); } Buffer.BlockCopy(Guid.NewGuid().ToByteArray(), <span class="hljs-number"><span class="hljs-number">0</span></span>, data, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); Buffer.BlockCopy(Guid.NewGuid().ToByteArray(), <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer2, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SuperUser = SDKCommon.MD5Hash(Encoding.UTF8.GetString(data)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SuperPass = SDKCommon.MD5Hash(Encoding.UTF8.GetString(buffer2));</code> </pre> <br>  The new version of the code uses a crypto-resistant class of random data generation mixed with Guid, which guarantees the practical impossibility of selecting an account, besides the developers have closed the possibility of using this account in the two previously mentioned requests to the server.  Nevertheless, this account is still used when applying the configuration, but the search speed in this case is much lower: the minimum request to the server is about 10 Kb, which is 10 times more traffic than the previously possible method, and only the risk of updating old users.  The fact is that for the existing configuration, the pair of hashes is not modified when installing a new version of the program, so this procedure remains to be done only independently.  Most importantly, if a multi-server configuration is used, then a couple of hashes and, accordingly, the configuration itself must be the same on all servers.  Otherwise there will be a conflict when applying the new configuration.  Thus, for new users of MACROSCOP, who are just beginning to use the program, from version 1.9.72 the vulnerability is not terrible, but for old users there is a small risk that can be eliminated as follows: <br><br>  - stop the MacroscopServer service or shut down the standalone version on the computer; <br>  - open the ‚ÄúCurrent.CmnConf‚Äù configuration file located in the program folder in the hex editor, (first make a backup copy of the file); <br>  - we find in the file the string ‚ÄúAlarus.Config.SystemEditions‚Äù, namely the second result of the entry; <br>  - Immediately just below the search result there will be two lines 32 characters long - this is the data of the built-in account; <br>  - we change the contents of strings to arbitrary values, taking into account the valid characters from the set ‚Äú0123456789ABCDEF‚Äù, without changing the length of the strings; <br>  - save the configuration; <br>  - run the service or standalone version of the program; <br>  - in the case of using a multi-server configuration, we perform the same actions, only as strings we use previously edited values ‚Äã‚Äãor simply replace the configuration with the corrected one. <br><br>  Summing up, I can‚Äôt help all developers not to repeat mistakes using the standard Random class, but to use crypto-resistant implementations of the random data generation algorithm, and also to respond promptly to potential threats in applications. </div><p>Source: <a href="https://habr.com/ru/post/218467/">https://habr.com/ru/post/218467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218457/index.html">Multiple Core Data</a></li>
<li><a href="../218459/index.html">Build Systems - Intro</a></li>
<li><a href="../218461/index.html">Free virtualization - practical applicability</a></li>
<li><a href="../218463/index.html">Game server for one day on Node.js + Socket.io</a></li>
<li><a href="../218465/index.html">Using ngShow and ngHide directives in AngularJS</a></li>
<li><a href="../218469/index.html">Diet for server processor</a></li>
<li><a href="../218471/index.html">Accelerate PHP development with overload</a></li>
<li><a href="../218473/index.html">Particles System in crowd modeling</a></li>
<li><a href="../218477/index.html">Watching IP-TV from Rostelecom on the computer</a></li>
<li><a href="../218481/index.html">Intl comes to us!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>