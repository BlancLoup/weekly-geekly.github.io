<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Very easy monitoring system with Telegram and Consul</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All happiness and good! 


 Evolutionarily it turned out that in my personal possession there was not a small zoo of various servers: from cheap Super...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Very easy monitoring system with Telegram and Consul</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/4a4/4d6/0d3/4a44d60d3fd54b29aab30a62e93fbfa7.png"></p><br><p>  All happiness and good! </p><br><p>  Evolutionarily it turned out that in my personal possession there was not a small zoo of various servers: from cheap Supermicro to top-end (at the time of release) HP Gen 8. Everything is of course connected by optics and other pleasures of life. </p><br><p>  But the tale is not about how to put the network, and not even about how to configure the server, but about how <del>  right </del>  just on all this, docker-compose services should be raised and rejoiced. </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">IMHO about the server</b> <div class="spoiler_text"><p>  HP - great guys, powerful and reliable stuffing, but only serve from the point of view of physics, well, it is not very convenient after supermicro. <br>  Supermicro - cheap, comfortable guys, but the functionality (ILO, firmware, Smart Array ...) is much less. </p></div></div><br><p>  It would seem that it could be simpler: he took, made docker-compose.yaml, a couple of Dockerfile, launched - profit.  But the demon is in the details .. </p><br><p>  The prelude about the server is given for a reason: what if there are ten or two virtual machines in each server, and hundreds of services out of ten compose files in each virtual machine?  In the appendage, we must not forget that part of the components simply exist as independent services. </p><br><p>  And everything seems to work.  But sometimes that marvelous wonderful moment comes when a consumer of one of the services comes up with a question of the type ‚Äúbut something I‚Äôve already had a week‚Äôs service is so little not alive‚Äù. <br>  And it seems like the client is loyal (the service is free for him), and it seems that the tragedy did not happen, but a strange sensation of an impending storm of unexpected people and calls to three nights appears. </p><br><p>  Since the most important skill of any programmer / devopser / admin is the ability to respond in time to signals from the softest part of the body just below the back, I began to take appropriate measures. </p><br><p>  But I would not be myself and not a mathematical engineer, if I had not tried to formulate the causes and possible solutions to the problem. </p><br><h2 id="dano">  Given </h2><br><ul><li>  Zoo of services running both in and without the docker </li><li>  The number of services will increase </li><li>  Some groups of services are completely isolated (usually in order to distinguish visibility / access) </li></ul><br><h2 id="zadacha">  Task </h2><br><ul><li><del>  Make it so that nothing falls. </del>  To rise itself in the fall </li><li>  Use solutions that are possible for a small number of services, and for large </li><li>  Know when and what fell.  Preferably no later than the client. </li><li>  Do not spend a lot of time setting </li></ul><br><h2 id="reshenie">  Decision </h2><br><p>  First, the temptation to start services with restart = always was marked by convulsive memories of loaded containers with zero delay at the start. <br>  Secondly, smoking docker-compose v3 showed that something like this is there, but on close inspection it works with a lot of conventions. <br>  Third, the use of Kubernetus and co., Looked like a shot from the SRZO Smerch in a mosquito at a distance of 100 meters. </p><br><p>  After a couple of strong mugs <del>  Roma </del>  coffee, the memory of Consul and the consul-template came to mind. </p><br><div class="spoiler">  <b class="spoiler_title">consul-template</b> <div class="spoiler_text"><p>  Initially, the consul-template was created as a configs generation based on the data in the Consul with auto update, but now it can be used as a certain analogue of the supervisord. </p></div></div><br><p>  The following chain was formed: </p><br><ul><li>  consul-template runs the application </li><li>  It is registered as a service in the Consul (Service Register), </li><li>  and I fasten monitoring on the same consul due to events and change monitoring </li></ul><br><p>  Rainbows, unicorns and butterflies ... Until I realized that the consul-template cannot register with Consul.  0_o <br>  <a href="https://github.com/hashicorp/consul-template/issues/952">link to the Issue</a> , which leads to the <a href="https://github.com/hashicorp/consul-template/issues/570">Issue 2016</a> </p><br><p>  However, the idea was still simple: </p><br><p><img src="https://habrastorage.org/web/d13/ae9/557/d13ae9557a964c2b83d4340a5df9cc99.png"></p><br><p>  Dear Microsoft founder, bequeathed us all to be lazy, but since who I am to argue with him, I went to look for alternative solutions. </p><br><p>  Suddenly it turned out that there was no easy solution.  Supervisord - pulls a python (I don‚Äôt have anything against it, but it's kind of a pity, especially considering the number of services).  Zabbix and others like him are good, but either heavy agents or a big delay. </p><br><p>  # izheprogrammer so for cooking.  The recipe is simple: let's take go (the final files are small and self-sufficient, and the cross-compilation is elementary), a handful of knowledge on unix-processes and a lot of tea. </p><br><p>  Chronology (D - day start): </p><br><ul><li>  D + 1 ready, working prototype </li><li>  D + 2 fixed all found bugs </li><li>  D + 3 given at the mercy of colleagues </li><li>  D + 4 errors found by colleagues </li><li>  D + 7 everything was rewritten <br>  ... </li></ul><br><h2 id="nashi-dni">  Our days </h2><br><p>  An ultra-lightweight supervisor was made with the ability to configure the number of restarts, the intervals between them, automatic (de) registration with Consul, notification with Telegram. <br>  Startup parameters can be saved to a configuration file.  The root part is rendered as a separate library, the ability to easily develop extensions has been added. </p><br><h3 id="primer">  Example </h3><br><p>  Suppose there is a service (let's call it / usr / local / bin / dummy) with a large number of flags to configure.  He can sometimes fall (he is not, life is =). </p><br><p>  We start it with registration in the local Consul agent: </p><br><pre><code class="hljs pgsql">monexec run <span class="hljs-comment"><span class="hljs-comment">--consul -- /usr/local/bin/dummy -a 1 -b 2 -c 3 --foo bar --foo baz --foo etc</span></span></code> </pre> <br><p>  Profit!  By default, monexec will restart it forever with an interval of 5 seconds. </p><br><p>  Next, we want to transfer this to administrators for future use.  Kilometer start line to send somehow not comme il faut. </p><br><p>  We generate the startup script (all the same, just add the <code>--generate</code> flag): </p><br><pre> <code class="hljs pgsql"> monexec run <span class="hljs-comment"><span class="hljs-comment">--generate --consul -- /usr/local/bin/dummy -a 1 -b 2 -c 3 --foo bar --foo baz --foo etc &gt; dummy.yml</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">dummy.yml</b> <div class="spoiler_text"><pre> <code class="hljs go">services: - label: stinger-desert command: /usr/local/bin/dummy args: - -a - <span class="hljs-string"><span class="hljs-string">"1"</span></span> - -b - <span class="hljs-string"><span class="hljs-string">"2"</span></span> - -c - <span class="hljs-string"><span class="hljs-string">"3"</span></span> - --foo - bar - --foo - baz - --foo - etc stop_timeout: <span class="hljs-number"><span class="hljs-number">5s</span></span> restart_delay: <span class="hljs-number"><span class="hljs-number">5s</span></span> restart: <span class="hljs-number"><span class="hljs-number">-1</span></span> consul: url: http:<span class="hljs-comment"><span class="hljs-comment">//localhost:8500 ttl: 3s timeout: 1m0s register: - stinger-desert</span></span></code> </pre> </div></div><br><p>  This will create a configuration file for us to use. <br>  Run it like this: </p><br><pre> <code class="hljs pgsql"> monexec <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/dir/<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>/dummy</code> </pre> <br><p>  <strong>Important!</strong>  <code>/path/to/dir/with/dummy</code> is the directory, not the path to the file.  (Inspired by Dockerfiles) </p><br><p>  Now add a happy life and a gram of madness: connect alerts in Telegram.  To do this, <a href="http://t.me/botfather">create a bot</a> and <a href="http://t.me/MyTelegramID_bot">find out your number.</a> </p><br><div class="spoiler">  <b class="spoiler_title">dummy with telegram</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">services: - label: stinger-desert command: /usr/local/bin/dummy args: - -a - "1" - -b - "2" - -c - "3" - --foo - bar - --foo - baz - --foo - etc stop_timeout: 5s restart_delay: 5s restart: -1 consul: url: http://localhost:8500 ttl: 3s timeout: 1m0s register: - stinger-desert telegram: token: "123456789:AAAAAAAAAAAAAAAAAAAAAA_BBBBBBBBBBBB" services: - "stinger-desert" recipients: - 123456789 template: | *</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.label}}</span></span><span class="xml"><span class="xml">* Service </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.label}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.action}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{if .error}}</span></span><span class="xml"><span class="xml">Ô∏è *Error:* </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.error}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{end}}</span></span><span class="xml"><span class="xml"> _time: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.time}}</span></span><span class="xml"><span class="xml">_ _host: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.hostname}}</span></span><span class="xml"><span class="xml">_</span></span></code> </pre> </div></div><br><h1 id="itog">  Total </h1><br><p>  As one person said, the creation of something new consists of three stages: </p><br><ol><li>  Idea </li><li>  Implementation </li><li>  Publication </li></ol><br><p>  Good or bad idea and implementation (it's up to you) - all this has no value if others cannot use it. </p><br><p>  I tried to create a documented <a href="https://github.com/reddec/monexec">source code</a> , a <a href="https://reddec.github.io/monexec/">guide to using</a> and compiling <a href="https://github.com/reddec/monexec/releases">binary files for most platforms.</a> </p><br><p>  Good luck to all! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335166/">https://habr.com/ru/post/335166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335156/index.html">The digital economy should be digital</a></li>
<li><a href="../335158/index.html">Comparing REST and GraphQL</a></li>
<li><a href="../335160/index.html">Programming ‚â† computer science</a></li>
<li><a href="../335162/index.html">Polymorphism and function pointers</a></li>
<li><a href="../335164/index.html">How to program a satellite photo? Problem solving Dstl Satellite Imagery Feature Detection</a></li>
<li><a href="../335168/index.html">How to set up backup to S3-compatible cloud from Commvault</a></li>
<li><a href="../335170/index.html">How we look for (and why we find) cool developers. HR experience and tips for job seekers</a></li>
<li><a href="../335172/index.html">Attack of the clones. How to deal with code duplication?</a></li>
<li><a href="../335174/index.html">Smart stores, omni-channel analytics and endless loyalty: 6 retail trends in 2017</a></li>
<li><a href="../335176/index.html">Use PowerShell for IT security. Part I: Event Tracking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>