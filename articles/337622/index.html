<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32 without HAL and SPL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At one time, more than 5 years old, when searching for information about 32-bit microcontrollers, I noticed that almost all examples for STM32 implied...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32 without HAL and SPL</h1><div class="post__text post__text-html js-mediator-article">  At one time, more than 5 years old, when searching for information about 32-bit microcontrollers, I noticed that almost all examples for STM32 implied the use of SPL (Standard Peripherals Library).  Quote from wikipedia: <br><blockquote>  STM32F10x Standard Peripherals Library (abbr. STM32F10x SPL) is a library created by STMicroelectronics in C language for its microcontrollers of the STM32F10x family.  Contains functions, structures and macros to facilitate the work with the periphery of the microcontroller. " </blockquote><br>  Currently, it is proposed to use STM32CUBE to reduce the entry threshold and speed up development.  Quote from STM website: <blockquote>  STM32Cube embedded software libraries, including: <br><br>  HAL hardware abstraction layer, enabling portability between different STM32 devices via standardized API calls. <br>  The Low-Layer (LL) APIs are a light-weight, optimized, expert-oriented set of APIs. <br>  A collection of middleware components, like a RTOS, USB library, a file system, a TCP / IP stack, a touch sensing library or a Graphic Library (for MCU series) </blockquote><br>  In my opinion, for most projects, external libraries are not needed and it is easier to use access to the registers of the microcontroller using standard documentation. <br><a name="habracut"></a><br>  There is an opinion that the use of microcontroller registers is a more complicated way than using wrappers from external libraries.  I will try to show that this is not always the case. <br>  Examples of register initialization with comments. <br><br><h3>  Initialization of the periphery. </h3><br><h4>  Ports </h4>  . <br>  For many projects, you simply need to turn the corresponding controller legs on or off and read the analog values. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Enable port: 1 line of code: <br><br><pre><code class="hljs markdown">//  A<span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> RCC-&gt;AHB1ENR |= RCC<span class="hljs-emphasis"><span class="hljs-emphasis">_AHB1ENR_</span></span>GPIOAEN;</code> </pre> <br>  Translation of 0 pin of port A to analog mode 2 lines: <br><br><pre> <code class="hljs erlang-repl"> //PA0 - PA0/ADC1_ADC2_ADC3_IN0 // GPIO_Pin_0  A   GPIOA-&gt;MODER |= GPIO_MODER_MODER0_0; GPIOA-&gt;MODER |= GPIO_MODER_MODER0_1;</code> </pre><br>  Translation of 2 pins of port A to exit mode (push-pull) 1 line: <br><br><pre> <code class="hljs erlang-repl">GPIOA-&gt;MODER |= GPIO_MODER_MODER2_0;</code> </pre><br>  Using alternative functions is also not very difficult.  Often a microcontroller is used to control a half-bridge converter.  To do this, configure the appropriate port pins as complementary PWM outputs. <br><br>  Definition of output 8 of port A, as PWM output CH1 of the counter TIM1 (3 lines): <br><br><pre> <code class="hljs ruby"> /<span class="hljs-regexp"><span class="hljs-regexp">/PA8/</span></span>TIM1_CH1 /<span class="hljs-regexp"><span class="hljs-regexp">/ Alternate function mode GPIOA-&gt;MODER &amp;= ~GPIO_MODER_MODER8_0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 GPIOA-&gt;MODER |= GPIO_MODER_MODER8_1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/GPIO alternate function high register (GPIOx_AFRL) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/AFR8[3:0] = 0001: AF1 GPIOA -&gt; AFR[1] |= 0x00000001;</span></span></code> </pre> <br>  Definition of output 13 of port B as PWM output CH1N of the counter TIM1: <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/PB13/</span></span>TIM1_CH1N /<span class="hljs-regexp"><span class="hljs-regexp">/ Alternate function mode GPIOB-&gt;MODER &amp;= ~GPIO_MODER_MODER13_0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 GPIOB-&gt;MODER |= GPIO_MODER_MODER13_1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/GPIO alternate function high register (GPIOx_AFRL) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/AFR13[3:0] = 0001: AF1 GPIOB -&gt; AFR[1] |= 0x00100000;</span></span></code> </pre><br>  A logical question: where to get the designation of the necessary registers and bits?  Answer: in 3 documents (for example 746). <br><br>  1. Reference manual STM32F7.pdf <br>  2. STM32F745xx.pdf <br>  3. stm32f746xx.h <br><br>  These 3 files are completely enough to correctly access all registers of the microcontroller. <br><br><h4>  ADC </h4><br>  An example of the initialization of the ADC to work in DMA mode.  In this mode, the 4 ACP2 channels are automatically switched in a circle and transmit data to the DMA controller, which adds the data to an array. <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> init_ADC1(<span class="hljs-type"><span class="hljs-type">void</span></span>) { RCC-&gt;APB2ENR |= RCC_APB2ENR_ADC1EN; //   ADC1-&gt;CR2 |= ADC_CR2_ADON; //  ADC1-&gt;CR1 |= ADC_CR1_EOCIE; ADC1-&gt;CR1 |= ADC_CR1_SCAN; // <span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> SCAN: Scan mode ADC1-&gt;CR2 |= ADC_CR2_EOCS; //<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> EOCS: <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conversion</span></span> selection ADC1-&gt;CR2 |= ADC_CR2_DMA; //<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> DMA: Direct memory <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> mode (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> single ADC mode) ADC1-&gt;CR2 |= ADC_CR2_DDS; //<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> DDS: DMA <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> selection (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> single ADC mode //Bits <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> L[<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]: Regular channel <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> length (<span class="hljs-number"><span class="hljs-number">4</span></span>) //<span class="hljs-number"><span class="hljs-number">0003</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conversion</span></span> ADC1-&gt;SQR1 |= ADC_SQR1_L_0; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR1 |= ADC_SQR1_L_1; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR1 &amp;= ~ADC_SQR1_L_2; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR1 &amp;= ~ADC_SQR1_L_3; //<span class="hljs-number"><span class="hljs-number">0</span></span> //Bits <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> SQ1[<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]: <span class="hljs-number"><span class="hljs-number">1</span></span>st <span class="hljs-keyword"><span class="hljs-keyword">conversion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> regular <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> PC0/ADC1_ADC2_ADC3_IN10 ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ1_0; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ1_1; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ1_2; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ1_3; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ1_4; //<span class="hljs-number"><span class="hljs-number">0</span></span> //Bits <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> SQ2[<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]: <span class="hljs-number"><span class="hljs-number">2</span></span>st <span class="hljs-keyword"><span class="hljs-keyword">conversion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> regular <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> PC1/ADC1_ADC2_ADC3_IN11 ADC1-&gt;SQR3 |= ADC_SQR3_SQ2_0; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ2_1; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ2_2; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ2_3; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ2_4; //<span class="hljs-number"><span class="hljs-number">0</span></span> //Bits <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> SQ3[<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]: <span class="hljs-number"><span class="hljs-number">3</span></span>st <span class="hljs-keyword"><span class="hljs-keyword">conversion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> regular <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> PC2/ADC1_ADC2_ADC3_IN12 ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ3_0; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ3_1; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ3_2; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ3_3; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ3_4; //<span class="hljs-number"><span class="hljs-number">0</span></span> //Bits <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> SQ4[<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]: <span class="hljs-number"><span class="hljs-number">4</span></span>st <span class="hljs-keyword"><span class="hljs-keyword">conversion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> regular <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> PC3/ADC1_ADC2_ADC3_IN13 ADC1-&gt;SQR3 |= ADC_SQR3_SQ4_0; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ4_1; //<span class="hljs-number"><span class="hljs-number">0</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ4_2; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 |= ADC_SQR3_SQ4_3; //<span class="hljs-number"><span class="hljs-number">1</span></span> ADC1-&gt;SQR3 &amp;= ~ADC_SQR3_SQ4_4; //<span class="hljs-number"><span class="hljs-number">0</span></span> NVIC_EnableIRQ (ADC_IRQn); }</code> </pre> <br><h4>  RAP </h4><br>  Initialization of a single flow PDU for transferring data from the ADC to the array (see above) <br><br><pre> <code class="hljs ruby"> /<span class="hljs-regexp"><span class="hljs-regexp">/ DMA2 RCC-&gt;AHB1ENR |= RCC_AHB1ENR_DMA2EN; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Stream3 Channel 1 DMA2 -   ADC2_array 2 a /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 27:25 CHSEL[2:0]: Channel selection (1) DMA2_Stream3-&gt;CR |= DMA_SxCR_CHSEL_0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1 DMA2_Stream3-&gt;CR &amp;= ~DMA_SxCR_CHSEL_1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 DMA2_Stream3-&gt;CR &amp;= ~DMA_SxCR_CHSEL_2; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 14:13 MSIZE[1:0]: Memory data size (16 bit) DMA2_Stream3-&gt;CR |= DMA_SxCR_MSIZE_0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1 DMA2_Stream3-&gt;CR &amp;= ~DMA_SxCR_MSIZE_1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 12:11 PSIZE[1:0]: Peripheral data size (16 bit) DMA2_Stream3-&gt;CR |= DMA_SxCR_PSIZE_0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1 DMA2_Stream3-&gt;CR &amp;= ~DMA_SxCR_PSIZE_1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 10 MINC: Memory increment mode DMA2_Stream3-&gt;CR |= DMA_SxCR_MINC; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 7:6 DIR[1:0]: Data transfer direction (00: Peripheral-to-memory) DMA2_Stream3-&gt;CR &amp;= ~DMA_SxCR_DIR_0; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 DMA2_Stream3-&gt;CR &amp;= ~DMA_SxCR_DIR_1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 4 TCIE: Transfer complete interrupt enable DMA2_Stream3-&gt;CR |= DMA_SxCR_TCIE; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 15:0 NDT[15:0]: Number of data items to transfer /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1000 point x 4 channel DMA2_Stream3-&gt; NDTR = 4000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 31:0 PAR[31:0]: Peripheral address DMA2_Stream3-&gt;PAR = (uint32_t) &amp;(ADC2-&gt;DR); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 31:0 M0A[31:0]: Memory 0 address DMA2_Stream3-&gt;M0AR = (uint32_t) ADC2_array; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/Bits 0 EN: Stream enable /</span></span> flag stream ready <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> read low DMA2_Stream3-&gt;CR <span class="hljs-params"><span class="hljs-params">|= DMA_SxCR_EN; NVIC_EnableIRQ (DMA2_Stream0_IRQn);</span></span></code> </pre> <br><h4>  Timers </h4><br>  Timer configuration example with complementary 12-bit PWM outputs for controlling 3 half bridges (3-phase inverter) <br><br><pre> <code class="hljs erlang-repl"> // TIM1 PWM RCC -&gt; APB2ENR |= RCC_APB2ENR_TIM1EN; // TIM1 TIM1-&gt;CR1 |= TIM_CR1_CMS_0; //Center-aligned mode <span class="hljs-number"><span class="hljs-number">1</span></span> TIM1-&gt;CR1 |= TIM_CR1_ARPE; //  // <span class="hljs-number"><span class="hljs-number">8</span></span>   <span class="hljs-number"><span class="hljs-number">4000</span></span> - <span class="hljs-number"><span class="hljs-number">3000</span></span>  //  <span class="hljs-number"><span class="hljs-number">108</span></span>  TIM1-&gt;PSC = <span class="hljs-number"><span class="hljs-number">8</span></span>; TIM1-&gt;ARR = <span class="hljs-number"><span class="hljs-number">4000</span></span>; TIM1-&gt;CCR1 = <span class="hljs-number"><span class="hljs-number">1000</span></span>; //  TIM1-&gt;CCR2 = <span class="hljs-number"><span class="hljs-number">1000</span></span>; TIM1-&gt;CCR3 = <span class="hljs-number"><span class="hljs-number">1000</span></span>; TIM1-&gt;CCMR1 &amp;= ~TIM_CCMR1_OC1M_0; TIM1-&gt;CCMR1 |= TIM_CCMR1_OC1M_1; TIM1-&gt;CCMR1 |= TIM_CCMR1_OC1M_2; //<span class="hljs-number"><span class="hljs-number">110</span></span>: PWM mode <span class="hljs-number"><span class="hljs-number">1</span></span> TIM1-&gt;CCMR1 &amp;= ~TIM_CCMR1_OC2M_0; TIM1-&gt;CCMR1 |= TIM_CCMR1_OC2M_1; TIM1-&gt;CCMR1 |= TIM_CCMR1_OC2M_2; //<span class="hljs-number"><span class="hljs-number">110</span></span>: PWM mode <span class="hljs-number"><span class="hljs-number">1</span></span> TIM1-&gt;CCMR2 &amp;= ~TIM_CCMR2_OC3M_0; TIM1-&gt;CCMR2 |= TIM_CCMR2_OC3M_1; TIM1-&gt;CCMR2 |= TIM_CCMR2_OC3M_2; //<span class="hljs-number"><span class="hljs-number">110</span></span>: PWM mode <span class="hljs-number"><span class="hljs-number">1</span></span> TIM1-&gt;CCER |= TIM_CCER_CC1E; // Capture/Compare <span class="hljs-number"><span class="hljs-number">1</span></span> output enable TIM1-&gt;CCER |= TIM_CCER_CC1NE; // Capture/Compare <span class="hljs-number"><span class="hljs-number">1</span></span> complementary output enable TIM1-&gt;CCER |= TIM_CCER_CC2E; // Capture/Compare <span class="hljs-number"><span class="hljs-number">2</span></span> output enable TIM1-&gt;CCER |= TIM_CCER_CC2NE; // Capture/Compare <span class="hljs-number"><span class="hljs-number">2</span></span> complementary output enable TIM1-&gt;CCER |= TIM_CCER_CC3E; // Capture/Compare <span class="hljs-number"><span class="hljs-number">3</span></span> output enable TIM1-&gt;CCER |= TIM_CCER_CC3NE; // Capture/Compare <span class="hljs-number"><span class="hljs-number">3</span></span> complementary output enable //DTG[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]: Dead-time generator setup <span class="hljs-number"><span class="hljs-number">1</span></span> mks TIM1-&gt;BDTR |= TIM_BDTR_DTG_0; TIM1-&gt;BDTR |= TIM_BDTR_DTG_1; TIM1-&gt;BDTR |= TIM_BDTR_DTG_2; TIM1-&gt;BDTR |= TIM_BDTR_DTG_3; TIM1-&gt;BDTR |= TIM_BDTR_DTG_4; TIM1-&gt;BDTR |= TIM_BDTR_DTG_5; TIM1-&gt;BDTR |= TIM_BDTR_DTG_6; TIM1-&gt;BDTR |= TIM_BDTR_DTG_7; TIM1-&gt;DIER |= TIM_DIER_CC1IE; //Capture/Compare <span class="hljs-number"><span class="hljs-number">1</span></span> interrupt enable //TIM1-&gt;DIER |= TIM_DIER_CC2IE; //Capture/Compare <span class="hljs-number"><span class="hljs-number">2</span></span> interrupt enable //TIM1-&gt;DIER |= TIM_DIER_CC3IE; //Capture/Compare <span class="hljs-number"><span class="hljs-number">3</span></span> interrupt enable TIM1-&gt;CR1 |= TIM_CR1_CEN; //Bit <span class="hljs-number"><span class="hljs-number">0</span></span> CEN: Counter enable TIM1-&gt;BDTR |= TIM_BDTR_MOE; //MOE: Main output enable NVIC_EnableIRQ (TIM1_CC_IRQn); //   </code> </pre><br>  An example of a timer configuration for the formation of time interrupts.  Interrupts from this timer are usually used to update data on interfaces.  In this mode, the external timer outputs are not used. <br><br><pre> <code class="hljs pgsql"> // TIM3 <span class="hljs-number"><span class="hljs-number">100</span></span>  RCC -&gt; APB1ENR |= RCC_APB1ENR_TIM3EN; //TIM3 Timer clock <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> TIM3-&gt;CR1 |= TIM_CR1_CEN; //<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> CEN: Counter <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> TIM3-&gt;CR1 |= TIM_CR1_ARPE; //<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> ARPE: Auto-reload preload <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> TIM3-&gt;DIER |= TIM_DIER_UIE; //<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> UIE: <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> interrupt <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> TIM3-&gt;PSC = <span class="hljs-number"><span class="hljs-number">2000</span></span>; TIM3-&gt;ARR = <span class="hljs-number"><span class="hljs-number">5400</span></span>; NVIC_EnableIRQ (TIM3_IRQn); //   </code> </pre><br>  These configuration files are used almost without change for a long time.  It all started on the 103 controller, now used on the 7 series :) <br><br>  Of course, the initialization of the ADC, timers and PDP is a bit more complicated than the ports, but also a simple task. <br>  It does not use external libraries, more compact code, more predictable controller behavior. </div><p>Source: <a href="https://habr.com/ru/post/337622/">https://habr.com/ru/post/337622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337610/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ279 (September 4 - 10, 2017)</a></li>
<li><a href="../337614/index.html">Workplace control: a new ruling by the European Court</a></li>
<li><a href="../337616/index.html">PHP Digest number 116 - the latest news, materials and tools (August 27 - September 10, 2017)</a></li>
<li><a href="../337618/index.html">Using D-Bus system functions in Sailfish OS</a></li>
<li><a href="../337620/index.html">How, or rather, where we will work in 10 years</a></li>
<li><a href="../337624/index.html">"Man" of art: is artificial intelligence capable of creating?</a></li>
<li><a href="../337626/index.html">DevOps with Kubernetes and VSTS. Part 1: Local History</a></li>
<li><a href="../337628/index.html">Pygest # 17. Releases, articles, interesting projects from the world of Python [August 29, 2017 - September 11, 2017]</a></li>
<li><a href="../337630/index.html">AMD is preparing to press Intel in the market of server solutions</a></li>
<li><a href="../337632/index.html">PostgreSQL: materialized views and FDW</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>