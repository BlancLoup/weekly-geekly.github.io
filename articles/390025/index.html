<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AMS and magic crystal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This time I propose to do some magic (why not?) And create a magic crystal for our everyday needs. We will use it for its intended purpose - to prophe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AMS and magic crystal</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fe4/fd8/4a5/fe4fd84a55f54950bcbe661fdc78859f.jpg" alt="image"><br><br>  This time I propose to do some magic (why not?) And create a magic crystal for our everyday needs.  We will use it for its intended purpose - to prophesy various non-obvious entities and events.  And we need only two ingredients to make this artifact - the <a href="http://hi-lab.ru/arduino-mega-server">Arduino Mega Server</a> and the <a href="http://www.noo.com.by/silovoj-blok-SD111-180.html">nooLite SD111-180</a> wireless LED tape <a href="http://www.noo.com.by/silovoj-blok-SD111-180.html">controller</a> . <br><br>  A crystal will not be decorative (to deceive a gullible public), but a functional one, with many magical properties. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So let's get started ... <br><a name="habracut"></a><br><h2>  School of Magic </h2><br>  As you understand, you cannot just take and perform some kind of miracle, you must first go through the school of magic and master the basics of this complex art.  And here I refer you to a series of articles ( <a href="http://geektimes.ru/post/269100/">one</a> , <a href="http://geektimes.ru/post/269366/">two</a> , <a href="http://geektimes.ru/post/269450/">three</a> ) about the integration of nooLite equipment into home automation systems and recommend reading them before further reading.  These articles detail all the basics and technical details of how the Arduino Mega Server works with nooLite wireless equipment.  Therefore, all further narrative I will lead assuming that you have already read the previous articles. <br><br><h2>  Module </h2><br>  We will carry out all the experiments with the nooLite SD111-180 wireless controller, which allows you to control the LED strips "over the air" without any wires.  The connection, as always with nooLite, is the simplest - two wires to the power supply for LED strips and four to the tape itself: the plus and three channels R, G, B. <br><br><img src="https://habrastorage.org/files/27e/785/b98/27e785b980cb439eb143b77617a439f8.jpg" alt="image"><br><br><h2>  Software part </h2><br>  The previous articles talked about the nooLite control kernel integrated into the Arduino Mega Server system.  And there it was also mentioned that the core implements a basic set of functions for controlling nooLite devices and was suggested for everyone, by analogy, to add other necessary functions to the core.  Now we will facilitate this task and add functions to the core for wireless control of LED strips. <br><br>  First of all, we add the ‚Äúmain‚Äù function, which generates control commands for the <a href="http://www.noo.com.by/modul_mt1132.html">nooLite MT1132</a> module. <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooSendCommandLed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> channel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> r, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> g, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> format)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> buf[<span class="hljs-number"><span class="hljs-number">12</span></span>]; ledLastState[<span class="hljs-number"><span class="hljs-number">0</span></span>] = r; ledLastState[<span class="hljs-number"><span class="hljs-number">1</span></span>] = g; ledLastState[<span class="hljs-number"><span class="hljs-number">2</span></span>] = b; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">12</span></span>; i++) { buf[i] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">85</span></span>; buf[<span class="hljs-number"><span class="hljs-number">1</span></span>] = B01010000; buf[<span class="hljs-number"><span class="hljs-number">2</span></span>] = command; buf[<span class="hljs-number"><span class="hljs-number">3</span></span>] = format; buf[<span class="hljs-number"><span class="hljs-number">5</span></span>] = channel; buf[<span class="hljs-number"><span class="hljs-number">6</span></span>] = r; buf[<span class="hljs-number"><span class="hljs-number">7</span></span>] = g; buf[<span class="hljs-number"><span class="hljs-number">8</span></span>] = b; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> checkSum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { checkSum += buf[i]; } buf[<span class="hljs-number"><span class="hljs-number">10</span></span>] = lowByte(checkSum); buf[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">170</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (<span class="hljs-number"><span class="hljs-number">12</span></span>); i++) { Serial1.write(buf[i]); } }</code> </pre> <br>  This is the sister of the nooSendCommand function, which we discussed in the first article.  It is only slightly modified for the specific management needs of LED strips.  Added installation of 6, 7, 8 bytes of the control command, which contain the brightness of the three channels R, G, B. And the array is added <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ledLastState[] = {<span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>};</code> </pre><br>  containing the last set color value of the LED strip.  This is necessary in order to be able to turn on and off the light while maintaining the set color value.  If this is not done, then after turning it off and then on, the color will be reset to white, which is not very convenient. <br><br>  And to work with the LED strip, select the third channel <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NOO_CHANNEL_3 = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br>  One could choose any of the other 32 channels with which the nooLite MT1132 module works. <br><br>  Now we have a basic function that controls the operation of the nooLite SD111-180 LED tape controller, and, accordingly, the LED strip itself.  And now we can start writing wrapper functions that will make it easier for us to write code to control the color of the glow of the tape. <br><br>  Base wrapper <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooLed</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> r, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> g, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, r, g, b, <span class="hljs-number"><span class="hljs-number">3</span></span>); }</code> </pre><br>  Just specify the channel and the color of the glow.  We have 16 million colors.  Further we write wrapper functions for basic colors (you can add such functions for your favorite colors). <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooRed</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, v, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooGreen</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, v, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooBlue</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, v, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooYellow</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, v, v, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooMagenta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, v, <span class="hljs-number"><span class="hljs-number">0</span></span>, v, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooCyan</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, v, v, <span class="hljs-number"><span class="hljs-number">3</span></span>);}</code> </pre><br>  Simply indicate the channel and the intensity of the glow in the range from 0 to 255. And a few more "conceptual" functions.  White, black and gray intensity. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooBlack</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooWhite</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooGray</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, v, v, v, <span class="hljs-number"><span class="hljs-number">3</span></span>);}</code> </pre><br>  And the last function, which we will add to the nooLite core in the Arduino Mega Server system, is the function of restoring the last color of the glow of the tape (the nooLite modules themselves do not remember this value).  This feature is used to turn on the tape (after shutdown, which resets the color to white). <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nooSetLedLastState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{ nooSendCommandLed(ch, <span class="hljs-number"><span class="hljs-number">6</span></span>, ledLastState[<span class="hljs-number"><span class="hljs-number">0</span></span>], ledLastState[<span class="hljs-number"><span class="hljs-number">1</span></span>], ledLastState[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-number"><span class="hljs-number">3</span></span>); }</code> </pre><br>  Here is the complete code for the new nooLite control kernel. <br><br><div class="spoiler">  <b class="spoiler_title">Full kernel code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul nooLite for Due part of Arduino Mega Server project */</span></span> #ifdef NOO_FEATURE <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PIN_TX = <span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-comment"><span class="hljs-comment">// TX PIN (to RX noolite) byte const PIN_RX = 19; // RX PIN (to TX noolite) byte const NOO_CHANNEL_1 = 0; // channel (address) 0...31 (MT1132) byte const NOO_CHANNEL_2 = 1; byte const NOO_CHANNEL_3 = 2; byte const NOO_CHANNEL_4 = 3; byte const NOO_CHANNEL_5 = 4; void nooInit() { Serial1.begin(9600); modulNoo = MODUL_ENABLE; started("nooLite"); } void nooWork() { } void nooSendCommand(byte channel, byte command, byte data, byte format) { byte buf[12]; for (byte i = 0; i &lt; 12; i++) { buf[i] = 0; } buf[0] = 85; buf[1] = B01010000; buf[2] = command; buf[3] = format; buf[5] = channel; buf[6] = data; int checkSum = 0; for (byte i = 0; i &lt; 10; i++) { checkSum += buf[i]; } buf[10] = lowByte(checkSum); buf[11] = 170; for (byte i = 0; i &lt; (12); i++) { Serial1.write(buf[i]); } /* Serial.println("&gt;"); for (byte i = 0; i &lt; (12); i++) { Serial.print(buf[i]); } Serial.println(); */ } byte ledLastState[] = {127, 127, 127}; void nooSendCommandLed(byte channel, byte command, byte r, byte g, byte b, byte format) { byte buf[12]; ledLastState[0] = r; ledLastState[1] = g; ledLastState[2] = b; for (byte i = 0; i &lt; 12; i++) { buf[i] = 0; } buf[0] = 85; buf[1] = B01010000; buf[2] = command; buf[3] = format; buf[5] = channel; buf[6] = r; buf[7] = g; buf[8] = b; int checkSum = 0; for (byte i = 0; i &lt; 10; i++) { checkSum += buf[i]; } buf[10] = lowByte(checkSum); buf[11] = 170; for (byte i = 0; i &lt; (12); i++) { Serial1.write(buf[i]); } } // command data format void nooBind (byte ch) {nooSendCommand(ch, 15, 0, 0);} void nooUnbind (byte ch) {nooSendCommand(ch, 9, 0, 0);} void nooOn (byte ch) {nooSendCommand(ch, 2, 0, 0);} void nooOff (byte ch) {nooSendCommand(ch, 0, 0, 0);} void nooTrigger(byte ch) {nooSendCommand(ch, 4, 0, 0);} void nooCancel (byte ch) {nooSendCommand(ch, 10, 0, 0);} void nooUp (byte ch) {nooSendCommand(ch, 3, 0, 0);} void nooDown (byte ch) {nooSendCommand(ch, 1, 0, 0);} void nooRevers (byte ch) {nooSendCommand(ch, 5, 0, 0);} void nooValue (byte ch, byte v) {nooSendCommand(ch, 6, v, 1);} void nooLed (byte ch, byte r, byte g, byte b) {nooSendCommandLed(ch, 6, r, g, b, 3);} void nooBlack (byte ch) {nooSendCommandLed(ch, 6, 0, 0, 0, 3);} void nooWhite (byte ch) {nooSendCommandLed(ch, 6, 255, 255, 255, 3);} void nooGray (byte ch, byte v) {nooSendCommandLed(ch, 6, v, v, v, 3);} void nooRed (byte ch, byte v) {nooSendCommandLed(ch, 6, v, 0, 0, 3);} void nooGreen (byte ch, byte v) {nooSendCommandLed(ch, 6, 0, v, 0, 3);} void nooBlue (byte ch, byte v) {nooSendCommandLed(ch, 6, 0, 0, v, 3);} void nooYellow (byte ch, byte v) {nooSendCommandLed(ch, 6, v, v, 0, 3);} void nooMagenta(byte ch, byte v) {nooSendCommandLed(ch, 6, v, 0, v, 3);} void nooCyan (byte ch, byte v) {nooSendCommandLed(ch, 6, 0, v, v, 3);} void nooSetLedLastState(byte ch) {nooSendCommandLed(ch, 6, ledLastState[0], ledLastState[1], ledLastState[2], 3);} #endif // NOO_FEATURE</span></span></code> </pre><br></div></div><br>  That's all, with the description of the kernel add-ons, we finish and go to the interface for managing the color of the glow of AMS LED strips. <br><br><h2>  LED strip control interface </h2><br>  In previous articles, you remember the interface for controlling the nooLite devices of the Arduino Mega Server system.  We will not be particularly sophisticated and simply add another section to the three already existing (two instrument control sections and one ‚Äúbinding‚Äù / ‚Äúdecoupling‚Äù section of the modules). <br><br><img src="http://habrastorage.org/files/ddb/a13/622/ddba136224224711bde33fb43a85e36a.png" alt="image"><br><br>  Screenshots of other sections with detailed explanations can be seen in previous articles on AMS integration with the nooLite system.  The new section allows you to turn on and off the LED strip and choose the color of the glow from several preset options. <br><br>  This is just an example of integration and you can make any other interface based on this example.  You can make color choices, smoothly change colors, or provide scenarios for turning on, turning off, and changing the color of the backlight, etc., etc. <br><br><h2>  Internal kitchen </h2><br>  The management interface is only a part of the available capabilities provided by the Arduino Mega Server with the integrated nooLite control core.  And that, so to speak, is the tip of the iceberg.  And the underwater part is the ability to use wrapper functions in the code of the system itself.  You can easily, literally in one line of code, control the glow of the tape and display with it any internal system parameters (temperature, security functions, switching on devices, etc.) and external, coming over the network as commands from other Smart Home devices . <br><br>  And here we turn to the most interesting. <br><br><h2>  Magic crystal </h2><br>  Now let's talk about the actual "magic crystal".  What is this about?  Imagine any artificial environment of a person - the interior of an apartment or office, a hall for holding any events, the urban environment of our cities (stops, pillars, pedestals, etc.), etc. So, the idea is that With the current level of technology development, any subject can be made an ‚Äúindicator‚Äù of any events and parameters.  You can go even further and make any subject interactive or ‚Äúalive‚Äù, you can also equip any subject with a characteristic voice, etc. (hello, Alice!), But this is a topic for another article, we'll talk about this another time. <br><br><img src="http://habrastorage.org/files/4ae/ca1/4ec/4aeca14ecbe64529a5788fca91e66f42.jpg" alt="image"><br><br>  Take, for example, your room.  On the shelf, next to the TV, or just among the ‚Äúcreative disorder‚Äù on the table may lie a small object, for example, a ‚Äúmagic ball‚Äù which, depending on any parameters or events, changes its color, shade or brightness of the glow.  It does not interfere with anyone and does not attract attention, it does not produce any noise, but you just have to take a quick look at it and it becomes clear to you what the temperature is on the street, whether you received an e-mail, how much beer was left in the refrigerator, whether it was time to feed the fish or take sclerosis pills prescribed by your doctor. <br><br><img src="http://habrastorage.org/files/764/af8/0b4/764af80b4d754fb18998c7026d0e5518.jpg" alt="image"><br><br>  Particularly important events "magic crystal" may indicate flashing or even sound.  And you set all the parameters of this system yourself, depending on your needs and your imagination: the color and intensity of the glow, events and parameters to which the ‚Äúmagic crystal‚Äù reacts, etc. There can be several such ‚Äúcrystals‚Äù and they can be of any kind, not necessarily in the form of a ball. <br><br>  Now from the small and "invisible" things, let's move on to the middle forms.  This may be floor or ceiling lighting, luminous walls (parts of the walls) or niches, etc. elements of the interior.  For example, the backlight can serve as a color clock, when at night it changes light depending on time, and in the morning it gradually becomes brighter and serves as a ‚Äúnatural‚Äù alarm clock. <br><br><img src="http://habrastorage.org/files/aac/d3b/f52/aacd3bf52db84e44ba082257811d96a9.jpg" alt="image"><br><br>  And, finally, it is an inexhaustible storehouse of ideas for various performances and decoration of mass events, such as parties, corporate events, etc. people‚Äôs meetings, where a small magic crystal turns into 2-meter cubes and balls that change color depending on For example, the results of voting for or against something. <br><br><img src="http://habrastorage.org/files/f37/4c4/730/f374c47301d84aee8ed2988cbbe03c52.jpg" alt="image"><br><br><h2>  Conclusion </h2><br>  And all you need to realize all these ideas is the <a href="http://hi-lab.ru/arduino-mega-server">Arduino Mega Server</a> , the <a href="http://www.noo.com.by/silovoj-blok-SD111-180.html">nooLite SD111-180</a> wireless LED tape <a href="http://www.noo.com.by/silovoj-blok-SD111-180.html">controller</a> and a little imagination.  All the innovations described in this article will appear in the next, 0.15 version of the AMS system, and the most impatient of you can take the code of the nooLite kernel module from this article and start working wonders right now. <br><br>  Previous articles: <br><br>  <a href="http://geektimes.ru/post/269100/">Wireless nooLite equipment and Smart Home (part 1).</a>  <a href="http://geektimes.ru/post/269100/">Arduino</a> <br>  <a href="http://geektimes.ru/post/269366/">Wireless nooLite equipment and Smart Home (part 2).</a>  <a href="http://geektimes.ru/post/269366/">Arduino Mega Server</a> <br>  <a href="http://geektimes.ru/post/269450/">Wireless nooLite equipment and Smart Home (part 3).</a>  <a href="http://geektimes.ru/post/269450/">Soldering Station</a> <br><br>  Arduino Mega Server promo on Youtube, demonstrating the work with the real system <br><br>  <a href="http://www.youtube.com/watch%3Fv%3Djmu0MkIlywU">Arduino Mega Server promo</a> </div><p>Source: <a href="https://habr.com/ru/post/390025/">https://habr.com/ru/post/390025/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../390013/index.html">Where does cancer begin: physicians traced the development of tumors from a single cell</a></li>
<li><a href="../390017/index.html">5 facts about Wikipedia that you did not know. The third will blow your ... ah, who am I kidding</a></li>
<li><a href="../390019/index.html">Scientists have found genes that make us share in larks and owls</a></li>
<li><a href="../390021/index.html">Frozen time. Scientific approaches to dating</a></li>
<li><a href="../390023/index.html">A brain scan can replace passwords once</a></li>
<li><a href="../390029/index.html">Torrents Time: Popcorn Time as a browser plugin. Already supported on The Pirate Bay</a></li>
<li><a href="../390031/index.html">Innovations stuck on the road to techno-Olympus</a></li>
<li><a href="../390033/index.html">ECG at home, or made in Russia: domestic developers presented a cardioflesh</a></li>
<li><a href="../390035/index.html">About specialized onboard computers let's say a word</a></li>
<li><a href="../390037/index.html">Russian State Library allowed photographing books and documents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>