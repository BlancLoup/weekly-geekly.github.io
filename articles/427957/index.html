<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DNS over TLS - We encrypt our DNS queries using Stunnel and Lua</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="image source 
 
 DNS (English Domain Name System - domain name system) is a computer distributed system for obtaining information about domains. 

 TL...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DNS over TLS - We encrypt our DNS queries using Stunnel and Lua</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habr.com/post/427957/"><img src="https://habrastorage.org/webt/lx/tv/k-/lxtvk-ug3ul_vknfupcpp-uw0ge.jpeg"></a> <br>  <em><a href="">image source</a></em> <em><br></em> </p><br><blockquote>  <a href="https://ru.wikipedia.org/wiki/DNS">DNS</a> (English Domain Name System - domain name system) is a computer distributed system for obtaining information about domains. <br><br>  <a href="https://ru.wikipedia.org/wiki/TLS">TLS</a> (English transport layer security) - provides secure data transmission between Internet nodes. </blockquote><p>  After the news <a href="https://habr.com/post/427639/">"Google Public DNS silently turned on support for DNS over TLS"</a> I decided to try it.  I have a <a href="https://ru.wikipedia.org/wiki/Stunnel">stunnel</a> that will create an encrypted <a href="https://ru.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> tunnel.  But programs usually communicate with <a href="https://ru.wikipedia.org/wiki/DNS">DNS</a> via the <a href="https://ru.wikipedia.org/wiki/UDP">UDP</a> protocol.  Therefore, we need a proxy that will send UDP packets to the TCP stream and back.  We will write it on <a href="https://ru.wikipedia.org/wiki/Lua">Lua</a> . </p><br><p>  The difference between TCP and UDP DNS packets: </p><br><blockquote>  4.2.2.  TCP usage <br>  TCP port connections (decimal).  The length of the field is given by the length of the field, which excludes the two byte length.  This is a field. </blockquote><p>  <a href="https://www.ietf.org/rfc/rfc1035">RFC1035: DOMAIN NAMES - IMPLEMENTATION AND SPECIFICATION</a> </p><br><p>  That is, we do there: </p><br><ol><li>  take a packet from UDP </li><li>  we add to it at the beginning a couple of bytes which indicate the size of this packet </li><li>  send to TCP channel </li></ol><br><p>  And in the opposite direction: </p><br><ol><li>  read a couple of bytes from TCP, thereby obtaining the packet size </li><li>  read packet from TCP </li><li>  send it to the recipient via UDP </li></ol><a name="habracut"></a><br><h3 id="nastraivaem-stunnel">  Configure Stunnel </h3><br><ol><li>  Download the root certificate <a href="">Root-R2.crt</a> to the directory with the Stunnel config </li><li>  Convert certificate to PEM <br><pre><code class="hljs pgsql">openssl x509 -inform DER -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Root-R2.crt -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Root-R2.pem -<span class="hljs-type"><span class="hljs-type">text</span></span></code> </pre> </li><li><p>  We write to stunnel.conf: </p><br><pre> <code class="hljs perl">[dns] client = yes <span class="hljs-keyword"><span class="hljs-keyword">accept</span></span> = <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> = <span class="hljs-number"><span class="hljs-number">8.8</span></span>.<span class="hljs-number"><span class="hljs-number">8.8</span></span>:<span class="hljs-number"><span class="hljs-number">853</span></span> CAfile = Root-R2.pem verifyChain = yes checkIP = <span class="hljs-number"><span class="hljs-number">8.8</span></span>.<span class="hljs-number"><span class="hljs-number">8.8</span></span></code> </pre> <br></li></ol><br><p>  That is Stunnel: </p><br><ol><li>  will accept unencrypted TCP at 127.0.0.1:53 </li><li>  will open an encrypted TLS tunnel to the address 8.8.8.8:853 (Google DNS) </li><li>  will transfer data back and forth </li></ol><br><p>  Run Stunnel </p><br><p>  Tunnel operation can be checked with the command: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nslookup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-vc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ya</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span> 127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> <br><p>  The option '-vc' causes nslookup to use a TCP connection to a DNS server instead of UDP. </p><br><p>  Result: </p><br><pre> <code class="hljs swift">*** <span class="hljs-type"><span class="hljs-type">Can't</span></span> <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> server name <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> address <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>: <span class="hljs-type"><span class="hljs-type">Non</span></span>-existent domain <span class="hljs-type"><span class="hljs-type">Server</span></span>: <span class="hljs-type"><span class="hljs-type">UnKnown</span></span> <span class="hljs-type"><span class="hljs-type">Address</span></span>: <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-type"><span class="hljs-type">Non</span></span>-authoritative answer: <span class="hljs-type"><span class="hljs-type">Name</span></span>: ya.ru <span class="hljs-type"><span class="hljs-type">Address</span></span>: ( <span class="hljs-type"><span class="hljs-type">IP</span></span> )</code> </pre> <br><h3 id="pishem-skript">  We write a script </h3><br><p>  I am writing on <a href="https://www.lua.org/">Lua 5.3</a> .  It already has binary operations with numbers.  Well, we need the <a href="http://w3.impa.br/~diego/software/luasocket/">Lua Socket</a> module. </p><br><p>  File Name: <a href="">simple-udp-to-tcp-dns-proxy.lua</a> </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> socket = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"socket"</span></span> <span class="hljs-comment"><span class="hljs-comment">--  lua socket</span></span></code> </pre> <br><p> <code>--[[--</code> </p> <br><p>  Let's write a simple function that allows you to send a package dump to the console.  I want to see what the proxy does. </p><br><p> <code>--]]--</code> </p> <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">--       az  0-9    HEX  '\xFF' return "'"..data:gsub("[^a-z0-9-]", function(chr) return ("\\x%02X"):format(chr:byte()) end).."'" end</span></span></code> </pre> <br><p> <code>--[[--</code> </p> <br><h4 id="udp-v-tcp-i-obratno">  UDP to TCP and back </h4><br><p>  We write two functions that will operate on two data transfer channels. </p><br><p> <code>--]]--</code> </p> <br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--    UDP   TCP  function udp_to_tcp_coroutine_function(udp_in, tcp_out, clients) repeat coroutine.yield() --     packet, err_ip, port = udp_in:receivefrom() --  UDP  if packet then -- &gt; - big endian -- I - unsigned integer -- 2 - 2 bytes size tcp_out:send((("&gt;I2"):pack(#packet))..packet) --       TCP local id = ("&gt;I2"):unpack(packet:sub(1,2)) --  ID  if not clients[id] then clients[id] = {} end table.insert(clients[id] ,{ip=err_ip, port=port, packet=packet}) --    print(os.date("%c", os.time()) ,err_ip, port, "&gt;", serialize(packet)) --     end until false end --    TCP      UDP function tcp_to_udp_coroutine_function(tcp_in, udp_out, clients) repeat coroutine.yield() --     -- &gt; - big endian -- I - unsigned integer -- 2 - 2 bytes size local packet = tcp_in:receive(("&gt;I2"):unpack(tcp_in:receive(2)), nil) --  TCP  local id = ("&gt;I2"):unpack(packet:sub(1,2)) --  ID  if clients[id] then for key, client in pairs(clients[id]) do --  query     if packet:find(client.packet:sub(13, -1), 13, true) == 13 then --   udp_out:sendto(packet, client.ip, client.port) --     UDP clients[id][key] = nil --   --     print(os.date("%c", os.time()) ,client.ip, client.port, "&lt;", serialize(packet)) break end end if not next(clients[id]) then clients[id] = nil end end until false end</span></span></code> </pre> <br><p> <code>--[[--</code> </p> <br><p>  Both functions are executed immediately after startup by coroutine.yield ().  This allows the first call to pass the parameters of the function and then do coroutine.resume (co) without additional parameters. </p><br><h4 id="main">  main </h4><br><p>  And now the main function that will prepare and run the main loop. </p><br><p> <code>--]]--</code> </p> <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tcp_dns_socket = socket.tcp() <span class="hljs-comment"><span class="hljs-comment">--  TCP  local udp_dns_socket = socket.udp() --  UDP  local tcp_connected, err = tcp_dns_socket:connect("127.0.0.1", 53) --   TCP  assert(tcp_connected, err) --    print("tcp dns connected") --      local udp_open, err = udp_dns_socket:setsockname("127.0.0.1", 53) --  UDP  assert(udp_open, err) --    print("udp dns port open") --   UDP   --     Lua        nil --              local coroutines = { [tcp_dns_socket] = coroutine.create(tcp_to_udp_coroutine_function), --   TCP to UDP [udp_dns_socket] = coroutine.create(udp_to_tcp_coroutine_function) --   UDP to TCP } local clients = {} --      --        coroutine.resume(coroutines[tcp_dns_socket], tcp_dns_socket, udp_dns_socket, clients) coroutine.resume(coroutines[udp_dns_socket], udp_dns_socket, tcp_dns_socket, clients) --    socket.select        local socket_list = {tcp_dns_socket, udp_dns_socket} repeat --    -- socket.select   socket_list          --      .  for       for _, in_socket in ipairs(socket.select(socket_list)) do --       local ok, err = coroutine.resume(coroutines[in_socket]) if not ok then --       udp_dns_socket:close() --  UDP  tcp_dns_socket:close() --  TCP  print(err) --   return --    end end until false end</span></span></code> </pre> <br><p> <code>--[[--</code> </p> <br><p>  We start the main function.  If the connection is suddenly closed, we will install it again after a second by calling main. </p><br><p> <code>--]]--</code> </p> <br><pre> <code class="hljs vbscript">repeat local ok, <span class="hljs-built_in"><span class="hljs-built_in">err</span></span> = coroutine.<span class="hljs-keyword"><span class="hljs-keyword">resume</span></span>(coroutine.create(main)) --  main <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ok <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> print(<span class="hljs-built_in"><span class="hljs-built_in">err</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> socket.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) --      until <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><h3 id="proveryaem">  check </h3><br><ol><li><p>  Run stunnel </p><br></li><li><p>  Run our script </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">lua5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">simple-udp-to-tcp-dns-proxy</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span></code> </pre> <br></li><li><p>  We check the script work with the command </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nslookup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ya</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span> 127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> <br><p>  This time without `-vc ', we already wrote and launched a proxy that wraps UDP DNS requests in a TCP tunnel. </p><br></li></ol><br><p>  Result: </p><br><pre> <code class="hljs swift">*** <span class="hljs-type"><span class="hljs-type">Can't</span></span> <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> server name <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> address <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>: <span class="hljs-type"><span class="hljs-type">Non</span></span>-existent domain <span class="hljs-type"><span class="hljs-type">Server</span></span>: <span class="hljs-type"><span class="hljs-type">UnKnown</span></span> <span class="hljs-type"><span class="hljs-type">Address</span></span>: <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-type"><span class="hljs-type">Non</span></span>-authoritative answer: <span class="hljs-type"><span class="hljs-type">Name</span></span>: ya.ru <span class="hljs-type"><span class="hljs-type">Address</span></span>: ( <span class="hljs-type"><span class="hljs-type">IP</span></span> )</code> </pre> <br><p>  If everything is ok, you can specify it in the connection settings as the DNS server "127.0.0.1" </p><br><h3 id="zaklyuchenie">  conclusion </h3><br><p>  Now our DNS queries are protected by <a href="https://ru.wikipedia.org/wiki/TLS">TLS</a> . </p><br><h3 id="ps-ne-dayom-guglu-lishney-informacii-o-nas">  PS We do not give Google extra information about us </h3><br><p>  Immediately after connecting, Windows tries to register us with Google‚Äôs DNS servers through our tunnel.  This is disabled in advanced DNS settings by unchecking. </p><br><p><img src="https://habrastorage.org/webt/_n/8j/fj/_n8jfjfupbovjfs0bglslifskg8.png"></p><br><p>  There is another request for time.windows.com.  He is no longer so personal, but I never found out how to turn it off.  Automatic time synchronization is disabled. </p><br><h3 id="ssylki">  links </h3><br><ol><li>  <a href="https://www.ietf.org/rfc/rfc1035">RFC1035: DOMAIN NAMES - IMPLEMENTATION AND SPECIFICATION</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/DNS_%25D0%25BF%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2580%25D1%2585_TLS">DNS over TLS</a> </li><li>  <a href="">simple-udp-to-tcp-dns-proxy.lua</a> </li><li>  <a href="https://habr.com/post/346098/">Compile a DNS query manually</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/427957/">https://habr.com/ru/post/427957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427947/index.html">Neural networks do not understand what optical illusions are</a></li>
<li><a href="../427949/index.html">Understanding statistics is hindered by our unwillingness to change.</a></li>
<li><a href="../427951/index.html">Testing an application on Go as a black box using Rspec</a></li>
<li><a href="../427953/index.html">Microservices make the world easier (and here and not)</a></li>
<li><a href="../427955/index.html">Why I don't use story points for sprint planning</a></li>
<li><a href="../427959/index.html">Check it out: made the table</a></li>
<li><a href="../427961/index.html">How Yandex tried to copy my heat map service</a></li>
<li><a href="../427965/index.html">SXSW history: how did the biggest festival around culture, media and technology begin</a></li>
<li><a href="../427969/index.html">Entertaining mathematics. The most economical number system</a></li>
<li><a href="../427971/index.html">"Save" the old software - three projects that do it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>