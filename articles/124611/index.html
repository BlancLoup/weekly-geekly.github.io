<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Leo Tolstoy and static code analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This time using PVS-Studio we checked the Apache HTTP Server. As expected, they found errors in it. There are few mistakes. This is also expected. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Leo Tolstoy and static code analysis</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/bc4/c2c/225/bc4c2c225ed26e5c8a4b04164d39d5b7.png" alt="PVS-Studio vs Apache HTTP Server"><br>  This time using PVS-Studio we checked the Apache HTTP Server.  As expected, they found errors in it.  There are few mistakes.  This is also expected. <br><br>  Other developers face the same situation, testing PVS-Studio on their projects.  Unfortunately, the first conclusion that one would like to make, after seeing only a few mistakes, that such a tool is of little use to him.  Now I have come up with a good analogy that explains why this is not so. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/dab/d30/8d2/dabd308d258955b417912377eec6c3ba.png" alt="War and peace"><br>  Imagine the following situation.  We have a work of Leo Tolstoy, for example, " <a href="http://www.viva64.com/go.php%3Furl%3D703">War and Peace</a> ".  We want to try out the spelling engine built into Microsoft Word on this book.  We run the analysis, we detect only a few real errors and a large number of false positives.  In addition, Leo Tolstoy loved writing long sentences.  Microsoft Word, failing to understand the text, will emphasize a lot of green, suggesting the presence of punctuation errors.  We look at it all and turn up our nose.  We do not like that we almost did not find any errors.  We do not like that many names are considered to be incorrect.  We do not like the punctuation analysis.  We conclude that the spell checker in Word is absolutely useless in the work thing. <br><br>  Let us examine the incorrectness of such a study tool. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We forget that people have already worked on the mistakes in the book.  And they spent a lot of time and energy on it.  Leo Tolstoy rewrote his drafts and exterminated mistakes.  The editor worked, turning the text into a book.  Something was fixed in subsequent editions. <br><br>  Of course, the program will not find all the errors in the book.  People can do it better.  But the program does it much faster, tremendously reducing the waste of human power.  The true benefits of such a tool in its regular use.  I wrote a paragraph, noticed an underlined error and instantly corrected it.  And now, rereading the text, a person can correct not banal typos, but focus on the content and subtle mistakes. <br><br>  Remarks about false positives are also not convincing.  It is enough to add an unknown word to the program once in the dictionary, and it will no longer disturb the author of the text.  Well, for the other obviously false warnings, you can always click the right mouse button and specify ‚Äúignore‚Äù. <br><br>  I think it's silly to argue about the benefits of text-checking mechanisms built into such programs as Word, Thunderbird, TortoiseSVN.  We use them and do not experience that they will find few errors in the book ‚ÄúWar and Peace‚Äù. <br><br>  Identical situation with a <a href="http://www.viva64.com/ru/t/0046/">static analysis of the</a> source code of programs.  It makes no sense to check a project like <a href="http://www.viva64.com/go.php%3Furl%3D704">Apache HTTP Server</a> and try to evaluate the possible benefits of analysis.  Apache HTTP Server code is old by programmer standards.  As a project, the Apache HTTP Server has been around for over 15 years.  The quality of the code is confirmed by the huge number of projects built on its basis.  Naturally, a huge number of errors were corrected due to the wide use of this code by many programmers and a long period of development. <br><br>  It is logical to assume that many of the errors found earlier could be found much easier if static analysis were used.  The analogy with Word is complete.  It is more useful to constantly look for mistakes than to do it one-time. <br><br>  As in the Word editor, PVS-Studio false errors are easy to eliminate.  Simply click on the false message and hide it (a special comment will automatically be added to the code). <br><br>  Let's make the last comparison on the speed of finding errors.  Word Editor can underline errors immediately.  PVS-Studio analyzer does this after compiling files.  Previously, the syntax is too complicated to parse the unfinished code.  However, this is enough.  You can consider PVS-Studio as a means of increasing the warnings issued by the compiler.  By the way, now PVS-Studio can do this in different versions of Visual Studio: 2005, 2008, 2010. So I invite you to try <a href="http://www.viva64.com/ru/b/0102/">incremental analysis</a> . <br><br>  In general, the analogy with Word, in my opinion, is complete.  If someone does not agree, then he is ready to continue the discussion in the comments or in the mail (karpov [@] viva64.com). <br><br>  I finished the main idea that I wanted to share uncontrollably.  However, I‚Äôll disappoint readers if I don‚Äôt write anything about errors found in the Apache HTTP Server.  So now a little about the errors found. <br><br>  Here is an example of excess sizeof (). <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PSECURITY_ATTRIBUTES </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNullACL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ PSECURITY_ATTRIBUTES sa; sa = (PSECURITY_ATTRIBUTES) LocalAlloc(LPTR, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SECURITY_ATTRIBUTES)); sa-&gt;nLength = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SECURITY_ATTRIBUTES)); ... }</code> </pre> <br>  PVS-Studio diagnostic message: V568 This is the case of the sizeof () operator is the sizeof (SECURITY_ATTRIBUTES) 'expression.  libhttpd util_win32.c 115 <br><br>  The size of the SECURITY_ATTRIBUTES structure is set incorrectly.  As a result, correct work with such a structure is impossible. <br><br>  However, I suspect that most of the examples that I will give are in code that rarely gets control.  Therefore, do not worry much.  This is the following example.  The error is in the function associated with error handling. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">apr_size_t</span></span> ap_regerror(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> errcode, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ap_regex_t</span></span> *preg, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *errbuf, <span class="hljs-keyword"><span class="hljs-keyword">apr_size_t</span></span> errbuf_size) { ... apr_snprintf(errbuf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> errbuf, <span class="hljs-string"><span class="hljs-string">"%s%s%-6d"</span></span>, message, addmessage, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)preg-&gt;re_erroffset); ... }</code> </pre> <br>  PVS-Studio diagnostic message: V579  It is possibly a mistake.  Inspect the second argument.  libhttpd util_pcre.c 85 <br><br>  The meaning is as follows.  Instead of the buffer size, the pointer size is passed to the function.  As a result, an error message cannot be generated correctly.  In practice, the message will be 3 or 7 characters long. <br><br>  There are also classic copy-paste errors. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">magic_rsl_to_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request_rec *r)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == rsl_subtype || state == rsl_encoding || state == rsl_encoding) { ... }</code> </pre> <br>  PVS-Studio diagnostic message: V501 There are identical sub-expressions 'state == rsl_encoding' to the left and to the right of the '||'  operator.  mod_mime_magic mod_mime_magic.c 787 <br><br>  In fact, the comparison should be: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == rsl_subtype || state == rsl_separator || state == rsl_encoding) {</code> </pre> <br>  There are errors that will manifest themselves only in the Windows operating system. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> UINT_PTR SOCKET; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">win9x_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * dummy)</span></span></span><span class="hljs-function"> </span></span>{ SOCKET csd; ... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { clen = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(sa_client); csd = accept(nsd, (struct sockaddr *) &amp;sa_client, &amp;clen); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (csd &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; APR_STATUS_IS_EINTR(apr_get_netos_error())); ... }</code> </pre> <br>  PVS-Studio diagnostic message: V547 Expression 'csd &lt;0' is always false.  Unsigned type value is never &lt;0. libhttpd child.c 404 <br><br>  The accept function in Visual Studio header files returns a value of unsigned type SOCKET.  Therefore, the 'csd &lt;0' check is invalid, because its result is always false (false).  The returned values ‚Äã‚Äãmust be explicitly compared with various constants, for example, with SOCKET_ERROR. <br><br>  There are a number of errors that can be attributed to potential vulnerabilities.  I do not know, maybe at least theoretically use them to attack.  Nevertheless, I will give a couple of similar examples. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">apr_size_t</span></span>; APU_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">apr_status_t</span></span>) apr_memcache_getp(...) { ... <span class="hljs-keyword"><span class="hljs-keyword">apr_size_t</span></span> len = <span class="hljs-number"><span class="hljs-number">0</span></span>; ... len = atoi(length); ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ... } }</code> </pre> <br>  PVS-Studio diagnostic message: V547 Expression 'len &lt;0' is always false.  Unsigned type value is never &lt;0. aprutil apr_memcache.c 814 <br><br>  The condition ‚Äúlen &lt;0‚Äù in this code is always false, since the variable 'len' is of unsigned type.  Accordingly, if you input a string with a negative number, it will probably fail. <br><br>  Still in Apache there is a lot of code where various buffers with data are reset.  Most likely, this is due to security.  However, zeroing itself often does not occur due to an error of the following form: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MEMSET_BZERO(p,l) memset((p), 0, (l)) void apr__SHA256_Final(sha2_byte digest[], SHA256_CTX* context) { ... MEMSET_BZERO(context, sizeof(context)); ... }</span></span></code> </pre> <br>  PVS-Studio diagnostic message: V512 A call of the 'memset' function will.  apr sha2.c 560 <br><br>  Only the first bytes in the buffer are reset, because the sizeof () operator returns the size of the pointer, not the buffer with data.  I counted such errors at least 6 pieces. <br><br>  The remaining mistakes are more boring, so I will not write about them.  Thanks for attention.  Come <a href="http://www.viva64.com/ru/pvs-studio-download/">try</a> PVS-Studio.  And we still provide keys for the developers of free open-source projects and those who really want to try the analyzer in full force.  Write to us. </div><p>Source: <a href="https://habr.com/ru/post/124611/">https://habr.com/ru/post/124611/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124603/index.html">Hacked API Bank Privat24</a></li>
<li><a href="../124605/index.html">Algorithm for Finding N First Primes</a></li>
<li><a href="../124606/index.html">Tips and tricks for using Wine</a></li>
<li><a href="../124608/index.html">Layouts, search for alternatives or why YSTUKEN will remain popular</a></li>
<li><a href="../124610/index.html">How does the femto network</a></li>
<li><a href="../124612/index.html">Samsung Galaxy S II - still a cake!</a></li>
<li><a href="../124613/index.html">External web services and traffic-generating sites. Why be friends?</a></li>
<li><a href="../124615/index.html">Discontinued Google Toolbar for Firefox</a></li>
<li><a href="../124617/index.html">Preparations for the launch of Levenhuk-1 (part 2)</a></li>
<li><a href="../124619/index.html">Universal ADO.NET Entity Repository</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>