<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup files, database and server settings in Dropbox</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For several years now, the opportunity has appeared for any mortal who wants to rent not only a shared-hosting, but also a ‚Äúfull-fledged‚Äù server with ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup files, database and server settings in Dropbox</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fb5/ee8/54c/fb5ee854c8f147f59500f5319fcd7d86.png" align="right">  For several years now, the opportunity has appeared for any <s>mortal</s> who wants to rent not only a shared-hosting, but also a ‚Äúfull-fledged‚Äù server with root-access and the ability to configure it the way you want yourself.  Set up, for example, in addition to the web-server also a bunch of other services. <br>  I did the same a few years ago.  At first I rented one server, then another, and transferred the settings using handles, finding the necessary files in the / etc directory. <br><br>  For a couple of years, several friends' blogs have settled on my server, and even a mail server, as I haven‚Äôt wanted Google for a long time.  About the safety of data was thought after each article on Habr√©, but it was somehow not up to it.  And, as they say, admins are divided into three categories: those who do not back up, those who already do, and those who even check for recoverability from backups.  It happened with me, even though the hoster is very good, but they had an accident with hard drives.  Yes, such that a week they tried to restore the discs and preliminary estimates were very disappointing.  And I did not have backups.  What mood I had in those days you can imagine. <br><br>  But after a few days, the hosting technicians managed to restore the data and launch all the virtual servers on that node.  And I thought about backups.  I thought so - the backup should not be on the same server (naturally!), It is desirable that it be on my computer, but not in one instance.  I thought about installing FTP on my home computer and even sending archives with letters, but all these options did not suit me.  And I realized that I had to try Dropbox, which I had already used for a couple of years by that time, and I had about 18 free gigs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Benefits of backup in Dropbox: </h4><br><ul><li>  Independence from home infrastructure and Internet channel </li><li>  Multiple copies (on all synchronized PCs at once) </li><li>  In addition to their own storage backups are stored in the cloud </li></ul><br><h4>  What does the script submitted by me do? </h4><br><ul><li>  Incremental backup of files in the specified folders (the first and the fifteenth numbers are full backup) </li><li>  Backup the entire MySQL database </li><li>  The backup is archived using 7zip, with a password (you do not need to store passwords in clear form in Dropbox?) </li></ul><a name="habracut"></a><br><h4>  How it's done? </h4><br>  In short, an ‚Äúapplication‚Äù is created from the point of view of the Dropbox platform, authorized by the user (that is, us), and a script is written that uses authorization data and uploads backup files to Dropbox. <br><br><h4>  Or rather? </h4><br><h5>  Step 1 - Creating the Application </h5><br>  Go to the <a href="https://www.dropbox.com/developers/apps">App Console</a> page, click the ‚ÄúCreate app‚Äù button, select the ‚ÄúDropbox API app‚Äù type, select the ‚ÄúFiles and datastores‚Äù option, since we are going to work with files, and in the next paragraph we answer ‚ÄúYes - My app only needs access to files it creates ", this means that your application will be limited only to its own separate subfolder in the App folder, it will not have access to other files.  We come up with the name of your application and click "Create app". <br>  You will see a whole page of settings for the created application, but there is no need to customize anything.  But do not close it yet. <br><br><h5>  Step 2 - Download and Install the SDK </h5><br>  To write applications that will work with files in your Dropbox, you need to go to the <a href="https://www.dropbox.com/developers/core">Core API</a> section.  There we can download the SDKs we need, read the documentation and go through study tours. <br>  Since I believe that the best language for scripting for me is Python, I downloaded the SDK for myself and installed it.  Installation is very simple, everything is limited to downloading, unzipping the SDK itself and installing it using the commands " <i>python setup.py install</i> ", or " <i>pip install dropbox</i> ". <br><br><h5>  Step 3 - Authorization </h5><br>  The Core API library uses <a href="http://www.oauth.net/">OAuth v2</a> , but Dropbox's Python SDK will take care of how to use it, so you have nothing to worry about and don't have to write everything from scratch. <br>  It is time to build a small script: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  Dropbox SDK import dropbox #   app_key  app_secret       1 app_key = 'INSERT_APP_KEY' app_secret = 'INSERT_APP_SECRET' flow = dropbox.client.DropboxOAuth2FlowNoRedirect(app_key, app_secret) #      authorize_url = flow.start() print '1.   : ' + authorize_url print '2.  "Allow"' print '3.   .' code = raw_input("   : ").strip() #     ,         access_token,    access_token, user_id = flow.finish(code) #        client = dropbox.client.DropboxClient(access_token) print 'linked account: ', client.account_info() #   access_token          print 'access_token: ', access_token</span></span></code> </pre> <br><h5>  Step 4 - create a temporary folder and token file </h5><br>  The backup.py script itself is in my / root folder, it also has a temporary backup folder and a dropbox_token.txt file.  You also need to create them and write a token to the file from the previous step.  The token consists of two lines, in the file they are just like that, with a line break. <br><br><h5>  Step last - we write a backup script </h5><br><div class="spoiler">  <b class="spoiler_title">Expand</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import os import sys import time import string from os.path import getsize curDate = time.strftime("%d.%m.%Y", time.gmtime()) curDay = time.strftime("%d", time.gmtime()) backupDelay = time.time()-86400 if curDay == "01" or curDay == "15": backupDelay = 0 print "curDate:", curDate # Include the Dropbox SDK libraries from dropbox import client, rest, session # Get your app key and secret from the Dropbox developer website APP_KEY = ' ' APP_SECRET = '  ' # ACCESS_TYPE should be 'dropbox' or 'app_folder' as configured for your app ACCESS_TYPE = 'app_folder' sess = session.DropboxSession(APP_KEY, APP_SECRET, ACCESS_TYPE) oauth_token = '' oauth_token_secret = '' f = open("dropbox_token.txt",'r') if f: oauth_token = string.strip(f.readline()) oauth_token_secret = string.strip(f.readline()) f.close() print "oauth token found:", oauth_token, oauth_token_secret if oauth_token == '' or oauth_token_secret == '': request_token = sess.obtain_request_token() # Authorize the application on dropbox site url = sess.build_authorize_url(request_token) print "url:", url print "Please visit this website and press the 'Allow' button, then hit 'Enter' here." raw_input() # This will fail if the user didn't visit the above URL and hit 'Allow' access_token = sess.obtain_access_token(request_token) f = open("dropbox_token.txt","wb") f.write(access_token.key + '\n') f.write(access_token.secret) f.close() else: sess.set_token(oauth_token, oauth_token_secret) client = client.DropboxClient(sess) print "linked account:", client.account_info() def sync_dir(dir): rootdir = dir print "Syncing directory:", rootdir startTime = backupDelay for root, subFolders, files in os.walk(rootdir): for file in files: fname = os.path.join(root,file) if os.path.getmtime(fname)&gt;startTime: #print root, file os.system("mkdir -p 'backup"+root+"'") os.system("cp '"+fname+"' 'backup"+fname+"'") print "Making dump of MySQL databases..." os.system("mysqldump --all-databases -uroot -pROOT__MYSQL -r backup/backup.sql") sync_dir("/var/www") sync_dir("/var/spool/virtual") sync_dir("/home/user") backupName = 'backup_'+curDate+'.7z' print "Creating archive with name", backupName os.system("7z a -p_ "+backupName+" backup/* /etc") f = open(backupName,'rb') if f: fsize = getsize(backupName) uploader = client.get_chunked_uploader(f, fsize) print "Uploading file", fsize, "bytes..." while uploader.offset &lt; fsize: try: upload = uploader.upload_chunked() print "." except rest.ErrorResponse, e: # perform error handling and retry logic print "error uploading file!" uploader.finish("/"+backupName) f.close() print "File uploaded successfully." print "Deleting temp files..." os.system("rm -r backup/*") os.system("rm " + backupName);</span></span></code> </pre></div></div><br><h5>  Afterword </h5><br><ul><li>  I added this script to the crontab with the launch every day at 4:00 in the morning. </li><li>  The script has three lines with the function call sync_dir, just as you can configure which folders you need to back up. </li><li>  The script does not delete the files that have been deleted from the folder, if you unzip the full archive incrementally and subsequent, then the deleted folders / files will remain. </li><li>  I didn‚Äôt delete the old backups in the Dropbox itself, I clean the folder myself when I remember it. </li><li>  Recently I took myself a couple of VPS in other countries, and in the script I added only a prefix to the name of the backups, so all the backups are merged into one folder, but they can be very easily distinguished. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/236483/">https://habr.com/ru/post/236483/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236471/index.html">How to find a lost or delete outdated 1C databases</a></li>
<li><a href="../236473/index.html">For Raspberry Pi Model B + we created a VGA adapter</a></li>
<li><a href="../236475/index.html">Google for Entrepreneurs: Google‚Äôs concern for startups and entrepreneurs</a></li>
<li><a href="../236477/index.html">Apple and Google: Thought Locally, Act Globally</a></li>
<li><a href="../236481/index.html">News from the world of Node: promise.io, copromise, Apper</a></li>
<li><a href="../236485/index.html">Hazelcast 3.3 - what's new?</a></li>
<li><a href="../236489/index.html">Version Control Systems: Fossil Part II</a></li>
<li><a href="../236491/index.html">Cheat sheet for comparing Twitter Bootstrap and Zurb Foundation classes</a></li>
<li><a href="../236493/index.html">DigiSole smart insoles will teach how to put a foot correctly and will monitor the owner‚Äôs physical activity</a></li>
<li><a href="../236499/index.html">New Berlin: Lumia accessories</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>