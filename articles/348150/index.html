<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we launched the offline version of the site RG.RU</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How often, when requesting a page, we see the message ‚ÄúNo internet connection‚Äù. However, it has long been possible to catch events in the absence of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we launched the offline version of the site RG.RU</h1><div class="post__text post__text-html js-mediator-article">  How often, when requesting a page, we see the message ‚ÄúNo internet connection‚Äù.  However, it has long been possible to catch events in the absence of the Internet and control the content that the user sees.  Alexey Chernyshev and Maxim Chagin launched a offline version of the Russian Newspaper website - the official publication of the Russian Government with 1 million visitors per day - and shared their experience on RHS ++ 2017. Decoding their report under the cut. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16f/548/874/16f548874ce790bf6dfb8ea473bc2395.png"><br><a name="habracut"></a><br><h2>  Offline version is already available for any site. </h2><br>  Let's imagine - we have a pizza delivery service.  The client enters, but he does not have internet.  He waits for 20 seconds and sees the same thing: ‚ÄúNo internet connection‚Äù.  I don‚Äôt think it will stop him from ordering if we have a really tasty pizza. <br><br>  But are you sure that in order to visit the site, choose a pizza, fill it with ingredients, send an order form, do we really need internet?  No, of course!  All this can be done offline, and when the connection appears, send the order already to the server for processing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/c72/aab/551/c72aab551a28cadc8be40757e421fd1e.png"><br><br>  If the Internet has not appeared, you can send a notification: ‚ÄúOh!  Contact the phone manager or stay hungry! ‚ÄùThe option is certainly not perfect, but better than nothing. <br><br>  This can be absolutely any case.  If you have an online store, you can inform the user about the sale.  In the case of informational content, you can give interesting material to read. <br><br><h2>  Service Worker - the heart of offline applications </h2><br>  All offline work is based on the use of the Service Worker.  He has a lot of properties, but we'll talk only about the basic basic parts, which will help to understand what is happening with offline. <br><br>  So, the <em>Service Worker</em> is an event-driven worker who receives a JavaScript file, executes it, and allows you to: <br><br>  ‚úì Monitor the pages in the context of which this <em>Service Worker</em> was invoked; <br><br>  ‚úì Intercept various requests and modify them on the pages under control; <br><br>  ‚úì Cache resources through a special cache API. <br><br>  I would also like to note that it works in a stream parallel to the main one, and accordingly, the DOM, LocalStorage or the Window object is not available to it.  But then, performing some actions, it does not block the main UI browser. <br><br><h2>  The principle of operation of the Service Worker </h2><br>  In order for the Service Worker to be able to earn money on the site, and all the magic could act, it must be registered, then it must go through the installation phase and the activation phase. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/abb/88c/145/abb88c145079abcf2adc77f7019aefd0.png"><br><br><h3>  Register Service Worker </h3><br>  On the client, you need to call the code that passes the path to our Service Worker.  If this file is available and it can be executed without errors, then the Service Worker is considered registered, and begins to listen and view those pages that are in its scope. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c91/f16/e16/c91f16e16205d5f6cc70393bca8e2911.png"><br><br><h3>  A little bit about the scope </h3><br><ul><li>  If the Service Worker is put in the root of the site, next to Favicon, then he will see all the pages that are inside the site. </li><li>  If you put it in a subdirectory, it will only act in the page that is inside this directory. </li><li>  You can programmatically limit its scope through the scope property.  In the example, we have limited it to work only in the article subdirectory. </li></ul><br><br><h3>  Install Service Worker </h3><br>  The first event that occurs is the installation event.  By processing this event, we cache resources, which we will later use to render the client an offline version, via the API cache to the browser. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2b0/45e/e43/2b045ee434582833fa181cb1cb94fa88.png"><br><br><h3>  Service Worker Activation </h3><br>  After this, an activation event is triggered.  Note that if the Service Worker is only registered for the first time and activated on the page, then the activation event immediately triggers and you can do something by handling this event. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7df/983/d6a/7df983d6a90aecb5817e383ad9442bd7.png"><br><br>  When updating the Service Worker, the order of activation is different.  If before this site already had some version of it, and we changed the file, the browser, which checks identity after about 24 hours, understands: ‚ÄúYeah, I have a new version of the Service Worker on the site, let's update it!‚Äù <br><br>  After that, the new Service Worker starts registration and installation.  But, if the user has opened the pages with the old Service Worker, the new Service Worker goes into standby mode.  Only after they are closed, the activation event is triggered, and it can continue to work, at this point you can tidy up the old Service Worker and remove unnecessary data. <br><br><h2>  We listen to events </h2><br>  After we have processed the activation, the Service Worker starts working in full force, namely, the following events are available to it: <br><ul><li>  <b>Message</b> allows the client side to tell the Service Worker something to do, i.e.  send a message via Post message. </li><li>  <b>Fetch</b> is one of the most important events in the offline method.  Occurs when a resource is requested in the pages controlled by the Service Worker.  By processing the Fetch event, we can send the desired response to the page. </li><li>  <b>Push</b> occurs when a push notification to a browser comes from a service. </li><li>  <b>Sync</b> occurs when we want to update some data for the Service Worker on the client in the background. </li></ul><br><br><h2>  Approaches to building offline applications </h2><br>  Now that we know what a Service Worker is and that it can be used to manage the cache, let's highlight the main strategies for building an offline application. <br><br><h3>  1. Static. </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/d18/e9f/ab9/d18e9fab92660c06f3a04719b0a096d9.png"><br><br>  We take in general everything that is on the page - HTML.  CSS, JS, Fonts, SVG, IMG and throw in the cache.  This is the easiest and fastest way to make your application available offline, but it has a significant drawback.  It is suitable for rarely updated static content, if the information changes more often than the user visits the site, then perhaps it will simply lose its relevance and become useless to no one. <br><br>  This option can be used to cache the conference schedule.  We already have speakers, everything is compiled and compiled - thrown into the cache, and everyone is happy. <br><br><h3>  2. Offline first, or unkillable service. </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/dce/91a/f86/dce91af863911d93ad8fabb8066ad351.png"><br><br>  This is a way to create an application where an internet connection is a kind of improvement, not a necessity.  By default, we believe that we have no Internet.  All server logic is transferred to the client. <br><br>  As soon as the Internet appears, the client part is synchronized with the server part, if necessary, and the user continues to work, as if nothing had happened. <br><br>  For example, we have a news publishing service, the editor can write and do anything there, without the Internet, and when the Internet appears, everything is synchronized with the server, and it will be possible to display content on the site. <br><br><h3>  3. SPA </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/63c/529/fb9/63c529fb93620a0d47329f8c15c2b6e4.png"><br><br>  This is a deployment of a mini-application with its structure, addressing, design.  As we have said, in such a mini-application, we intercept the request from the user, and in case he does not have the Internet, we expose some content. <br><br>  It can be anything you want - a game, an interactive, a poll.  This option is not suitable for services due to the fact that we actually have a substitution of content, but for an information and entertainment resource, this is an ideal option. <br><br>  At home, we use it will tell about it a little more. <br><br><h2>  The idea of ‚Äã‚Äãcreating an offline version of rg.ru </h2><br>  So, at the Moscow JS conference, colleagues from Lenta.ru told that they didn‚Äôt suggest playing tic-tac-toe if the user lost the Internet while reading an application.  The idea itself seemed interesting to us, but one toy is not enough.  We reasoned that the user sees all the same message and it is trite. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f6/4c7/a29/8f64c7a29f174ff9bcd4b453eba355af.png"><br><br>  Another option: the user visits the site and, as long as he does not have the Internet, he is offered to read articles.  This is already better - at least there is a chance that we have captured the user's attention, and after he has the Internet, he will continue to read further on the main site. <br><br><h2>  Interface description </h2><br>  The first thing that comes to mind when you try to imagine an offline application is the 2-page SPA: the main page with a list of news, and you can open any one for reading. <br><br>  An important question is how to inform the user that he has opened an offline version so that he does not think that the site now looks like this.  We tried a lot of different options, but we stopped at the simple, maximally noticeable dice at the top, which says that this is an offline version and there is no advertising here.  In the upper right corner there is a red indicator that says ‚ÄúOffline‚Äù, as soon as the Internet appears, it turns green, indicating that a landing page is available. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3de/3be/565/3de3be565c7ad6692720585d8231cd6e.jpg"><br><br><h2>  Filtering content </h2><br>  It should be noted that not all the materials in a row are offline.  This is due to the specifics of information content.  Imagine, the application can be opened both in a week and a month after the last visit, and in June-July we will show the user something like ‚ÄúMay 20 in Moscow will warm to the climatic norm‚Äù.  On the other hand, advice on how to maintain health after 25 is always relevant. <br><br><h2>  How does the offline version of the site rg.ru </h2><br>  In order for this to work, you need to visit the site at least once.  After entering the site, the Service Worker is initialized, adding all the necessary information to the cache. <br><br><h3>  Offline application architecture </h3><br>  The user enters the site and on the client side of the page the registration of the Service Worker is turned on, we give the user to the cache several files for the offline version, and after that we delete the unnecessary old ones. <br><br>  Next, we begin to check the availability of the page itself through the Fetch event.  Namely, by processing the Fetch event, we see that if the requested resource is available, then we simply give it away.  If not, we leave to the exception and give our offline version via the API cache. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/516/dc7/e88/516dc7e88e806881acb64e25d15b6603.png"><br><br>  While the Service Worker checks and processes everything, we find out in parallel whether the user needs to update the data for the offline version. <br><br><h2>  The principle of the application </h2><br>  As already mentioned, the offline version is a SPA application built on the standard MVC architecture: there is a controller, which in our case receives only 2 addresses, the main page or the page of the article.  We take the data from the cache and the piece of the template we need and give the user the ready-made HTML. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/220/03b/31a/22003b31a94b21d48175088edf492fb9.png"><br><br>  By the way, here we do not use any libraries like React or Angular.  We only have the Mustache template engine and regular JavaScript - just so that all this does not drag the user into the browser. <br><br><h2>  Network availability </h2><br>  Now you need to decide how to know that the Internet has appeared.  Events ONONLINE and ONOFFLINE, unfortunately, are not suitable, because they occur when the network cord is pulled out of the network card.  And we went to the forehead, and it turned out to be effective. <br><br>  After a certain time interval inside the application, statistics are sent to Google Analytics - if the statistics are sent, we understand that the Internet has appeared and inform the user about it. <br><br><h2>  Problems‚Ä¶ </h2><br>  When we developed this version and launched it on production, we faced a number of problems that we want to share with you, so that you do not experience the same rake. <br><br><h3>  Data update </h3><br><blockquote>  - Cap, we have a problem!  It is necessary to update the cached data so that the user always sees the current version of the news. <br><br>  - Maybe you have any ideas?  You develop it! </blockquote><br><img src="https://habrastorage.org/getpro/habr/post_images/0d8/1db/4bc/0d81db4bc125d83dffc9765e0596b09f.png"><br><br>  The first thing that comes to mind, of course, is the setinterval inside the Service Worker ‚Äî why not?  We conducted a small experiment.  Inside the Service, Worker wrote a function that, in a cycle, sent a simple get request to the server every 10 seconds, all data was logged.  After that we go to the test page so that the Service Worker is initialized, close the tab and wait for the Service Worker to die. <br><br>  <b>It turned out the following:</b> <br><br><ul><li>  In Google Chrome, on the desktop, the Service Worker dies, that is, it stops sending requests, in exactly 1 minute. </li><li>  FireFox sends requests indefinitely as long as the browser is open. The Service Worker continues to work. </li><li>  In the mobile Chrome, Service Worker also works endlessly, even if you remove the browser from applications, it still sends requests. </li></ul><br>  <b>In principle, you can work with setinterval.</b>  <b>But we did not use it:</b> <br><br><ol><li>  Because it is not known how much battery it consumes. </li><li>  It is not known what will happen in the next version, suddenly Google will restrict sending requests to one minute, like on a desktop. </li></ol><br>  Therefore, we, as with the network accessibility check, decided to take a detour.  If the user visits the page when there is internet: <br><br><ul><li>  It records the time stamp in Local Storage. </li><li>  When the page is reloaded or re-visited, the timestamp is again removed and compared to the one that was recorded in Local Storage. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/e27/a23/acc/e27a23acc61a0d0482a3c2a6080cc89a.png"><br><br>  Thus, it calculates how much time has passed since the last visit to our site, and if it is more than 15 minutes, a request is sent to the Service Worker: ‚ÄúMy friend, it‚Äôs time to delete the old data from the cache and write new data into it!‚Äù <br><br>  The documentation says that Background Synchronization is being developed, that is, in the future, it will be possible to update the data for the Service Worker through the PeriodicSync method in the background.  But for now we use proven time stamps. <br><br><h3>  Delays in receiving data </h3><br>  When we tested the offline application in the metro, a situation arose when the application was initialized, but the data did not arrive.  What could happen?  With the incomprehensible state of the Internet in the metro, the Service Worker did not understand whether there is Internet or not, and there was a delay. <br><br>  It was decided very simply.  We do not send the request through Fetch, but via PostMessage from our SPA application, ask the Service Worker: ‚ÄúWell, my friend, give us the data that you have in the cache!‚Äù <br><br><h3>  Two Service Workers in one scope </h3><br>  We already had one Service Worker with a push notification service, and now we have developed a second one.  Just asking them different scope is not suitable, because both push-notifications and offline version should work throughout the site. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/871/eb5/57a/871eb557a05fad315f20577e9111f515.png"><br><br>  You cannot set the root Scope either, because the Service Worker installed later will replace the earlier version.  It was also impossible to make one Service Worker file and import scripts with different services into it due to similar event handling. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/696/e71/3ed/696e713ed6450e944101159ecabbbd5a.png"><br><br>  Therefore it was necessary to rewrite everything trivially.  More precisely, the logic remained, but we made one large PWA application to work in the Service Worker and already connected separate services to it. <br><br>  At the moment, this is only Push notifications and an offline version, but perhaps in the future, such a modular approach will be useful to us for something else. <br><br><blockquote>  Banal advice - it is better to make a fully modular structure in the Service Worker in advance, so that you do not have to rewrite later. </blockquote><br><br><h2>  Proxy traffic through the Service Worker </h2><br>  The moment came when we seemed to have done everything, everything was debugged and we run the Service Worker into our offline version for production. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/921/056/b5b/921056b5b742734c773c137b1a25fc63.png"><br><br>  But not everything went smoothly, on all pages of the site the offline version worked.  But there were pages with a video player, when turned on, the video was given with a huge delay in minutes, because  it also went through the Service Worker. <br><br>  We realized that through the Service Worker we don‚Äôt need to skip anything but the page document itself, and added the appropriate filter.  However, it still did not work, because the video was also given inside the Service Worker with the same title.  I had to additionally exclude video from all requests. <br><br><h2>  Analytics </h2><br>  There is another problem - this is analytics.  We do not have the Internet, requests are not sent, but we really want to know what is happening there. <br><br>  The easiest option is to send data to GA, if the Internet appears in the process of reading the application.  But what to do with users who have closed the application before the appearance of the network.  Let's store the analytics on the client, and send it later.  We decided that Index DB would be the best storage option. <br><br>  This is the standard for storing large amounts of structured information on the client, which <br><br><ul><li>  works asynchronously; </li><li>  supports transactions; </li><li>  able to work with indices; </li><li>  works directly directly from the Service Worker. </li></ul><br>  In our small application, only the first and last points are needed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/785/2d0/3f5/7852d03f5db9940798f0f903384cbd68.png"><br><br>  Now the scheme looks like this: <br><br><ul><li>  The user walks the page; <br></li><li>  All pageview data is sent to the database; <br><ul><li>  If the data is sent, we believe that the Internet is there, the database is cleared; </li><li>  If there is no Internet, the request is not sent, we are waiting for the next cycle. </li></ul><br></li></ul><br>  Screwing this thing, we found about 10% of the missing audience. <br><br><h2>  What do we have at the moment? </h2><br>  When we first started, the data was, say, so-so - 2 thousand users per day.  For our site, this is a small figure, which affected, among other things, the need to install the Service Worker, that is, a kind of user infection. <br><br>  At the moment we have about 6 thousand users per day.  This is about 180,000 per month. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/35b/b83/9f9/35bb839f9184081144cd7a1302e23ea9.png"><br><br>  We also measure how many users came to us from an offline to the main version of the site - that's about 3,000. It's easy to calculate that half have gone somewhere - we are dealing with this. <br><br>  When we just launched the application, we counted on a mobile audience - subway, cottage, fishing, etc.  But after the launch, it turned out that 30% are desktops.  For us it was, frankly, unexpected!  On desktops, we still see it as just a mobile version, but plans to fix it. <br><br><h2>  Unexpected use of the Service Worker.  Blocking sites </h2><br>  Some time ago there was news about blocking the Russian media in Ukraine.  In general, the topic of locks and we have quite relevant.  As long as admins set up endless mirrors, you and I can inform the user about moving to another domain or give some information. <br><br>  The same Service Worker will help us in this! <br><br>  When a provider blocks a site by urla, in most cases it makes a simple 302 redirect.  As a result, we just need to catch 302 server response status via Fetch. <br><br>  As already mentioned, when we go through Fetch to exceptions, we vice versa catch request and check for response.status.  Here response.status = 0 is not 302 or 301, namely 0. In the case of redirects, the Service Worker does not understand at all what happens on your server and gives the status 0. <br><br>  To catch 5XX server errors, it is necessary to modify the previous version.  All the same, but the status comes right, so we can safely catch and show some content. <br><br>  This can be used if you have a server lying tight, while admins are trying to pick it up, the front heroically gives some information either from the cache or from a backup source. <br><br><h2>  A little bit about browser support </h2><br>  <strong>In IE, Edge and Safari Service Worker 'does not work</strong> : <br><br><ul><li>  Ie you can immediately forget. </li><li>  Edge is under development with no specific dates. </li><li>  Safari says support is being considered for the next 5 years. </li></ul><br>  In fact, it is there, but turned off by default.  It can be enabled through the developer‚Äôs functions, but for production and for users you will not launch it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5bc/845/36e/5bc84536e23bb5aa0dab766a848e2e17.png"><br><br>  In mobile browsers, it's not that bad either.  Everything works in the Android Browser version 5-6 and in Chrome for Android - that's about 55% of our audience. <br><br><h2>  Summary </h2><br>  ‚úì Offline is working now. <br><br>  ‚úì As a bonus, you can catch errors, redirects, and in general any statuses. <br><br>  ‚úì Expanded accessibility of the site - now you are not only online, but also offline. <br><br>  <strong>PS:</strong> Working with offline is part of PWA (Progressive Web Applications), but we specifically bypassed this topic. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f4/e5f/db2/8f4e5fdb2f849fa65bd02ee5537ff117.png"><br><br>  Gitkhab Alexey Chernyshev profiles - <a href="https://github.com/nanomen">https://github.com/nanomen</a> and <br><br>  Maxim Chagin - <a href="https://github.com/maxchagin">https://github.com/maxchagin</a> . <br><br>  Answers to questions from listeners are often full of interesting information.  We hid them under the spoiler, practically in its original form, i.e.  with the maximum amount of details. <br><br><div class="spoiler">  <b class="spoiler_title">Questions and Answers</b> <div class="spoiler_text">  <strong>- I have 2 questions:</strong> <br><br>  <strong>1. First - I would like to once again understand how the scripts that Service Serviceer has downloaded are disabled?</strong> <br><br>  <strong>2. The second question is - do I understand correctly that when I open some news page with popular articles, then, in theory, you can download them in advance so that the next time I click on it on the site, the request for the server did not go, and the saved page would be downloaded?</strong> <br><br>  Maxim: I will first answer the second question.  Theoretically, yes, it is possible.  But the fact is that the resource is updated very quickly.  You are not interested in what was yesterday?  There is an option with push-notification.  Users who are subscribed to the Push notification when it arrives, the Service Worker wakes up, and after that it can load the article that we ‚Äúpushed‚Äù into the cache.  In this case, it can open it even without the Internet. <br><br>  In other cases, we just update some interesting articles.  Our editorial board marks interesting articles with a special tag and it is sent to the user in advance in the cache. <br><br>  Alexey: The first question.  There is a registration, installation and activation.  These 3 events occur only at the moment when either the Service Worker is installed on the site for the first time, or when we in the Service Worker file changed hands and reloaded it.  This hash sum looks every day, is checked by the browser, it was updated or not. <br><br>  Only at this moment the registration event is triggered again.  Just at the time of registration, he checks whether it is necessary to update him further or not.  And then installation and activation pops up. <br><br>  The most difficult moment is activation.  Imagine - there are 2 versions of Service Worker: old and new.  The old one works.  The user has open tabs with the old version.  He opens a new page, and he already has a new Service Worker trying to break through. <br><br>  For developer reasons, if we update the Service Worker to everyone now, then all these old pages will break.  You never know what our Service Worker does?  Therefore, the new Service Worker is installed; it can do something at the time of installation ‚Äî write something to the cache.  And after that it is blocked and starts to wait.  He has an endless wait until the pages that use the old Service Worker are closed. <br><br>  After we close them all or completely the browser, the new Service Worker asks for activation.  At this moment we can do something (and we can not do it) - there is a certain toolkit in the Service Worker, and we can use it (or not use it).  We can set the event and not activate the activation.  There we are cleaning up what is not needed - the old cache.  Then activation arises - that's all. <br><br>  <strong>- Judging by your slides, you have nothing at all on Safari?</strong> <br><br>  Yes, it all works only on Android.  In Safari, this does not work in principle.  If you open the cell phone, it will not work.  We had a problem - the management only has iPhones, they come in and say: ‚ÄúGuys, what are you doing at all ?!‚Äù <br><br>  <strong>- Hence the question.</strong>  <strong>According to your own statistics, this is about 50% of the audience.</strong>  <strong>Did you try to use AppCash as a fallback?</strong> <br><br>  Maxim: No, not tried.  In fact, we did this thing, so that it was not that we could play, but it was interesting.  Therefore, there is no point in cramming something; <br><br>  Alexey: What's the matter?  It all started, as I said, with the notification.  That is, it seems that we already have a Service Worker, and then we looked at the report on Lenta.ru ‚Äî they did tic-tac-toe ‚Äî why not?  But let's not the game, but the news feed.  And it somehow went. <br><br>  That is, we didn‚Äôt have a task - and now we‚Äôll also be hooked offline.  It somehow happened by chance.  Just what the most interesting thing is that actually writing this offline version is not very difficult.  The most difficult to understand how these events are fulfilled.  And just to give something from the cache is not at all difficult. <br><br>  We wrote it down quickly, and then problems began to arise from this, about which I spoke, including with analytics. <br><br>  Maxim: We still have a specific problem - it is monetization.  That is, until we monetize offline, it‚Äôs rather useless to do something for the rest of the audience.  There is no advertising. <br><br>  <strong>- But what about the loyalty of users?</strong> <br><br>  Those who do not know that the site is offline, they do not know.  This is not what the need is, it is a bonus, appendage. <br><br>  Alexey: I would even add that this is more likely for those who, in principle, visit the site, and not just go there from a search engine by accident.  This is a bonus for regular visitors.  I noticed that my wife was stuck and all the way to the subway was stuck with news.  Unfortunately, you need to somehow find out about this.  We didn‚Äôt hang any banners on this issue, we didn‚Äôt tell anyone that we were offline. <br><br>  <strong>- What can be done to make the application run faster during the initial download?</strong>  <strong>I'm trying now - it can hang for about 30 seconds.</strong>  <strong>In principle, cool - there are 10 articles there, it‚Äôs enough to stick in the subway.</strong> <br><br>  Maxim: If you do not have internet, then the browser tries to connect to it.  At this time we can not show anything. <br><br>  Aleksey: That's the funny trick of the Service Worker - inside it, when we process Fetch, this request goes to Promise, and it waits - either to go to resolve, or to reject.  At this moment, hypothetically, maybe, something can be thrown out of it, but hardly.  We either process it or this. <br><br>  That was the problem - this is our sore subject, when, by foolishness in the SPA application itself, we requested data through Fetch offline.  Since there is no Internet, why do you request data via Fetch?  Accordingly, the system tries to obtain this data, but there is no Internet, and so there are delays. <br><br>  <strong>The same story, if I press "Back" - it is a little more annoying.</strong>  <strong>I went to the online version, then the Internet disappeared, I got offline, clicked "Back" - and he thinks for a long time trying to send a request, but it fails.</strong> <br><br>  If the mobile and WI-FI are turned off in the settings, then in principle, then very quickly, then it must catch.  There would be a method to understand that the Internet is not too good to give you the full version - you have to work on it. <br><br>  <strong>- We also recently made an offline version, but we did not make a separate one.</strong>  <strong>There is a very short question - do you really have 50% iOS?</strong> <br><br>  45% iOS. <br><br>  <strong>And about the technology itself - you, if I understood correctly, first try to get data over the network, then submit it from the cache.</strong>  <strong>You can do the opposite and periodically update them.</strong> <br><br>  <strong>And the second question - what do you do with media resources?</strong>  <strong>An article is not just a text, it is also some kind of interactive kit, and what about your traffic, as a result?</strong> <br><br>  Maxim: We specifically look forward to a mobile audience, so we do not load any media resources there at all.  That is, there are no photos.  Therefore, we have the following iteration - loading media there.  We are going to optimize it for the desktop, display images, previews and load media content.  I think we most likely will not get to photo reports and videos, but some small media will be there. <br><br>  Alexey: So it happened, we love users.  I just don't want to push everything into the browser.  Hypothetically, you can really roll up the full article in the cache, no problem.  But why? <br><br>  Maxim: We have an advertising service that shoves banners 2-3 MB each.  If we still do this, it will turn out badly. <br><br>  Alexey: I will add about a cache.  There is still a difference: there is a cache in which the browser caches some page, this is understandable.  He caches it himself and we cannot manage it.  But just the API cache - if we cache until we delete it ourselves, it will roll there.  Therefore, I do not want to. <br><br>  <strong>- Two questions.</strong>  <strong>Firstly, you said that you suddenly had a third offline desktop and you are going to do something about it.</strong>  <strong>But you figured out who these people are?</strong> <br><br>  Maxim: Yes, these are people mostly from the regions.  You can even see - we have a monitor, and the offline version is displayed there in real time, where we look at the regions.  Falling attendance - hop!  - some region has been cut off.  Desktops are mostly from there.  That's life.  We here in Moscow do not know about it.  It turns out people on the desktop have no internet. <br><br>  <strong>- The second question is - you said that you can catch the redirect and at this moment in case of blocking something should be pushed through.</strong>  <strong>It's not very clear.</strong>  <strong>If you are already blocked, how can you tell where to move?</strong> <br><br>  Maxim: This must be done in advance in the Service Worker.  We all know in advance which one of us will be blocked.  What is there to hide?  ‚Äì  ,     ‚Äì - -     ‚Äì ,    .      . <br><br>   ,      ,  ,  ,  !      ! <br><br>        .    ,   ,   ,   Service Worker   ‚Äì    .   import script ,     ‚Äî     ,  CDN.     Service Worker   ,     ,     . <br><br>       ,    : ¬´,   !¬ª   ,   ‚Äì   !       5  ,  Safari . <br><br>          ,    ‚Äì    .   ,       ,     ,      5  ‚Äì  . <br><br> :  Service Worker  JavaScript.    .  Fetch'    .  Service Worker ,   Fetch   .  6     .    ‚Äì !   ,  ,     Service Worker,    . <br></div></div><br><hr><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Come share experiences </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dear friends, for sure you also face interesting challenges and find elegant solutions. </font><font style="vertical-align: inherit;">Do not underestimate them, it seems to you that everything is simple, because you have already done everything, and someone else does not know where to start. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choose the appropriate direction at the </font></font><a href="http://ritfest.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RIT ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conference festival </font><font style="vertical-align: inherit;">and send the application to the program committee. </font><font style="vertical-align: inherit;">For those who doubt their lecturing abilities, we remind you that </font></font><a href="http://speakers.ritfest.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we will help you</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with this </font><font style="vertical-align: inherit;">.</font></font></div><p>Source: <a href="https://habr.com/ru/post/348150/">https://habr.com/ru/post/348150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348136/index.html">The most correct implementation of splash screen</a></li>
<li><a href="../348138/index.html">Isometric depth sorting for moving platforms</a></li>
<li><a href="../348140/index.html">Four ways to fool a deep learning neural network</a></li>
<li><a href="../348142/index.html">The history of hacking a single WordPress plugin - or how you allow vulnerabilities in your projects</a></li>
<li><a href="../348148/index.html">Road to War: AI Total War Series Games</a></li>
<li><a href="../348152/index.html">WebRTC and Electron: Trend for Desktop Applications</a></li>
<li><a href="../348156/index.html">Mathematical model of snobbery</a></li>
<li><a href="../348158/index.html">What habits make me better as a software developer?</a></li>
<li><a href="../348160/index.html">Zimbra vs. Microsoft Office 365</a></li>
<li><a href="../348162/index.html">Anonymous cryptocurrencies: why Edward Snowden supports the concept of proof with zero disclosure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>