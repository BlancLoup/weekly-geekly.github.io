<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to index business application logs in Hadoop (SolrCloud)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 One of our clients was faced with the task of removing logs from most corporate applications and their databases ‚Äúsomewhere‚Äù - it‚Äôs pai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to index business application logs in Hadoop (SolrCloud)</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  One of our clients was faced with the task of removing logs from most corporate applications and their databases ‚Äúsomewhere‚Äù - it‚Äôs painfully a lot of trouble: they grow like leaps and bounds, clean them periodically, and access to some must also be provided during many years, and yes even the analysis I want to carry out a systematic way.  Of course, making logs is not the primary goal, and for the aggregate of requirements, we chose Hadoop, the version from Cloudera (CDH 5). <br><br>  Requirements indicated that the solution, among other things, should provide the ability to search and view a list of events (from logs) according to specified criteria, preferably fast.  Moreover, some applications must also be redone so that log viewing forms start using Hadoop instead of their databases. <br><br>  One solution is to use the SolrCloud search module, which is included with Cloudera's Hadoop.  Cloudera includes out-of-the-box tools for uploading data from application databases and indexing them in bundles (not line by line).  However, this method turned out to be at least working, but more laborious and unpredictable in tuning than, say, if we used Impala to fetch data.  Therefore, I decided to share how we did it, hoping to save time for those who will face a similar task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article describes the details of the settings, as well as features encountered in the process. <br><a name="habracut"></a><br><br><h2>  Scenario </h2><br><ol><li>  We unload data from Oracle to files on HDFS.  The file format is avro.  Tool: <b>sqoop</b> ( <a href="http://sqoop.apache.org/docs/1.4.2/SqoopUserGuide.htm">http://sqoop.apache.org/docs/1.4.2/SqoopUserGuide.htm</a> ). <blockquote>  The avro format has many advantages: it is binary, the data compresses well, with it you will not bathe with carriage translations and with commas in the text fields, as with CSV, and there is a data scheme in the file itself that supports Schema Evolution.  In general, in Hadoop, avro is promoted as a unified format for storing and transferring data between different components; it is supported by many tools and components.  And there is one more plus exactly for our task, about it below. </blockquote></li><li>  Create a ‚Äúcollection‚Äù in SolrCloud.  Tool: <b>solrctl</b> ( <a href="http://www.cloudera.com/content/cloudera-content/cloudera-docs/CDH5/latest/Search/Cloudera-Search-User-Guide/csug_solrctl_ref.html">http://www.cloudera.com/content/cloudera-content/cloudera-docs/CDH5/latest/Search/Cloudera-Search-User-Guide/csug_solrctl_ref.html</a> ) <blockquote>  The collection is a logical index in SolrCloud.  It is associated with a set of configuration files and consists of one or more shards (shard), count folders with index files.  If the number of shards is more than one, this is a distributed index. </blockquote></li><li>  Run the MapReduce driver ( <a href="https://developer.yahoo.com/hadoop/tutorial/module4.html">https://developer.yahoo.com/hadoop/tutorial/module4.html#driver</a> ), which: <br><ul><li>  read all entries from avro-file </li><li>  skip them through an ETL process written as a morphline script;  the result of this process is a shard with new data (index files in Solr format, laid out in the specified HDFS directory) </li><li>  merge the shard laid out to the active SolrCloud collection without transferring it offline, live (go-live), so to speak :) </li></ul><br>  Tool: hadoop command that runs the <b>org.apache.solr.hadoop.MapReduceIndexerTool</b> driver ( <a href="http://www.cloudera.com/content/cloudera-content/cloudera-docs/CDH5/latest/Search/Cloudera-Search-User-Guide/csug_mapreduceindexertool.html">http://www.cloudera.com/content/cloudera-content/cloudera-docs/CDH5/latest/Search/Cloudera-Search-User-Guide /csug_mapreduceindexertool.html</a> ), performing this sequence. <br></li></ol><br>  We start everything from the main NameNode, although it doesn't matter. <br><br>  So, on the steps ... <br><br><h2>  Uploading data from Oracle to avro files </h2><br><pre><code class="bash hljs">sqoop import --connect jdbc:oracle:thin:@oraclehost:1521/SERVICENAME \ --username ausername --password apassword --table ASCHEMA.LOG_TABLE \ --as-avrodatafile --compression-codec snappy \ -m 16 --split-by NUM_BEG \ --map-column-java NUM_BEG=Integer,DTM_BEG=String,KEY_TYPE=String,OLD_VALUE=String,NEW_VALUE=String,NUM_PARENT=Integer,\ NUM_END=Integer,EVENT=String,TRACELEVEL=String,KEY_USER=String,COMPUTER_NAME=String,PRM=String,OPERATION=Integer,\ KEY_ENTITY=String,MODULE_NAME=String \ --target-dir /user/<span class="hljs-variable"><span class="hljs-variable">$USER</span></span>/solrindir/tmlogavro</code> </pre> <br><br>  A little about the parameters: <br><ul><li>  <b>connect</b> - the connection string to the database of one of the applications on Oracle. </li><li>  <b>as-avrodatafile</b> and <b>compression-codec</b> indicate that the data will be uploaded to the avro format file (s) with the specified compression, which on average compresses the data of our structure 10 times. </li><li>  <b>-m</b> determines how many map tasks will unload data from the table.  Multiple tasks run in parallel.  Each task takes its own subset of records from the table and saves it in a separate file.  To define an entire subset, sqoop takes select min (&lt;split-by&gt;), max (&lt;split-by&gt;). </li><li>  <b>from</b> divides the resulting range of numbers into 16 parts (in our example), and now each task will use the resulting subrange of numbers as filters in the SQL query to select the desired subset of table entries.  By default, split-by is taken as the first column in the Pk table. </li><li>  <b>map-column-java</b> - specifying column types in terms of Sqoop.  In principle, Sqoop can digest most Oracle column types, but sometimes you have to prompt it in this parameter. </li><li>  <b>target-dir</b> - directory in HDFS, in which you want to save files. </li></ul><br><br><h2>  Create a collection </h2><br>  Here we use the solrctl utility to manage deployed SolrCloud. <br>  First, on the local disk, we generate the file structure of the future collection, the so-called Collection Instance Directory.  In it, we will do / change the settings of the collection on a local disk and then clone them into the zookeeper configuration service, from which SolrCloud reads the settings necessary for the job: <br><pre> <code class="bash hljs">solrctl instancedir --generate <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/solr_configs_for_tm_log</code> </pre> <br>  Here, the parameter is the path to the local directory being created. <br><br><br>  By default, the files created in the directory are already filled with a demo of the data scheme and search instructions, and we need to remove the excess. <br>  Open the conf / schema.xml file in the created directory.  This is the main collection file that describes the structure of the data being indexed.  Delete the tag with its contents, the tag and all.  Instead, insert the following: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"num_beg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"int"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dtm_beg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"date"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key_type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"old_value"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"new_value"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"num_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"num_end"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"event"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text_general"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tracelevel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key_user"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"computer_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"prm"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"operation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key_entity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_version_"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"long"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- catchall field, containing all other searchable text fields (implemented via copyField further on in this schema --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text_general"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indexed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stored</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiValued</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Field to use to determine and enforce document uniqueness. Unless this field is marked with required="false", it will be a required field --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uniqueKey</span></span></span><span class="hljs-tag">&gt;</span></span>num_beg<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uniqueKey</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">copyField</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"event"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dest</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Note that the _version_ field does not exist in the data source, it is necessary for Solr‚Äôs internal purposes, for example for optimistic locks, for the Partial Update mechanism.  Simply specifying such a field in your schema.xml will be enough: Solr will manage its contents on its own. <br>  There is also no text field.  We specified it along with the copyField instruction for the performance of full-text search via HUE (user interface to Hadoop from Clouder).  If you connect the created collection to HUE (via configuration UI-forms), then in the search interface for this collection the search string value occurs in the text field. <br><br>  Now one squat.  The fact is that in the generated example files, one search engine mechanism is enabled - Elevator.  It allows you to put forward results on certain criteria, such as ads from above in the search results in Yandex.  So in the example, it is set up that the key field in your schema is of type string (you can see examples of advertising phrases in conf \ elevate.xml).  We have an int.  Because of this, our entire indexing process collapsed with a type mismatch error.  Considering that this mechanism is not interesting for our task, we cut it out, namely: open the <code>conf/solrconfig.xml</code> in the created directory, and delete (comment) the tags and their contents <code>&lt;searchComponent name="elevator" ..."&gt;, &lt;requestHandler name="/elevate" ...&gt;</code> . And at the same time we delete the <code>conf\elevate.xml</code> from the created directory so that it does not hang under our feet. <br><br><br>  Then we register (clone) the entire configuration of the future collection in SolrCloud, or rather, in the naming service ZooKeeper, from which all SolrCloud deployed servers read configurations (and receive their updates): <br><pre> <code class="bash hljs">solrctl instancedir --create tm_log_avro <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/solr_configs_for_tm_log</code> </pre> <br>  Here, the parameter is the name of the future collection, and the path to the directory on the local disk containing the configuration files.  We created it above. <br><br><br>  Well, the last step at this stage is to create a collection with a specified number of shards: <br><pre> <code class="bash hljs">solrctl collection --create tm_log_avro -s 1</code> </pre> <br>  This command creates a collection based on the configuration registered in ZooKeeper.  The first parameter is the name of the collection, the second is the number of shards (let's take 1 for simplicity). <br><br><h2>  Starting the collection indexing process </h2><br>  First we configure the ETL indexing process.  Cloudera respects the Kite SDK library, especially its part of Morphline.  In essence, the Morphline component is an interpreter of a scripting language in which you describe (as a hierarchy of sequences of commands), what to do with the incoming data stream (as an array of ‚Äúrecord‚Äù objects), how to transform, and what to give next.  For example, there is a command to read the avro file.  Of course, their teams are connected, in this and chip.  So Clouder wrote the commands to create a Solr-index for all entries of the incoming stream, it will be the last in the script. <br><br>  The essence of the process: <br><ul><li>  an entry object comes in with information about the file </li><li>  a command is launched that reads this file and returns the lines of this file as an array of ‚Äúrecord‚Äù objects </li><li>  data of each row is converted as you like (for example, the value of the field with date-time is converted from UTC to regional time) </li><li>  each line is converted to a Solr document and the entire array is returned from the MapReduce Mapper </li></ul><br><br>  To set up such a process, create a file <code>$HOME/solr_configs_for_tm_log_morphlines/morphlines.conf</code> with the following content: <br><pre> <code class="hljs pgsql"># Specify <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> locations <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a SOLR_LOCATOR variable; used later <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> # variable substitutions: SOLR_LOCATOR : { # <span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> solr collection collection : tm_log_avro # ZooKeeper ensemble zkHost : "hadoop-n1.custis.ru:2181,hadoop-n2.custis.ru:2181,hadoop-n3.custis.ru:2181/solr" } # Specify an <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> one <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more morphlines, <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> which defines an ETL # transformation chain. A morphline consists <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> one <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more potentially # nested commands. A morphline <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> consume records such <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Flume events, # HDFS files <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> blocks, turn them <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> a stream <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> records, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pipe the stream # <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> records through a <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> easily configurable transformations <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> its way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> # Solr. morphlines : [ { # <span class="hljs-type"><span class="hljs-type">Name</span></span> used <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> identify a morphline. <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> example, used <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> there are multiple # morphlines <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a morphline config file. id : morphline1 # <span class="hljs-keyword"><span class="hljs-keyword">Import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> morphline commands <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> these java packages <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> their subpackages. # Other commands that may be present <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the classpath are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> visible <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> this # morphline. importCommands : ["org.kitesdk.**", "org.apache.solr.**"] commands : [ { # Parse Avro container file <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> emit a <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> Avro <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> readAvroContainer { # Optionally, require the <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> match one <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> these MIME <span class="hljs-keyword"><span class="hljs-keyword">types</span></span>: # supportedMimeTypes : [avro/binary] # Optionally, use a custom Avro <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span>: # readerSchemaString : """&lt;json can go here&gt;""" # Optionally, use a custom Avro <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: # readerSchemaFile : /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/syslog.avsc } } { # Consume the output <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the previous command <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pipe another # <span class="hljs-type"><span class="hljs-type">record</span></span> downstream. # # extractAvroPaths <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a command that uses zero <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more Avro <span class="hljs-type"><span class="hljs-type">path</span></span> # excodeblockssions <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> extract <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> an Avro <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> excodeblockssion # consists <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> a <span class="hljs-type"><span class="hljs-type">record</span></span> output field <span class="hljs-type"><span class="hljs-type">name</span></span>, which appears <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the left <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the # colon <span class="hljs-string"><span class="hljs-string">':'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> zero <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more <span class="hljs-type"><span class="hljs-type">path</span></span> steps, which appear <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the right. # <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span> step <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> separated <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> a <span class="hljs-string"><span class="hljs-string">'/'</span></span> slash. Avro arrays are # traversed <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-string"><span class="hljs-string">'[]'</span></span> notation. # # The result <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> a <span class="hljs-type"><span class="hljs-type">path</span></span> excodeblockssion <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> objects, <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> which # <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> added <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the given <span class="hljs-type"><span class="hljs-type">record</span></span> output field. # # The <span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> supports <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> Avro concepts, including nested # structures, records, arrays, maps, unions, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> others, <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> well <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a flatten # <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> that collects the primitives <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a subtree <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> a flat list. <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> the # paths specification, entries <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the left <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the colon are the target Solr # field <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> entries <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the right specify the Avro source paths. Paths are <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the source that <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> named <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the right <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the colon <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> written <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the # field that <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> named <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the left. extractAvroPaths { flatten : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> paths : { computer_name :/COMPUTER_NAME dtm_beg :/DTM_BEG event :/EVENT key_entity :/KEY_ENTITY key_type :/KEY_TYPE key_user :/KEY_USER module_name :/MODULE_NAME new_value :/NEW_VALUE num_beg :/NUM_BEG num_end :/NUM_END num_parent :/NUM_PARENT old_value :/OLD_VALUE operation :/OPERATION prm :/PRM tracelevel :/TRACELEVEL } } } # Consume the output <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the previous command <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pipe another # <span class="hljs-type"><span class="hljs-type">record</span></span> downstream. # # convert <span class="hljs-type"><span class="hljs-type">timestamp</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> native Solr <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> # such <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span>T07:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">34.000</span></span>Z <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> UTC { convertTimestamp { field : dtm_beg inputFormats : ["yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd"] inputTimezone : Europe/Moscow outputFormat : "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" outputTimezone : UTC } } # Consume the output <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the previous command <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pipe another # <span class="hljs-type"><span class="hljs-type">record</span></span> downstream. # # This command deletes <span class="hljs-type"><span class="hljs-type">record</span></span> fields that are <span class="hljs-type"><span class="hljs-type">unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Solr # <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>.xml. # # Recall that Solr throws an <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> attempt <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> a document # that contains a field that <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> specified <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>.xml. { sanitizeUnknownSolrFields { # <span class="hljs-keyword"><span class="hljs-keyword">Location</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> which <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> Solr <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> solrLocator : ${SOLR_LOCATOR} } } # <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> the <span class="hljs-type"><span class="hljs-type">record</span></span> at <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> SLF4J { logDebug { <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> : "output record: {}", args : ["@{}"] } } # <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> the <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> a Solr <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> MapReduce Reducer { loadSolr { solrLocator : ${SOLR_LOCATOR} } } ] } ]</code> </pre><br>  A little about the commands used: <br><ul><li>  <b>readAvroContainer</b> - this is where the avro format comes in handy: the file itself contains all the meta-information about the data structure, which is needed to form a stream of record objects and start it up further by commands.  If we took, for example, CSV, then we would have to once again describe here the name of each field, its type, length, position in the file ... Now this information is automatically generated in the first step when unloading from Oracle via Sqoop. </li><li>  <b>extractAvroPaths</b> - indicates which fields from each incoming record to take and which fields of the outgoing record to put.  We indicate here those field names that our collection in SolrCloud ‚Äúknows‚Äù.  That is what the last command will pass to the indexing. </li><li>  <b>convertTimestamp</b> - <b>calling</b> for each incoming record, converts the string field to the date-time in UTC format. </li><li>  <b>loadSolr</b> - converts a ‚Äúrecord‚Äù object into a Solr document.  An array of these documents will then be transferred to MapReduce Reducer, which will directly deal with their indexing. </li></ul><br><br><h2>  Launch </h2><br>  Now everything is ready for launch.  Run together two commands: <br><ul><li>  <b>org.apache.solr.hadoop.HdfsFindTool</b> is, in fact, an implementation of a part of the find linux command (for some reason this command has not yet been implemented in hdfs, although the bugs have been standing for a long time).  The result of this command (list) is transmitted to the second </li><li>  MapReduce <b>org.apache.solr.hadoop.MapReduceIndexerTool</b> driver with a bunch of parameters </li></ul><br><pre> <code class="bash hljs">sudo -u hdfs hadoop jar /usr/lib/solr/contrib/mr/search-mr-*-job.jar org.apache.solr.hadoop.HdfsFindTool -find \ hdfs://<span class="hljs-variable"><span class="hljs-variable">$NNHOST</span></span>:8020/user/<span class="hljs-variable"><span class="hljs-variable">$USER</span></span>/solrindir/tmlogavro -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f \ -name <span class="hljs-string"><span class="hljs-string">'part-m-000*.avro'</span></span> |\ sudo -u hdfs hadoop --config /etc/hadoop/conf.cloudera.yarn \ jar /usr/lib/solr/contrib/mr/search-mr-*-job.jar org.apache.solr.hadoop.MapReduceIndexerTool \ --libjars /usr/lib/solr/contrib/mr/search-mr-1.0.0-cdh5.0.0.jar \ --log4j <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/solr_configs_for_tm_log_morphlines/log4j.properties \ --morphline-file <span class="hljs-variable"><span class="hljs-variable">$USER</span></span>/solr_configs_for_tm_log_morphlines/morphlines.conf \ --output-dir hdfs://<span class="hljs-variable"><span class="hljs-variable">$NNHOST</span></span>:8020/user/<span class="hljs-variable"><span class="hljs-variable">$USER</span></span>/solroutdir \ --verbose --go-live --zk-host <span class="hljs-variable"><span class="hljs-variable">$ZKHOST</span></span> \ --collection tm_log_avro \ --input-list -;</code> </pre><br>  A little about the parameters of the second command: <br><ul><li>  <b>jar</b> is the path to jar's driver;  Cloudera standard delivery </li><li>  <b>org.apache.solr.hadoop.MapReduceIndexerTool</b> - directly the name of the driver class in the jar </li><li>  <b>libjars</b> - additional link libraries </li><li>  <b>log4j</b> - the path to the log4j configuration file, you can take the standard in / usr / lib / hadoop-yarn / etc / hadoop </li><li>  <b>morphline-file</b> - path to the morphline script file created above </li><li>  <b>output-dir</b> is the name of the directory in hdfs where all indexes will be saved before merge to the SolrCloud server </li><li>  <b>input-list</b> - list of files for indexing.  A dash after the parameter means to take a list from the standard input. </li><li>  The <b>$ ZKHOST</b> variable is configured in hadoop-n1.custis.ru:2181,hadoop-n2.custis.ru:2181,hadoop-n3.custis.ru:2181/solr </li></ul><br><br>  This command will create and launch MapReduce tasks: <br><ul><li>  The Map task takes its file, passes it through the Morphline ETL, converting incoming log entries into Solr document objects, and transfers them to the next task.  There will be as many task instances as there are files. </li><li>  The Reduce task takes the input documents and indexes them into a separate directory on the disk (in the &lt;output-dir&gt; subdirectory).  Copies as much </li><li>  The so-called Reduce-Only task takes all indexes from folders and uploads them (merge) to SolrCloud.  There are as many copies of the task as there are shards in your collection.  In our case - 1 </li></ul><br><br><h2>  Little results </h2><br>  MapReduceIndexerTool, and Solr itself, turned out to be very capricious about the available RAM.  With our structures, each Reduce task, which indexes a file from the list, required that the available memory (Java Heap Size) be approximately 1/2 the size of the uncompressed file, otherwise, OutOfMemoryError.  Therefore, when uploading sqoop to files, control their size through, for example, the parameter m (the number of mappers creating files). <br>  Also, despite the amount of available memory in the Map and Reduce tasks, the success of the last stage directly depends on the amount of available memory in Solr Server and on the size of the already indexed data in the collection.  According to our structures, for example, for a merge of 30 GB for one shard, there was enough 6 GB of Java Heap Size allocated for one Solr instance. <br><br>  There is one more feature - the used mechanism of the index merge does not identify duplicate records.  If there are records in your indexed file that are already in the collection, they will be duplicated.  Therefore, when re-indexing, make sure to get a unique set of records in the files each time.  This can be quite easily arranged using the features of sqoop for incremental data upload (via sqoop job).  Just do not forget to remove the old files from the folder before starting the unloading, and then they will be indexed again. </div><p>Source: <a href="https://habr.com/ru/post/234049/">https://habr.com/ru/post/234049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234031/index.html">Announced new Java 9 features</a></li>
<li><a href="../234033/index.html">New optimizations using undefined behavior in gcc 4.9.0</a></li>
<li><a href="../234041/index.html">Good, bad and evil ... cash</a></li>
<li><a href="../234045/index.html">RAD Studio XE7 Preview Review Events</a></li>
<li><a href="../234047/index.html">Team sets should be free: the reasons for RISC-V</a></li>
<li><a href="../234051/index.html">Interview with the demoscenter - Smash ^ Fairlight</a></li>
<li><a href="../234053/index.html">HTC One M8 with WP 8.1 consumes battery more economically than Android version</a></li>
<li><a href="../234057/index.html">Radio controlled cars as a hobby</a></li>
<li><a href="../234059/index.html">New board for OptimusBoard developers based on the eight-core big.LITTLE SoC AllWinner A80</a></li>
<li><a href="../234061/index.html">How to keep valuable frames: recipes for small companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>