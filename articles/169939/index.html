<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Table bloat? No, have not heard‚Ä¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think many people know the feature of PostgreSQL, which leads to the effect of inflating tables, or table bloat. It is known that it manifests itsel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Table bloat? No, have not heard‚Ä¶</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/418/fa6/575/418fa6575a69d2933067ed2d51cb56c1.png"><br><br>  I think many people know the feature of PostgreSQL, which leads to the effect of inflating tables, or table bloat.  It is known that it manifests itself in cases of intensive updating of data, both with frequent UPDATE and with INSERT / DELETE operations.  As a result of such inflation, performance is reduced.  Consider why this happens and how to deal with it. <br><a name="habracut"></a><br><br>  Tables in PostgreSQL are presented in the form of pages, 8Kb in size, in which records are placed.  When one page is completely filled with records, a new page is added to the table.  When deleting records using DELETE or changing using UPDATE, the place where the old records were can not be reused immediately.  To do this, the autovacuum cleaning process, or the VACUUM command, runs through the modified pages and marks this space as free, after which new entries can be safely recorded in this space.  If autovacuum does not cope, for example, as a result of actively changing more data or simply because of poor settings, then new pages will be unnecessarily added to the table as new entries become available.  And even after the cleanup reaches our deleted posts, the new pages will remain.  It turns out that the table becomes more sparse in terms of the density of records.  This is called the spreading table effect, table bloat. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The cleaning procedure, autovacuum or VACUUM, can reduce the size of the table by removing completely empty pages, but only if they are at the very end of the table.  In order to minimize the table in PostgreSQL, there is VACUUM FULL or CLUSTER, but both of these methods involve the installation of heavy and long locks on the table, which is not always the right solution. <br><br>  Consider one of the solutions.  When updating a record using UPDATE, if there is free space in the table, then the new version will go to the free space without selecting new pages.  Preference is given to free space closer to the top of the table.  If you update the table using the so-called.  fake updates, type some_column = some_column from the last page, at some point, all records from the last page will go to the free space in the previous pages of the table.  Thus, after several such operations, the last pages will be empty and the usual non-blocking VACUUM will be able to cut them off from the table, thereby reducing the size. <br><br>  As a result, with the help of such a technique it is possible to compress the table as much as possible, without causing any critical locks, and therefore without interfering with other sessions and with normal database operation. <br>  And now the most important)))) To automate this procedure, there is a utility pgcompactor. <br><br>  Its main characteristics are: <br><ul><li>  does not require any dependencies except Perl&gt; = 5.8.8, i.e.  you can simply copy pgcompactor to the server and work with it; </li><li>  works through DBD :: Pg, DBD :: PgPP adapters or even through the standard utility psql, if the first two are not on the server; </li><li>  processing both individual tables and all tables within a schema, database or the entire cluster; </li><li>  the ability to exclude databases, charts or tables from processing; </li><li>  analysis of the effect of inflating and processing only those tables in which it is present; for more accurate calculations, it is recommended to install the pgstattuple extension; </li><li>  analysis and rebuilding of indices with the effect of inflation; </li><li>  analysis and rebuilding of unique constraints (unique constraints) and primary keys (primary keys) with the effect of inflating; </li><li>  incremental usage i.e.  you can stop the compression process without harming anything; </li><li>  Dynamic adjustment to the current database load, so as not to affect the performance of user queries (with adjustable at startup); </li><li>  recommendations to administrators, accompanied by ready-made DDL, for rebuilding database objects that cannot be rebuilt automatically. </li></ul><br><br>  A couple of examples of use: <br>  running on the entire cluster with mandatory rebuilding of indices: <br>  # pgcompactor --all --reindex <br><br>  run on a separate table (with rebuilding indexes): <br>  # pgcompactor --reindex --dbname geodata --table cities --verbose info&gt; pgcompactor.log 2&gt; &amp; 1 <br><br>  Result of work: <br>  Table size decreased from 9.2GB to 5.6GB.  The cumulative size of all indices dropped from 7.5GB to 2.8GB <br><img src="https://habrastorage.org/storage2/648/744/476/648744476fc9dd736f43f0ab974e30cb.png"><br><br>  Project URL: <a href="https://github.com/PostgreSQL-Consulting/pgcompacttable">github.com/PostgreSQL-Consulting/pgcompacttable</a> <br><br>  Many thanks to the authors of the utility for their work!  This is a really useful tool. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/169939/">https://habr.com/ru/post/169939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169927/index.html">Parallels declassified Cloud Server</a></li>
<li><a href="../169929/index.html">How to connect to MySQL using ADO.NET</a></li>
<li><a href="../169933/index.html">MoneyQuest: How to cash a check from Google</a></li>
<li><a href="../169935/index.html">Database of lost items with the search by name</a></li>
<li><a href="../169937/index.html">Print me ... a face. 3d printer for Fantomas</a></li>
<li><a href="../169943/index.html">3Doodler pen can draw three-dimensional objects right in the air</a></li>
<li><a href="../169945/index.html">How we buy technology</a></li>
<li><a href="../169949/index.html">Interview for junior position. Antipertenants interviewing</a></li>
<li><a href="../169953/index.html">How to secure yourself on Facebook</a></li>
<li><a href="../169957/index.html">Who writes WebKit?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>