<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OAuth authorization using the example of Desktop Twitter client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It took me here to write a cross-platform Twitter client with closed source code, do not ask why I need it, I have this job, I get money for it. Which...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OAuth authorization using the example of Desktop Twitter client</h1><div class="post__text post__text-html js-mediator-article">  It took me here to write a cross-platform Twitter client with closed source code, do not ask why I need it, I have this job, I get money for it.  Which is logical, C ++ was chosen as the development language using Qt. <br>  API Twitter'a itself is simple as a tarpaulin boot.  But!  There is such an important thing as authorization, and there are two ways, the old one is authentication via HTTP Headers and a new one is using OAuth protocol.  The old method is simple, just like the API itself, but, unfortunately, it is not safe, and most importantly, the Twitter team warns that it will abandon it at the end of June of this year.  Therefore, the second OAuth method remains.  I must say that this protocol is used not only in Twitter, but since I wrote Twitter-client, and we will consider the example of Twitter'a. <br><a name="habracut"></a><br><h1>  Theory </h1><br>  So, having studied the Twitter API and the OAuth protocol description, I learned the following. To authorize a Desktop application, you need to register your future application on Twitter, this can be done on this page: <a href="http://twitter.com/oauth_clients">twitter.com/oauth_clients</a> , you will be given two keys: oauth_consumer_key and oauth_consumer_secret.  These keys should be remembered and subsequently inserted into your application as constants, since they are inseparably linked with it. <br><br>  Now consider the authorization process in steps: <br><ol><li>  Using a GET request to <a href="http://api.twitter.com/oauth/request_token">api.twitter.com/oauth/request_token,</a> we need to get the initial value of the oauth_token and oauth_secret keys </li><li>  Using a GET request, we need to open the following page in the user's browser: <a href="http://api.twitter.com/oauth/authorize">api.twitter.com/oauth/authorize</a> </li><li>  On this page, the user will be asked for his username and password if he is not authorized on the site and will be asked if he really wants to allow this application to access Twitter on behalf of his account. </li><li>  After the user's consent, he will be shown a PIN code </li><li>  In the meantime, our application should offer the user a dialog for entering a PIN code. </li><li>  After the user copies the PIN from the browser and inserts it into our application, it must execute a certain POST request to the address <a href="http://api.twitter.com/oauth/access_token">api.twitter.com/oauth/access_token</a> , this is necessary to obtain the real oauth_token and oauth_secret keys that will be used later to identify the user in the system. </li></ol><br>  Now more about requests, I recall three of them: request_token, autorize and access_token <br><br><h2>  request_token </h2><br>  This request should contain the following field in the HTTP header: <br><blockquote>  Authorization: OAuth realm = "http% 3A% 2F% 2Fapi.twitter.com% 2F", <br>  oauth_consumer_key = "0685bd9184jfhq22", <br>  oauth_signature_method = "HMAC-SHA1", <br>  oauth_timestamp = "137131200", <br>  oauth_nonce = "4572616e48616d6d65724c61686176", <br>  oauth_version = "1.0", <br>  oauth_signature = "wOJIO9A2W5mFwDgiDvZbTSMK% 2FPY% 3D" <br></blockquote><br>  <b>realm</b> - the host to which the request is sent; <br>  <b>oauth_consumer_key</b> - the same key that we were given during registration; <br>  <b>oauth_signature_method</b> is a signature encryption method, there are three of them for this protocol: PLAINTEXT, HMAC-SHA1, RSA-SHA1, but it was found out experimentally that Twitter does not support PLAINTEXT; <br>  <b>oauth_timestamp</b> - the current timestamp on your machine; <br>  <b>oauth_nonce</b> - randomly generated string for each request, a kind of salt; <br>  <b>oauth_version</b> - protocol version, always 1.0; <br>  <b>oauth_signature</b> - oh!  This parameter is the most intricate, it is formed as follows: <br>  We need to run HMAC-SHA1 (or RSA-SHA1) with a key that is formed like this: <i>urlencode ("&lt;oauth_consumer_secret&gt; &amp; &lt;oauth_token_secret&gt;")</i> - (at this stage, oauth_token_secret has not yet been received, so it will be empty) and the base line, which is composed as follows: <i>"&lt;request method&gt; &amp; &lt;urlencode (request address)&gt; &amp; &lt;urlencode (key_sort (request parameters))&gt;"</i> so that I can give an example more clearly: <br><blockquote>  GET &amp; http3A% 2F2Fapi.twitter.com% 2Frequest_token &amp; oauth_consumer_key% 3Ddpf43f3p2l4k3l03% 26oauth_nonce% 3Dkllo9940pd9333jh% 26oauth_signature_method% 3DHMAC-SHA4A aracrynl aus a%%% a% _% a%%%%%%% %ver%% %verververver%%%%%%%%%%%%%%%%%%% %nnnllllllllllllllllllllllllllllll a <br></blockquote><br>  and an example key: <br><blockquote>  kd94hf93k423kf44% 26 <br></blockquote><br>  After that, the resulting value should be processed by the base64 algorithm. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Response of</b> this request, if everything went well, will contain a line of the form: <br><blockquote>  oauth_token = nnch734d00sl2jdk &amp; oauth_token_secret = pfkkdhi9sl3r4s00 <br></blockquote><br>  These parameters should be parsed and memorized. <br><br><h2>  autorize </h2><br>  The easiest step, you need to open the following request in your browser: <br><blockquote>  <a href="http://api.twitter.com/oauth/authorize%3Foauth_token%3Dnnch734d00sl2jdk">api.twitter.com/oauth/authorize?oauth_token=nnch734d00sl2jdk</a> <br></blockquote><br>  The result of the user's actions in the browser will be the PIN code displayed to him. <br>  Your application must request this PIN and remember it; you will need it in the next step. <br><br><h2>  access_token </h2><br>  The final authorization step, now we need to get the real keys oauth_token and oauth_token_secret. <br>  To do this, you must perform a POST request to the address: <a href="http://api.twitter.com/oauth/access_token">api.twitter.com/oauth/access_token</a> . <br>  POST parameters should contain the following: <br><blockquote>  oauth_consumer_key = dpf43f3p2l4k3l03 <br>  oauth_token = hh5s93j4hdidpola <br>  oauth_signature_method = HMAC-SHA1 <br>  oauth_timestamp = 1191242092 &amp; <br>  oauth_version = 1.0 <br>  oauth_nonce = dji430splmx33448 <br>  oauth_verifier = 213423534 <br>  oauth_signature = kd94hf93k423kf44% 26hdhd0244k9j7ao03 <br></blockquote><br>  <b>oauth_verifier</b> is the PIN we received. <br>  The signature is generated in the same way as in the first step. <br>  The answer to this query will be the same string with parameters as in the first step, but these parameters need to be remembered forever (unless, of course, you want the user to go through the whole procedure each time the program is started). <br><br><h1>  Practice </h1><br>  Practice has shown that there is no sane implementation of HMAC-SHA1 in C ++ under the LGPL, and this is sad, I tried to do something with this implementation: <a href="http://bit.ly/96RlAL">bit.ly/96RlAL</a> - I did not succeed.  There is an option to write my own using OpenSSL, unfortunately I did not have time for that.  However, during intensive googling I found a library called <a href="http://qt-apps.org/content/show.php/QOAuth%3Fcontent%3D107420">QOAuth</a> <br><br><h1>  QOAuth </h1><br>  With luck, I didn‚Äôt have a side chapel :), however, even with her everything was not so simple. <br>  The library itself is included in the project, it is very easy and simple to compile (by the way I did not manage to make it work as a separate * .so / *. Dll file, but this was already due to the lack of time and curvature of my hands), but this library has dependencies, and namely <a href="http://api.kde.org/kdesupport-api/kdesupport-apidocs/qca/html/">QCA - Qt Cryptographic Architecture</a> and its QCA OpenSSL plugin. <br><br><h1>  QCA and QCA ossl plugin </h1><br>  The assembly of the QCA itself is trivial, all steps are described in the README, however, the ossl-plugin refused to take off after taking off with this message: <br><blockquote>  qca-ossl.cpp: In function 'X509_EXTENSION * <br>  opensslQCAPlugin :: new_subject_key_id (X509 *) ': <br>  qca-ossl.cpp: 330: warning: deprecated conversion from string constant to <br>  'char *' <br>  qca-ossl.cpp: In member function 'virtual QCA :: Provider :: Context * <br>  opensslProvider :: createContext (const QString &amp;) ': <br>  qca-ossl.cpp: 6815: error: 'EVP_whirlpool' <br>  *** Error code 1 <br></blockquote><br>  And then I felt that this was the end: (however, the <a href="https://habrahabr.ru/users/tass/" class="user_link">tass</a> habrouser came to the rescue and helped to google the solution: <a href="http://www.mail-archive.com/kde-freebsd%40kde.org/msg03672.html">www.mail-archive.com/kde-freebsd@kde.org/msg03672.html</a> - here it is a patch that resolves the error (note patch for KDE under FreeBSD :)).  Well, the simplest thing remains, to put everything together and write the request code, the code was taken from QOAuth examples and modified, because the examples are outdated, unlike the library itself, and become ‚Äúnoncompilable‚Äù, therefore I attach examples of working request_token and access_token <br><br><h2>  request_token </h2><br><blockquote><ol><li>  QOAuth :: Interface * qoauth = <font color="#0000ff">new</font> QOAuth :: Interface ( <font color="#0000ff">this</font> ); </li><li>  qoauth-&gt; setConsumerKey (consumerKey.toAscii ()); </li><li>  qoauth-&gt; setConsumerSecret (consumerSecret.toAscii ()); </li><li>  qoauth-&gt; setRequestTimeout (10000); </li><li></li><li>  QOAuth :: ParamMap reply = qoauth-&gt; requestToken (oAuthRequestTokenUrl, QOAuth :: GET, QOAuth :: HMAC_SHA1); </li><li>  <font color="#0000ff">if</font> (qoauth-&gt; error () == QOAuth :: NoError) </li><li>  { </li><li>  token = reply.  <font color="#0000ff">value</font> (QOAuth :: tokenParameterName ()); </li><li>  tokenSecret = reply.  <font color="#0000ff">value</font> (QOAuth :: tokenSecretParameterName ()); </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br><h2>  acess_token </h2><br><blockquote><ol><li>  QOAuth :: ParamMap otherArgs; </li><li>  otherArgs.insert (QByteArray ( <font color="#A31515">"oauth_verifier"</font> ), pin.toAscii ()); </li><li></li><li>  QOAuth :: ParamMap reply = qoauth-&gt; accessToken (oAuthAccessTokenUrl, QOAuth :: POST, token, tokenSecret, QOAuth :: HMAC_SHA1, otherArgs); </li><li></li><li>  <font color="#0000ff">if</font> (qoauth-&gt; error () == QOAuth :: NoError) { </li><li>  token = reply.  <font color="#0000ff">value</font> (QOAuth :: tokenParameterName ()); </li><li>  tokenSecret = reply.  <font color="#0000ff">value</font> (QOAuth :: tokenSecretParameterName ()); </li><li>  QString userName = reply.  <font color="#0000ff">value</font> ( <font color="#A31515">"screen_name"</font> ); </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br><h1>  useful links </h1><br>  <a href="http://apiwiki.twitter.com/Twitter-API-Documentation">Twitter API</a> <br>  <a href="http://oauth.net/core/1.0/">OAuth protocol</a> <br><br><h1>  Conclusion </h1><br>  I, as in all my other articles, do not pretend to complete the solution, and do not offer a step-by-step guide, I only describe the basic sequence of actions necessary to solve the problem and the pitfalls that I faced myself.  I will also be grateful if someone prompts a working cross-platform LGPL implementation of HMAC-SHA1. </div><p>Source: <a href="https://habr.com/ru/post/86846/">https://habr.com/ru/post/86846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../86835/index.html">Samsung Electronics Introduces Complete 3D Home Solution</a></li>
<li><a href="../86838/index.html">10 years of Nupedia, the free encyclopedia</a></li>
<li><a href="../86841/index.html">1024-bit RSA encryption cracked</a></li>
<li><a href="../86844/index.html">Vuurmuur - fighting cats guard your network</a></li>
<li><a href="../86845/index.html">"Beeline" introduces a fee for "silent" subscribers - 5 rubles per day</a></li>
<li><a href="../86847/index.html">Data conversion, or deepening in Talent Open Studio</a></li>
<li><a href="../86848/index.html">Ribbon Development (‚ÄúWhy the Interface, Part 1)</a></li>
<li><a href="../86850/index.html">Soyuz Telecom plans in early April to begin providing WiMAX in seven locations in various regions and territories of Russia</a></li>
<li><a href="../86852/index.html">Parable about interception of errors</a></li>
<li><a href="../86857/index.html">Place a layer with traffic jams on our J.Map map</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>