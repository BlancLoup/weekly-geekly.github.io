<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cards, Troika, payments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had the opportunity, but my experience suggests that if there is an opportunity, it is better to use it, since it is there. 
 Lock, Stock and Two Sm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cards, Troika, payments</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  I had the opportunity, but my experience suggests that if there is an opportunity, it is better to use it, since it is there. <br>  Lock, Stock and Two Smoking Barrels </blockquote><br><br>  About Habr already knows <a href="http://habrahabr.ru/company/megafon/blog/231235/">about</a> how we created a network of payment terminals - <a href="http://habrahabr.ru/company/megafon/blog/231235/">we wrote about it last summer</a> .  Today we decided to tell what is inside the terminals, near the terminals and around them.  And there is no intrigue inside, there is a computer and peripherals inside each MegaFon payment terminal.  But when at one point, quite a lot of factors converge, which must be linked into a workable system, tricky action films occur, worthy of the attention of Guy Ritchie. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      About the characteristics of the built-in terminal computer has also been written.  Recall that this is a fairly productive system running Windows Embedded Standard 7 <br><br>  ‚Ä¢ Processor: Intel Original LGA-1155 Pentium G2130 (3 GHz) <br>  ‚Ä¢ Motherboard: Asus P8B75-M Soc-1155 iB75 DDR3 mATX AC`97 8ch GbLAN SATA3 VGA + DVI + HDMI <br>  ‚Ä¢ RAM: DDR3 2048Mb 1333MHz Crucial (ST25664BA1339) <br>  ‚Ä¢ Video card: Palit PCI-E NV GF210 512Mb 32bit (TC) DDR3 625/589 <br><br>  <a href="http://habrahabr.ru/company/megafon/blog/231235/">In the past topic,</a> habrayusers offered to make a bitcoin mining farm on them, but we did not try. <br><br>  The computer is packed in a specially designed floor case with two monitors: <br><br><img src="https://habrastorage.org/files/c6d/d74/534/c6dd7453440e47da85c837a2c4c7dcf8.jpg" width="600"><br><br>  The case is strong, vandal-resistant, but not intended for outdoor use.  It was not intended for all the street tests and works only indoors.  Two monitors are needed solely for marketing purposes: firstly, to distinguish them from other terminals, and secondly, advertising is played on an additional large screen, which, again, attracts attention, and, of course, generates income from scrollable commercials. <br><br>  When designing the software and hardware of the terminals, we laid out that they will be updated ‚Äúon-the-air‚Äù - on the fly, without specialists leaving the site, from the ‚Äúcenter‚Äù.  Moreover, now not only the operating system itself is updated, but also the firmware of the devices of the complex - bill acceptors, for example.  Entering a new function, monitoring system, financial statements - any changes are made simultaneously to the entire network.  And security against fraud is also increasing. <br><br><h1>  Scene: "Lobby" </h1><br>  The theater begins with a hanger, a movie with a scream "Motor!", And payment terminals begin with a bill acceptor. <br><br>  Our system is equipped with a CashCode validator (we will not call the exact model) a fairly well-known Canadian company Crane Payment Innovation (CPI) on the market.  It is alleged that CPI in the Russian market occupies a leading place and more than 200 thousand devices have already been sold. <br><br>  Proper recognition of bills is very important, one might say, the key function of the payment terminal.  Despite the fact that bank cards are getting more and more prevalent, Russians still prefer to use cash.  <a href="http://www.cbr.ru/statistics/%3FPrtId%3Dsndmvo">The Central Bank of the Russian Federation regularly publishes statistics on cash turnover</a> , and, as can be seen from the graph, the amount of money, at least, does not decrease: <br><br><img src="https://habrastorage.org/files/ec9/593/6f8/ec95936f860f4398af5ecef9f0e81ea6.jpg" width="600"><br><br>  Some may be interested in the principle of the bill acceptor - how does the machine distinguish real money from paper?  We answer: quite simply - with sensors.  But, of course, the equipment is not engaged in pattern recognition, in order to read the denomination of each individual bill - everything is much simpler.  Bills of different denominations differ, firstly, in size and weight, secondly, by special marks visible in infrared or ultraviolet light, and, thirdly, there are magnetic marks on the notes.  The process and rejection algorithms of bills are quite interesting (for example, <a href="http://www.cbr.ru/Bank-notes_coins/%3FPrtid%3Dbanknotes_itm%26selBanknote%3D100r_14%26type%3Dtype4">you can read</a> about machine-readable signs of various bills <a href="http://www.cbr.ru/Bank-notes_coins/%3FPrtid%3Dbanknotes_itm%26selBanknote%3D100r_14%26type%3Dtype4">on the website of the Central Bank of the Russian Federation</a> ) or <a href="http://www.cbr.ru/Bank-notes_coins/%3FPrtId%3Dvideo">even see</a> , but this is not the purpose of our story - we can only say that the validators used in our terminals recognize almost all counterfeit bills. .  But between fraudsters and "coin houses" there is an old, never ending war, like a shield and a sword and with varying success.  We are not far behind the new products, and our devices promptly receive new data for their recognition, although fraudsters use rather sophisticated fake methods.  For example, for some time there was such a way to turn one five-thousandth note into two: <br><br><img src="https://habrastorage.org/files/f7d/a9d/9e0/f7da9d9e07244622bd8b4aee009b7d08.jpg" width="600"><br><br>  We believe that the reliability of bill acceptors used in terminals is sufficient for industrial operation. <br><br>  Here is the scheme of the bill validator, taken from the site of the device supplier: <br><br><img src="https://habrastorage.org/files/b95/184/56d/b9518456d5644b5396adb4f38c875fdd.png" width="600"><br><br>  The cash-in complex, it should be noted, includes not only the bill validator, but also the very necessary and useful devices attached to it, the stekker (sorter and banknote), and, of course, a special safe where the accumulated money is stored. <br><br>  But it would be naive to assume that the villains will be limited to counterfeit bills - there are many more ways to deceive automatic receivers of money, which are not accepted to be distributed in the media.  For example, the so-called ‚Äúfishing‚Äù (abroad is also called fishing) is a fraudulent way to deceive the automation of the cash receiver, the essence of which is to pull the read bill back behind the leash line previously attached.  The process of fraud is very similar to fishing.  Here is the bill, prepared for the "fishing" and not the last operation: <br><br><img src="https://habrastorage.org/files/d81/4a3/c8e/d814a3c8e1114a1db568a548fcb01eda.jpg" width="600"><br><br>  And struggling with it in a similar way - cutting.  Moreover, there are several options for fighting - rough ‚Äúiron‚Äù, when special combs with sharp edges are inserted on the way of pulling the bill, which mechanically cuts unauthorized modifications of treasury tickets.  The manufacturer does not provide such improvements. <br><br>  Another way is more civilized: an attempt to pull out a bill after reading it is fixed by a special sensor, and the automation gives a strong impulse to the motor of the rollers - all kinds of ‚Äúleashes‚Äù just breaks off, while the bill is not taken into account in the amount of credited funds.  In addition, the actual bill also fits into the reader in a special way, excluding its withdrawal - note that the validator is pulled down.  The bill is first pulled forward, and then at a sharp angle - down.  Pull back it will be difficult. <br><br><h1>  Scene "Bar" </h1><br>  Guy Ritchie's heroes not only steal (not in the most productive way, in fact), but also cheat on taxes.  MegaFon terminals are very law-abiding in this respect - a fiscal receipt is issued to the user for each operation.  Checks are printed on a special thermal printer, and all transactions are recorded on the fiscal registrar.  Printer brand: VKP-80II, and the fiscal registrar - PayVKP-80K. <br><br>  In fact, this is a fairly simple device, which, however, can be talked about for quite some time: <br><br><img src="https://habrastorage.org/files/6a6/533/dfb/6a6533dfb41c42e19121e098d017d51a.jpg" width="600"><br><br>  But the device is quite famous and common.  More interesting is the rule of working with fiscal checks accepted in our company.  MegaFon reports on each transaction, each payment, and all transactions are recorded in EKLZ (stands for Electronic Control Tape Secure) - a special black box registered with the FTS, which is installed in each terminal and registers all transactions without being able to change them, provides a reliable mechanism for reporting. <br><br>  First, a check is an official document with which you can report, for example, in the accounting department.  Therefore, in case a ribbon runs out in a specific terminal, it stops accepting payments. <br><br>  Secondly, in the event of a failure or error (have you ever made a mistake when entering a phone number?), The check serves as a document that will be reconciled and all problems are resolved - the check is the primary document.  Therefore, each check contains a unique number for each transaction, by which it will be possible to resolve misunderstandings that may occur. <br><br>  Thirdly, on the check there are contact phone numbers of technical support, where the user will be helped with the resolution of payment problems. <br><br>  And fourthly, we ensure the implementation of all laws of the Russian Federation related to the receipt of cash.  Today, there are still payment terminals that do not provide fiscal checks, which is a violation of <a href="http://base.garant.ru/12130951/">federal law of May 22,</a> 2003 N 54- ‚ÄúOn the use of cash registers in cash payments and (or) payments using payment cards‚Äù.  We honor the laws and fulfill all their requirements. <br><br>  Of course, the terminal device is not limited to a printer and a bill acceptor.  The terminal still contains an autonomous power source, which, according to regulations, supports device operation for at least four hours.  There is a communication module in addition to the standard Ethernet - GSM / GPRS-modem, there is a small keyboard for entering digital data (pin-pad). <br><br>  But we are coming to a close. <br><br><h1>  Scene: Shooting </h1><br><br><blockquote>  Edd has been playing cards since he was able to raise a deck.  He soon discovered that he had a huge advantage.  The point is not that he is a good player and not what he thinks well when playing, the fact is that he perfectly follows people's reactions, no matter how they hid them, but everyone has reactions, especially when it comes to money . <br>  Lock, Stock and Two Smoking Barrels </blockquote><br><br>  Payment system terminals a lot.  They are different and from different operators.  The difference between the MegaFon network of terminals is that in addition to simple payments using cash in favor of the telecom operator (by the way, we accept payments for other operators and no commission), or payment for other services, our terminals are able to work with public transit cards. transport.  You can replenish the balance of the transport card "Troika" for travel in public transport in Moscow and the Moscow region. <br><br>  For the replenishment of the Troika card there are two options that can be called ‚Äúdirect‚Äù and ‚Äúremote‚Äù replenishment.  Both options are available at MegaFon terminals. <br><br><h2>  Direct replenishment </h2><br>  It is very simple to replenish ‚Äúdirectly‚Äù the ‚ÄúTroika‚Äù: 1. or enter the card number in the terminal, 2. or bring the card to the reader of the terminal, deposit money and, voila!  - You can go about their business. <br><br>  Just in words, but difficult inside: to interact with transport cards using NFC technology ( <a href="https://en.wikipedia.org/wiki/Near_field_communication">Near field communication</a> ). <br><br>  The principle of operation of contactless RFID cards, which are the Troika cards, is as follows: <br><br><img src="https://habrastorage.org/files/cab/ece/450/cabece4509b74369bba5014cd195ee90.jpg" width="600"><br><br>  "Reader" creates an alternating magnetic field of a given frequency.  The contour of the card brought to the reader, tuned to resonance, creates an emf and a current appears in the circuit.  This current is rectified by the diode and accumulated by the capacitor C2.  The energy stored on capacitor C2 is used to power the chip, which contains a microprocessor and memory. <br><br>  Energy, I must say, is enough to light up a simple LED: <br><br><img src="https://habrastorage.org/files/d68/77d/b92/d6877db9293c4e5e900ab5463edf5fea.jpg" width="600"><br><br>  The oscillatory circuit consisting of the capacitor capacitance C1 and the antenna inductance is controlled by a field-effect transistor, to the gate of which the chip transmits control pulses.  But unlike the reader, the card does not have enough power to create a reciprocal electromotive force that the reader could catch.  Therefore, the field-effect transistor simply ‚Äúslows down‚Äù the oscillating circuit, and the reader receives information as a result of increasing losses in its own active oscillating circuit. <br><br>  The subtlety of working with such cards is that the chip card's memory is very limited - the Mifare Classic (or Mifare Plus) cards used are only 7 bytes for the unchanged unique card code and another 1 or 4 KB (depending on the card type) user and map configuration data.  For protection, the crypto <a href="http://en.wikipedia.org/wiki/Crypto-1">-1</a> proprietary encryption algorithm is used, which turned out to be too simple and poorly protected against falsification.  Experiments on the security of the Troika cards <a href="http://habrahabr.ru/post/175557/">have already been described by</a> Habrazhiteli. <br><br>  The protection of the entire system was eventually carried out at several levels, and above all, in organizational measures and with the help of permanent monitoring of card use. <br><br>  Therefore, the replenishment of Troika through the MegaFon payment terminal takes place according to a special algorithm that takes into account the security requirements. <br><br>  So, the card contains a unique crypto-identifier and a memory bank, which may contain the number of tickets and / or a sum of money.  The map stores only numerical indicators, and the information itself is contained on the servers of the transport system.  Therefore, the replenishment of the card occurs only online, and, while from the terminal you can only replenish the balance.  For tickets you will still have to contact the Moscow Metro ticket offices.  But we are working together with the Metropolitan to expand the capabilities of the service. <br><br>  To replenish the balance of "Troika", the user puts the card to the NFC reader and the terminal receives the card indicators. <br><br><img src="https://habrastorage.org/files/233/e29/fd4/233e29fd41274e9aa9cf900e54fcb057.png" width="400"><br><br>  Next, the authorization of the actual terminal on the transport system server, and authentication of a specific card occurs.  The response comes the following information: <br><br>  Amount of funds on the card <br>  Number of trips <br>  Write permission for a specific card <br>  The maximum amount to write. <br><br>  The first two points are clear and simple, but the third and fourth need to be explained.  "Write permission" is associated with the fight against fraud.  If a particular card is simply suspected of fraud, it is immediately blocked.  Now it is impossible to record any information on it - the system blocks.  The user is printed a special receipt (remember about the printer?), With which you need to contact the Metro cash desks for the relevant details.  There are a lot of reasons for blocking, for example, cloning, which is calculated by an attempt to re-use the card faster than the system has installed, or if the user is too fast, according to the system, moves around the city, some of them were discussed in the article that we <a href="http://habrahabr.ru/post/175557/">cited earlier</a> .  Enough "unusual behavior" and the system can put your card on the "black list". <br><br>  The maximum amount of the record is the limit for card replenishment.  Currently, it is set at 3000 rubles for all cards - the system will not allow a large amount to be recorded. <br><br>  After all information about a specific card has been received by the terminal, the following happens: <br><br>  The interface shows the amount that can be accepted on the card (not exceeding the limit). <br>  User enters recharge amount. <br>  The amount to be credited, plus the agreed amount already on the card is sent to the Metro server. <br>  The Troika system responds to the terminal with the approval of the transaction and sends the bitmap that needs to be written to the memory of the card. <br>  In case of an error (for example, the card was removed before the bitmap recording process was completed) - the terminal displays an error check.  Unfortunately, you can correct the error only in the <a href="http://mosmetro.ru/payment/agency/">passenger agency</a> e. <br><br><h2>  Remote replenishment </h2><br><br>  The card "Troika" can be replenished and remotely.  No, this does not mean that you will not need to contact the terminal at all - to be able to work offline when calculating in public transport, where there is no permanent connection with the Metropolitan transport system, you need to write the ‚Äúe-ticket‚Äù bitmap to the memory card.  And this can only be done by physically lifting the card to the reader.  But the money on the card account can be transferred using modern telecommunications means - using <a href="http://troika.mos.ru/about/sms/">SMS</a> or using popular payment systems. <br><br>  The principle of ‚Äúremote replenishment‚Äù is the following: we transfer money to the Troika virtual account in the Metropolitan system, and then write the refill to the card later, when visiting the Metro or in MegaFon saloon on the way to the bus stop. <br><br>  You can recharge the card via the web interface on <a href="http://troika.mos.ru/about/pay/">the Troika website</a> . <br><br>  And in order to replenish the "Troika" from the personal account of a cellular subscriber, you need to send an SMS to the number 3116 with the text: <br><br>  troika &lt;card number&gt; &lt;top up amount&gt; <br><br>  This process looks like on your phone: <br><br>  1. We send the card number and the amount of "troika ..." <br><br><img src="https://habrastorage.org/files/9af/e13/ed1/9afe13ed17674792b304aa446370897c.jpg" width="400"><br><br>  2. In response, an SMS comes with a variable code, which must be confirmed in the response message.  This is done to protect your money from accidental cancellation: <br><br><img src="https://habrastorage.org/files/94e/f81/b93/94ef81b931794dd0b4ec1d6763f8d046.png" width="400"><br><br>  3. After a short time, an SMS arrives with the message that the payment has been formed: <br><br><img src="https://habrastorage.org/files/6ed/af8/cd8/6edaf8cd82bc4caab651dcfac35507c4.png" width="400"><br><br>  The money will be debited from the personal account of the MegaFon subscriber and will be credited to the Troika system without a fee. <br><br>  4. The final stage - we approach the MegaFon terminal or the Metropolitan Information Terminal, and write the generated bitmap to the card.  No additional information is required - the system already knows the unique card number and the amount to be credited. <br><br>  Our terminal: <br><br><img src="https://habrastorage.org/files/b90/b65/e42/b90b65e42e5f4cbc994d4dcb40f82b72.png" width="400"><br><br>  Moscow Metro: <br><br><img src="https://habrastorage.org/files/9ba/0d2/d27/9ba0d2d27bd348b1bc5aadd56277b9d6.png" width="400"><br><br>  While the terminal remains the most usual way of replenishment, which can be used without going down the subway, for example, on the way to a bus or tram stop, which makes using the Troika much more accessible. <br><br>  By the way, our terminals are installed in almost every MegaFon store.  You can find the nearest salon <a href="http://moscow.megafon.ru/help/offices/">on the map</a> or by requesting a list using the USSD command * 123 # <br><br><img src="https://habrastorage.org/files/61a/c25/582/61ac25582030499a9b43cf76965d9a57.png" width="400"><br><br><h1>  Final Scene "Apartment after disassembly" </h1><br>  Not all peripheral devices that are available inside the MegaFon payment terminal are listed.  While we have not told you about how we plan to use NFC to communicate with mobile phones and you can use a barcode scanner. <br><br>  We will tell about them a little later in our Habrablog. <br><br><img src="https://habrastorage.org/files/c92/6e6/49a/c926e649ac824689ae622564288d6017.png" width="600"></div><p>Source: <a href="https://habr.com/ru/post/249755/">https://habr.com/ru/post/249755/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249739/index.html">Twitter Bootstrap and SharePoint. How to make Bootstrap work correctly under SP</a></li>
<li><a href="../249743/index.html">Intel¬Æ Graphics Technology. Part I: Almost Gran Turismo</a></li>
<li><a href="../249747/index.html">Yandex.Metro is watching you</a></li>
<li><a href="../249751/index.html">Change CoffeeScript to ES6</a></li>
<li><a href="../249753/index.html">An overview of the Strela robotic platform or a do-it-yourself simple bluetooth bot</a></li>
<li><a href="../249757/index.html">How to hack Yandex two-factor authentication</a></li>
<li><a href="../249759/index.html">Sample Feature Engineering in Machine Learning</a></li>
<li><a href="../249761/index.html">Sberbank Online: find out personal data by phone</a></li>
<li><a href="../249765/index.html">How I fought adware on google play and lost</a></li>
<li><a href="../249767/index.html">Authoring Perl Modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>