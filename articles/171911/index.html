<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ContactManager, part 3. Testing controllers using MockMvc</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 Acquainted with the library MockMvc, I found the " presence of the absence " of its references to Habr√©. I will try to fill this gap, all th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ContactManager, part 3. Testing controllers using MockMvc</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  Acquainted with the library MockMvc, I found the " <i>presence of the absence</i> " of its references to Habr√©.  I will try to fill this gap, all the more so that our <a href="http://habrahabr.ru/post/145158">ContactManager application</a> just needs automated testing. <br><a name="habracut"></a><br>  So, the main topic of the lesson is to add tests for controllers to the application.  As a bonus, we will do it in a fashionable, <a href="http://habrahabr.ru/post/112488">‚Äúnon-xml-based‚Äù</a> technology. <br><br><h5>  Updating the project structure </h5><br>  First update the library versions.  SpringFramework has now been updated to version 3.2.1, and includes the coveted MockMvc, so this update is necessary.  Spring Security is a little behind, but it is (almost) not a problem.  The version of Hibernate also grew to 4.1.9.Final.  You will find the full project file <a href="">in the repository</a> (link at the end of the article). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Transition to version 4 of Hibernate requires a slight refinement of the <code>data.xml</code> file.  You need to change 3 to 4 in the package name <code>org.springframework.orm.hibernate4</code> , remove the <code>configLocation</code> and <code>configurationClass</code> parameters in the <code>configLocation</code> and instead add the <code>packagesToScan</code> parameter where to transfer the list of class packages with Hibernate mapping from <code>hibernate.cfg.xml</code> .  This file itself can be deleted, we no longer need it.  As a result, the <code>sessionfactory</code> bin takes the form: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.orm.hibernate4.LocalSessionFactoryBean"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"packagesToScan"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>net.schastny.contactmanager.domain<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>com.acme.contactmanager.domain<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernateProperties"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">props</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.show_sql"</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.hbm2ddl.auto"</span></span></span><span class="hljs-tag">&gt;</span></span>create-drop<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.dialect"</span></span></span><span class="hljs-tag">&gt;</span></span>${jdbc.dialect}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hibernate.connection.charSet"</span></span></span><span class="hljs-tag">&gt;</span></span>UTF-8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prop</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">props</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We will also need test resources, so we create the <code>src/test/resources</code> directory, copy security.xml <code>security.xml</code> settings into it, and create <code>testdb.properties</code> property file for the database.  You can do without it, but again, for educational purposes, we will see how you can set properties in bins from the outside.  File contents <br><pre> <code class="nginx hljs">db.user.name=<span class="hljs-attribute"><span class="hljs-attribute">sa</span></span> db.user.pass=</code> </pre><br>  Not God knows what, but as an example will do.  Make a copy of <code>log4j.xml</code> and with resources on it all.  Go to the source code. <br><br>  Create a directory <code>src/test/groovy</code> , package <code>com.acme.contactmanager.test</code> <br><blockquote>  In order for the maven to find our grooves when building from the command line, we‚Äôll add build-helper-maven-plugin to pom.xml </blockquote><br><h5>  Spring configuration for tests </h5><br>  Create a TestConfig.groovy spring configuration <code>TestConfig.groovy</code> <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ComponentScan</span></span>([<span class="hljs-string"><span class="hljs-string">'net.schastny.contactmanager.dao'</span></span>, <span class="hljs-string"><span class="hljs-string">'com.acme.contactmanager.dao'</span></span>, <span class="hljs-string"><span class="hljs-string">'net.schastny.contactmanager.web'</span></span>, <span class="hljs-string"><span class="hljs-string">'net.schastny.contactmanager.service'</span></span>]) <span class="hljs-meta"><span class="hljs-meta">@PropertySource</span></span>(<span class="hljs-string"><span class="hljs-string">'classpath:testdb.properties'</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ImportResource</span></span>(<span class="hljs-string"><span class="hljs-string">'classpath:security.xml'</span></span>) <span class="hljs-meta"><span class="hljs-meta">@EnableTransactionManagement</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br>  The titles of the annotations speak for themselves: <br><ul><li>  this is the configuration </li><li>  components must be searched for in the indicated packages (remember: this is a groove and an array is enclosed in square brackets) </li><li>  need to load testdb.properties <code>testdb.properties</code> </li><li>  don't forget about <code>security.xml</code> </li><li>  and yes, we will need transactions </li></ul><br><blockquote>  By the way, about the transaction.  We have interfaces and implementations for the DAO and service classes, but in general we can confine ourselves to the implementation class alone.  In this case, the annotation will need to specify that the proxyTarget is created automatically, otherwise there will be problems: <code>@EnableTransactionManagement(proxyTargetClass = true)</code> </blockquote><br>  Further.  Bind properties from <code>testdb.properties</code> to class attributes using <code>@Value</code> <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Value</span></span>(<span class="hljs-string"><span class="hljs-string">'${db.user.name}'</span></span>) String userName <span class="hljs-meta"><span class="hljs-meta">@Value</span></span>(<span class="hljs-string"><span class="hljs-string">'${db.user.pass}'</span></span>) String userPass <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  Add the <code>LocalSessionFactoryBean</code> , where we will use the properties obtained.  Here we see the <code>packagesToScan</code> already familiar to us. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LocalSessionFactoryBean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sessionFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LocalSessionFactoryBean bean = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalSessionFactoryBean() bean.packagesToScan = [ <span class="hljs-string"><span class="hljs-string">'com.acme.contactmanager.domain'</span></span>, <span class="hljs-string"><span class="hljs-string">'net.schastny.contactmanager.domain'</span></span>] as String[] Properties props = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Properties() props.<span class="hljs-string"><span class="hljs-string">"hibernate.connection.driver_class"</span></span> = <span class="hljs-string"><span class="hljs-string">"org.h2.Driver"</span></span> props.<span class="hljs-string"><span class="hljs-string">"hibernate.connection.url"</span></span> = <span class="hljs-string"><span class="hljs-string">"jdbc:h2:mem:db1;DB_CLOSE_DELAY=-1;MVCC=TRUE;DB_CLOSE_ON_EXIT=FALSE"</span></span> props.<span class="hljs-string"><span class="hljs-string">"hibernate.connection.username"</span></span> = userName props.<span class="hljs-string"><span class="hljs-string">"hibernate.connection.password"</span></span> = userPass props.<span class="hljs-string"><span class="hljs-string">"hibernate.dialect"</span></span> = <span class="hljs-string"><span class="hljs-string">"org.hibernate.dialect.H2Dialect"</span></span> props.<span class="hljs-string"><span class="hljs-string">"hibernate.hbm2ddl.auto"</span></span> = <span class="hljs-string"><span class="hljs-string">"create-drop"</span></span> props.<span class="hljs-string"><span class="hljs-string">"hibernate.temp.use_jdbc_metadata_defaults"</span></span> = <span class="hljs-string"><span class="hljs-string">"false"</span></span> bean.hibernateProperties = props bean }</code> </pre> <br><blockquote>  This <code>hibernate.temp.use_jdbc_metadata_defaults = false</code> thing helps when it <a href="http://stackoverflow.com/questions/10075081/hibernate-slow-to-acquire-postgres-connection">slows down the context</a> to retrieve metadata from the database </blockquote><br>  Finally, the ‚Äúcherry on the cake‚Äù of our configuration will be <code>HibernateTransactionManager</code> <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HibernateTransactionManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transactionManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HibernateTransactionManager txManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HibernateTransactionManager() txManager.autodetectDataSource = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> txManager.sessionFactory = sessionFactory().object txManager }</code> </pre> <br>  I repeat - the configuration of the project itself remains old, based on xml.  This configuration applies only to tests. <br><br><h5>  We start testing </h5><br>  But it was all a saying, it was time for a fairy tale.  It is logical to expect that working with MockMvc consists of 3 steps: building a mock object, sending an HTTP request to the controller and actually analyzing the results.  For the first step - building a mock object - we will use a builder based on WebApplicationContext. <br><br>  Create a class with the mnemonic name <code>MockMvcTest.groovy</code> <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringJUnit4ClassRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebAppConfiguration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(classes = [ TestConfig.class ] ) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockMvcTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> WebApplicationContext wac MockMvc mockMvc <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wac).dispatchOptions(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).build() } }</code> </pre><br>  Everything is simple to disgrace.  You can already test something.  Let's take a look at our controller and see that the <code>home()</code> method is a good candidate for the test case, where there is a simple redirect <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"redirect:/index"</span></span>; }</code> </pre><br>  Actually, that's what we write <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ MockHttpServletRequestBuilder request = MockMvcRequestBuilders.get(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) ResultActions result = mockMvc.perform(request) result.andExpect(MockMvcResultMatchers.redirectedUrl(<span class="hljs-string"><span class="hljs-string">"/index"</span></span>)) }</code> </pre><br>  Explanations <a href="http://izvestia.ru/news/544796">almost</a> not required: <br><ul><li>  using MockMvcRequestBuilders.get ("/") we get a wrapper for the GET request for the URL "/" </li><li>  mockMvc.perform (request) returns the result </li><li>  as a result, we check that the redirect returned to the desired URL </li></ul><br><blockquote>  The <code>andExpect()</code> function provides great opportunities for checking the result obtained, here are examples from Javadoc, which give a general idea of ‚Äã‚Äãits work: <br><pre> <code class="java hljs">mockMvc.perform(get(<span class="hljs-string"><span class="hljs-string">"/person/1"</span></span>)) .andExpect(status.isOk()) .andExpect(content().mimeType(MediaType.APPLICATION_JSON)) .andExpect(jsonPath(<span class="hljs-string"><span class="hljs-string">"$.person.name"</span></span>).equalTo(<span class="hljs-string"><span class="hljs-string">"Jason"</span></span>)); mockMvc.perform(post(<span class="hljs-string"><span class="hljs-string">"/form"</span></span>)) .andExpect(status.isOk()) .andExpect(redirectedUrl(<span class="hljs-string"><span class="hljs-string">"/person/1"</span></span>)) .andExpect(model().size(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .andExpect(model().attributeExists(<span class="hljs-string"><span class="hljs-string">"person"</span></span>)) .andExpect(flash().attributeCount(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .andExpect(flash().attribute(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-string"><span class="hljs-string">"success!"</span></span>));</code> </pre></blockquote><br>  Run, works.  Hurray, the first test is ready.  What is next?  List of contacts. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/index"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listContacts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, Object&gt; map)</span></span></span><span class="hljs-function"> </span></span>{ map.put(<span class="hljs-string"><span class="hljs-string">"contact"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Contact()); map.put(<span class="hljs-string"><span class="hljs-string">"contactList"</span></span>, contactService.listContact()); map.put(<span class="hljs-string"><span class="hljs-string">"contactTypeList"</span></span>, contactService.listContactType()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"contact"</span></span>; }</code> </pre><br>  All the same GET request, we receive map in parameters, we fill it and we return name view.  We are already able to send GET requests, it remains only to add a check of the result.  We write the second test. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ResultActions result = mockMvc.perform(MockMvcRequestBuilders.get(<span class="hljs-string"><span class="hljs-string">"/index"</span></span>)) result.andExpect(MockMvcResultMatchers.view().name(<span class="hljs-string"><span class="hljs-string">"contact"</span></span>)) .andExpect(MockMvcResultMatchers.model().attributeExists(<span class="hljs-string"><span class="hljs-string">"contact"</span></span>)) .andExpect(MockMvcResultMatchers.model().attributeExists(<span class="hljs-string"><span class="hljs-string">"contactList"</span></span>)) .andExpect(MockMvcResultMatchers.model().attributeExists(<span class="hljs-string"><span class="hljs-string">"contactTypeList"</span></span>)) }</code> </pre><br>  Again, not a single extra line.  Having executed the request, we checked the name of the view, which it returned to us, and checked that all the attributes of the model are in place.  For a more detailed study of these attributes, you can get a link to the actual MvcResult object using the andReturn () function <br><pre> <code class="java hljs">MvcResult mvcResult = result.andReturn() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> mvcResult.modelAndView.model.contactTypeList.size() == <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  So far so good, but there is still a lot of work ahead.  It's time to add something to our list.  The controller method looks like this: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"/add"</span></span>, method = RequestMethod.POST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addContact</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ModelAttribute(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"contact"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Contact contact, BindingResult result) </span></span>{ contactService.addContact(contact); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"redirect:/index"</span></span>; }</code> </pre><br>  Finally, the POST method and the awesome <code>@ModelAttribute Contact contact</code> parameter.  But it is not all that bad.  A quick googling request for ‚Äúmockmvc Model Attribute‚Äù here gives the <a href="http://forum.springsource.org/archive/index.php/t-124040.html">result</a> .  Such mapping can simply be replaced by a set of query parameters.  The function of adding parameters to the query is quite expected to look like this: <code>param(Stirng name, String... values)</code> .  We write <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> ContactService contactService <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      ,    def contacts = contactService.listContact() assert !contacts //         def contactTypes = contactService.listContactType() assert contactTypes //  POST-,      mockMvc.perform(MockMvcRequestBuilders.post("/add") .param("firstname",'firstname') .param("lastname",'lastname') .param("email",'firstname.lastname@gmail.com') .param("telephone",'555-1234') .param("contacttype.id", contactTypes[0].id.toString()) .andExpect(MockMvcResultMatchers.redirectedUrl("/index")) //    contacts = contactService.listContact() //        id assert contacts assert contacts[0].id //   ,      contactService.removeContact(contacts[0].id) }</span></span></code> </pre><br>  Well, the last method remains - delete (). <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/delete/{contactId}"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteContact</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"contactId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Integer contactId) </span></span>{ contactService.removeContact(contactId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"redirect:/index"</span></span>; }</code> </pre><br>  Passing <code>@PathVariable</code> also not a problem, just add it to the URL. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     def contactTypes = contactService.listContactType() assert contactTypes Contact contact = new Contact( firstname : 'firstname', lastname : 'lastname', email : 'firstname.lastname@gmail.com', telephone : '555-1234', contacttype : contactTypes[0] ) contactService.addContact(contact) assert contact.id def contacts = contactService.listContact() //   contacts.id    id  assert contact.id in contacts.id //  POST- ,   URL id   // ${contact.id} -    placeholder,  GString! mockMvc.perform(MockMvcRequestBuilders.get("/delete/${contact.id}") .andExpect(MockMvcResultMatchers.redirectedUrl("/index")) // ,    def contacts = contactService.listContact() assert !(contact.id in contacts.id) }</span></span></code> </pre><br>  That's all, all methods are covered with automatic tests, hooray!  Or not cheers?  An attentive reader will ask - what about security ?!  Why did we connect <code>security.xml</code> if there is no mention of users and roles in the tests?  And he will be right.  In the third part of the lesson, we will add support for working with SpringSecurity. <br><br><h5>  Add authentication </h5><br>  It is logical to assume that MockMvc should have support for working with filters.  In fact, in the builder there is a method <code>addFilter()</code> , in which we can pass an instance of <code>springSecurityFilterChain</code> .  Let's change our test as follows: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> FilterChainProxy springSecurityFilterChain <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wac) .addFilter(springSecurityFilterChain) <span class="hljs-comment"><span class="hljs-comment">//    .dispatchOptions(true).build() }</span></span></code> </pre><br>  Now we have a rights check when accessing URLs, but we need to somehow introduce ourselves to the system.  Let's try to make ‚Äúfeint ears‚Äù and directly set the value in SecirityContextHolder. <br><pre> <code class="java hljs"> List&lt;GrantedAuthority&gt; authorities = AuthorityUtils.createAuthorityList(<span class="hljs-string"><span class="hljs-string">"ROLE_USER"</span></span>); Authentication auth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UsernamePasswordAuthenticationToken(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>, <span class="hljs-string"><span class="hljs-string">"1111"</span></span>, authorities); SecurityContextHolder.getContext().setAuthentication(auth);</code> </pre><br>  It looks plausible, let's try the add () method, which requires the ROLE_USER privilege.  Babah!  Did not work out <br><pre> <code class="nginx hljs">DEBUG: org.springframework.security.web.access.intercept.<span class="hljs-attribute"><span class="hljs-attribute">FilterSecurityInterceptor</span></span> - Secure object: FilterInvocation: URL: /add; Attributes: [ROLE_USER] DEBUG: org.springframework.security.web.access.intercept.<span class="hljs-attribute"><span class="hljs-attribute">FilterSecurityInterceptor</span></span> - Previously Authenticated: org.springframework.security.authentication. AnonymousAuthenticationToken<span class="hljs-variable"><span class="hljs-variable">@d4551ca6</span></span>: Principal: guest; Credentials: [PROTECTED]; Authenticated: true; Details: org.springframework.security.web.authentication. WebAuthenticationDetails@957e: RemoteIpAddress: 127.0.0.1; SessionId: null; <span class="hljs-attribute"><span class="hljs-attribute">Granted</span></span> Authorities: ROLE_ANONYMOUS DEBUG: org.springframework.security.web.access.ExceptionTranslationFilter - Access is denied (user is anonymous); <span class="hljs-attribute"><span class="hljs-attribute">redirecting</span></span> to authentication entry point</code> </pre><br>  <code>Granted Authorities: ROLE_ANONYMOUS</code> hints that our feint didn‚Äôt work with our ears.  But I hasten to reassure - our guilt is not here, supporting Security in the tests <a href="https://jira.springsource.org/browse/SEC-2015">has not yet been implemented</a> .  That is why in the beginning I wrote that integration with SpringSecurity is ‚Äúalmost no problem‚Äù.  The problem is still there, but it is solved. <br><br>  The <a href="">SecurityRequestPostProcessors.java</a> class will help us with this.  I will not dwell on its content, just copy it to the <code>src/test/java</code> folder and show how it can be used for our needs. <br><br>  We remove the call <code>setAuthentication(auth)</code> , which turned out to be useless, and in the add () method we add one line to the query construct: <br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">//... mockMvc.perform(MockMvcRequestBuilders.post("/add") .param("firstname",'firstname') .param("lastname",'lastname') .param("email",'firstname.lastname@gmail.com') .param("telephone",'555-1234') .param("contacttype.id", contactTypes[0].id.toString()) .with(SecurityRequestPostProcessors.userDetailsService("user1"))) //   Security .andExpect(MockMvcResultMatchers.redirectedUrl("/index")) // ...</span></span></code> </pre><br>  That is, in fact, we execute the request on behalf of user1, with all his rights.  And it works great!  In the log we see the desired <code>Granted Authorities: ROLE_USER</code> <br><br>  But do not rush to remove the old test cases, they will still be useful to us.  Indeed, in this form, they are testing nothing more than unauthorized access to our system.  And the same methods home () and index () should work, because these URLs do not impose any restrictions on authentication.  And they work! <br><br>  Let's go back to the add () method.  What does our application do when we try to keep a contact being unauthorized?  Shows us a login page!  In terms of redirect, this means redirect to /login.jsp <br>  Therefore, we replace the verification of the result of an unauthorized request to save a contact with another one: <br><pre> <code class="java hljs">result.andExpect(MockMvcResultMatchers.redirectedUrl(<span class="hljs-string"><span class="hljs-string">"http://localhost/login.jsp"</span></span>))</code> </pre><br>  In the same way, in the absence of authorization, the delete () method must also implement.  And on behalf of the user ‚Äúadmin‚Äù the deletion works and it is correct. <br><br>  And it remains to test another option - when a user with ROLE_USER rights tries to delete an entry.  In this case, he should see error 403, or rather, the forward on /error403.jsp.  The body of the test method for this scenario will look like this (the contact id doesn't matter in this case, just put / 1): <br><pre> <code class="java hljs"> mockMvc.perform(MockMvcRequestBuilders.get(<span class="hljs-string"><span class="hljs-string">"/delete/1"</span></span>) .with(SecurityRequestPostProcessors.userDetailsService(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>))) .andExpect(MockMvcResultMatchers.forwardedUrl(<span class="hljs-string"><span class="hljs-string">"/error403.jsp"</span></span>))</code> </pre><br><br>  That's all.  As a result, we got 12 test methods, 3 for each of the 4 URLs.  They check unauthorized access, access with ROLE_USER and ROLE_ADMIN rights.  Along with the controllers, we tested the methods of services and DAO. <br><br>  <a href="https://github.com/monzdrpower/ContactManager-MockMvc">Project source code on github</a> </div><p>Source: <a href="https://habr.com/ru/post/171911/">https://habr.com/ru/post/171911/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171899/index.html">TASK_RTF_NOTES in MS Project or RTF in MS SQL. How to win it and prepare cubes in SSAS</a></li>
<li><a href="../171901/index.html">Create a backup copy of the database in Azure Storage</a></li>
<li><a href="../171903/index.html">Technical fight: mobile apps against mobile sites</a></li>
<li><a href="../171905/index.html">Riddle of the Amazon dropdown list</a></li>
<li><a href="../171909/index.html">Distance learning using mobile devices</a></li>
<li><a href="../171913/index.html">Pwn2Own 2013: First Results</a></li>
<li><a href="../171915/index.html">Phalcon 1.0.0 First Beta</a></li>
<li><a href="../171919/index.html">Highlights $ in'y: MongoDB performance in ranges</a></li>
<li><a href="../171925/index.html">What is the difference between using MVC and MVP</a></li>
<li><a href="../171929/index.html">Caphaw Banking Trojan attacks European banks using web injects plugin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>