<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Amateur and back-engineering. Part 1: Paths and Files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How many of the progers did projects based on the games they played? I think a lot. You may be told that the game is so-so that you don‚Äôt have to spen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Amateur and back-engineering. Part 1: Paths and Files</h1><div class="post__text post__text-html js-mediator-article">  How many of the progers did projects based on the games they played?  I think a lot.  You may be told that the game is so-so that you don‚Äôt have to spend time on a meaningless project, it‚Äôs still not useful to anyone, but it makes no difference to you, because it was cool, and at least somehow I want to repeat those emotions. <br><br>  At one time I played a lot in ‚ÄúTales of pirates‚Äù (hereinafter TOP) from Moli, more precisely in its Russian localization from Nival, Piratia.  Chic, as for me, the game.  Yes, not WOW, but I didn‚Äôt know anything about him either.  Many years have passed, ‚ÄúPiratia‚Äù was closed, I grew up, but in the ocean of memory, the forgotten conqueror of the seas still floats on the ship of the 54th level. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7d/8c3/5d3/e7d8c35d3cb133edd26c419ef789d256.png" alt="image" width="600"><br><a name="habracut"></a><br>  After I learned that the Russian server was closed, and at that moment I hadn‚Äôt played for a couple of years, the excitement reawakened.  After a couple of months, I got a little understanding of the world of fan servers, tried to set up my own on LAN, and began to figure out the structure of the files.  And then it started.  At first I decided to learn how to work with models.  For a couple of hours, I found some code on Pastebin that, after a file, could open, however with problems, models.  But besides the models in the game, the textures were encrypted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fortunately, there was one program, Gemini Decompiler, able to transform the texture of the game into normal and conventional pictures.  Even more fortunate that this applet was written on .Net.  After the decompiler, it turned out that the normal texture was broken into 3 blocks - the first 44 bytes, the last 44 bytes, and the rest - in the encrypted texture, first went the last 44 bytes, then the main part, then the first 44 bytes, and another 4 bytes is unimportant. <br><br>  Based on the code from Pastebin and the texture converter, it turned out to make a model viewer.  Horrible of course, but still.  Here, he only read only the simplest models, like swords / staffs / daggers, characters and decor elements without animation. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a8a/4a2/9a3/a8a4a29a3a04b0992af010c668c9da7c.png" alt="image" width="600"><br><br>  And I wanted to move.  And I started looking for disassemblers to sort the TOP engine library in pieces.  Found a pirate IDA Pro.  And he began to break ... A convenient program in general, especially because it can adequately dereference names after processing by the compiler and translates the result of the disassembly into pseudocode extremely similar to C. In the article about Caesar 3 this was <a href="http://habrahabr.ru/post/221913/">remembered</a> . <br><br>  I worked with varying success for about two months.  Well, how it worked, was played.  I found a code with mathematical operations, started sticking structures from the model viewer into the IDA database, then I found that you can import .pdb (and it is, apparently for feedback, if there are errors), the code and structure rules that were issued by the pseudo-code designer.  But it was felt that all was not right.  I have .pdb, and there, as far as I knew, there is information about the project.  I found a bunch of different programs, but they all gave out only general information.  Then I began to consider Debug Interface Access (hereinafter referred to as DIA), if it was also delivered with the Express version of Visual studio.  In short, now I'm writing on the Professional edition.  Having compiled the dia2dump example, I went nuts.  I had a lot of service information at hand.  A little more than 30 megabytes of text.  For example, there is a list of all .obj files that are fed to the linker, in addition, for each .obj file there is a list of sources that are included there.  In general, the code for creating files from the TOP engine project was ready in one day.  And then there will be the creation of structures and the connection of inkudov on .pdb ... <br><br>  So it goes. <br><br>  For a snack - additional code for dia2dump.  The code for counting the number of .obj in a project, outputting files in each .obj, and creating folders and project files for .pdb. <br><div class="spoiler">  <b class="spoiler_title">Open the result of the encoder</b> <div class="spoiler_text"><pre><code class="hljs php">int total=<span class="hljs-number"><span class="hljs-number">0</span></span>; bool AQLCreateDirectory(WCHAR * sPathTo) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(CreateDirectory(sPathTo, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>) == <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) { WCHAR sTemp[MAX_PATH]; int k = wcslen(sPathTo); wcscpy(sTemp, sPathTo); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(CreateDirectory(sTemp, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(sTemp[--k] != L<span class="hljs-string"><span class="hljs-string">'\\'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(k&lt;=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>; sTemp[k] = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>; }; void Process(IDiaSession *pSession, IDiaSymbol *pGlobal) { int total=<span class="hljs-number"><span class="hljs-number">0</span></span>; IDiaEnumSymbols *pEnumSymbols; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FAILED(pGlobal-&gt;findChildren(SymTagCompiland, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, nsNone, &amp;pEnumSymbols))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; IDiaSymbol *pCompiland; ULONG celt = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SUCCEEDED(pEnumSymbols-&gt;Next(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;pCompiland, &amp;celt)) &amp;&amp; (celt == <span class="hljs-number"><span class="hljs-number">1</span></span>)) { pCompiland-&gt;Release(); total++; } fwprintf(pFileout,L<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, total); pEnumSymbols-&gt;Release(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FAILED(pGlobal-&gt;findChildren(SymTagCompiland, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, nsNone, &amp;pEnumSymbols))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; celt = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SUCCEEDED(pEnumSymbols-&gt;Next(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;pCompiland, &amp;celt)) &amp;&amp; (celt == <span class="hljs-number"><span class="hljs-number">1</span></span>)) { BSTR bstrName; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pCompiland-&gt;get_name(&amp;bstrName) == S_OK) { fwprintf(pFileout,L<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, bstrName); SysFreeString(bstrName); } int num=<span class="hljs-number"><span class="hljs-number">0</span></span>; IDiaEnumSourceFiles *pEnumSourceFiles; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SUCCEEDED(pSession-&gt;findFile(pCompiland, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, nsNone, &amp;pEnumSourceFiles))) { IDiaSourceFile *pSourceFile; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SUCCEEDED(pEnumSourceFiles-&gt;Next(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;pSourceFile, &amp;celt)) &amp;&amp; (celt == <span class="hljs-number"><span class="hljs-number">1</span></span>)) { num++; pSourceFile-&gt;Release(); } pEnumSourceFiles-&gt;Release(); fwprintf(pFileout,L<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, num); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SUCCEEDED(pSession-&gt;findFile(pCompiland, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, nsNone, &amp;pEnumSourceFiles))) { IDiaSourceFile *pSourceFile; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SUCCEEDED(pEnumSourceFiles-&gt;Next(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;pSourceFile, &amp;celt)) &amp;&amp; (celt == <span class="hljs-number"><span class="hljs-number">1</span></span>)) { BSTR bstrSourceName; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pSourceFile-&gt;get_fileName(&amp;bstrSourceName) == S_OK) { fwprintf(pFileout,L<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, bstrSourceName); WCHAR *path = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WCHAR[wcslen(bstrSourceName)+<span class="hljs-number"><span class="hljs-number">8</span></span>]; wcscpy(path,L<span class="hljs-string"><span class="hljs-string">"c:\\test\\"</span></span>); wcscat(path,bstrSourceName+<span class="hljs-number"><span class="hljs-number">2</span></span>); WCHAR *filename = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WCHAR[wcslen(path)+<span class="hljs-number"><span class="hljs-number">1</span></span>]; wcscpy(filename,path); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(int k=wcslen(path)<span class="hljs-number"><span class="hljs-number">-1</span></span>;k&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;&amp;path[k]!=L<span class="hljs-string"><span class="hljs-string">'\\'</span></span>;k--)path[k]=<span class="hljs-number"><span class="hljs-number">0</span></span>; bool ok = AQLCreateDirectory(path); FILE *file = _wfopen(filename,L<span class="hljs-string"><span class="hljs-string">"w"</span></span>); fclose(file); delete(filename); delete(path); SysFreeString(bstrSourceName); } pSourceFile-&gt;Release(); } pEnumSourceFiles-&gt;Release(); } pCompiland-&gt;Release(); } pEnumSymbols-&gt;Release(); }</code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/236899/">https://habr.com/ru/post/236899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236887/index.html">The results of the survey ‚ÄúHow I work‚Äù and some disappointing conclusions</a></li>
<li><a href="../236889/index.html">Opera 25 Beta: Bookmarks and New Express Panel</a></li>
<li><a href="../236891/index.html">And what does your grandmother know about IT?</a></li>
<li><a href="../236893/index.html">ESA specialists selected a primary and alternative landing point for the Philae / Rosetta probe on the comet Churyumov-Gerasimenko</a></li>
<li><a href="../236897/index.html">Catching unusual SNMP-trap messages in an unusual way</a></li>
<li><a href="../236901/index.html">Probabilistic law of the distribution of the duration of a session of an artificial Earth satellite with a ground object</a></li>
<li><a href="../236903/index.html">Behind smart carts the future of retail, or How I invented the wheel</a></li>
<li><a href="../236905/index.html">Bummer Live Apple</a></li>
<li><a href="../236907/index.html">How I developed a markup language translator</a></li>
<li><a href="../236909/index.html">WikiLeaks Publishes FinFisher Client Countries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>