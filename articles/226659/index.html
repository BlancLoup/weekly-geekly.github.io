<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our experience accelerating iOS apps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Mitya Kurkin, I lead the development of iOS messengers Mail.Ru Group. Today I will talk about our experience in accelerating apps on iOS. H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our experience accelerating iOS apps</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/mailru/blog/226659/"><img src="https://habrastorage.org/getpro/habr/post_images/55d/5b7/1da/55d5b71da18c2d844172c727d016a176.png"></a> <br><br>  My name is Mitya Kurkin, I lead the development of iOS messengers Mail.Ru Group.  Today I will talk about our experience in accelerating <a href="http://bit.ly/iosicq">apps</a> on iOS.  High speed is very important for 99% of applications.  This is especially true on mobile platforms, where computing power and, accordingly, the battery charge is very limited.  Therefore, every self-respecting developer seeks to optimize the performance of his application in order to eliminate the various delays that make up the total reaction time. <br><a name="habracut"></a><br><h1>  Measurement </h1>  Before you make any manipulations, you need to fix the current state of affairs.  That is, measure how much time is now lost in problem areas.  The measurement method must be reproducible; otherwise, it will be meaningless to compare this data with subsequent achievements.  How to measure?  Situations may be different, but we always have a stopwatch.  True, this is the least accurate option. <br><br>  Can be measured with a profiler.  If there are characteristic areas on the graph (decline or peak load), then you can measure them.  This option gives a more accurate result.  In addition, the graph will show the influence of additional factors.  For example, if you measure the speed of all device processes, you can find out what other applications are doing and whether this affects the result of our measurement.  If the profiler does not catch on anything, then you can measure your own logs.  This can give even more accurate results, but this will require changing the application, which may in some way affect its operation.  Also in this case, the influence of additional factors will not be visible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Perfect result </h1>  To understand whether it is possible to accelerate in a particular situation, it is desirable to understand in advance what the minimum time can be.  The fastest solution is to consider the operation of a similar function in a competitor application.  This can give a guideline how quickly such an operation can be performed.  It is necessary to evaluate whether the selected technologies allow achieving the desired speed.  It is necessary to remove everything that is possible in order to get the very minimum of the function performed: <br><ul><li>  disable parallel running processes; </li><li>  replace variables with constants; </li><li>  instead of a full screen load, show only the cap; </li><li>  leave from the network operation only a sequence of constant network requests; </li><li>  you can even create a clean application that performs only this constant function. </li></ul><br>  If in this case we get the desired speed, then you can slowly return the disconnected elements and see how this affects performance.  If, even after all the described procedures are completed, the result is unsatisfactory, then more radical actions are needed: changing the libraries used, reducing the traffic volume due to its quality, changing the protocol used, etc. <br><br><h1>  Profiler </h1>  When optimizing a simple code reading can easily lead the wrong way.  Perhaps you will find some ‚Äúhard‚Äù operation that is difficult, but you can optimize a little.  And so, having spent a lot of time, applying the latest and most modern algorithms, you succeed.  But at the same time, the ideal is still as before China.  Or maybe even worse.  Although in reality the problem may lie in the most unexpected places that are not at all suspicious.  Somewhere completely unnecessary actions can be performed, or it is just an error leading to a hang.  Therefore, you first need to measure what takes time.  Moreover, we have such an opportunity thanks to the tools from Apple. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/890/7e1/508/8907e1508a4b90b169f2c1d8cceb067b.png"><br><br>  To speed up the application, Time Profiler is primarily required.  Its interface is quite clear: on top of the graph of the load on the processor, at the bottom of the call tree, showing what method ate.  There is a splitting into streams, filters, fragment selection, various sorts and many more. <br><br>  To work most effectively with this data, you need to understand how they are calculated.  Let's take this schedule: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1b/da7/518/b1bda751836d2819a529cb960d140e4c.png"><br><br>  At high magnification, it looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e54/6a3/9c6/e546a39c6f46be3870cda38bf49fe0b3.png"><br><br>  Profiler measures the flow of time due to periodic polling of the application status.  If during such a measurement it uses a processor, then all methods from the call stack use processor time.  According to the total amount of such measurements, we get a call tree indicating the elapsed time: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db2/eac/be1/db2eacbe1d32c1a263e33d5dd3a5ba69.png"><br><br>  Tools allow you to adjust the frequency of such measurements: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2b3/bd2/158/2b3bd215849d263e972bbf9da075aeb0.png"><br><br>  It turns out that the more often the processor usage is noted in the measurements, the higher the level on the original graph.  But then, if the processor is not used, this time does not affect the overall result.  How then to look for those cases when the application is in a waiting state for an event, for example, a response to an http request?  In this case, the setting ‚ÄúRecord Waiting Threads‚Äù can help.  Then the measurements will be recorded and those states when the processor is not used.  A column with the number of measurements per function instead of the elapsed time will automatically turn on in the bottom table.  The display of these columns can be customized, but by default either the time or the number of measurements is shown. <br><br>  Consider this example: <br><br><pre><code class="html hljs xml">- (void)someMethod { [self performSelector:@selector(nothing:) onThread:[self backThread] withObject:nil waitUntilDone:YES]; } - (void)nothing:(id)object { for (int i=0; i<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">10000000;</span></span></span><span class="hljs-tag"> ++</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">) { [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NSString</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stringWithFormat:</span></span></span><span class="hljs-tag">@"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">get</span></span></span><span class="hljs-tag">%@", @"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Some</span></span></span><span class="hljs-tag">"]; } }</span></span></code> </pre> <br>  Measuring the application with the launch of such a code will give something like this: <br><br><img src="//habrastorage.org/files/940/1ea/cee/9401eaceed6344bd95b0e019c9ddc56c.png"><br><br>  The figure shows that the main stream takes 94 ms and 2.3% in time, and 9276 and 27% in measurements (samples).  However, the difference may not always be so noticeable.  How to search for such cases in real applications?  Here helps the mode of displaying the graph as streams: <br><br><img src="//habrastorage.org/files/aa3/c4b/5d0/aa3c4b5d0c0642d887833bfd7fb50d8a.png"><br><br>  In this mode, you can see when threads start, when they perform some actions and when they ‚Äúsleep‚Äù.  In addition to viewing the graph in the upper part, you can also enable the display of the list of measurements (Sample List) in the lower table.  Looking through the areas of "sleep" of the main thread, you can find the culprit hang interface. <br><br><h1>  Do not stop on system calls </h1>  Conducting measurements, it is very easy to rest against system calls.  It turns out that all the time goes to the work of the system code.  What is there to do?  In fact, the main thing is not to dwell on this.  While there is an opportunity, you need to delve into these challenges.  If you dig, it can easily be a calbek or a delegate who calls your code, and the tangible waste of time is precisely because of it. <br><br><h1>  Turn off </h1>  So, the suspect is found.  Before you redo, you need to check how the application will work completely without it. <br><br>  It so happens that there are a lot of potential culprits for braking, and it is problematic to measure all this by the profiler.  For example, the problem is well reproduced only by some users and not always, but only in a certain situation.  In order to quickly understand whether we are moving in the right direction, whether we are measuring and optimizing those places, disabling these modules helps very well. <br><br>  If everything is already off, and far from ideal, then you need to try to move from the other side.  Create an empty application and increase its functionality. <br><br><h1>  Consider the technical features of devices </h1>  Technical specifications of devices are changing, and it is also worth considering.  For example, starting with the iPhone 4S began to use multi-core processors.  Therefore, there is more efficient use of multithreading through the use of multiple cores.  However, on a single-core processor, this may slow down the final result, since we can still use only one core, but at the same time spend additional resources on switching the context of the thread. <br><br><h1>  Be careful when connecting large frameworks. </h1>  The more and more powerful the mechanism you connect, the more it takes in your hands.  The less you control the situation.  And, accordingly, the application becomes less flexible.  In our case, we firmly sat on CoreData.  Great technology.  Full support for migrations, FetchResultController, caching is very tempting.  But take the launch of the application.  To initialize the CoreData stack, you must at least load the base and load the model.  If you use sqlite without CoreData, you do not need to load the model.  In our case, the model contains 26 entities.  Its download takes considerable time, especially on older devices, where the launch speed is felt most acutely. <br><br>  Our applications are actively developing, so there is always the need to add entities to the database.  Thanks to the convenient migration mechanism this does not cause problems.  But there are already almost 40 of them. First of all, this greatly affects the size of the application.  In total, all migrations add about 30%.  In addition, migrations work consistently.  So the more of them - the longer the migration takes place.  And this again affects the launch speed. <br><br>  We also encountered a removal problem.  With our model and a sufficiently large base, the removal affecting all entities took about 10 minutes.  Having turned on the magic debugging option CoreData SQLDebug, we saw a huge number of SELECTs, UPDATEs and a bit of DELETEs.  The main problem here is that there is no deleteObjects method in NSManagedObjectContext.  That is, objects can be deleted only one at a time, although SQL itself can delete via DELETE ... WHERE someValue IN ... In addition, to delete each object, its key is selected and then deleted.  Similarly, the removal of dependent objects. <br><br>  In our situation, the situation is aggravated by the fact that users of mobile devices, as a rule, do not wait for such a huge period of time and ‚Äúkill‚Äù the application.  The result is a broken base. <br><br><h1>  findings </h1>  As you can see, there are quite a few ways to optimize the speed of mobile applications.  But, surrounded by numbers and graphs, you need not to break away from reality.  It is desirable to keep the application running so that the effect of optimization can be felt in combat conditions.  Unfortunately, developers often either don‚Äôt pay enough attention to optimization, or they‚Äôre too enthusiastic about this activity.  The main thing is to remember that optimization should produce tangible user results.  Optimization for the sake of optimization itself, when the effect is obtained homeopathic, is a waste of time and effort.  Total should be in moderation. </div><p>Source: <a href="https://habr.com/ru/post/226659/">https://habr.com/ru/post/226659/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226647/index.html">Easy integration of P2P service transfers to the site and in the application</a></li>
<li><a href="../226649/index.html">The war with the designer: where does good design come from? Part 2</a></li>
<li><a href="../226653/index.html">Management tools: Mammoth as the main principle of team building</a></li>
<li><a href="../226655/index.html">Spacecraft Solar Probe Plus will go on record rapprochement with the Sun</a></li>
<li><a href="../226657/index.html">Tesla coil from hozmag</a></li>
<li><a href="../226661/index.html">How we deployed Huawei MicroDC</a></li>
<li><a href="../226663/index.html">Spring MVC - JavaConfig or project configuration without XML files</a></li>
<li><a href="../226665/index.html">Microsoft moves to proprietary processors</a></li>
<li><a href="../226667/index.html">RaspberryPi + Pioneer System Remote</a></li>
<li><a href="../226669/index.html">Cross-platform file manager? This is reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>