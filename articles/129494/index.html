<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Right singleton in java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am sure that each of the readers knows what the ‚ÄúSingleton‚Äù design pattern is, but not everyone knows how to program it effectively and correctly. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Right singleton in java</h1><div class="post__text post__text-html js-mediator-article">  I am sure that each of the readers knows what the ‚ÄúSingleton‚Äù design pattern is, but not everyone knows how to program it effectively and correctly.  This article is an attempt to aggregate existing knowledge on this issue. <br><br>  In addition, we can consider the article as a continuation of the <a href="http://habrahabr.ru/blogs/complete_code/27108">remarkable study</a> published earlier in Habrahabr. <br><a name="habracut"></a><br><h5>  Unholy Singleton in Java </h5><br>  The author knows two ways to implement a template with normal initialization. <br><br><h6>  1 Static field </h6><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Singleton INSTANCE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Singleton(); }</code> </pre> <br>  <b>+</b> Simple and transparent implementation <br>  <b>+</b> Thread safety <br>  <b>-</b> Not lazy initialization 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  2 Enum Singleton </h6><br>  According to Joshua Bloch, this is the best way to implement a template [1]. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Singleton { INSTANCE; }</code> </pre><br>  <b>+</b> Witty <br>  <b>+</b> Serialization out of the box <br>  <b>+</b> Out-of-box thread safety <br>  <b>+</b> Ability to use EnumSet, EnumMap, etc. <br>  <b>+</b> Switch support <br>  <b>-</b> Not lazy initialization <br><br><h5>  Lazy singleton in java </h5><br>  At the time of writing, there are at least three valid implementations of the Singleton pattern with lazy initialization in Java. <br><br><h6>  1 Synchronized Accessor </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Singleton instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> Singleton </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Singleton(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } }</code> </pre><br>  <b>+</b> Lazy initialization <br>  <b>-</b> Low performance (critical section) in the most typical access <br><br><h6>  2 Double Checked Locking &amp; volatile </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Singleton instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Singleton </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Singleton localInstance = instance; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localInstance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (Singleton.class) { localInstance = instance; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localInstance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { instance = localInstance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Singleton(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> localInstance; } }</code> </pre><br>  <b>+</b> Lazy initialization <br>  <b>+</b> High performance <br>  <b>-</b> Supported only with JDK 1.5 [5] <br><br><h6>  2.1 Why doesn't it work without volatile? </h6><br>  The problem of the Double Checked Lock idiom lies in the Java memory model, more precisely in the order in which objects are created.  It is possible to conditionally present this order by the following stages [2, 3]: <br><br>  Suppose we create a new student: Student s = new Student (), then <br><br>  1) local_ptr = malloc (sizeof (Student)) // memory allocation for the object itself; <br>  2) s = local_ptr // initialization of the pointer; <br>  3) Student :: ctor (s);  // construction of the object (initialization of fields); <br><br>  Thus, between the second and third stage, a situation is possible in which another thread can receive and start using (based on the condition that the pointer is not zero) an incompletely constructed object.  In fact, this problem was partially solved in JDK 1.5 [5], but the authors of JSR-133 [5] recommend using voloatile for Double Cheated Lock.  Moreover, their attitude to such things is easily traced from the comment to the specification: <br><br><blockquote>  There exist a number of common but dubious coding idioms, such as the double-checked locking idiom, that is.  Semantics are almost always idioms. </blockquote><br>  Thus, although the problem has been solved, using Double Checked Lock without volatile is extremely dangerous.  In some cases, depending on the implementation of the JVM, operating environment, scheduler, etc., this approach may not work.  However, with a series of experiments accompanied by viewing the assembler code generated by JIT to the author, such a case could not be solved. <br><br>  Finally, Double Checked Lock can be used without exception with immutable objects (String, Integer, Float, etc.). <br><br><h6>  3 On Demand Holder idiom </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingletonHolder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Singleton HOLDER_INSTANCE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Singleton(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Singleton </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SingletonHolder.HOLDER_INSTANCE; } }</code> </pre><br><br>  <b>+</b> Lazy initialization <br>  <b>+</b> High performance <br>  <b>-</b> Cannot be used for non-static class fields <br><br><h5>  Performance </h5><br>  To compare the performance of the above methods, a micro-benchmark [6] was used, which determines the number of elementary operations (field increment) per second over a Singleton object, from two parallel threads. <br><br>  Measurements were made on a dual-core machine Intel Core 2 Duo T7300 2GHz, 2Gb ram and Java HotSpot (TM) Client VM (build 17.0-b17).  The unit increment count (and hence the object captures) per second is * 100,000. <br><br>  (more is better) <br><table><tbody><tr><th></th><th>  Client </th><th>  Server </th></tr><tr><td>  Synchronized accessor </td><td>  42.6 </td><td>  86.3 </td></tr><tr><td>  Double Checked Lock &amp; volatile </td><td>  179.8 </td><td>  202.4 </td></tr><tr><td>  On Demand Holder </td><td>  181.6 </td><td>  202.7 </td></tr></tbody></table><br><br>  Conclusion: if you choose the right implementation of the template, you can get acceleration (speed up) from <b>2x</b> to <b>4x</b> . <br><br><h5>  Summary </h5><br>  We can single out the following short advice on the use of one approach or another for the implementation of the ‚ÄúLoner‚Äù template [1]. <br><br>  1) Use normal (not lazy) initialization wherever possible; <br>  2) For static fields use On Demand Holder idom; <br>  3) For simple fields use Double Chedked Lock &amp; volatile idom; <br>  4) In all other cases, use the Syncronized accessor; <br><br><h5>  Java Class Library &amp; Singleton </h5><br>  It is noteworthy that the developers of the Java Class Library chose the easiest way to implement the template - Syncronized Accessor.  On the one hand, this is a guarantee of compatibility and proper operation.  On the other hand, this is the loss of processor time to enter and exit the critical section during each access. <br><br>  A quick search for grep from source made it clear that there are a lot of such places in JCL. <br><br>  Maybe the next article will be ‚ÄúWhat will happen if in the Java Class Library correctly write all singleton classes?‚Äù :) <br><br>  Links <br>  [1] Joshua Bloch, <a href="http://sites.google.com/site/io/effective-java-reloaded">Effective Java Reloaded</a> talk at Google I / O 2008 ( <a href="http://www.youtube.com/watch%3Fv%3Dpi_I7oD_uGI">video</a> ); <br>  [2] <a href="http://www.ibm.com/developerworks/java/library/j-dcl/index.html">Double-checked locking and the Singleton pattern</a> ; <br>  [3] <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html">The "Double-Checked Locking is Broken" Declaration</a> ; <br>  [4] <a href="http://en.wikipedia.org/wiki/Double-checked_locking">en.wikipedia.org/wiki/Double-checked_locking</a> <br>  [5] <a href="http://jcp.org/en/jsr/detail%3Fid%3D133">JSR-133</a> <br>  [6] <a href="http://wikis.sun.com/display/HotSpotInternals/MicroBenchmarks">How to write microbenchmarks</a> </div><p>Source: <a href="https://habr.com/ru/post/129494/">https://habr.com/ru/post/129494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129488/index.html">Interest graph (interest graph): a new principle of interaction in the network</a></li>
<li><a href="../129489/index.html">Testing the trading system in PHP</a></li>
<li><a href="../129490/index.html">Release LiveStreet 0.5.1 and move to GitHub</a></li>
<li><a href="../129492/index.html">I use the firm's smartphone ...</a></li>
<li><a href="../129493/index.html">Pentax Q - the smallest mirrorless in the world</a></li>
<li><a href="../129495/index.html">Canobuvosti, 111th edition</a></li>
<li><a href="../129497/index.html">Fonts Ubuntu Font Family 0.80, now with Ubuntu Mono and Ubuntu Condensed</a></li>
<li><a href="../129500/index.html">StatCounter: in December, Chrome will overtake Firefox and become the number 2 browser in the world</a></li>
<li><a href="../129501/index.html">Freedom Tablet from Packard Bell. Video review</a></li>
<li><a href="../129502/index.html">Full-size paper model car "Ford Mustang"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>