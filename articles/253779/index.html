<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interesting moments of LINQ to SQL. Again</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A month has passed since my previous post , I think it's time to continue. This time we will talk about Inheritance Mapping, well, those who are espec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interesting moments of LINQ to SQL. Again</h1><div class="post__text post__text-html js-mediator-article">  A month has passed since <a href="http://habrahabr.ru/post/250759">my previous post</a> , I think it's time to continue.  This time we will talk about Inheritance Mapping, well, those who are especially interested in the end of the article will have a surprise. <br><br>  So, let's begin. <br><br><h3>  Discriminator Issues </h3><br>  Of course, we store polymorphic entities in our database.  For example, there is an essence CustomerOperation, which reflects some operation that can be performed on a consumer.  Operations are performed mainly through services, so there is a successor to CustomerServiceOperation, and we also have a mechanism for WebTracking, for which we have WebTrackingOperation.  But enough words, better show the code: <br><a name="habracut"></a><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Table(Name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"directcrm.CustomerOperations"</span></span></span><span class="hljs-meta">)</span></span>] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">""</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomerOperation), IsDefault = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"Service"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomerServiceOperation))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"WebTracking"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(WebTrackingOperation))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomerOperation</span></span> : <span class="hljs-title"><span class="hljs-title">CampaignItemBase</span></span>, <span class="hljs-title"><span class="hljs-title">ICampaignItem</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  -  [Column(Storage = "discriminator", CanBeNull = false, IsDiscriminator = true)] public string Discriminator { get { return discriminator; } private set { if (discriminator != value) { SendPropertyChanging(); discriminator = value; SendPropertyChanged(); } } } //   -  }</span></span></code> </pre> <br>  Let's try to get some WebTracking operation.  And here is the code: <br><pre> <code class="cs hljs">modelContext.Repositories.Get&lt;CustomerOperationRepository&gt;() .FixedItems.OfType&lt;WebTrackingOperation&gt;() .FirstOrDefault();</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All is well.  But what will happen if we suddenly forgot to register the type of WebTrackingOperation in the Inheritance Mapping attributes?  If we forget to do this, then such a request will be translated to <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">EMPTY</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [directcrm].[CustomerOperations] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [t0] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Smart LINQ to SQL!  But the exception would be the best choice, in my humble opinion.  Well, if we forgot the type, but we went through the table of these operations and changed the type directly to the database with a script (for example, before all operations were CustomerService, now WebTracking appeared, and some old ones need to be updated).  Let's try to subtract the operation with unregistered discriminator from the database: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test = modelContext.Repositories.Get&lt;CustomerOperationRepository&gt;().GetBySystemName(<span class="hljs-string"><span class="hljs-string">"Webtrackingtest"</span></span>);</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/42e/a4d/2b0/42ea4d2b0e95612531bf0b6ad066b30b.png" alt="image"><br><br>  The expected base type entity is read.  What if you try to save such a miracle? <br><br>  Here is the code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test = mc.Repositories.Get&lt;CustomerOperationRepository&gt;().GetBySystemName(<span class="hljs-string"><span class="hljs-string">"Webtrackingtest"</span></span>); test.NormalizeAndSetName(<span class="hljs-string"><span class="hljs-string">"SomeOperationName"</span></span>); mc.SubmitChanges();</code> </pre><br>  Nothing terrible happened.  The name has changed, the rest remains the same: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c2f/c74/b06/c2fc74b06baa50854f36769ff19c1191.png" alt="image"><br><br>  Great, let's now try to write WebTrackingOperation into the database (when refactoring, which I described above, the code that creates such entities would necessarily appear).  Attempting this will fail with a funny NullReference, proof: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c5/e21/7f1/6c5e217f14f77212207f517715290a24.png" alt="image"><br><br>  Do not pay attention that the error falls in the mysterious Mindbox.Data.Linq.dll, it falls in the same way in the classic LINQ to SQL.  From an error, as you can see, you never see where to look for a problem, so the bug is not very pleasant.  Be careful and do not forget to specify all types of polymorphic entities in the attributes of Inheritance Mapping. <br><br>  And finally, about the funny property of the discriminator.  Let's try to create a new entity of the base class CustomerOperation, assign the discriminator yourself and save: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newOp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomerOperation(); newOp.NormalizeAndSetName(<span class="hljs-string"><span class="hljs-string">"TestForHabr"</span></span>); newOp.NormalizeAndSetSystemName(<span class="hljs-string"><span class="hljs-string">"TestForHabr"</span></span>); newOp.NormalizeAndSetDescription(<span class="hljs-string"><span class="hljs-string">"TestForHabr"</span></span>); newOp.Discriminator = <span class="hljs-string"><span class="hljs-string">"WebTracking"</span></span>; newOp.Campaign = test.Campaign; mc.Repositories.Get&lt;CustomerOperationRepository&gt;().Add(newOp); mc.SubmitChanges();</code> </pre><br>  This will generate an insert with the value of the Discriminator = WebTracking field, however, after inserting LINQ to SQL, the discriminator will re-set itself ‚Äî that is, it will call its setter with an empty string (because this default value for the base type was specified in the Inheritance Mapping attribute): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38b/968/150/38b9681504d5a5cec47fad02ead08492.png" alt="image"><br><br>  If this behavior does not suit you, then there is a simple workaround: in the setter of the discriminator, ignore the blank line setting. <br><br><h3>  Unsolicited Enumeration </h3><br>  LINQ to SQL has one (no, well, of course, never one, of course, but now it's about a specific one) is a very unpleasant moment.  Almost always, if the linq request was built in such a way that it cannot be squatted to sql, linq throws an exception when calling the enumerator.  The text of such exceptions is known to everyone, it could be something of a type (pulled a couple from the bug tracker): ‚ÄúMember access 'System.DateTime DateTimeUtc' of 'Itc.DirectCrm.Model.CustomerAction' not legal on type 'System.Linq.IQueryable' 1 [Itc.DirectCrm.Model.CustomerAction] ‚Äùor‚Äú Method 'Boolean Evaluate [CustomerLotteryTicket, Boolean] (System.Linq.Expressions.Expression`1 [System.Func`2 [Itc.DirectCrm.Promo.CustomerLotteryTicket, System.Boolean ]], Itc.DirectCrm.Promo.CustomerLotteryTicket) "has no supported translation to SQL‚Äù.  The key word is <b>almost</b> here.  Sometimes LINQ to SQL may consider that instead of throwing a similar exception, it is better to subtract more entities into memory, and already have some conversion in memory.  This is very sad for several reasons: it is not documented in any way (as far as I know), because of this, OutOfMemory sometimes falls (since the subtracted entities will never leave the context, although the code will look as if you are reading anonymous objects that GC will be quickly assembled), as well as due to bugs with Inheritance Mapping.  Actually, let's look at such a bug. <br><br>  There is the essence of ‚ÄúAction Template‚Äù, it reflects various types of actions of people in the system.  There are simple templates: a person made an authorization, went to a specific section of the site, won a prize.  There are also all sorts of mailing lists that we have implemented through other types of action templates - that is, through inheritance mapping.  A piece of code so that everything is good: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Table(Name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"directcrm.ActionTemplates"</span></span></span><span class="hljs-meta">)</span></span>] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">""</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ActionTemplate), IsDefault = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"Hierarchical"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(HierarchicalActionTemplate))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"CustomerToCustomer"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomerToCustomerActionTemplate))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"EmailMailing"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EmailMailingActionTemplate))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"SmsMailing"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SmsMailingActionTemplate))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"BannerCampaign"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(BannerCampaignActionTemplate))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ActionTemplate</span></span> : <span class="hljs-title"><span class="hljs-title">INotifyPropertyChanging</span></span>, <span class="hljs-title"><span class="hljs-title">INotifyPropertyChanged</span></span>, <span class="hljs-title"><span class="hljs-title">IValidatable</span></span>, <span class="hljs-title"><span class="hljs-title">IEntityWithSystemName</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  -  }</span></span></code> </pre><br>  The action template with id = 20 is EmailMailingActionTemplate - Email (I checked), let's subtract it: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actualTemplate = modelContext.Repositories.Get&lt;ActionTemplateRepository&gt;().GetById(<span class="hljs-number"><span class="hljs-number">20</span></span>);</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/fa0/f18/97d/fa0f1897dd848811884d4fe12a2f9160.png" alt="image"><br><br>  Perfectly.  And now we will try to execute a query query before requesting this action template: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test = modelContext.Repositories.Get&lt;ActionTemplateRepository&gt;() .Items .Where(at =&gt; at.Id == <span class="hljs-number"><span class="hljs-number">20</span></span>) .Select(at =&gt; at.EffectiveEndDateTimeUtc) .FirstOrDefault();</code> </pre><br><br>  I specifically limited Id to show that the problem is precisely in this query.  EffectiveEndDateTimeUtc is not a column, it is just a property in the class, before calling Select was not called AsEnumerable, so in theory linq should throw one of those exceptions, examples of which I cited above.  But no.  The query is translated into the following sql (just an entity query): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) [t0].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [t0].[CategoryId], [t0].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>], [t0].[<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>], [t0].[Discriminator], [t0].[RowVersion], [t0].[SystemName], [t0].[CreationCondition], [t0].[UsageDescription], [t0].[StartDateTimeUtcOverride], [t0].[EndDateTimeUtcOverride], [t0].[DateCreatedUtc], [t0].[DateChangedUtc], [t0].[CreatedById], [t0].[LastChangedById], [t0].[CampaignId] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [directcrm].[ActionTemplates] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [t0] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [t0].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = @p0</code> </pre><br>  After such a request, the previous one (pulling out a specific template by Id) returns the action template of the base type: <br><img src="https://habrastorage.org/getpro/habr/post_images/3dc/e59/57c/3dce5957c1557e1aaf9deb141cd9ef89.png" alt="image"><br>  Automatic enumeration, as this result shows, simply does not pay attention to Inheritance Mapping, always creating the base class entities.  Fear automatic enumeration! <br><br>  <b>Comment from <a href="http://habrahabr.ru/users/IharBury">IharBury</a> :</b> <br><blockquote>  I'm afraid this doesn‚Äôt quite reflect what is really going on.  LINQ does not treat code like AsEnumerable.  It performs mapping for mapping and the rest is in memory.  For example, if you make not just the Select properties of an entity, but the Select properties of a related entity, then only a related entity will be created in memory. <br>  It would be a good advice not to make properties for entities that do not use SQL - to make them methods so that the problem is immediately visible. </blockquote><br><br><h3>  Fixeditems </h3><br>  You may have noticed that in the part where I talked about problems with the discriminator, I had the following code presented: <br><br><pre> <code class="cs hljs">modelContext.Repositories.Get&lt;CustomerOperationRepository&gt;() .FixedItems.OfType&lt;WebTrackingOperation&gt;() .FirstOrDefault();</code> </pre><br>  As you can guess, all access to the DBMS from the code is through the repository.  Each repository has helper methods for getting entities for some features (consumers' repository has GetByName method, etc.), but since it‚Äôs not practical to create their own method for each, then each of our repositories has the Items property - it is just iQueryable of the necessary entities.  But what are FixedItems on CustomerOperationRepository?  The funny thing is that the FixedItems property in the code looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;TCampaignItem&gt; FixedItems { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Items.Select(item =&gt; item); } }</code> </pre><br><br>  This is one of the crutches that you have to use when working with LINQ to SQL.  In order to explain the problem, it is necessary to describe the situation a little. <br><br>  CustomerOperationRepository gives access to CustomerOperation entities, but the CustomerOperation entity itself is a campaign element (of our large aggregate, to which quite a lot of other entities are attached).  These entities have similar validation, there are many common properties, so that they are inherited from one class and their repositories are also inherited.  Also, all campaign elements are inherited from the ICampaignItem interface, and the base class of the repository takes the entity type as the first parameter of the generic: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CampaignItemRepositoryBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TCampaignItem</span></span>, <span class="hljs-title"><span class="hljs-title">TInitialState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ChangeRestrictedExtensionSubsetRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TCampaignItem</span></span>, <span class="hljs-title"><span class="hljs-title">int</span></span>, <span class="hljs-title"><span class="hljs-title">Campaign</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">ICampaignItemRepository</span></span>, <span class="hljs-title"><span class="hljs-title">ICampaignRelatedItemRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TCampaignItem</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCampaignItem</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">ICampaignItem</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TInitialState</span></span> : <span class="hljs-title"><span class="hljs-title">CampaignItemInitialState</span></span></code> </pre><br>  The problem is that the methods of this class refer to the TCampaignItem fields using the ICampaignItem interface, and there is indeed a <a href="https://social.msdn.microsoft.com/Forums/en-US/5691e0ad-ad67-47ea-ae2c-9432e4e4bd46/l2s-doesnt-like-it-when-you-wrap-column-properties-with-properties-in-an-interface%3Fforum%3Dlinqtosql">known problem</a> that LINQ to SQL does not map properties defined in interfaces.  Therefore, a request, for example, of all operations associated with a campaign (Where (item =&gt; item.CampaignId == campaign.Id)), falls with InvalidOperationException: MappingOfInterfacesMemberIsNotSupported: ICampaignItem, CampaignId.  In this case, adding a seemingly useless IQueryable to the chain Select (item =&gt; item) solves all problems in a magical way.  You can also use the object.Equals method instead of the ==: Where (item =&gt; Equals (item.CampaignId, campaign.Id) operator), such a query is translated without using FixedItems. <br><br><h3>  Null / Not null in different heirs </h3><br>  Short and clear bug.  LINQ to SQL does not support different settings for null and not null in the heirs for the same field.  For example: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Table(Name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"directcrm.CustomerOperations"</span></span></span><span class="hljs-meta">)</span></span>] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">""</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomerOperation), IsDefault = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"Service"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomerServiceOperation))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"Custom"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomCustomerServiceOperation))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"PerformAction"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(PerformActionCustomerServiceOperation))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"WebTracking"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(WebTrackingOperation))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"IdentificationTracking"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IdentificationTrackingOperation))] [InheritanceMapping(Code = <span class="hljs-string"><span class="hljs-string">"CustomerOperationByStaff"</span></span>, Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CustomerOperationByStaff))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomerOperation</span></span> : <span class="hljs-title"><span class="hljs-title">CampaignItemBase</span></span>, <span class="hljs-title"><span class="hljs-title">ICampaignItem</span></span></code> </pre><br><br>  PerformActionCustomerServiceOperation requires that the operationStepGroupId value is always (this is required by the domain model), but the same operationStepGroupId field in the IdentificationTrackingOperation may be missing.  The base class for these two entities is CustomerOperation, in which there is no operationStepGroupId, this field is added separately both in the PerformActionCustomerServiceOperation and in IdentificationTrackingOperation. <br><br>  This is how it happens.  Pay attention to the CanBeNull values ‚Äã‚Äãand column type in different entities: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">IdentificationTrackingOperation</span></span> : <span class="hljs-title"><span class="hljs-title">CustomerOperation</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? operationStepGroupId; [Column(Storage = <span class="hljs-string"><span class="hljs-string">"operationStepGroupId"</span></span>, CanBeNull = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? OperationStepGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> operationStepGroupId; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (operationStepGroupId != <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { SendPropertyChanging(); operationStepGroupId = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; SendPropertyChanged(); } } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PerformActionCustomerServiceOperation</span></span> : <span class="hljs-title"><span class="hljs-title">CustomerServiceOperation</span></span>, <span class="hljs-title"><span class="hljs-title">IPerformActionCustomerServiceOperation</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> operationStepGroupId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EntityRef&lt;OperationStepGroup&gt; operationStepGroup; [Column(Storage = <span class="hljs-string"><span class="hljs-string">"operationStepGroupId"</span></span>, CanBeNull = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OperationStepGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> operationStepGroupId; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (operationStepGroupId != <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { SendPropertyChanging(); operationStepGroupId = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; SendPropertyChanged(); } } } }</code> </pre><br>  Well, fine, and now we will try to read the list of operations from the database.  One of these operations is IdentificationTrackingOperation, which has no OperationStepGroupId. <br><br>  The attempt fails as expected because we get an InvalidOperationException: CannotAssignNull: System.Int32. <br><br>  How to deal with it?  We made it easy - for LINQ, PerformActionCustomerServiceOperation was allowed to have no values ‚Äã‚Äãfor OperationStepGroupId, and in our validation we check this separately.  <b>It is important that CanBeNull in all successors has the same value, otherwise you will have LINQ to SQL debug sessions for a couple of hours.</b> <br><br><h3>  Those who read a surprise </h3><br>  You may have noticed that errors in LINQ in my screenshots fall in an assembly called Mindbox.Data.Linq.dll.  Yes, we forked LINQ to SQL.  For example, now you can use not only the InheritanceMappingAttribute, but also the void AddInheritance &lt;TRoot, T&gt; (object code) method on Mindbox.Data.Linq.Mapping.MindboxMappingConfiguration, which allows you to register the heirs of entities in different assemblies. <br><br>  Our fork can be delivered via Nuget: <a href="">Mindbox.Data.Linq</a> . <br><br>  Maybe you want to help or take advantage of - good luck with that. </div><p>Source: <a href="https://habr.com/ru/post/253779/">https://habr.com/ru/post/253779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253769/index.html">How to catch what is not. Part Two: Projectile and Armor</a></li>
<li><a href="../253771/index.html">Kerio Control 8.2 received the certificate of FSTEC of Russia</a></li>
<li><a href="../253773/index.html">Integration phpBB site (Codeigniter). Pass-through authorization</a></li>
<li><a href="../253775/index.html">Yandex.Browser: the interface of the future is now in beta</a></li>
<li><a href="../253777/index.html">Runscope: convenient to test API</a></li>
<li><a href="../253781/index.html">The use of MEMS gyroscopes and accelerometers to track human body movements</a></li>
<li><a href="../253783/index.html">Backing up to the cloud with the help of a new feature Veeam</a></li>
<li><a href="../253785/index.html">Testing flash storage. IBM FlashSystem 840</a></li>
<li><a href="../253787/index.html">10 things you didn't know about java</a></li>
<li><a href="../253791/index.html">A short course in computer graphics, addendum: GLSL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>