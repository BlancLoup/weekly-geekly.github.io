<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Little special container magic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, I gave an example of a factory for obtaining IQuery implementations, but did not explain the mechanism of its work 


_queryFacto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Little special container magic</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/post/259829/">last article,</a> I gave an example of a factory for obtaining IQuery implementations, but did not explain the mechanism of its work <br><img align="left" src="https://habrastorage.org/files/0b6/bc8/2ac/0b6bc82acd4c43519049cbf6ae280257.jpg"><pre><code class="hljs pgsql">_queryFactory.GetQuery&lt;Product&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(Product.ActiveRule) .OrderBy(x =&gt; x.Id) .Paged(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) //  <span class="hljs-number"><span class="hljs-number">10</span></span>     //        ElasticSearch,  : _queryFactory.GetQuery&lt;Product, FullTextSpecification&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FullTextSpecification(¬´¬ª)) .<span class="hljs-keyword"><span class="hljs-keyword">All</span></span>() //  EF          Dapper _queryFactory.GetQuery&lt;Product, DictionarySpecification, DapperQuery&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DictionarySpecification (someDirctionary)) .<span class="hljs-keyword"><span class="hljs-keyword">All</span></span>()</code> </pre> <br>  In this article I want to share the technique of registering the necessary components of the assembly according to the agreements.  Now I have a code base at hand with a different implementation of CQRS, so the examples will be different.  It does not matter: the basic idea remains unchanged. <br><br>  Suppose you have an interface where <i>ListParams</i> is a specification coming from the frontend <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IListOperation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TDto</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">ListResult&lt;TDto&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ListParams listParam)</span></span></span></span>; }</code> </pre><br>  <b>Task</b> <br>  Rid application developers from writing controllers, projections and services. <br><a name="habracut"></a><br><br>  <b>Decision</b> <br>  Create a base class for the List operation: <br><pre> <code class="hljs haskell"> public <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">ListOperationBase</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TEntity</span></span>, <span class="hljs-type"><span class="hljs-type">TDto</span></span>&gt; : <span class="hljs-type"><span class="hljs-type">IListOperation</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TDto</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">TEntity</span></span>: <span class="hljs-type"><span class="hljs-type">IEntity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">TDto</span></span>: <span class="hljs-type"><span class="hljs-type">IHaveId</span></span> { protected readonly <span class="hljs-type"><span class="hljs-type">IDbContext</span></span> <span class="hljs-type"><span class="hljs-type">DbContext</span></span> ; public <span class="hljs-type"><span class="hljs-type">ListOperationBase</span></span>(<span class="hljs-type"><span class="hljs-type">IDbContext</span></span> dbContext ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dbContext == null) throw new <span class="hljs-type"><span class="hljs-type">ArgumentNullException</span></span>(nameof(dbContext)); <span class="hljs-type"><span class="hljs-type">DbContext</span></span> = dataStore; } public virtual <span class="hljs-type"><span class="hljs-type">ListResult</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TDto</span></span>&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">ListParam</span></span> listParam) { var <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AddProjectionBusinessLogic</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AddEntityBusinessLogic</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataStore</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetAll</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity</span></span></span><span class="hljs-class">&gt;()) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ProjectTo</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TDto</span></span></span><span class="hljs-class">&gt;()) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Filter</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">listParam</span></span></span><span class="hljs-class">); return new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ListResult</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TDto</span></span></span><span class="hljs-class">&gt;() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Paging(listParam)</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToList</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TotalCount</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">() }; } protected virtual </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AddEntityBusinessLogic</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class">) =&gt; queryable; protected virtual </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TDto</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AddProjectionBusinessLogic</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TDto</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class">) =&gt; queryable; }</span></span></code> </pre><br>  The <i>ProjectTo</i> method is an <a href="https://github.com/AutoMapper/AutoMapper/wiki/Queryable-Extensions">AutoMapper feature</a> that allows you to build projections on agreements.  Eliminates the need to raise the entire <i>Entity</i> in memory, while allowing you not to write dull <i>Select</i> constructions of the form <br><pre> <code class="hljs pgsql">Query.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; { <span class="hljs-type"><span class="hljs-type">Name</span></span> = x.Name, ParentUrl = x.Parent.Url, Foo = x.Foo })</code> </pre><br>  The virtual methods <i>AddEntityBusinessLogic</i> and <i>AddProjectionBusinessLogic</i> allow you to add filtering conditions before and after creating a projection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now for fast prototyping we can use <i>ListOperationBase &lt;TEntity, TDto&gt;</i> and for real implementations, we need to create real operations with the correct logic.  To do this, at the start of the application you need to register everything that is in the assembly under the agreements.  In my case, the modular architecture is used and this is the module load code.  For monolithic applications, you will need to make a list of assemblies from which you want to load types. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> types = GetType().Assembly.GetTypes(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> operations = types .Where(t.IsClass &amp;&amp; !t.IsAbstract &amp;&amp; t.ImplementsOpenGenericInterface(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IListOperation&lt;&gt;))); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> operation <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> operations) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> definitions = operation.GetInterfaces().Where(i =&gt; i.ImplementsOpenGenericInterface(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (IListOperation&lt;&gt;))); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> definition <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> definitions) { Container.Register(definition, operation); } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  You need only one controller for all Crud operations.  You can find the implementation of ControllerSelector for Generic WebApi controllers at: <a href="">github.com/hightechtoday/costeffectivecode/blob/master/src/CostEffectiveCode.WebApi2/WebApi/Infrastructure/RuntimeScaffoldingHttpControllerSelector.</a> <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ListResult&lt;TListDto&gt; <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>(ListParam loadParams) =&gt; (_container.ResolveAll&lt;IListOperation&lt;TListDto&gt;&gt;().SingleOrDefault() ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ListOperationBase&lt;TEntity,TListDto&gt;(DataStore)) .<span class="hljs-keyword"><span class="hljs-keyword">List</span></span>(loadParams);</code> </pre><br>  Transferring the container to the controller is of course an idea of ‚Äã‚Äãitself ( <i>ServiceLocator</i> ) and in fact it is much better to wrap the call in a factory method (as is done in the <i>QueryFactory</i> example).  Another weak point is what to do if 2 <i>IListOperation</i> implementations with the same types are registered.  There is no definitive answer to this question: it all depends on the specifics of your application and system requirements. <br><br>  As a result, we got a system for rapid prototyping, which saves the programmer from writing controllers and registering services in a container.  All you need to do is add the entity, DTO and describe the mapping.  In the case of using <i>AutoMapper</i> , you should definitely add the <i>Mapper.AssertConfigurationIsValid ();</i>  It will help you learn about errors if you have to change Entity or Dto.  By the way, by analogy with the registration of operations, you can automate the creation of mappings under agreements for cases when all mappings are obvious.  However, in real life, several lines have to be added to the mapping quite often, so I prefer to do it manually, the benefit is just a couple of lines. <br><br>  <b>Steps</b> <br><ol><li>  Add <i>SomeEntity: IEntity</i> </li><li>  Add <i>SomeEntityListDto</i> </li><li>  Register the mapping <i>SomeEntity -&gt; SomeEntityListDto</i> </li><li>  Automaton we get the method <i>/ SomeEntity / List</i> </li><li>  We add business logic to <i>SomeEntityListOperation &lt;SomeEntity, SomeEntityListDto&gt;</i> </li><li>  The <i>/ SomeEntity / List</i> method starts using a new implementation with ‚Äúcorrect‚Äù business logic. </li></ol><br>  Mapping can be omitted if the Entity can be transferred to the presentation layer / serialized smoothly "as is". </div><p>Source: <a href="https://habr.com/ru/post/305050/">https://habr.com/ru/post/305050/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305018/index.html">Functors (chapter of the book "Category Theory for Programmers")</a></li>
<li><a href="../305022/index.html">How to work correctly with virtual machine snapshots</a></li>
<li><a href="../305026/index.html">Kaggle: A story about how we learned to predict the relevance of search queries and took 3rd place</a></li>
<li><a href="../305034/index.html">Changes in data centers: Technological solutions</a></li>
<li><a href="../305048/index.html">Comparison of DLMS / COSEM, SML and IEC 61850 communication protocols for smart metering applications</a></li>
<li><a href="../305058/index.html">Experience finding a job and moving to Dubai</a></li>
<li><a href="../305072/index.html">How do universities teach future security guards?</a></li>
<li><a href="../305074/index.html">Redux-Redents is (yet) one module for working with server data from React-Redux applications.</a></li>
<li><a href="../305076/index.html">How big data changes the media advertising market</a></li>
<li><a href="../305096/index.html">To the birthday of the Dalai Lama</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>