<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We study the MMP protocol (Mail.ru agent) and write an alternative client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's no secret that Mail.ru Agent has become quite a popular IM project. Here you and support for ICQ, XMPP, voice calls and even sending SMS, only no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We study the MMP protocol (Mail.ru agent) and write an alternative client</h1><div class="post__text post__text-html js-mediator-article">  It's no secret that Mail.ru Agent has become quite a popular IM project.  Here you and support for ICQ, XMPP, voice calls and even sending SMS, only now the company Mail.ru completely forgot about the developers. <br>  <a href="http://agent.mail.ru/ru/developers/protocol.html">The official documentation of the Mail.ru Data Exchange Protocol Agent</a> describes the protocol version 1.7 implemented in 2008.  At the moment the server uses protocol version 1.24. <br><a name="habracut"></a><br><h4>  A bit of theory </h4><br>  At first glance, writing a network client is nothing complicated, but there are many ‚Äúpitfalls‚Äù in network programming.  Without understanding the details of how TCP / IP works, it‚Äôs almost impossible to write an effective and stable application. <br><br><h5>  Data integrity </h5><br>  As you know, TCP is a streaming protocol, and although data is transmitted in IP packets, the packet size is not directly related to the amount of data transmitted by TCP.  Therefore, it is impossible to say with confidence that when calling recv we will get the specified number of bytes. <br>  To get data of a given length, I use this function <br><pre><code class="hljs lua">#define SEND <span class="hljs-number"><span class="hljs-number">0</span></span> #define RECV <span class="hljs-number"><span class="hljs-number">1</span></span> int (__stdcall *tcp_func)(SOCKET s,<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* buf,int <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>,int flags); //   /    <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> int tcp_rs(unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>,SOCKET s, void *buf, int <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>, int flags) { int total = <span class="hljs-number"><span class="hljs-number">0</span></span>; int n; *(void* *)&amp;tcp_func=(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>==SEND)?&amp;send:&amp;recv; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(total &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>) { n = tcp_func(s, (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *)buf+total, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>-total, flags); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { total += n; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n == <span class="hljs-number"><span class="hljs-number">0</span></span>) { closesocket(s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { n=WSAGetLastError(); closesocket(s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (!n+<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> total; }</code> </pre> <br>  which, if successful, returns the number of received / transmitted bytes equal to len, 0 if the connection was terminated or closed, and (minus) the error number if the call to the send / recv function fails. <br><br><h5>  Network outages </h5><br>  It is also necessary to remember that TCP does not poll the connection.  In the case of blocking sockets, if the server crashes (disconnection, failure), we will wait for a response ‚Äúforever‚Äù, the program will simply ‚Äúhang‚Äù. <br>  One way to determine if a connection is broken is a keep-alive timer. <br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SIO_KEEPALIVE_VALS _WSAIOW(IOC_VENDOR,4) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(push,1) //   typedef struct tcp_keepalive { DWORD onoff; DWORD keepalivetime; DWORD keepaliveinterval; } tcp_keepalive; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(pop) //     keep-alive struct tcp_keepalive alive; DWORD dwSize; alive.onoff = 1; alive.keepalivetime = 5000; alive.keepaliveinterval = 1000; WSAIoctl(my_sock, SIO_KEEPALIVE_VALS, &amp;alive, sizeof(alive),NULL, 0, &amp;dwSize, NULL, NULL);</span></span></code> </pre><br>  In our case, if the connection is not active for 5 seconds, a service message will be sent, if there is no answer to it, the connection will be closed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  About protocol </h4><br>  MMP binary asynchronous protocol.  Binary means that data is transmitted in the form of packets of a certain structure: <br><pre> <code class="hljs pgsql">//   typedef struct mrim_packet_header_t { unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> magic; // Magic unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> proto; //   unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> seq; // <span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> msg; //   unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> dlen; //   unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>; //   unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> fromport; //   unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> reserved[<span class="hljs-number"><span class="hljs-number">16</span></span>]; //  } mrim_packet_header_t; //    ,   MFC, Delphi  typedef struct LPS { unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> len; unsigned <span class="hljs-type"><span class="hljs-type">char</span></span> *str; } LPS;</code> </pre><br>  Asynchrony here is characterized by the fact that the server, maintaining a constant connection at different time intervals, sends data packets to the client, having received which the client can (and in some cases should) respond and send a response to the server. <br><br>  The client initializes the connection, before this it is necessary to get the address of the ‚Äúfree‚Äù MMP server in text format <i>ip: port</i> , simply by connecting to <b>mrim.mail.ru.</b>  The official client version 5.9 uses the following ports for connection: 2024, 80, 5190, 1863, 25, 110, 443. <br>  As stated in the official documentation, after connecting to the recommended address, the client must send the package MRIM_CS_HELLO, wait for MRIM_CS_HELLO_ACK, then send the authorization package, then the most interesting begins. <br><br><h5>  In fact </h5><br>  Starting with version 1.22 (Mail.ru agent 5.7), the authorization method has changed.  Now for authorization you need to send a package <b>0x1078</b> (MRIM_CS_LOGIN3) with parameters <br><br>  LPS ## login ## login user email <br>  LPS ## md5 password ## password encrypted in md5 <br>  Ffffffff <br>  and 1391 bytes identifying the Mail.ru client <br><br>  At the moment (protocol version 1.24) the protocol supports mandatory encryption.  After receiving the MRIM_CS_HELLO_ACK packet, the client sends the 0x1086 packet and receives the 0x1087 response, after which the SSL connection is initialized. <br>  But so far no one forbids us to use earlier versions of the protocol. <br><br>  An important feature of the client‚Äôs work is that the client can send its requests only after receiving the package MRIM_CS_CONTACT_LIST2 from the server, which in turn is sent after successful authorization. <br><br><h4>  Projects </h4><br>  All the client's MMP code would take up a lot of space, so I suggest you download and study it yourself.  The archive <a href="">MMPclient_sample.25.04.2011.rar</a> , are the source code in the C language and the project Visual Studio. <br>  <b>UPD: <a href="https://github.com/Garik-/Simple-MMP-client">source on github</a></b> <br><br>  To study the protocol was written by a small SOCKS 5 server.  It allows you to track the message chain of the client and the server in a convenient way.  <a href="">Server sources and project</a> can be downloaded here. <br><br>  And: <br><ul><li>  <a href="">Mail.ru Get Key</a> - a program for obtaining a web-authorization key, which can be used to log into the box using the md5 password hash </li><li>  <a href="https://forum.antichat.ru/thread133090.html">Mail.ru SMS sender</a> - program for sending SMS messages </li><li>  <a href="https://forum.antichat.ru/thread170703.html">Bruteforce MMP</a> - password selection service Mail.ru </li></ul><br><h4>  Links </h4><br>  <a href="http://agent.mail.ru/ru/download/agent_windows/old_versions.html">All versions of Mail.ru Agent</a> <br>  <a href="http://agent.mail.ru/ru/developers/protocol.html">Official protocol documentation</a> <br><br>  <a href="http://www.insidepro.com/kk/006/006r.shtml">Tutorial games on WINSOCK</a> <br>  <a href="">Detecting a broken TCP connection</a> <br>  <a href="http://www.ozon.ru/context/detail/id/126048/">Efficient TCP / IP programming</a> </div><p>Source: <a href="https://habr.com/ru/post/136041/">https://habr.com/ru/post/136041/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136033/index.html">Kotlin web code editor with examples and JavaScript compilation</a></li>
<li><a href="../136036/index.html">DROID RAZR MAXX or ‚ÄúFinally an Android smartphone with a good battery‚Äù</a></li>
<li><a href="../136037/index.html">Interesting -webkit CSS properties</a></li>
<li><a href="../136038/index.html">Top 10 games for iPhone / iPad (2011)</a></li>
<li><a href="../136039/index.html">CES 2012: new ultrabooks, tablet computers and the first real smartphone with the Intel Atom inside</a></li>
<li><a href="../136042/index.html">Published source code and developer tools for Tizen mobile OS</a></li>
<li><a href="../136043/index.html">Corel has released an image editor, AfterShot Pro, similar in functionality to Lightroom, with a version for Linux.</a></li>
<li><a href="../136045/index.html">Adobe has released Lightroom 4 beta</a></li>
<li><a href="../136046/index.html">Introduction to OVAL: Open vulnerability and Assessment Language</a></li>
<li><a href="../136047/index.html">Markdown, Dropbox and Hosting / Blogging platform for perfectionists</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>