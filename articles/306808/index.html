<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remote control server daemon do it yourself</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Today I will talk about how to control a computer from a mobile device. No, this is not just another analogue of radmin, and not an examp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remote control server daemon do it yourself</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  Today I will talk about how to control a computer from a mobile device.  No, this is not just another analogue of radmin, and not an example of how you can make fun of a friend's computer.  It will be about remote control of the daemon, or rather, about creating an interface for managing the daemon written in Python. <br><br>  The architecture is pretty simple: <br><ul><li>  <i><a href="https://habr.com/ru/post/306808/">"Remote control App"</a></i> - Kivy-application that implements the client part for mobile devices. </li><li>  <i><a href="https://habr.com/ru/post/306808/">"Remote control"</a></i> - Django-application that implements the <a href="https://habr.com/ru/post/306808/">REST API</a> and interaction with the database; </li><li>  <i><a href="https://habr.com/ru/post/306808/">IRemoteControl</a></i> - A class that implements the logic for processing incoming commands (to be used in the daemon); </li></ul><br>  Interested - welcome under cat. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before embarking on implementation, I propose to ‚Äúprepare‚Äù the project catalog.  Need to: <br><ul><li>  create a separate python virtual environment <pre><code class="bash hljs">virtualenv .env</code> </pre> </li><li>  create a new Django project (for example, web) <pre> <code class="bash hljs">django-admin startproject web</code> </pre>  All operations with Django will be performed relative to this directory; </li><li>  Create a directory for an Android application (for example, ui_app).  All operations regarding the mobile application will be performed relative to this directory. </li></ul><br><br><a name="remotecontrol"></a><h3>  "Remote control" </h3><br>  Let's start with the server part - Django-applications.  Create a new application and add a superuser: <br><pre> <code class="bash hljs">python manage.py startapp remotecontrol</code> </pre><br>  I recommend immediately adding it to the applications used by the Django project (web \ settings.py or, instead of ‚Äúweb‚Äù, the name of your Djnago project): <br><pre> <code class="python hljs">INSTALLED_APPS = [ ....... <span class="hljs-string"><span class="hljs-string">'remotecontrol'</span></span>, ]</code> </pre><br>  Create a database and superuser'a: <br><pre> <code class="bash hljs">python manage.py migrate python manage.py createsuperuser</code> </pre><br>  Settings completed, proceed to the implementation of the application. <br><br><h4>  Models (remotecontrol \ models.py) </h4><br>  The model in architecture is the same - this is the command to which the demon must respond.  Model Fields: <br><ul><li>  <i>Command code</i> - we will use 4 commands: ‚ÄúSuspend‚Äù, ‚ÄúResume‚Äù, ‚ÄúRestart‚Äù, ‚ÄúDisable remote control‚Äù </li><li>  <i>Team status</i> - 4 states are possible: "Created", "In Processing", "Completed", "Rejected". </li><li>  <i>IP</i> </li><li>  <i>Object Creation Date</i> </li></ul><br>  More information about teams and statuses - <a href="https://habr.com/ru/post/306808/">see below</a> . <br><br><div class="spoiler">  <b class="spoiler_title">We describe the model:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from django.db import models #   CODE_PAUSE = 1 #   "" CODE_RESUME = 2 #   "" CODE_RESTART = 3 #   "" CODE_REMOTE_OFF = 4 #   "  " COMMANDS = ( (CODE_RESTART, 'Restart'), (CODE_PAUSE, 'Pause'), (CODE_RESUME, 'Resume'), (CODE_REMOTE_OFF, 'Disable remote control'), ) class Command(models.Model): #   STATUS_CREATE = 1 #   "" STATUS_PROCESS = 2 #   " " STATUS_DONE = 3 #   "" STATUS_DECLINE = 4 #   "" STATUS_CHOICES = ( (STATUS_CREATE, 'Created'), (STATUS_PROCESS, 'In progress...'), (STATUS_DONE, 'DONE'), (STATUS_DECLINE, 'Declined'), ) #   created = models.DateTimeField(auto_now_add=True) ip = models.GenericIPAddressField() code = models.IntegerField(choices=COMMANDS) status = models.IntegerField(choices=STATUS_CHOICES, default=STATUS_CREATE)</span></span></code> </pre></div></div><br>  A little ‚Äúupgrade‚Äù model: <br><br>  1. Expand the standard manager.  Add methods to get commands in the "Created" state and in the "In Processing" state. <br><br><div class="spoiler">  <b class="spoiler_title">We describe our manager:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandManager</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Manager)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    "",        def created(self): return super(CommandManager, self).get_queryset().filter( status=Command.STATUS_CREATE).order_by('created') #    " ",        def processing(self): return super(CommandManager, self).get_queryset().filter( status=Command.STATUS_PROCESS).order_by('created')</span></span></code> </pre></div></div><br>  And add it to the model: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> ....... objects = CommandManager()</code> </pre><br><br>  2. Add state checking methods and methods for setting the command state: <br><br><div class="spoiler">  <b class="spoiler_title">Add.</b>  <b class="spoiler_title">methods:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> ....... <span class="hljs-comment"><span class="hljs-comment">#    def is_created(self): return self.status == self.STATUS_CREATE def is_processing(self): return self.status == self.STATUS_PROCESS def is_done(self): return self.status == self.STATUS_DONE def is_declined(self): return self.status == self.STATUS_DECLINE #    def __update_command(self, status): self.status = status self.save() def set_process(self): self.__update_command(Command.STATUS_PROCESS) def set_done(self): self.__update_command(Command.STATUS_DONE) def set_decline(self): self.__update_command(Command.STATUS_DECLINE)</span></span></code> </pre></div></div><br>  <i>Note: Of course, you can do without these methods.</i>  <i>In this case, the code working with Django ORM will need to use constants and describe the logic (at least two-line, but still) command updates, which, IMHO, is not very convenient.</i>  <i>Much more convenient to pull the necessary methods.</i>  <i>But if this approach is contrary to the concept - I will be happy to hear the arguments in the comments.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Full listing of models.py:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from django.db import models #   CODE_PAUSE = 1 #   "" CODE_RESUME = 2 #   "" CODE_RESTART = 3 #   "" CODE_REMOTE_OFF = 4 #   "  " COMMANDS = ( (CODE_RESTART, 'Restart'), (CODE_PAUSE, 'Pause'), (CODE_RESUME, 'Resume'), (CODE_REMOTE_OFF, 'Disable remote control'), ) class CommandManager(models.Manager): #    "",        def created(self): return super(CommandManager, self).get_queryset().filter( status=Command.STATUS_CREATE).order_by('created') #    " ",        def processing(self): return super(CommandManager, self).get_queryset().filter( status=Command.STATUS_PROCESS).order_by('created') class Command(models.Model): #   STATUS_CREATE = 1 #   "" STATUS_PROCESS = 2 #   " " STATUS_DONE = 3 #   "" STATUS_DECLINE = 4 #   "" STATUS_CHOICES = ( (STATUS_CREATE, 'Created'), (STATUS_PROCESS, 'In progress...'), (STATUS_DONE, 'DONE'), (STATUS_DECLINE, 'Declined'), ) #   created = models.DateTimeField(auto_now_add=True) ip = models.GenericIPAddressField() code = models.IntegerField(choices=COMMANDS) status = models.IntegerField(choices=STATUS_CHOICES, default=STATUS_CREATE) objects = CommandManager() #    def is_created(self): return self.status == self.STATUS_CREATE def is_processing(self): return self.status == self.STATUS_PROCESS def is_done(self): return self.status == self.STATUS_DONE def is_declined(self): return self.status == self.STATUS_DECLINE #    def set_process(self): self.__update_command(Command.STATUS_PROCESS) def set_done(self): self.__update_command(Command.STATUS_DONE) def set_decline(self): self.__update_command(Command.STATUS_DECLINE) def __update_command(self, status): self.status = status self.save() #   - STATUS_COLORS = { STATUS_CREATE: '000000', STATUS_PROCESS: 'FFBB00', STATUS_DONE: '00BB00', STATUS_DECLINE: 'FF0000', } def colored_status(self): return '&lt;span style="color: #%s;"&gt;%s&lt;/span&gt;' % (self.STATUS_COLORS[self.status], self.get_status_display()) colored_status.allow_tags = True colored_status.short_description = 'Status' #     REST API def status_dsp(self): return self.get_status_display() def code_dsp(self): return self.get_code_display()</span></span></code> </pre></div></div><br><br><h4>  Admin Panel (remotecontrol \ admin.py) </h4><br>  <i>Note: From here on, we will need the ‚Äúdjango-ipware‚Äù application to determine the client's IP, install:</i> <i><br></i> <pre> <i><code class="bash hljs">pip install django-ipware</code></i> </pre><br>  Here everything goes natively: register the model in the admin panel, describe the displayed columns in the table and fields on the form.  The only caveat is that in order to save the client's IP in the object, you must override the save method: <br><br><div class="spoiler">  <b class="spoiler_title">Listing admin.py:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from django.contrib import admin from ipware.ip import get_ip from .models import Command @admin.register(Command) class CommandAdmin(admin.ModelAdmin): #       list_display = ('created', 'code', 'colored_status', 'ip') #       list_filter = ('code', 'status', 'ip') #     \  fields = (('code', 'status'), ) #     def save_model(self, request, obj, form, change): if obj.ip is None: #    IP     obj.ip = get_ip(request) obj.save()</span></span></code> </pre></div></div><br>  Do not forget to apply the changes in the models to the database: <br><pre> <code class="bash hljs">python manage.py makemigrations remotecontrol python manage.py migrate remotecontrol</code> </pre><br><div class="spoiler">  <b class="spoiler_title">As a result, we have the ability to create \ edit objects ...</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d93/d96/077/d93d9607778648669a9f68f5faed33c3.png" alt="Creating \ editing a command object"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">... and view the list of objects in the admin panel:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/5b1/c44/da7/5b1c44da752a4b489a306595e0e6d396.png" alt="list of objects"><br></div></div><br>  We proceed to the implementation of command processing logic. <br><br><a name="iremotecontrol"></a><h3>  Class IRemoteControl </h3><br>  As it was written above, we have 4 teams at our disposal: <br><ul><li>  <i>‚ÄúSuspend‚Äù</i> - pauses the main loop of the daemon and ignores all commands except ‚ÄúResume‚Äù, ‚ÄúRestart‚Äù and ‚ÄúDisable Remote‚Äù; </li><li>  <i>‚ÄúResume‚Äù</i> - resumes the main daemon cycle; </li><li>  <i>‚ÄúRestart‚Äù</i> - re-initializes the daemon, re-reads the configuration, etc.  This command is also executed in the case of the ‚ÄúPause‚Äù command action, but after restarting it resumes the main loop; </li><li>  <i>‚ÄúDisable remote control‚Äù</i> - stops processing incoming commands (all further commands will be ignored).  This command is also executed in the case of the ‚ÄúSuspend‚Äù command. </li></ul><br>  When creating, the team is assigned the status ‚ÄúCreated‚Äù (thanks, Cap!).  During processing, the command can be ‚ÄúExecuted‚Äù (if the state of the system satisfies all necessary conditions) or ‚ÄúRejected‚Äù (otherwise).  The ‚ÄúIn Processing‚Äù state is applicable for ‚Äúlong-playing‚Äù teams - their execution may require a long period of time.  For example, having received the ‚ÄúPause‚Äù command, the code only changes the value of the flag, and the ‚ÄúRestart‚Äù command initiates the execution of more complex logic. <br><br>  The command processing logic is as follows: <br><ul><li>  During one iteration, one command is processed; </li><li>  We get the most "old" team in the "In Processing" state.  If there are none, we get the ‚Äúoldest‚Äù in the ‚ÄúCreated‚Äù state.  If not, the iteration is completed; </li><li>  If the command is received from an invalid IP - set the status to "Rejected".  Iteration is complete; </li><li>  If the control panel is disabled, we set the command to ‚ÄúRejected‚Äù status.  Iteration is complete; </li><li>  If the command is not valid for the current state of the daemon, set the state to ‚ÄúRejected‚Äù.  Iteration is complete; </li><li>  Set the status "In Processing" (if required), execute the command, set the status "Completed".  Iteration is complete. </li></ul><br><br>  The ‚Äúentry point‚Äù in the class is the .check_commands () method - it implements the logic described above.  The same method will be called in the main daemon loop.  In case of receiving the ‚ÄúPause‚Äù command, a cycle is created in the method, the condition for exiting which is to receive the ‚ÄúResume‚Äù command - thus achieving the desired effect of the pause in the operation of the daemon. <br><br><h4>  Module control.py (remotecontrol \ control.py) </h4><br>  The module in which we describe the implementation of IRemoteControl, I propose to place in the application directory.  So we will receive conveniently transported Django-app. <br><br><div class="spoiler">  <b class="spoiler_title">Listing control.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import django django.setup() from time import sleep from remotecontrol.models import * class IRemoteControl(object): #   IP.   ,    . IP_WHITE_LIST = ['127.0.0.1'] #    CODE_REMOTE_OFF REMOTE_ENABLED = True #      def __get_command(self): commands = Command.objects.processing() if len(commands) == 0: commands = Command.objects.created() if len(commands) == 0: return None command = commands[0] if self.IP_WHITE_LIST and command.ip not in self.IP_WHITE_LIST: print('Wrong IP: %s' % command.ip) elif not self.REMOTE_ENABLED: print('Remote is disabled') else: return command self.__update_command(command.set_decline) #    "" def __restart(self, command): if command.is_created(): self.__update_command(command.set_process) print('... Restarting ...') sleep(5) self.__update_command(command.set_done) print('... Restart complete ...') #       def __update_command(self, method): try: method() except Exception as e: print('Cannot update command. Reason: %s' % e) #     def check_commands(self): pause = False enter = True while enter or pause: enter = False command = self.__get_command() if command is not None: if command.code == CODE_REMOTE_OFF: self.__update_command(command.set_done) print('... !!! WARNING !!! Remote control is DISABLED ...') self.REMOTE_ENABLED = False elif command.code == CODE_RESTART: self.__restart(command) pause = False elif pause: if command.code == CODE_RESUME: self.__update_command(command.set_done) print('... Resuming ...') pause = False else: self.__update_command(command.set_decline) else: if command.code == CODE_PAUSE: self.__update_command(command.set_done) print('... Waiting for resume ...') pause = True elif pause: sleep(1)</span></span></code> </pre></div></div><br><br><h4>  Black magic </h4><br>  If the model of a spherical demon in vacuum can be represented as follows: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- class MyDaemon(object): def magic(self): #   ....... def summon(self): #   while True: self.magic() MyDaemon().summon()</span></span></code> </pre><br>  then the implementation of the control panel interface is painless: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import os os.environ.setdefault("DJANGO_SETTINGS_MODULE", "web.settings") #   control     DJANGO_SETTINGS_MODULE # ..     django.setup() from remotecontrol.control import * class MyDaemon(IRemoteControl): def magic(self): ....... def summon(self): while True: #   self.check_commands() self.magic() MyDaemon().summon()</span></span></code> </pre><br>  As a result, the evil spirits are controlled, but only from the admin panel. <br>  Place this code in a file, for example, <i>daemon.py</i> and go ahead - we will write a mobile client. <br><br><a name="restapi"></a><h3>  REST API </h3><br>  But for a start it would be nice to implement an interface for communication between the mobile client and the server part.  Let's get started <br><br><h4>  Preparatory stage </h4><br>  Install the Django REST framework: <pre> <code class="bash hljs">pip install djangorestframework</code> </pre>  connect (web \ settings.py): <pre> <code class="python hljs">INSTALLED_APPS = [ ....... <span class="hljs-string"><span class="hljs-string">'rest_framework'</span></span>, ]</code> </pre>  and configure (ibid., add to the end of the file): <pre> <code class="python hljs">REST_FRAMEWORK = { <span class="hljs-comment"><span class="hljs-comment">#      superuser' 'DEFAULT_PERMISSION_CLASSES': ('rest_framework.permissions.IsAdminUser',), #     API,   JSON 'DEFAULT_RENDERER_CLASSES': ('rest_framework.renderers.JSONRenderer',), }</span></span></code> </pre><br><br><h4>  Serializers (remotecontrol \ serializers.py) </h4><br>  We begin by describing the return data set by the REST interface.  Here we can use those mysterious methods from the model description (.status_dsp () and .code_dsp ‚Äã‚Äã()), which return the text name of the state and the command code, respectively: <br><br><div class="spoiler">  <b class="spoiler_title">Listing serializers.py:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rest_framework <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> serializers <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Command <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandSerializer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(serializers.ModelSerializer)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> model = Command fields = (<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'code'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'status_dsp'</span></span>, <span class="hljs-string"><span class="hljs-string">'code_dsp'</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>)</code> </pre></div></div><br><br><h4>  Data views (remotecontrol \ views.py) </h4><br>  The REST API methods in the Django application architecture are the same views, only ... you understand. <br>  To communicate with the client, three <s>letters</s> <s>of the</s> API-method <s>words are</s> enough (ehh, ideal world ...): <br><ul><li>  <i>commands_available</i> - returns a list of available command codes and a list of state codes in which the command is considered processed; </li><li>  <i>commands</i> - used to create a new command object.  The list of objects in the database is not required; </li><li>  <i>commands / &lt;object_id&gt;</i> - used to determine the state of the command object. </li></ul><br>  To minimize the code, we use the buns that come with the Django REST framework: <br><ul><li>  <i>@api_view</i> - decorator for function based view, the parameter specifies the list of valid http-methods; </li><li>  <i>generics.CreateAPIView</i> - class for methods of creating objects, supports only POST; </li><li>  <i>generics.RetrieveAPIView</i> - a class for receiving detailed information about an object, supports only GET. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Listing views.py:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rest_framework.decorators <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> api_view <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rest_framework.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Response <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rest_framework <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> generics <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ipware.ip <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_ip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Command <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .serializers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CommandSerializer @api_view([<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commands_available</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># API- "   " response = { #    .   CODE_REMOTE_OFF  # ,    " "   . 'commands': dict(Command.COMMAND_CHOICES), #   ,     . 'completed': [Command.STATUS_DONE, Command.STATUS_DECLINE], } return Response(response) class CommandList(generics.CreateAPIView): # API- " " serializer_class = CommandSerializer def post(self, request, *args, **kwargs): #    IP  request.data[u'ip'] = u'' + get_ip(request) return super(CommandList, self).post(request, *args, **kwargs) class CommandDetail(generics.RetrieveAPIView): # API- "  " queryset = Command.objects.all() serializer_class = CommandSerializer</span></span></code> </pre></div></div><br><br><h4>  End-points (remotecontrol \ urls.py) </h4><br>  We describe the end-points of implemented API methods. <br><br><div class="spoiler">  <b class="spoiler_title">Listing urls.py:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf.urls <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> url <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> views urlpatterns = [ url(<span class="hljs-string"><span class="hljs-string">r'^commands_available/$'</span></span>, views.commands_available), url(<span class="hljs-string"><span class="hljs-string">r'^commands/$'</span></span>, views.CommandList.as_view()), url(<span class="hljs-string"><span class="hljs-string">r'^commands/(?P&lt;pk&gt;[0-9]+)/$'</span></span>, views.CommandDetail.as_view()), ]</code> </pre></div></div><br>  And connect them to the project (web \ urls.py): <br><pre> <code class="python hljs">urlpatterns = [ ....... url(<span class="hljs-string"><span class="hljs-string">r'^remotecontrol/'</span></span>, include(<span class="hljs-string"><span class="hljs-string">'remotecontrol.urls'</span></span>)), ]</code> </pre><br><br>  Interface for communication is implemented.  Go to the most delicious. <br><br><a name="remotecontrolapp"></a><h3>  "Remote Control App" </h3><br>  To communicate with the server, use UrlRequest ( <a href="https://kivy.org/docs/api-kivy.network.urlrequest.html">kivy.network.urlrequest.UrlRequest</a> ).  Of all its merits, we will need the following: <br><ul><li>  asynchronous mode support; </li><li>  automatic conversion of the correct JSON received in the response in Python dict. </li></ul><br>  For ease of implementation, we will use the Basic authentication scheme.  <i>If you wish, you can devote one of the following articles to other authentication methods on web resources using UrlRequest - write in the comments.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Listing main.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import kivy kivy.require('1.9.1') from kivy.network.urlrequest import UrlRequest from kivy.properties import StringProperty, Clock from kivy.uix.button import Button from kivy.app import App from kivy.uix.boxlayout import BoxLayout try: from kivy.garden.xpopup import XError, XProgress except: from xpopup import XError, XProgress from json import dumps import base64 class RemoteControlUI(BoxLayout): """     """ #      login = StringProperty(u'') password = StringProperty(u'') host = StringProperty('') def __init__(self, **kwargs): # ID     self._cmd_id = None #   ""  self._completed = [] #      . #    ""   #    . self._wait_completion = False super(RemoteControlUI, self).__init__( orientation='vertical', spacing=2, padding=3, **kwargs) #     self._pnl_commands = BoxLayout(orientation='vertical') self.add_widget(self._pnl_commands) # =============  http- ============== def _get_auth(self): #     "Authorization" cred = ('%s:%s' % (self.login, self.password)) return 'Basic %s' %\ base64.b64encode(cred.encode('ascii')).decode('ascii') def _send_request(self, url, success=None, error=None, params=None): #    headers = { 'User-Agent': 'Mozilla/5.0', 'Content-type': 'application/json', 'Authorization': self._get_auth() } UrlRequest( url=self.host + url, timeout=30, req_headers=headers, req_body=None if params is None else dumps(params), on_success=success, on_error=error, on_failure=error) # ===========      =========== def _get_commands(self, instance=None): #    API- "commands_available" self._progress_start('Trying to get command list') self._send_request( 'commands_available/', success=self._get_commands_result, error=self._get_commands_error) def _get_commands_result(self, request, response): # callback    try: self._pnl_commands.clear_widgets() #        for code, command in sorted( response['commands'].items(), key=lambda x: int(x[0])): btn = Button( id=code, text=command, on_release=self._btn_command_click) self._pnl_commands.add_widget(btn) self._completed = response['completed'] self._progress_complete('Command list received successfully') except Exception as e: self._get_commands_error(request, str(e)) def _get_commands_error(self, request, error): # callback    self._progress_complete() XError(text=str(error)[:256], buttons=['Retry', 'Exit'], on_dismiss=self._get_commands_error_dismiss) def _get_commands_error_dismiss(self, instance): # callback    if instance.button_pressed == 'Exit': App.get_running_app().stop() elif instance.button_pressed == 'Retry': self._get_commands() # =============   ============= def _btn_command_click(self, instance): #    API- "commands" self._cmd_id = None self._wait_completion = True self._progress_start('Processing command "%s"' % instance.text) self._send_request( 'commands/', params={'code': instance.id}, success=self._send_command_result, error=self._send_command_error) def _send_command_result(self, request, response): # callback    try: if response['status'] not in self._completed: #   -  ID  self._cmd_id = response['id'] #         , #      if self._wait_completion: #      Clock.schedule_once(self._get_status, 1) else: #   self._progress_complete( 'Command "%s" is %s' % (response['code_dsp'], response['status_dsp'])) except Exception as e: XError(text=str(e)[:256]) def _send_command_error(self, request, error): # callback    self._progress_complete() XError(text=str(error)[:256]) # ==========     ========== def _get_status(self, pdt=None): #    API- "commands/&lt;id_&gt;" if not self._cmd_id: return self._send_request( 'commands/%s/' % self._cmd_id, success=self._send_command_result, error=self._send_command_error) # =============       ============== def _progress_start(self, text): self.popup = XProgress( title='RemoteControl', text=text, buttons=['Close'], on_dismiss=self._progress_dismiss) self.popup.autoprogress() def _progress_dismiss(self, instance): self._wait_completion = False def _progress_complete(self, text=''): if self.popup is not None: self.popup.complete(text=text, show_time=0 if text is None else 1) # ========================================= def start(self): self._get_commands() class RemoteControlApp(App): """   """ remote = None def build(self): #    self.remote = RemoteControlUI( login='test', password='qwerty123', host='http://localhost:8000/remotecontrol/') return self.remote def on_start(self): self.remote.start() #   RemoteControlApp().run()</span></span></code> </pre></div></div><br>  <i>I hope there are enough comments in the code for understanding.</i>  <i>If it is still not enough - inform me, I will make changes.</i> <br><br>  At this pampering with the code ends and comes on the scene <br><br><h4>  Heavy artillery </h4><br>  You can talk about Buildozer for a long time, because not much is said about it.  There are articles on Habr√© ( <a href="https://habrahabr.ru/post/301776/">about installing and configuring</a> and <a href="https://habrahabr.ru/post/189660/">building a release version and publishing on Google Play</a> ), of course, there is <a href="http://buildozer.readthedocs.io/en/latest/index.html">documentation</a> ... But there are also nuances <s>about which you can write an entire article</s> that are scattered from various sources.  I will try to gather highlights here. <br><br><div class="spoiler">  <b class="spoiler_title">Some practical tips for dealing with this wunderwaffe:</b> <div class="spoiler_text"><ul><li>  To build an Android application, you still need Linux, you can do with a virtual machine.  This is due to the fact that python-for-android (the package required for building) in the current version uses a more recent version of the sh package (previously pbs), which lacks Windows support; </li><li>   ,         ‚Äî  Buildozer     Android-dev .    ( ,        ndk, sdk  requirements)   30-40 ; </li><li>   Buildozer ,    Kivy  Kivy-garden (     Kivy); </li><li> ,   Buildozer    ( ‚Äî <a href="http://buildozer.readthedocs.io/en/latest/installation.html"></a> ).  Buildozer   ,         ( )   . </li><li>    Buildozer   root; </li></ul><br><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, a bit of code to help the happy owners of Debian and Ubuntu (the rest will need to be ‚Äúcarefully processed with a file‚Äù) </font></font><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kivy-install.sh</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Create virtualenv virtualenv --python=python2.7 .env # Activate virtualenv source .env/bin/activate # Make sure Pip, Virtualenv and Setuptools are updated pip install --upgrade pip virtualenv setuptools # Use correct Cython version here pip install --upgrade Cython==0.20 # Install necessary system packages sudo apt-get install --upgrade build-essential mercurial git python-dev libsdl-image1.2-dev libsdl-mixer1.2-dev libsdl-ttf2.0-dev libsmpeg-dev libsdl1.2-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev # Install kivy pip install --upgrade kivy</span></span></code> </pre></div></div><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buildozer-install.sh</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Activate virtualenv source .env/bin/activate # Android SDK has 32bit libs sudo dpkg --add-architecture i386 # add system dependencies sudo apt-get update sudo apt-get install --upgrade ccache sudo apt-get install --upgrade libncurses5:i386 libstdc++6:i386 zlib1g:i386 sudo apt-get install --upgrade openjdk-7-jdk sudo apt-get install --upgrade unzip # Install buildozer pip install --upgrade buildozer</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now that Buildozer is installed, initialize it: </font></font><br><pre> <code class="bash hljs">buildozer init</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result of this command, a configuration configuration file (buildozer.spec) will be created in the directory. </font><font style="vertical-align: inherit;">In it we find the keys below and assign them the appropriate values:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edit for buildozer.spec</font></font></b> <div class="spoiler_text"> <code># (list) Garden requirements <br> garden_requirements = xpopup <br> <br> # (str) Supported orientation (one of landscape, portrait or all) <br> orientation = portrait <br> <br> # (bool) Indicate if the application should be fullscreen or not <br> fullscreen = 0 <br> <br> # (list) Permissions <br> android.permissions = INTERNET <br> <br> # (int) Minimum API required <br> android.minapi = 13 <br> <br> # (int) Android SDK version to use <br> android.sdk = 21 <br></code> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Activate the wunderwaffe: </font></font><br><pre> <code class="bash hljs">buildozer android debug</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the output is .apk, which can be installed on an Android device. </font></font><br><br>  Is done.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> With what I congratulate you! </font></font><br><br><h3>  Testing </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And let's see how it all works. </font><font style="vertical-align: inherit;">It‚Äôs not for nothing that we tried so long :) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We launch the Django server, using the parameter to specify the IP of your machine on the local network:</font></font><br><pre> <code class="bash hljs">python manage.py 192.168.xxx.xxx:8000</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calling evil spirits: </font></font><br><pre> <code class="bash hljs">python daemon.py</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We start the application on the Android device and see something like this: </font></font><br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/EqxDIJOSegw%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhcKryvNo2dwhHAtJuO9TyYRJVjSA" frameborder="0" allowfullscreen=""></iframe><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: The final version of the project, which can be </font></font><a href="https://github.com/ophermit/RemoteControlInterface"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">found on github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , was used to record the video </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It differs from the code given in the article by the extension of the functional. </font><font style="vertical-align: inherit;">The server part adds support for user commands and debug messages (for clarity), and the client added an authorization form, a request for confirmation of the command execution and some convenience to the interface.</font></font></i> <br><br><h3>  Let's sum up </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What did we get as a result? </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Easily built-in class that implements the logic of reaction to remote commands; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A server application that allows you to control an arbitrary script from a web interface and provides a REST API; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Android application for managing the script through the REST API. </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maybe this is too loudly said, but ... </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now I am tormented by the question - is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it possible to implement a similar architecture using other languages ‚Äã‚Äãand technologies (except Python), applying (at least) no more effort and writing no more code?</font></font></i></b> <br><br>  That's all. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> All nice coding and successful builds. </font></font><br><br><h3>  useful links </h3><br> <a href="https://github.com/ophermit/RemoteControlInterface"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"RemoteControlInterface" on github </font></font></a> <br> <a href="https://docs.djangoproject.com/en/1.9/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docks by Django </font></font></a> <br> <a href="http://www.django-rest-framework.org/api-guide/requests/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docks by Django REST framework </font></font></a> <br> <a href="https://kivy.org/docs/api-kivy.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docks by Kivy </font></font></a> <br> <a href="https://kivy.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installing Kivy </font></font></a> <br> <a href="http://buildozer.readthedocs.io/en/latest/installation.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installing Buildozer</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/306808/">https://habr.com/ru/post/306808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306796/index.html">Introducing 3CX Phone System v15 SP1 and test the system on a mini PC instead of a server</a></li>
<li><a href="../306798/index.html">How many neurons do you need to recognize a bridge summary?</a></li>
<li><a href="../306802/index.html">The digest of interesting materials for the mobile # 164 developer (July 25-31)</a></li>
<li><a href="../306804/index.html">Myths about FreeBSD</a></li>
<li><a href="../306806/index.html">"Working with a microscope": The data storage revolution</a></li>
<li><a href="../306810/index.html">De-anonymize Windows users and get Microsoft and VPN account credentials</a></li>
<li><a href="../306812/index.html">How not to keep secrets where we have to, or why we need Hashicorp Vault</a></li>
<li><a href="../306814/index.html">Who cares about product bugs if it is successfully sold</a></li>
<li><a href="../306816/index.html">We write microservice on KoaJS 2 in the style of ES2017. Part I: Such Different Assynchrony</a></li>
<li><a href="../306820/index.html">Part 1. Platform DSS Universal Algorithms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>