<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing your own good memory manager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day, reader. Perhaps you have already read my previous articles, and you know that I am writing my own OS. Today we will talk and conside...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing your own good memory manager</h1><div class="post__text post__text-html js-mediator-article">  Good time of day, reader.  Perhaps you have already read my previous articles, and you know that I am writing my own OS.  Today we will talk and consider a simple and fast enough memory management algorithm - a memory manager is a critical part of the OS, because fast, reliable and non-memory memory is a pledge of a good OS. <br>  I was looking for simple and adequate ideas for the manager in RuNet, and on English-language sites - I still could not find any good articles about adequate, not working for O (N) allocator.  Well, today we are going to consider a better idea for the memory manager, I‚Äôm going to continue the text under cat. <br><a name="habracut"></a><br><h2>  Theory </h2><br>  From a wiki: A memory manager is a part of a computer program (both an application and an operating system) that processes requests for allocating and freeing RAM or (for some computer architectures) requests for the inclusion of a given memory area in the processor‚Äôs address space. <br><br>  I suggest also to read <a href="https://habr.com/post/270009/">this article</a> before continuing. <br><br><h2>  Watermak Allocator </h2><br>  Well, probably the easiest of all the allocators is the Watermark Allocator.  Its essence is approximately the following: the whole memory is divided into blocks, the block has a header containing the size of this and the previous block, the block status (busy / free), knowing the block address, we can get the address of the next and previous block for O (1). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/jg/6p/et/jg6petlw2ms3ifnq7ctss59pnja.jpeg"><br><br><h3>  Memory allocation </h3>  To allocate memory, we simply need to run in blocks, and look for a block whose size is greater than or equal to the size required for allocating memory.  As you already understood, the asymptotic behavior of O (N) is bad. <br><br><h3>  Memory release </h3>  To free up memory, we just need to set the block status as ‚Äúfree‚Äù - O (1) - super! <br><br>  But, as you understand, holes can start to form, in which 2 or more free blocks - the memory is defragmented, when released, you can view the next blocks, and in the case when one or two are free - merge them into one. <br><br><h2>  Allocator for logarithmic speed </h2><br>  We know that we need to search only among the free blocks.  Running only for free improves speed on average twice, but it's still a line.  Well, why should we run through all the blocks, looking for size, if we can organize a tree of free blocks!  Initially, we have only one free block, and then we add free blocks to the binary search tree, the key will be the block size.  Thus, to allocate memory, it is enough for us to find a block in a tree whose size is greater than or equal to what we need.  We calmly do this for O (log N), just going down the tree.  Then we either cut the block in two, or completely give it to the one who requested the memory.  Next we remove the block from the tree in O (1).  And, if necessary, insert the rest of the block back for O (log N).  For release, we just need to insert the block back, and do not forget about fragmentation. <br><br>  It is logical that you do not need to use a simple tree, you must use a self-balancing tree, Red-Black or AVL.  You can store a tree of blocks in a static array, or figure out how to do it differently. <br><br>  Actually, the code: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">malloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!size) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * addr = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; allocationAvlTree.size; ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r; <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *n; n = &amp;allocationAvlTree.nodes[i]; <span class="hljs-comment"><span class="hljs-comment">/* couldn't find it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!n-&gt;key) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } r = allocationAvlTree.cmp(n-&gt;key, size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//We're lucky today. //Get memory block header alloc_t * block = (size_t)n-&gt;val - sizeof(alloc_t); //Set to used block-&gt;status = 1; //Set size block-&gt;size = size; alloc_t * next = (size_t)n-&gt;val + size; next-&gt;prev_size = size; next-&gt;status = 0; next-&gt;size = n-&gt;key - size - 16; avltree_remove(&amp;allocationAvlTree, n-&gt;key, n-&gt;val); if (n-&gt;key - size - 16) avltree_insert(&amp;allocationAvlTree, next-&gt;size, (size_t)next + sizeof(alloc_t)); memset((size_t)block + sizeof(alloc_t), 0, block-&gt;size); block-&gt;signature = 0xDEADBEEF; unlockTaskSwitch(); return (size_t)block + sizeof(alloc_t); } else if (r &gt; 0) i = __child_r(i); else assert(0); } return 0; } void free(void * mem) { if (!mem) return; //Get current alloc alloc_t * alloc = ((unsigned int)mem - sizeof(alloc_t)); if (alloc-&gt;signature != 0xDEADBEEF) return; alloc-&gt;status = 0; alloc_t * left = ((unsigned int)alloc - sizeof(alloc_t) - alloc-&gt;prev_size); if (left-&gt;signature == 0xDEADBEEF&amp;&amp;left-&gt;status == 0&amp;&amp;left-&gt;size==alloc-&gt;prev_size) { //Merge blocks if (avltree_remove(&amp;allocationAvlTree, left-&gt;size, (uint)left + sizeof(alloc_t))) { left-&gt;size += sizeof(alloc_t) + alloc-&gt;size; alloc = left; } else assert(0); } alloc_t * right = (uint)alloc + sizeof(alloc_t) + alloc-&gt;size; if (right-&gt;prev_size&amp;&amp;right-&gt;status == 0&amp;&amp;right-&gt;signature == 0xDEADBEEF) { if (avltree_remove(&amp;allocationAvlTree, right-&gt;size, (uint)right + sizeof(alloc_t))) alloc-&gt;size += sizeof(alloc_t) + right-&gt;size; else assert(0); } avltree_insert(&amp;allocationAvlTree, alloc-&gt;size, (uint)alloc + sizeof(alloc_t)); }</span></span></code> </pre> <br>  Good luck and ethical hacking!  Any objective criticism is welcome, the purpose of the article is not to say that it is a wah which allocator, but simply to tell about the allocator, which will be better than the stupid implementations of simple allocators. </div><p>Source: <a href="https://habr.com/ru/post/435698/">https://habr.com/ru/post/435698/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435688/index.html">An example client-server application on Flutter</a></li>
<li><a href="../435690/index.html">[What's wrong with GraphQL] ... and how to deal with it</a></li>
<li><a href="../435692/index.html">Y Combinator: ‚ÄúAt first, some of the largest technology companies look like toys‚Äù</a></li>
<li><a href="../435694/index.html">How and why we optimized the algorithm of cleaning SLAB-caches in the Linux kernel</a></li>
<li><a href="../435696/index.html">Antiquities: Computer Advertising 1997</a></li>
<li><a href="../435700/index.html">8 worst questions on Vue.js interview</a></li>
<li><a href="../435702/index.html">Patent trolls start and win: how I was left without a game</a></li>
<li><a href="../435704/index.html">Architectural solutions for mobile games. Part 2: Command and their queues</a></li>
<li><a href="../435706/index.html">Use rcm to deploy the configuration to any folder</a></li>
<li><a href="../435708/index.html">Faial: a meeting place in the Atlantic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>