<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development ‚Üí Kazakhstan: How I helped to submit 100 forms of tax reporting. Continuation 300 form</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* This is not the moon. This is a space station. 
 - Obi-Wan Kenobi* 



 Greetings to the society! 


 1 article ‚Üí Start 200 form 


 Continued ... 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development ‚Üí Kazakhstan: How I helped to submit 100 forms of tax reporting. Continuation 300 form</h1><div class="post__text post__text-html js-mediator-article"><table><tbody><tr><td align="right">  * This is not the moon.  This is a space station. <br>  - Obi-Wan Kenobi* <br></td></tr></tbody></table><br><p>  Greetings to the society! </p><br><p>  1 article ‚Üí <a href="https://habrahabr.ru/post/325292/">Start 200 form</a> </p><br><p>  Continued ... </p><br><p>  The next step to solve the problems of my customer were the VAT tax returns.  What is interesting is the taxpayer's office could export only 300 small forms in the form of xml.  The remaining forms were exported only with the help of the SONO program.  And these forms have been archived. </p><br><p>  But not everything is as simple as it seems from the first time. </p><br><img width="100%" src="https://habrastorage.org/files/a79/06e/474/a7906e474c3c474a8ca607be368b70d6.jpg"><br><p><br>  and the most interesting, as programmers in a company that supports an online service for filing tax returns, "encrypted" these same forms ... </p><a name="habracut"></a><br><p>  <strong>Part one.</strong>  <strong>The torment of finding the algorithm for reading large forms.</strong> <br>  This is SONO program.  It employs Kazakhstan‚Äôs accountants who file online tax returns. </p><br><img src="https://habrastorage.org/files/470/d85/86c/470d8586cb4249d3a5c1ac1b96e1590c.png"><br><p><br>  What I started with. </p><br><p>  Exported all 300 forms of declarations from SONO. </p><br><img src="https://habrastorage.org/files/c84/ec2/b15/c84ec2b1592740b883f08d94c8fa2f97.png"><br><p><br>  And tried to open the archives.  But it was not there. </p><br><img src="https://habrastorage.org/files/f9a/29c/846/f9a29c846bf343828bf83053de1b07a5.png"><br><p><br>  The archiver produced an error - "file is corrupted".  After spending 5 hours learning the basics of <a href="https://ru.wikipedia.org/wiki/Tar">tar,</a> I realized that I didn't understand anything ... </p><br><p>  The study of open sources stupidly googling also did not help.  And here I came across a small discussion on the accounting forum.  Where admins frankly mocked the algorithm, which is encrypted large forms. </p><br><p>  It turns out that without thinking twice without composing various cryptographic protection.  The authors of the "encryption" of large forms decided to stupidly remove the first two characters "BZ" at the beginning of the file. </p><br><p>  By inserting this mega key into the beginning of the file </p><br><img src="https://habrastorage.org/files/a74/fb5/83e/a74fb583e68a4ce092e62b72a715e43c.png"><br><p><br>  I opened the archive.  And inside it was the same damaged archive.  (for the coders who invented to hide the data inside the same archive, see the matryoshka favorite toy) Wise with experience, I repeated the mega crack by adding BZ to the beginning of the file. </p><br><img src="https://habrastorage.org/files/411/6c7/ce5/4116c7ce58364d7b9fb7787efeef3703.png"><br><p><br>  and finally got access to the data. </p><br><img src="https://habrastorage.org/files/525/532/5ad/5255325ada7644b7aee893a4f03b1ecc.png"><br><p><br>  Just solving the issue of how to calculate information from the archive took 6 hours of my life.  ‚ÄúAbildet‚Äù - as my uncle says. </p><br><p>  Ready function on php which "decrypts" the big forms. </p><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_POST[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] == <span class="hljs-string"><span class="hljs-string">"getBz2"</span></span>) { $name = $_FILES[<span class="hljs-string"><span class="hljs-string">"bz2"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>]; $homepage = file_get_contents($name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strripos($_FILES[<span class="hljs-string"><span class="hljs-string">"bz2"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>], <span class="hljs-string"><span class="hljs-string">".xml"</span></span>) === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $homepage = <span class="hljs-string"><span class="hljs-string">"BZ"</span></span>.$homepage; file_put_contents($name, $homepage); $baseDir = <span class="hljs-string"><span class="hljs-string">"/tmp/21"</span></span>; exec(<span class="hljs-string"><span class="hljs-string">"rm -f "</span></span> .$baseDir . <span class="hljs-string"><span class="hljs-string">"/dir/*"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!@mkdir(<span class="hljs-string"><span class="hljs-string">"$baseDir"</span></span>, <span class="hljs-number"><span class="hljs-number">0777</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) { } exec(<span class="hljs-string"><span class="hljs-string">"tar -jxvf $name -C $baseDir"</span></span>); exec (<span class="hljs-string"><span class="hljs-string">" rm $baseDir/*.xml -rf"</span></span>); $files = glob(<span class="hljs-string"><span class="hljs-string">"$baseDir/*.bz2"</span></span>); $homepage = file_get_contents($files[<span class="hljs-number"><span class="hljs-number">0</span></span>]); $homepage = <span class="hljs-string"><span class="hljs-string">"BZ"</span></span>.$homepage; file_put_contents($files[<span class="hljs-number"><span class="hljs-number">0</span></span>], $homepage); exec(<span class="hljs-string"><span class="hljs-string">"bunzip2 "</span></span>.$files[<span class="hljs-number"><span class="hljs-number">0</span></span>]); $files = glob(<span class="hljs-string"><span class="hljs-string">"$baseDir/*.xml"</span></span>); $homepage = file_get_contents($files[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> homepage; <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(); }</code> </pre> <br><p>  Of course, everything can be easily improved, but here only a part of the php code that is responsible for the "crack". </p><br><p>  <strong>Part Two Reading the xml structure and collecting the necessary data on TK</strong> </p><br><p>  A small visual analysis of the final xml files.  Gave an understanding that the forms that were originally given as xml have fno formatVersion = 1, mega encrypted had fno formatVersion = 2. <br></p><br><img src="https://habrastorage.org/files/884/9fc/7b6/8849fc7b67d84631af31ea623bac1a77.png"><br><p></p><br><img src="https://habrastorage.org/files/a9b/ab6/48f/a9bab648fc2241dfbd42093a69c5bc09.png"><br><p><br>  The main data structure is completely repeated. </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> frame.contentWindow.document.querySelector(<span class="hljs-string"><span class="hljs-string">"form[name='form_300_00'] field[name='"</span></span> + a + <span class="hljs-string"><span class="hljs-string">"']"</span></span>).innerHTML; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fno = {}; fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>] = {} fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"dt_main"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"dt_main"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"dt_regular"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"dt_regular"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"dt_additional"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"dt_additional"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"dt_notice"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"dt_notice"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"dt_final"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"dt_final"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"notice_date"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"notice_date"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"dt"</span></span>][<span class="hljs-string"><span class="hljs-string">"notice_number"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"notice_number"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"p7"</span></span>] = getFaktures(<span class="hljs-number"><span class="hljs-number">7</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"p8"</span></span>] = getFaktures(<span class="hljs-number"><span class="hljs-number">8</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"period_year"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"period_year"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"period_quarter"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"period_quarter"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"submit_date"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"submit_date"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_001_A"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_001_A"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_001_B"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_001_B"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_013_A"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_013_A"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_013_B"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_013_B"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_015"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_015"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_021"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_021"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"field_300_00_023"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"field_300_00_023"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"iin"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"iin"</span></span>); fno[<span class="hljs-string"><span class="hljs-string">"rnn"</span></span>] = getTitle(<span class="hljs-string"><span class="hljs-string">"rnn"</span></span>);</code> </pre> <br><p>  In principle, I made the logical structure of the document in 20 minutes.  If it were not for mega quack, then it all hung. </p><br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><p>  List of 300 forms: </p><br><img src="https://habrastorage.org/files/c6c/372/06a/c6c37206aa974eb7954de63b3ab0a08a.png"><br><p><br>  Loading forms: </p><br><img src="https://habrastorage.org/files/ecb/ec6/79c/ecbec679cd324f5c92c4b58ecfcf84d3.png"><br><p><br>  View Forms: </p><br><img src="https://habrastorage.org/files/89d/cb5/4bd/89dcb54bdaf9400284378174c6dc0d50.png"></div></div><br><p>  <strong>ps</strong> The customer stopped writing for joy. <br>  <strong>pps</strong> For those interested, on the application side, this is not "sexy." <br>  <strong>ppps</strong> If anyone wants to try to hand off soon everything on the githab.  Currently the system is not finalized.  Therefore, I do not want to show it ... </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325310/">https://habr.com/ru/post/325310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325298/index.html">An overview of hash-opening tools: John the Ripper password cracker and MDCrack</a></li>
<li><a href="../325300/index.html">Certificates from StartCom and WoSign finally turned into a pumpkin</a></li>
<li><a href="../325302/index.html">Necurs, one of the largest botnets in the world, received a DDoS module</a></li>
<li><a href="../325304/index.html">How we ported the software / hardware solution from SPARC Solaris to AMD64 Linux and virtualized it all</a></li>
<li><a href="../325308/index.html">Functional C #</a></li>
<li><a href="../325312/index.html">The right to oblivion does not apply to data in business registers: decision of the Court of Justice of the European Union of March 9, 2017</a></li>
<li><a href="../325316/index.html">MySQL sample rotation</a></li>
<li><a href="../325318/index.html">How I stopped being afraid and re-invented QML</a></li>
<li><a href="../325320/index.html">Node.js Streams and Reactive Programming</a></li>
<li><a href="../325322/index.html">Productive weekend: when all things can be put off until later</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>