<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using RabbitMQ in django projects without Celery, and what's new in Celery 3.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think most python programmers are already to some extent familiar with the features of Celery. In the first part I will tell you how to use RabbitMQ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using RabbitMQ in django projects without Celery, and what's new in Celery 3.0</h1><div class="post__text post__text-html js-mediator-article"> I think most python programmers are already to some extent familiar with the features of Celery.  In the first part I will tell you how to use RabbitMQ without celery, and in the second part - a brief overview of the new features of celery 3.0. <br>  About installing bundles Django-Celery-RabbitMQ can be read <a href="http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html">here</a> . <br>  About the use of RabbitMQ is well written <a href="http://habrahabr.ru/post/149694/">here</a> , and <a href="http://habrahabr.ru/post/150134/">here</a> , well, on the site RabbitMQ. <br><a name="habracut"></a><br>  Briefly recall the installation and configuration: <br>  RabbitMQ: <br> <code>sudo apt-get install rabbitmq-server</code> <br>  Add user: <br><pre> <code class="bash hljs">$ rabbitmqctl add_user myuser mypassword $ rabbitmqctl add_vhost <span class="hljs-string"><span class="hljs-string">'/'</span></span> $ rabbitmqctl set_permissions -p myvhost myuser <span class="hljs-string"><span class="hljs-string">".*"</span></span> <span class="hljs-string"><span class="hljs-string">".*"</span></span> <span class="hljs-string"><span class="hljs-string">".*"</span></span></code> </pre><br>  Briefly settings Celery, RabbitMQ: <br>  in settings.py <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> djcelery os.environ[<span class="hljs-string"><span class="hljs-string">"CELERY_LOADER"</span></span>] = <span class="hljs-string"><span class="hljs-string">"django"</span></span> djcelery.setup_loader() AMQP_HOST = <span class="hljs-string"><span class="hljs-string">'localhost'</span></span> BROKER_HOST=<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> BROKER_PORT = <span class="hljs-number"><span class="hljs-number">5672</span></span> BROKER_VHOST = <span class="hljs-string"><span class="hljs-string">"/"</span></span> BROKER_USER = <span class="hljs-string"><span class="hljs-string">"myuser"</span></span> BROKER_PASSWORD = <span class="hljs-string"><span class="hljs-string">"mypassword"</span></span> INSTALLED_APPS+=<span class="hljs-string"><span class="hljs-string">'djcelery'</span></span></code> </pre><br>  Statement: in order to make one small task asynchronous, it is not at all necessary to use celery.  It is possible to do RabbitMQ. <br>  Evidence: <br>  Let's start from the opposite: <br>  Task: check email for the presence of a letter from the specified sender, if there is no letter, repeat the check in a minute, if there is, go further (parse it for example ...) <br>  Use poplib, email. <br>  We will write a function that receives an email from a predetermined sender and we wrap it with a task decorator. <br>  The function accepts an email address, a password and an email address from whom the letter should come and returns the status (Ok, Error) and message <br>  in tasks.py <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery.task <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> task, periodic_task <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery.task.schedules <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> crontab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> poplib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> email @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_content</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_mail, mail_pass, mail_from)</span></span></span><span class="hljs-function">:</span></span> mail_server = <span class="hljs-string"><span class="hljs-string">'pop.'</span></span>+user_mail.split(<span class="hljs-string"><span class="hljs-string">'@'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] mail_login = user_mail.split(<span class="hljs-string"><span class="hljs-string">'@'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] p = poplib.POP3(mail_server) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> p.getwelcome() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: p.user(mail_login) p.pass_(mail_pass) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> poplib.error_proto: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error'</span></span>, <span class="hljs-string"><span class="hljs-string">'Email is blocked'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> p.list() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error'</span></span>, <span class="hljs-string"><span class="hljs-string">'dont receive list of mails'</span></span> numMessages = len(p.list()[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> numMessages <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(numMessages): m = email.message_from_string(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>.join(p.top(i+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: this_email_from = m[<span class="hljs-string"><span class="hljs-string">'From'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> this_email_from.find(mail_from) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> this_email_from m = email.message_from_string(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>.join(p.retr(i+<span class="hljs-number"><span class="hljs-number">1</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>])) content = get_text_body(m) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> content <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Ok'</span></span>, content <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception, e: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error'</span></span>, unicode(e, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> mail_content.retry(exc=e, countdown=<span class="hljs-number"><span class="hljs-number">30</span></span>)</code> </pre><br>  The last line of the code describes the restart of the task after 30 seconds if the letter was not found. <br>  Now we can run a task like this: <br><pre> <code class="python hljs">&gt;&gt;&gt;res = mail_content.delay(<span class="hljs-string"><span class="hljs-string">'user@domen'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'email_from@domen.email.from'</span></span>)</code> </pre><br>  in this case, execution will start immediately, or like this: <br><pre> <code class="python hljs">&gt;&gt;&gt;res = mail_content.apply_async((<span class="hljs-string"><span class="hljs-string">'user@domen'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'email_from@domen.email.from'</span></span>), countdown=<span class="hljs-number"><span class="hljs-number">30</span></span>)</code> </pre><br>  In this case, execution will begin after 30 seconds. <br>  (You must first start the celery server: <br>  python manage.py celeryd <br>  and in another window run the shell: <br>  python manage.py shell, <br>  And already from the shela call these commands) <br>  We can get the result by doing <br><pre> <code class="python hljs">&gt;&gt;&gt;res.get() () &gt;&gt;&gt;res.info</code> </pre><br>  (returns None if there is no result yet, and the result if there is one) <br>  But checking whether the result is not always convenient and always means performing unnecessary actions. <br>  To call a function after performing the task, you can implement a callback.  If you have celery installed and you can make a function that accepts the result of a task (task), then you can proceed to the next subsection.  Who wants to do without celery is a way to organize callback based on pika and rabbitMQ. <br>  To work with AMQP, install the pika package: <br><pre> <code class="python hljs">$ sudo pip install pika==<span class="hljs-number"><span class="hljs-number">0.9</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span></code> </pre><br>  Details Hello world using this library and RabbitMQ is described <a href="http://www.rabbitmq.com/tutorials/tutorial-one-python.html">here.</a> <br>  in decorators.py: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pika <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time importr settings <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function_to_decorate)</span></span></span><span class="hljs-function">:</span></span> user = settings.BROKER_USER broker_host = settings.BROKER_HOST password = settings.BROKER_PASSWORD credentials = pika.PlainCredentials(user, password) parameters = pika.ConnectionParameters(host=broker_host, credentials=credentials) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kw)</span></span></span><span class="hljs-function">:</span></span> (backend_function, data) = function_to_decorate(*args, **kw) pickled_obj = pickle.dumps(data) queue_name = str(time.time()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"call_backend"</span></span>, backend_function.__name__ connection = pika.BlockingConnection(parameters) channel = connection.channel() channel.queue_declare( queue = queue_name) channel.basic_publish(exchange=<span class="hljs-string"><span class="hljs-string">''</span></span>, routing_key=queue_name, body=pickled_obj) channel.basic_consume( backend_function, queue=queue_name, no_ack = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) channel.queue_delete(queue=queue_name) connection.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receiver</code> </pre><br>  This is the decorator, with which we wrap the mail_content function before (!) Wrapping the <a href="https://habrahabr.ru/users/task/" class="user_link">task</a> decorator <br>  The decorator returns our mail_content function with the added instructions for sending a message to rabbitmq <br>  I will not rewrite the entire function in tasks.py, I just changed <br>  in tasks.py: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> decorators <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tasks_backend <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mail_analizer, mail_error @task @callback <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_content</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (...): ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mail_analizer, (content,) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mail_error, (<span class="hljs-string"><span class="hljs-string">'error'</span></span>,)</code> </pre><br>  We return the function as the first argument, the second as the list of arguments that we want to pass to the function <br>  in tasks_backend.py <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tasks <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_analizer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ch, method, properties, body)</span></span></span><span class="hljs-function">:</span></span> email_text = pickle.loads(body) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> emai_text.find(<span class="hljs-string"><span class="hljs-string">u'Hello'</span></span>): tasks.send_emails.delay(email_text) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: tasks.send_twitter_status.delay(email_text)</code> </pre><br>  They accepted email, recognized it and launched new tasks. <br>  Note that the arguments are not very convenient, fix this: <br>  in decorators.py <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">backend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function_to_decorate)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ch, method, properties, body)</span></span></span><span class="hljs-function">:</span></span> data=pickle.loads(body) args = data function_to_decorate(*args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receive</code> </pre><br>  Now we can rewrite the mail_analizer function like this: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@backend def mail_analizer(email_text): if emai_text.find(u'Hello'): tasks.send_emails.delay(email_text) else: tasks.send_twitter_status.delay(email_text)</span></span></code> </pre><br>  For start of the following functions we use the decorator <pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@callback</span></span></code> </pre>  as in mail_content: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@backend @callback def mail_analizer(cont): print cont return send_twitter_status, (cont,)</span></span></code> </pre><br>  A simple example of building a chain of functions with this interface: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@callback def first(*args): print first.__name__ print args return senders, args @backend @callback def senders(*args): print args return analizer, args @backend @callback def analizer( *args): print args return ended_fun, args @backend def ended_fun(*args): print ended_fun.__name__ print args</span></span></code> </pre><br>  The first function is wrapped only by the decorator. <pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@callback</span></span></code> </pre>  because  she takes nothing from the rabbit, and the last - only <pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@backend</span></span></code> </pre>  - because  she does not transmit anything. <br>  Note that a function can call itself.  Also note that the function wrapped by the backend decorator can only be called from rabbitmq. <br>  To run, use a function that wraps only callback. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@callback def runer(*args): return test_func, (args) @backend @callback def test_func( *args): print args return test_func, args</span></span></code> </pre><br>  The final version of the functions mail_content, email_analizer, run_email: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@backend @call_backend def mail_content(user_mail, mail_pass, mail_from): mail_server = 'pop.'+user_mail.split('@')[1] mail_login = user_mail.split('@')[0] p = poplib.POP3(mail_server) print p.getwelcome() try: p.user(mail_login) p.pass_(mail_pass) except poplib.error_proto: return mail_error, 'Email is blocked' try: print p.list() except: return mail_error, 'dont receive list of mails' numMessages = len(p.list()[1]) print numMessages for i in range(numMessages): m = email.message_from_string("\n".join(p.top(i+1, 1)[1])) try: this_from = m['From'] this_from = this_from.decode('cp1251').split('&lt;'.decode('cp1251'))[1] if this_from.find(mail_from) &gt;= 0: print m['From'] m = email.message_from_string('\n'.join(p.retr(i+1)[1])) content = get_text_body(m) print content return email_analizer, (content, email_from) else: pass except Exception, e: return email_error, (unicode(e, 'utf8'),) return mail_content, (user_mail, mail_pass, mail_from) @backend @call_backend def email_analizer(content, email_from): if content.find(u'Hello'): email_to = email_from text=u'Hello, my dear friend' return send_mail, (email_to, text) return send_twitter_status, (cont,) @call_backend def run_email(): '''  , , email, password, email_from ''' return mail_content, (email, password, email_from)</span></span></code> </pre><br><h5>  Subtotal: </h5>  I hope there was nothing complicated.  You can use, instead of celery, if you have for example one small task (task). <br><br><h4>  How to do it with celery 3.0 </h4><br><br>  In celery 3.0, you can transfer the name of the task to which you want to transfer the result of the task <br>  Example from documentation: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@celery.task def add(x, y): return x + y add.apply_async((2, 2), link=add.s(16))</span></span></code> </pre><br>  where add is our task (task), add.s is a subtask (subtask), which is started after the execution of add (2, 2), the first argument to the subtask is the result of the execution of add (2, 2), the second argument comes to 16. Total (2 + 2) + 16 = 20.  What is the subtask <a href="http://docs.celeryproject.org/en/latest/userguide/canvas.html">here</a> <br>  In relation to our task, we make a task from the mail_analizer function, leave one argument - content, remove the decorator @call_backend and call it like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      &gt;&gt;&gt; mail_content.apply_async (mail_addres, mail_password, email_from, link = mail_analizer.s ()) <br>  The variable link_error is also provided for the case when the problem ‚Äúraises‚Äù an error. <br>  Read more about it <a href="http://docs.celeryproject.org/en/latest/userguide/calling.html">here.</a> <br>  In addition, in celery 3.0 appeared: <br><h5>  Group </h5><br>  the group accepts a list of tasks to be applied in parallel: <br>  example from the documentation: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> group &gt;&gt;&gt; res = group(add.s(i, i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span>))() &gt;&gt;&gt; res.get(timeout=<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>]   &gt;&gt;&gt; g = group(add.s(i, i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span>)) &gt;&gt;&gt; g.apply_async()</code> </pre><br><h5>  chain: </h5><br>  Call chains <br>  Now tasks can be called as chains, for example: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> chain @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mul</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x,y)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x*y @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">div</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x,y)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x/y <span class="hljs-comment"><span class="hljs-comment"># (2 + 2) * 8 / 2 &gt;&gt;&gt; res = chain(add.subtask((2, 2)), mul.subtask((8, )), div.subtask((2,))).apply_async() &gt;&gt;&gt; res.get() == 16 &gt;&gt;&gt; res.parent.get() == 32 &gt;&gt;&gt; res.parent.parent.get() == 4   &gt;&gt;&gt; (add.s(2, 2) | add.s(4) | add.s(8))().get() 16 &lt;/source &lt;h5&gt;immutable&lt;/h5&gt;     ,            &lt;source lang="python"&gt; &gt;&gt;&gt; add.subtask((2, 2), immutable=True)  &gt;&gt;&gt; add.si(2, 2)</span></span></code> </pre><br><h5>  chord </h5><br>  Chord: <br>  accepts a list of tasks to be performed in parallel and a task that accepts a list of results from the task list.  This is bent. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@task def xsum(res_list): return sum(res_list) &gt;&gt;&gt; from celery import chord &gt;&gt;&gt; res = chord((add.s(i, i) for i in xrange(10)), xsum.s())() &gt;&gt;&gt; res.get() 90</span></span></code> </pre><br>  using chain (group) we get chord: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>c3 = (group(add.s(i, i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span>) | xsum.s())) &gt;&gt;&gt; res = c3() &gt;&gt;&gt; res.get() <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre><br><h5>  map </h5><br>  Like map (fun, [1,2,3]) <br><pre> <code class="python hljs">res=task.map([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>])  res=[task(<span class="hljs-number"><span class="hljs-number">1</span></span>), task(<span class="hljs-number"><span class="hljs-number">2</span></span>)]</code> </pre><br><h5>  starmap </h5><br><pre> <code class="python hljs">res=add.starmap([(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)])  res=[add(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), add(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)]</code> </pre><br><h5>  chuncs </h5><br>  Splits long lists of arguments into different tasks, <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> proj.tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> add &gt;&gt;&gt; res = add.chunks(zip(range(<span class="hljs-number"><span class="hljs-number">100</span></span>), range(<span class="hljs-number"><span class="hljs-number">100</span></span>)), <span class="hljs-number"><span class="hljs-number">10</span></span>)() &gt;&gt;&gt; res.get() [[<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>], [<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">36</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>], [<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-number"><span class="hljs-number">46</span></span>, <span class="hljs-number"><span class="hljs-number">48</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">54</span></span>, <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">58</span></span>], [<span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">62</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">66</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">72</span></span>, <span class="hljs-number"><span class="hljs-number">74</span></span>, <span class="hljs-number"><span class="hljs-number">76</span></span>, <span class="hljs-number"><span class="hljs-number">78</span></span>], [<span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-number"><span class="hljs-number">86</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">98</span></span>], [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">106</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">118</span></span>], [<span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-number"><span class="hljs-number">124</span></span>, <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">130</span></span>, <span class="hljs-number"><span class="hljs-number">132</span></span>, <span class="hljs-number"><span class="hljs-number">134</span></span>, <span class="hljs-number"><span class="hljs-number">136</span></span>, <span class="hljs-number"><span class="hljs-number">138</span></span>], [<span class="hljs-number"><span class="hljs-number">140</span></span>, <span class="hljs-number"><span class="hljs-number">142</span></span>, <span class="hljs-number"><span class="hljs-number">144</span></span>, <span class="hljs-number"><span class="hljs-number">146</span></span>, <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">154</span></span>, <span class="hljs-number"><span class="hljs-number">156</span></span>, <span class="hljs-number"><span class="hljs-number">158</span></span>], [<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">162</span></span>, <span class="hljs-number"><span class="hljs-number">164</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">170</span></span>, <span class="hljs-number"><span class="hljs-number">172</span></span>, <span class="hljs-number"><span class="hljs-number">174</span></span>, <span class="hljs-number"><span class="hljs-number">176</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>], [<span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-number"><span class="hljs-number">182</span></span>, <span class="hljs-number"><span class="hljs-number">184</span></span>, <span class="hljs-number"><span class="hljs-number">186</span></span>, <span class="hljs-number"><span class="hljs-number">188</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>, <span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">194</span></span>, <span class="hljs-number"><span class="hljs-number">196</span></span>, <span class="hljs-number"><span class="hljs-number">198</span></span>]]</code> </pre><br><h5>  Subtotal: </h5><br>  Celery 3.0 gives a lot of very handy buns that are a pleasure to use if used. <br><h5>  Total: </h5><br>  Celery provides many convenient tools, but for small tasks, where 90% of these functions are not needed, it is quite possible to do with a message queue (rabbit), thus getting rid of the need to configure celery, reduce server load, get rid of additional project dependencies. <br>  <b>Thank you all for your attention.</b> </div><p>Source: <a href="https://habr.com/ru/post/158961/">https://habr.com/ru/post/158961/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158949/index.html">Increased throughput of heavily loaded WiFi networks by 4-7 times</a></li>
<li><a href="../158951/index.html">Methods of monetization of Internet projects</a></li>
<li><a href="../158953/index.html">Cabinets that do not cut hands</a></li>
<li><a href="../158955/index.html">Call of Duty: Black Ops 2 earned $ 500 million per day</a></li>
<li><a href="../158959/index.html">Microsoft Surface as an attempt to lift your hair</a></li>
<li><a href="../158963/index.html">Eliminating the artifacts of compression PVRTC textures</a></li>
<li><a href="../158965/index.html">Understanding MSP430 and Toilet Automation</a></li>
<li><a href="../158969/index.html">Difficult forms in Django</a></li>
<li><a href="../158971/index.html">Scripting Techniques in Bash</a></li>
<li><a href="../158973/index.html">Good Practice on setting up a small local network based on Active Directory</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>