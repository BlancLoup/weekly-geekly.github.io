<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Petya and others. ESET discloses cyber attacks on corporate networks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The epidemic of the Petya encoder is in the spotlight. The problem is that this is only the last incident in a series of attacks on Ukrainian companie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Petya and others. ESET discloses cyber attacks on corporate networks</h1><div class="post__text post__text-html js-mediator-article">  The epidemic of the Petya encoder is in the spotlight.  The problem is that this is only the last incident in a series of attacks on Ukrainian companies.  The ESET report reveals some features of Diskcoder.C (aka ExPetr, PetrWrap, Petya, or NotPetya) and includes information about previously unlit attacks. <br><br><img src="https://habrastorage.org/web/6c0/a91/626/6c0a916267df4d84a78be0a7ecd6114a.jpg"><br><br><a name="habracut"></a><h3>  TeleBots </h3><br>  In December 2016, we published a study of the destructive attacks carried out by the cyber group, which we call TeleBots.  The group attacked <a href="https://www.welivesecurity.com/2016/12/13/rise-telebots-analyzing-disruptive-killdisk-attacks/">financial institutions</a> and used a version of the destructive component <a href="https://www.welivesecurity.com/2017/01/05/killdisk-now-targeting-linux-demands-250k-ransom-cant-decrypt/">KillDisk for Linux</a> .  In addition, TeleBots may be related to the BlackEnergy group related to <a href="https://habrahabr.ru/company/eset/blog/274503/">cyber attacks</a> on energy companies. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The KillDisk malware was used by the TeleBots group at the final stage of the attacks to overwrite files with certain extensions on the victim's disk.  Looking ahead, the ransom was never a priority for this group. <br><br>  In the first wave of attacks in December 2016, KillDisk rewrote target files, instead of encrypting data.  The victim did not receive contacts to connect with the attackers, the malware simply displayed an image referring to the ‚ÄúMr. Robot‚Äù series. <br><br><img src="https://habrastorage.org/web/175/9c1/08f/1759c108f8ac491182ad915fd4175f8d.png"><br>  <i>Figure 1. The image that KillDisk displayed on the screen during the first wave of attacks in December 2016.</i> <i><br></i> <br>  In the second wave of attacks, the attackers modified KillDisk by adding encryption and contact information to the redemption message, which made it look like a typical extortionist program.  At the same time, the authors requested a record amount for data recovery - 222 Bitcoins (about 250 thousand dollars at the current exchange rate).  This may indicate that the hackers were not interested in obtaining a ransom, but were trying to harm the attacked companies. <br><br><img src="https://habrastorage.org/web/b11/82d/071/b1182d07198645d9a55581d393ee0ee4.png"><br>  <i>Figure 2. KillDisk buyback, version of the second wave of attacks in December 2016.</i> <br><br>  In 2017, the TeleBots group continued attacks that became more sophisticated.  From January to March 2017, the group compromised a Ukrainian software development company ( <u>not</u> MEDoc) and, using VPN tunnels, gained access to the internal networks of several financial institutions. <br><br><img src="https://habrastorage.org/web/a13/a96/460/a13a96460d22480fa67c65f4bd9f2a06.png"><br>  <i>Figure 3. Supply-chain attacks in 2017</i> <br><br>  In the course of this attack, TeleBots replenished the arsenal with two samples of encoders and updated versions of the tools mentioned in our previous reports. <br><br>  The first backdoor that the group largely relied on was Python / TeleBot.A, which was rewritten from the Python programming language to Rust.  The functions have not changed - this is a standard backdoor that uses the Telegram Bot API to receive commands from operators and send responses. <br><br><img src="https://habrastorage.org/web/633/804/bab/633804babdd24e6bb6e2ca686446e8db.png"><br>  <i>Figure 4. Disassembled Win32 / TeleBot.AB trojan code.</i> <br><br>  The second backdoor, written on VBS and packed using the <code>script2exe</code> program, was strongly obfuscated, but its functionality remained the same as in previous attacks. <br><br><img src="https://habrastorage.org/web/994/f2d/71f/994f2d71fd0841c0b84151713808a1fa.png"><br>  <i>Figure 5. Obfuscated version of the VBS backdoor.</i> <br><br>  This time the VBS backdoor uses the command C &amp; C server 130.185.250 [.] 171.  To make connections less suspicious for those who check the firewall logs, the attackers registered the domain <b>transfinance.com [.] Ua</b> and placed it on this IP address.  As you can see in Figure 6, a mail server named <code>severalwdadwajunior</code> , which worked on the Tor network, was also launched. <br><br><img src="https://habrastorage.org/web/bf0/fa7/065/bf0fa706538c43fb89e7d2bc6d8033da.png"><br>  <i>Figure 6. Information about the TeleBots group server.</i> <br><br>  In addition, the attackers used the following tools: <br><br><ul><li>  CredRaptor (password theft) </li><li>  Plainpwd (modified Mimikatz is used to recover Windows credentials from memory) </li><li>  SysInternals' PsExec (used to spread threats inside the network) </li></ul><br>  As stated earlier, at the final stage of the attack, TeleBots spread the encoder using PsExec and the stolen Windows credentials.  ESET antivirus products detect it as Win32 / Filecoder.NKH.  After running, malware encrypts all files (except those located in C: \ Windows) using the AES-128 and RSA-1024 algorithms.  The malicious program adds the <code>.xcrypted</code> extension to the encrypted files <code>.xcrypted</code> <br><br>  When encryption is complete, the program creates a text file readme.txt with the following content: <br><br>  <i>Please contact us: openy0urm1nd@protonmail.ch</i> <br><br>  In addition to malware for Windows, the TeleBots group used a Linux encoder for other operating systems.  ESET detects the threat as Python / Filecoder.R, it is written in Python.  This time, attackers use third-party utilities to encrypt files, such as <code>openssl</code> .  Encryption is performed using RSA-2048 and AES-256 algorithms. <br><br><img src="https://habrastorage.org/web/a31/b72/deb/a31b72deb630449bba7a59ebdbdfc581.png"><br>  <i>Figure 7. Python code of the Python / Filecoder.R Linux encoder used by the TeleBots group.</i> <br><br>  In the Python script code, attackers leave a comment, including the following text: <br><br>  <i>feedback: openy0urm1nd [@] protonmail.ch</i> <br><br><h3>  Win32 / Filecoder.AESNI.C </h3><br>  On May 18, we <a href="https://www.esetnod32.ru/company/press/center/shifrator-xdata-atakoval-ukrainskie-kompanii/">recorded the</a> activity of another family's encoder, Win32 / Filecoder.AESNI.C, also known as XData. <br><br>  The extortioner program was distributed mainly in Ukraine, which is associated with an interesting initial vector of infection.  According to ESET telemetry, the encoder appeared on the computer immediately after launching the MEDoc reporting and workflow software, which is widespread in Ukrainian companies. <br><br>  The Win32 / Filecoder.AESNI.C functionality allowed the encoder to be automatically distributed on the company's local network.  In particular, the Mimikatz embedded DLL was used to extract Windows accounts from the memory of a compromised computer.  Using credentials, malware was distributed within the network using the PsExec utility. <br><br>  It seems that the attackers did not reach their goal during this attack, or they tested before a more effective strike.  In any case, the master keys were published on the <a href="https://www.bleepingcomputer.com/news/security/aes-ni-ransomware-dev-releases-decryption-keys-amid-fears-of-being-framed-for-xdata-outbreak/">BleepingComputer</a> forum, and a statement appeared there that the AESNI source code was stolen from the real author and was used in the Ukrainian incident. <br><br>  ESET has released a <a href="https://www.esetnod32.ru/company/press/center/eset-vosstanovit-fayly-zashifrovannye-aes-ni-i-xdata/">decoder</a> for Win32 / Filecoder.AESNI victims. <br><br><h3>  Epidemic Diskcoder.C (better known as Petya) </h3><br>  What really received wide media coverage was the Petya epidemic that began on June 27th.  The malware has compromised many systems in critical infrastructures and corporate networks in Ukraine and abroad. <br><br>  The encryptor used in this attack can replace the master boot record (MBR) with its own malicious code.  The code is borrowed from the <a href="http://virusradar.com/en/Win32_Diskcoder.Petya.B/description">Win32 / Diskcoder.Petya ransomware program</a> , so some researchers call the threat ExPetr, PetrWrap, Petya or NotPetya.  Unlike the original Petya, the authors of Diskcoder.C changed the MBR code in such a way that it was impossible to recover the data.  More precisely, the attackers cannot send the decryption key to the victim, and it cannot be entered in the appropriate field because it contains invalid characters. <br><br>  Visually, the MBR part of Diskcoder.C looks like a slightly modified version of Petya: first, it shows a message in which it disguises itself as CHKDSK, a Microsoft disk check utility.  In the fake scan process, Diskcoder.C actually encrypts the data. <br><br><img src="https://habrastorage.org/web/92e/3f3/b25/92e3f3b25d284a07b838f006a5e53738.png"><br>  <i>Figure 8. Fake CHKDSK message displayed by Diskcoder.C.</i> <br><br>  When encryption is complete, the MBR code displays the following message with instructions for payment, but, as has already been proven, this information is useless. <br><br><img src="https://habrastorage.org/web/56e/532/66a/56e53266affa491ba0eecb33854c70a4.png"><br>  <i>Figure 9. Message Diskcoder.C with instructions for paying the ransom.</i> <i><br></i> <br>  The rest of the code, in addition to the borrowed MBR, was written by the authors of the malware.  It includes a file encryptor that can be used in addition to the MBR disk encryption.  The malware uses the AES-128 and RSA-2048 algorithms. <br><br>  It is worth noting that the authors made mistakes, which reduced the possibility of decrypting files.  For example, Diskcoder.C encrypts only the first 1 MB of data and does not record the header and footer, only the original encrypted data.  Malware does not rename files, so it‚Äôs hard to say which files are encrypted and which are not. <br><br>  Interestingly, the list of targeted extensions, although not completely identical, is very similar to that used in the KillDisk attacks <a href="https://www.welivesecurity.com/2016/12/13/rise-telebots-analyzing-disruptive-killdisk-attacks/">in December 2016</a> . <br><br><img src="https://habrastorage.org/web/09d/816/253/09d8162535de49438f6168a7a23ab199.png"><br>  <i>Figure 10. The list of target Diskcoder.C extensions.</i> <br><br>  After executing Diskcoder.C, it tries to increase the reach with the help of the EternalBlue exploit that uses the DoublePulsar backdoor operating in kernel mode.  Exactly the same method was used in the extortionist WannaCryptor.D. <br><br>  Diskcoder.C also used a method borrowed from Win32 / Filecoder.AESNI.C (XData) - it uses a simplified version of Mimikatz to get credentials, and then executes malware on other local network machines using SysInternals PsExec. <br><br>  Finally, the authors of Diskcoder.C used the third distribution method, the WMI mechanism. <br><br>  All three methods were used to distribute Diskcoder.C within networks.  Unlike WannaCryptor, the new encoder used the EternalBlue exploit only on computers in the address range of the local network. <br><br>  Why did the epidemic go beyond Ukraine?  Our study showed that infected companies in other countries connected via VPN to their Ukrainian branches or business partners. <br><br><h3>  Initial vector of infection </h3><br>  Both Diskcoder.C and Win32 / Filecoder.AESNI.C used supply-chain attack attacks as the initial infection vector.  These families of malware were transmitted using the reporting and document management software MEDoc, which is widely used in accounting. <br><br>  There are several options for conducting these attacks.  MEDoc has an internal document and messaging system, so hackers could use phishing.  In this case, user interaction is necessary, perhaps not without social engineering.  Since Win32 / Filecoder.AESNI.C did not spread too widely, we first decided that it was these methods that were involved. <br><br>  But the subsequent epidemic of Diskcoder.C suggests that hackers had access to the update server of legitimate MEDoc software.  With it, attackers could send malicious updates with their installation automatically without user intervention.  Therefore, so many systems in Ukraine suffered from this attack.  It seems that the creators of Malvari underestimated the ability of Diskcoder.C to expand. <br><br>  ESET researchers have confirmed this theory.  We found a php backdoor in the <code>medoc_online.php</code> file in one of the directories on the MEDoc FTP server.  Access to the backdoor could be obtained via HTTP, although it was encrypted and the attacker needed a password to use it. <br><br><img src="https://habrastorage.org/web/d80/032/543/d80032543c1f4dd09b9138c9ef000334.png"><br>  <i>Figure 11. Directory with PHP backdoor on FTP.</i> <br><br>  It must be said that there are signs indicating that Diskcoder.C and Win32 / Filecoder.AESNI.C are not the only families of malicious programs that used this vector.  We can assume that malicious updates were applied to hidden penetration into computer networks belonging to priority objects. <br><br>  One of the malware spread by the compromised MEDoc update mechanism was the VBS backdoor, which the TeleBots group uses.  This time the attackers again used domain names related to the financial theme: <b>bankstat.kiev [.] Ua</b> . <br><br>  On the day of the outbreak of Diskcoder.C, the A-record of this domain was changed to 10.0.0.1. <br><br><h3>  findings </h3><br>  The TeleBots group improves the tools of destructive attacks.  Instead of sending phishing emails containing documents containing malicious macros, they used a more complex scheme known as supply-chain attack.  Before the outbreak of the epidemic, the group attacked mainly the financial sector.  It is likely that the last campaign was aimed at the Ukrainian business, but the attackers underestimated the possibilities of the malicious program - the malware got out of control. <br><br><h3>  Infection Indicators (IoC) </h3><br>  <b>Detection by ESET products:</b> <br> <code>Win32/TeleBot trojan <br> VBS/Agent.BB trojan <br> VBS/Agent.BD trojan <br> VBS/Agent.BE trojan <br> Win32/PSW.Agent.ODE trojan <br> Win64/PSW.Agent.K trojan <br> Python/Filecoder.R trojan <br> Win32/Filecoder.AESNI.C trojan <br> Win32/Filecoder.NKH trojan <br> Win32/Diskcoder.C trojan <br> Win64/Riskware.Mimikatz application <br> Win32/RiskWare.Mimikatz application</code> <br> <br>  <b>C &amp; C:</b> <br> <code>transfinance.com[.]ua (IP: 130.185.250.171) <br> bankstat.kiev[.]ua (IP: 82.221.128.27) <br> www.capital-investing.com[.]ua (IP: 82.221.131.52)</code> <br> <br>  <b>Legitimate servers used by malware authors:</b> <br> <code>api.telegram.org (IP: 149.154.167.200, 149.154.167.197, 149.154.167.198, 149.154.167.199)</code> <br> <br>  <b>VBS backdoor:</b> <br> <code>1557E59985FAAB8EE3630641378D232541A8F6F9 <br> 31098779CE95235FED873FF32BB547FFF02AC2F5 <br> CF7B558726527551CDD94D71F7F21E2757ECD109</code> <br> <br>  <b>Mimikatz:</b> <br> <code>91D955D6AC6264FBD4324DB2202F68D097DEB241 <br> DCF47141069AECF6291746D4CDF10A6482F2EE2B <br> 4CEA7E552C82FA986A8D99F9DF0EA04802C5AB5D <br> 4134AE8F447659B465B294C131842009173A786B <br> 698474A332580464D04162E6A75B89DE030AA768 <br> 00141A5F0B269CE182B7C4AC06C10DEA93C91664 <br> 271023936A084F52FEC50130755A41CD17D6B3B1 <br> D7FB7927E19E483CD0F58A8AD4277686B2669831 <br> 56C03D8E43F50568741704AEE482704A4F5005AD <br> 38E2855E11E353CEDF9A8A4F2F2747F1C5C07FCF <br> 4EAAC7CFBAADE00BB526E6B52C43A45AA13FD82B <br> F4068E3528D7232CCC016975C89937B3C54AD0D1</code> <br> <br>  <b>Win32 / TeleBot:</b> <br> <code>A4F2FF043693828A46321CCB11C5513F73444E34 <br> 5251EDD77D46511100FEF7EBAE10F633C1C5FC53</code> <br> <br>  <b>Win32 / PSW.Agent.ODE (CredRaptor):</b> <br> <code>759DCDDDA26CF2CC61628611CF14CFABE4C27423 <br> 77C1C31AD4B9EBF5DB77CC8B9FE9782350294D70 <br> EAEDC201D83328AF6A77AF3B1E7C4CAC65C05A88 <br> EE275908790F63AFCD58E6963DC255A54FD7512A <br> EE9DC32621F52EDC857394E4F509C7D2559DA26B <br> FC68089D1A7DFB2EB4644576810068F7F451D5AA</code> <br> <br>  <b>Win32 / Filecoder.NKH:</b> <br> <code>1C69F2F7DEE471B1369BF2036B94FDC8E4EDA03E <br></code> <br>  <b>Python / Filecoder.R:</b> <br> <code>AF07AB5950D35424B1ECCC3DD0EEBC05AE7DDB5E</code> <br> <br>  <b>Win32 / Filecoder.AESNI.C:</b> <br> <code>BDD2ECF290406B8A09EB01016C7658A283C407C3 <br> 9C694094BCBEB6E87CD8DD03B80B48AC1041ADC9 <br> D2C8D76B1B97AE4CB57D0D8BE739586F82043DBD</code> <br> <br>  <b>Win32 / Diskcoder.C:</b> <br> <code>34F917AABA5684FBE56D3C57D48EF2A1AA7CF06D</code> <br> <br>  <b>PHP shell:</b> <br> <code>D297281C2BF03CE2DE2359F0CE68F16317BF0A86</code> </div><p>Source: <a href="https://habr.com/ru/post/332058/">https://habr.com/ru/post/332058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332042/index.html">Some thoughts on the Visitor pattern</a></li>
<li><a href="../332050/index.html">Security Week 26: ExPetr is not an extortionist, Intel PT allows you to bypass PatchGuard, in the Malware Protection Engine again RCE</a></li>
<li><a href="../332052/index.html">Symfony: Webpack Encore - plugin for resource management</a></li>
<li><a href="../332054/index.html">VK Streaming API Contest</a></li>
<li><a href="../332056/index.html">How to become a team leader and not explode</a></li>
<li><a href="../332060/index.html">Never write long ifs</a></li>
<li><a href="../332062/index.html">Who is Mr. Hacker?</a></li>
<li><a href="../332064/index.html">How to confuse the analyst. Part Two: What is domain modeling?</a></li>
<li><a href="../332066/index.html">Probabilistic and informational analysis of measurement results in Python</a></li>
<li><a href="../332068/index.html">Automation blocking Petya / NonPetya</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>