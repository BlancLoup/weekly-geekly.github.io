<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Intel technology to transfer network traffic from a physical adapter to a virtual one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I want to share an analysis of existing Intel technologies that allow you to quickly transfer traffic from a physical card to a virtual machine...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Intel technology to transfer network traffic from a physical adapter to a virtual one</h1><div class="post__text post__text-html js-mediator-article">  Hello!  I want to share an analysis of existing Intel technologies that allow you to quickly transfer traffic from a physical card to a virtual machine.  In principle, all methods have been tested in reality on Intel XL710 cards, so I will also say about their pros and cons.  And since our company is engaged in the development of a virtual switch, all of this is in terms of a virtual switch. <br><br><h4>  <b>Intel SR-IOV</b> </h4><br>  Not exactly the technology from Intel, but only their implementation was able to touch.  In short, the physical adapter (PF) is divided into several virtual (VF).  The traffic inside one vlan by default does not go beyond the boundaries of the PF, and provides the most minimal delays compared to virtual adapters on soft bridges. <br><br><div class="spoiler">  <b class="spoiler_title">Drivers</b> <div class="spoiler_text">  VF is a PCI device that runs into a virtual machine.  The virtual machine must have an i40e driver, otherwise it will not be able to pick it up.  True to the dockers you can stupidly throw in netns. </div></div><br>  Using <b>Intel FlowDirector</b> in principle, you can change the behavior and specify the rules by which traffic should go between the VF or out of the PF.  You can also make a manual distribution of traffic on RX queues or hardwired drop traffic immediately at the entrance to the map.  Support for the configuration of the flow is in the drivers, but I did not find a specific api specifically for Flow Director.  Who wants to play around - you can dig into the ethtool source, or use Intel DPDK, the API is implemented in it, but the card is unlinked from the kernel driver with all the consequences. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From my point of view, these technologies are mainly for admins who simply need to reduce delays in transferring traffic between virtual machines. <br><br>  <b>Pros</b> : work in VMWare, and KVM.  Everywhere is faster than software bridges both in terms of delays and throughput.  And the CPU does not eat. <br><br>  <b>Minuses</b> : virtual switch in this case - you need to turn it into a real one on a separate hardware, where PFs from the server with virtual machines are plugged into. <br>  And 64 VF per PF is now quite small. <br><a name="habracut"></a><br><h4>  <b>Intel DPDK</b> </h4><br>  About this development kit on Habr√© there were already articles, so I will not particularly spread.  But in the virtual machine contest, there is little information.  I will analyze the main ways of using the Intel DPDK in case you need to transfer traffic between the physical adapter and the virtual one.  This technology for us is the main, as we do the Openflow switch. <br>  Well, further, under the virtual machine, I mean KVM with the DPDK application inside, since you don‚Äôt really put anything on the VMWare hypervisor, and there isn‚Äôt much choice inside the VMWare virtual machine, e1000 or vmxnet3.  I advise vmxnet3. <br><br>  Intel pleased us with the following features. <br><br><h5>  <b>Method 1: Pain</b> </h5><br>  Technically it is one of the two.  You can pick up your virtual switch via TAP, and use the e1000 as a virtual adapter, and if within the VM DPDK application you cling to it via igb pmd. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/465/2e8/e83/4652e8e839774dfdbe7bc1263f5dbc57.png"></div><br>  You can pick up your virtual switch via TAP, and use virtio-net as a virtual adapter, and if you have an application inside VM DPDK, you cling to it through virtio pmd. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9ee/487/34f/9ee48734fae94237a7e86d9950a55bc0.png"></div><br>  <b>Advantages of these methods:</b> simplicity, works with both DPDK applications and conventional ones. <br>  <b>Cons:</b> performance is just pain, a lot of copying, a lot of transitions inside the virtual machine and context switching. <br><br><h5>  <b>Method 2: Fast &amp; Furios</b> <br></h5><br>  You can pick up your virtual switch via IVSHMEM (in Qemu, you had to patch it before, now it‚Äôs kind of injected), and as a virtual adapter you can create a specialized DPDK Ring adapter, which is the fastest IPC mechanism between DPDK applications. <br><br><img src="https://habrastorage.org/files/df9/764/677/df9764677a9446dc96f9b536d6ba02c8.png"><br><br>  <b>Pros</b> : better performance <br>  <b>Cons</b> : DPDK applications only <br><br><h5>  <b>Method 3: One size fits all</b> </h5><br>  You can pick up your virtual switch through the vhost-user API, and use virtio-net as a virtual adapter. <br><br><img src="https://habrastorage.org/files/e98/926/9e8/e989269e81be4035a2668e54e4720c91.png"><br><br>  <b>Pros</b> : works with both DPDK applications and ordinary ones, the performance is good (but worse than method 2, if there is an application inside the VM DPDK) <br>  <b>Cons</b> : mainly related to link statuses and other straps, solvable <br><br><h5>  <b>Method 4: Arcane</b> </h5><br>  Intel DPDK also offers a way to create a KNI device.  In a nutshell, there is a separate kernel module that organizes soft rx / tx queues, creates a virtual adapter with these queues and provides copying from skb_buf to mbuf and back, emulating the network. <br>  We are still exploring it until there are no final results. <br><br>  But already known: <br><br>  <b>Pros</b> : you can combine with a DPDK ring, create a KNI for legacy, leave a ring for DPDK.  You can create KNI on top of a physical map. <br>  <b>Cons</b> : as it does not go very well, the CPU eats in tons and there are no special benefits. <br>  But we are working on it. <br><br>  Will keep you posted. </div><p>Source: <a href="https://habr.com/ru/post/315914/">https://habr.com/ru/post/315914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315904/index.html">Meeting lovers of big data and art</a></li>
<li><a href="../315906/index.html">SPDK: Acceleration with NVMe Disks</a></li>
<li><a href="../315908/index.html">When is it harmful to test your components?</a></li>
<li><a href="../315910/index.html">Asterisk statistics interface. New version, new functionality</a></li>
<li><a href="../315912/index.html">Connecting a character LCD to the board from WD MyBook Live on AppliedMicro APM82181</a></li>
<li><a href="../315916/index.html">You, Inc. How to develop personal and professional skills, sell them and stand out from the crowd</a></li>
<li><a href="../315918/index.html">How an entrepreneur destroyed a mediocre business to create a great company</a></li>
<li><a href="../315924/index.html">Biological background of the degradation of companies</a></li>
<li><a href="../315926/index.html">Fedora 25. New Hope: Wayland, Storaged, Raspberry Pi Support ...</a></li>
<li><a href="../315928/index.html">Welcome to Unity Moscow Meetup December 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>