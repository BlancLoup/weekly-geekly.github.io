<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Electronic library for PocketBook: automatic processing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably every electric reader would like to keep his entire collection of books directly on the e-book reader, and at the same time, in spite of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Electronic library for PocketBook: automatic processing</h1><div class="post__text post__text-html js-mediator-article">  Probably every electric reader would like to keep his entire collection of books directly on the e-book reader, and at the same time, in spite of the overall inhibition of the device, have easy navigation. <br>  Often, it‚Äôs problematic to keep hundreds and thousands of books in an e-book: either the device does not read for a long time, reading information about each book from its insides, or manually maintain the collection with a breakdown into catalogs ‚Äî one that is still hemorrhoids. <br><a name="habracut"></a><br><br><h4>  Preamble </h4><br>  I remember that in the early editions of Sony's electronic books there was such a problem: you upload several hundred books there, and the device hangs on when you turn it on, making up a list of downloaded files.  Then there was still no support for collections and Sonya ran for a long time over the entire card, collecting information about the uploaded books.  Many have complained. <br>  It was more convenient to work with books from PocketBook - they supported navigation through the file system, so you could manually scatter books into folders, and only books in the folder in which we entered were read the device. <br>  Manually from a computer it was already possible to form something and somehow live. <br><br>  At the same time, I was introduced to LibRusEk (now Flibusta is more relevant, who does not know what it is, to you <a href="http://bit.ly/KBR6xy">here</a> ).  And at some point I got the idea, and not try to drive the entire library into the electric book, having slightly automated this process? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  <em>And now important!</em>  <em>In order not to waste the attention of people to whom this article probably will not be able to help (unfortunately there will be such), I will give a filter installation:</em> <em><br></em>  <em>If you are the owner of the <strong>PocketBook</strong> e-reader, and you are interested in the idea of ‚Äã‚Äãdriving as many books as possible with convenient navigation into the device - you are definitely here.</em>  <em>If you are the owner of another e-book, which nevertheless supports the <strong>FB2</strong> format and navigation through directories, you probably also come here, see closer to the end of the article the description of the <strong>$ no_leased_storage setting</strong> .</em>  <em>The rest, unfortunately, this article will not be able to help.</em>  <em>Excuse me.</em> </blockquote><br><br>  Having a little picked about the PocketBook functionality, I found out one interesting feature: it supports link files.  Something like shortcuts in Windows or symlinks in Unix.  I will explain later why we need them and what is the beauty of this feature, and now I‚Äôll just say that they are used regularly for the functioning of the Favorites section.  When you post a book there, only the link to the real book file is placed in a special folder on the device.  The book itself is not copied to favorites. <br>  Also, after talking with the developers, it was found that at that time SDHC capacities up to 32Gb were already supported.  In general, for modern models that have a microSD slot, the same 32Gb is indicated in the TTX, which is somewhat disappointing.  But not much.  Yes, and it is necessary to check the specifications of the specifications, but actually can support more.  Only a 64Gb card for the sake of unwarranted check broke to buy. <br>  Well, there is still a great feature - support for .fb2.zip, this is when each book in fb2 format is packed into its own zip-archive.  PocketBook sees such books transparently, that is, just as unpacked ones. <br><br>  Immediately it is worth explaining one thing, preempting rash questions: no one is going to read hundreds of thousands of books (and we are talking about such quantities).  Keeping such a collection on the device in the hope of ever reading it all is simply insane. <br>  The convenience of such a cataloged volume is completely different.  For example, someone advises you to read a particular book, you look, and you already have it.  Or a specific author for example.  You immediately find it in your book, and bookmark your favorites.  Yes, the author's directory can also be put in favorites, links to directories in Pocketbooks also work. <br>  Like ‚ÄúHonor Garrison‚Äù, ‚ÄúOK, I read‚Äù, and immediately put it into your favorites.  Otherwise, it will be forgotten, not to write in notebooks. <br><br><br><h4>  Theoretical part </h4><br>  So, get down to business.  A PHP script was written that takes fb2 files from the source folder, including zipped archives in batches, and creates a file system-based book collection for uploading to PocketBook. <br>  He creates it slyly.  Here you need to separately say about the nuances of the format fb2. <br>  First, the book keeps its title (as well as information about authors, genres and series) within itself.  The file name here is not important in principle. <br>  Secondly, the book can be written by several authors, relate to several genres and be included in several series.  And I would like to have a search and cataloging both by authors, by genres and by series.  With that, if written by two authors, I would like the book to be present in the catalogs of both. <br>  Copy to each appropriate directory book?  Nekomilfo. <br>  And this is where the link files come to the rescue. <br>  The script places the bodies of the books (in zip) in a separate directory, creating nested subdirectories inside and scattering them so that the final directory contains no more than a hundred books, and in intermediate directories no more than a hundred subdirectories.  This is so that the book is not stupid when accessing a particular zip, going through many files in one directory. <br>  Nearly, for example, in the root of a flash drive, a cataloger directory is created in which all the necessary navigation through authors, series and genres is done inside, and which in the end nodes instead of books contains the above-described link files that refer to the corresponding zip files.  A clever poketbook on the site of these links will show the books themselves, and will open them just as if they were in the cataloger. <br><br>  For example, I will show you how arbitrary 10 books will be stored as a result, what they will turn into in the file system of the SD card: <br><br><pre><code class="sql hljs">/_zipstorage_/00000000/00000000/00000001.zip /_zipstorage_/00000000/00000000/00000002.zip /_zipstorage_/00000000/00000000/00000003.zip /_zipstorage_/00000000/00000000/00000004.zip /_zipstorage_/00000000/00000000/00000005.zip /_zipstorage_/00000000/00000000/00000006.zip /_zipstorage_/00000000/00000000/00000007.zip /_zipstorage_/00000000/00000000/00000008.zip /_zipstorage_/00000000/00000000/00000009.zip /_zipstorage_/00000000/00000000/0000000a.zip /// -///  /00000001.flk /// -///  /00000002.flk /// -///  /00000003.flk /// -///  /00000004.flk /// -///  /00000005.flk /// -///  /00000006.flk /// -/// /00000008.flk /// -/// /0000000a.flk /// -///  /00000007.flk /// -///  /00000009.flk //_/ /  / -///  /00000007.flk //_/  // -/// /0000000a.flk //_/, // -///  /00000009.flk //_// / -///  /00000001.flk //_// / -///  /00000002.flk //_// / -///  /00000003.flk //_// / -///  /00000004.flk //_// / -///  /00000005.flk //_// / -///  /00000006.flk //_/// -/// /00000008.flk //_// / -///  /00000001.flk //_/ /  / -///00000007.flk //_/ /  / //00000007.flk //_/  // -///0000000a.flk //_/  // //0000000a.flk /// -///00000007.flk /// -///00000007.flk /// -///0000000a.flk /// //00000007.flk /// //00000007.flk /// //0000000a.flk</code> </pre> <br><br>  Inside each zip file in the _zipstorage_ directory there is a book in .fb2 format with the same name as the zip file. <br>  Inside each flk-file is the path to the corresponding zip-file with the book. <br>  In place of the .flk files in the device, the corresponding books are displayed, and they behave in the same way as if they were lying instead of .flk files.  That is, no "00000007.flk", "00000007.zip" and "00000007.fb2" users of the electric book will not see. <br>  As you can see, without the .flk links, if we had to copy each file to where it should be, our 10 files would turn into 31 files with the same size on the flash drive. <br>  But, thanks to the use of this fenki with links, this did not happen. <br><br>  You do not need to go to the "_zipstorage_" directory at all - this is a repository. <br>  Go to the cataloger called "Library". <br>  There you will be given a visitor card, at your request the librarian will go to the vault himself and bring you from there ... <br><br>  You may not immediately understand why it is necessary to get to the book ‚ÄúCube of red plastic‚Äù in this library along such a long path: "/ Authors / Letters AZ / S / Sem / Semenova Maria Vasilyevna". <br>  But I remind you that this is not about a dozen files, but about hundreds of thousands.  It will be much faster to enter consistently the directories "Letters AZ", "C", "Sem" and find there "Semyonova Maria Vasilyevna" than wait a long time to display, and then for a long time leaf through the full list of authors until we get to letters "C". <br>  In the same way, if you need to find all the books of Harry Harrison, it is quite logical to assume that the path will be "/ Authors / Letters AZ / Y / Gar / Harrison Harry".  Since, for example, the letter ‚ÄúG‚Äù of the authors of the dofigishch had to introduce an additional level of directories with the first three letters of the last name.  By the way, this is driven in the ‚Äúprocess.php‚Äù script by parameters to the function calls get_splitten_dirs (). <br>  Among other things, you do not need to go to the ‚Äúlibrary‚Äù every time to start reading the next Harrison book ‚Äî you only need to get there once.  And then, as I wrote above, we throw the entire Harrison into favorites and we always have it at hand.  It is really convenient. <br><br>  And I use it all almost ‚Äúin one person‚Äù (not counting a few friends who took the ready fill out from me, or simply duplicated my SD card) for about three years or so.  Disorder, it's probably time to share. <br><br><br><h4>  Practical part </h4><br>  Well, I think about theory is enough.  Who is in the subject, they will understand everything at once, incl.  where on the filibust to take the necessary "raw materials", and those who are not in the subject and who are not interested, are unlikely to finish reading this place. <br>  So let's move on to the description of the script itself, a link to the zip archive with which you will find at the end of the article. <br>  I will not describe the problems and solutions that I had to go through.  This is a topic for a separate article, probably in the section on PHP. <br>  I will describe only the general scheme of the script and its settings. <br><br><br><h4>  Let's start with what the script does outside </h4><br>  In addition to reading the source directory and forming the cataloger, the script also passes every fb2 file through itself.  That is, parses the structure and re-saves the file again - parsit. <br>  This is necessary to correct format errors.  Some files initially come beaten - then the invalid character is not translated into HTML code, then the left tags are found, which are torn off from the Internet pages, but not valid in fb2-format, then unclosed tags, then something else.  It‚Äôs not that there are too many of these errors, but they occur relatively regularly, and the electric book cannot open such files. <br><br>  The script also translates genres into more readable names. <br><br>  So.  When you download a zip-archive, you will find several php-files in it and in the subdirectories a few books for example. <br>  There is an ‚Äúout_dir \ src‚Äù directory from which we will read books, incl.  in zips. <br>  And there is a directory "out_dir \ dest", in which we will put the cataloger and storage.  After the script itself, everything that will be in this directory should be transferred to the root of the SD card. <br>  Well, you can either configure the script right away so that you write directly to the USB flash drive. <br><br>  Here it is necessary to make a reservation about a couple of nuances regarding the recording on SD-cards.  Be prepared for the fact that this process is not fast, given the amount of information and fragmentation. <br><ul><li>  There will be a lot of files.  In addition to the number of source files, at least three times more small flk-files will also be written to the USB flash drive.  Each of them contains a link to a zip-archive and takes only a few bytes, but on the media takes up a whole cluster.  We must remember this.  Therefore, it makes sense to format the USB flash drive with the smallest cluster size.  Otherwise, the megabytes of these files by the sum of their sizes in reality can easily gobble up on a flash drive already a gigabyte of space. </li><li>  A flash drive (SD card, not important) will warm up.  In addition, it will slow down after a short time due to the filling of buffers, it will also slow down the recording speed as it warms up.  I do not know why this is happening, but there is such a thing.  She needs to be given breaks to cool.  I usually form the script library on the hard drive, and then from it I already copy on the USB flash drive in batches.  It is also possible that it makes sense to use any container like TrueCrypt, on which you can form a library as on a USB flash drive, then tear off a disk image and deploy it to an SD card.  This will be the fastest way to write to a USB flash drive. </li><li>  An SD card, if you do not already have a large volume card, it is better to buy a higher class (for example, Class10), it will be a little more expensive, but it will significantly speed up the recording process.  Class10, by the way, it is already quite tolerably possible to score against the stop during the working day.  This I once again remind you that we are talking about hundreds of thousands of small files.  In terms of recording speed, this is fundamentally different from the ‚Äúroll up movie on 4 Gig.‚Äù  That is absolutely absolutely not similar. </li></ul><br><br>  The script was written for the machine on Windows, and accordingly PHP was installed under Windows, version 5.2.9-2.  In theory, he doesn‚Äôt care on which system to work on, but it may not be possible for someone to start something. <br>  It is because of Windows that the .bat files for running scripts are found in the arihiva. <br>  Here is a cropped version of the script.  The full one consists of two parts and a database under Interbase, into which all books are first imported, dubbing is filtered, cleaned, different interpretations of authors, genres, series and titles are corrected (such as Pushkin A.S. =&gt; Pushkin Alexander Sergeevich) , MD5 hashes are collected for further library updates, etc. <br>  I don‚Äôt see the point here to dump it all, because it‚Äôs one thing to raise PHP to execute the script, another thing is to set up a database, install all libraries, etc.  Hardly many of you will bother with it.  It's easier for everyone to finish their own database functionality to the script, if necessary.  Therefore, the script is cut off for autonomous work without any databases.  Slightly less functional, but not critical. <br><br>  A log file with errors (‚Äúprc_errors.txt‚Äù) will be created next to the script during its operation.  This is specified in the startup bat file ‚Äî redirecting STDERR to this file.  If there were no errors, it will be of zero size. <br><br><br><h4>  Internal kitchen </h4><br>  Actually the main script is in the file ‚Äúprocess.php‚Äù, and it must be run. <br>  Settings are stored in it at the beginning.  Here they are: <br><br><pre> <code class="php hljs">$out_file=<span class="hljs-string"><span class="hljs-string">'./out.txt'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        .    false     . $src_dir='./out_dir/src'; //  .  ,      . $dest_dir='./out_dir/dest'; //  .  ,      SD-. $storagename='_zipstorage_'; //   -.      flk-,         SD-. $libname=''; //   - $compress_storage=true; //     .  ,    fb2.  ,    .   -. $control_genres_export=false; //      (. genres.inc) $no_leased_storage=false; //      -. $dbid=0; //    ID ,        .       ))) $GLOBALS['process_config']=array( 'struct_only'=&gt;false, //    'unknown_tags_processing'=&gt;XMLP_UT_CUT, //    (  fb2 , . 'tags_hash') 'strip_comments'=&gt;false, //   &lt;!-- --&gt; 'tags_hash'=&gt;$GLOBALS['XMLP_FB2_elements'], //    'tags_processing'=&gt;array( //      'name_first_alpha'=&gt;false, 'name_len'=&gt;20, 'content_len'=&gt;512, 'pattern_type'=&gt;XMLP_TPS_STRICT, 'include_comments'=&gt;true, ), );</span></span></code> </pre><br><br>  I will describe the parameter <strong>$ GLOBALS ['process_config'] ['unknown_tags_processing']</strong> .  It steers the parser, and more precisely, what the parser will do with the detected tags that are not valid for the fb2 format (FictionBook 2.0): <br><ul><li>  XMLP_UT_LEAVE - leave everything as it was in the source. </li><li>  XMLP_UT_CONVERT - convert to text displayed in the book.  That is, &lt;tag&gt; text &lt;/ tag&gt; turns into &amp; lt; tag &amp; gt;  text &amp; lt; / tag &amp; gt;  as a result, the book will display as &lt;tag&gt; text &lt;/ tag&gt;. </li><li>  XMLP_UT_CUT - only the tags themselves will be cut.  Their internal text will remain accessible to the reader.  &lt;phpcode&gt; $ a = $ b; &lt;/ phpcode&gt; turns into $ a = $ b; </li><li>  XMLP_UT_CUT_FULL - unknown tags will be cut along with their contents.  that is, completely. </li><li>  XMLP_UT_CUT_SMART - not implemented.  alias for XMLP_UT_CUT </li></ul><br><br>  Obviously, two options are best for correcting errors: XMLP_UT_CONVERT and XMLP_UT_CUT.  Since in most cases the user is not interested in these tags at all, they are garbage, in my opinion, the most correct ones are simply cut using the XMLP_UT_CUT option. <br><br>  The FictionBook format tags themselves are passed to the parser in the <strong>$ GLOBALS ['process_config'] [[tags_hash '] parameter</strong> .  The <strong>$ GLOBALS ['XMLP_FB2_elements']</strong> array is predefined at the beginning of the xmlp.inc file. <br><br>  The <strong>$ GLOBALS ['process_config'] ['tags_processing'] parameter drives the</strong> generation of regular perception of tags in the text.  There it is better not to touch too much, by default it's normal.  You can only set the <strong>'name_first_alpha'</strong> parameter to <strong>true</strong> - in this case, the engine will require an alpha character at the beginning of the tag name, and for example, this <strong>&lt;:&gt;</strong> will be perceived not as an unknown tag, but as garbage in the text, with all the consequences - with the <strong>XMLP_UT_CUT</strong> option <strong>,</strong> such tags will not be cut out, but will be turned into html entities and displayed to the end reader of the book. <br><br>  If the option <strong>'include_comments'</strong> is disabled here, a simpler regular schedule will be generated, as a result, script performance will increase two times at least, but in the files of books the comments in the &lt;! - -&gt; tags will turn into obfuscated porridge and become visible the ultimate reader of the book.  If the comment goes to the book text area, it‚Äôs still nothing, but if it‚Äôs in the title area, the book probably won't open at all on the device, since  this will be a violation of the XML structure of the document (arbitrary text between the XML tags). <br><br>  Configure <strong>$ no_leased_storage</strong> .  If set to true, a separate storage for books will not be used.  That is, no '_zipstorage_' and flk-files.  In place of flk-files in the library will go fb2 or zip (depending on the parameter <strong>$ compress_storage</strong> ).  It will eat more space on the SD card at the expense of several copies of the same book (see the description of the problem above), but it will allow the owners of other electronic books (not PocketBook), if their book supports fb2 format and navigation through directories on a flash drive, use the same script to automatically catalog your libraries. <br><br>  Another setting is <strong>$ control_genres_export</strong> .  Its rules are in the file ‚Äúgenres.inc‚Äù. <br>  There is an array of decoding genres, it looks like this: <br><pre> <code class="sql hljs"> ''=&gt;array('_ _','_ _', true), 'biography'=&gt;array('','', true), 'biogr_historical'=&gt;array('  ','', true), 'biogr_sports'=&gt;array(' ','', true), 'biogr_arts'=&gt;array(' ','', true), 'banking'=&gt;array(' ',' ', true), 'accounting'=&gt;array(', , ',' ', true), 'design'=&gt;array('  ',' ', true), 'org_behavior'=&gt;array(' ',' ', true),</code> </pre><br>  See, at the end of each array there is an element with a value of true?  So, with the <strong>$ control_genres_export</strong> option <strong>turned on, the</strong> script will only pour out those genres opposite of which in this last element is true.  Books that do not have any genres marked in ‚Äúgenres.inc‚Äù as true will be ignored, their bodies will not be included in the memory card either. <br>  This is very convenient if you understand that the size of your collection is larger than you have on the SD card. <br>  In this case, you simply edit the list of genres, excluding from it unnecessary you.  This allows you to pour the library onto the map partially, only with genres of interest to you.  For example, you like fiction, and poetry, romance novels and business literature do not interest you in principle. <br>  Also, no one bothers with this mechanism to break the library into sets of genres into several different memory cards. <br><br>  There is one more mechanism in the list of genres - reassignment. <br>  Below in the same file (and in the same array) you can see something like this: <br><pre> <code class="sql hljs"> ''=&gt;array('sci_psychology','r', true), 'science_history_philosophy'=&gt;array('sci_philosophy','r', true), ''=&gt;array('sci_linguistic','r', true), 'adv_history_avant'=&gt;array('adv_history','r', true), ''=&gt;array('adventure','r', true), ' '=&gt;array('prose_history','r', true),</code> </pre><br>  Do you see the lonely letter 'r' in the penultimate value of the meta tag? <br>  For a script, this means, for example, that if the code for the genre of 'adventure' is found in a book, it should look at the record of the genre with the code 'adventure' (in the same array).  As a result, he will attribute the book in the cataloger to the correct genre.  Although the fb2 file itself will not be edited. <br><br><br><h4>  Not implemented </h4><br>  Not cataloged by the actual names of the books.  Frankly speaking, I have no idea how it will look, and how to make a convenient breakdown of directories for quick navigation.  By and large, if you do not know anything other than the title, you can quickly punch the author from the phone in the internet, and already find the book on the device.  The time spent on the search, against the time spent on subsequent reading, IMHO, quite allow you to not bother with this. <br><br>  Progress mapping is not very well done.  In the source directory, both fb2-files, and zip'y with them, as well as subdirectories with the same sets can roll. <br>  For zip'files, progress is calculated at random, for each subdirectory its progress is displayed.  For good, it would be necessary at the beginning of the script to scan everything that is a separate passage and then show the overall progress of the implementation. <br><br>  Only the xmlp.inc parser module is thoroughly perelopachen.  In the rest of the source there is a mess with the names of variables, there are extra variables. <br><br>  Well, and still in detail, various non-critical things are not done. <br><br><br><h4>  Example of structure error correction </h4><br>  Before processing: <br><pre> <code class="sql hljs"> &lt;p&gt;&lt;:&gt;   &lt;tag&gt;&lt;/tag&gt;    &lt;  &gt;,  &lt;/b&gt;&gt;  &amp;lt; .&lt;:&gt;&lt;/p&gt; &lt;p&gt;‚Äî   ! ‚Äî  &lt;a&gt;  .&lt;/p&gt; &lt;p&gt;    &lt;/a&gt;     . .&lt;/p&gt;</code> </pre><br>  After (setting up XMLP_UT_CONVERT): <br><pre> <code class="sql hljs"> &lt;p&gt;&amp;lt;:&amp;gt;   &amp;lt;tag&amp;gt;&amp;lt;/tag&amp;gt;    &amp;lt;  &amp;gt;,  &amp;lt;/b&amp;gt;&amp;gt;  &amp;lt; .&amp;lt;:&amp;gt;&lt;/p&gt; &lt;p&gt;‚Äî   ! ‚Äî  &lt;a&gt;  .&lt;/a&gt;&lt;/p&gt; &lt;p&gt;         . .&lt;/p&gt;</code> </pre><br>  After (setting up XMLP_UT_CUT): <br><pre> <code class="sql hljs"> &lt;p&gt;       &amp;lt;  &amp;gt;,  &amp;gt;  &amp;lt; .&lt;/p&gt; &lt;p&gt;‚Äî   ! ‚Äî  &lt;a&gt;  .&lt;/a&gt;&lt;/p&gt; &lt;p&gt;         . .&lt;/p&gt;</code> </pre><br><br><br><h4>  Where to get this good? </h4><br>  And <a href="">here</a> . <br><br>  For everyone who does not want to hemorrhoids with PHP settings for Windows, he also dropped his package <a href="">here</a> .  By and large, it is better to download the latest version from <a href="http://www.php.net/">php.net</a> , but if you want to try scrap quickly and painlessly try, and if anything, immediately demolish, then deploy this archive to the c: \ php folder (in general, it is important to which one, it is desirable that the path be shorter and without spaces), and write this directory into the system environment variable path.  Everything will be ready to work at once. <br><br><br>  <strong>PS</strong> Yes, I know that there are desktop programs that allow you to store your collection.  But‚Ä¶ <br>  First, it was done all this when such programs did not exist. <br>  Secondly, they will not allow me to quickly do for myself what I can do myself (finish something in the code). <br>  Thirdly, it is unlikely that these programs can correct critical errors in books.  I intentionally did not use faster parsing of XML in the script using the C-shny libraries built into PHP, because they fall on errors.  You can disable the script crash in case of errors, but you cannot normally copy the file and automatically fix it. <br>  This script, although written in native PHP, is nevertheless optimized for processing speed. <br>  And much more. <br>  By the way, no one bothers to combine both.  From the desktop program, we select the books we need according to the conditions (there, in GIU, it is much more convenient to put all the conditions and filter everything according to the filters), and then we feed this script and it creates a directory on the memory card. <br><br><br>  <strong>UPD</strong> : I found an ambush with new Pocketbooks and new firmware.  Removes old bookshelf functionality, and support for .flk files.  You can see the discussion of the problem in the comments in my correspondence with the user <a href="https://geektimes.ru/users/klu4nik/" class="user_link">Klu4nik</a> .  The functionality with .flk files runs on the 912th Pocket on the firmware E912.2.1.2 20110727_154845 from the store.  On newer firmware is no longer working. <br>  A call to the support Poketbukov did not give anything useful, only water. <br>  After that, with the help of <a href="https://geektimes.ru/users/klu4nik/" class="user_link">Klu4nik,</a> I went out on the official forum to the user with the nickname Antuan, with the help of whom I found the solution.  Well, as a solution, at least we have a temporary crutch. <br>  It consists in the following: <br>  Pocketbook firmware supports native and third-party applications, you could see them by going from the main menu to the folder of the same name. <br>  Among other things, these applications can be shell scripts, just give them the extension .app <br>  After the tests, it turned out that you can open the book with a simple shell-command like "/ ebrmain/bin/fbreader.app /mnt/ext2/_zipstorage_/00000000/00000000/00000001.zip". <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, if, being in the application folder, on the device, simply go to the directory up (the ".." directory, not the main menu of the shelf), you will see the memory of the library and the memory card, and you can go everywhere and easily run .app files. If you enter from the main menu in the library - .app files you can not see. And through the "Applications" can. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I updated the sources, now there is another option in the ‚Äúprocess.php‚Äù file for setting </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ app_instead_of_flk</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If you enable it (true), then instead of .flk files, the cataloger will contain the .app files of the ‚ÄúWar and Peace.app‚Äù type, with approximately the following content:</font></font><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /ebrmain/bin/fbreader.app /mnt/ext2/_zipstorage_/00000000/00000000/00000001.zip</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Works with a bang, the book opens. I checked it on my PocketBook Pro 912, everything seems to be working fine. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But there are a couple of minuses. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When you enter through the "Applications" section, a simple file manager works instead of the bookshelf. No covers and beautiful bookshelf it will not display. It is also not possible to add to the "Favorites". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, download the script from the link above. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also advised to add to the site </font></font><a href="http://idea.pocketbook-int.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idea.pocketbook-int.com a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> request for the return of the old functionality. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is already a topic: </font></font><a href="http://idea.pocketbook-int.com/pocketbook-pro/idea/161"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idea.pocketbook-int.com/pocketbook-pro/idea/161</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you only need to get more votes, then there is a chance that they will make the option of the old shelf in the new firmware. But there you need to register to vote for the implementation of this feature. </font></font><br><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD 2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Solution number two. Also temporary (well, as anyone). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the current firmware 2.1.2 and 2.1.3, you can install the old shelf from PocketBook 611. There will be a main menu interface, like in the old firmware. At the same time, reference files .flk, ‚ÄúFavorites‚Äù, multitasking, new firmware settings work. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It looks like 9.7 inches like this (vertical and horizontal orientations): </font><font style="vertical-align: inherit;">(the pictures are clickable, I added a one-pixel frame to the screenshots and previews so that you can see the edges of the screen on a white background) </font><font style="vertical-align: inherit;">So far only two small bugs have been noticed:</font></font><br> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0001.png"></a> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0003.png"></a> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0004.png"></a> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0005.png"></a> <br><br> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0006.png"></a> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0007.png"></a> <br><br> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0008.png"></a> <a href=""><img src="http://cs.loving.ru/to_habr/pb_screens/tn/scr0009.png"></a> <br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. The main menu is not full screen, but it works as it should, not annoying. It is understandable - the menu template was made under the screen of 6 inches. The remaining screens normally scale themselves. Also, the ‚Äúdetailed‚Äù view of the shelf is not rendered to the full width of the screen. In the screenshots can be seen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. The "Home" button (return to the main menu) does not work.</font></font> Because<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switching to the main menu from the context also does not work, apparently this is due to the multitasking environment - it can not switch the task to that little task menu that we replaced. A bit annoying for a long time to go to the main menu from the directory tree. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation is simple. We swing </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Inside the zip is one ‚Äúbookshelf.app‚Äù file. You need to connect a USB-cord and write this file to the internal memory of the device (not to a USB flash drive) in the directory "/ system / bin /". </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually everything. After disconnecting the cable, it will work immediately, although it is better for every fireman to reboot in order for the main shelf to be unloaded from memory. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demolition is just as simple - we catch a string, delete this file "/system/bin/bookshelf.app" and everything will be back to square one.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tested on a PocketBook Pro 912 device. Works fine. </font></font><br><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD 3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : There is an additional discussion </font></font><a href="http://habrahabr.ru/post/143847/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wellcome with wishes and suggestions. </font></font><br><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD 4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [05/15/2012 20:52 MSK]: Fixed a malicious error in ‚Äúgenres.inc‚Äù, the genres_get () function, which caused a memory buzz in a loop. Dull ochepyatka was. Copy-paste is to blame. Sources updated, download. </font></font><br><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD 5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [05/15/2012 22:03 MSK]: As a result of the discussions on the link in UPD3, the following settings were added and changed:</font></font><br><pre> <code class="php hljs">$dest_mount_point=<span class="hljs-string"><span class="hljs-string">'/mnt/ext2/'</span></span>; $storagename=<span class="hljs-string"><span class="hljs-string">'.zipstorage'</span></span>; $path_encoding=PATH_ENC_AUTO;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The variable $ path_encoding is responsible for what encoding will be generated in the cataloger paths. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to the default automatic values, there can also be forced PATH_ENC_1251 or PATH_ENC_UTF8. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATH_ENC_AUTO defines preg_match ('/ win / i', PHP_OS) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the PHP_OS constant contains ‚Äúwin‚Äù, then it will be PATH_ENC_1251, otherwise PATH_ENC_UTF8. </font></font><br><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD 6</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [05/20/2012 3:10 MSK]: Moved to </font></font><a href="http://github.com/dsdcorp/fb2p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/143492/">https://habr.com/ru/post/143492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143482/index.html">Errors of technology transfer No. 3 / ‚ÄúErrors of offshore‚Äù + APDATE</a></li>
<li><a href="../143483/index.html">We delve into include and extend</a></li>
<li><a href="../143486/index.html">Changing the Visual Studio interface in the incoming RC</a></li>
<li><a href="../143489/index.html">Inside Startup sauna</a></li>
<li><a href="../143490/index.html">Benefits of Common Lisp</a></li>
<li><a href="../143494/index.html">Features of the culture of teaching in universities on computer specialties</a></li>
<li><a href="../143496/index.html">Oh this web</a></li>
<li><a href="../143497/index.html">Implementing an Identity Map Template in the Yii Framework</a></li>
<li><a href="../143498/index.html">Zabbix, we monitor MongoDB</a></li>
<li><a href="../143499/index.html">Practice of working with time in different time zones in unix-like systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>