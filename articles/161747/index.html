<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forwarding NVIDIA Quadro 4000 to a virtual machine using the Xen hypervisor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I read a post [ 1 ] about successfully deploying a video card to a virtual machine, I thought it would be nice for me to get myself such a workst...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forwarding NVIDIA Quadro 4000 to a virtual machine using the Xen hypervisor</h1><div class="post__text post__text-html js-mediator-article">  Once I read a post [ <a href="https://habr.com/ru/post/161747/">1</a> ] about successfully deploying a video card to a virtual machine, I thought it would be nice for me to get myself such a workstation. <br><br>  When developing cross-platform software, there are often problems with testing it.  I do all my work exclusively under Linux, with the end user working exclusively on the Windows operating system (OS).  It would be possible to use VirtualBox, for example, but when you need to test the operation of modules using OpenGL or CUDA, serious problems arise.  Dual Boot as an option I do not even consider.  It turns out that, one way or another, I have to use a second computer, which is simply not where to put it.  In this case, most of the time he is idle without work.  It turns out extremely not effective, in terms of the use of resources, the scheme. <br><br>  One day my dream has become a necessity.  It was necessary to build a graphic station with the following characteristics: <br><ol><li>  Operating system Windows 7 (hereinafter Windows); </li><li>  A set of software using DirectX, OpenGL and CUDA; </li><li>  High-speed, local, fault-tolerant storage of about 10 TB; </li><li>  Backup and recovery mechanism for the entire system; </li><li>  Periodic automatic backup of user data. </li></ol><br>  Many may think: "And where is virtualization?".  The problem is that Windows, in my personal opinion, is not very reliable.  Often, the end users of the system are not very qualified people, as a result of which malicious software gets onto the computer, which can destroy all data on all drives.  In this case, it is necessary that the backup was stored locally, but it was not possible to destroy it.  Organizing large and fast data storage is also not a trivial task.  One way or another, it was decided to run Windows in a virtual machine (VM) environment. <br><a name="habracut"></a><br>  I read a lot of articles and documentation (including on Habr√© [ <a href="https://habr.com/ru/post/161747/">1</a> - <a href="https://habr.com/ru/post/161747/">3</a> ]) about forwarding video cards to the VM environment.  The conclusion to which I came was not comforting for me.  Most successful probros were carried out with ATI graphics cards.  Throwing NVIDIA graphics card is possible, but not every.  This requires a patch hypervisor [ <a href="https://habr.com/ru/post/161747/">4</a> , <a href="https://habr.com/ru/post/161747/">5</a> ]. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Because of the need to use CUDA technology, I had to forward the NVIDIA graphics card.  There is NVIDIA Multi-OS technology [ <a href="https://habr.com/ru/post/161747/">6</a> ], which allows forwarding video cards to VMs.  This technology is supported only by accelerators from the Quadro series [ <a href="https://habr.com/ru/post/161747/">7</a> ]. <br><br>  Another disadvantage of most video cards is their minimum two slots.  This is often unacceptable and that is why the single-slot NVIDIA Quadro 4000 graphics card was chosen. It is the most powerful member of the Quadro family among single-slot options. <br><br>  Key elements of the system: <br><ol><li>  Motherboard ASUS P9X79 WS; </li><li>  Core i7-3820 processor; </li><li>  32 GB memory (4 levels of 8 GiB); </li><li>  Video card for dom0 (no matter what); </li><li>  Video card for domU NVIDIA Quadro 4000. </li></ol><br>  Initially, I wanted to implement my plan using the Xen hypervisor.  I chose Debian <nobr>GNU / Linux</nobr> wheezy (hereinafter Debian) as the OS for dom0.  The Linux kernel has an excellent implementation of software RAIDs. <br><br>  During the experiments I tried KVM.  He coped well with any device other than a video card.  Unfortunately, with <nobr>Xen 4.1</nobr> , which is part of common distributions, I also didn‚Äôt do anything.  In the virtual machine environment, the video card stubbornly refused to start. <br><br>  Fortunately, not long before I started working on this issue, <nobr>Xen 4.2.0</nobr> was released.  It is available, of course, only in the form of source codes. <br><br>  In order to avoid problems with disabling the necessary for forwarding devices from the dom0, it is necessary that the <nobr>xen-pciback driver</nobr> be included in the kernel.  In Debian distributions, it is shipped as a module. <br><br>  Thus, it was necessary to assemble the hypervisor and the kernel. <br><br><h2>  Install debian </h2><br>  When installing Debian, I didn‚Äôt do anything unusual.  Install only the base system.  The graphical environment should not be installed, because along with it a lot of software is put, part of which will conflict with the compiled Xen. <br><br>  At the end of the basic installation, I installed the minimum set of necessary software. <br><br><pre><code class="bash hljs">$ sudo apt-get install gnome-core gvncviewer mc</code> </pre> <br><h2>  Build the hypervisor and kernel </h2><br>  In order not to litter the combat system, I performed the assembly in a clean operating system specially installed under VirtualBox. <br><br>  To build Xen you need to run a series of simple commands [ <a href="https://habr.com/ru/post/161747/">8</a> ]. <br><br><pre> <code class="bash hljs">$ sudo apt-get build-dep xen $ sudo apt-get install libglib2.0-dev libyajl-dev fakeroot bison flex libbz2-dev liblzo2-dev $ wget http://bits.xensource.com/oss-xen/release/4.2.0/xen-4.2.0.tar.gz $ tar xf xen-4.2.0.tar.gz $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> xen-4.2.0 $ ./configure --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-githttp $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"PYTHON\_PREFIX\_ARG=--install-layout=deb"</span></span> &gt; .config $ make deb</code> </pre><br>  At the exit, I received the xen-upstream-4.2.0.deb package. <br><br>  The kernel was built because of the need to include the <nobr>xen-pciback driver</nobr> in the kernel.  The build process is well described in the official Debian documentation [ <a href="https://habr.com/ru/post/161747/">9</a> ]. <br><br><pre> <code class="bash hljs">$ sudo apt-get install linux-source $ sudo apt-get build-dep linux-latest $ sudo apt-get install kernel-package fakeroot $ tar xf /usr/src/linux-source-3.2.tar.bz2 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux-source-3.2 $ cp /boot/config-`uname -r` .config $ sed -i <span class="hljs-string"><span class="hljs-string">'s/CONFIG_XEN_PCIDEV_BACKEND=.*$/CONFIG_XEN_PCIDEV_BACKEND=y/g'</span></span> .config $ make-kpkg clean $ fakeroot make-kpkg --initrd --revision=1.0.0 kernel_image</code> </pre><br>  I got linux-image-3.2.32_1.0.0_amd64.deb on output. <br><br><h2>  Install the kernel and hypervisor </h2><br>  I installed the received packages on the target system.  Installing Xen creates unnecessary symbolic links in the / boot directory that need to be removed.  Since the assembled <nobr>xen-upstream-4.2.0.deb package</nobr> does not <nobr>contain</nobr> dependencies, the packages required for Xen need to be installed manually. <br><br><pre> <code class="bash hljs">$ sudo dpkg -i linux-image-3.2.32_1.0.0_amd64.deb $ sudo dpkg -i xen-upstream-4.2.0.deb $ sudo su -c <span class="hljs-string"><span class="hljs-string">"cd /boot; rm xen.gz xen-4.gz xen-4.2.gz xen-syms-4.2.0"</span></span> $ sudo apt-get install libyajl2 liblzo2-2 libaio1</code> </pre><br>  Making Xen bootable by default. <br><pre> <code class="bash hljs">$ sudo dpkg-divert --divert /etc/grub.d/08_linux_xen --rename /etc/grub.d/20_linux_xen</code> </pre><br>  We register Xen services in the system. <br><pre> <code class="bash hljs">$ sudo update-rc.d xend start 99 2 3 5 stop 99 0 1 6 $ sudo update-rc.d xencommons start 99 2 3 5 stop 99 0 1 6 $ sudo update-rc.d xendomains start 99 2 3 5 stop 99 0 1 6 $ sudo update-rc.d xen-watchdog start 99 2 3 5 stop 99 0 1 6</code> </pre><br>  To hide the devices necessary for forwarding from dom0, the <nobr>xen-pciback driver</nobr> needs to submit a list of them.  To disable Memory Ballooning, you must pre-specify the amount of memory required for dom0.  To do this, you need to add 2 lines to <nobr>/ etc / default / grub</nobr> . <br><br><pre> GRUB_CMDLINE_LINUX_XEN_REPLACE_DEFAULT = "xen-pciback.hide = (02: 00.0) (02: 00.1) &lt;br&gt; (00: 1a.0) (00: 1d.0) (09: 00.0) (0a: 00.0) (0b: 00.0 ) (03: 00.0) (00: 1b.0) "
 GRUB_CMDLINE_XEN_DEFAULT = "dom0_mem = 15360M"
</pre><br>  In addition to the video card, 4 USB controllers, network and sound cards, and a number of peripherals were thrown. <br><br>  After that, you need to update the GRUB bootloader configuration file. <br><br><pre> <code class="bash hljs">$ sudo update-grub</code> </pre><br>  Since the ASUS P9X79 WS motherboard has two network interfaces, it was decided not to make any network bridges.  dom0 and domU will have independent network connections. <br><br>  The following sequence of commands sets the minimum amount of memory for dom0 (thereby finally turning off Memory Ballooning) and turns off unnecessary network scripts.  I also made VNC available at any IP address. <br><br><pre> <code class="bash hljs">$ sudo sed -i <span class="hljs-string"><span class="hljs-string">'s/^XENDOMAINS_SAVE=.*$/XENDOMAINS_SAVE=""/g'</span></span> /etc/default/xendomains $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/xen $ sudo sed -i <span class="hljs-string"><span class="hljs-string">'s/^.*.(dom0-min-mem.*)$/(dom0-min-mem 15360)/g'</span></span> xend-config.sxp $ sudo sed -i <span class="hljs-string"><span class="hljs-string">'s/^.*.(enable-dom0-ballooning.*)$/(enable-dom0-ballooning no)/g'</span></span> xend-config.sxp $ sudo sed -i <span class="hljs-string"><span class="hljs-string">'s/^(network-script.*)$/#&amp;/g'</span></span> xend-config.sxp $ sudo sed -i <span class="hljs-string"><span class="hljs-string">'s/^(vif-script.*)$/#&amp;/g'</span></span> xend-config.sxp $ sudo sed -i <span class="hljs-string"><span class="hljs-string">"s/^.*.(vnc-listen.*)$/(vnc-listen '0.0.0.0')/g"</span></span> xend-config.sxp</code> </pre><br><h2>  Install Windows </h2><br>  I will not dwell on the issue of installing Windows on a VM environment.  Let me just say that the installation must be performed remotely using VNC.  NVIDIA Quadro starts working only after installing the drivers.  It starts only when the OS is fully loaded.  Also, paravirtual drivers were successfully installed [ <a href="https://habr.com/ru/post/161747/">10</a> ]. <br><br><img src="https://habrastorage.org/storage2/8df/ae7/7bb/8dfae77bb5b59910d2893aa3d24910ae.png"><br><br>  Among the network devices is the VirtualBox Host-Only Ethernet Adapter.  The fact is that I installed VirtualBox in the VM environment (inside the domU).  Inside was installed Windows XP.  Even with double nesting inside the VM OS, Windows XP worked with acceptable speed. <br><br><div class="spoiler">  <b class="spoiler_title">Domain configuration file</b> <div class="spoiler_text"><pre> builder = "hvm"
 memory = 16384
 vcpus = 8
 name = "windows-7"
 uuid = "830460b8-3541-11e2-8560-5404a63ce590"
 disk = ['phy: / dev / storage / windows-7, hda, w']
 boot = 'c'

 pci = ['02: 00.0 ',' 02: 00.1 ',' 00: 1a.0 ',' 00: 1d.0 ', &lt;br&gt; '09: 00.0', '0a: 00.0', '0b: 00.0 ', '03: 00.0', '00: 1b.0']
 gfx_passthru = 0

 pae = 1
 nx = 1
 videoram = 16
 stdvga = 1
 vnc = 1
 usb = 1
 usbdevice = "tablet"
 localtime = 1
 xen_platform_pci = 1
</pre></div></div><br><h2>  Test results </h2><br>  I‚Äôll just say that I didn‚Äôt even try to install Windows on bare hardware, so I don‚Äôt have anything to compare objectively with.  The entire assessment was reduced to viewing the Windows Experience Index (WEI) and installing 3DMark 2011. That is, to be honest, I didn‚Äôt carry out any performance testing. <br><br><img src="https://habrastorage.org/storage2/e10/cb9/8f3/e10cb98f3e202529afe2efe204ad948e.png"><br><br>  The WEI is determined by the test result with the worst result.  In my case, the bottleneck was ‚Äúhard disk‚Äù.  The fact is that all the experiments I conducted using a single old hard drive.  Otherwise, the results are not very bad. <br><br><img src="https://habrastorage.org/storage2/2a6/d92/d77/2a6d92d77a5ac9c87e67ec67d63de3ab.png"><br><br>  The NVIDIA Quadro 4000 video card is not gaming, but Crysis worked smartly. <br><br><h2>  Comments on Xen </h2><br>  Since version <nobr>4.1</nobr> , the xl toolkit has come to Xen.  It does not need xend and in the future it should replace xm. <br><br>  When working in manual xl did not cause any complaints.  However, the xendomains script is clearly not designed to work with it.  When you run <nobr>/etc/init.d/xendomains start</nobr> , domU domains started up without problems.  However, when calling <nobr>/etc/init.d/xendomains stop</nobr> did not occur, absolutely nothing.  The domU operation did not automatically terminate as a result of which the entire system was hanging.  During a small investigation, it turned out that some of the functions inside xendomains are simply not adapted to work with xl.  In principle, I was ready to cope with these problems. <br><br>  The worst thing was that when you run domU xl it gave an error saying that it could not reset the PCI device, namely the video card, via sysfs.  For a video card, the reset file in sysfs is simply missing.  I'm not completely sure, but it seems to me that it was because of this that after reloading the domU video card, it often refused to start.  Only restarting the entire system helped. <br><br><pre> libxl: error: libxl_pci.c: 1001: libxl__device_pci_reset: &lt;br&gt; The kernel doesn't support reset from sysfs for PCI device 0000: 02: 00.0
 libxl: error: libxl_pci.c: 1001: libxl__device_pci_reset: &lt;br&gt; The kernel doesn't support reset from sysfs for PCI device 0000: 02: 00.1
</pre><br>  In xm, resetting PCI devices seems to be implemented differently.  At least, when working with it, there were no problems with the video card.  That is why I stopped at xm. <br><br><h2>  Conclusion </h2><br>  It took me 5 days to implement everything described.  In general, the system worked very stably.  No BSODs and freezes were observed.  I hope that in the near future, without exception, all video cards will be suitable for forwarding to a VM, since NVIDIA Quadro cannot be called a budget option. <br><br><h2>  List of used sources </h2><br><ol><li><a name="cite-1"></a>  <a href="http://habrahabr.ru/post/137327">Forwarding a video card to a virtual machine</a> </li><li><a name="cite-2"></a>  <a href="http://habrahabr.ru/post/151661">Forwarding a video card to a guest OS from the Xen hypervisor</a> </li><li><a name="cite-3"></a>  <a href="http://habrahabr.ru/post/149416">Forwarding a video card in Xen, from under Ubuntu</a> </li><li><a name="cite-4"></a>  <a href="http://wiki.xen.org/wiki/Xen_VGA_Passthrough">Xen VGA Passthrough</a> </li><li><a name="cite-5"></a>  <a href="http://www.linux-kvm.org/page/VGA_device_assignment">VGA device assignment - KVM</a> </li><li><a name="cite-6"></a>  <a href="http://www.nvidia.com/object/sli_multi_os.html">NVIDIA Multi-OS</a> </li><li><a name="cite-7"></a>  <a href="http://developer.download.nvidia.com/GTC/SIGGRAPH_Asia_2011/PDF/Wade.pdf">Graphics and Virtualization - NVIDIA</a> </li><li><a name="cite-8"></a>  <a href="http://wiki.xen.org/wiki/Compiling_Xen_From_Source">Compiling Xen From Source</a> </li><li><a name="cite-9"></a>  <a href="">Compiling a New Kernel</a> </li><li><a name="cite-10"></a>  <a href="http://wiki.xen.org/wiki/XenWindowsGplPv/Installing">Xen Windows GplPv / Installing</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/161747/">https://habr.com/ru/post/161747/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161735/index.html">MAD'Day - the day of mobile application development</a></li>
<li><a href="../161737/index.html">Announcement of broadcast Video Game Awards 2012 on Gamersweb.ru</a></li>
<li><a href="../161739/index.html">Anonymous Santa Claus: post boasting Christmas gifts</a></li>
<li><a href="../161741/index.html">AWS: How to create a login to your account for multiple users using IAM</a></li>
<li><a href="../161743/index.html">Meeting FProg 2012-12 in St. Petersburg</a></li>
<li><a href="../161755/index.html">Create a complex maze in the background of the web page (on the client)</a></li>
<li><a href="../161757/index.html">What is appropriate to pay attention to in the report "2012 Internet Trends (Update)", leafing through it in its entirety</a></li>
<li><a href="../161761/index.html">Price reduction for Windows Azure Storage</a></li>
<li><a href="../161763/index.html">Custom buttons in the Yandex.Maps API 2.0</a></li>
<li><a href="../161767/index.html">Introduction to Vector Displays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>