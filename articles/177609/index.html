<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with FTP and uploading data to xlsx (Cach√© Object Script)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention an article on the following topics: 


1. Work with FTP server using% Net.FtpSession 
2. An easy way to upload data to xls f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with FTP and uploading data to xlsx (Cach√© Object Script)</h1><div class="post__text post__text-html js-mediator-article">  I bring to your attention an article on the following topics: <br><ol><li>  Work with FTP server using% Net.FtpSession </li><li>  An easy way to upload data to xls format </li><li>  Some useful tips </li></ol><br><a name="habracut"></a><br><h4>  Work with FTP server. </h4><br>  Web services?  No, not heard. <br>  The third day of our company had a chance to organize stream synchronization of data with the production complex ‚ÄúHe‚Äù.  The IT department of the customer insisted on using an FTP server, other methods of exchange were violently rejected. <br><br>  We will need: <br><pre><code class="html hljs xml">s ftp = ##class(%Net.FtpSession).%New() ‚Äì     FTP ftp.Timeout =    ‚Äì   ftp.Connect(, , , ) ‚Äì   FTP ftp.SetDirectory() ‚Äì     FTP ( ) ftp.List( ,     ) ‚Äì   ,  ,     ftp.Binary() ‚Äì     ftp.Retrieve(, .GlobalStream) ‚Äì     ftp.Delete() ‚Äì   ftp.Append(, ) -         ftp.Logout() ‚Äì  FTP </code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">An example of importing files from an FTP server (files are selected by mask).</b> <div class="spoiler_text"><pre> <code class="html hljs xml">ClassMethod FTPGetFiles(ftp, fileName) As %Status { s ftp = ##class(%Net.FtpSession).%New() s ftp.Timeout = 2000 s host = "11.111.11.111" s port = 2021 s user = "myth/user" s pass = "userspass" if ftp.Connect(host, user, pass, port) { d ftp.SetDirectory("/TestDir") //   s fileName = "????????t??????vK*.xml" //         d ..ParserDir(ftp, fileName) s fileName = "????????a??????yK*.xml" d ..ParserDir(ftp, fileName) } q ftp.Logout() } ///    ,   ClassMethod ParserDir(ftp, fileName) As %Status { s file = "" sx = 1 s file(x) = "" //       d ftp.List(fileName, .stream) q:'$IsObject(stream) while 'stream.AtEnd { //       s file = stream.ReadLine(1, .sc, .eol) if ( file = $C(10) ) { //     sx = x + 1 s file(x) = "" } else { //    s file(x) = file(x) _ file } if $$$ISERR(sc) { w "ERROR" q } } //     d ftp.Binary() //     s key = $ORDER(file(""),1) while ( key '= "" ) { //   s fName = $E(file(key), 40, *) if ( $L(fName) &gt; 0 ) { #dim GlobalStream As %GlobalBinaryStream; //         fName.    -   FTP    CP1251    d ftp.Retrieve($zcvt($zcvt(fName,"I","CP1251"),"O","CP1251"),.GlobalStream) #dim status As %String; //       if ( $F(fName,"s") &gt; 0 ) { s status = ..Parser(GlobalStream, "Product", "Shipment", parser) } elseif ( $F(fName,"d") &gt; 0 ) { s status = ..Parser(GlobalStream, "Product", "Disposal" ,parser) } if ( status ) { d ftp.Delete(fName) } } s key = $order(file(key),1) } q ftp.Logout() }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Example of exporting files to an FTP server</b> <div class="spoiler_text"><pre> <code class="html hljs xml">///    FTP  ClassMethod RunExport() As %Status { s ftp = ##class(%Net.FtpSession).%New() s ftp.Timeout = 2000 s host = "11.111.11.111" s port = 2021 s user = "myth/user" s pass = "userspass" if ftp.Connect(host, user, pass, port) { d ftp.Binary() //          s st = ##class(%SQL.Statement).%New() d st.%PrepareClassQuery("%File","FileSet") s rs = st.%Execute("/usr/cachesys201221/csp/sm/export_xml","*.xml","Size,Name") while rs.%Next() { //    ,     d ftp.Delete(rs.%GetData(6)) //     s stream = ##class(%FileBinaryStream).%New() // 1 -         s stream.Filename = rs.%GetData(1) //       -     "done" if ( ftp.Append(rs.%GetData(6),stream) = $$$OK ) { d ##class(%File).Rename(rs.%GetData(1), ##class(%File).GetDirectory(rs.%GetData(1)) _ "done/" _ rs.%GetData(6)) } k stream } } d ftp.Logout() k ftp q $$$OK }</code> </pre><br></div></div><br><h4>  Uploading data to xlsx format. </h4><br>  Nothing is as good as the grief of a neighbor. <br>  I remember well how in the morning, when I came to the office, a colleague smiled at me and, not without a share of gloating, reported on the release of a new version of Mozilla Firefox.  And all because the task of exporting data to excel in our software products was resolved using a browser plugin that used a library written in visual-C.  After changing the security policy of FireFox applications, I had to at every change of version, at best, download a new SDK and rebuild a DLL (and the plugin as a whole), at worst - rewrite the ssh code for the DLL and the JS parser page).  I don‚Äôt want to recall the need to update the plugin with users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, the third day and on our street, a truck with cookies turned over in the form of a simple way to export to Excel, which I want to share with you: <br><ul><li>  We take (form) html table with data </li><li>  Save the table in a text file, change the extension to xls </li><li>  Open the file, do not forget to click ‚Äúyes‚Äù on the warning plate and ... voila!  Excel perfectly recognized our table.  If necessary, cells can transmit css styles and specify the data format. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="html hljs xml">#server(TestProject.MakeExcelFile($("#table_to_excel").html(), "PriceList"))# ClassMethod MakeExcelFile(Data As %String, FileName As %String) As %Status { s FileName = "/tkf/reports/" _ FileName _ "_Excel.xls" s stream = ##class(%Library.FileCharacterStream).%New() s FP = $$GetFilename^%apiCSP(FileName) if ( $L(Data) = 22 ) { d stream.CopyFrom(Data) } else { d stream.Write(Data) } d stream.SetAttribute("Content-Length",stream.Size) d stream.SetAttribute("ContentType","application/excel") d stream.SetAttribute("Charset","UTF8") d stream.SetAttribute("ContentDisposition","attachment; filename=" _ $p(FileName,"/",4)) d stream.LinkToFile(FP) d stream.SaveStream() s oid = stream.%Oid() &amp;js<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">window.location="#url(%25CSP.StreamServer.cls?STREAMOID=#(..Encrypt(oid))#)#";</span></span></span><span class="hljs-tag">&gt;</span></span> q $$$OK }</code> </pre><br></div></div><br>  The cell, for example, can be set to the font size - <code> </code> , or you can specify the number format type: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.toText</span></span></span><span class="css">{ </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">mso-number-format</span></span></span><span class="css">:\</span><span class="hljs-string"><span class="css"><span class="hljs-string">"\@\"; } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚ÄùtoText‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h4>  Useful tips </h4><br><h6>  Abbreviations </h6><br>  Surely not everyone knows that in COS there are abbreviated versions of operators, like these: <br><br>  Set = s <br>  Do = d <br>  Write = w <br>  Kill = k <br>  Quit = q <br>  ... <br><br>  Abbreviations in most cases are reflected in the documentation like this: <br><img src="https://habrastorage.org/storage2/f37/424/c36/f37424c36881ba1c38ffad72441f7d1e.png"><br><h6>  Typing </h6><br>  COS is a language without strict typing, but sometimes it is useful or even necessary to carry out typing beforehand, for this the #dim construction was created <br><br>  Example: <br><img src="https://habrastorage.org/storage2/9cb/1ba/8ad/9cb1ba8ad433ed5acea298a647ac54b2.png"><br><img src="https://habrastorage.org/storage2/357/b91/168/357b91168d9cac3f9b00571e3e507c2f.png"><br><br><h6>  $ CLASSNAME to SQL </h6><br>  A rare but very real case - when building a query, you must output the name of the class (Analog to $ CLASSNAME in SQL), for this purpose you can use a hidden field that is common to all classes - x__classname. <br><br>  Example: <br>  There are 2 classes A and B, which are inherited from a common ancestor of Letters Extends% Persistent.  We include in the selection the x__classname field. <br><img src="https://habrastorage.org/storage2/353/115/2e0/3531152e0254b6e29a5042ee510f0312.png"><br><br>  Version Cache - Cache for UNIX (Red Hat Enterprise Linux for x86-64) 2012.2.1 (Build 705U) Wed Oct 24 2012 14:32:01 EDT. </div><p>Source: <a href="https://habr.com/ru/post/177609/">https://habr.com/ru/post/177609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177595/index.html">DIY: dumbbells as a way to store DVDs</a></li>
<li><a href="../177597/index.html">Take part in the contest "Northern Lights"</a></li>
<li><a href="../177603/index.html">Leap Motion support appeared in Google Earth</a></li>
<li><a href="../177605/index.html">The crib on the graphic design of Android applications</a></li>
<li><a href="../177607/index.html">Advanced file navigation</a></li>
<li><a href="../177611/index.html">Connecting the LCD panel from iPad to personal computer</a></li>
<li><a href="../177615/index.html">Information system based on Semantic MediaWiki</a></li>
<li><a href="../177617/index.html">How we made a movie for Shadow Fight 2</a></li>
<li><a href="../177619/index.html">How to get into the "golden billion" or sobering statistics</a></li>
<li><a href="../177621/index.html">Are we all ready to go to electric cars (Fermi problem)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>