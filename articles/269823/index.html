<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostrgreSQL: Accelerated through intarray</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So 6 years ago, when the elephant was only at 8.0, and I sat tight on MySql, I often heard calls to change the DB. I remember how painful it was to st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostrgreSQL: Accelerated through intarray</h1><div class="post__text post__text-html js-mediator-article">  So 6 years ago, when the elephant was only at 8.0, and I sat tight on MySql, I often heard calls to change the DB.  I remember how painful it was to start.  But after I made up my mind, I never regretted it, and I‚Äôm hardly likely to return.  There are a lot of advantages here, but the post is not about that. <br><br>  The task came: to write a store, a big one in perspective.  A la Photos, Hotline.  Well, the standard task for such sites is a filter. <br><a name="habracut"></a><br>  How is this done in the usual "engines"?  True: parameters = filters.  Well, everything is clear that it is simple, but not always beautiful, especially when you need filters with ranges (for example: a diagonal of 10 "-11").  And then you have to think about the fact that filters are an entity independent of the parameters.  In my version, the filters "fit" to the parameters.  I do not know how it was done on the same hotline (there is a suspicion that there filters fit directly on the goods), but this option requires a lot of human attention.  I will not go into the details of architecture, this is a topic for another post.  But we will consider just the simplified version, so as not to get lost. <br><br>  The problem with such filters is their construction.  Calculate the number of products for the selected (or not selected yet) filters. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So‚Ä¶ <br><br>  Create a table for products: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.products ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span>, title <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> products_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre> <br>  Filter table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.filters ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span>, title <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> filters_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre><br>  Table for links between filters and products: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.products_ref_filters ( id_product <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, id_filter <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> products_ref_filters_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(id_product, id_filter), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> products_ref_filters_fk <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (id_product) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> public.products(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> products_ref_filters_fk1 <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (id_filter) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> public.filters(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> );</code> </pre><br>  And it turns out the standard version.  Trivially. <br><br>  Farther‚Ä¶ <br><br>  Add the filters field to the product table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.products <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> filters <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>[] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[]::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre><br>  As you have noticed, this is an array of numbers, the IDs of the filters will be duplicated here, yes, this is denormalization.  For integrity, we write procedures and hang them on the trigger.  Insert: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.products_ref_filters__insert_tr () <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span><span class="hljs-string"><span class="hljs-string">' BEGIN UPDATE products SET filters = filters + NEW.id_filter --push element onto array WHERE id = NEW.id_product; RETURN NEW; END; '</span></span><span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plpgsql'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> products_ref_filters__insert_tr <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products_ref_filters <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> public.products_ref_filters__insert_tr();</code> </pre><br>  Uninstall: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.products_ref_filters__delete_tr () <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span><span class="hljs-string"><span class="hljs-string">' BEGIN UPDATE products SET filters = filters - OLD.id_filter --remove entries matching right argument from array WHERE id = OLD.id_product; RETURN OLD; END; '</span></span><span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plpgsql'</span></span>;</code> </pre><br>  Update: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.products_ref_filters__update_tr () <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span><span class="hljs-string"><span class="hljs-string">' BEGIN UPDATE products SET filters = filters - OLD.id_filter WHERE id = OLD.id_product; UPDATE products SET filters = filters + NEW.id_filter WHERE id = NEW.id_product; RETURN NEW; END; '</span></span><span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plpgsql'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> products_ref_filters__update_tr <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products_ref_filters <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> public.products_ref_filters__update_tr();</code> </pre><br>  Cleaning: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.products_ref_filters__truncate_tr () <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span><span class="hljs-string"><span class="hljs-string">' BEGIN UPDATE products SET filters = ARRAY[]::INTEGER[]; RETURN NULL; END; '</span></span><span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plpgsql'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> products_ref_filters__truncate_tr <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRUNCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products_ref_filters <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATEMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> public.products_ref_filters__truncate_tr();</code> </pre><br>  Now, when inserting, updating, deleting data from the link table, an array of filters will be written into the product table.  And we got rid of JOIN.  Now no need to glue the table in the query.  This gives a lot of advantages, it is easier to build queries, they are faster, less memory, etc.  But the article is about intarray?  Yes. <br><br>  Install the extension: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION intarray;</code> </pre><br>  After executing this command, functions, indexes, operators for working with INTEGER arrays will appear in the database.  Now it will be much faster and more convenient to work. <br><br>  Fill our database.  Filters 10 000. Goods 100 000. For each product 10 filters.  Total: intermediate table of 1 000 000 lines.  This block of requests took 8 min.  So wait. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> filters (title) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'filter_'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> products (title) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'product_'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> idp <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> idp <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> products_ref_filters <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> idp, f.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> filters f <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> random() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$$;</code> </pre><br>  Create an index on an array of numbers: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> products_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin (filters public.gin__int_ops);</code> </pre><br>  Total, our database is full.  Let's see what to do with it now.  Let's find the most popular filters and remember them. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id_filter <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products_ref_filters <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> id_filter <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br>  My result is: 7267, 4889, 6364, 5376, 3556, 7292, 11188, 2643, 9005, 10235. <br><br>  Let's find products with a specific filter, let it be 7267: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  JOIN SELECT t1.* FROM products t1, products_ref_filters t2 WHERE t1.id = t2.id_product AND t2.id_filter = 7267 -- 140 rows returned (execution time: 125 ms; total time: 141 ms) -- SUB SELECT SELECT * FROM products WHERE id IN ( SELECT id_product FROM products_ref_filters WHERE id_filter = 7267 ) -- 140 rows returned (execution time: 125 ms; total time: 141 ms) --    SELECT * FROM products WHERE filters @&gt; ARRAY[7267] -- 140 rows returned (execution time: 0 ms; total time: 0 ms)</span></span></code> </pre><br>  One of the filters <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- JOIN SELECT DISTINCT t1.* FROM products t1, products_ref_filters t2 WHERE t1.id = t2.id_product AND t2.id_filter IN (7267,4889,6364,5376,3556,7292,11188,2643,9005,10235) -- 1347 rows returned (execution time: 297 ms; total time: 297 ms) -- SUB SELECT SELECT * FROM products WHERE id IN ( SELECT id_product FROM products_ref_filters WHERE id_filter IN (7267,4889,6364,5376,3556,7292,11188,2643,9005,10235) ) -- 1347 rows returned (execution time: 234 ms; total time: 250 ms) -- INTARRAY SELECT * FROM products WHERE filters &amp;&amp; ARRAY[7267,4889,6364,5376,3556,7292,11188,2643,9005,10235] -- 1347 rows returned (execution time: 16 ms; total time: 16 ms)</span></span></code> </pre><br>  Too lazy to make other requests, forgive.  But when you need to find products with several filters, then in general, this approach leaves joins and subselections far behind. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- JOIN -- ,       ;) --     SELECT * FROM products WHERE filters @&gt; ARRAY[9844,9957]; -- 1 rows returned (execution time: 0 ms; total time: 16 ms)</span></span></code> </pre><br>  Of  dock <a href="http://www.postgresql.org/docs/9.1/static/intarray.html">here</a> . <br><br>  Pay attention to the operators, it's just a fairy tale!  I read somewhere that even there is a patch, by installing which, you can build foreign keys on an array, and the base itself will monitor integrity.  I also read somewhere that developers even plan to do this without any patches.  Yes, great.  At one time, when I found (for myself) this solution, there was joy ... <br><br>  Seeing that there is a small interest in the topic. <br>  I decided to add a little bit of volume tests. <br>  Let's try on 10 million items. <br>  Let's slightly change the request for filling pseudo-products. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     1000 INSERT INTO filters (title) SELECT 'filter_' || num FROM generate_series(1, 10000) as num; -- 10 000 000 INSERT INTO products (title) SELECT 'product_' || num FROM generate_series(1, 10000000) as num; -- ..      ,   ID- DO $$ DECLARE idp INTEGER; BEGIN FOR idp IN SELECT id FROM products LOOP UPDATE products SET filters = (SELECT array_agg(id) FROM (SELECT id FROM filters OFFSET random()*1000 LIMIT 10) as foo) WHERE id = idp; END LOOP; END$$; --    ~20</span></span></code> </pre><br><br>  DB size ~ 2.9GB <br><br>  BTREE Index: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> products_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> btree (filters); <span class="hljs-comment"><span class="hljs-comment">-- execution time: 00:02:36 -- DB size ~ 3.8Gb SELECT * FROM products WHERE filters @&gt; '{842}'::INTEGER[]; -- Seq Scan on public.products (cost=0.00..357908.00 rows=10000 width=80) ... -- 99798 rows returned (execution time: 5,594 sec; total time: 5,594 sec) SELECT * FROM products WHERE filters = '{842,843,844,845,846,847,848,849,850,851}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=487.94..32940.13 rows=9726 width=80) -- 9940 rows returned (execution time: 46 ms; total time: 62 ms) SELECT * FROM products WHERE filters &amp;&amp; '{842,843,844,845,846,847,848,849,850,851}'::INTEGER[] -- Seq Scan on public.products (cost=0.00..357908.00 rows=10000 width=80) -- 189853 rows returned (execution time: 6,281 sec; total time: 6,296 sec)</span></span></code> </pre><br><br>  GIST Index: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> products_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gist (filters public.gist__int_ops); <span class="hljs-comment"><span class="hljs-comment">-- execution time: 00:26:55; -- DB size ~ 4.5Gb SELECT * FROM products WHERE filters @&gt; '{842}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=833.92..34097.44 rows=10000 width=80) -- 99798 rows returned (execution time: 2,234 sec; total time: 2,234 sec) SELECT * FROM products WHERE filters = '{842,843,844,845,846,847,848,849,850,851}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=811.79..33263.99 rows=9726 width=80) -- 9940 rows returned (execution time: 234 ms; total time: 234 ms) SELECT * FROM products WHERE filters &amp;&amp; '{842,843,844,845,846,847,848,849,850,851}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=833.92..34097.44 rows=10000 width=80) -- 189853 rows returned (execution time: 5,234 sec; total time: 5,234 sec)</span></span></code> </pre><br><br>  GIN Index: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> products_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.products <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin (filters public.gin__int_ops); <span class="hljs-comment"><span class="hljs-comment">-- execution time: 56,344 sec; SELECT * FROM products WHERE filters @&gt; '{842}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=97.50..33361.02 rows=10000 width=80) -- 99798 rows returned (execution time: 2,204 sec; total time: 2,219 sec) SELECT * FROM products WHERE filters = '{842,843,844,845,846,847,848,849,850,851}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=211.37..32663.57 rows=9726 width=80) -- 9940 rows returned (execution time: 297 ms; total time: 312 ms) SELECT * FROM products WHERE filters &amp;&amp; '{842,843,844,845,846,847,848,849,850,851}'::INTEGER[]; -- Bitmap Heap Scan on public.products (cost=213.50..33477.02 rows=10000 width=80) -- 189853 rows returned (execution time: 4,500 sec; total time: 4,515 sec)</span></span></code> </pre><br><br>  Yes, for mega big bases, it won't save much.  But given that such a search in practice does not happen, and there is always an additional filter, for example, by category, the method is still good.  In any case, this is 100 times faster JOIN. </div><p>Source: <a href="https://habr.com/ru/post/269823/">https://habr.com/ru/post/269823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269809/index.html">Rust 1.4 Released</a></li>
<li><a href="../269811/index.html">10 largest mathematical achievements of recent years</a></li>
<li><a href="../269817/index.html">Why Go is a well-thought programming language.</a></li>
<li><a href="../269819/index.html">Creating a channel with auto posting in Telegram without a single line of code</a></li>
<li><a href="../269821/index.html">Assembler Intel-4004 - for fun</a></li>
<li><a href="../269825/index.html">Perspective video formats. New direction</a></li>
<li><a href="../269827/index.html">AngularJS optimization: working examples</a></li>
<li><a href="../269829/index.html">10 relatively honest ways to hack mail</a></li>
<li><a href="../269831/index.html">From 0 to 1. We understand with Redux</a></li>
<li><a href="../269833/index.html">Google is going to combine Chrome OS and Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>