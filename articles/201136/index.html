<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a bot for a flash game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What for? 
 I was thinking about laser vision correction for a long time, and then, finally, I decided on a procedure. After a brief study of the mark...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a bot for a flash game</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/101/c65/60e/101c6560e22b2cbe5867f80e4c12e102.jpg"><br><h1>  What for? </h1><br>  I was thinking about laser vision correction for a long time, and then, finally, I decided on a procedure.  After a brief study of the market (I live in St. Petersburg), it turned out that prices around the city are about the same everywhere, and there is also no sense in medical tourism (in Moscow, it is not much cheaper).  However, it turned out that the operation can be significantly saved, because  one of the clinics provides an extensive system of discounts on its services. <br><br>  Discounts for veterans and pensioners, of course, did not interest me.  But I decided to use the unusual <a href="http://medi.spb.ru/medi/spetspredlozheniya/aktsii/lasik-mania">action</a> ‚Äúplay a flash game on our website and convert points scored into a discount‚Äù.  Sub-description of the process. <br><br>  In general, the idea at first was astonished by its absurdity - it seems that computer games are harmful to eyesight, and then the action is similar to "scoop out 10,000 buckets of ice-cold water from the basement and get a discount on rheumatism treatment."  The game itself, I must say, was also struck by its stubbornness - it is obvious that the authors wanted to make the game without violence, so the legend says: ‚Äúwith the help of LASIK technology, help restore the sight of the moles‚Äù.  And, judging by the animation, the treatment of myopia is performed by instantaneous evaporation of the patient. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, okay, this is the lyrics.  In fact, I immediately tried to knock out a discount, however, my entire gaming experience did not help me get even 17% from the first time.  Having played several times, I still scored the required 17,000 points, but it was clear that even 20,000 were an unattainable bar, not to mention the cherished 25,000. Damned moles climb from all cracks, but quickly hide back.  In this case, for the "healing" of the mole is given 100-200 points, so you can not miss them.  I do not know whether it is a man. <br><br>  The decision came to mind immediately - you need to write a bot that will play for me!  The process of writing a bot on C # rolled up. <br><a name="habracut"></a><br><h1>  How? </h1><br><h5>  Concept </h5><br>  Two forces started fighting in me, about the battles of which many posts have already been written.  On the one hand, I wanted to write a beautiful and well-designed application.  On the other hand, the thought ‚Äúthe code should work, it should not do anything‚Äù pulsed in my head.  In general, for the experiment, I decided to fully adhere to the second concept.  Well, let's go. <br><img src="https://habrastorage.org/getpro/habr/post_images/eb6/26a/f64/eb626af642348caecbc9e89f520dbab2.png"><br><h5>  Eyes </h5><br>  First, take OpenCV to capture frames from the screen and recognize objects ... STOP.  I don't need some kind of super app, I just need to get this discount.  Should I tinker with OpenCV?  Maybe it is easier to start a stream that will take a screenshot of the screen in an infinite loop and view it?  For example: <br><br><pre><code class="hljs cs">Bitmap bmpScreen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height); Graphics g = Graphics.FromImage(bmpScreen); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { g.CopyFromScreen(Screen.AllScreens[<span class="hljs-number"><span class="hljs-number">0</span></span>].Bounds.X, Screen.AllScreens[<span class="hljs-number"><span class="hljs-number">0</span></span>].Bounds.Y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, bmpScreen.Size, CopyPixelOperation.SourceCopy); }</code> </pre> <br><h5>  Arms </h5><br>  And how to "treat" moles?  Obviously, at startup you need to find the browser window and send it a WM_CLICK message with the necessary parameters.  However, you can make everything easier - physically move the cursor to the desired location on the screen and emulate keystrokes. <br><br>  Import the appropriate WinAPI functions. <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user32.dll"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCursorPos</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Point lpPoint</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCursorPos</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Y</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouse_event</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwFlags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dy, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwData, IntPtr dwExtraInfo</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><br>  And write the function to click <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MouseClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Point ptCoords = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(); GetCursorPos(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> ptCoords); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> x = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)ptCoords.X; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> y = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)ptCoords.Y; System.IntPtr ptr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr(); mouse_event(MOUSEEVENTF_LEFTDOWN, x, y, <span class="hljs-number"><span class="hljs-number">0</span></span>, ptr); mouse_event(MOUSEEVENTF_LEFTUP, x, y, <span class="hljs-number"><span class="hljs-number">0</span></span>, ptr); }</code> </pre><br><br>  Now that all the service functions are there, it remains to write the logic. <br><br><h5>  Brain </h5><br>  Having passed the first round several times manually, I made several observations: <br><ol><li>  Moles appear in the same places. </li><li>  Additional targets (robot and UFO) scare away moles, so they should be ‚Äútreated‚Äù first.  Moreover, they appear in strictly defined places. </li><li>  500 points are given for the Copper rocket, and it hangs in one place. </li></ol><br><br>  In general, since our goals appear in the same places, the first thing that comes to mind is to make a reference screenshot of the screen, and then just check if the color of the specified pixels has changed. <br><br>  How to store the coordinates of the goals?  Generally it is not so simple.  You need to consider the screen resolution, page scroll level, and so on.  Those.  Not only can the game window have a different size, it can also be in different places on the screen.  Fortunately, I did not write a universal game for the game, I just needed to score 25,000 points.  Therefore, I decided to open the game in a browser deployed to the full screen, scroll to the very top of the page and record the coordinates of the targets as the physical coordinates of the pixels on the screen. <br><br>  And how to record the coordinates?  The most convenient way for the user is to make a hot key, by pressing which the coordinates of the cursor are saved, for example, to a file.  Then, when the mole appears, you need to hover the cursor on it and press the hotkey.  Frankly, at first I did.  Later it turned out that it was much easier to make screenshots of moles, measure the position of each mole in the graphic editor, and these coordinates are simply hard-coded.  It turned out something like this <br><br><pre> <code class="hljs pgsql">List&lt;<span class="hljs-type"><span class="hljs-type">Point</span></span>&gt; m_lpTargets = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;<span class="hljs-type"><span class="hljs-type">Point</span></span>&gt;(); m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">557</span></span>, <span class="hljs-number"><span class="hljs-number">623</span></span>)); //  m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">261</span></span>, <span class="hljs-number"><span class="hljs-number">654</span></span>)); //  m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">352</span></span>, <span class="hljs-number"><span class="hljs-number">486</span></span>)); //   m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">450</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>)); // m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">592</span></span>, <span class="hljs-number"><span class="hljs-number">698</span></span>)); //  m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">756</span></span>, <span class="hljs-number"><span class="hljs-number">631</span></span>)); //  m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">373</span></span>, <span class="hljs-number"><span class="hljs-number">514</span></span>)); // m_lpTargets.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">481</span></span>, <span class="hljs-number"><span class="hljs-number">440</span></span>)); //  </code> </pre><br><br>  Add an Aim button to the form that will make a reference screenshot. <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAim_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { m_bmpReference = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height); Graphics g = Graphics.FromImage(m_bmpReference); g.CopyFromScreen(Screen.AllScreens[<span class="hljs-number"><span class="hljs-number">0</span></span>].Bounds.X, Screen.AllScreens[<span class="hljs-number"><span class="hljs-number">0</span></span>].Bounds.Y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, m_bmpReference.Size, CopyPixelOperation.SourceCopy); }</code> </pre><br><br>  Now we add our bot code to the main loop and run it! <br><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-type"><span class="hljs-type">Point</span></span> pt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> m_lptTargets) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_bmpReference.GetPixel(pt.X, pt.Y) != bmpScreen.GetPixel(pt.X, pt.Y)) { MouseMoveTo(pt, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); MouseClick(); } }</code> </pre><br><h1>  What happened? </h1><br><h5>  First result </h5><br>  Well, it‚Äôs not that it doesn‚Äôt work at all ... First, in a hurry, as always, I forgot that when a program intercepts user input (especially in such a barbaric way), it becomes problematic to close it.  After the launch of the bot, the mouse cannot be brought out of the playing field - it will always jump at the specified points, even when the task manager is started.  I admit that I came out of this situation with the help of a reboot ... Actually, to be honest, I think that this is how robots will ever take over the world. <br><br><h5>  Main switch </h5><br>  It is probably worth making some wise algorithm that will determine that the game is over, and also release the mouse when, for example, the game window is minimized.  But, fortunately, I just need to find a way to stop the bot according to my desire, and this will help me to know the Windows hotkeys.  I simply add a form resizing handler in which I will stop the flow with the firing code. <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Form1_Resize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WindowState == FormWindowState.Minimized) { m_objAimingThread.Abort(); } }</code> </pre><br><br>  Now, to stop the bot, you just need to click Win + D. <br><br><h5>  First problems </h5><br>  But this is not even the most important thing.  The trouble is that, although our bot successfully heals the moles, something is wrong: when it hits a mole, glasses are knocked out of it, but the mole itself does not disappear, or a white silhouette remains after it.  It is clear that in this case, our bot continues to peel at this point to infinity (the color has changed). <br><br>  Frankly, I fought over this problem for quite a long time.  As a result, I came to the conclusion that the game somehow implemented crookedly drawing and accounting of moles.  Those.  if I hit the mole earlier than it had completely emerged from the hole, then I earn points for it, but at the same time it continues to crawl out.  And when the mole is marked as ‚Äúhealed‚Äù, then re-get points for it does not work.  It can be seen that several variables are responsible for the mole state, in which consistency is violated.  It is important that this problem arose only with moles, which crawl out of four holes ‚Äî there were no difficulties with jumping across the field and flying into space. <br><br>  I reasoned so - once in the manual mode, such a problem does not arise, then you just need to pause, and maybe even emulate mouse movement to the goal. <br><br>  After launching a modified program that brings the pointer to a mole in 250 milliseconds, the problem with non-disappearing moles is gone.  But another one came out immediately - the bouncing moles at the bottom of the screen move too fast so that they can manage to transfer the sight to it in 250ms.  After all, the moles from the holes appear at fixed points, and they sit there for some time, and the jumping moles jump over our ‚Äútarget points‚Äù very quickly. <br><br>  Finally, on closer examination, it turned out that the moles jumping into the atmosphere actually have different X-coordinates, so simply listing their positions would be too tedious.  It seems that we need to change the concept ... <br><br><h5>  New concept </h5><br>  So, moles appear in different places, so it is impossible to track them along the coordinates.  Do you have to do pattern recognition?  I would not want to.  I will try before this another "stupid" implementation.  What is common to all moles?  Suits and boots are not visible to everyone.  But all the moles visible head in the helmet.  In addition, the helmet has a very unusual color ... What if you scan the entire image for the presence of this bluish tint?  Let's try! <br><br><pre> <code class="hljs matlab">Color clHelmet = Color.FromArgb(<span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">142</span></span>, <span class="hljs-number"><span class="hljs-number">193</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> = <span class="hljs-number"><span class="hljs-number">400</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> &lt; <span class="hljs-number"><span class="hljs-number">880</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> += <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">850</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> += <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bmpScreen.GetPixel(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>) == clHelmet) { Point ptTarget = new Point(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>); MouseMoveTo(ptTarget); MouseClick(); } } }</code> </pre><br><br>  In the screenshot, I looked at the coordinates of the working area of ‚Äã‚Äãthe flash drive and the color of the helmet.  Now on my Core i5, I simply loop through all the pixels using the super-braking method GetPixel, and shoot when the color matches the reference one.  With this approach, the execution time of one cycle is about 200 milliseconds, which seems to be a valid value.  Run! <br><br><h5>  And new problems </h5><br><br>  Everything turned out to be not so simple - there is more than one dot of reference color on the helmet, so the bot, when a mole appears, starts to peel into white light like a pretty penny, ignoring other patients.  The solution was found quite simple - we will save the coordinates of the last shot, and when processing the current frame, ignore the pixels in the vicinity of these coordinates. <br><br>  The second problem of this approach is that the moles move, therefore, often during the frame processing time, the mole manages to escape from the healing beam of photons.  In addition, the color chosen by us is on the very edge of the helmet, so even with a slight delay we lose the patient. <br><br>  To begin, reduce the frame processing time.  In general, for this you need to copy the image to the area of ‚Äã‚Äãdirect memory access, and work with the bikes directly ... But we just change the step of scanning cycles to two, thereby increasing the scanning speed of the image four times.  Stronger increment is no longer painless - some pixel zones will be skipped. <br><br>  The second step to the guaranteed cure of moles - when it detects a point of the reference color, shoot not only at it, but immediately turn into the detected area.  Here is the code, enter and run. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">Point</span></span> ptLastHit = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> j = <span class="hljs-number"><span class="hljs-number">400</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">880</span></span>; j += <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">200</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">850</span></span>; i += <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bmpScreen.GetPixel(i, j) == clHelmet) { <span class="hljs-type"><span class="hljs-type">Point</span></span> ptTarget = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(i, j); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Distance(ptLastHit,ptTarget) &gt; <span class="hljs-number"><span class="hljs-number">70</span></span>) { ptLastHit = ptTarget; MouseMoveTo(ptTarget); MouseClick(); ptTarget.<span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); MouseMoveTo(ptTarget); MouseClick(); ptTarget.<span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>(<span class="hljs-number"><span class="hljs-number">-40</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); MouseMoveTo(ptTarget); MouseClick(); } } }</code> </pre><br><br><h5>  Patient sorting </h5><br>  Now everything is fine - the moles are successfully healed, but the problem with the moles from the holes has returned.  Remember, they did not disappear if you shoot at them without delay?  I returned the delay to 250ms, but with such a delay it becomes impossible to get into the running moles ... The solution was found quite quickly - we put the coordinates of the holes in the code, and we will give a delay to the shooting only if the target appears in these areas. <br><br>  Even to increase the effectiveness of shooting at jumping moles, it is worth stopping frame processing after hitting the first target found.  Let me explain - even if there are two moles on the screen, then while we are shooting at one, the second one already has time to shift a little, while in the old frame we still have his previous image.  At this moment we are faced with one of the global problems of all C-like languages ‚Äã‚Äã- the impossibility of interrupting two nested loops with the help of the break command.  In such cases, I commit a terrible karmic crime using the goto operator. <br><br>  Finally, let's not forget about flying saucers, robots and rocket, which must be tracked strictly in certain places.  As a result, the cycle began to look like this. <br><br><pre> <code class="hljs pgsql"> g.CopyFromScreen(Screen.AllScreens[<span class="hljs-number"><span class="hljs-number">0</span></span>].Bounds.X, Screen.AllScreens[<span class="hljs-number"><span class="hljs-number">0</span></span>].Bounds.Y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, bmpScreen.Size, CopyPixelOperation.SourceCopy); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-type"><span class="hljs-type">Point</span></span> pt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> m_lptTargets) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_bmpReference.GetPixel(pt.X, pt.Y) != bmpScreen.GetPixel(pt.X, pt.Y)) { <span class="hljs-type"><span class="hljs-type">Point</span></span> ptMouse = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(); GetCursorPos(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> ptMouse); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptMouse != pt) { MouseMoveTo(pt); MouseClick(); } } } // Rectangle hole1 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">539</span></span>, <span class="hljs-number"><span class="hljs-number">612</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); Rectangle hole2 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">577</span></span>, <span class="hljs-number"><span class="hljs-number">690</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); Rectangle hole3 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">738</span></span>, <span class="hljs-number"><span class="hljs-number">621</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); Rectangle hole4 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">243</span></span>, <span class="hljs-number"><span class="hljs-number">641</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); // Rectangle hole5 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">379</span></span>, <span class="hljs-number"><span class="hljs-number">415</span></span>, <span class="hljs-number"><span class="hljs-number">45</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> iDelay = <span class="hljs-number"><span class="hljs-number">5</span></span>; Color clHelmet = Color.FromArgb(<span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">142</span></span>, <span class="hljs-number"><span class="hljs-number">193</span></span>); DateTime tmNow = DateTime.Now; <span class="hljs-type"><span class="hljs-type">Point</span></span> ptLastHit = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> j = <span class="hljs-number"><span class="hljs-number">400</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">880</span></span>; j += <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">200</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">850</span></span>; i += <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bmpScreen.GetPixel(i, j) == clHelmet) { <span class="hljs-type"><span class="hljs-type">Point</span></span> ptTarget = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(i, j); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hole1.Contains(ptTarget) || hole2.Contains(ptTarget) || hole3.Contains(ptTarget) || hole4.Contains(ptTarget) || hole5.Contains(ptTarget)) { iDelay = <span class="hljs-number"><span class="hljs-number">200</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Distance(ptLastHit,ptTarget) &gt; <span class="hljs-number"><span class="hljs-number">70</span></span>) { ptLastHit = ptTarget; Thread.Sleep(iDelay); MouseMoveTo(ptTarget); MouseClick(); ptTarget.<span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); MouseMoveTo(ptTarget); MouseClick(); ptTarget.<span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>(<span class="hljs-number"><span class="hljs-number">-40</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); MouseMoveTo(ptTarget); MouseClick(); goto next; } } } next: }</code> </pre><br><br><h1>  What is the result? </h1><br>  In general, this program has already successfully gained 21-22 thousand points.  To get 25, it was necessary to change some magic values ‚Äã‚Äãsuch as delays and shot coordinates for the ‚Äúqueue‚Äù.  At a certain point, the stars were successful, and I passed the cherished mark of 25,000, for this, a couple of dozen launches were required. <br><br>  It took two nights for all the work from the moment of creating the project to the moment of printing the discount coupon.  Now I understand that the work could be reduced if the algorithm had been thought out in advance.  However, I saved a lot of time due to the fact that I constantly tugged at myself when it occurred to me to create a product that would pass the game for the person. <br><br>  I originally wrote bad code in terms of architecture and functionality, trying to solve a specific task in the shortest possible time.  This program works only on my monitor configuration and requires quite a lot of computing resources, but it solves its problem, and that is enough.  Actually, this post was conceived as an illustration of the effectiveness of this approach, since  In the past, I often missed many opportunities precisely because of "perfectionism" and the desire to write the perfect code, instead of just doing the thing that solves the problem. <br><br>  It is not at all clear to me what the creators of the game hoped for, because it seems to me that it‚Äôs unrealistic to go through the game manually.  Probably, the concept just assumed that only the Red-eyed, who can write a bot, deserve a 25% discount. <br><br>  UPD.  The comments set out more ways to get discounts.  To my shame, I did not even think about the simplest of them ... It turns out that the post as an illustration of what not to do is difficult, when it can be done simply, was a success thanks to the commentators.  Indeed, the bot could not write ... I hope this will serve as a lesson not only for me, but also for the rest of the unfortunate, suffering from computer disease, identified and classified fifty years ago. <br><br><blockquote>  As for Mr. Frenkel, who started all this activity, he began to suffer from a computer disease - everyone who worked with computers today knows about it.  This is a very serious disease and it is impossible to work with it.  The trouble with computers is that you play with them.  They are so beautiful, so many opportunities - if an even number, you do it, if it is odd, you do it, and very soon you can do more and more sophisticated things on a single machine, if you are smart enough. <br><br>  After some time, the whole system collapsed.  Frenkel did not pay any attention to her, he no longer supervised anyone.  The system acted very, very slowly, and at that time he was sitting in a room, wondering how to make one of the tabs automatically type the arctangent x.  Then the tabulator was turned on, typed columns, then - bang, bang, bang - calculated the arctangent automatically by integration and compiled the entire table in one operation. <br><br>  Absolutely useless exercise.  After all, we already had arctangent tables.  But if you have ever worked with computers, you understand what kind of a disease this is - admiration for being able to see how much can be done.  Frenkel picked up this disease for the first time, poor guy;  the poor guy who invented the whole thing. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/201136/">https://habr.com/ru/post/201136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201124/index.html">Why is the assessment of compliance of information security tools and there is certification</a></li>
<li><a href="../201126/index.html">Bitcoin cost exceeded historic record of $ 266 / BTC</a></li>
<li><a href="../201128/index.html">Tesla is going to build its own battery factory</a></li>
<li><a href="../201130/index.html">API for the Russian public initiative. Step 2.1: UK experience with electronic petition data</a></li>
<li><a href="../201132/index.html">Test Labs 2013 Part II. November 16th Online conference for testers</a></li>
<li><a href="../201140/index.html">Universal quadcopter with Kinect on board: able to fly, does not sink in water, rolls along the ground</a></li>
<li><a href="../201142/index.html">Do I need on Habrahabr hub SQLite?</a></li>
<li><a href="../201148/index.html">Novell vs BBS - anti-piracy review at the end of the 20th century</a></li>
<li><a href="../201152/index.html">Corel, Escher, Photoshop ...</a></li>
<li><a href="../201154/index.html">Corel Painter: Drawing a funny cat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>