<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Several different VPN connections with local DNS servers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Where did the problem come from 
 Many of you use a VPN connection to a working local network from home. 
 Thanks to this, connecting VPN you work wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Several different VPN connections with local DNS servers</h1><div class="post__text post__text-html js-mediator-article"><h4>  Where did the problem come from </h4><br>  Many of you use a VPN connection to a working local network from home. <br>  Thanks to this, connecting VPN you work with a working network ‚Äúas if being in it‚Äù. <br><br>  What does a typical linux setup look like? <br>  It is written into /etc/resolv.conf (using openresolv or NetworkManager) <br><br><pre><code class="bash hljs">search local.company.name nameserver 10.0.20.186</code> </pre> <br>  Where local.company.name is the domain of the company, and 10.0.20.186 is the ip address of the local (on the working network) DNS server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What does work look like? <br><br><pre> <code class="bash hljs">root@t510 0 ~ % ping -c 1 cdash-master PING cdash-master.local.company.name (10.0.20.237) 56(84) bytes of data. 64 bytes from 10.0.20.237: icmp_seq=1 ttl=63 time=214 ms ...</code> </pre><br>  What happened? <br><ol><li>  search has added a local.company.name suffix to cdash-master </li><li>  DNS server in the working network converted cdash-master.local.company.name to 10.0.20.237 </li></ol><br>  Everything works fine as long as you have a VPN connection ... one thing. <br>  I wanted to connect at the same time two VPNs and prescribe two DNS - one for the working network, the other for the local network on hetzner, where my virtual machines are spinning. <br><br>  It would seem, what could be easier?  However, the path to the solution was long and winding. <br><a name="habracut"></a><br><h4>  Detailed description of the result </h4><br><h3>  Work network </h3><br>  The local subnet is 10.0.20.0/24 (i.e. 10.0.20. * - from the subnet) <br>  Domain - * .local.company.name <br>  DNS server - 10.0.20.186 <br><br><pre> <code class="bash hljs">ping - 1 somename</code> </pre><br>  should define somename as somename.local.company.name, and turn somename.local.company.name into an IP address via DNS 10.0.20.186 <br><br>  If the VPN connection is disabled, the name will not be found. <br><br><h3>  Personal server on hetzner </h3><br>  It's a bit smarter with him. <br><br>  Local subnet - 10.10.10.0/24 (i.e. 10.10.10. * - from the subnet) <br>  Domain - * .my.domain <br>  Local DNS server - 10.10.10.253 <br><br>  The my.domain server has a white IP address and is accessible from the outside. <br>  The server hosts nginx, which proxies requests of the form subdomain.my.domain to machines from the local subnet. <br><br>  On the one hand, if the user went to the subdomain.my.domain by the browser, the registrar's DNS server will return the white IP address my.domain, the browser will send an HTTP request to this IP address, and then nginx will figure out where to proxy it. <br><br>  On the other hand, when VPN is enabled, my connections are: <br><br><pre> <code class="bash hljs">ssh subdomain</code> </pre><br>  should go directly to the machine from the local subnet. <br>  What for? <br><br>  I feel so comfortable.  I once set up a working machine, and transparently walk around the work network and personal network.  Outside on * .my.domain, users see exactly one server (which is part-time and VPN) and do not have access to local machines.  I can directly connect via ssh to both the machines from the working network and from the personal one. <br><br>  ‚ÄúWait,‚Äù the user will tell me. <br>  ‚ÄúI will just prescribe /etc/resolv.conf‚Äù: <br><br><pre> <code class="bash hljs">search local.company.name my.domain</code> </pre><br>  "And everything will work." <br><br>  Will not be.  For each zone - local.company.name and my.domain, you need to register your DNS server.  Through resolv.conf, openresolv this problem is not solved. <br><br><h4>  Decision </h4><br>  I had to torment Google and familiar admins for hours to find a solution. <br>  My post is designed to save your time. <br><br>  So, first you need to put bind.  I have a working machine on Arch Linux: <br><br><pre> <code class="bash hljs">pacman -S <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> named</code> </pre><br>  Further we configure / etc / named.conf, adds there: <br><br><pre> <code class="bash hljs">zone <span class="hljs-string"><span class="hljs-string">"local.company.name"</span></span> IN { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> forward; forwarders { 10.0.20.186; }; }; include <span class="hljs-string"><span class="hljs-string">"/usr/share/openvpn/named.conf.my.domain"</span></span>; zone <span class="hljs-string"><span class="hljs-string">"."</span></span> IN { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> forward; forwarders { 8.8.8.8; 8.8.4.4; }; };</code> </pre><br>  Configure NetworkManager or edit /etc/resolv.conf.  The result in both cases should be: <br>  root @ t510 0 / usr / share / openvpn # cat /etc/resolv.conf <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Generated by NetworkManager search local.company.name my.domain nameserver 127.0.0.1</span></span></code> </pre><br>  In the openvpn script for my.domain add: <br><br><pre> <code class="bash hljs">up <span class="hljs-string"><span class="hljs-string">"/usr/share/openvpn/update-dns-my.domain"</span></span> down <span class="hljs-string"><span class="hljs-string">"/usr/share/openvpn/update-dns-my.domain"</span></span></code> </pre><br>  Add the /usr/share/openvpn/update-dns-my.domain script that will update the bind settings and restart it after establishing the VPN connection: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -eu NAME=/usr/share/openvpn/named.conf.my.domain TEMPLATE=${NAME}.template function restart_bind () { /usr/bin/systemctl restart named } case $script_type in up) cat ${TEMPLATE} &gt; ${NAME} restart_bind ;; down) cat /dev/null &gt; ${NAME} restart_bind ;; esac</span></span></code> </pre><br><br>  Add /usr/share/openvpn/named.conf.my.domain.template <br><pre> <code class="bash hljs">zone <span class="hljs-string"><span class="hljs-string">"my.domain"</span></span> IN { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> forward; forwarders { 10.10.10.253; }; };</code> </pre><br>  How it works? <br><br>  When establishing a VPN connection to a personal server: <br><ol><li>  openvpn runs the script /usr/share/openvpn/update-dns-my.domain </li><li>  the script in the /usr/share/openvpn/named.conf.my.domain file writes the contents of /usr/share/openvpn/named.conf.my.domain.template </li><li>  script restarts bind </li><li>  bind reads my.domain zone settings from the updated file. </li><li>  my.domain zone is now resolved by DNS server from local network (available via VPN) </li></ol><br><br>  When disconnecting a VPN connection <br><ol><li>  openvpn runs the script /usr/share/openvpn/update-dns-my.domain </li><li>  the script clears the contents of /usr/share/openvpn/named.conf.my.domain </li><li>  script restarts bind </li><li>  bind reads the my.domain zone settings from the updated file (forgets about the zone) </li><li>  my.domain zone is now resolvable by public DNS </li></ol><br><br>  How does it look in practice? <br><br><pre> <code class="bash hljs">root@t510 0 /usr/share/openvpn <span class="hljs-comment"><span class="hljs-comment"># systemctl start named #    bind root@t510 0 /usr/share/openvpn # systemctl start openvpn@waltham #   root@t510 0 /usr/share/openvpn # systemctl start openvpn@hetzner #   root@t510 0 /usr/share/openvpn # ping -c 1 cdash-master PING cdash-master.local.company.name (10.0.20.237) 56(84) bytes of data. 64 bytes from 10.0.20.237: icmp_seq=1 ttl=63 time=214 ms ... root@t510 0 /usr/share/openvpn # ping -c 1 db PING db.my.domain (10.10.10.200) 56(84) bytes of data. 64 bytes from 10.10.10.200: icmp_seq=1 ttl=63 time=233 ms ... root@t510 0 /usr/share/openvpn # systemctl stop openvpn@hetzner root@t510 0 /usr/share/openvpn # ping -c 1 db PING db.my.domain (white-ip-address) 56(84) bytes of data. 64 bytes from my.domain (white-ip-address): icmp_seq=1 ttl=55 time=124 ms ... root@t510 0 /usr/share/openvpn # systemctl start openvpn@hetzner root@t510 0 /usr/share/openvpn # ping -c 1 db PING db.my.domain (10.10.10.200) 56(84) bytes of data. 64 bytes from 10.10.10.200: icmp_seq=1 ttl=63 time=118 ms ...</span></span></code> </pre><br>  It's funny that to get such a simple behavior, you had to do so much work. </div><p>Source: <a href="https://habr.com/ru/post/182924/">https://habr.com/ru/post/182924/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182904/index.html">Apple's WWDC 2013 news: iOS 7, OS X 10.9, iWork for iCloud, iTunes Radio, Haswell-based Macbook Air</a></li>
<li><a href="../182908/index.html">About human immortality</a></li>
<li><a href="../182912/index.html">Obtained photos of the crystal of the specialized bitcoin processor Avalon</a></li>
<li><a href="../182920/index.html">Ten C ++ 11 features that every C ++ developer should use</a></li>
<li><a href="../182922/index.html">Lawsuit for $ 3 billion against the NSA, Obama, Verizon and the US Justice Department</a></li>
<li><a href="../182928/index.html">Apple has provided the ability to transfer applications from one developer to another</a></li>
<li><a href="../182930/index.html">It is contagious: tightening the screws in the information space of Ukraine</a></li>
<li><a href="../182932/index.html">IOS 7 for iPhone Review</a></li>
<li><a href="../182936/index.html">A soft introduction to Coq: use tactics</a></li>
<li><a href="../182938/index.html">How we built a fail-safe data center level TIER-III</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>