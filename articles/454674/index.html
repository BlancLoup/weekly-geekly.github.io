<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Poor man's monitoring or monitor server from console</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All welcome dear readers. In this article, I will tell you about my "bike", on which I do monitoring of various things without leaving the console. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Poor man's monitoring or monitor server from console</h1><div class="post__text post__text-html js-mediator-article"> All welcome dear readers.  In this article, I will tell you about my "bike", on which I do monitoring of various things without leaving the console. <br><br>  I once faced a situation where quite a lot of different projects and servers were bred, and my hands did not reach for setting up normal monitoring. <br><br>  Yes, and in the modern world, ‚Äúproper‚Äù monitoring implies the deployment of a whole heap of software, customization of the whole thing.  Well, you know there ... the docker, the elastic stack and it went away.  For me it was a strong overhead projector.  It would be desirable that one-two and in production. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I looked in the direction of <a href="https://jamesoff.github.io/simplemonitor/">Simple monitor</a> on the python, he was closest to me in spirit, but he lacked quite a few features.  And at the same time I wanted to teach Go ... well, in general, you yourself know how it all starts as usual. <br><br>  So I took the go <s>weld</s> , and knocked this <a href="https://github.com/zim32/climonitoring">bike out</a> . <br><a name="habracut"></a><br>  Cli Monitoring is written in Go and is a collection of binaries, each of which receives data from stdin, performs some specific task and outputs the result to stdout. <br><br>  There are four types of binaries in total: <b>metrics</b> , <b>processors</b> , <b>filters</b> , and <b>outputs</b> . <br><br>  <b>Metrics</b> , as the name implies, collect any data and usually go first in the chain. <br>  <b>Processors</b> are in the middle and somehow change the data or perform other utility functions. <br>  <b>Filters are</b> almost like processors, but unlike them, they either skip or do not skip data depending on the condition. <br>  <b>Outputs</b> are at the exit from the chain and are used to send notifications to various services. <br><br>  The whole chain of commands usually looks like: <br><br> <code>some_metric | processor_1 | processor_2 ... | cm_p_message | output_1 | output_2 ...</code> <br> <br>  Any piece of this chain can be any Linux command, so long as it receives data in stdin and gives it to stdout without buffering.  There is only one small BUT associated with the transfer of lines, but more on that later. <br><br>  The name of the binaries is formed as <b>cm_ {type} _ {name}</b> , where type is one of three: <b>m, p, f, or o</b> , and name is the name of the command. <br><br>  For example, cm_m_cpu is a metric that displays statistics on the processor in json format to stdout. <br><br>  And the cm_p_debounce file is a processor that only allows one message to exit at a given interval. <br><br>  There is one special processor <b>cm_p_message</b> , which should stand before the first output.  It creates a message of the desired format for subsequent processing by its Outputs. <br><br>  To handle json in the console and various conditions, I used the <a href="https://stedolan.github.io/jq/">jq</a> utility.  This is something like sed, only for json. <br><br>  So, for example, looks at the result of monitoring the CPU load. <br><br><pre> <code class="bash hljs">cm_m_cpu | cm_p_eot2nl | jq -cM --unbuffered <span class="hljs-string"><span class="hljs-string">'if .LoadAvg1 &gt; 1 then .LoadAvg1 else false end'</span></span> | cm_p_nl2eot | cm_f_regex -e <span class="hljs-string"><span class="hljs-string">'\d+'</span></span> | cm_p_debounce -i 60 | cm_p_message -m <span class="hljs-string"><span class="hljs-string">'Load average is {stdin}'</span></span> | cm_o_telegram</code> </pre> <br>  And so monitoring of messages in the RabbitMQ queue <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> rabbitmqctl list_queues -p queue_name | grep -Po --line-buffered <span class="hljs-string"><span class="hljs-string">'\d+'</span></span>; sleep 60; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> | jq -cM <span class="hljs-string"><span class="hljs-string">'. &gt; 10000'</span></span> --unbuffered | cm_p_nl2eot | cm_f_true | cm_p_message -m <span class="hljs-string"><span class="hljs-string">'There are more than 10000 tasks in rabbit queue'</span></span> | cm_o_opsgenie</code> </pre><br>  So you can monitor that nothing has been written to the file in 10 seconds. <br><br><pre> <code class="bash hljs">tail -f out.log | cm_p_nl2eot | cm_p_watchdog -i 10 | cm_p_debounce -i 3600 | cm_p_message -m <span class="hljs-string"><span class="hljs-string">'No write to out.log for 10 seconds'</span></span> -s <span class="hljs-string"><span class="hljs-string">'alert'</span></span> | cm_o_telegram</code> </pre> <br>  Do not rush to close the screen, now analyze what happens here in the first example. <br><br>  <b>1)</b> The metric <b>cm_m_cpu</b> displays once per second (set by the -i parameter, the default is second) strings in json format.  For example, {"LoadAvg1": 2.0332031, "LoadAvg2": 1.9018555, "LoadAvg3": 1.8623047} <br><br>  <b>2)</b> <b>cm_p_nl2eot is</b> one of the utility commands that converts the EOT character to the LF character.  The fact is that in order to avoid problems with the line break, I decided to make sure that all my binaries read data up to the ascii EOT (End of Transmission) symbol.  This allows you to safely transfer multi-line data between commands. <br><br>  Therefore, when any other commands are called, they should be surrounded in the form of: <br>  <i>cm_p_eot2nl |</i>  <i>any other team |</i>  <i>cm_p_nl2eot.</i> <br><br>  <b>3)</b> This is followed by a call to the <b>jq</b> utility, which checks the LoadAvg1 field and if it is greater than 1, then displays it further, if less, it displays false <br><br>  <b>4)</b> Next we need to throw out the entire message <i>false</i> from the chain.  To do this, use the filter <b>cm_f_regex</b> , which accepts a string as an input, matches it with a regular expression, and in the case with a match, outputs further.  Otherwise, the string is simply discarded. <br><br>  It would be possible to use the usual grep, but firstly it buffers the output, and the full syntax gets a little longer (grep --line-buffered), and secondly, cm_f_regex makes it very easy to display group matches.  For example: <br><br> <code>cm_f_regex -e '(\d+)-(\d+)' -o '{1}/{2}'</code> <br> <br>  Converts the string 123-345 to the string 123/345 <br><br>  <b>5)</b> The <b>cm_p_debounce</b> processor, in this case, takes our LoadAvg1 value and outputs it further along the chain only once every 60 seconds.  This is necessary in order not to spam yourself.  You can set any other interval. <br><br>  <b>6)</b> Almost everything is ready.  It remains only to form a message and send it to the telegram.  The message is formed by a special command <b>cm_p_message</b> .  It simply accepts a string as input, creates json with the fields Severity, Message and others and outputs further for processing by outputs.  If we did not pass the -m parameter to it, then stdin would be the message, i.e.  millet number is our LoadAvg1.  This is not very informative. <br><br>  <b>7) The</b> cm_o_telegram <b>command</b> simply sends the input message to the telegram.  Telegram settings are stored in the ini file. <br><br><h3>  Configuration </h3><br>  All parameters that accept binaries can be specified in the ini file.  Parameters set by the command line argument take precedence over the ini file. <br><br>  The init file format is: <br><br> <code>[global] <br> host_name=override host name for this machine <br> <br> [telegram] <br> cid=.... <br> token=.... <br> <br> [opsgenie] <br> apiToken=... <br> apiEndpoint=... <br> ...... <br> <br> [debounce] <br> i=3600</code> <br> <br>  The ini file itself is selected in the following order: <br><br>  1) The cm.config.ini file in the current working directory <br>  2) File /etc/cm/config.ini if ‚Äã‚Äãthe file from item 1 is not found <br><br><h3>  Production </h3><br>  On a real server, I create a file for example cpu.sh, in which all the necessary chain of commands is recorded.  Next in the crown I prescribe something like this: <br><br> <code>*/5 * * * * flock -n /etc/cm/cpu.lock /etc/cm/cpu.sh &gt; /dev/null</code> <br> <br>  If anything falls, the flock will raise the command.  And that's it!  The simplicity of which I did not lack. <br><br>  That turned out to be such a tool, maybe someone will find it convenient.  For me, the convenience is that you don‚Äôt have to do a lot of unnecessary things just to monitor the necessary things.  Yes, and this is all set up quite comfortably: clone the repository, add the path to the binaries in $ PATH, that's all. <br><br>  Please do not judge strictly.  The tool was written for myself, the set of commands is not big yet.  But I will be glad to any feedback and wishes.  Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/454674/">https://habr.com/ru/post/454674/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454662/index.html">Careful transfer to the Netherlands with his wife and mortgage. Part 1: Job Search</a></li>
<li><a href="../454666/index.html">Software Defined Radio - how does it work? Part 7</a></li>
<li><a href="../454668/index.html">Developer Cookbook: DDD Recipes (Part 5, Processes)</a></li>
<li><a href="../45467/index.html">How to promote your video on YouTube</a></li>
<li><a href="../454670/index.html">The series "Chernobyl": watch and think</a></li>
<li><a href="../454676/index.html">GPS clock on Arduino</a></li>
<li><a href="../454678/index.html">The idiomatic programming of a GPU on Rust: The Emu Library</a></li>
<li><a href="../45468/index.html">US Army buys new game</a></li>
<li><a href="../454682/index.html">iOS 13, watchOS 6, iPadOS and new Mac Pro. Apple presentation at WWDC 2019</a></li>
<li><a href="../454686/index.html">Israeli Aleph Farms, which develops technologies for the production of "test tube" meat, has raised $ 11.65 million</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>