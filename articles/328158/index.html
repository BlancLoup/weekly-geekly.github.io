<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we did a short-term forecast of precipitation. Lecture in Yandex</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the beginning of winter, Yandex.Pogoda learned how to show whether precipitation will occur in the next two hours. After a couple of months, the to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we did a short-term forecast of precipitation. Lecture in Yandex</h1><div class="post__text post__text-html js-mediator-article">  At the beginning of winter, Yandex.Pogoda <a href="https://habrahabr.ru/company/yandex/blog/317626/">learned how to show</a> whether precipitation will occur in the next two hours.  After a couple of months, the topic of weather forecasting became central at one of the events of Data &amp; Science.  Among the speakers that day was Alexey Preobrazhensky - a developer from the Yandex.Pogoda team.  Alexey talked about our algorithm for nauchasing and the convolutional neural network underlying this algorithm. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/wTi-jQ2ZEmU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Under the cut - decoding lectures and slides. <br><br><a name="habracut"></a><hr><br>  My name is Alexey Preobrazhensky, I‚Äôm not a meteorologist, but a developer, and I‚Äôll tell you about technical things, about data analysis. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How many people are involved in data analysis - are they competing at Kaggle, for example?  Lot.  And who is involved in the <a href="https://habrahabr.ru/company/yandex/blog/327444/">training of Yandex</a> machine learning?  The same, great.  My report is organized roughly as a workout.  Waiting for you a story about how we in the team of Yandex.Pogoda built nauchsting, what algorithms used, what data was used, how they measured and what we did. <br><br>  Everyone who watched the film ‚ÄúBack to the Future 2‚Äù probably knows what naunting is.  When doc Brown gets out of the car and says that the rain will end in 5 seconds, this is a naunting.  But this is naughting in movies.  Real-life science research ‚Äî at least in the heads of managers ‚Äî looks either as a notice to a person in the form of text or push notification, or as a precipitation map that moves with time.  The task was precisely to develop a product that would combine both notifications and a precipitation map.  The forecast of precipitation on the future map was required, floating clouds. <br><br>  A year and a half ago, when we started, we had nothing but data.  Unlike the participants at Kaggle, we had no fixed metrics, no baseline solutions.  The only thing that happened was the constant technology race in which we wanted to overtake ourselves. <br><br>  The first decision is simply Groundhog Day.  Overtake the forecast, decide that tomorrow will be the same as yesterday.  And the next model should improve the previous one. <br><br>  What is needed to predict precipitation?  Need data, radar images.  It is necessary to understand how particles move in the atmosphere, what winds blow and how to apply this movement to particles.  I'll tell you about all three components of the forecast. <br><img src="https://habrastorage.org/web/696/d47/986/696d479864fb406fa2defc4d54e1b44f.png" width="700"><br>  The first - radar images.  They come in very different formats and come from very different suppliers.  These are just separate pictures in PNG, with the agreement that such and such intensity of the reflected signal is indicated by color with such a code.  This is GeoTIFF - a picture in TIFF format with geo-information inside itself, where it is indicated which coordinates it refers to.  Or - the scientific format NetCDF. <br><br>  Radars differ greatly in update frequency.  There are radars that are updated every 10 minutes, every 15 minutes.  The worst thing is that the data from the radar - in contrast to the relatively clean data for the competition - contain artifacts.  Radars operate on physical principles, on wave reflection, so that they have blind zones.  And when small fragments of the visibility zone are radially closed by buildings, this is still far from the most difficult case. <br><img src="https://habrastorage.org/web/ff4/b97/b61/ff4b97b612594264a81b30d65fd33011.png" width="700"><br>  Some radars are closed for about 50% of the range.  There are also artifacts made by people.  For example, during the beta testing period, we ran into a person who bought a Wi-Fi point, incorrectly tuned the frequency and channel number on it, and then put it out of the window.  As a result, we hung over Ivanovo huge laser sword in the form of a cloud.  We saw it on the map and could not do anything with it until we called Frequency Surveillance.  Please, if you buy Wi-Fi-points somewhere in China, tune them to Russian frequencies. <br><img src="https://habrastorage.org/web/22f/2b9/5b3/22f2b95b3b4841038dd59e7b71564194.png" width="700"><br>  In addition to radar data, it is necessary to take a vector field from somewhere else.  In principle, it can be taken from just two places: either by analyzing previous radar images and applying, say, optical flow algorithms, or from some other sources.  For example, you can use the weather modeling and the result of the work of the same RUF or Meteum.  We take the field of winds and use it to transfer the pictures that the radar returns. <br><br>  Both ways of getting vector fields have disadvantages.  Optical flow can not be calculated in places where the cloud does not fly.  There is nothing to reflect on the radar beam, and there is no data on air velocity and direction of motion. <br><br>  Weather modeling may not coincide with reality.  Therefore, if we used only the data of the weather models, it could happen that in the historical data of the radar the cloud flies in one direction, and then in the forecast of the winds it turns sharply and flies in the other direction. <br><br>  The third component of nauchsting is an algorithm for applying a vector field.  Here science can pretty much.  We took as a basis the thin plate spline transform - the transformation of a picture that represents it in the form of a thin rubber plate and stretches some places.  We parametrize this transformation with just a few reference vectors, and restore all other motion vectors inside the image by spline interpolation.  This technology is used, for example, in the restoration of motion on the last frame of the video.  Known scientific work. <br><br>  Armed with the knowledge gained, we began to try to build a forecast.  The first solution that came to mind was to simply train several neural networks so that the first neural network predicted the situation on the radar in 10 minutes, the second - in 20 minutes, the third - in 30. The requirement was as follows: predict radar data for about two hours forward. <br><img src="https://habrastorage.org/web/c39/6dd/b91/c396ddb91d8845ebb85a3ab2515c0d21.png" width="700"><br>  Predictions turned out like this.  At about the same time when we trained 12 neural networks, we had the opportunity to visualize the data on the map.  Looking at the jumping clouds, the managers said: we will not release it for sure.  One of them said: of course, I understand that this maximizes the likelihood of something there, but this cannot be explained to the user - in real life the clouds do not jump like that. <br><br>  During the next iteration, we decided to count only the vector field and multiply the support vectors by 2 and 3 in order to get the transfer not by 10, but by 20 minutes and 30 minutes, respectively. <br><img src="https://habrastorage.org/web/63f/fc3/9fc/63ffc39fc0334568ac2d4feb0afa2cb6.png" width="700"><br>  At near horizons, the results looked pretty decent, but the farther, the more often artifacts appeared on the edge.  It turned out that in the vector field too large vectors break the thin plate spline, and we have the second mirror image of our image.  Then the reflections merge.  In the near horizons, the artifact was not noticeable, but it manifested itself very strongly on distant ones.  A cloud appeared from nowhere. <br><img src="https://habrastorage.org/web/823/8a5/ade/8238a5ade3c3437f85fa16c92802d3d2.png" width="700"><br>  The third solution was to consistently apply the same thin plate spline transformation to the same picture.  On the one hand, it contributed to the accumulation of errors.  This was the first really working solution, which we showed in the internal beta test.  The neural network received six radar images at the input in the last hour, several convolutions brought them to the tensor of 16 4 x 4 vectors. The spline transform was reconstructed from the vectors and consistently applied to the picture to get each next forecast horizon. <br><br>  The solution did quite well, but the only question left was: why do we need a neural network?  If red convolutions are the only part that we teach, why don't we calculate the vector field on our own, algorithmically?  So the fourth solution, which noticeably improved the result, used an explicit minimization of the loss function. <br><img src="https://habrastorage.org/web/16e/4d1/3df/16e4d13df9e543759a72845db473b367.png" width="700"><br>  We were looking for a vector field that would equally well approximate the transition by 10 minutes in the last hour.  From ‚Äì60 minutes to ‚Äì50, then to ‚Äì40, and so on. We applied this vector field to t0 to get a forecast 10 minutes further. <br><br>  Algorithmically it is much better to find a vector field using minimization.  It works faster, does not require training.  The most interesting - it does not require all the data.  You can skip some data - and the radars are often delayed.  We have long thought what to leave - neural networks or algorithmic calculations of a vector field.  But all won the same laser sword in Ivanovo.  When it hangs over you like a sword of Damocles and zooms out all the vectors around itself, the clouds can neither cross it nor move in the same area with it.  Even some kind of physical movement in the picture does not occur. <br><img src="https://habrastorage.org/web/48f/a8e/3f8/48fa8e3f894442da870e2417fdfb6985.png" width="700"><br>  Therefore, in the end, we came to the neural network.  Now the neural network works and gives predictions, its architecture is shown schematically here.  It is composed of about 12 identical blocks.  Each block consistently builds a forecast over its horizon, receiving as input a state tensor and the last radar snapshot, the last prediction from the previous horizon. <br><br>  The state tensor has a rather small dimension, only 32 x 32 by 30 channels, but by convolution to involution we get from it a vector field, support vectors for the transformation of the thin plate spline.  And, conversely, by convolution to deconvolution, we get the places where precipitation falls.  This neural network architecture takes into account that in some places precipitation falls traditionally.  For example, a cloud that has flown over a city is more likely to spill than over a forest, because there is a different atmosphere over the city, a microclimate.  There, for example, is simply warmer. <br><br>  From horizon to horizon, from block to block, we transfer the state in question, and in the process we change it a little by means of the residual network.  Residual is when we ourselves change the tensor quite a bit, adding measurements to it.  The trained part is the delta of the trained part, the change of the tensor. <br><br>  We take the memorized state, with the help of deconvolution we make of it some kind of precipitation map, we add them to the clouds and move them.  This is the current network architecture.  It works, predicts, and the results are pretty good - you can see them <a href="https://pogoda.yandex.ru/">on the site</a> . <br><br>  But they are pretty good in terms of data science, ROC AUC, and F1-metrics, and the business is not interested in abstract figures and curves that we draw.  Business is interested in the accuracy of these predictions, the accuracy of the text that the rain will end in 10 minutes and 20 seconds.  We are now faced with another task.  Now the neural network is learning with some kind of loss function.  It maximizes the probability of correct classification using binary entropy.  But in fact, it is necessary to improve other business metrics - not the correct classification, but the correct determination of the start and end time of precipitation.  Studies on how to get loss functions for training neural networks from business metrics are very important and interesting.  We continue to develop in the right direction. <br><br>  In addition to business requirements, we still have quite a few plans for the development of the current solution.  For example, at the moment we only use pictures, but we have a huge amount of information.  The most interesting is the radial speed.  Radar on the Doppler effect determines not only the presence of particles in the air, but also their speed.  The length of the reflected wave, he understands the speed with which to move, to or from the radar.  The results can also be used to predict a vector field.  But unfortunately, we only have radial speed and only in places where there are really some particles, precipitation. <br><br>  You can mix vector fields from weather modeling.  There is wind, and you can add something else - for example, temperature. <br><br>  We have a relief, height, land use, the type of underlying surface.  In cities, precipitation behave differently than over the huge Baltic Sea.  They fly over him and fall already in St. Petersburg. <br><br>  An even bigger task that we are currently solving is the transfer of forecasts between radars.  Now the neural network is building a forecast for only one zone, around one radar.  A cloud that approaches the radar visibility boundary will never spill over to the next radar, because the neighboring radar will not know that there was a cloud somewhere.  There is no such information in the input data, and the indicated question remains open. <br><br>  It's all.  I told about all the differences and similarities between the solutions of the competitions on Kaggle and the tasks of the business.  Our current architecture is a convolutional neural network.  It predicts not only movement, but also precipitation.  Thank. </div><p>Source: <a href="https://habr.com/ru/post/328158/">https://habr.com/ru/post/328158/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328144/index.html">Docker containers slightly increase server power consumption</a></li>
<li><a href="../328146/index.html">A simple model of the adaptive Kalman filter by means of Python</a></li>
<li><a href="../328148/index.html">BK-0010 emulator on FPGA - part 2</a></li>
<li><a href="../328152/index.html">As I wrote my Redux</a></li>
<li><a href="../328156/index.html">How Studying Smalltalk Can Improve Your Programming Skills</a></li>
<li><a href="../328160/index.html">Change in perception of complexity</a></li>
<li><a href="../328162/index.html">Count to three: three</a></li>
<li><a href="../328164/index.html">IaaS Digest: ‚ÄúvCloud and His Friends‚Äù</a></li>
<li><a href="../328170/index.html">Profiling and optimizing symbolic computations for a future server</a></li>
<li><a href="../328172/index.html">By the day of communication: the history of IP-telephony</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>