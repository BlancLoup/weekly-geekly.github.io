<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating patch on Wix with PatchWiz. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! In my last article, I set the task of generating patches and began a review of the technology for creating them on Wix (using PatchWi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating patch on Wix with PatchWiz. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/f29/494/dcf/f29494dcf6d3477fc05513891744f0ff.png" alt="image" align="right"><br>  Good day to all!  In my <a href="http://habrahabr.ru/post/190546/">last article,</a> I set the task of generating patches and began a review of the technology for creating them on Wix (using <i>PatchWiz</i> ).  In the same place we came to the conclusion that for a complete solution of the problem, ‚Äúsomething else‚Äù is needed.  Welcome to Part 2, where I will describe our organizational and technical approaches with all the sources. <br><br><a name="habracut"></a><br><br>  To begin with, I still say that I describe our approach, that is, my own experience and result, and not dogma. <br>  So in order to avoid all the shortcomings mentioned last time, we had to develop rules for creating installations and a utility for creating patches. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Our organizational problem solving </h4><br>  We decided to do this: installations are assembled from <i><a href="http://wix.sourceforge.net/manual-wix2/authoring_merge_modules.htm">merge modules</a></i> . <br>  A certain basic assembly (baseline) is selected, which includes modules with binaries that are mandatory for all.  It is collected for each new version of the product.  Moreover, if only the <i>Build number has</i> been changed, then a differential patch is created, where the base version is the previous one with the <i>Build number</i> = 0 (let's call them reference assemblies). <br><br><img src="https://habrastorage.org/storage2/13e/9c7/c16/13e9c7c16510555a9ee90039c3a15799.png"><br><br>  Circles on the time axis are the created assemblies.  The reference assemblies are marked in blue, the assemblies in green, where a differential patch was additionally created based on the previous reference assembly.  In addition, additionally, for the reference assemblies, a differential patch is also formed based on the previous reference assembly. <br><br>  Thus, when a client requests the latest version from us, we check if he has an installed version now and what is its number.  Further, either a complete assembly or patch is sent. <br><br>  A similar scheme works with automatic updating: either <i>msi</i> or <i>msp</i> package comes from the server, which is installed using standard <i>msiexec</i> tools. <br><br>  To understand the implementation of this mechanism consider the following solution. <br><br><h4>  Solution Overview </h4><br>  To begin with, we will look at the general structure of the solution (the folders themselves are named for clarity).  Fully its source is laid out on <i>GitHub</i> , the link is at the end. <br><br><img src="https://habrastorage.org/storage2/2c9/1a1/dd6/2c91a1dd67ffcf97b37c0a150d4b40c1.png"><br><br>  Folders contain: <br>  1. Directly the application itself. <br>  2. Shared files for collecting installations, including an extension for <i>Wix</i> . <br>  3. Project installation application. <br>  4. Utility for creating patches. <br>  5. Batnik for the test. <br><br>  Folder numbers reflect the order of actions required.  Let's start. <br><br><h4>  Go in steps </h4><br><h6>  Step 1. Write an application </h6><br>  In our case, this will be a simple console application ‚ÄúHello, World!‚Äù, With which we will change the version. <br><br><h6>  Step 2. We write common parts for installations </h6><br>  Go through the files: <br>  <i>Deploy.Variables.wxi</i> - common variables for all installations of the company: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define Manufacturer=</span><span class="hljs-string"><span class="php"><span class="hljs-string">""</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define ManufacturerUrl=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"http://company.ru"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define Language=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"1049"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define Codepage=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"1251"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  It seems to me that everything is clear here: the variables that will be used in all installation projects are indicated. <br><br>  <i>Deploy.Yasen.Variables.wxi</i> is a common <i>Wix</i> file for all product installations: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define ProductName=</span><span class="hljs-string"><span class="php"><span class="hljs-string">""</span></span></span><span class="php"> </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define YasenProductCode=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"{06CABA42-492E-49CE-9849-F85E87442E99}"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define YasenUpgradeCode=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"{BA8CCE3C-4267-4291-B330-16EE510F023B}"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  Why are we taking out separately product codes and updates?  Because then we will need them in many places (in different projects of installations and a patch descriptor). <br><br>  <i>Deploy.Yasen.ProductContent.wxi</i> - a common file with various properties of installations. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Package</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PackageId)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">InstallerVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Compressed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Languages</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Language)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SummaryCodepage</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Codepage)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Comments</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" $(var.ProductName)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Keywords</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">", , , , , "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Subject)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">InstallScope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"perMachine"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MSIUSEREALADMINDETECTION"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MajorUpgrade</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DowngradeErrorMessage</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"     "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AllowDowngrades</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Upgrade</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'$(var.UpgradeCode)'</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UpgradeVersion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">OnlyDetect</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Maximum</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IncludeMaximum</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Property</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OLDERVERSIONBEINGUPGRADED"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">MigrateFeatures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Upgrade</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Media --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Media</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Cabinet</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"media1.cab"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">EmbedCab</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In this file, we finally start using variables from previous files (they will be available here later when we create the main installation file).  The required <i>Media</i> element is indicated and several additional ones are set (mainly concerning updates): <br><br><ul><li>  <b>MSIUSEREALADMINDETECTION</b> - if = 1, then the real administrator rights will be requested (meaning through UAC). </li><li>  The <b>MajorUpgrade</b> element indicates the possibilities for <i>Major upgrade</i> , in our case the upgrade to the new version is allowed and the rollback to the old version is prohibited. </li><li>  <b>Upgrade</b> element - contains a description of possible upgrades. </li><li>  The <b>UpgradeVersion</b> element describes the conditions for detecting previous versions (by <i>UpgradeCode</i> ) and actions in case of their detection.  Possible options (I don‚Äôt give everything): <br>  <b>Minimum</b> - the minimum version that this installation can update. <br>  <b>Maximum</b> - the maximum version that this installation can update. <br>  <b>IncludeMaximum</b> - "inclusive" maximum version (by default - yes). <br>  <b>IncludeMinimum</b> - "inclusive" minimum version. <br>  <b>Property</b> - contains the name of some variable.  In case if the corresponding product is found for the indicated versions, then their codes will be written to this variable through a ';'.  The values ‚Äã‚Äãof this variable can be further involved, for example, when performing <i>CustomAction</i> . <br>  <b>OnlyDetect</b> - If = ' <i>yes</i> ', then the specified versions will only be detected and written to the specified properties, but they will not be uninstalled. <br>  <b>IgnoreRemoveFailure</b> - informs whether to ignore errors when uninstalling the detected version. </li></ul><br><br>  In our case, <b>UpgradeVersion is</b> configured so that you can upgrade all previous versions within our <i>UpgradeCode</i> . <br><br>  Go <i>ahead</i> : <i>Deploy.Yasen.PatchCreation.xml</i> - patch descriptor for this product. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/wix/2006/wi"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">include</span></span></span><span class="php"> Deploy.Variables.wxi</span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">include</span></span></span><span class="php"> Deploy.Yasen.Variables.wxi</span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define PatchDescription=</span><span class="hljs-string"><span class="php"><span class="hljs-string">" $(var.ProductName)"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatchCreation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchId)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Codepage</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Codepage)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CleanWorkingFolder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">OutputPath</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"patch.pcp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WholeFilesOnly</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatchInformation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchDescription)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Comments</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchDescription)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Manufacturer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Manufacturer)"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatchMetadata</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AllowRemoval</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchDescription)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ManufacturerName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Manufacturer)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TargetProductName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductName)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">MoreInfoURL</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ManufacturerUrl)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Classification</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Update"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DisplayName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchDescription)   $(var.PatchVersion)"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Family</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DiskId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Family)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SequenceStart</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5000"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UpgradeImage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SourceFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.NewMsi)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"NewPackage"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetImage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SourceFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.BaseMsi)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Order</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BasePackage"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IgnoreMissingFiles</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Validation</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0x00000912"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UpgradeImage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Family</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatchSequence</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PatchFamily</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchFamily)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sequence</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.PatchVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Supersede</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ProductCode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductCode)"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatchCreation</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Include</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  We <b>examined the PatchCreation</b> structure in detail in Part 1. But here you can see at least 2 very important differences: <br><br><ul><li>  <b>Validation</b> attribute on the <b>TargetImage</b> element.  It is this attribute that allows us to allow patch skipping.  It is described in detail <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa370073(v%3Dvs.85).aspx">here</a> .  So, to allow multiple versions to be updated, you usually need to specify all of them ( <b>using TargetImage</b> elements), which in turn increases the size of the patch.  Considering our requirements and organizational measures (the principle of versions), we managed to indicate only the previous support assembly and the <b>Validation</b> flag with a value of <b>912</b> .  This value indicates that the following condition must be met to apply a patch to the installed product: <i>UpgradeCode</i> , <i>ProductCode</i> and <i>magor</i> and <i>minor</i> versions of the patch (to which you are updating) and the installed version must match (and the <i>build number should</i> not).  Thus, skipping updates within the <i>minor</i> version will be allowed!  High five!  Validation can take a fairly wide range of values ‚Äã‚Äãand you can get a very interesting effect.  Enjoy! </li><li>  Also in the <i>PatchCreation</i> file, variables are used that have not been previously declared anywhere, for example: <i>var.PatchFamily</i> , <i>var.PatchVersion</i> .  Their use will become clear to us at step 4. <br></li></ul><br>  And even in step 2 there is a certain project <i>Incom.WixExtensions</i> (in the folder).  This is a project with an extension for <i>Wix</i> .  It should logically be present here, and its use will become clear in step 3. <br><br><h6>  Step 3. We assemble the installation for some customer </h6><br>  First, we connect <i>Wix</i> files with variables that we declared before. <br><pre> <code class="xml hljs"> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define WixCommonPath=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"$(var.ProjectDir)..\"?&gt;</span></span></span></span> <span class="php"><span class="hljs-string"><span class="php"><span class="hljs-string">&lt;?include $(var.WixCommonPath)\Deploy.Variables.wxi?&gt;</span></span></span></span> <span class="php"><span class="hljs-string"><span class="php"><span class="hljs-string">&lt;?include $(var.WixCommonPath)\Deploy.Yasen.Variables.wxi?&gt;</span></span></span></span></code> </pre><br>  Then we will announce the software version and the current product codes and update lines. <br><pre> <code class="xml hljs"> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define Subject=</span><span class="hljs-string"><span class="php"><span class="hljs-string">" "</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define ProductVersion=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"$(incom.FileVersion($(var.Yasen.UI.TargetPath)))"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define UpgradeCode=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"$(var.YasenUpgradeCode)"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">define ProductCode=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"$(incom.ChangeGuid($(var.YasenProductCode),$(var.ProductVersion), 2))"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Please note that <i>UpgradeCode is</i> used "as is", and some conversion is applied to the product code. <br>  Using this transformation, we strive for the following goal: when changing the <i>Build number, the Product Code</i> should not change so that a differential patch can be created, and if you change the <i>Major</i> or <i>Minor</i> version, the <i>Product</i> Code should change (this was described in the first part).  Accordingly, we do the following: we use the product code from a global variable and call the conversion function, indicating from which parts of the version the final version depends.  With that, 1 - only from <i>major</i> , 2 - from <i>major</i> and <i>minor</i> , and then by analogy to the value 4. <br><br>  The time has come for the <i>Wix</i> extension mentioned above. <br>  Since the purpose of the article is not in the description of the technology for creating extensions for <i>Wix</i> (you can see <a href="http://wix.sourceforge.net/manual-wix3/extension_development_preprocessor.htm">here</a> ), I will briefly summarize the essence: an extension is created for the preprocessor, which redefines the <i>EvaluateFunction</i> method.  It will be called by <i>Wix</i> when using functions with the <i>incom</i> prefix. <br>  In this method, we perform 2 functions: <br>  ‚Ä¢ Get file version <br>  ‚Ä¢ Universal <i>Guid</i> change feature <br><br><div class="spoiler">  <b class="spoiler_title">A piece of Wix extension code for computing functions</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="prefix"&gt;</span></span></span><span class="hljs-comment"></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="function"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="args"&gt;</span></span></span><span class="hljs-comment"></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public override string EvaluateFunction(string prefix, string function, string[] args) { if (prefix == "incom") { switch (function.ToLower()) { case "fileversion": var ver = FileVersionInfo.GetVersionInfo(Path.GetFullPath(args[0])).FileVersion; Console.WriteLine(string.Format("Version of {0}: {1}", args[0], ver)); return ver; case "changeguid": var guid = Guid.Parse(args[0]).ToByteArray(); version = Version.Parse(args[1]); var major = BitConverter.GetBytes((Int16)((version.Major &amp; 0xFF) ^ ((version.Major &gt;&gt; 16) &amp; 0xFF))); var minor = BitConverter.GetBytes((Int16)((version.Minor &amp; 0xFF) ^ ((version.Minor &gt;&gt; 16) &amp; 0xFF))); var build = BitConverter.GetBytes((Int16)((version.Build &amp; 0xFF) ^ ((version.Build &gt;&gt; 16) &amp; 0xFF))); var revision = BitConverter.GetBytes((Int16)((version.Revision &amp; 0xFF) ^ ((version.Revision &gt;&gt; 16) &amp; 0xFF))); var len = 4; if (args.Length &gt; 2) len = int.Parse(args[2]); if (len &gt; 0) { guid[0] = major[0]; guid[1] = major[1]; } if (len &gt; 1) { guid[2] = minor[0]; guid[3] = minor[1]; } if (len &gt; 2) { guid[4] = build[0]; guid[5] = build[1]; } if (len &gt; 3) { guid[6] = revision[0]; guid[7] = revision[1]; } return new Guid(guid).ToString(); } } return base.EvaluateFunction(prefix, function, args); }</span></span></code> </pre><br></div></div><br>  Thus, our codes behave predictably and depend on the product version.  When we change the code a bit - we change the <i>Build number</i> (once every 2-3 weeks), something more serious - change the <i>Minor number</i> (about once every 2-3 months) to form a support assembly.  When everything is rewritten, the <i>Major number</i> changes (about once every 3-4 years). <br><br>  Let's go back to the <i>wix</i> files.  Then everything is standard: using the variables declared above, we create the <i>Product</i> block, specify the files, components, features, use the <i>Deploy.Yasen.ProductContent</i> described in the previous step. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductCode)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductName)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Language)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Manufacturer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Manufacturer)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UpgradeCode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.UpgradeCode)"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">include</span></span></span><span class="php"> $(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">var</span></span></span><span class="php">.WixCommonPath)\Deploy.Yasen.ProductContent.wxi</span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Directory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TARGETDIR"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SourceDir"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Directory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ProgramFilesFolder"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Directory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"APPLICATIONFOLDER"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.ProductName)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DiskId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Content --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Component</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Component1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Guid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{1F4A6EF3-4B65-4405-8E08-D750E5038C75}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">File</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"File1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content.txt"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\..\Incom.Yasen.Content\content.txt"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">File</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"File2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Yasen.UI.exe"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(var.Yasen.UI.TargetPath)"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Component</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Directory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Directory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Directory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ClientSide"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" $(var.ProductName)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Level</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Absent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"disallow"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ComponentRef</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Component1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Feature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h6>  Step 4. Create a patch </h6><br>  Now we have everything necessary to create installations of our product, and this can even be done, but our goal is patches. <br>  As noted in Part 1, creating patches from the command line is quite troublesome, so at this step we are writing a new utility, <i>MakeMsp</i> , which performs these steps for us.  Requirements for use will be as follows: the arguments indicate the basic assembly, the final assembly, the patch descriptor, and the path to the result. <br><pre> <code class="bash hljs">Incom.MakeMsp.exe <span class="hljs-string"><span class="hljs-string">"YasenSetup1.msi"</span></span> <span class="hljs-string"><span class="hljs-string">"YasenSetup1.0.1.msi"</span></span> <span class="hljs-string"><span class="hljs-string">"Deploy.Yasen.PatchCreation.xml"</span></span> <span class="hljs-string"><span class="hljs-string">"Patch.msp"</span></span></code> </pre><br>  In general, the algorithm is as follows: <br>  <b>1.</b> Copy both <i>msi</i> to a temporary folder <br><div class="spoiler">  <b class="spoiler_title">A piece of copy code</b> <div class="spoiler_text"><pre> <code class="cs hljs">Task.WaitAll( Task.Run( () =&gt; { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Start copying RTM..."</span></span>); File.Copy(args[<span class="hljs-number"><span class="hljs-number">0</span></span>], rtmFilePath, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Finished copying RTM..."</span></span>); }) , Task.Run( () =&gt; { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Start copying latest..."</span></span>); File.Copy(args[<span class="hljs-number"><span class="hljs-number">1</span></span>], latestFilePath, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Finished copying latest..."</span></span>); }));</code> </pre><br></div></div><br>  <b>2.</b> Remember, in step 2, when creating a <i>PatchCreation</i> , did we use unknown variables?  It is time to identify them.  For this, the utility creates a temporary file with a <i>Wix</i> structure, where the values ‚Äã‚Äãof these variables are written. <br><div class="spoiler">  <b class="spoiler_title">A piece of code to create a file with variables to create a patch</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> productName = MsiReader.GetMSIParameters(latestFilePath, <span class="hljs-string"><span class="hljs-string">"ProductName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wixPachCreationReference = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">@"&lt;?xml version=""1.0"" encoding=""utf-8""?&gt; &lt;Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'&gt; &lt;?define Family='{0}'?&gt; &lt;?define PatchFamily='{0}'?&gt; &lt;?define PatchId='{1}'?&gt; &lt;?define ProductCode='{2}'?&gt; &lt;?define PatchVersion='{3}'?&gt; &lt;?define BaseMsi='{4}'?&gt; &lt;?define NewMsi='{5}'?&gt; &lt;?include {6}?&gt; &lt;/Wix&gt;"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(Transliterate(productName).Where(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>.IsLetterOrDigit).Take(<span class="hljs-number"><span class="hljs-number">8</span></span>).ToArray()), Guid.NewGuid().ToString(), MsiReader.GetMSIParameters(latestFilePath, <span class="hljs-string"><span class="hljs-string">"ProductCode"</span></span>), MsiReader.GetMSIParameters(latestFilePath, <span class="hljs-string"><span class="hljs-string">"ProductVersion"</span></span>), Path.Combine(rtmPath, <span class="hljs-string"><span class="hljs-string">"rtm.msi"</span></span>), Path.Combine(latesPath, <span class="hljs-string"><span class="hljs-string">"last.msi"</span></span>), Path.GetFullPath(args[<span class="hljs-number"><span class="hljs-number">2</span></span>]) );</code> </pre><br></div></div><br>  As <b>PatchFamily</b> , the product name with transliteration is used.  <b>PatchId</b> - the new Guid.  <b>ProductCode</b> , <b>PatchVersion</b> - extracted from the final <i>msi</i> , <b>BaseMsi</b> and <b>NewMsi</b> - the path to the temporary <i>msi</i> (copied to a temporary folder).  At the end, <i>include</i> the file itself with <b>PatchCreation</b> . <br><br>  <b>3.</b> Next, perform the compilation steps described in Part 1. <br>  Administrative installation: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">"msiexec"</span></span>, string.Format(<span class="hljs-string"><span class="hljs-string">"/a \"{0}\" /qn TARGETDIR=\"{1}\\\""</span></span>, rtmFilePath, rtmPath)); <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">"msiexec"</span></span>, string.Format(<span class="hljs-string"><span class="hljs-string">"/a \"{0}\" /qn TARGETDIR=\"{1}\\\""</span></span>, latestFilePath, latesPath));</code> </pre><br>  Compiling and creating a patch: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">"candle"</span></span>, string.Format(<span class="hljs-string"><span class="hljs-string">"\"{0}\" -out \"{1}\\patch.wixobj\""</span></span>, Path.Combine(tempDir, <span class="hljs-string"><span class="hljs-string">"desc.xml"</span></span>), tempDir)); <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">"light"</span></span>, string.Format(<span class="hljs-string"><span class="hljs-string">"\"{0}\\patch.wixobj\" -out \"{0}\\patch.pcp\""</span></span>, tempDir)); <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">"msimsp"</span></span>, string.Format(<span class="hljs-string"><span class="hljs-string">"-s \"{0}\\patch.pcp\" -p \"{1}\" -l \"{0}\\msimsp.log\""</span></span>, tempDir, args[3]));</code> </pre><br><h6>  Step 5. Compile everything and everyone </h6><br>  Now we have everything we need: an installation project, extensions for <i>Wix</i> , a patch handle, a utility for creating a patch.  It is time to put it all together. <br>  To do this, at the root of the solution is the file <b>CompileAll.bat</b> , which will bring it all together (requires <i>framework 4.0</i> ) and put the result in the <i>Releases</i> folder.  You can see all this in the source. <br><br><h4>  Use of results </h4><br>  The result obtained after running <b>CompileAll.bat</b> . <br><br><img src="https://habrastorage.org/storage2/9ff/562/9d6/9ff5629d6863e177d8097ba4bb1fb05c.png"><br><br><h5>  Patch update </h5><br>  You can <b>install</b> version 1 simply by <b>DblClick</b> .  Result: <br><img src="https://habrastorage.org/storage2/0dc/734/ced/0dc734cedc27b5a70fe968a8d07fb75a.png"><br><br>  You can also <b>install a</b> patch according to <b>DblClick</b> : <br><img src="https://habrastorage.org/storage2/d81/099/0aa/d810990aad2354db63fcb51ece2d1744.png"><br><br>  Viewing installed updates will show this: <br><img src="https://habrastorage.org/storage2/5d4/e22/459/5d4e22459958af7cdbb78e19bf67e210.png"><br><br><h5>  Update full package </h5><br>  If we need to upgrade from version 1.0.0 to 1.0.1 using the full <i>msi</i> package, we will have to use the console with the following parameters: <br><br><pre> <code class="bash hljs">msiexec /i YasenSetup1.0.1.msi REINSTALL=ALL REINSTALLMODE=vomus</code> </pre><br>  Here: <br>  <b>REINSTALL</b> - Indicates which features will be reinstalled by this package when upgrading (we specify that all).  If we do not specify this property, then when you try to start the package (and the old version installed), the message ‚ÄúAnother version is already installed‚Äù will be displayed.  ( <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa371175(v%3Dvs.85).aspx">details</a> ) <br>  <b>REINSTALLMODE</b> is a property that indicates how exactly the reinstallation (update) of the files will take place.  ( <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa371182(v%3Dvs.85).aspx">details</a> ).  In our case it is: <br>  <b>v</b> - it is necessary to re-cache the package in the local storage.  The fact is that for each product ( <i>ProductCode</i> ), <i>Windows</i> remembers the value of the <i>Package.Id</i> from which the product was shipped.  If the product is already installed and an attempt is made to install even a package that is identical in content and version, but with a different <i>Package.Id</i> (just made a rebuild of the solution), then the cached value of <i>Package.Id</i> does not match the <i>Package.Id of the</i> new installation and a warning will be issued that another version.  In the presence of " <b>v</b> " <i>Package.Id</i> will not be checked for compliance. <br>  <b>o</b> - rewrite the file if the current version is less than new, or the file is missing. <br>  <b>m</b> - overwrites registry keys ( <i>HKEY_LOCAL_MACHINE</i> and <i>HKEY_CLASSES_ROOT</i> ) <br>  <b>u</b> - overwrites registry keys ( <i>HKEY_CURRENT_USER</i> and <i>HKEY_USERS</i> ) <br>  <b>s</b> - rewrite all shortcuts and rewrite icon cache. <br><br>  There are options for how to avoid this inconvenient way of updating and get work only on <b>DblClick</b> , but that's another story. <br><br><h4>  Summarize </h4><br>  So, the following steps were taken to solve the problem: <br>  1) Developed special requirements for writing <i>Wix</i> installations for end users, which include: <br>  a.  Put all that is possible into common files, <i>merge modules</i> and use the <i>include</i> directive. <br>  b.  Generate <i>Product.ProductCode</i> based on base value. <br>  2) Create a single project for generating patches. <br>  3) Make a special utility that will help build patches. <br><br><h4>  The final result </h4><br>  <i>Wix</i> helps solve a big headache, for which he thanks a lot. <br>  Of course, some things remained in the shadows, but the most important and valuable presented to the reader. <br><br>  Thank. <br><br>  References: <br>  All sources on <a href="https://github.com/neisbut/WixInstallersAndPatches">github</a> </div><p>Source: <a href="https://habr.com/ru/post/190654/">https://habr.com/ru/post/190654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190642/index.html">Benefit from Selenium and Jenkins CI</a></li>
<li><a href="../190644/index.html">The creators of Oculus Rift have launched a specialized game store.</a></li>
<li><a href="../190646/index.html">Animate.css - a set of cross-browser CSS3 animations</a></li>
<li><a href="../190648/index.html">We work with mail through Emacs and Wanderlust</a></li>
<li><a href="../190652/index.html">Twitter Bootstrap 3.0 Released</a></li>
<li><a href="../190658/index.html">We generate PDF from an HTML template with conditions using wkhtmltopdf and RazorEngine</a></li>
<li><a href="../190660/index.html">Here is your pizza. Pay by card or cash?</a></li>
<li><a href="../190662/index.html">57 rules startups</a></li>
<li><a href="../190664/index.html">Methods of anonymity online. Part 2. Data Leaks</a></li>
<li><a href="../190666/index.html">PRIMERGY RX900 S2: Fujitsu monolithic 8-processor server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>