<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing Services in MSWin (Part Two)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In addition to the habratopics about writing services, I will mention one more possibility - launching applications on behalf of the current terminal ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing Services in MSWin (Part Two)</h1><div class="post__text post__text-html js-mediator-article">  In addition to the habratopics about writing services, I will mention one more possibility - launching applications on behalf of the current terminal user. <br><br>  This is convenient if you choose the option of managing the service and its interaction with the user on the principle that the service is not interactive and is running on behalf of the Local System, and the application must be running on behalf of the user. <a name="habracut"></a><br><br>  First, there is a mechanism in the service management system that allows you to receive a message about connecting a new terminal user and disconnecting the current one. <br>  Secondly, you can run any application on behalf of the current terminal user. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Personally, it is more convenient for me when both the service and the user application are located in the same executable file, but this is rather a personal whim, and no one limits the programmer to this. <br><br>  Starting from <b>Windows XP</b> / <b>Windows 2003 Server</b> , the following <b>SERVICE_CONTROL_SESSIONCHANGE</b> message may <b>appear</b> in the service event handler, indicating that the user has changed the session (disconnecting from the session, creating a new one, etc.) Unfortunately, this is not provided in <b>Windows 2000</b> , therefore (if this version is listed in the target list) it should be borne in mind that even the definition of this message in <i>windows.h is</i> framed by checking the _WIN32_WINNT define. <br><br>  As a result, the message handler is supplemented with approximately the following code: <br><blockquote><code><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> <font color="black">Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> <ol> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; <font color="#cc6633">#endif</font></font></code> </li> <li> <code><font color="black"><font color="#cc6633"><a href="http://s-c.me/6892/s"></a> <a href="http://s-c.me/6892/h"></a> Copy Source | Copy HTML <font color="#cc6633">#if</font> (_WIN32_WINNT &gt; <font color="#A31515">0x0500</font> ) <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE: <font color="#0000ff">if</font> (dwEventType == WTS_SESSION_LOGON) { system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"service accept SESSION LOGON signal"</font> ); <font color="#0000ff">if</font> (!run_gui()) system_logger_t::instance()-&gt;trace_info(L <font color="#A31515">"[ERROR] creating GUI window for service failed"</font> ); } <font color="#0000ff">break</font> ; #endif</font></font></code> </li> </ol></blockquote><br><br>  Actually launching an executable file of the service on behalf of the current terminal user, but with the <i>gui</i> key: <br><blockquote> <code><a href="http://s-c.me/6894/s"></a> <a href="http://s-c.me/6894/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">/ *</font> &lt;br/&gt; <font color="#008000">* /</font> </li><li>  <font color="#0000ff">bool</font> service_t :: run_gui () </li><li>  { </li><li>  HANDLE l_hToken = NULL; </li><li>  STARTUPINFOW l_startInfo; </li><li>  PROCESS_INFORMATION l_processInfo; </li><li>  <font color="#2b91af">ULONG</font> l_SID = - <font color="#A31515">1</font> ; </li><li>  memset (&amp; l_startInfo, <font color="#A31515">0x00</font> , <font color="#0000ff">sizeof</font> (STARTUPINFOW)); </li><li>  memset (&amp; l_processInfo, <font color="#A31515">0x00</font> , <font color="#0000ff">sizeof</font> (PROCESS_INFORMATION)); </li><li>  l_startInfo.cb = <font color="#0000ff">sizeof</font> (STARTUPINFOW); </li><li>  l_SID = static_cast &lt; <font color="#2b91af">ULONG</font> &gt; (WTSGetActiveConsoleSessionId ()); </li><li>  <font color="#0000ff">if</font> (l_SID! = - <font color="#A31515">1</font> ) </li><li>  { </li><li>  <font color="#0000ff">if</font> (WTSQueryUserToken (l_SID, &amp; l_hToken)! = FALSE) </li><li>  { </li><li>  std :: wstringstream l_wss; </li><li>  l_wss &lt;&lt; get_path () &lt;&lt; get_name (); </li><li>  <font color="#0000ff">if</font> (CreateProcessAsUserW ( </li><li>  l_hToken </li><li>  l_wss.str (). c_str (), </li><li>  L <font color="#A31515">"/ gui"</font> , </li><li>  Null </li><li>  Null </li><li>  FALSE, </li><li>  CREATE_DEFAULT_ERROR_MODE, </li><li>  Null </li><li>  Null </li><li>  &amp; l_startInfo, </li><li>  &amp; l_processInfo)! = FALSE) </li><li>  { </li><li>  system_logger_t :: instance () -&gt; trace_info ( </li><li>  L <font color="#A31515">"creating GUI window for service succeeded"</font> </li><li>  ); </li><li>  <font color="#0000ff">return true</font> ; </li><li>  } </li><li>  } </li><li>  } </li><li>  <font color="#0000ff">return false</font> ; </li><li>  } </li><li>  <font color="#008000">// ------------------------------------------------ ---------------------------</font> </li></ol></blockquote><br><br>  It only remains to recall that the application should be able to run only one copy if the service processes only <b>WTS_SESSION_LOGON</b> , and for this it is enough to create a named mutex whose name starts with <i>L ‚ÄúLocal \\‚Äù</i> .  This will create a mutex within the current user session.  If the application instance must exist in one copy in principle, then we create a mutex ‚Äúname‚Äù which starts with <i>L ‚ÄúGlobal \\‚Äù</i> and do not forget that in this case the application should have time to delete the mutex even in case of emergency completion. </div><p>Source: <a href="https://habr.com/ru/post/91497/">https://habr.com/ru/post/91497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91487/index.html">About colors and inputs</a></li>
<li><a href="../91490/index.html">Present your startup without leaving home? Easy!</a></li>
<li><a href="../91491/index.html">Apple Launches Developer Decode Video Decode Acceleration Framework</a></li>
<li><a href="../91492/index.html">The game "Shark business"</a></li>
<li><a href="../91495/index.html">Changes in the infrastructure of tools for programmers</a></li>
<li><a href="../91498/index.html">Venture hitting. Or sometimes they come back.</a></li>
<li><a href="../91499/index.html">Planting trees with jqGrid</a></li>
<li><a href="../91500/index.html">Cross-browser text-overflow \ (^ _ ^) /</a></li>
<li><a href="../91503/index.html">Why do we need virtualization?</a></li>
<li><a href="../91507/index.html">‚ÄúOnce again about the naked king‚Äù or as I tested SAP B1 (sap business one)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>