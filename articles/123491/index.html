<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MS SQL 2011 - New Offset Operator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The new SQL Server 2011 (Denali) extends the capabilities of the Order By command with the help of two long-awaited additional commands: 


- Offset 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MS SQL 2011 - New Offset Operator</h1><div class="post__text post__text-html js-mediator-article">  The new SQL Server 2011 (Denali) extends the capabilities of the Order By command with the help of two long-awaited additional commands: <br><ul><li>  Offset </li><li>  Fetch First or Fetch Next ( <strong>take the first ...</strong> or <strong>take the following ...</strong> ) </li></ul><br><br><h2>  Offset </h2><br>  Using this command allows you to skip the specified number of lines before displaying the results of the query.  What is meant by this: Suppose we have 100 entries in the table and need to skip the first 10 lines and print lines 11 to 100. Now this is easily solved by the following query: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> &lt;SomeTable&gt; <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> &lt;SomeColumn&gt; <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  For those comrades who practice .Net, the extension method for <strong>Skip</strong> collections, which skips the specified number of lines, should be familiar.  So the expression <strong>Offset</strong> works the same way.  After the data is ordered in some way, you can use the expression Offset. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Situations in which the expression Offset can be used </h3><br>  In all subsequent examples on Offset will use a data set constructed as a result of this script: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    Declare @tblSample Table ( [Person Name] Varchar(50) ,Age int ,Address Varchar(100) ) --   Insert into @tblSample Select 'Person Name' + CAST(Number AS VARCHAR) , Number ,'Address' + CAST(Number AS VARCHAR) From master..spt_values Where Type = 'p' And Number Between 1 and 50</span></span></code> </pre> <br>  <strong>Task 1. Skip the first 10 entries and show the rest.</strong> <br><br>  The script will be simple. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span></code> </pre> <br>  Or <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> (<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  The output will be as follows: <br><pre> <code class="sql hljs">Person Name     Age     Address Person Name11   11     Address11 Person Name12   12      Address12 . . . . . . . . . . . . . . . . . . . .. . . . . . . . . Person Name49   49      Address49 Person Name50   50      Address50</code> </pre> <br>  It does not matter which word to use after specifying the number of rows: <strong>Row</strong> or <strong>Rows</strong> - they are synonymous in this case. <br><br>  <strong>Task 2. Transfer the number of rows to skip as a variable</strong> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--       -    Declare @RowSkip As int --      Set @RowSkip = 10 --   Select * From @tblSample Order by Age Offset @RowSkip Row</span></span></code> </pre> <br>  <strong>Task 3. Set the number of lines to skip as an expression</strong> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    14  50 Select * From @tblSample Order by Age Offset (select MAX(number)/99999999 from master..spt_values) Rows</span></span></code> </pre> <br>  The <em>select</em> expression <em>MAX (number) / 99999999 from master..spt_values</em> returns the number 14. <br><br>  <strong>Task 4. Set the number of rows to skip as a user-defined function</strong> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dbo.fn_test()) <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  Code for scalar user function <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fn_test() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @ResultVar <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> @ResultVar = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> @ResultVar <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  <strong>Task 5. Using Offset with Order by inside views (view), functions, subqueries, nested tables, common table expressions (CTE).</strong> <br><br>  For example, use in general terms. <br><pre> <code class="sql hljs">;<span class="hljs-keyword"><span class="hljs-keyword">With</span></span> Cte <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">By</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> Cte</code> </pre> <br>  The example below shows the use of Offset and Order by within a nested table. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> Age &gt;<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">By</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> PersonDerivedTable</code> </pre> <br>  And another example of the work Offset and Order with views. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  view Create View vwPersonRecord AS Select * FROM tblSample GO --    view Select * From vwPersonRecord Where Age &gt; 10 Order By Age Offset 10 Rows</span></span></code> </pre> <br><br><h3>  When Offset Will Not Work </h3><br>  1. Since this is an ‚Äúextension method‚Äù, nothing will work without an order by clause. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> (<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  Report an error <br><br>  <strong><em>Msg 102, Level 15, State 1, Line 21 Incorrect syntax near '10'.</em></strong> <br><br>  2. You can not set a negative value for Offset. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> (<span class="hljs-number"><span class="hljs-number">-10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  SQL Server engine will issue <br><br>  <strong><em>Msg 10742, Level 15, State 1, Line 22 The offset specified in the OFFSET clause may not be negative.</em></strong> <br><br>  3. It is impossible to set values ‚Äã‚Äãother than integer type. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  or <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-literal"><span class="hljs-literal">Null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  Will give us <br><br>  <strong><em>Msg 10743, Level 15, State 1, Line 24 clause must be an integer.</em></strong> <br><br>  4. Cannot be used inside an <strong>Over ()</strong> expression. <br><pre> <code class="sql hljs">;<span class="hljs-keyword"><span class="hljs-keyword">With</span></span> Cte <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> *, Rn = Row_Number() <span class="hljs-keyword"><span class="hljs-keyword">Over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample ) <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Cte</code> </pre> <br>  During the execution of the request will receive a message <br><br>  <strong><em>Msg 102, Level 15, State 1, Line 22 Incorrect syntax near 'Offset'.</em></strong> <br><br><h2>  Using Fetch First / Fetch Next </h2><br>  These keywords are used to specify the number of returned rows after skipping an array of strings using the Offset expression.  Imagine that we have 100 lines and we need to skip the first 10 and get the next 5 lines.  Those.  you need to get lines 11 through 15. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> &lt;SomeTable&gt; <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> &lt;SomeColumn&gt; <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span>; <span class="hljs-comment"><span class="hljs-comment">--  Fetch First 5 Rows Only</span></span></code> </pre> <br>  Such a query will return the expected number of rows.  Programmers on .Net will immediately recall Take expansion method. <br><br>  Next, consider the situations where you can apply these keywords. <br><br>  <strong>Task 1. Skip the first 10 entries and get the next 5</strong> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> @tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">First</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span></code> </pre> <br>  The result will be: <br><pre> <code class="sql hljs">Person Name     Age     Address Person Name11   11      Address11 Person Name12   12      Address12 Person Name13   13      Address13 Person Name14   14      Address14 Person Name15   15      Address15</code> </pre> <br>  <strong>Task 2. Set the number of lines to display using a variable</strong> <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     Declare @RowSkip As int --    -   Declare @RowFetch As int -- -    Set @RowSkip = 10 -- -    Set @RowFetch = 5 --    11  15 Select * From @tblSample Order by Age Offset @RowSkip Row Fetch Next @RowFetch Rows Only;</span></span></code> </pre> <br>  In general and in general, with these keywords you can do everything the same as with Offset.  Subqueries, views, functions, etc. <br><br><h3>  When Fetch First / Fetch Next Will Not Work </h3><br>  The restrictions on these keywords completely coincide with the restrictions on the Offset. <br><br><h2>  Offset and Fetch Next for Sql Server 2005/2008 </h2><br>  In previous versions of SQL Server, you could get the same functionality by applying the Row_Number () ranking function.  Of course, the code was not so elegant and concise, for example: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--      Declare @RowSkip As int --    -    Declare @RowFetch As int --   Set @RowSkip = 10 Set @RowFetch = 5 ;With Cte As ( Select rn=ROW_NUMBER() Over(Order by (Select 1) /*    */ ) ,* From @tblSample ) --    11  15 Select [Person Name] ,Age ,Address From Cte --   Offset  Fetch First/Fetch Next Where rn Between (@RowSkip+1) --  Offset And (@RowSkip+ @RowFetch) --  Fetch First/Fetch Next Clause</span></span></code> </pre> <br>  Inside the CTE, a service column is generated that simply numbers the lines, after which the lines are filtered by this field.  The method is not the fastest as you know. <br><br><h2>  Offset and Fetch Next for Sql Server 2000 </h2><br>  For these ancient servers there was no ranking function, but even then the discussed functionality could be repeated.  Then temporary tables with an auto incremental field were used.  Sample script: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @RowSkip <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @RowFetch <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> @RowSkip = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> @RowFetch = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-comment"><span class="hljs-comment">--   ,    IF OBJECT_ID('tempdb..#Temp') IS NOT NULL BEGIN Drop Table #Temp END --   Create Table #Temp ( Rn int Identity ,[Person Name] Varchar(50) ,Age int ,Address Varchar(100) ) --    Insert Into #Temp([Person Name],Age,Address) Select [Person Name],Age,Address From @tblSample --    11  15 Select [Person Name] ,Age ,Address From #Temp --   Offset  Fetch First/Fetch Next Where Rn Between (@RowSkip+1) --  Offset And (@RowSkip+ @RowFetch) --  Fetch First/Fetch Next</span></span></code> </pre> <br>  In this script, a temporary table is first created where the data from the target table is overwritten.  And in the temporary table there is an auto-incremental field, according to which then the necessary rows are requested. <br><br><h2>  The practical use of Offset and Fetch with measurements of time and resources </h2><br>  I am sure that all the previous explanations about the use and purpose of Offset and Fetch led you to a clear understanding of why they are needed and where they can be used.  Born ideas for optimizing existing code.  Next, we consider an example from real practice, when an Offset can be useful.  There will also be results of performance measurements on different SQL servers.  Tests will be run on a sample of 1 million lines. <br><br>  To begin, create an <a href="http://databasechallenges.com/SQLServer/toolbox/tally-table">invoice table</a> for the following script. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   tblSample,    IF OBJECT_ID('tblSample','U') IS NOT NULL BEGIN DROP TABLE tblSample END GO --   Create Table tblSample ( [Person ID]     Int Identity ,[Person Name] Varchar(100) ,Age Int ,DOB Datetime ,Address Varchar(100) ) GO --     Insert into tblSample Select 'Person Name' + CAST(N AS VARCHAR) , N ,DATEADD(D,N, '1900-01-01') ,'Address' + CAST(N AS VARCHAR) From dbo.tsqlc_Tally Where N Between 1 and 1000000 --   Select * From tblSample</span></span></code> </pre> <br><br><h3>  Paging through server-side data </h3><br>  Page by page view is the most common function in record viewing systems from any database.  Now it is possible to do this both on the client side and on the server side.  Paging on the client side means loading the entire table or a very large part of it into memory in order to programmatically make pagination.  On the other hand, this can be done on the server side, then the application will receive only the data that it has requested to display the desired page.  With this approach, time is reduced for sending data, post-processing and storing them in memory.  Those.  There is a significant acceleration of application performance. <br><br>  For the purpose of the experiment, we will skip the first 20,000 entries and take the next 50,000. <br><br><h4>  Approach for SQL Server 2000 </h4><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--      DBCC DROPCLEANBUFFERS DBCC FREEPROCCACHE USE TSQLDB; GO SET STATISTICS IO ON; SET STATISTICS TIME ON; GO --    Declare @RowSkip As int Declare @RowFetch As int --     Set @RowSkip = 20000 Set @RowFetch = 50000 --  ,    IF OBJECT_ID('tempdb..#Temp') IS NOT NULL BEGIN Drop Table #Temp END --    Create Table #Temp ( Rn int Identity ,[Person ID] int ,[Person Name] Varchar(50) ,Age int ,DOB datetime ,Address Varchar(100) ) --      Insert Into #Temp([Person ID],[Person Name],Age,DOB,Address) Select [Person ID],[Person Name],Age,DOB,Address From dbo.tblSample --    20 000  70 000 Select [Person ID] ,[Person Name] ,Age ,DOB ,Address From #Temp --   Offset  Fetch First/Fetch Next Where Rn Between (@RowSkip+1) --  Offset And (@RowSkip+ @RowFetch) --  Fetch First/Fetch Next GO SET STATISTICS IO OFF; SET STATISTICS TIME OFF; GO</span></span></code> </pre> <br>  I think that the previous examples and comments are enough to understand the work of the script. <br><br>  <strong>Lead time:</strong> <br><br>  SQL Server Execution Times: <br>  CPU time = 110 ms, elapsed time = 839 ms. <br><br>  <strong>Input / Output Statistics:</strong> <br>  Scan count 1, <br>  logical reads 8037, <br>  physical reads 0, <br>  read-ahead reads 0, <br>  lob logical reads 0, <br>  lob physical reads 0, <br>  lob read-ahead reads 0. <br><br><h4>  Approach for SQL Server 2005/2008 </h4><br><pre> <code class="sql hljs">DBCC DROPCLEANBUFFERS DBCC FREEPROCCACHE <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> TSQLDB; GO <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @RowSkip <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @RowFetch <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> @RowSkip = <span class="hljs-number"><span class="hljs-number">20000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> @RowFetch = <span class="hljs-number"><span class="hljs-number">50000</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">With</span></span> Cte <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> rn=ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">Over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)) ,* <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> dbo.tblSample ) <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> [Person <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] ,[Person <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] ,Age ,DOB ,Address <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> Cte <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> rn <span class="hljs-keyword"><span class="hljs-keyword">Between</span></span> (@RowSkip+<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;em&gt; &lt;/em&gt; <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> (@RowSkip+ @RowFetch) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>; GO</code> </pre> <br><br><br>  <strong>Lead time:</strong> <br><br>  SQL Server Execution Times: <br>  CPU time = 78 ms, elapsed time = 631 ms. <br><br>  <strong>Input / Output Statistics:</strong> <br>  Scan count 1, <br>  logical reads 530, <br>  physical reads 0, <br>  read-ahead reads 1549, <br>  lob logical reads 0, <br>  lob physical reads 0, <br>  lob read-ahead reads 0. <br><br><h4>  Approach for SQL Server 2011 </h4><br><pre> <code class="sql hljs">DBCC DROPCLEANBUFFERS DBCC FREEPROCCACHE <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> TSQLDB; GO <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @RowSkip <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @RowFetch <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> @RowSkip = <span class="hljs-number"><span class="hljs-number">20000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> @RowFetch = <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> dbo.tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> @RowSkip <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> @RowFetch <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>; GO</code> </pre> <br>  <strong>Lead time</strong> <strong>:</strong> <br><br>  SQL Server Execution Times: <br>  CPU time = 47 ms, elapsed time = 626 ms. <br><br>  <strong>Input / Output Statistics:</strong> <br>  Scan count 1, <br>  logical reads 530, <br>  physical reads 0, <br>  read-ahead reads 1549, <br>  lob logical reads 0, <br>  lob physical reads 0, <br>  lob read-ahead reads 0. <br>  The most interesting result on the use of processor time (CPU Time) and the execution time (Elapsed Time - the time taken to execute the request).  Comparison of measurements is presented below: <br><table border="1"><tbody><tr><td>  <strong>Sql Server Version</strong> </td><td>  <strong>CPU Time</strong> </td><td>  <strong>Elapsed time</strong> </td></tr><tr><td>  2000 </td><td>  110ms </td><td>  839 ms </td></tr><tr><td>  2005/2008 </td><td>  78ms </td><td>  631 ms </td></tr><tr><td>  2011 </td><td>  46ms </td><td>  626 ms </td></tr></tbody></table><br><br><br>  The table clearly shows that the new SQL Server runs noticeably faster than previous versions.  Naturally, the timing of your machine may vary, but the performance of the new server will always be higher. <br><br><h3>  Alternative to TOP </h3><br>  New features Denali in some situations can be a substitute for the expression TOP. <br>  For example, take the situation when you need to get the first 10 records sorted in descending order of any parameter. <br><br>  <strong>Approaches on previous versions</strong> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> Top(<span class="hljs-number"><span class="hljs-number">10</span></span>) [Person <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] ,[Person <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] ,Age ,DOB ,Address <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> dbo.tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">By</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Desc</span></span></code> </pre> <br>  <strong>Approach possible in SQL Server Denali</strong> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> [Person <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] ,[Person <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] ,Age ,DOB ,Address <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> dbo.tblSample <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">By</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">Desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span></code> </pre> <br>  <i>As noted in the <a href="http://habrahabr.ru/blogs/sql/123491/">comments,</a> this is the wrong code and will return the result inverse Top (10).</i> <br><br>  <i>Transfers from the cycle:</i> <i><br></i>  <i>MS SQL Server 2011: <a href="http://habrahabr.ru/blogs/htranslations/123345/">Autonomous databases</a> , <a href="http://habrahabr.ru/blogs/sql/123446/">new Sequence object</a> , <a href="http://habrahabr.ru/blogs/sql/123491/">Offset operator</a> , <a href="http://habrahabr.ru/blogs/sql/123507/">error handling</a> , <a href="http://habrahabr.ru/blogs/sql/123573/">With Result Set construction</a> , <a href="http://habrahabr.ru/blogs/sql/123664/">new in SSMS</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/123491/">https://habr.com/ru/post/123491/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123480/index.html">Postsharp. We solve the problem of caching</a></li>
<li><a href="../123484/index.html">Testers! All on Ciklum QA Subbotnik (July 16)!</a></li>
<li><a href="../123485/index.html">New efficiency record for solar cells</a></li>
<li><a href="../123489/index.html">DataRetriever - a service for collecting and analyzing data from online media and social networks</a></li>
<li><a href="../123490/index.html">Web interface for iptables</a></li>
<li><a href="../123496/index.html">Mashable: Google abandons Blogger and Picasa brands in favor of Google+</a></li>
<li><a href="../123501/index.html">Pdf.js passed the first pixel test</a></li>
<li><a href="../123502/index.html">Using MongoDB in Java EE 6</a></li>
<li><a href="../123504/index.html">Fun with Google's Street View</a></li>
<li><a href="../123507/index.html">MS SQL 2011 - Error Handling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>