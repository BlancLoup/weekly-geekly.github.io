<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization of users who have cookies blocked</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All browsers have an option that allows you to prohibit the receipt of cookies from third-party sites (for example, from an iframe with a domain other...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization of users who have cookies blocked</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/aad/276/fbe/aad276fbeffdb1e7ae843ccdbd83077f.jpg" align="right">  All browsers have an option that allows you to prohibit the receipt of cookies from third-party sites (for example, from an iframe with a domain other than the current one).  In some browsers (hello, Apple) this feature is enabled by default, but often users turn it on independently and safely forget about it, as a result of which the developer cannot write the necessary data into cookies or localstorage.  For example, when developing applications for VKontakte, you may encounter such a problem. <br><br>  I want to share a simple and elegant solution how to get around this limitation. <br><a name="habracut"></a><br><br>  In principle, when we have any other way to identify the user, this problem is not so acute, you can always write down or retrieve the necessary data from the database.  But for small applications, this is an additional load, especially if you need to store a couple of lines. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fortunately, the VKontakte API has <a href="http://vk.com/developers.php%3Foid%3D-1%26p%3Dstorage.set">methods for storing data</a> on the VK servers (key-value storage).  We can only write and read data from there.  But we will try to make it as beautiful as possible. <br><br>  Suppose that we need to write some user data in cookies (for example, <a href="http://vk.com/app3079606">we</a> need to store a user authentication token on Instagram).  The main idea is to record data both in the cookie and in the VKontakte storage, and then as quickly as possible. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-string"><span class="hljs-string">'abcde'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,       document.cookie = "userdata="+data+"; path=/; expires=Tue, 31 Dec 2013 23:59:59 GMT"; //         //     //        VK.api('storage.set', { key: 'userdata', value: data }, function(response) { //     ,   GET-   window.location = "/page_for_logined_users?userdata="+data; });</span></span></code> </pre> <br>  In the example above, we redirected the user to some page where the recorded data is required (in our application, this is the main page that uses the received token).  It is clear that the next time the application is loaded, this data will disappear from the GET ‚Äì parameter and remain only in the VC repository.  Of course, we can get them using the Javascript API, but we are writing an elegant solution ;-). <br><br>  To be able to get our data on the server side of the application, we must fill in the ‚ÄúFirst API request‚Äù field in the application settings: <br><br><img src="https://habrastorage.org/storage2/e16/120/76e/e1612076e56fb82ea3c8ead5ca972703.png"><br><br><pre> <code class="javascript hljs">method=storage.get&amp;key=userdata&amp;format=json&amp;v=<span class="hljs-number"><span class="hljs-number">3.0</span></span></code> </pre><br>  Thus, VKontakte when accessing our application will be transmitted by the GET ‚Äì parameter <b>api_result</b> - there will be a JSON object with our cookie in it.  Also, nothing prevents you from checking for cookies in nginx (if you change format to xml): <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$arg_api_result</span></span> ~ <span class="hljs-string"><span class="hljs-string">"%3Cresponse%3E(.*)%3C%2Fresponse%3E"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$userdata</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; rewrite ^ /page_for_logined_users?userdata=<span class="hljs-variable"><span class="hljs-variable">$userdata</span></span>? redirect; }</code> </pre><br>  So, on the server side, we can do something like: <br><pre> <code class="php hljs">$userdata = (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_COOKIE[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>])) ? $_COOKIE[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>] : (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>])) ? $_GET[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>] : <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;</code> </pre><br>  and get the data safe and sound.  If without the proposed perversions with nginx, then it suffices to parse <b>api_result</b> : <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'api_result'</span></span>])) { $data = json_decode($_GET[<span class="hljs-string"><span class="hljs-string">'api_result'</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>); $userdata = (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($data[<span class="hljs-string"><span class="hljs-string">'response'</span></span>])) ? $data[<span class="hljs-string"><span class="hljs-string">'response'</span></span>] : <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br><br>  PS Also, taking this opportunity, I offer you an interesting way to optimize the load using the above method.  For example, in the application, we need a certain token, which we store in cookies or in the VK storage.  However, the application itself is a static html file, in which the server language, for example, is needed only to insert this token into the application.  Of course, we can request from JS the necessary cookie or data from the VKontakte store, but we are writing an elegant solution ;-). <br><br>  So, you can configure nginx (or Apache) as follows: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    if ($http_cookie ~ "userdata") { set $token $cookie_userdata; set $gotohtml "1"; } #     API if ($arg_api_result ~ "%3Cresponse%3E(.*)%3C%2Fresponse%3E") { set $token $1; set $gotohtml "1"; } #     (http://example.com/) if ($request_uri != /$is_args$args) { set $gotohtml ""; } #      if ($gotohtml ~ 1) { rewrite ^ /index.html#$token? redirect; }</span></span></code> </pre><br>  Well, in Javascript get the necessary data: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.hash.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  In this way, we will be able to send all logged users to the html file (which nginx will return very quickly), passing any necessary parameters to the hash.  And the file itself can generally be transferred to a CDN, thereby further reducing the load on your server. </div><p>Source: <a href="https://habr.com/ru/post/150644/">https://habr.com/ru/post/150644/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150635/index.html">S02.01. Space Odyssey</a></li>
<li><a href="../150636/index.html">Code of honor</a></li>
<li><a href="../150637/index.html">1760GB of DDR-III memory. Getting ready for September</a></li>
<li><a href="../150639/index.html">Hyphen or underscore instead of a space in the URL</a></li>
<li><a href="../150642/index.html">Would you like to have polls on Habr√© were not in the tape, but in the q & a section?</a></li>
<li><a href="../150647/index.html">WebOS beta is available for developers.</a></li>
<li><a href="../150648/index.html">IconBIT STB330DVBT2 review: Affordable TV set-top box with support for DVB-T2 or preparing a sleigh from summer</a></li>
<li><a href="../150649/index.html">Valve like open source technology</a></li>
<li><a href="../150650/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ20 (August 25 - 31, 2012)</a></li>
<li><a href="../150651/index.html">Ruby NoName Podcast S04E16</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>