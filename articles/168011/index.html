<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage Windows services using PowerShell. Part 3. Configuring Services with WMI and CIM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to publish translations of articles published on the 4sysops.com portal dedicated to managing Windows services using PowerShell. In the tw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage Windows services using PowerShell. Part 3. Configuring Services with WMI and CIM</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/eef/1be/c68/eef1bec6878c24a31ad68b76ed06356e.jpg"><br>  We continue to publish translations of articles published on the <a href="http://4sysops.com/">4sysops.com</a> portal dedicated to managing Windows services using PowerShell.  In the two previous posts, the issues of obtaining the status of services on the local and remote computers ( <a href="http://habrahabr.ru/company/netwrix/blog/166289/">here</a> ) and the basic aspects of managing services (start, stop, pause, etc.) were discussed.  This post will explain how to use WMI and CIM for configuring services on remote computers. <br><br>  <b>Previous articles:</b> <br>  <a href="http://habrahabr.ru/company/netwrix/blog/166289/">Manage Windows services using PowerShell.</a>  <a href="http://habrahabr.ru/company/netwrix/blog/166289/">Part 1. Get the status of services</a> <br>  <a href="http://habrahabr.ru/company/netwrix/blog/167171/">Manage Windows services using PowerShell.</a>  <a href="http://habrahabr.ru/company/netwrix/blog/167171/">Part 2. Stop, start, pause.</a> <br><br><a name="habracut"></a><br>  In the last article, I showed a couple of examples of using <b>Set-Service</b> to configure services.  However, there are some limitations, especially when we work with services on remote machines.  This is partly due to the fact that cmdlets such as <b>Get-Service</b> and <b>Set-Service</b> are designed to work with a service object, which is expressed through the .NET Framework - System.ServiceProcess.ServiceController.  From the point of view of the administrator, there is no useful information in such an object definition, for example, under which account the service is running.  Fortunately, Windows Management Instrumentation (WMI) comes to our rescue. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  We use WMI </h4><br>  We can use <b>Get-WmiObject</b> to retrieve an instance of the service object.  I will demonstrate in PS 3.0 on Windows 8, but the same team should work and PS 2.0.  Find those services whose class is Win32_Service. <br><br><pre><code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service | format-table</code> </pre> <br><img src="https://habrastorage.org/storage2/52a/495/787/52a4957879c2cef4de9ce2091569c1af.png"><br><br>  I formatted the output of the command to make it easier to read.  And now let's take a look at a separate service. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"name='bits'"</span></span> ExitCode : <span class="hljs-number"><span class="hljs-number">0</span></span> Name : BITS ProcessId : <span class="hljs-number"><span class="hljs-number">876</span></span> StartMode : Auto State : Running Status : OK</code> </pre><br><br>  To get other properties, use the following command. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"name='bits'"</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> *</code> </pre><br><br>  The output is shown in the screenshot. <br><br><img src="https://habrastorage.org/storage2/9a3/c14/328/9a3c14328226aaf02aa5ecaa8253c973.png"><br><br>  Now you know the properties of the service, and you can create refinement queries using the <b>‚ÄìFilter</b> parameter. <br><br><h4>  We get the type of startup </h4><br><br>  The <b>StartMode</b> property indicates whether the service starts automatically or must be started manually.  When you find out, you can use the following commands: <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"StartMode &lt;&gt;'disabled'"</span></span> | sort StartMode | format-table -GroupBy StartMode -<span class="hljs-keyword"><span class="hljs-keyword">Property</span></span> Name,State,PathName -AutoSize</code> </pre><br><br>  The team will bring us a table grouped by download type with new key properties.  Run it yourself and look at the result. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"startmode='auto' AND state&lt;&gt;'Running'"</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> Name,State Name State ---- ----- MMCSS Stopped RemoteRegistry Stopped sppsvc Stopped wuauserv Stopped</code> </pre><br><br>  I request information about local services, but the same can be done on remote machines <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"startmode='auto' AND state&lt;&gt;'Running'"</span></span> -computername chi-dc01,chi-dc02,chi-dc03 | <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> Name,State,Systemname Name State Systemname ---- ----- ---------- sppsvc Stopped CHI-DC01 sppsvc Stopped CHI-DC02 VMTools Stopped CHI-DC02 RemoteRegistry Stopped CHI-DC03 ShellHWDetection Stopped CHI-DC03 sppsvc Stopped CHI-DC03 wuauserv Stopped CHI-DC03</code> </pre><br><br><h4>  We get the account under which the service is running </h4><br><br>  You can also get an account under which the service is running using WMI.  In WMI, this is the <b>Startname</b> property. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -comp chi-ex01 | group startname Count Name Group ----- ---- ----- <span class="hljs-number"><span class="hljs-number">95</span></span> localSystem {\\CHI-EX01\root\cimv2:Win32_Service.Name=<span class="hljs-string"><span class="hljs-string">"AeLook... 36 NT AUTHORITY\LocalService {\\CHI-EX01\root\cimv2:Win32_Service.Name="</span></span>ALG<span class="hljs-string"><span class="hljs-string">", ... 24 NT AUTHORITY\NetworkSe... {\\CHI-EX01\root\cimv2:Win32_Service.Name="</span></span>aspnet...</code> </pre><br><br>  And of course, you can filter on this property. <br><br><img src="https://habrastorage.org/storage2/ac6/131/7ab/ac61317ab1245e13f62d907150c26190.png"><br><br>  This is very convenient if you are looking for services running under a specific account, for example, a domain administrator. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-wmiobject win32_service -computer $computers -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"startname like '%administrator%'"</span></span>| <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> Name,startmode,state,startname,systemname Name : BITS startmode : Manual state : Stopped startname : .\Administrator systemname : CHI-EX01 Name : PeerDistSvc startmode : Manual state : Stopped startname : Administrator@GLOBOMANTICS.local systemname : CHI-WIN8<span class="hljs-number"><span class="hljs-number">-01</span></span></code> </pre><br><br>  Using one simple command, I found those services that are running under a specific administrator account. <br><br><h4>  We use CIM </h4><br><br>  In PowerShell 3.0, you can use <a href="http://blogs.msdn.com/b/powershell/archive/2012/08/24/introduction-to-cim-cmdlets.aspx">CIM cmdlets</a> to perform the same queries.  The advantages of CIM are related to remote work with PowerShell. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-ciminstance win32_service -comp chi-dc01</code> </pre><br><br><img src="https://habrastorage.org/storage2/3be/360/875/3be360875a2824da1d7a705f7eb40133.png"><br><br>  Filters work in a similar way. <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-ciminstance win32_service -<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"startmode='auto' AND state&lt;&gt;'Running'"</span></span> -comp chi-ex01 | <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> Name,State,Systemname Name State Systemname ---- ----- ---------- clr_optimization_v4<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.30319</span></span>_32 Stopped CHI-EX01 clr_optimization_v4<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.30319</span></span>_64 Stopped CHI-EX01 MSExchangeProtectedServiceHost Stopped CHI-EX01 MSExchangeRPC Stopped CHI-EX01 MSExchangeSA Stopped CHI-EX01 MSExchangeServiceHost Stopped CHI-EX01 ShellHWDetection Stopped CHI-EX01 sppsvc Stopped CHI-EX01</code> </pre><br><br>  As you can see in the output, there are some issues with Exchange.  With them and them like we will understand in the next article. <br><br><h4>  Total </h4><br>  Using WMI or CIM is a good way to get service configuration reports for your environment.  The Win32_Service class contains a lot of useful information.  Plus You can run long queries with the <b>‚ÄìAsjob</b> parameter or use alternative credentials.  You can always do this with <b>Get-Service</b> , but it takes a lot of time.  In the next article, we will look at how to change services using WMI and CIM. <br><br>  Upd: <br>  The post is a translation of an article from the portal <a href="http://4sysops.com/">4sysops.com</a> <br>  <a href="http://4sysops.com/archives/managing-services-the-powershell-way-part-5/">Managing Services the PowerShell way - Part 5</a> <br><br>  <b>Previous articles:</b> <br>  <a href="http://habrahabr.ru/company/netwrix/blog/166289/">Manage Windows services using PowerShell.</a>  <a href="http://habrahabr.ru/company/netwrix/blog/166289/">Part 1. Get the status of services</a> <br>  <a href="http://habrahabr.ru/company/netwrix/blog/167171/">Manage Windows services using PowerShell.</a>  <a href="http://habrahabr.ru/company/netwrix/blog/167171/">Part 2. Stop, start, pause.</a> </div><p>Source: <a href="https://habr.com/ru/post/168011/">https://habr.com/ru/post/168011/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167999/index.html">Why do we (still) believe in remote work</a></li>
<li><a href="../168003/index.html">Google has blocked the application Moon + Reader on the complaint LitRes</a></li>
<li><a href="../168005/index.html">Data mining for information security</a></li>
<li><a href="../168007/index.html">We pump over the ultrabook Acer Aspire S3 391</a></li>
<li><a href="../168009/index.html">New to Windows Server 2012 - Part 2: Storage Systems</a></li>
<li><a href="../168013/index.html">Life with a tablet or a list of applications for Android</a></li>
<li><a href="../168015/index.html">CodeIgniter Framework Overview</a></li>
<li><a href="../168017/index.html">One and a half years of life under the sign of IT. As manager manager</a></li>
<li><a href="../168025/index.html">Mega: security review</a></li>
<li><a href="../168027/index.html">Tweetping - all tweets on the world map live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>