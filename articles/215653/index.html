<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use nginx, docker, skydns and skydock to update the code on the fly (zero-downtime deployment)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tools that we will use 
 Docker 
 Docker is a simple and elegant library for creating lightweight, isolated from each other virtual containers in whic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use nginx, docker, skydns and skydock to update the code on the fly (zero-downtime deployment)</h1><div class="post__text post__text-html js-mediator-article"><h2>  Tools that we will use </h2><br><h3>  Docker </h3><br>  <a href="https://www.docker.io/">Docker</a> is a simple and elegant library for creating lightweight, isolated from each other virtual containers in which you can execute any code.  It is not demanding at all resources, minimum overhead. <br><br>  Having collected the container once, it can be reused. <br><br>  A simple example is the Redis DB.  If we need several Redis servers on the same computer, with the usual approach we will have to change the configuration files in / etc / redis and change the files in /etc/init.d.  You can write a bash script, but this does not make the process easier. <br><a name="habracut"></a><br>  In the case of Docker, we can use the following command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">docker run -d --name <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-redis-server dockerfile/redis</code> </pre> <br>  This command will download the Redis container from the main repository ( <a href="https://index.docker.io/">index.docker.io</a> ), run it in the background and give the newly created container the name test-redis-server. <br><br>  This container can be run later with the command: <br><br><pre> <code class="bash hljs">docker start <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-redis-server</code> </pre><br><h3>  Skydns </h3><br>  More recently, Docker developers have introduced the --link tool when launching a container so that several containers can be linked using ENV environment variables.  For example, to associate a web application container with Redis, Postgresql, Elasticsearch containers, etc. <br><br>  This is convenient, but we need to monitor the accuracy of the ENV and change the code when changing the conditions of the launch containers and the parameter --link. <br><br>  This is called Service Discovery, for it there are many solutions (for more information about existing solutions, you can read the article <a href="http://jasonwilder.com/blog/2014/02/04/service-discovery-in-the-cloud/">Open-Source Service Discovery</a> ). <br><br>  One of these solutions is SkyDNS.  A small local DNS and DNS proxy server written in the Go language (it is important to note that Go is extremely effective in terms of resource consumption, up to about 6MB of memory at startup. I personally conducted several synthetic tests for myself, the maximum memory consumption for 50 simultaneous simple queries was about 20MB). <br><br>  SkyDNS allows you to add DNS records using a simple API (in more detail: <a href="https://github.com/skynetservices/skydns">SkyDNS</a> ), and then make regular queries that return SRV, A or AAAA records. <br><br>  If the record is not found, SkyDNS will send a request to google public dns (8.8.8.8/8.8.4.4). <br><br>  SkyDNS uses its own interesting domain scheme: <br><br><pre> <code class="bash hljs">&lt;uuid&gt;.&lt;host&gt;.&lt;region&gt;.&lt;version&gt;.&lt;service&gt;.&lt;environment&gt;.skydns.local</code> </pre><br>  If environment = production, and service = redis, then you can make a request to <u>redis.production.skydns.local</u> , which will return one or more records (by default, it returns A record). <br><br><h3>  Skydock </h3><br>  <a href="https://github.com/crosbymichael/skydock">Skydock</a> is a small program that combines Docker and SkyDNS. <br><br>  Skydock uses the SkyDNS domain scheme as follows: <br><br><pre> <code class="bash hljs">&lt;name&gt;.&lt;container-name&gt;.&lt;environment&gt;.skydns.local</code> </pre><br>  <b>ontainer-name</b> is the name of the Docker image without a repository (for example, crosbymichael / redis =&gt; redis or test / cool-api =&gt; cool-api).  <b>name</b> is the name of the container assigned to it using the --name parameter. <br><br>  Skydock automatically detects running containers and adds them to SkyDNS. <br><br>  Docker assigns a separate IP address for each container, therefore if we launch the container as follows: <br><br><pre> <code class="bash hljs">docker run -d --name redis-test-app dockerfile/redis</code> </pre><br>  We will be able to make a request (later it will be described why we make a request for 172.17.42.1) and we will receive in response A record, that is, the IP address of the container in which Redis is running. <br><br><pre> <code class="bash hljs">dig @172.17.42.1 redis-test-app.redis.dev.skydns.local dev.skydns.local. 27 IN A 172.17.0.3</code> </pre><br>  The default Redis port is 6379, so in the code we can do something like this (pseudo-language example): <br><br><pre> <code class="go hljs">redisConn = redis.Connect(<span class="hljs-string"><span class="hljs-string">"redis-test-app.redis.dev.skydns.local:6379"</span></span>)</code> </pre><br><h2>  Installation </h2><br>  We will not consider the installation of Docker, it is very simple and described in detail here: <a href="https://www.docker.io/gettingstarted/">Start using Docker</a> <br><br>  We need to launch 2 containers - one with SkyDNS, the other with Skydock.  Unlike Skydock, I recommend running SkyDNS with the additional option -p 172.17.42.1:8080:8080 - this will allow your containers to use the SkyDNS API directly for their own needs. <br><br><pre> <code class="bash hljs">docker pull crosbymichael/skydns docker run -d -p 172.17.42.1:53:53/udp -p 172.17.42.1:8080:8080 --name skydns crosbymichael/skydns -nameserver 8.8.8.8:53 -domain skydns.local</code> </pre><br>  IP 172.17.42.1 is the docker0 bridge, used by Docker to configure its own network.  We specified the skydns.local domain, although you can do any of your choice, for example, docker, super.local.  In my opinion, skydns.local is more convenient and versatile, especially since it is used by default in SkyDNS. <br><br>  Next, run Skydock: <br><br><pre> <code class="bash hljs">docker pull crosbymichael/skydock docker run -d -v /var/run/docker.sock:/docker.sock --name skydock -link skydns:skydns crosbymichael/skydock -ttl 30 -environment dev -s /docker.sock -domain skydns.local</code> </pre><br><br>  Here you need to specify the TTL (if it is smaller - more dynamic environments, you can make more changes to the architecture faster. If more - a less dynamic, more cached environment) and environment - this can be absolutely any line (dev, development, production, stage, qa ). <br><br>  If everything went well, then all the necessary components are running. <br><br>  The only thing that needs to be done is when launching the container with your application, you need to specify the primary DNS server: <br><br><pre> <code class="bash hljs">docker run -d --dns 172.17.42.1 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/cool-api</code> </pre><br>  Our cool-api container will be available in the local DNS at: <u>cool-api.dev.skydns.local</u> - this will list the IP addresses of all containers called cool-api.  This property we will use to configure nginx. <br><br>  If you specify --name api1 when you start the container, it will be available at <u>api1.cool-api.dev.skydns.local</u> - just 1 container with the name api1. <br><br>  Inside the container, you can now specify the domain directly, since it will use the local DNS: <u>redis.dev.skydns.local</u> - will return A records of all containers running Redis.  Naturally, only 1 address will be selected to which the Redis client will connect. <br><br><h2>  nginx </h2><br>  I use this magic of local DNS, we can do for example: <br><br><ul><li>  Load balancing - web server or database connections </li><li>  Simple routing of requests by criterion.  For example, by creating an image test / cool-api-v1 - we can send requests to the API v1 to some containers ( <u>cool-api-v1.dev.skydns.local</u> ), and use <u>cool-api.dev.skydns.local</u> as the latest version.  At the same time with automatic balancing </li><li>  <b>Update code on the fly</b> - what we need </li></ul><br>  Add this configuration file to nginx: <br><br><pre> <code class="bash hljs">server { listen 80; server_name super-cool-domain.com; <span class="hljs-comment"><span class="hljs-comment">#  nginx  SkyDNS resolver 172.17.42.1 valid=5s; resolver_timeout 5s; #      ,  nginx   DNS. - nginx   set $dns cool-api.production.skydns.local; location /api { proxy_pass http://$dns:8080; } #    location / { try_files $uri /index.html; } }</span></span></code> </pre><br>  We simply specify that nginx use the local DNS server, then specify where to go - the $ dns variable and do the good old proxy_pass to the port that your application uses. <br><br>  Now, when launching a new container, Skydock will add it to SkyDNS, nginx will proxy requests to this container.  When the container is stopped, Skydock will delete its address from SkyDNS. <br><br>  By launching 2-3 containers in this way, we can balance the load between them. <br><br>  We will launch several additional containers, nginx will automatically start proxying requests to them.  After that, we can stop the work of the old - thereby making an update on the fly. <br><br>  This will not require reconfiguration.  Everything works by default.  In essence, all you need to do to change the code is: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#          docker pull test/cool-api #  ID   OLDPORTS=( `docker ps | grep cool-api | awk '{print $1}'` ) #    docker run -d test/cool-api #   for i in ${OLDPORTS[@]} do echo "removing old container $i" docker kill $i done</span></span></code> </pre><br><h3>  Conclusion </h3><br>  The author Skydock wants to develop the idea and make support for multiple servers in the data center.  At the moment, this is not implemented, although SkyDNS itself is already used in the production environment on multiple servers. <br><br>  The article also does not address the topic of docker repositories.  There is an open source solution that allows you to create a private image repository. <br><br>  The solution has almost no effect on performance, Docker and SkyDNS are very well designed and use the effective and fast language Go. <br>  At first glance, this seems to be a somewhat complicated process, but the result is a very flexible solution that does not need to be further configured after the initial setup. </div><p>Source: <a href="https://habr.com/ru/post/215653/">https://habr.com/ru/post/215653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215637/index.html">What happens if you decide to assemble a 3D printer with your own hands</a></li>
<li><a href="../215641/index.html">We are on friendly terms with IPS Appliance and Multi-Layer Switch (Cisco IPS and Catalyst 6500)</a></li>
<li><a href="../215645/index.html">Clever image cropping using point of focus</a></li>
<li><a href="../215647/index.html">Android SDK vs NDK - comparing the performance of similar types of code</a></li>
<li><a href="../215651/index.html">Application on Express.js + Sass / Compass + CoffeeScript + Haml</a></li>
<li><a href="../215655/index.html">Downloading historical data to SAP using LSMW (Legacy System Migration Workbench)</a></li>
<li><a href="../215657/index.html">We program in Python</a></li>
<li><a href="../215661/index.html">In the Indian police for 8 years did not respond to complaints because they lost the password from the database</a></li>
<li><a href="../215665/index.html">+ (AppStore *) Timera: application architecture and design features. Part 2</a></li>
<li><a href="../215667/index.html">Pwn2Own 2014: first results</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>