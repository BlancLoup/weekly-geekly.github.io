<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database versioning on the fly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, my name is Eugene, and I am a web developer. Several years ago, the DBA function (Database Administrator) peeled me, I received several certifi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Database versioning on the fly</h1><div class="post__text post__text-html js-mediator-article">  Hello, my name is Eugene, and I am a web developer.  Several years ago, the DBA function (Database Administrator) peeled me, I received several certificates about this and solved the corresponding tasks.  I have long wanted to describe the task of database versioning, but it seemed to me that for this there must be some kind of win-win options that are well-known to skillful uncles, and I just misunderstand something.  Yesterday's interview and the subsequent search on thematic resources showed that this is not so, and the task is really complicated, relevant and not solved unequivocally.  Let's sort it out by points. <br><br><h1>  What we are versioning </h1><br>  We only use version control for DDL (Data Definition Language) queries.  The data itself does not interest us.  Why?  Consider two extreme cases. <br><br><ol><li>  Little data (say, less than 50 megabytes).  In this case, we can simply periodically make a full dump of the database and safely add it to the repository. </li><li>  There is a lot of data (more than a gigabyte).  In this case, versioning will not help us much, it will still be quite problematic to understand this.  It is advisable in this case to use a standard scheme with backups and an archive log, which allows us to get a complete version of the database at any time. </li></ol><br><a name="habracut"></a><br><h1>  Why do we need to version DDL? </h1><br>  If you work with a complex database, the tables, oddly enough, are the least interesting in it (although they should also be under version control).  It is much more difficult to deal with business logic, which is contained in triggers, views, packages and procedures, and similar objects.  For example, in one of the databases with which I worked, there were packets of up to one and a half megabytes in size.  These packages are constantly being edited, and it is vital to know who made the changes, when, it is desirable to know why, and how we would roll it back to any desired state. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Perfect world </h1><br>  Imagine an ideal world in which we have a clear TK, which does not change until the completion of the project.  The release, after which we forget about what we did, and get a regular salary for the beautiful eyes.  The ideal code that we wrote immediately taking into account all the nuances that works without errors and does not require maintenance.  The lack of improvements, urgent bug fixes, integration mechanisms, the ability to work on a test base and test samples, the presence of ubiquitous unit tests, which say that everything is impeccable. <br><br>  In this case, it is more than enough for us to use the version control system as the primary source of information about the state of the database, and roll out changes to the base from it.  There is a single repository, there is a joint work on the code base - everything is beautiful and transparent.  There are several products that seem to implement this functionality quite well. <br><br><h1>  Real world </h1><br><div class="spoiler">  <b class="spoiler_title">Summary of this part</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b93/325/ce1/b93325ce18794b5f8ec85965facca862.png"></div></div><br>  Now open your eyes and look around.  In most cases, the project is implemented according to the scheme, which I would call the UHV (made, rolled out, threw out).  A huge percentage of completed projects can not be sold and closed without any prospects for the future.  The remaining lucky people go through hundreds of iterations, after which the name of the initial TK remains, at best.  In this reality, we are primarily concerned not with the speed of the product, its requirements and quality.  We are worried about the speed of development, because, for obvious reasons, the largest part of the project budget - the cost of work in development hours - depends on it. <br><br>  Yes it is wrong.  The world is cruel, unjust, dynamic, and requires an instant reaction, even if quality suffers.  All developers in their hearts strive for the ideal code, but most accept the terms of the deal with the devil, and seek an acceptable compromise between quality and speed.  We try to do what is best, but we learn not to blush, if instead of half a year and a perfect product, we made an unstable and ugly decision in two weeks.  Moreover, at some point an understanding comes that the ‚Äúlast bug‚Äù will never be found, and all we can do is just at some point stop searching for it and making a release.  To bring the solution to the ideal - the lot of the simplest applications and console scripts - and even then it is often not possible to take into account some non-trivial moments.  When we talk about large projects, the example of Oracle, Microsoft and Apple shows us that there is no perfect code.  As an example, the classic DBA answer to the question that in the new release of the Oracle Database - ‚Äúremoved 30% of the old bugs, added 40% of the new ones‚Äù. <br><br><h1>  Who is to blame and what to do? </h1><br>  What does this mean when we are talking about a database?  Usually it is like this: <br><br><ol><li>  Access to the database is a large number of developers </li><li>  Often there is a need to roll back an object. </li><li>  No one ever admits that it was he who broke the object. </li><li>  Modifications are often incomprehensible </li></ol><br>  Further, if a developer comes to the DBA and asks to return the previous version of its object, then the DBA can do it in three cases (using the example of Oracle): <br><br><ol><li>  If the previous version is still preserved in UNDO </li><li>  If the object was simply deleted and stored in the trash can (RECYCLEBIN) </li><li>  If he can deploy a full backup of the database to the desired date </li></ol><br>  The most realistic option is the third.  But it is complicated by the fact that it is often unknown on what date the restoration needs to be performed, and the restoration of a database of, say, 10 terabytes is quite a long and resource-intensive operation.  So usually DBA just throws up his hands, the developer frowns out coffee and goes to write his object from scratch. <br><br>  What can we do to make life easier for developers?  I see the only option - to version the base on the fact of the changes already made.  Naturally, this does not give any opportunity to prevent possible errors - but it will give a way in a large percentage of cases to bring the desired object and the whole system back to life. <br><br><h1>  Implementation on the example of Oracle </h1><br>  The first simple ‚Äúhead-on‚Äù solution is to periodically unload the entire database.  But unloading the base takes a long time, and then we will not know who changed what, when and what.  So obviously something is required more difficult.  Namely, we only need to unload the modified DDL objects.  To do this, you can use two approaches - use Audit, or create a system trigger.  I used the second method.  Then the sequence is as follows: <br><br><ol><li>  Create a table in which data about DDL queries will be stored. </li><li>  Create a system trigger that will write to this table. </li></ol><br>  In addition, for each action we can get quite detailed information, including the full text of the request, the scheme, the name and type of the object, the IP address of the user, the network name of his machine, the name of the user, the type and date of changes.  As a rule, this is enough to then find a developer and issue a medal. <br><br>  Next, we want to have a repository, in which the base structure will be presented in an intuitive way so that we can compare different versions of the object.  To do this, each time you change the base, you need to unload the changed objects and commit to the base.  Nothing complicated!  We create a Git repository, first we do a full upload there, then we create a service that monitors our table of changes, and in the case of new records, unloads the changed objects. <br><br><h1>  What it looks like </h1><br><div class="spoiler">  <b class="spoiler_title">Normal comparison</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/28f/77a/bd3/28f77abd36494a999483fb9edb6de127.png"></div></div><br>  <a href="">Side by side comparison</a> <br>  <a href="">List of objects</a> in the scheme <br>  <a href="">Change history of a</a> specific object <br>  Same thing <a href="">on github</a> <br><br>  That is, we have a working tool with which you can find the source of any changes in the database and, if necessary, roll them back.  In my case, the largest Git repository in Gitlab (your instance on a separate machine) occupies several hundred megabytes, there are about one hundred thousand commits in it, and at the same time it works quite quickly.  Before moving to Gitlab, the same repository lived fine on github, and then on bitbucket. <br><br>  Data about what objects we then have: <br><br><ol><li>  Tables </li><li>  representation </li><li>  materialized views </li><li>  triggers </li><li>  sequences </li><li>  users (with password hashes that can be used to recover the old password) </li><li>  packages, functions, procedures </li><li>  database links (also with password hashes) </li><li>  grants </li><li>  with their state </li><li>  synonyms </li></ol><br>  You can also modify the program for updating an outdated database ‚Äî unload the old version, unload the new version on top of it, fix the difference in semi-automatic mode. <br><br><h1>  Minuses </h1><br><ol><li>  Some changes may occur too quickly, and the service will not have time to upload intermediate results - but they are hardly relevant to us, and you can find them in the table of changes. </li><li>  Some changes can affect several objects at once - for example, deleting a schema or DROP CASCADE - but this can also be correctly worked out if desired, the question is only in implementation. </li><li>  Due to the fact that password repositories are stored in the repository, it cannot be issued directly to developers. </li></ol><br>  As a recommendation, I will also add that it is better to periodically upload the current version over what is in the repository - in case of any changes that the logic of the upload algorithm could not cover. <br><br>  There is a link to my PHP algorithm and installation guide at the end of the article, but I sincerely recommend that you use it only for reference - it was written long ago and very crookedly with your left hand during other tasks.  The only plus is that, oddly enough, it works. <br><br><h1>  Conclusion </h1><br>  I sincerely wish you not to have to work with such a workflow.  And I hope that this publication will help you if your world is still far from ideal. <br>  Are you versioning your database?  In the right way, or in fact?  Maybe there are implementations for other DBMS - MySQL, Postgres?  Or is there some fundamentally different good approach that I overlooked? <br><br><h1>  Links </h1><br><ol><li>  A great discussion of how to version base on <a href="http://dba.stackexchange.com/questions/283/how-do-you-version-your-oracle-database-changes">stackoverflow</a> </li><li>  Implementing the right approach from <a href="http://www.liquibase.org/">Liquibase</a> </li><li>  Same <a href="https://github.com/qwazer/oracle-ddl2svn">old</a> Java + SVN <a href="https://github.com/qwazer/oracle-ddl2svn">implementation</a> </li><li>  <a href="http://oracletogit.ru/">My tool's website</a> with installation instructions </li><li>  My tool code <a href="https://github.com/jehy/OracleToGit">repository</a> on github </li><li>  You can take me to work <a href="http://whois.jehy.ru/">here.</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/277359/">https://habr.com/ru/post/277359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277345/index.html">In-depth training in the garage - Two networks</a></li>
<li><a href="../277349/index.html">Ireland is a tasty morsel for building a data center</a></li>
<li><a href="../277351/index.html">Implementing a semantic news aggregator with extensive search capabilities</a></li>
<li><a href="../277353/index.html">Examination of SSL certificates, software licenses and backup space</a></li>
<li><a href="../277355/index.html">Data Center with warranty</a></li>
<li><a href="../277361/index.html">Kimono service is closing</a></li>
<li><a href="../277363/index.html">Who works in Innopolis?</a></li>
<li><a href="../277367/index.html">Popular reasons for the fall of sites</a></li>
<li><a href="../277369/index.html">How to the developer to "join" the theme of DevOps</a></li>
<li><a href="../277371/index.html">The advantages of using unique shaders in computer games: personal experience and observation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>