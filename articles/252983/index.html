<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We show the work process of a continuous task on the server using one connection.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I needed to show the interactive execution of the script to the user. I implemented a multi-threaded PHP bot that performs a background task while rec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We show the work process of a continuous task on the server using one connection.</h1><div class="post__text post__text-html js-mediator-article">  I needed to show the interactive execution of the script to the user.  I implemented a multi-threaded PHP bot that performs a background task while receiving execution requests.  The results of his activities, he writes in the database.  Next, I had to somehow inform the user about the process. <br><br>  Usually, in this case, for example, a long request is made, at the end of which the current status is answered from the server, after which it is repeated again, or the status is checked every couple of seconds.  But I wanted to realize this in a more lively form, using one connection. <br><br>  The resulting method can be used to continuously receive a response from the server and processing it in parallel without interruption.  That is, it is possible not only to use it to obtain the state of readiness of the process, but also, for example, it is possible to process huge data in the process of obtaining it, without waiting for it to be fully loaded. <br><a name="habracut"></a><br><h4>  How are we going to act? </h4><br>  The method is to force the PHP script to give the data to the client in predetermined portions.  And in the reception of these portions on the client side. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, many browsers do not know how to properly handle the data transfer status in AJAX, so we will do conditional data synchronization in seconds.  Every 2 seconds we will reset the data from the server, and every 2 seconds we will check the arrival of new data on the client side.  In this case, inconsistencies often occur, some data has come already newer than needed, or there is no new data yet.  I will consider only the first case, since  It is assumed that your ping is high enough to ensure the arrival of data in abundance. <br><br><h4>  We force the server to give the data </h4><br>  To do this, we need to disable all compression methods, tell the browser that we are transmitting the stream, and force it to reset all output data to the user. <br><br>  Also one of the most data points - you must close the recording of an open session.  The fact is that PHP cannot open the same session in two parallel threads, so if your process runs and uses a parallel request, it will hang in the queue.  As a result, all AJAX functions will be paralyzed. <br><br><pre><code class="php hljs">header(<span class="hljs-string"><span class="hljs-string">'Content-Encoding: none;'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  header('Content-type: application/octet-stream'); //   ini_set('output_buffering', 'off'); //     php ini_set('zlib.output_compression', false); //         ini_set('implicit_flush', true); ob_implicit_flush(true); //    ,          (!) session_write_close(); for ($i = 0;$i &lt; 20; $i++) { echo '|'.$i.str_repeat(' ', 4096).PHP_EOL; flush(); sleep(2); }</span></span></code> </pre> <br>  Above, I use the separator | to output only fresh data and divide the transferred data into logical parts. <br><br>  Notice - we hammer in extra 4096 bytes to force the packet to be sent to the user.  Otherwise, the web server will cache the data until it is collected in the necessary packet to send.  Perhaps there is a method to send without it, I will be ready to listen to the decisions in the comments. <br><br>  The script above will transmit numbers from 0 to 19 every 2 seconds. The browser will display only the most recent data. <br><br><h4>  Client part </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timerlive; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">live</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cont</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ xhr.abort(); }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> temp; clearTimeout(timerlive); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prevtext = <span class="hljs-string"><span class="hljs-string">''</span></span>; xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'ajax.php'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>); xhr.send(<span class="hljs-string"><span class="hljs-string">"type=live"</span></span>); timerlive = setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xhr.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span>) { clearTimeout(timerlive); } temp=xhr.responseText.substring(prevtext.length); $(<span class="hljs-string"><span class="hljs-string">'#'</span></span>+cont).html(temp.substr(temp.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"|"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)); prevtext = xhr.responseText; }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">breaklive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ xhr.abort(); }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { } clearTimeout(timerlive); }</code> </pre><br><br>  Calling the live () function will first interrupt the previous live channel, and then initialize a new connection to the server.  We will record old data to know the starting point for new data.  Also using the delimiter |  we will trim only the most recent data from the obtained.  In general, you can simply separate only the most recent data, but you can process all the new data, if you for example generate an online log. <br><br>  Below is a function to interrupt the connection, it can be embedded in your AJAX scripts so that when you switch to another page, you close the connection. </div><p>Source: <a href="https://habr.com/ru/post/252983/">https://habr.com/ru/post/252983/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252971/index.html">Building a Nodejs Modular System</a></li>
<li><a href="../252973/index.html">Proper increase in disk size in a virtual machine</a></li>
<li><a href="../252975/index.html">Create your Amazon-like navigation menu</a></li>
<li><a href="../252977/index.html">Time is money =?</a></li>
<li><a href="../252979/index.html">Watching new lease addresses on a DHCP server using PowerShell</a></li>
<li><a href="../252985/index.html">Visual linear approximation with Gnuplot</a></li>
<li><a href="../252987/index.html">Where do we lose 70% of customers? Sales Funnel WebCanape</a></li>
<li><a href="../252991/index.html">How to get superuser status using DRAM vulnerability: Rowhammer technique</a></li>
<li><a href="../252993/index.html">Conference DUMP-2015: Section "Testing"</a></li>
<li><a href="../252995/index.html">Squeeze all the juices from the free version of Veeam Backup & Replication</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>