<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making payments by cryptocurrency with your own hands</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 


 From time to time I notice questions about how to accept Bitcoin payments on my website without using third-party services. It is quite ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making payments by cryptocurrency with your own hands</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr! </p><br><p>  From time to time I notice questions about how to accept Bitcoin payments on my website without using third-party services.  It is quite simple, but we must bear in mind that there are pitfalls. </p><br><p>  In this article I will try as much as possible, without an accent in any programming language, to describe how to accept Bitcoin payments (and also, if desired, Litecoin, Dash, Bitcoin Cash, Steep, ONION, etc.), starting with expanding the full node and completing the verification of receipt of payment. </p><a name="habracut"></a><br><h2 id="predvaritelnye-trebovaniya">  Prerequisites </h2><br><p>  This implies that you have a website hosted on a VPS, to which you have root access, and are also willing to spend $ 15 + to pay for the server for the wallet. </p><br><h2 id="ustanovka-koshelka">  Wallet installation </h2><br><p>  The first step is to allocate a separate server to host the wallet.  Why a separate server?  A separate server will reduce the risk of withdrawal of all your funds by the attacker in case of hacking the main site.  Well, do not forget that to store the blockchain requires a lot of disk space (~ 150Gb of disk space, etc. - details on the <a href="https://bitcoin.org/en/full-node">link</a> ). </p><br><p>  What are the options for cheap servers?  Their mass, in my opinion the most adequate - the server from hetzner.de or chipcore.com.  On chipcore.com, for example, you can get dedicated with a 500Gb disk (enough for BTC and a couple more blockchains) for only 990 rubles (about 17 bucks).  If you know something cheaper - write in the comments, very interesting (I think, not only me). </p><br><p>  After you have consciously decided that you want to accept cryptocurrencies on your website and bought a server (or used an existing one), you need to install a bitcoin node. </p><br><p>  The server should have any suitable operating system installed, the simplest option is Ubuntu 16.10 (yes, in fact, this is not the best choice, it is better to install 16.04 or wait for 18.04 and wait another couple of months for stabilization).  As a rule, it does not make sense to bother with a disk partitioning and you can safely use 2-4Gb on swap and let the rest go to the root partition (/ or root). </p><br><p>  After the server is available, the first thing to do is to disable password authorization and set up authorization using ssh keys.  Making it simple is a good description from <a href="https://www.digitalocean.com/community/tutorials/c-ubuntu-16-04-ru">DigitalOcean</a> . </p><br><p>  After the server is configured, just a couple of commands are enough to run a full purse node. </p><br><h2 id="ustanavlivaem-bitcoind">  Install bitcoind </h2><br><pre><code class="bash hljs">sudo apt-add-repository ppa:bitcoin/bitcoin sudo apt-get update sudo apt-get install bitcoind</code> </pre> <br><p>  This is all that is required to install the node. </p><br><h3 id="nastroyka-bitcoind">  Configure bitcoind </h3><br><p>  The first step is to create a <code>bitcoin</code> user: </p><br><pre> <code class="bash hljs">adduser bitcoin <span class="hljs-comment"><span class="hljs-comment">#       -  </span></span></code> </pre> <br><p>  and create service directories: </p><br><pre> <code class="bash hljs">mkdir -p /etc/bitcoin chown bitcoin: /etc/bitcoin mkdir -p /run/bitcoind chown bitcoin: /run/bitcoind mkdir -p /var/lib/bitcoind chown bitcoin: /var/lib/bitcoind</code> </pre> <br><p>  Now the trifle remains - to correctly configure the node to receive JSON RPC requests. </p><br><p>  The minimum config will look like this: </p><br><pre> <code class="hljs pgsql">rpcuser=USERNAME rpcpassword=<span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> rpcbind=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> rpcallowip=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span></code> </pre> <br><p>  It should be put at <code>/etc/bitcoin/bitcoin.conf</code> .  And do not forget to set the correct owner: </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> bitcoin: <span class="hljs-regexp"><span class="hljs-regexp">/etc/bitcoin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bitcoin.conf</span></span></code> </pre> <br><p>  Important: The use of USERNAME and PASSWORD is a deprecated method and is not a bit safe.  More correctly to use rpcauth, an example can be found <a href="https://en.bitcoin.it/wiki/Running_Bitcoin">on the link</a> . </p><br><p>  Further, it is enough to configure the systemd service to start the node (including after a reboot). </p><br><p>  To do this, you can simply copy the unit file located at the <a href="https://github.com/bitcoin/bitcoin/blob/master/contrib/init/bitcoind.service">address</a> in the <code>/etc/systemd/system/</code> directory: </p><br><pre> <code class="bash hljs">wget https://raw.githubusercontent.com/bitcoin/bitcoin/master/contrib/init/bitcoind.service -O /etc/systemd/system/bitcoind.service</code> </pre> <br><p>  After that start it and configure autorun: </p><br><pre> <code class="bash hljs">systemctl daemon-reload systemctl start bitcoind systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> bitcoind</code> </pre> <br><p>  Now you can check the node performance: </p><br><pre> <code class="bash hljs">curl --data-binary <span class="hljs-string"><span class="hljs-string">'{"jsonrpc": "1.0", "method": "getinfo", "params": [] }'</span></span> -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> http://USERNAME:PASSWORD@127.0.0.1:8332/</code> </pre> <br><p>  If everything is ok, the following message will be sent back: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"result"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"balance"</span></span>:<span class="hljs-number"><span class="hljs-number">0.000000000000000</span></span>,<span class="hljs-attr"><span class="hljs-attr">"blocks"</span></span>:<span class="hljs-number"><span class="hljs-number">59952</span></span>,<span class="hljs-attr"><span class="hljs-attr">"connections"</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>,<span class="hljs-attr"><span class="hljs-attr">"proxy"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"generate"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"genproclimit"</span></span>:<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-attr"><span class="hljs-attr">"difficulty"</span></span>:<span class="hljs-number"><span class="hljs-number">16.61907875185736</span></span>},<span class="hljs-attr"><span class="hljs-attr">"error"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"curltest"</span></span>}</code> </pre> <br><h3 id="nastroyka-servera-osnovnogo-sayta">  Configure the primary site server </h3><br><p>  It remains only to configure the server on which your site is located. </p><br><p>  The safest and easiest way to make the wallet API available on the backend is to push the ssh tunnel through the systemd service (well, or any other init service).  In the case of using systemd, the configuration of the service is as simple as possible: </p><br><pre> <code class="hljs pgsql">[Unit] Description=SSH Tunnel BTC <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=network.target [Service] <span class="hljs-keyword"><span class="hljs-keyword">Restart</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">always</span></span> RestartSec=<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=tunnel ExecStart=/usr/bin/ssh -NT -o ServerAliveInterval=<span class="hljs-number"><span class="hljs-number">60</span></span> -L <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">8332</span></span>:<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">8332</span></span> tunnel@YOUR_SERVER_IP [Install] WantedBy=multi-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.target</code> </pre> <br><p>  This configuration must be placed along the path <code>/etc/systemd/system/sshtunnel-btc.service</code> . </p><br><p>  After that, we put the service in autostart and run: </p><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> sshtunnel-btc.service systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> sshtunnel-btc.service</code> </pre> <br><p>  To check, you can knock on the port of localhost and check that everything is ok: </p><br><pre> <code class="hljs scala">curl --data-binary '{<span class="hljs-string"><span class="hljs-string">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"getinfo"</span></span>, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: [] }' -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'Content</span></span>-<span class="hljs-type"><span class="hljs-type">Type</span></span>: application/json' http:<span class="hljs-comment"><span class="hljs-comment">//USERNAME:PASSWORD@127.0.0.1:8332/</span></span></code> </pre> <br><h2 id="dokumentaciya-api">  API documentation </h2><br><p>  The list of all methods is most conveniently available through the <a href="https://en.bitcoin.it/wiki/Original_Bitcoin_client/API_calls_list">link</a> . </p><br><p>  It is very simple to call them even through curl, we have already used the sample query earlier when getting information about a node with the getinfo method. </p><br><p>  There are two options for the transfer of parameters - an array or a dictionary. </p><br><p>  Below you can see examples of a request for a new address with the transfer of parameters in an array and a dictionary: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># array curl --data-binary '{"jsonrpc": "1.0", "method": "getnewaddress", "params": ["test"] }' -H 'Content-Type: application/json' http://USERNAME:PASSWORD@127.0.0.1:8332/ # object curl --data-binary '{"jsonrpc": "1.0", "method": "getnewaddress", "params": {"account": "test"} }' -H 'Content-Type: application/json' http://USERNAME:PASSWORD@127.0.0.1:8332/</span></span></code> </pre> <br><h2 id="prostoy-api-klient">  Simple API client </h2><br><p>  For use it is convenient to write a simple wrapper with the functions we need (or use the existing library for your language).  Example for ruby: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Btc</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BtcError</span></span></span><span class="hljs-class"> &lt; StandardError;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> SUPPORTED_METHODS = <span class="hljs-string"><span class="hljs-string">%w(get_new_address get_addresses_by_account get_info get_net_totals get_balance get_received_by_address send_to_address list_transactions get_transaction)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> &lt;&lt; self </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_missing</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SUPPORTED_METHODS</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send_request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">empty?</span></span></span><span class="hljs-class"> ? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">else</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">respond_to_missing?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_include_private</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SUPPORTED_METHODS</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">) || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protected</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENV</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HOST</span></span></span><span class="hljs-class">"] || "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">://</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">@127.0.0.1:8332" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send_request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URI</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Net::HTTP::Post</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basic_auth</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSON</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dump</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jsonrpc</span></span></span><span class="hljs-class">: "1.0", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tr</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class">", ""), </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req_options</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">use_ssl</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scheme</span></span></span><span class="hljs-class"> == "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">https</span></span></span><span class="hljs-class">" } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Net::HTTP</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hostname</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req_options</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">begin</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSON</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rescue</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSON::ParserError</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BtcError</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BtcError</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">"].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_json</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">"] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">"].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_a?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hash</span></span></span><span class="hljs-class">) ? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">"].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deep_symbolize_keys</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">["</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">"] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  After that, you can conveniently use it in approximately the following form: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># run with HOST env variable (HOST=http://username:password</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@localhost</span></span></span><span class="hljs-comment">:8332) Btc.get_info # =&gt; {result: {...}}</span></span></code> </pre> <br><p>  Analogous example for node.js: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BtcApi</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">host, port, username, password</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.host = host; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.port = port; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password = password; }; BtcApi.methods = [ <span class="hljs-string"><span class="hljs-string">'getNewAddress'</span></span>, <span class="hljs-string"><span class="hljs-string">'getAddressesByAccount'</span></span>, <span class="hljs-string"><span class="hljs-string">'getInfo'</span></span>, <span class="hljs-string"><span class="hljs-string">'getNetTotals'</span></span>, <span class="hljs-string"><span class="hljs-string">'getBalance'</span></span>, <span class="hljs-string"><span class="hljs-string">'getReceivedByAddress'</span></span>, <span class="hljs-string"><span class="hljs-string">'sendToAddress'</span></span>, <span class="hljs-string"><span class="hljs-string">'listTransactions'</span></span>, <span class="hljs-string"><span class="hljs-string">'getTransaction'</span></span>, ]; BtcApi.prototype.sendRequest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, params, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BtcApi.methods.indexOf(method) === <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'wrong method name '</span></span> + method) }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callback == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { callback = params; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({ <span class="hljs-attr"><span class="hljs-attr">jsonrpc</span></span>: <span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: method.toLowerCase(), <span class="hljs-attr"><span class="hljs-attr">params</span></span>: params, }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth = <span class="hljs-string"><span class="hljs-string">'Basic '</span></span> + Buffer.from(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username + <span class="hljs-string"><span class="hljs-string">':'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password).toString(<span class="hljs-string"><span class="hljs-string">'base64'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.host, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.port, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, <span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: auth }, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = http.request(options, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-string"><span class="hljs-string">''</span></span>; response.setEncoding(<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); response.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chunk</span></span></span><span class="hljs-function">) </span></span>{ result += chunk; }); <span class="hljs-comment"><span class="hljs-comment">// Listener for intializing callback after receiving complete response response.on('end', function () { try { callback(JSON.parse(result)); } catch (e) { console.error(e); callback(result); } }); }); request.write(body) request.end() }; for (var i = 0; i &lt; BtcApi.methods.length; i++) { BtcApi.prototype[BtcApi.methods[i]] = function (method) { return function (params, callback) { this.sendRequest(method, params, callback) } }(BtcApi.methods[i]) } module.exports = BtcApi</span></span></code> </pre> <br><p>  Which can be used in approximately the following way: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BtcApi = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./btc'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BtcApi(<span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-number"><span class="hljs-number">8332</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>); client.listTransactions({ <span class="hljs-attr"><span class="hljs-attr">count</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'response: '</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(response)); }); <span class="hljs-comment"><span class="hljs-comment">// {"result":[{...}]}</span></span></code> </pre> <br><p>  For Python, it's still easier - the official way is to <a href="http://json-rpc.org/wiki/python-json-rpc">use</a> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> jsonrpc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServiceProxy access = ServiceProxy(<span class="hljs-string"><span class="hljs-string">"http://user:password@127.0.0.1:8332"</span></span>) access.getinfo()</code> </pre> <br><p>  Actually, there are no problems with PHP either (it is recommended to use <a href="http://jsonrpcphp.org/">http://jsonrpcphp.org/</a> ): </p><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'jsonRPCClient.php'</span></span>; $bitcoin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> jsonRPCClient(<span class="hljs-string"><span class="hljs-string">'http://user:password@127.0.0.1:8332/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;pre&gt;\n"</span></span>; print_r($bitcoin-&gt;getinfo()); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Received: "</span></span>.$bitcoin-&gt;getreceivedbylabel(<span class="hljs-string"><span class="hljs-string">"Your Address"</span></span>).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;/pre&gt;"</span></span>;</code> </pre> <br><p>  A good selection of documentation is <a href="https://en.bitcoin.it/wiki/API_reference_(JSON-RPC)">here</a> . </p><br><p>  The examples above are slightly modified versions listed by reference. </p><br><h2 id="integraciya-s-saytom">  Integration with the site </h2><br><p>  The rather simple part remains - to set up processing of receiving payments and generating addresses for replenishment. </p><br><p>  The process of integration of the acceptance of payments by the crypt looks like this: </p><br><ul><li>  When requesting payment from the user, we show him the address where to transfer funds </li><li>  In the background (the easiest option is by cron), we check the list of transactions of the wallet and upon receipt of a new one, we credit the funds / change the payment status. </li></ul><br><p>  To generate addresses for receiving, you can use several different approaches - creating a new address for each deposit, or using a permanent address for a user account. </p><br><p>  The first option is more secure (since it is more difficult to track repeat payments by the payer) and simple, but it can become a problem when using not very powerful hardware (each generated address increases the load on the node, but this only becomes apparent from several million addresses). </p><br><p>  The second option is more convenient if users need to register and pay often, but at the same time, it is less secure (for example, you can track all funds received on a user account). </p><br><p>  To generate the top-up address, call the getnewaddress method, which in response will return a new address for the top-up.  For convenience, you can transfer the account as a parameter (account) to which the created address will be associated.  Sometimes it can be convenient to view transactions for a specific user. </p><br><p>  Several methods are suitable for checking the balance.  The easiest way is to create a record in the database for each generated replenishment address, then check the receipt of funds for each of the records via the <code>getreceivedbyaddress</code> method (not the most productive option, but suitable for most situations). </p><br><p>  Another good option would be to receive information through the listtransactions about the latest operations and for them to already search for the user who receives the balances.  What kind of implementation to use - you choose. </p><br><p>  An important point in the verification of transactions - correctly specify the number of confirmations to protect against various attacks.  For most cryptocurrencies, they can usually be found in White Paper. </p><br><p>  For bitcoin, the current recommended value is 6 confirmations for small amounts.  <a href="https://en.bitcoin.it/wiki/Confirmation">Here</a> everything is well described. </p><br><p>  I will not write code examples here anymore, because it strongly depends on the technology used. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  I also wanted to write about the integration of other wallets, in more detail about server requirements and output, how to accept payments, if the site is not hosted on a VPS with root access, etc., but I understood that the article turned out to be big, so if It will be interesting - it is better to publish it in one of the following articles. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350430/">https://habr.com/ru/post/350430/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350420/index.html">Digest of interesting materials for the mobile developer # 243 (February 26 - March 4)</a></li>
<li><a href="../350422/index.html">It's time for managers to wake up</a></li>
<li><a href="../350424/index.html">25 billion requests per hour: ServiceNow database</a></li>
<li><a href="../350426/index.html">Game development for NES in C. Chapters 17-21. My own game</a></li>
<li><a href="../350428/index.html">Develop isomorphic RealWorld applications with SSR and Progressive Enhancement. Part 3 - Routing & Fetching</a></li>
<li><a href="../350432/index.html">Theory of the decrepit laptop</a></li>
<li><a href="../350434/index.html">Reasoning on the game design of VR games</a></li>
<li><a href="../350436/index.html">FastTrack Training. "Network Basics". "Basics of a wireless LAN". Part two. Eddie Martin December 2012</a></li>
<li><a href="../350438/index.html">Validation of strings with validate.it.js</a></li>
<li><a href="../350440/index.html">Gini coefficient. From economics to machine learning</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>