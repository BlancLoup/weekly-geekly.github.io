<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RabbitMQ Spring tutorial</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Rabbitmq.com already has detailed examples and a client for java. However, if the project already uses spring, it is much more convenient to use the S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RabbitMQ Spring tutorial</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://www.rabbitmq.com/">Rabbitmq.com</a> already has detailed examples and a client for java.  However, if the project already uses spring, it is much more convenient to use the <a href="http://projects.spring.io/spring-amqp/">Spring AMQP</a> library.  This article contains the implementation of <a href="http://www.rabbitmq.com/getstarted.html">all six</a> official examples of working with RabbitMQ. <br><a name="habracut"></a><br>  Immediately link to projects on <a href="https://github.com/Dmitry-Shweikus/rabbitmq-examples">GitHub</a> . <br><br>  For examples, I will use the simplest application in the spring.  After the user clicks on the specified link, a message will be sent to RabbitMQ which will be sent to one of the listeners.  The listener in turn will simply output the message to the log.  Habr√© already had translations of official tutorials in php and python, and I think many are already familiar with the principles of rabbitmq, so I‚Äôll concentrate on working with Spring AMQP. <br><br><h1>  Training </h1><br><h2>  RabbitMQ installation </h2><br>  RabbitMQ installation is described <a href="http://www.rabbitmq.com/download.html">in</a> detail <a href="http://www.rabbitmq.com/download.html">on the official website</a> .  There should be no problems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Spring Setup </h2><br>  For simplicity, I used <a href="http://projects.spring.io/spring-boot/">Spring Boot</a> .  It is great for quickly deploying applications in the spring and not having to configure it for a long time.  At the same time, I myself will configure Spring AMQP in a ‚Äúclassic way‚Äù - i.e.  the way I configured it in a real project without Spring Boot (unless the ConnectionFactory doesn‚Äôt describe some of the heroku-specific things). <br><br>  The content of the minimum pom.xml we need to run.  There is already Spring boot and Spring AMQP. <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span>4.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>rabbitmq<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>example-1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0-SNAPSHOT<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parent</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-parent<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.2.4.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parent</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.amqp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-rabbit<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.4.5.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-web<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The main configuration file.  In addition to the class name, its contents will be the same for all our examples. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example1; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.SpringApplication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.autoconfigure.EnableAutoConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.ComponentScan; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Import; <span class="hljs-meta"><span class="hljs-meta">@EnableAutoConfiguration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ComponentScan</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(RabbitConfiguration.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Example1Configuration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ SpringApplication.run(Example1Configuration.class, args); } }</code> </pre><br><br><h2>  Example 1. ‚ÄúHello World!‚Äù </h2><br><img src="https://habrastorage.org/files/b3c/acd/477/b3cacd47781f4493a1018275b1b003bb.png"><br><br>  To work with RabbitMQ we need the following bins: <br>  - connectionFactory - to connect with RabbitMQ; <br>  - rabbitAdmin - for registration / cancellation of registration of queues, etc .; <br>  - rabbitTemplate - to send messages (producer); <br>  - myQueue1 - the actual queue to send messages to; <br>  - messageListenerContainer - receives messages (consumer). <br><br><div class="spoiler">  <b class="spoiler_title">The configuration code for these beans</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example1; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.AmqpAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.Message; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.MessageListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.Queue; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.ConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConfiguration</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitConfiguration.class); <span class="hljs-comment"><span class="hljs-comment">//   RabbitMQ @Bean public ConnectionFactory connectionFactory() { CachingConnectionFactory connectionFactory = new CachingConnectionFactory("localhost"); return connectionFactory; } @Bean public AmqpAdmin amqpAdmin() { return new RabbitAdmin(connectionFactory()); } @Bean public RabbitTemplate rabbitTemplate() { return new RabbitTemplate(connectionFactory()); } //    queue1 @Bean public Queue myQueue1() { return new Queue("queue1"); } // ,       @Bean public SimpleMessageListenerContainer messageListenerContainer1() { SimpleMessageListenerContainer container = new SimpleMessageListenerContainer(); container.setConnectionFactory(connectionFactory()); container.setQueueNames("queue1"); container.setMessageListener(new MessageListener() { //    queue1 public void onMessage(Message message) { logger.info("received from queue1 : " + new String(message.getBody())); } }); return container; } }</span></span></code> </pre><br></div></div><br>  In this and the following examples, as a producer, there will be a controller that will send messages to rabbitmq. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example1; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.AmqpTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> AmqpTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Emit to queue1"</span></span>); template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"queue1"</span></span>,<span class="hljs-string"><span class="hljs-string">"Message to queue"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Emit to queue"</span></span>; } }</code> </pre><br>  Now, if you run Example1Configuration and go to the browser at <a href="http://localhost:8080/emit">http: // localhost: 8080 / emit</a> , then in the console we will see something like: <br><br><pre> 2015-06-23 21: 16: 26.250 INFO 6460 --- [nio-8080-exec-2] com.rabbitmq.example1.SampleController: Emit to queue1
 2015-06-23 21: 16: 26.252 INFO 6460 --- [cTaskExecutor-1] c.rabbitmq.example1.RabbitConfiguration: received from queue 1: Message to queue
</pre><br><br>  Consider the result in more detail.  Here we are sending a message to SampleController.java: <br><br><pre> <code class="java hljs">template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"queue1"</span></span>,<span class="hljs-string"><span class="hljs-string">"Message to queue"</span></span>);</code> </pre><br>  And here we get it: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"received from queue 1: "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(message.getBody())); }</code> </pre><br>  Nothing complicated, but describing all listeners in the configuration is not very convenient, especially when there are a lot of them.  It is much more convenient to configure listeners with annotations. <br><br><h2>  Example 1.1.  "Hello World!" On annotations </h2><br>  Instead of the listener in the configuration, add the RabbitMqListener class to the project to which the messages will come.  Accordingly, messageListenerContainer1 is no longer needed. <br><br>  RabbitMqListener is an ordinary component (@Component) of a spring with a method marked with the @RabbitListener annotation.  In this method messages will come.  At the same time, we can receive both the complete <a href="http://docs.spring.io/autorepo/docs/spring-amqp-dist/1.4.2.M1/api/org/springframework/amqp/core/Message.html">Message</a> message with headers and the body as an array of bytes, as well as simply converted body as we sent it. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"queue1"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processQueue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Received from queue 1: "</span></span> + message); }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Source code for RabbitMqListener.java and updated RabbitConfiguration.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example1annotated; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.EnableRabbit; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.RabbitListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-meta"><span class="hljs-meta">@EnableRabbit</span></span> <span class="hljs-comment"><span class="hljs-comment">//     @RabbitListener @Component public class RabbitMqListener { Logger logger = Logger.getLogger(RabbitMqListener.class); @RabbitListener(queues = "queue1") public void processQueue1(String message) { logger.info("Received from queue 1: " + message); } }</span></span></code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example1annotated; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.AmqpAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.Queue; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.ConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConfiguration</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitConfiguration.class); <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ConnectionFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ CachingConnectionFactory connectionFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingConnectionFactory(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connectionFactory; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AmqpAdmin </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amqpAdmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitAdmin(connectionFactory()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RabbitTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rabbitTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitTemplate(connectionFactory()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Queue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myQueue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Queue(<span class="hljs-string"><span class="hljs-string">"queue1"</span></span>); } }</code> </pre><br></div></div><br><h2>  Example 2. Work Queues </h2><br><img src="https://habrastorage.org/files/d77/b67/9d3/d77b679d32204eafaa8dc2b7d78cd1c6.png"><br><br>  In this example, two listeners already listen for one queue.  To emulate useful work, use Thread.sleep.  It is important that listeners of the same queue can be on different instances of the program.  So you can parallelize the queue on multiple computers or nodes in the cloud. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"worker 1 : "</span></span> + message); Thread.sleep(<span class="hljs-number"><span class="hljs-number">100</span></span> * random.nextInt(<span class="hljs-number"><span class="hljs-number">20</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"worker 2 : "</span></span> + message); Thread.sleep(<span class="hljs-number"><span class="hljs-number">100</span></span> * random.nextInt(<span class="hljs-number"><span class="hljs-number">20</span></span>)); }</code> </pre><br>  Result: <br><pre> 2015-06-23 22: 03: 48.018 INFO 6784 --- [nio-8080-exec-1] com.rabbitmq.example2.SampleController: Emit to queue
 2015-06-23 22: 03: 48.029 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 2: Message 1
 2015-06-23 22: 03: 48.029 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 1: Message 0
 2015-06-23 22: 03: 48.830 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 2: Message 2
 2015-06-23 22: 03: 49.331 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 2: Message 3
 2015-06-23 22: 03: 49.432 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 2: Message 4
 2015-06-23 22: 03: 49.634 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 1: Message 5
 2015-06-23 22: 03: 49.733 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 2: Message 6
 2015-06-23 22: 03: 49.735 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 1: Message 7
 2015-06-23 22: 03: 50.236 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 1: Message 8
 2015-06-23 22: 03: 50.537 INFO 6784 --- [cTaskExecutor-1] com.rabbitmq.example2.RabbitMqListener: worker 1: Message 9
</pre><br><br><div class="spoiler">  <b class="spoiler_title">RabbitMqListener.java source code and updated SampleController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example2; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.RabbitListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitMqListener</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitMqListener.class); Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"worker 1 : "</span></span> + message); Thread.sleep(<span class="hljs-number"><span class="hljs-number">100</span></span> * random.nextInt(<span class="hljs-number"><span class="hljs-number">20</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"worker 2 : "</span></span> + message); Thread.sleep(<span class="hljs-number"><span class="hljs-number">100</span></span> * random.nextInt(<span class="hljs-number"><span class="hljs-number">20</span></span>)); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example2; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.AmqpTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> AmqpTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/queue"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Emit to queue"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">10</span></span>;i++) template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"query-example-2"</span></span>,<span class="hljs-string"><span class="hljs-string">"Message "</span></span> + i); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Emit to queue"</span></span>; } }</code> </pre><br></div></div><br><h2>  Example 3. Publish / Subscribe </h2><br><img src="https://habrastorage.org/files/551/02c/5a3/55102c5a339845ed973eb1418f825543.png"><br><br>  Here the same message comes at once to two consumers. <br><br><pre> 2015-06-23 22: 12: 24.669 INFO 1664 --- [nio-8080-exec-1] com.rabbitmq.example3.SampleController: Emit to exchange-example-3
 2015-06-23 22: 12: 24.684 INFO 1664 --- [cTaskExecutor-1] com.rabbitmq.example3.RabbitMqListener: accepted on worker 1: Fanout message
 2015-06-23 22: 12: 24.684 INFO 1664 --- [cTaskExecutor-1] com.rabbitmq.example3.RabbitMqListener: accepted on worker 2: Fanout message
</pre><br>  To do this, let's connect both queues to FanoutExchange: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FanoutExchange </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fanoutExchangeA</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FanoutExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-3"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue1()).to(fanoutExchangeA()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(fanoutExchangeA()); }</code> </pre><br>  And we will send not to the queue, but in exchange exchange-example-3: <br><br><pre> <code class="java hljs"> template.setExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-3"</span></span>); template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"Fanout message"</span></span>);</code> </pre><br>  Each time specify the exchange is optional.  You can specify it once when creating a RabbitTemplate. <br><br><div class="spoiler">  <b class="spoiler_title">Full source codes</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example3; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.EnableRabbit; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.ConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-meta"><span class="hljs-meta">@EnableRabbit</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConfiguration</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitConfiguration.class); <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ConnectionFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ CachingConnectionFactory connectionFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingConnectionFactory(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connectionFactory; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AmqpAdmin </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amqpAdmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RabbitAdmin rabbitAdmin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitAdmin(connectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rabbitAdmin; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RabbitTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rabbitTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RabbitTemplate rabbitTemplate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitTemplate(connectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rabbitTemplate; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Queue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myQueue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Queue(<span class="hljs-string"><span class="hljs-string">"query-example-3-1"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Queue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myQueue2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Queue(<span class="hljs-string"><span class="hljs-string">"query-example-3-2"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FanoutExchange </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fanoutExchangeA</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FanoutExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-3"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue1()).to(fanoutExchangeA()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(fanoutExchangeA()); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example3; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.RabbitListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitMqListener</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitMqListener.class); Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-3-1"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"accepted on worker 1 : "</span></span> + message); } <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-3-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"accepted on worker 2 : "</span></span> + message); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example3; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> RabbitTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Empty mapping"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Emit to exchange-example-3"</span></span>); template.setExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-3"</span></span>); template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"Fanout message"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Emit to exchange-example-3"</span></span>; } }</code> </pre><br></div></div><br><br><h2>  Example 4. Routing </h2><br><img src="https://habrastorage.org/files/804/21c/1cf/80421c1cfaa54a789bf388f11a10a1a8.png"><br><br>  It uses the routing key, depending on which message can go to one of the queues or both at once.  To do this, instead of using FanoutExchange, use DirectExchange: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DirectExchange </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">directExchange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-4"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorBinding1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue1()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"error"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorBinding2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"error"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">infoBinding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"info"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warningBinding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"warning"</span></span>); }</code> </pre><br><br>  And when sending we use we specify the Routing key, for example, <br><br><pre> <code class="java hljs"> template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"info"</span></span>, <span class="hljs-string"><span class="hljs-string">"Info"</span></span>);</code> </pre><br>  The result is: <br><br><pre> 2015-06-23 22: 29: 24.480 INFO 5820 --- [nio-8080-exec-2] com.rabbitmq.example4.SampleController: Emit as info
 2015-06-23 22: 29: 24.483 INFO 5820 --- [cTaskExecutor-1] com.rabbitmq.example4.RabbitMqListener: accepted on worker 2: Info
 2015-06-23 22: 29: 29.721 INFO 5820 --- [nio-8080-exec-4] com.rabbitmq.example4.SampleController: Emit as error
 2015-06-23 22: 29: 29.727 INFO 5820 --- [cTaskExecutor-1] com.rabbitmq.example4.RabbitMqListener: accepted on worker 2: Error
 2015-06-23 22: 29: 29.731 INFO 5820 --- [cTaskExecutor-1] com.rabbitmq.example4.RabbitMqListener: accepted on worker 1: Error
 2015-06-23 22: 29: 36.779 INFO 5820 --- [nio-8080-exec-5] com.rabbitmq.example4.SampleController: Emit as warning
 2015-06-23 22: 29: 36.781 INFO 5820 --- [cTaskExecutor-1] com.rabbitmq.example4.RabbitMqListener: accepted on worker 2: Warning
</pre><br><br><div class="spoiler">  <b class="spoiler_title">Full source codes</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example4; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.EnableRabbit; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.ConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-meta"><span class="hljs-meta">@EnableRabbit</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConfiguration</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitConfiguration.class); <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ConnectionFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ CachingConnectionFactory connectionFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingConnectionFactory(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connectionFactory; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AmqpAdmin </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amqpAdmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RabbitAdmin rabbitAdmin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitAdmin(connectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rabbitAdmin; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RabbitTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rabbitTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RabbitTemplate rabbitTemplate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitTemplate(connectionFactory()); rabbitTemplate.setExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-4"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rabbitTemplate; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Queue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myQueue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Queue(<span class="hljs-string"><span class="hljs-string">"query-example-4-1"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Queue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myQueue2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Queue(<span class="hljs-string"><span class="hljs-string">"query-example-4-2"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DirectExchange </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">directExchange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-4"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorBinding1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue1()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"error"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorBinding2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"error"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">infoBinding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"info"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warningBinding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(directExchange()).with(<span class="hljs-string"><span class="hljs-string">"warning"</span></span>); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example4; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.RabbitListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitMqListener</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitMqListener.class); Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-4-1"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"accepted on worker 1 : "</span></span> + message); } <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-4-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"accepted on worker 2 : "</span></span> + message); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example4; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> RabbitTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Empty mapping"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit/error"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Emit as error"</span></span>); template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-string"><span class="hljs-string">"Error"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Emit as error"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit/info"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Emit as info"</span></span>); template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"info"</span></span>, <span class="hljs-string"><span class="hljs-string">"Info"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Emit as info"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit/warning"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warning</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Emit as warning"</span></span>); template.convertAndSend(<span class="hljs-string"><span class="hljs-string">"warning"</span></span>, <span class="hljs-string"><span class="hljs-string">"Warning"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Emit as warning"</span></span>; } }</code> </pre><br></div></div><br><h2>  Example 5. Topics </h2><br><img src="https://habrastorage.org/files/73f/c40/d68/73fc40d68dae4bd1a470e178a7747813.png"><br><br>  Here, instead of DirectExchange, we use TopicExchange. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TopicExchange </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">topicExchange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TopicExchange(<span class="hljs-string"><span class="hljs-string">"exchange-example-5"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue1()).to(topicExchange()).with(<span class="hljs-string"><span class="hljs-string">"*.orange.*"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(topicExchange()).with(<span class="hljs-string"><span class="hljs-string">"*.*.rabbit"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Binding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binding3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BindingBuilder.bind(myQueue2()).to(topicExchange()).with(<span class="hljs-string"><span class="hljs-string">"lazy.#"</span></span>); }</code> </pre><br>  The result is: <br><br><pre> 2015-06-23 22: 42: 28.414 INFO 6560 --- [nio-8080-exec-1] com.rabbitmq.example5.SampleController: Emit 'to 1 and 2' to 'quick.orange.rabbit'
 2015-06-23 22: 42: 28.428 INFO 6560 --- [cTaskExecutor-1] com.rabbitmq.example5.RabbitMqListener: accepted on worker 2: to 1 and 2
 2015-06-23 22: 42: 28.428 INFO 6560 --- [cTaskExecutor-1] com.rabbitmq.example5.RabbitMqListener: accepted on worker 1: to 1 and 2
 2015-06-23 22: 42: 55.802 INFO 6560 --- [nio-8080-exec-2] com.rabbitmq.example5.SampleController: Emit 'to 2' to 'lazy.black.cat'
 2015-06-23 22: 42: 55.805 INFO 6560 --- [cTaskExecutor-1] com.rabbitmq.example5.RabbitMqListener: accepted on worker 2: to 2
</pre><br><br><div class="spoiler">  <b class="spoiler_title">Full source codes</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example5; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.PathVariable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> RabbitTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Empty mapping"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit/{key}/{message}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"key"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String key, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PathVariable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"message"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String message) </span></span>{ logger.info(String.format(<span class="hljs-string"><span class="hljs-string">"Emit '%s' to '%s'"</span></span>,message,key)); template.convertAndSend(key, message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.format(<span class="hljs-string"><span class="hljs-string">"Emit '%s' to '%s'"</span></span>,message,key); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example5; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.RabbitListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitMqListener</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitMqListener.class); Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-5-1"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"accepted on worker 1 : "</span></span> + message); } <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-5-2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"accepted on worker 2 : "</span></span> + message); } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example5; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.PathVariable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> RabbitTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Empty mapping"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/emit/{key}/{message}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"key"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String key, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PathVariable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"message"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String message) </span></span>{ logger.info(String.format(<span class="hljs-string"><span class="hljs-string">"Emit '%s' to '%s'"</span></span>,message,key)); template.convertAndSend(key, message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.format(<span class="hljs-string"><span class="hljs-string">"Emit '%s' to '%s'"</span></span>,message,key); } }</code> </pre><br></div></div><br><br><h2>  Example 6. Remote procedure call (RPC) </h2><br><img src="https://habrastorage.org/files/7da/867/303/7da8673033db407aa58c3e02fc7fa711.png"><br><br>  Spring AMQP allows you to use convertSendAndReceive to receive a response to a sent message.  At the same time, with the default setting, if we have RabbitMQ versions up to 3.4.0, then a temporary queue will be created for the response message.  This method is not very productive, so it is not recommended to use it, and you should also create a queue for return messages yourself and specify it as RabbitTemplate ReplyQueue.  If we have RabbitMQ version 3.4.0 and higher, then the Direct reply-to mechanism will be used, which is much faster.  Read more in the <a href="http://docs.spring.io/spring-amqp/docs/1.4.5.RELEASE/reference/html/amqp.html">Spring AMQP documentation</a> . <br><br>  Thus, you can make a remote procedure call in just one line: <br><br><pre> <code class="java hljs"> String response = (String) template.convertSendAndReceive(<span class="hljs-string"><span class="hljs-string">"query-example-6"</span></span>,message);</code> </pre><br>  And so the procedure is processed on the conciermer: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-6"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"received on worker : "</span></span> + message); Thread.sleep(<span class="hljs-number"><span class="hljs-number">3000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   return "received on worker : " + message; }</span></span></code> </pre><br>  The result is: <br><br><pre> 2015-06-23 23: 12: 36.677 INFO 6536 --- [nio-8080-exec-5] com.rabbitmq.example6.SampleController: Emit 'Hello world'
 2015-06-23 23: 12: 36.679 INFO 6536 --- [cTaskExecutor-1] com.rabbitmq.example6.RabbitMqListener: Received on worker: Hello world
 2015-06-23 23: 12: 39.681 INFO 6536 --- [nio-8080-exec-5] com.rabbitmq.example6.SampleController: Received on producer 'Received on worker: Hello world'
</pre><br><br><div class="spoiler">  <b class="spoiler_title">Full source codes</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example6; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.AmqpAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.core.Queue; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.EnableRabbit; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.connection.ConnectionFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitAdmin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-meta"><span class="hljs-meta">@EnableRabbit</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConfiguration</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitConfiguration.class); <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ConnectionFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ CachingConnectionFactory connectionFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingConnectionFactory(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connectionFactory; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AmqpAdmin </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amqpAdmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RabbitAdmin rabbitAdmin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitAdmin(connectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rabbitAdmin; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RabbitTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rabbitTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RabbitTemplate rabbitTemplate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RabbitTemplate(connectionFactory()); rabbitTemplate.setQueue(<span class="hljs-string"><span class="hljs-string">"query-example-6"</span></span>); rabbitTemplate.setReplyTimeout(<span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//no reply to - we use direct-reply-to return rabbitTemplate; } @Bean public Queue myQueue() { return new Queue("query-example-6"); } }</span></span></code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example6; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.annotation.RabbitListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitMqListener</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(RabbitMqListener.class); <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(queues = <span class="hljs-string"><span class="hljs-string">"query-example-6"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Received on worker : "</span></span> + message); Thread.sleep(<span class="hljs-number"><span class="hljs-number">3000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Received on worker : "</span></span> + message; } }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.rabbitmq.example6; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.amqp.rabbit.core.RabbitTemplate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Controller; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.PathVariable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.RequestMapping; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.annotation.ResponseBody; <span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleController</span></span></span><span class="hljs-class"> </span></span>{ Logger logger = Logger.getLogger(SampleController.class); <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> RabbitTemplate template; <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Empty mapping"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/process/{message}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"message"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String message) </span></span>{ logger.info(String.format(<span class="hljs-string"><span class="hljs-string">"Emit '%s'"</span></span>,message)); String response = (String) template.convertSendAndReceive(<span class="hljs-string"><span class="hljs-string">"query-example-6"</span></span>,message); logger.info(String.format(<span class="hljs-string"><span class="hljs-string">"Received on producer '%s'"</span></span>,response)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.valueOf(<span class="hljs-string"><span class="hljs-string">"returned from worker : "</span></span> + response); } }</code> </pre><br></div></div><br><h2>  Conclusion </h2><br>  I used RabbitMQ in my project in the heroku cloud hosting.  Using heroku's RabbitMQ is quite simple - just connect one of the RabbitMQ providers in the administration console and then the address for accessing the rabbit appears in the environment variables.  This address must be used when creating a connectionFactory. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ConnectionFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  AMQP   String uri = System.getenv("CLOUDAMQP_URL"); if (uri == null) //         rabbitmq uri = "amqp://guest:guest@localhost"; URI url = null; try { url = new URI(uri); } catch (URISyntaxException e) { e.printStackTrace(); //    } CachingConnectionFactory connectionFactory = new CachingConnectionFactory(); connectionFactory.setHost(url.getHost()); connectionFactory.setUsername(url.getUserInfo().split(":")[0]); connectionFactory.setPassword(url.getUserInfo().split(":")[1]); if (StringUtils.isNotBlank(url.getPath())) connectionFactory.setVirtualHost(url.getPath().replace("/", "")); connectionFactory.setConnectionTimeout(3000); connectionFactory.setRequestedHeartBeat(30); return connectionFactory; }</span></span></code> </pre><br>  The rest of the code differs little from that shown in Example 4 (Routing). <br><br><h2>  Used sources </h2><br>  <a href="http://projects.spring.io/spring-amqp/">Spring</a> Project Page <a href="http://projects.spring.io/spring-amqp/">AMQP</a> <br>  <a href="http://projects.spring.io/spring-boot/">Spring Boot</a> Project Page <br>  Examples page <a href="http://www.rabbitmq.com/getstarted.html">RabbitMQ</a> </div><p>Source: <a href="https://habr.com/ru/post/262069/">https://habr.com/ru/post/262069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262057/index.html">Twelve simple initial steps to developing a module for Node.js</a></li>
<li><a href="../262061/index.html">Malefactors actively use 0day vulnerability of Flash Player for cyber attacks</a></li>
<li><a href="../262063/index.html">Almost duplicate search and geometry</a></li>
<li><a href="../262065/index.html">Combining offices in 3CX (Part 2. Use Session Boarder Controller)</a></li>
<li><a href="../262067/index.html">Plot chat, or how we won first place on wth.by</a></li>
<li><a href="../262071/index.html">How to correctly select and buy Backup Exec 15</a></li>
<li><a href="../262073/index.html">Horizontal scaling of database servers for OLTP systems, or what is on the market</a></li>
<li><a href="../262075/index.html">Writing for Apple Watch something harder Hello, world</a></li>
<li><a href="../262077/index.html">Digest of grocery design, June 2015</a></li>
<li><a href="../262079/index.html">Visualization of static and dynamic networks on R, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>