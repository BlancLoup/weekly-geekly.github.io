<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The architecture of the system of receiving electronic payments on the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many projects, there comes a time when you want the site to make a profit. 
 And not only in the form of payment of advertising banners or context...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The architecture of the system of receiving electronic payments on the site</h1><div class="post__text post__text-html js-mediator-article">  For many projects, there comes a time when you want the site to make a profit. <br>  And not only in the form of payment of advertising banners or contextual advertising, but also in the form of money from its visitors. <br><br>  No matter what they offer - a cool special effect on an avatar, a T-shirt with the symbols of the project or access to private messages of the first beauty of the site.  It is important how to get money for it.  And it is desirable immediately, until the user has decided not to spend their money. <br><br>  Such a restriction immediately leads to deletion from the list of payment methods filling out a receipt in Sberbank.  Yes, this is also a method, but the method is not fast.  Especially if it's late evening outside, the user relaxed over a <s>bottle of beer with a</s> cup of tea.  What a Sberbank, to take it lukewarm, lukewarm! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  What are the ways to organize the reception of more or less instant payments come to mind in the first place?  Personally, I just came to mind three at once: <br><ul><li>  SMS </li><li>  plastic cards </li><li>  electronic money </li></ul>  Each method has its own advantages and disadvantages. <br>  <i><b>Payments via SMS</b></i> - a big commission, but almost every user has a mobile phone. <br>  <i><b>Plastic cards</b></i> are not common enough (yes, yes, the residents of Default City, there is a life outside the Ring Road, too, ready to pay!), But the commission is minimal. <br>  <i><b>Electronic money</b></i> - a lot of different systems, technical and legal difficulties of connection, but the audience is big!  And how to replenish! <br><br>  Not stopping in this article on the first two methods, I want to talk about the organization of reception on the website of electronic currencies.  Such as <a href="http://webmoney.ru/">WebMoney</a> , <a href="http://money.yandex.ru/">Yandex.Money</a> , <a href="https://money.mail.ru/">Money@Mail.Ru</a> and the like.  We don‚Äôt care about the implementation of work in each specific case, you can read about it in the documentation for these payment systems (PS), and in various kinds of success stories and failures. <br><br>  The main idea that should arise after reading the article (and I hope it will arise) - having correctly designed a payment acceptance system, it will not be difficult to connect each new system. <br><br>  <i>Immediately make a reservation, further under the "account" I will understand not the <b>account</b> , but rather <b>invoice</b> .</i>  <i>And for convenience, in order not to be confused between the user's account, which contains information about payments, the size of the user's payment balance, etc., and the invoice for payment of something, I will call the latter the ‚Äúapplication‚Äù or ‚Äúorder‚Äù.</i> <br><br>  In general, the payment systems that I have come across are divided into two types: <ul><li>  independently informing the seller of the fact of payment (as a rule, sending some data in the background to a pre-specified URL). </li><li>  and systems that need to be polled for payment status. </li></ul>  The implementation of the scheme of working with both types is almost the same, but the first one is much simpler - it is enough to somehow separate the order number in our system from the data stream and call a single function that changes the status of the request to ‚Äúpaid‚Äù. <br><br>  Therefore, let's talk about the second. <br>  A typical scenario of working with such systems from the seller‚Äôs point of view is as follows: <br><ol><li>  initialization of the payment process by the user, saving of the request for payment </li><li>  Formation of an application based on our billing data, signature of an application with a secret key or certificate </li><li>  sending data to the payment system and getting the order number in their accounting system </li><li>  saving this number in our system </li><li>  questioning the payment system to change the status of this order </li><li>  change of application status in our system, user service </li></ol><br><br>  If we are talking about payments, then of course, to account for payments / user requests, some kind of billing is needed.  It can be arbitrarily complex or simple, for us it can be a ‚Äúblack box‚Äù: we only need two things from it: the amount of the application and its number. <br>  I think you should not specifically discuss why this number should be unique, right? <br>  The rest of the billing data (for example, some textual description of the service) is optional. <br><br>  How to write billing correctly is a speech for a whole group of articles, so now it‚Äôs not about it. <br>  Who wants, questions about billing can ask me in private or by mail. <br><br>  So let's start with a common architecture. <br><br>  As it does not seem strange, the recipe for the architecture of the payment acceptance system according to the described scenario is very, very simple.  We will need: <br><br>  order queue - 1 pc. <br>  queue processing dispatcher - 1 pc. <br>  general library of work with applications - 1 pc. <br>  common web interface library - 1 pc. <br>  general library of work with payment systems - 1 pc. <br>  libraries work with specific payment systems - N pieces, by the number of systems. <br><br>  Now more about each of the parts. <br><br>  <b>1. What is the queue of applications?</b> <br>  Everything is simple - this is a table of applications of various statuses (in the simplest approximation - ‚Äúpaid‚Äù, ‚Äúunpaid‚Äù, ‚Äúin processing‚Äù).  We will need it both in order to save information about the application, and in order to understand which applications need to be sent for processing to the dispatcher. <br><br>  Readers who have already learned the words ‚Äúnormalization‚Äù and ‚Äúrelational database‚Äù will argue that there should be more tables, but I argue that one is enough. <br><br>  <b>2. Manager queue processing.</b> <br>  This is a kind of script running in the background as a demon or just crown, it does not matter. <br>  Its task is to process the queue of applications, access payment systems and change the status of applications. <br><br>  <b>3. Library work with applications.</b> <br>  In essence, this is a library for working with queues (read the ‚Äúdatabase‚Äù).  It just needs a few functions: <br><ul><li>  creating application </li><li>  getting information about the application </li><li>  Change in status and other application data </li><li>  getting an application from a queue </li><li>  removal of application </li></ul><br>  <b>4. Web interface.</b> <br>  For what it is needed, it is clear - to display information about the order to the user and so that the user can click on the ‚ÄúPay‚Äù button. <br><br>  From this library you need to be able to give the same data from several formats: at least html and json / xml.  HTML is understandable for what, and JSON is for using AJAX and not overloading pages.  In principle, it is possible without it. <br><br>  From the web interface, only 4 functions are needed: <br><ul><li>  call creation request function </li><li>  call the function of obtaining data on the application </li><li>  call delete order function </li><li>  and basic error handling and data output in the right format. </li></ul><br>  <b>5. Libraries of work with specific payment systems (BPS)</b> should be able to <br><ul><li>  generate the URL and data for the request to create an application in the PS. </li><li>  parse the answer of the payment system and return the order number in the numbering of the payment system </li><li>  generate URL and data for request status request </li><li>  parse the response of the payment system and return the status of the application. </li></ul><br>  <b>6. From the general library of work with payment systems (OB) you</b> will also need a little: <br><ul><li>  a function to receive data from BPS, which is necessary for creating an order, and sending this data to the payment system. </li><li>  function to send a response to the BPS and receive from there the status of the application </li><li>  function for working with general settings (for example, information about connected payment systems) </li></ul><br><br>  How to change the described scenario of work in the new terminology? <br><br>  <i>0. User initialization of the payment process.</i> <br><br>  The web interface displays a list of available payment systems and payment information. <br>  The user presses "Pay", an order is created with the status "new", information about it is placed in the queue.  At this moment, the user is issued a message ‚ÄúSch everything will be, wait‚Äù and check the status of the application from time to time.  Here you will need the same data about the application in JSON - while we draw the user on the screen all sorts of watch, progress bars, etc., using AJAX we query the queue about the status of the application. <br><br>  <i>1. Formation of an application based on our billing data, signature of the application with a secret key or certificate.</i> <i><br></i>  <i>2. sending data to the payment system and getting the order number in their accounting system</i> <i><br></i>  <i>3. saving this number in our system.</i> <i><br></i> <br><br>  The dispatcher removes the application with the status ‚Äúnew‚Äù from the queue, sets the status ‚Äúin processing‚Äù, transfers the data to the OB, receives the data necessary for sending to the UA.  Sends them, receives the answer, gives it to the OB, the one in BPS and receives the order number.  Saves the order number and URL for payment in our turn, puts the request status "ready for payment". <br><br>  At the next survey of the user's queue, we throw on the URL to continue the payment.  What he will do there is his business.  In case he realizes that he doesn‚Äôt have this e-currency, on the page with the order status, we‚Äôll give him a link to delete the order and create a new one with the ability to choose another currency. <br><br>  <i>4. survey of the payment system to change the status of the order.</i> <br>  Periodically, the dispatcher receives an application in the ‚Äúready for payment‚Äù status and checks its status in the payment system.  If the status does not change, put the application aside until better times. <br>  In a good way, you need to consider the "shelf life" of the application, so as not to interrogate the payment system indefinitely. <br><br>  <i>5. changing the status of the application in our system, providing services to the user.</i> <br>  As soon as the status has changed, the dispatcher marks the request as ‚Äúpaid for‚Äù or ‚Äúrejected‚Äù depending on the payment system‚Äôs response.  More she will not get to the dispatcher.  Now the background billing scripts will receive information that the invoice has been paid and will render the ordered service to the user. <br><br>  <b>What is good about the described system?</b> <br><br>  <b>1. It allows you to perform all operations with the user extremely quickly.</b> <br>  Saving the application to the queue, obtaining data on the application by a unique number is a very fast operation. <br>  All slow work is performed by the dispatcher in the background. <br><br>  <b>2. It scales well.</b> <br>  We can organize dozens of queues using various partitioning methods. <br>  Tens and hundreds of demons to handle each queue or status, or currency. <br><br>  <b>3. It is simple.</b> <br>  Connecting a new payment system is just adding a new library, which should be able to only 4 things described above. <br><br>  I do not voice the specific implementation details in this article - the tools are unimportant. <br><br>  This can be Perl or PHP, or Python for the web / work with the database. <br>  This can be MySQL, or SQLite, or Oracle, or PosgreSQL for queuing. <br>  This can be file_get_contents (), LWP :: UserAgent or CURL for working with HTTP. <br>  You can double the polling interval of the request status in the payment system by half.  You can in 3.14159 ... <br><br>  The implementation is yours. <br><br>  <b>upd: The</b> full text (including diagrams and additions) is posted <a href="http://www.maxbabich.ru/">on my website</a> </div><p>Source: <a href="https://habr.com/ru/post/75453/">https://habr.com/ru/post/75453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../75448/index.html">Google Translate Changes</a></li>
<li><a href="../75449/index.html">Google Translate Changes</a></li>
<li><a href="../75450/index.html">Open seminars - New technologies for education</a></li>
<li><a href="../75451/index.html">Place for D</a></li>
<li><a href="../75452/index.html">Habras users outwitted themselves</a></li>
<li><a href="../75454/index.html">Almost true multithreading with php 5</a></li>
<li><a href="../75456/index.html">I'm a Mac: Half YouTube</a></li>
<li><a href="../75460/index.html">WordPress 2.8.6 - Security Updates</a></li>
<li><a href="../75461/index.html">Antipiar BlastoffNetwork.com</a></li>
<li><a href="../75462/index.html">Windows Mobile Marketplace available for WM 6 and 6.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>