<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of one Russian RTOS, part 5. First application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The next publication of the review of features of the MAKS RTOS is ready. In the previous article, we dealt with theory, and today it is time to pract...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overview of one Russian RTOS, part 5. First application</h1><div class="post__text post__text-html js-mediator-article">  The next publication of the review of features of the MAKS RTOS is ready.  In the previous article, we dealt with theory, and today it is time to practice. <br><br>  <a href="https://habrahabr.ru/post/336308/">Part 1. General information</a> <br>  <a href="https://habrahabr.ru/post/336696/">Part 2. Core MAX MAX</a> <br>  <a href="https://habrahabr.ru/post/336944/">Part 3. The structure of the simplest program</a> <br>  <a href="https://habrahabr.ru/post/337476/">Part 4. Useful theory</a> <br>  Part 5. First Attachment (this article) <br>  <a href="https://habrahabr.ru/post/338682/">Part 6. Thread synchronization tools</a> <br>  <a href="https://habrahabr.ru/post/339498/">Part 7. Means of data exchange between tasks</a> <br>  <a href="https://habrahabr.ru/post/340032/">Part 8. Work with interruptions</a> <br><br>  When you start working with controllers, it is customary to blink the LEDs.  I will break this tradition. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, it is corny tired.  Secondly, LEDs consume too much current.  Do not rush to think that I save every milliwatt, just in the course of work, this saving will be extremely important to us.  Again, what we will see below is almost impossible to see on LEDs. <br><br>  So, while there is no project generator, we take the default project for our prototype board and my favorite compiler (I took <a name="habracut"></a>  <b>... \ maksRTOS \ Compilers \ STM32F4xx \ MDK-ARM 5 \ Projects \ Default)</b> and copy it under a different name (I did it <b>... \ maksRTOS \ Compilers \ STM32F4xx \ MDK-ARM 5 \ Projects \ Test1)</b> .  Also read-only attribute should be removed from all files. <br><br><img src="https://habrastorage.org/web/390/533/cb4/390533cb48b9446fa037da5c6d821b5c.png" alt="image"><br><br>  The project file directory is quite spartan. <br><br>  DefaultApp.cpp <br>  DefaultApp.h <br>  main.cpp <br>  MaksConfig.h <br><br>  The file main.cpp refers to the canonical example, the files DefaultApp.cpp and DefaultApp.h describe the empty class derived from Application.  We will use the file MaksConfig.h to change the system options. <br><br>  If you open a project, it turns out that a huge number of operating system files are connected to it. <br><br><img src="https://habrastorage.org/web/c79/fe9/3cf/c79fe93cfe074025b4dae59b91cde7a7.png" alt="image"><br><br>  In the properties of the project also has a rabid number of settings. <br><br><img src="https://habrastorage.org/web/059/15c/796/05915c7963b44667ac37de176691205c.png" alt="image"><br><br>  So you should not even hope to create a project from scratch.  We'll have to accept the fact that it should be either copied from the empty project by default, or created using automatic utilities. <br><br>  For further discussion, I am torn between "correct" and "readable."  The fact is that it is right to start creating files for tasks, and a separate header file, separately a file with a code.  However, the reader will be confused in what the author will do.  This approach is good at creating video tutorials.  Therefore, I will go another way - I will start adding new classes to the DefaultApp.h file.  This is fundamentally wrong in practical work, but the code will be more or less readable in the document. <br><br>  So.  We will not blink the LEDs.  We will change the state of a pair of pins of the controller, and observe the results on an oscilloscope. <br><br>  Let's make a class of a task which is engaged in this movement.  We do not know how to use drivers yet, so we will turn to ports in the old manner.  Choose a couple of free ports on the board.  Let it be PE2 and PE3.  That they are free, I derived from the following table contained in the description of the STM32F429-DISCO board: <br><br><img src="https://habrastorage.org/web/040/e58/004/040e580040e840a5a6a0b8a2fd73a719.png" alt="image"><br><br>  First, we will make a class that moves PE2 with its foot, then we will remake it into a patterned look. <br>  Go to the DefaultApp.h file (as we remember, this is wrong for real work, but clearly for the text) and create a class that inherits from Task.  What should I add?  That's right, the constructor and the execute () function.  Fine, we write (the first and last lines are left as reference, so that it is clear exactly where we are writing): <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"maksRTOS.h"</span></span></span><span class="hljs-meta"> class Blinker : public Task { public: Blinker (const char * name = nullptr) : Task (name){} virtual void Execute() { while (true) { GPIOE-&gt;BSRR = (1</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;2); GPIOE-&gt;BSRR = (1&lt;&lt;(2+16)); } } }; class DefaultApp : public Application</span></span></span></span></code> </pre> <br>  The task jerking PE2 is ready.  But now it is necessary <br><br><ul><li>  Enable port E clocking; </li><li>  Connect the task to the scheduler. </li></ul><br><br>  Where is it most convenient to do?  That's right, we already know that this is most conveniently done in the function <br><br> <code>void DefaultApp::Initialize()</code> <br> <br>  the blessing preparation is already available.  We write something like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DefaultApp::Initialize() { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">//    E RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOEEN; //  PE2  PE3   GPIOE-&gt;MODER = GPIO_MODER_MODER2_0 | GPIO_MODER_MODER3_0; //     Task::Add (new Blinker ("Blink_PE2")); }</span></span></code> </pre> <br>  We sew in the plan ... Oh, and the project uses the default simulator. <br><br><img src="https://habrastorage.org/web/a00/e09/aec/a00e09aecd344ab59fdf672fd7223b44.png" alt="image"><br><br>  Well, we are switching to JTAG adapter (in case of STM32F429-DISCO card - to ST-Link). <br><br><img src="https://habrastorage.org/web/7c4/bc7/30d/7c4bc730d78541828819767cf2a3714a.png" alt="image"><br><br>  Now everything can be poured into the board.  Fill, connect the oscilloscope to the PE2 line, observe ... <br><br><img src="https://habrastorage.org/web/a92/348/1f9/a923481f9c004eb29af1bd6236b2cc83.png" alt="image"><br><br>  Beauty!  Only some low-speed performance. <br><br><img src="https://habrastorage.org/web/82d/4d0/1ee/82d4d01eeab640ecae497558fe3f4204.png" alt="image"><br><br>  Replacing optimization from level 0 to level 3 <br><br><img src="https://habrastorage.org/web/69f/217/e29/69f217e2931e4708af5fbf5b5025a436.png" alt="image"><br><br>  And ... Everything stops working altogether <br><br><img src="https://habrastorage.org/web/7c1/bb1/558/7c1bb1558e6243c8b14c4551fc6806a6.png" alt="image"><br><br>  Trying to trace - works fine in steps.  What a miracle?  Well, these are not OS problems, these are microcontroller problems, he doesn‚Äôt like the nearby commands to write to the port.  The key to this effect is in the output current settings of the transistors.  Higher current - more ringing, but higher speed.  By default, all outputs are configured for minimum speed.  And our optimizer has cleared everything up well: <br><br> <code>0x08004092 6182 STR r2,[r0,#0x18] <br> 0x08004094 6181 STR r1,[r0,#0x18] <br> 0x08004096 E7FC B 0x08004092</code> <br> <br>  You can, of course, raise the output speed at the port configuration stage <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//     GPIOE-&gt;OSPEEDR |= (3&lt;&lt;(2*2))|(3&lt;&lt;(3*2));</span></span></code> </pre><br>  But the signal will obviously have the wrong porosity (Up, then down, then the transition delay).  To improve the signal, correct the code of the main loop as follows: <br><br><img src="https://habrastorage.org/web/600/562/acd/600562acd3ac4386907905018e54d2a9.png"><br><div class="spoiler">  <b class="spoiler_title">same text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> {nop} GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(<span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">16</span></span>)); } } };</code> </pre> <br></div></div><br>  Here it turns up, then a delay at the NOP, then a down, then a transition delay, which provides a duty cycle close to 50% (in the comments below it was precisely calculated that there are actually 3 clocks in the unit and 5 clocks in zero, but this closer to 50% than 1 to 5, and on the existing oscilloscope the difference in the upper and lower parts of the pulses is still almost impossible to notice).  And the output speed is already enough even in low-noise mode.  The output frequency was 168 / (3 + 5) = 21 MHz. <br><br><img src="https://habrastorage.org/web/4c9/524/814/4c952481490d4397a3c2ef3e9c50bc99.png" alt="image"><br><br>  True, on a different scale, no, no, yes, and such black holes will slip through <br><br><img src="https://habrastorage.org/web/6fb/044/cda/6fb044cda3e3417cbb84d4581f0830d1.png" alt="image"><br><br>  This we observe the work of the scheduler.  We have one task, but periodically they take control from her to check whether it is possible to transfer it to someone else.  If there are no other tasks, control is returned to the only one that is.  Well, add the second task, which will pull PE3.  Place the bit number in the member variable of the class, and configure it through the constructor <br><br><img src="https://habrastorage.org/web/5c7/99c/933/5c799c9335b84b749285c81dc3d77b65.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Blinker</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_nBit; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Blinker (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nBit,<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) : Task (name),m_nBit(nBit){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;m_nBit); GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(m_nBit+<span class="hljs-number"><span class="hljs-number">16</span></span>)); } } };</code> </pre> <br></div></div><br>  And adding tasks to the scheduler is like this: <br><br><img src="https://habrastorage.org/web/2da/420/94f/2da42094f4d547f5b19510fb058b640a.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DefaultApp::Initialize() { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">//    E RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOEEN; //  PE2  PE3   GPIOE-&gt;MODER = GPIO_MODER_MODER2_0 | GPIO_MODER_MODER3_0; //     Task::Add (new Blinker (2,"Blink_PE2")); Task::Add (new Blinker (3,"Blink_PE3")); }</span></span></code> </pre> <br></div></div><br>  Connect the second channel of the oscilloscope to the output PE3.  Now sometimes there are pulses on one channel. <br><br><img src="https://habrastorage.org/web/b1b/6f7/bb4/b1b6f7bb43b14cdda03f439cd524b9b9.png" alt="image"><br><br>  Oh, what a low frequency ... No, false start.  Rewrite the task on the templates ... <br><br><img src="https://habrastorage.org/web/50a/5ea/1ae/50a5ea1ae6be468e9a559025aab2a78e.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nBit&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Blinker</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Blinker (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) : Task (name){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;nBit); <span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> {nop} GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(nBit+<span class="hljs-number"><span class="hljs-number">16</span></span>)); } } };</code> </pre> <br></div></div><br>  And its planning statement is like this: <br><br><img src="https://habrastorage.org/web/734/446/1d3/7344461d3a3b4de2ba258e71029f37fe.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> Task::Add (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blinker&lt;<span class="hljs-number"><span class="hljs-number">2</span></span>&gt; (<span class="hljs-string"><span class="hljs-string">"Blink_PE2"</span></span>)); Task::Add (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blinker&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>&gt; (<span class="hljs-string"><span class="hljs-string">"Blink_PE3"</span></span>));</code> </pre> <br></div></div><br>  So.  Now, sometimes pulses (with the correct frequency) go on the same channel: <br><br><img src="https://habrastorage.org/web/2c3/feb/087/2c3feb087e064876b8fd4092d5ef0132.png" alt="image"><br><br>  And sometimes - on the other. <br><br><img src="https://habrastorage.org/web/780/e88/e5a/780e88e5a3ac4ffcb89d69ffe7d8af80.png" alt="image"><br><br>  You can select the scale on which time slices are visible.  At the same time, we measure and make sure that one quantum is indeed equal to one millisecond (up to the scale of the oscilloscope screen) <br><br><img src="https://habrastorage.org/web/c73/ff0/d03/c73ff0d03a3f470980564afb1d877990.png" alt="image"><br><br>  You can make sure that the scheduler still needs time to switch tasks (and more than at the time when there was one task) <br><br><img src="https://habrastorage.org/web/e55/496/031/e554960312ea426fa74159bd4a9bf6a7.png" alt="image"><br><br>  Now let's consider the work of threads with different priorities.  Add a fun task that ‚Äúgoes out, goes out‚Äù <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Funny (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) : Task (name){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { Delay (<span class="hljs-number"><span class="hljs-number">5</span></span>); CpuDelay (<span class="hljs-number"><span class="hljs-number">5</span></span>); } } };</code> </pre> <br>  And add it to the higher priority scheduler. <br><br><img src="https://habrastorage.org/web/fb4/f3b/caf/fb4f3bcaf29b457dbcbe7d504bfec3d4.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> Task::Add (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blinker&lt;<span class="hljs-number"><span class="hljs-number">2</span></span>&gt; (<span class="hljs-string"><span class="hljs-string">"Blink_PE2"</span></span>)); Task::Add (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blinker&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>&gt; (<span class="hljs-string"><span class="hljs-string">"Blink_PE3"</span></span>)); Task::Add (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Funny (<span class="hljs-string"><span class="hljs-string">"FunnyTask"</span></span>),Task::PriorityHigh);</code> </pre> <br></div></div><br>  This task takes half the time to delay without context switching.  Since its priority is higher than the others, control will not be transferred to anyone else.  Half the time task is asleep.  That is, it is in a locked state.  That is, threads with normal priority will work at this time.  Check? <br><br><img src="https://habrastorage.org/web/77b/634/a6c/77b634a6c46d4ca18eec7dbef09e94f4.png" alt="image"><br><br>  Actually, what was required to prove.  The pause is equal to five milliseconds (highlighted by cursors), and during normal tasks, the context has time to switch between them.  Here is another scale so that it can be seen that this is not an accident, but statistics <br><br><img src="https://habrastorage.org/web/02f/7c2/cb4/02f7c2cb480848259a372ea649450311.png" alt="image"><br><br>  We remove the work of this terrible task.  We will continue with the two main <br>  Task :: Add (new Blinker &lt;2&gt; ("Blink_PE2")); <br>  Task :: Add (new Blinker &lt;3&gt; ("Blink_PE3")); <br><br>  Finally, we will translate the port pulling from the ‚ÄúVery puffy‚Äù mode to the more real one.  To LED will not bring.  Let's say we make a period of 10 milliseconds <br><br><img src="https://habrastorage.org/web/ef5/9c0/ce9/ef59c0ce97fc4b18996e97556e2dcc47.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Blinker</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Blinker (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) : Task (name){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;nBit); Delay (<span class="hljs-number"><span class="hljs-number">5</span></span>); GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(nBit+<span class="hljs-number"><span class="hljs-number">16</span></span>)); Delay (<span class="hljs-number"><span class="hljs-number">5</span></span>); } } };</code> </pre> <br></div></div><br>  Teprer connect ammeter.  For the STM32F429-DISCO board, remove jumper JP3 and turn on the device instead of it, as stated in the documentation: <br><br><img src="https://habrastorage.org/web/7b8/193/0a1/7b81930a12d043049095a90befc1cb26.png" alt="image"><br><br>  We measure the current consumed by this version of the program. <br><br><img src="https://habrastorage.org/web/721/f2f/861/721f2f86188c44518f70fe5fa8c14e32.jpg" alt="image"><br><br>  Go to the file MaksConfig.h and add the line there: <br>  #define MAKS_SLEEP_ON_IDLE 1 <br><br><img src="https://habrastorage.org/web/8dc/33f/050/8dc33f05017845208c3af5105c173ad1.png" alt="image"><br><br>  We put together a project, ‚Äúflashing‚Äù the result into the board, look at the ammeter: <br><br><img src="https://habrastorage.org/web/781/ff7/f8a/781ff7f8afee40efbf2452d8c1a7aed8.jpg" alt="image"><br><br>  Soooo, another theoretical thing checked in practice.  It works too.  But if we blinked with a LED, then it would consume, then not consume 10 mA, which is quite significant against the background of the measured values. <br><br>  Well, and finally, replace the multi-tasking cooperative.  To do this, add a constructor to the application class. <br><br><img src="https://habrastorage.org/web/1ce/42a/5e1/1ce42a5e174c4cbfa2a2496412843f1f.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultApp</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Application { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: DefaultApp() : Application (<span class="hljs-literal"><span class="hljs-literal">false</span></span>){} <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre> <br></div></div><br>  And we will make sure that tasks after three pulses to the port transfer control to each other.  We will also add delays so that the delay on the oscilloscope doesn‚Äôt take the image of another task behind the screen. <br><br><img src="https://habrastorage.org/web/b11/997/cee/b11997cee7d84b429052578496a38a10.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nBit&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Blinker</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Blinker (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) : Task (name){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>;i++) { GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;nBit); CpuDelay (<span class="hljs-number"><span class="hljs-number">1</span></span>); GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(nBit+<span class="hljs-number"><span class="hljs-number">16</span></span>)); CpuDelay (<span class="hljs-number"><span class="hljs-number">1</span></span>); } Yield(); } } };</code> </pre> <br></div></div><br>  What is there on the oscilloscope? <br><br><img src="https://habrastorage.org/web/061/897/9e5/0618979e595447ed88af33c2a0b45925.png" alt="image"><br><br>  Actually, we wanted triples of impulses - we received them. <br>  Well, finally, let's add a virtual function. <br><br><img src="https://habrastorage.org/web/e74/c11/9e9/e74c119e9abc40208f2704c18c14e906.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultApp</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Application { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: DefaultApp() : Application (<span class="hljs-literal"><span class="hljs-literal">true</span></span>){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ALARM_ACTION </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ALARM_REASON reason)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> ALARM_REASON r = reason; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre> <br></div></div><br>  and try to cause any problem.  For example, create a critical section in a task with a normal level of privileges. <br><br><pre> <code class="cpp hljs"> Blinker (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) : Task (name){} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ CriticalSection cs; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;nBit); Delay (<span class="hljs-number"><span class="hljs-number">5</span></span>); GPIOE-&gt;BSRR = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(nBit+<span class="hljs-number"><span class="hljs-number">16</span></span>)); Delay (<span class="hljs-number"><span class="hljs-number">5</span></span>); }</code> </pre> <br>  We start the project for debugging, put a breakpoint on the next line <br><br><img src="https://habrastorage.org/web/8ff/2db/1c1/8ff2db1c16a94f94b773a411137da185.png"><br><br>  after which we launch for execution (F5).  Instantly we get a stop (if it doesn't work, click on the ‚ÄúStop‚Äù icon). <br><br><img src="https://habrastorage.org/web/974/48f/6d0/97448f6d0d41434e9cfbaf1251c7c50e.png"><br><br>  In the line where the break occurred, we move the cursor to the variable reason.  We get the following result: <br><br><img src="https://habrastorage.org/web/bc7/557/74a/bc755774aa934e8bbe62836471425ffb.png"><br><br>  Well, we have completed the verification of the first basic theoretical calculations; we can proceed to the next <a href="https://habrahabr.ru/post/338682/">large complex section</a> . </div><p>Source: <a href="https://habr.com/ru/post/337974/">https://habr.com/ru/post/337974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337962/index.html">Where to go vendor when Amazon is too tough: we come up with a marketplace for niche gadgets</a></li>
<li><a href="../337964/index.html">Docker, or There and back</a></li>
<li><a href="../337968/index.html">What do large successful open source projects have in common?</a></li>
<li><a href="../337970/index.html">People's Privacy Policy</a></li>
<li><a href="../337972/index.html">On the factor of the case when playing "Monopoly"</a></li>
<li><a href="../337976/index.html">RTP Bleed: Dangerous vulnerability to intercept VoIP traffic</a></li>
<li><a href="../337978/index.html">Telegram bot for Mikrotik with Webhook and JSON parser</a></li>
<li><a href="../337982/index.html">Methods for developing motion software flow sensors that work with Arduino</a></li>
<li><a href="../337984/index.html">About smart contracts in simple words</a></li>
<li><a href="../337986/index.html">Prototyping in the Python-Arduino environment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>