<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a smart home and developing your own protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I must say that the post is focused more on ordinary people than on those in the subject, and is rather a report of what I have been doing in recent d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a smart home and developing your own protocol</h1><div class="post__text post__text-html js-mediator-article"> I must say that the post is focused more on ordinary people than on those in the subject, and is rather a report of what I have been doing in recent days. <br><br>  I decided here to score on all the work and do something for the soul.  Again took up the soldering iron.  I decided to automate everything at home.  In the old apartment I had a smart house or something like that - could turn on the lights in the room via the Internet and all that. <br><br>  This time I decided to take into account my mistakes.  The main problem was that before I had one device responsible for everything, to which temperature, movement, display, buttons, and other sensors were connected.  All this was great, but in the end, the device performed only the functionality that was originally incorporated into it.  It was impossible so easy to take and connect some kind of sensor without modifying this device. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was decided that it is better to do a lot of separate devices, each of which is responsible for a strictly specific task, having the ability to easily connect them to a common network.  And so that each device has an address and its own set of commands.  Something like CAN-bus in modern cars.  At the same time, I want the network to be decentralized, without a master device, so that everything can be connected over a single wire, easily realized without buying an additional controller, and so that the long wires were not a problem. <br><br>  On board the microcontroller there are all sorts of I¬≤C, yes UART, but they clearly do not satisfy the conditions.  As a result, it was decided to develop your <strike>bike</strike> protocol. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9c9/50b/5df/9c950b5df7d9a6f410c2ea22fc6bd200.jpg"></a> <br><br><a name="habracut"></a><br>  There are dominant and recessive signals, as in CAN.  In the case of wires (who knows, maybe I will also use radio or infrared light) the dominant one is pressing the data line to the ground.  In the normal state, the data line has a pull up to + 5V.  Thus, when the device sees that the line is already pressed to the ground, it understands that some other device is already sending data, and is waiting for the line to be released.  The data itself is encoded by the length of the dominant signals.  1T is zero, 3T is one, the pause between them is 1T.  Each transmission begins with initialization as a long signal at 10T.  After numerous experiments on a microcontroller centipede ... <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3eb/123/ba0/3eb123ba0f6260d833811621afa0c6cc.jpg"></a> <br><br>  ... I decided that the optimal value of T = 0.000064 seconds.  At the same time there are no losses (almost?).  I do not think that a large amount of data will be transmitted over this network.  Print messages from Twitter to display in the toilet if only. <br><br>  The data packets themselves have the following structure: 2 bits of packet priority (in case the devices send them simultaneously, which is very unlikely), 8 bits - the sender's address, 8 bits - the recipient's address (0xFF - broadcast), 8 bits - the command number , 8 bits - the length of the data field in bytes, the corresponding number of data bytes and 8 bits - the checksum, where without it. <br><br>  The result was a library that implements work with this protocol entirely at the interrupt level.  Those.  It turns out such a multitasking from the point of view of the rest of the program.  It is enough to perform initialization once, and the microcontroller will respond to pings, even if the main program has entered an infinite loop.  It does not hang, even if the line is busy when sending a packet, the library sends it as soon as the line is released.  And when a package is received at its address, the specified function is called. <br><br>  Thus, to connect a new device to the network, it is enough for me to simply configure the library, specifying the microcontroller‚Äôs feet, address and name. <br><br>  We must pay tribute to one small box.  I don‚Äôt have a normal oscilloscope, but a few years ago I ordered the cheapest oscilloscope on USB for a computer on ibei.  Total at 1MHz.  When I received it and tried it, I decided that it was useless Chinese consumer goods, and in vain I threw out the money, and put it in the back box.  And now I decided to get it ... If it were not for him, I probably would still debug all this.  And on it everything is immediately visible and understandable. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f22/d81/c49/f22d81c49c4e0700095be24a25d93eb5.jpg"></a> <br><br>  It turned out to sit down from three wires - earth, power and data.  Yes, I didn‚Äôt want to mess around with the power supply of each device, so I decided to bring 9-12 volts of direct current everywhere, and on each device I would have to install a banal SUMMER. <br><br>  However, this entire network still needs to be somehow connected to a computer and the Internet.  To do this, I first made a device to the COM port: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ba2/7a8/68c/ba27a868c487065e7ddd00a96833271a.jpg"></a> <br><br>  This thing worked frankly bad.  And why I did not decide to do right on USB?  I do not know.  Later, the FT232 microcircuit was purchased.  Essentially in a QFN package. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/205/b43/acc/205b43acc6d9a3b7ff7c500740936739.jpg"></a> <br><br>  For the first time soldered QFN case.  It did not work out right away, the board was already blackened from overheating.  But it worked!  I stuck this thing into the router, because it works around the clock, and I need to communicate not just with the computer, but also with the Internet. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f39/fd6/71f/f39fd671fccc0ddd54c48e14e43ba620.jpg"></a> <br><br>  In a router as usual Linux.  After small dances with a tambourine, it turned out to suck my device to him.  Then I had to remember programming skills under the Nix.  The task was not so difficult - to share a virtual COM port on the network with the ability to connect to it simultaneously several clients.  Then I made it so that when I receive each packet, a simple script is executed.  Thus, you can easily force the router to respond to various events by simply changing the shell script, without restarting the daemon.  Then I did more work with the fifo pseudo-file, which gave me the opportunity to send packets to the network directly from the command line.  For example, the command: <i>echo "04010803"&gt; fifo</i> sends a packet with priority 04 to device 01 with command 08 (relay control) and data 03 (turn on the 1st and 2nd lamps).  Of course, I don‚Äôt need to type all this manually, but it makes it much easier to write scripts that automate everything.  Under Windows, a library was written that connects to the daemon on the server and receives / sends packets.  There is no full-fledged software yet, but I can already turn on the lights in the room, TV and receiver with hot keys on the keyboard, which makes life much easier. <br><br>  But then I decided to write my own bootloader.  I can‚Äôt imagine how I could do without him.  It allows you to update devices firmware right on my network!  This is a small program that sits at the end of the microcontroller's memory and runs before the main program.  Her whole task is to submit signs of life, and then either launch the main program after a few seconds, or download and update the firmware if such a command arrives.  With great difficulty, I put all this code in one kilobyte.  The score went literally bytes.  Only the very basis is implemented - no checks on the freeness of the line, expectations and other features.  Only data transfer and checksum verification, but for the loader this is quite enough.  How great it is to save every byte of memory, work directly with registers, optimize the code to the full ... Low-level programming just brings a lot of fun =) <br><br>  For the company, I wrote the corresponding command line utility, which sends the device a reboot command, a command to switch to the firmware mode and the firmware itself.  Just write it in the project's Makefile, and ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e19/797/6b4/e197976b498edc8e6bf4cfd1a1b9257f.png"><br><br>  By pressing one key in Programmer's Notepad, I can update the firmware to any working device in my apartment.  Without disconnecting, without a soldering iron, without leaving your computer.  And the whole process takes 10-20 seconds.  It's just mega-easy.  The configuration of some devices is much easier to change, changing the firmware itself, than to provide everything in advance.  For example, add to the wall switch response to broadcast packets sent by the remote control receiver, which now allows you to turn on the chandelier from the remote from the DVD player.  I remind you that the presence of a wizard is not required for this, the devices communicate with each other directly :) At the same time, you cannot kill the device with unsuccessful firmware - the bootloader always starts earlier.  Now it is enough to flash each device with a simple template, making minimal changes (legs and device ID), after which you can safely put it in its place, and then start writing firmware for it :) <br><br>  Now I already have six devices in my network, and so far everything is working perfectly :) There were problems only with noise in the power supply, but again my oscilloscope saved me.  It will be necessary to buy a full. <br><br>  <b>upd:</b> <b><br></b>  <b>GitHub project: <a href="https://github.com/ClusterM/clunet">github.com/ClusterM/clunet</a></b> </div><p>Source: <a href="https://habr.com/ru/post/160469/">https://habr.com/ru/post/160469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160457/index.html">SMS alert plugin for critical tasks for Redmine</a></li>
<li><a href="../160459/index.html">NetWrix Change Reporter Suite licenses for Microsoft Certified Professionals</a></li>
<li><a href="../160461/index.html">Sixth Kiev Habravstrecha</a></li>
<li><a href="../160463/index.html">Industrial Internet can add 15 trillion dollars to global GDP</a></li>
<li><a href="../160465/index.html">Web audio offline in Safari for iOS 6</a></li>
<li><a href="../160473/index.html">Examples of using trigonometric functions for animation</a></li>
<li><a href="../160477/index.html">"Offline first" approach to creating web applications</a></li>
<li><a href="../160479/index.html">Catalog of companies - exporters of IT solutions in St. Petersburg</a></li>
<li><a href="../16048/index.html">Veche 2.0</a></li>
<li><a href="../160481/index.html">Gmail increases attachment size up to 10 GB (with links to GDrive)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>