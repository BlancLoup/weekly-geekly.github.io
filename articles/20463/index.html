<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Indexing rights in multi-user services.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This text is about how to speed up the sampling of private data in multi-user projects. 
 Some things considered at the beginning may already be well ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Indexing rights in multi-user services.</h1><div class="post__text post__text-html js-mediator-article">  This text is about how to speed up the sampling of private data in multi-user projects. <br>  Some things considered at the beginning may already be well known to you, but given that questions about the differentiation of access rights are asked regularly, I found it necessary to examine them in more detail. <br>  For a guru, there can be valuable, if not justification, what this method is not good for.  If this is understandable to you, go directly to the ‚Äúbinary masks‚Äù item, there it contains the most basic. <br>  Many services allow the user to place various data on the network, while the person placing himself, as a rule, needs to limit the circle of people who can view, comment on his records or images.  For these purposes, developers create different systems of rights control. <br><a name="habracut"></a><br>  It should be noted that in most services the elements are displayed in the form of a list, and the elements whose reading is not allowed in the list should not be shown.  Unlike, for example, the file system, where you can show a file in the list, and check the rights already at the opening stage, a hidden blog entry or ‚Äúpreview‚Äù of the photo should not be shown at all, since it already carries some information. <br><h2>  Separation of rights based on access level. </h2><br>  An example of such a separation is the system of secrecy in public institutions, that is, each subject has a certain level of access, and each object has a certain level of secrecy; to read an object, an access level not lower than the level of secrecy is required. <br>  For Internet sites, as a rule, the division into levels is carried out: ‚Äúacquaintances‚Äù, ‚Äúfriends‚Äù, ‚Äúrelatives‚Äù.  In addition, according to the same principle (only for actions), the mechanism of "karma" works on the site <a href="http://habrahabr.ru/">habrahabr.ru</a> <br>  Thus, the selection is carried out on two tables: <br><table border="1" cellpadding="2"><tbody><tr><td colspan="3">  records </td></tr><tr><td width="67">  id </td><td width="60">  int </td><td width="192">  Record ID </td></tr><tr><td width="67">  us_id </td><td width="60">  int </td><td width="192">  Owner </td></tr><tr><td width="67">  level </td><td width="60">  int </td><td width="192">  Level of secrecy </td></tr></tbody></table><br><table border="1" cellpadding="2"><tbody><tr><td width="319" colspan="3">  user_levels - access levels </td></tr><tr><td width="67">  us_id </td><td width="60">  int </td><td width="192">  User </td></tr><tr><td width="67">  cor_id </td><td width="60">  int </td><td width="192">  Linked User </td></tr><tr><td width="67">  level </td><td width="60">  int </td><td width="192">  Access level </td></tr></tbody></table><br>  Thus, you can select allowed entries as follows: <br> <code>SELECT `records`.`id` <br> FROM `records`, `level` <br> WHERE `records`.`us_id`=`user_levels`.`us_id` <br> AND `records`.`level`&lt;=`users`.`level` <br> AND `user_levels`.`cor_id`=$us_id;</code> <br>  The presented method has one major drawback; we are limited only by comparing the access level, i.e.  in this case, the record available to friends will be available to parents, which, you see, is not always convenient. <br><h2>  ACL </h2><br>  ACL is an access list system in which roles (groups) can be allowed or denied some action on an arbitrary object.  In this case, one object can inherit from another access rights. <br>  Also belonging to the role can be calculated on the fly in relation to the object. <br>  This is called ‚Äúvirtual groups‚Äù; for example, a virtual group can be ‚Äúowner‚Äù, which is calculated as user_id = object.owner_id.  Disk quotas can also be implemented as a virtual group: users who have less than N megabytes loaded. <br>  ACL is an incredibly flexible and convenient tool for working with rights. You can read more about ACL in the book "Protected Code", which describes in detail the mechanism of access lists in Windows OS, if you have anything to do with Microsoft or if you want to immediately use this mechanism on your site, then you should refer to the documentation of the zend_acl library. <br>  Despite all the advantages, the ACL has significant drawbacks: <br><ol><li>  The documentation for zend_acl contains a fragment about storing lists in which it is written: a programmer can store an access table, where he pleases, for example, by serializing. <br>  In this lies the main hitch, the structure of the access tables is rather nontrivial and it is rather difficult to normalize it for storage, i.e.  as a rule, they are stored in a serialized form. <br>  It turns out that in order to find out whether a user can read a record, you must first receive this record, then initiate its ACL and only then check access. <br>  Those.  to get a list, or (oeeee) the number of elements, we need to select more records than you need to display, and even from the uncertain boundary conditions. <br>  It is practically impossible to do this at the sampling stage, right in the request. <br>  Yes, many databases allow you to work with serialized structures, and even index them, but the costs of this are still too high. </li><li>  The flexibility of an ACL is compensated for by the complexity of the setup; practice shows that even developers can make an ACL for their needs with great difficulty, what can we say about end users. <br>  Therefore, I believe that the ACL mechanism is redundant for most needs, so they should be where it is really needed, and for simple cases (just a reading restriction), use simpler tools. </li></ol><br><h2>  User groups. </h2><br>  So, as a rule, a user has several groups, suppose ‚Äúfriends‚Äù, ‚Äúcolleagues‚Äù and ‚Äúrelatives‚Äù, with which he wants to allow certain records to be read. <br>  Wherein: <br><ul><li>  the same user may belong to several groups at the same time (be ‚Äúfriend‚Äù and ‚Äúcolleague‚Äù, although this is contraindicated) </li><li>  A record can be opened for one or several groups (for example, friends and relatives should know about your desire to change jobs, but it‚Äôs not necessary for colleagues to know about this). </li></ul><br>  Thus, we have the following structure: <br><table border="1" cellpadding="2"><tbody><tr><td colspan="3">  records </td></tr><tr><td width="79">  id </td><td width="48">  int </td><td width="192">  Record ID </td></tr><tr><td width="79">  us_id </td><td width="48">  int </td><td width="192">  Owner </td></tr></tbody></table><br><br><table border="1" cellpadding="2"><tbody><tr><td colspan="3">  record_permissions - who can read </td></tr><tr><td width="76">  record_id </td><td width="60">  int </td><td width="192">  Record ID </td></tr><tr><td width="76">  group </td><td width="60">  int </td><td width="192">  Group id </td></tr></tbody></table><br><table border="1" cellpadding="2"><tbody><tr><td width="319" colspan="3">  group_members are members of groups </td></tr><tr><td width="79">  us_id </td><td width="48">  int </td><td width="192">  User </td></tr><tr><td width="79">  group </td><td width="48">  int </td><td width="192">  Group id </td></tr></tbody></table><br>  Thus, the selection of records occurs using the following query: <br> <code>SELECT DISTINCT `records`.`id` , `records`.`name` <br> FROM `records` , `record_permissions` , `group_members` <br> WHERE `records`.`public` =0 <br> <br> AND `records`.`id` = `record_permissions`.`record_id` <br> AND `record_permissions`.`group_id` = `group_members`.`group_id` <br> AND `group_members`.`us_id` =$us_id</code> <br>  In principle, the whole picture of rights can be kept in this form, but it is not worth doing. <br><ul><li>  It is better to keep the rights to actions in the ACL, in practice you will never use this data. </li><li>  The rights to change, creation, deletion change much less frequently, and if you are such a fan of database normalization, store them at least in a separate table so as not to clutter the one you are working with (or view if the DBMS is able) </li></ul><br>  Despite the simplicity and elegance of the solution, it has significant drawbacks, which will be discussed below, in the same place I will try to show solutions. <br><h2>  Public records. </h2><br>  A diligent reader has already noticed a hole in our reasoning: only the user who is explicitly allowed to read the record can read it. <br>  By default, in most cases, the records are open, and anyone can read them. <br>  You can solve this with the help of a tricky query with LEFT JOIN, but in the end we have a condition on the table being joined, that there is a universal evil. <br>  You can make a virtual group "Everyone", which includes any user and who is allowed to read public records.  But this is not very good in relation to resources and it is generally ugly to create meaningless recordings for everyone. <br>  Therefore, we introduce a new property in records: public, this will allow us: <br><ul><li>  Pull out without write extras to the system of privileges records for blocks like: ‚Äúthe last on the site‚Äù </li><li>  Display entries for unregistered users also without using rights verification. </li><li>  Add open records by a simple UNION in the query (UNION works extremely fast, it is even recommended to use it instead of OR and IN, for a particularly confusing case) </li></ul><br><h2>  Binary masks. </h2><br>  Even in the last query, the bad word DISTINCT is used, and the sample is based on three tables, and even with one-to-many relationships, this is a matter of concern. <br>  In order to get something, you need to sacrifice something, we introduce some boundary conditions: <br><ul><li>  The user can open records only for their groups. <br>  Very few people may need to open their notes to ‚ÄúVasya's friends,‚Äù and in this case it will be difficult to do at the interface level. </li><li>  A user may have a limited number of groups. <br>  A person can memorize 5 ¬± 2 objects, in a large number of groups it is easier to get confused than to understand anything. </li></ul><br>  Based on this, we reduce the number of tables to two: <br><table border="1" cellpadding="2"><tbody><tr><td width="319" colspan="3">  records </td></tr><tr><td width="79">  id </td><td width="48">  int </td><td width="192">  Record </td></tr><tr><td width="79">  us_id </td><td width="48">  int </td><td width="192">  User </td></tr><tr><td width="79">  access </td><td width="48">  int </td><td width="192">  Access mask </td></tr><tr><td width="79">  public </td><td width="48">  bool </td><td width="192">  Public record flag </td></tr></tbody></table><br><table border="1" cellpadding="2"><tbody><tr><td width="319" colspan="3">  user_references- user relationships </td></tr><tr><td width="79">  us_id </td><td width="48">  int </td><td width="192">  User </td></tr><tr><td width="79">  cor_id </td><td width="48">  int </td><td width="192">  Linked User </td></tr><tr><td width="79">  mask </td><td width="48">  int </td><td width="192">  Relationship mask </td></tr></tbody></table><br>  access and mask are binary masks that define access for the owner of the record and belong to the user‚Äôs groups. <br>  Those.  each bit of the mask corresponds to a group, int we have 32 bits, so the number of groups is limited to 32 (several bits can be reserved). <br><h3>  Example. </h3><br>  <strong>User Relations</strong> <strong>:</strong> <br><table border="1" cellpadding="2"><tbody><tr><td width="67">  Friends </td><td width="72">  Family </td><td width="72">  Colleagues </td><td width="120">  User </td><td width="72">  Total </td></tr><tr><td width="67">  one </td><td width="72">  0 </td><td width="72">  0 </td><td width="120">  Friend </td><td width="72">  one </td></tr><tr><td width="67">  0 </td><td width="72">  one </td><td width="72">  0 </td><td width="120">  Mama </td><td width="72">  2 </td></tr><tr><td width="67">  0 </td><td width="72">  0 </td><td width="72">  one </td><td width="120">  Colleague </td><td width="72">  four </td></tr><tr><td width="67">  one </td><td width="72">  0 </td><td width="72">  one </td><td width="120">  Friend-colleague </td><td width="72">  five </td></tr></tbody></table><br>  <strong>Access to records</strong> <strong>:</strong> <br><table border="1" cellpadding="2"><tbody><tr><td width="67">  Friends </td><td width="72">  Family </td><td width="72">  Colleagues </td><td width="132">  Record </td><td width="60">  Total </td></tr><tr><td width="67">  0 </td><td width="72">  0 </td><td width="72">  0 </td><td width="132">  Only me </td><td width="60">  0 </td></tr><tr><td width="67">  0 </td><td width="72">  one </td><td width="72">  0 </td><td width="132">  Hello Mom! </td><td width="60">  2 </td></tr><tr><td width="67">  0 </td><td width="72">  0 </td><td width="72">  one </td><td width="132">  Working </td><td width="60">  four </td></tr><tr><td width="67">  one </td><td width="72">  one </td><td width="72">  0 </td><td width="132">  I want to quit! </td><td width="60">  3 </td></tr></tbody></table><br>  Thus, it is possible to find out if the user has the right to read the record by performing the bitwise "&amp;" above the masks.  Bitwise operations are fast because everything is based on them. <br>  Thus, the query looks like this: <br> <code>SELECT `records`.`id` , `records`.`name` <br> FROM `records` , `user_references` <br> WHERE `records`.`public` =0 <br> AND `records`.`us_id` = `user_references`.`us_id` <br> <br> AND `records`.`access` &amp; `user_references`.`mask` <br> AND `user_references`.`cor_id` =$us_id</code> <br>  Or taking into account the public field: <br> <code>SELECT `records`.`id` , `records`.`name` <br> FROM `records` , `user_references` <br> WHERE `records`.`public` =0 <br> AND `records`.`us_id` = `user_references`.`us_id` <br> <br> AND `records`.`access` &amp; `user_references`.`mask` <br> AND `user_references`.`cor_id` =$us_id <br> UNION <br> SELECT `records`.`id` , `records`.`name` <br> FROM `records` <br> <br> WHERE `public` =1</code> <br> <h2>  Testing. </h2><br>  During testing, the performance of the solution was compared with user groups and solutions with bit masks. <br>  As we see, the gain is very substantial, which justifies the limitations imposed by the latter method. <br>  Separately, I will say that on a real project, an ACL (proprietary) is used, which eats up a fair amount of resources and creates significant difficulties for developers. <br><table cellpadding="2" border="1"><tbody><tr><td width="448">  Conditions </td><td width="123">  By mask (s) </td><td width="127">  By groups (sec) </td><td width="122">  Speed ‚Äã‚Äãat times </td></tr><tr><td>  MySql 4, 30,000 records, 100 users, 1000 connections, UNION </td><td align="right">  0,00215 </td><td align="right">  0,0107 </td><td align="right">  4.98 </td></tr><tr><td>  MySql 4,500,000 records, 10,000 users, 100,000 links </td><td align="right">  0,00185 </td><td align="right">  0.1346 </td><td align="right">  72.76 </td></tr><tr><td>  MySql 4,500,000 records, 10,000 users, 100,000 UNION connections </td><td align="right">  0,00215 </td><td align="right">  0.1383 </td><td align="right">  64.33 </td></tr><tr><td>  MySql 5,500,000 records, 10,000 users, 100,000 links </td><td align="right">  0,00135 </td><td align="right">  0.169 </td><td align="right">  125.19 </td></tr></tbody></table><br>  Sampling time averaged over 4 users created manually.  All other users were created automatically; each such user had 10 friends and 10 ‚Äúfor friends‚Äù entries. <br>  As can be seen from the results, the sampling rate differs by 2 orders of magnitude, while the solution with the tables is expandable, the sampling rate depends little on the number of records <br>  It should be noted that if the user is in two groups (‚Äúfriends‚Äù and ‚Äúcolleagues‚Äù), then this does not affect the sampling rate by mask.  And sampling by groups (DISTINCT is involved) takes a few seconds (horror of horror), I did not even use it in the pivot table. <br><h2>  Results </h2><br>  It turns out that to improve the performance of the system of rights, you can create additional easily indexable tools. <br>  I do not call in any way to abandon the ACL or other complex rights demarcation systems, but in some cases use optimized solutions for a specific task. <br>  If you know more effective ways of differentiation of access rights, or are aware of aspects unknown to me, you are welcome in the comments. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/20463/">https://habr.com/ru/post/20463/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204618/index.html">Where in the Silicon Valley SVODat investors and startups?</a></li>
<li><a href="../20462/index.html">Y Combinator: Would he finance your idea?</a></li>
<li><a href="../204620/index.html">Stock Market Technologies: Direct Access to the Exchange</a></li>
<li><a href="../204624/index.html">CyanogenMod 10.2 released</a></li>
<li><a href="../204628/index.html">250 lines of code recognizing the date in Russian</a></li>
<li><a href="../204630/index.html">Webinar "User Experience in an Agile Process - When the Real World Comes Knocking" from Danish interface designer Trifork A / S Janne Yul Jansen</a></li>
<li><a href="../204632/index.html">Go 1.2 release</a></li>
<li><a href="../204636/index.html">How ESET handles state-sponsored malware</a></li>
<li><a href="../204638/index.html">Work with OpenCV. Part 1. Installation and Hello World</a></li>
<li><a href="../20464/index.html">Tournaments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>