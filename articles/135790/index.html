<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Radio-controlled Wi-Fi machine with a camera</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Start 
 In the summer, there was an idea to make a radio-controlled machine, but not just something similar to the creation of Chinese engineering, wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Radio-controlled Wi-Fi machine with a camera</h1><div class="post__text post__text-html js-mediator-article"><h4>  Start </h4><br>  In the summer, there was an idea to make a radio-controlled machine, but not just something similar to the creation of Chinese engineering, which is sold at every turn, but a machine that could be controlled from a computer or phone.  It is understood that the machine, which can be controlled via Wi-Fi in its pure form, is not at all interesting.  But what if she had a camera?  And if you still control via 3G / EDGE / GPRS?  This is another matter! <a name="habracut"></a>  This means that the control device should have USB and Wi-Fi (or just USB, you can buy a USB Wi-Fi adapter).  Now you need to figure out how to control the engines.  Initially, I wanted to do this with the help of the COM port and the shift register (74HC595), but having burned 5 such chips, I refused this method.  Later, my eyes fell on the Arduino, namely on the Arduino Duemilanove.  This board has 14 digital I / O ports, six of them are <abbr title="Pulse width modulation">PWM</abbr> (it will be possible to control the voltage on the motor and hang up the servos for the camera), two can be used as the Tx and Rx serial ports. <br><h4>  Router </h4><br>  Having found the D-Link DIR-320 router in my city, which has a USB port, I immediately bought it.  When I got home, I learned that this router has an unmarked UART port.  Thus, we have a communication channel between the router and arduina. <br>  For the router, I chose the OpenWrt firmware.  You can download the finished firmware from <a href="http://openwrt.org/">OpenWrt</a> for DIR-320 is <a href="">here</a> .  I do not remember why already, but I decided to assemble the firmware myself (described in detail <a href="http://dipcore.com/%3Fp%3D117">here</a> ).  This will require Linux (I built on Ubuntu 11.10).  First, download the firmware sources and collect everything you need: <br><pre><code class="bash hljs">svn co svn://svn.openwrt.org/openwrt/branches/backfire dir320 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> dir320 ./scripts/feeds update -a &amp;&amp; ./scripts/feeds install ‚Äìa make prereq &amp;&amp; make tools/install &amp;&amp; make toolchain/install</code> </pre> <br>  Configuring the firmware <br><pre> <code class="bash hljs">make menuconfig</code> </pre> <br>  Choose the following packages: <br><ul><li>  Target System ---&gt; &lt;*&gt; Broadcom BCM947xx / 953xx - 2.6 kernel </li><li>  Image configuration ---&gt; &lt;*&gt; LAN IP Address ---&gt; &lt;IP address&gt; - [optional] You can select the IP address that the router will have after booting the kernel and all modules </li><li>  Kernel modules ---&gt; &lt;*&gt; Filesystems ---&gt; &lt;*&gt; kmod-fs-ext3 - more on this later </li><li>  Utilities ---&gt; Filesystem ---&gt; &lt;*&gt; e2fsprogs - And about that </li><li>  Utilities ---&gt; disc ---&gt; &lt;*&gt; block-extroot - And that too </li><li>  Kernel modules ---&gt; &lt;*&gt; USB Support ---&gt; &lt;*&gt; kmod-usb-core - USB support </li><li>  Kernel modules ---&gt; &lt;*&gt; USB Support ---&gt; &lt;*&gt; kmod-usb-ohci - for USB hub.  Why is he?  More about this later </li><li>  Kernel modules ---&gt; &lt;*&gt; USB Support ---&gt; &lt;*&gt; kmod-usb-storage - USB flash drive support </li><li>  Kernel modules ---&gt; &lt;*&gt; USB Support ---&gt; &lt;*&gt; kmod-usb2 - USB 2.0 </li><li>  Administration -&gt; webif ---&gt; &lt;*&gt; webif-applications - admin panel </li><li>  Kernel modules ---&gt; &lt;*&gt; Video Support ---&gt; &lt;*&gt; kmod-usb-video-core - USB-video support </li><li>  Kernel modules ---&gt; &lt;*&gt; Video Support ---&gt; &lt;*&gt; kmod-usb-video-uvc - support for UVC-webcams </li></ul><br>  Choose the last item, I had a UVC webcam. <br>  So why did we choose those packages, the purpose of which I did not explain?  The problem is that the amount of flash memory installed in the router is 4MB, which can interfere with our further work.  We will transfer rootfs to a USB flash drive, and the router will boot from it. <br>  By the way, about flash memory: you need not forget the following: <br> <code>make kernel_menuconfig</code> <br> <ul><li>  Device Drivers ---&gt; &lt;*&gt; Memory Technology Device (MTD) support ---&gt; RAM / ROM / Flash chip drivers ---&gt; [*] Flash chip driver advanced configuration options -&gt; [*] Specific CFI Flash geometry selection -&gt; [*] Support 8-bit buswidth </li><li>  Device Drivers ---&gt; &lt;*&gt; Memory Technology Device (MTD) support ---&gt; RAM / ROM / Flash chip drivers ---&gt; [*] Flash chip driver advanced configuration options -&gt; [*] Specific CFI Flash geometry selection -&gt; [*] Support 16-bit buswidth </li></ul><br>  And in Kernel Hacking, you need to fix <code>console=/dev/ttyS0</code> on <code>console=/dev/null</code> so that the router does not use this port as a debugging one. <br><h5>  Compile and flash </h5><br>  Compile the firmware: <br><pre> <code class="bash hljs">make V=99 -j2</code> </pre> <br>  Now you need to flash it: <br>  <b>For bash:</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo "==================================================================" echo "This script will upload dd-wrt firmware (firmware.bin)" echo "in the current directory to 192.168.0.1 " echo "during the router's bootup. " echo "" echo "* Set your ethernet card's settings to: " echo " IP: 192.168.0.10 " echo " Mask: 255.255.255.0 " echo " Gateway: 192.168.0.1 " echo "* Unplug the router's power cable. " echo "" echo "Press Ctrl+C to abort or any other key to continue... " read echo "" echo "* Re-plug the router's power cable. " echo "" echo "==================================================================" echo "Waiting for the router... Press Ctrl+C to abort. " echo "" try(){ ping -c 1 -w 1 192.168.0.1 } try while [ "$?" != "0" ] ; do try done echo "*** Start Flashing **** " atftp --no-source-port-checking -p -l firmware.bin 192.168.0.1 echo "Firmware successfully loaded!"</span></span></code> </pre> <br>  <b>For Windows:</b> <br><pre> <code class="hljs dos">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ================================================================== <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> This batch file will upload dd-wrt firmware <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the current directory to <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> during the router's bootup. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> your ethernet card's settings to: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> IP: <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Mask: <span class="hljs-number"><span class="hljs-number">255</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Gateway: <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * Unplug the router's power cable. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Press Ctrl+C to abort or any other key to continue... <span class="hljs-built_in"><span class="hljs-built_in">pause</span></span> &gt; <span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * Re-plug the router's power cable. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ================================================================== <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the router... Press Ctrl+C to abort. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FIND</span></span>=<span class="hljs-variable"><span class="hljs-variable">%WINDIR%</span></span>\command\<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>.exe <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exist</span></span> <span class="hljs-variable"><span class="hljs-variable">%FIND%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> LPING <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FIND</span></span>=<span class="hljs-variable"><span class="hljs-variable">%WINDIR%</span></span>\system32\<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>.exe <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exist</span></span> <span class="hljs-variable"><span class="hljs-variable">%FIND%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> LPING <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FIND</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> :LPING <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> -n <span class="hljs-number"><span class="hljs-number">1</span></span> -w <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-variable"><span class="hljs-variable">%FIND%</span></span> "TTL=" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">errorlevel</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> LPING <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *** <span class="hljs-built_in"><span class="hljs-built_in">Start</span></span> Flashing **** tftp -i <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> put firmware.bin <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">errorlevel</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> LPING <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FIND</span></span>= <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ================================================================== <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * WAIT <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> about <span class="hljs-number"><span class="hljs-number">2</span></span> minutes while the firmware is being flashed. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * Reset your ethernet card's settings back to DHCP. <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * The default router address will be <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">Pause</span></span></code> </pre> <br><h5>  Configuring boot from flash drive </h5><br>  After the first power up, go to the web interface of the router and change the password.  Now connect to it via SSH.  You need to configure the boot from the flash drive, for this you first need to mark it.  I had two sections: the first is an ext3 partition for rootfs, the second is a swap.  Open / etc / config / fstab in vim and write what corresponds to our felshka.  I have so: <br><pre> <code class="hljs pgsql"> config <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> automount <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> from_fstab <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> anon_mount <span class="hljs-number"><span class="hljs-number">1</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> autoswap <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> from_fstab <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> anon_swap <span class="hljs-number"><span class="hljs-number">0</span></span> config mount <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> target / <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> device /dev/sda1 <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> fstype ext3 <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> rw,sync <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> enabled <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> enabled_fsck <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> is_rootfs <span class="hljs-number"><span class="hljs-number">1</span></span> config swap <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> device /dev/sda2 <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> enabled <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Save, reboot. <br><h5>  Demon </h5><br>  Arduin will control the engines, so we will write a daemon that will redirect everything that came to TCP port 5554 on / dev / ttyS0. <br>  Search for my compiled version of the daemon in the archive (card) <br>  Compile with gcc, which was compiled in preparation for the firmware build: <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">‚Ä¶</span></span></span><span class="hljs-tag">&gt;</span></span>/dir320/staging_dir/toolchain-mipsel_gcc-4.3.3+cs_uClibc-0.9.30.1/usr/bin/mipsel-openwrt-linux-uclibc-gcc-4.3.3 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">   &gt;</span></span> -o <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">  &gt;</span></span></code> </pre> <br><h5>  A small digression about the convenience of organizing work with the router </h5><br><ul><li>  After each power up, I had to write <code>opkg update</code> , so I added it to /etc/rc.local </li><li>  It is quite convenient to use an FTP server.  I put pure-ftpd.  To do this, we write: <br><pre> <code class="hljs sql">opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> pure-ftpd</code> </pre> <br>  Add it to /etc/rc.local: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">pure-ftpd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-4</span></span> ‚Äì<span class="hljs-selector-tag"><span class="hljs-selector-tag">B</span></span> ‚Äì<span class="hljs-selector-tag"><span class="hljs-selector-tag">M</span></span> ‚Äì<span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">unix</span></span> ‚Äì<span class="hljs-selector-tag"><span class="hljs-selector-tag">U</span></span> 000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000</span></span></code> </pre> </li><li>  It will be convenient to change the web interface to luci, for this we write: <br><pre> <code class="hljs cmake">opkg <span class="hljs-keyword"><span class="hljs-keyword">remove</span></span> webif* opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> luci</code> </pre> </li></ul><br><h5>  Demon [continued] </h5><br>  Fill our daemon on the router, add it to autoload. <br>  Now put mjpg-streamer: <br><pre> <code class="hljs sql">opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mjpg-streamer</code> </pre> <br>  We write the following to / etc / config / mjpg-stramer: <br><pre> <code class="hljs pgsql">config mjpg-streamer <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> device ‚Äú/dev/video0‚Äù <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> resolution ‚Äú<span class="hljs-number"><span class="hljs-number">640</span></span>x480‚Äù <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> fps ‚Äú<span class="hljs-number"><span class="hljs-number">24</span></span>‚Äù <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> port ‚Äú<span class="hljs-number"><span class="hljs-number">8080</span></span>‚Äù <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> enabled ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>‚Äù</code> </pre> <br>  We try to connect the camera.  If everything is fine, then you can see the image here: <br>  <a href="">http: // &lt;router IP&gt; /? action = stream</a> . <br><h4>  Arduino and compound </h4><br>  To begin with we will be defined with the scheme of connection of engines.  Since I took the case from the already finished typewriter, I was lucky with the engines - they were already there.  The front one was in charge of turns (left, right, straight), and the rear one was in motion (I had to change the button for locking the doors of some VAZ to the engine).  Arduine loads can be controlled using field-effect transistors (95N2LH5, but I used the IRF 630, because I found these fir trees in my city).  Connection is: the earth of the transistor - to the control pin of the arduin, source - to the ground of the arduin and the minus of the supply voltage, drain - to the minus of the load, plus the power supply to the plus of the load.  But in this way we can only go forward and turn only in one direction.  In order to cope with the problem, a relay with two groups of contacts hurries to our aid.  I had one engine (front) powered by 6 volts, and the other 12. This used two 6 volt batteries (one of them is a lead-acid battery from a back-up), given that the minus of the router would later have to be connected to the arduin ground, then get 6 volts for a router it does not work out (check how many volts you apply to the router - I had to buy one more after I gave it 12 volts).  So I had to use another relyushku to supply / non-supply power to the front engine. <br><img src="https://habrastorage.org/storage2/781/aa1/27c/781aa127c23150fa730b173e5b4494e8.png" alt="Scheme"><br>  Scheme painted for a long time.  Now there are all field effect transistors and no resistors. <br>  Now about the code itself.  Everything is pretty simple for me - there are 4 commands that have their own parameter with a size of 1 byte: <br><ul><li>  m - Responsible for voltage, and, therefore, for speed, on the engine a value from 0 to 255 </li><li>  r - Responsible for turns.  ‚Äú1‚Äù - turn, ‚Äú0‚Äù - do not turn </li><li>  n - ‚Äú1‚Äù - go backwards, ‚Äú0‚Äù - go forward </li><li>  e - ‚Äú1‚Äù - turn in the other direction </li></ul><br>  Here is my program code for arduine: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> inByte, val; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); pinMode(<span class="hljs-number"><span class="hljs-number">2</span></span>, OUTPUT); pinMode(<span class="hljs-number"><span class="hljs-number">4</span></span>, OUTPUT); pinMode(<span class="hljs-number"><span class="hljs-number">7</span></span>, OUTPUT); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Serial.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { inByte = Serial.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((inByte==<span class="hljs-string"><span class="hljs-string">'n'</span></span>)||(inByte==<span class="hljs-string"><span class="hljs-string">'e'</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial.available()==<span class="hljs-number"><span class="hljs-number">0</span></span>) {} val=Serial.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inByte==<span class="hljs-string"><span class="hljs-string">'n'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val==<span class="hljs-string"><span class="hljs-string">'1'</span></span>){ digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, HIGH); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 2 pin\n\r"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val==<span class="hljs-string"><span class="hljs-string">'0'</span></span>){ digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 2 pin\n\r"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inByte==<span class="hljs-string"><span class="hljs-string">'e'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val==<span class="hljs-string"><span class="hljs-string">'1'</span></span>){ digitalWrite(<span class="hljs-number"><span class="hljs-number">4</span></span>, HIGH); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 4 pin\n\r"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val==<span class="hljs-string"><span class="hljs-string">'0'</span></span>){ digitalWrite(<span class="hljs-number"><span class="hljs-number">4</span></span>, LOW); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 4 pin\n\r"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((inByte==<span class="hljs-string"><span class="hljs-string">'m'</span></span>)||(inByte==<span class="hljs-string"><span class="hljs-string">'r'</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial.available()==<span class="hljs-number"><span class="hljs-number">0</span></span>) {} val=Serial.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inByte==<span class="hljs-string"><span class="hljs-string">'m'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val!=<span class="hljs-string"><span class="hljs-string">'0'</span></span>) analogWrite(<span class="hljs-number"><span class="hljs-number">3</span></span>, val); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> analogWrite(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 3 pin\n\r"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inByte==<span class="hljs-string"><span class="hljs-string">'r'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val==<span class="hljs-string"><span class="hljs-string">'1'</span></span>){ digitalWrite(<span class="hljs-number"><span class="hljs-number">7</span></span>, HIGH); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 7 pin\n\r"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val==<span class="hljs-string"><span class="hljs-string">'0'</span></span>){ digitalWrite(<span class="hljs-number"><span class="hljs-number">7</span></span>, LOW); Serial.print(<span class="hljs-string"><span class="hljs-string">"Writing to 7 pin\n\r"</span></span>); } } } } }</code> </pre> <br>  As you can see, I have the back motor connected to 3 pins, the front one - to 7, the rear relay - to 2 pins, the front one - to 4. Since 3 is a PWM pin, using analogWrite (3, val) ;, where val from 0 to 255, we can control the voltage on the motor. <br>  We disassemble our router.  We see the UART port.  We connect it with arduinoy. <br><img src="https://habrastorage.org/storage2/a66/22b/eda/a6622beda88e2d20a4ee4c08cfe944b1.png" alt="UART on the router"><br>  Now we look, how it all works.  Connect with telnet to our port and check: <br><ul><li>  n1 - clicks the relay </li><li>  m &lt;space&gt; - the wheels begin to rotate slightly </li><li>  n0 - wheels rotate in the other direction </li><li>  m0 - wheels stop spinning </li><li>  r1 - turn the front wheels </li><li>  e1 - wheels turn the other way </li><li>  r0 - wheels get straight </li><li>  e0 - clicks the relay </li></ul><br>  You can use minicom ( <code>opkg install minicom</code> ) to debug work with the com port on the router. <br><h4>  Software part </h4><br>  In the archive, my program for controlling the machine (rotate and power from the archive must be copied to / bin / on the router, card is my demon).  It works only with a joystick.  On the scheduling tab, you can write a bash script (don't forget <code>opkg install bash</code> on the router) to execute it using the cron daemon.  Since this daemon needs to be restarted after changing its settings, my program runs the script at <a href="">http: // &lt;IP address&gt; / cron-restart</a> .  Therefore, you need to create it (/ www / cgi-bin / cron-restart) and do not forget to make it executable.  Code: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash /etc/init.d/cron stop; /etc/init.d/cron start</span></span></code> </pre> <br><h4>  Conclusion </h4><br>  It seems that I have not forgotten anything.  Oh, of course!  Here is my masterpiece: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/3J4ZakDRWz0%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhiGa6lLuXhgkgR3I2nV_OOHw1QCGg" frameborder="0" allowfullscreen=""></iframe><br><br><img src="https://habrastorage.org/storage2/333/35d/9ec/33335d9ecf54ada135d14d9cc77e35f2.jpg" alt="Photo cars"><br><br><img src="https://habrastorage.org/storage2/d78/bb6/e2a/d78bb6e2a0d1a23a1cbc9cf859635c02.jpg" alt="Photo cars">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/244/14f/679/24414f67938ce76568e6be4838bd7d55.jpg" alt="Photo cars"><br><br><img src="https://habrastorage.org/storage2/b56/d36/0e7/b56d360e712ae55a9e49c73c60965b88.jpg" alt="Photo cars"><br><br><img src="https://habrastorage.org/storage2/5ab/9b6/3d1/5ab9b63d1f1193b41676a5a0ce8b4f74.jpg" alt="Photo cars"><br><br>  You can connect Bluetooth to such a device (I have not tried it, but there is a driver), a 3G modem (I managed to get the Internet, but it seems that the provider does not give each client its own external ip address, so you will have to use something like back-connect or vpn), gps receiver (no problems should arise - after all, it should be defined as a serial port). <br><h4>  Notes </h4><br>  If the router suddenly reboots, then it is worth removing all the wires away from it or all of them to shield.  Experimentally, I realized that the router can reboot from interference, so I had to wrap the hub with several layers of insulation and aluminum foil. <br>  And more.  Instead of a router, you can use <a href="http://4pda.ru/2011/11/18/50235/">Raspberry Pi</a> , and instead of transistors and relays - Arduino Motor Shield. <br><br>  <a href="http://www.multiupload.com/CGMQFNODID">Archive, which more than once I mentioned</a> ( <a href="http://depositfiles.com/files/2xbpdxcoc">mirror</a> ). </div><p>Source: <a href="https://habr.com/ru/post/135790/">https://habr.com/ru/post/135790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135782/index.html">New Year's zip quest 2012 - the passage</a></li>
<li><a href="../135783/index.html">Personal multicopter</a></li>
<li><a href="../135784/index.html">PayPal may ask the buyer to destroy the item for a refund</a></li>
<li><a href="../135786/index.html">Parallel loading of JavaScript and CSS without blocking page parsing</a></li>
<li><a href="../135788/index.html">Unkillable USB flash drive :: 2</a></li>
<li><a href="../135793/index.html">Nokia Maps 3D demo (WebGL)</a></li>
<li><a href="../135794/index.html">Classical mechanics: about diffusions "on the fingers"</a></li>
<li><a href="../135795/index.html">Artificial intelligence in CAM-systems for solving problems of automating the creation of control programs</a></li>
<li><a href="../135796/index.html">Social Internet services as tools for creating social media</a></li>
<li><a href="../135797/index.html">Groovy implicit type casting features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>