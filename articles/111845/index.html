<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bluetooth watches and Maemo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely dear% username%, fascinated by gadgets, at least once, but drew attention to such a daily accessory, like a wrist bluetooth watch. It is on the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bluetooth watches and Maemo</h1><div class="post__text post__text-html js-mediator-article">  Surely dear% username%, fascinated by gadgets, at least once, but drew attention to such a daily accessory, like a wrist bluetooth watch.  It is on the bluetooth accessory, not the watch-phone and the like.  Convenient (in my opinion) auxiliary gadget. <br><br>  My adventures with a bluetooth clock began three or four years ago, the theme of such a clock flashed in all sorts of gadget news feeds.  Popular models then were the products SonyEricsson, developed in conjunction with Fossil.  By that time, I already had Fossil Abacus Wirst PDA, and I decided to try the products of this company again: I purchased Fossil Abacus CallerID on Amazon. <br><br>  Fossil Abacus CallerID is a complete analogue of the SonyEricsson MBW-100.  Of the possibilities - time synchronization with the phone, display of the incoming call (the name of the caller on a small screen, vibrating alert), and an ‚Äúenvelope‚Äù informing you of new messages.  Both CallerID and MBW-100 are compatible only with a number of SonyEricsson models. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At that moment, I used the SE P1i as a working phone and almost did not strain on such limited compatibility.  The watch did not publish any bluetooth profiles and I didn‚Äôt really want to dig deeper.  So everything went before the appearance of the Nokia N900.  At some point, I clicked that I was terribly lacking in the integration of watches with Maemo.  Once again, I walked through the search engines in search of information about the protocol used by the clock ... Development has begun! <br><br><a name="habracut"></a><br><br>  There are several models of watches from different manufacturers with several different functions on the market, they can be divided into groups: <br>  - <a href="http://reviews.cnet.com/watches-and-wrist-devices/fossil-caller-id-wristwatch/1707-3512_7-32148583.html">Fossil Abacus CallerID</a> , <a href="http://www.sonyericsson.com/cws/products/accessories/overview/mbw-100%3Flc%3Dru%26cc%3Dru">SonyEricsson MBW-100</a> , <a href="http://www.sonyericsson.com/cws/products/accessories/overview/mbw-150classicedition%3Flc%3Dru%26cc%3Dru">MBW-150</a> and <a href="http://www.sonyericsson.com/cws/products/accessories/overview/mbw-200eveningclassic%3Flc%3Dru%26cc%3Dru">MBW-200</a> (the latter two models from the point of view of User Expirience differ from the first ones only by the presence of multimedia control). <br>  - The line of watches <a href="http://citizen.jp/ivirt/">Citizen i: Virt and i: Virt-M</a> , designed for the domestic market of Japan.  In my opinion, this is the most interesting solution. <br>  - <a href="http://mobile.ixbt.com/device/LG/Prada%2BLink">LG Prada Link</a> , sold exclusively with the LG Prada phone, and therefore quite rare and not representing (for me) much interest. <br>  - Various Chinese watches and bracelets.  Here we can mention LM Technologies LM957, <a href="http://www.dealextreme.com/details.dx/sku.14725">LM-958</a> and LM959, but I did not come across a single live specimen.  What swings bracelets, they differ extremely curve software implementation. <br><br>  Before turning to the story about my project, I want to mention the projects of other developers, which gave me in one form or another information that allowed me to develop: <br>  - Sic!  BT-Watch for Symbian; <br>  - <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D362218">smartWatchM</a> for Windows Mobile; <br>  - cross-platform <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D554551">OpenWatch</a> , the development of which moves in parallel with mine. <br><br><h4>  What advantages does my project have over competing projects? </h4><br><br>  The main difference is the concept.  My first requirement was to support User Expirience, which is implemented by each particular model of watches, no more.  That is, for example, if the watch has the function of displaying the number of the caller, this does not mean that you need to slip the weather forecast instead.  When interacting with the phone, the clock interface is represented by a set of business-level commands, not a presentation level. <br><br>  The second requirement is to cover the maximum number of functions of the clock.  For example, Citizen i: Virt allows displaying incoming calls, disconnecting a call and dropping an incoming call, displaying a list of incoming messages, reading incoming messages directly on the clock, displaying and switching phone profiles, displaying the operator‚Äôs name, phone battery level.  Finally, they can show various notifications (vibrate at the same time), news (sic!) And even release the camera shutter! <br><br>  The third and equally important requirement is a well thought-out and compact implementation of the code.  My project is being developed in C / C ++ only using the stdlib and glib fundamental libraries.  STL, Boost, GlibMM and others like them were thrown out of the project at certain points in time because of their voracity. <br>  Do not forget that the process should work for months on a mobile device with limited resources of memory, processor, and even consider the battery life.  I am ready to pour a fly in the ointment to the OpenWatch project for wastefulness of resources, poorly structured and low concept. <br><br><h4>  How does the clock work? </h4><br><br>  It's funny, but despite the fact that initially it wasn‚Äôt clear to me how it works at all, everything turned out to be quite simple.  Without the invention of the bike. <br>  All developers of such devices adhere to the recommendations of the Bluetooth Group and ETSI - use IFCOMM and AT commands for communication.  The Japanese Mobile Computing Promotion Consortium (MCPC) even published several specifications related to the implementation of BT-hours. <br><br>  Fossil and SonyEricsson require the phone to publish an SPP profile with a specific UUID.  Other manufacturers adhere to the expansion of the HFP profile. <br>  Unfortunately, only the BlueZ bluetooth trunk version allows you to implement external agents for AT commands, therefore the support for the HFP profile is associated with some inconveniences: it is impossible to simultaneously implement support for various bluetooth audio and clocks.  (In my implementation, I have reduced this inconvenience to a minimum: HFP support is enabled by a ‚Äúcheckbox‚Äù, the Audio BlueZ plug-in is turned off only for the duration of the program). <br><br>  The command set used by Fossil and SonyEricsson is well described in the documentation for different phones from the latter.  It is enough to look only at the dump of the exchange of clocks and the telephone in order to decide which teams should be supported.  But it is still not without a ticker.  Younger models without media player control support have a full Unicode character generator, and older ones only have ASCII, so the caller‚Äôs name should be displayed only graphically, drawing text on the phone and passing the raster to the clock.  With a meta-information from a media player in general, a song: you throw an event with meta-information at the clock, and they reply to you with a command with the same text - draw it into a raster. <br><br>  Individual Adventures with Citizen i: Virt.  The Japanese are very closed.  These watches are designed for the domestic market of Japan and operate exclusively on Sharp Softbank and DisneyMobile phones.  Here some of the commands are covered by standard specifications, for some parts you can find the MCPC specifications.  The main is covered only by reverse engineering dumps.  At the current time, there are no commands for me to broadcast news and control the camera, I need to get a phone that supports these functions, and sniff all traffic between devices for further analysis. <br><br><h4>  Integration with Gnome Mobile and Maemo </h4><br><br>  I specifically indicated Gnome Mobile in the title of this section to emphasize the fact that the development of a multitude of mobile platforms based on Linux is based on this project.  This fact makes it easy enough to port the application to other Linux platforms based on the <a href="http://www.gnome.org/mobile/">Gnome Mobile</a> project. <br><br>  My project actively uses the object model to implement functional components: Separately, a sufficiently thin core is implemented that implements the communication layer with which agents interact - components that implement certain functional domains, such as integration with a modem or <a href="http://telepathy.freedesktop.org/wiki/">Telepathy</a> . <br><br>  Direct integration with the modem.  I had to implement it for the following reasons: for good, you need to display the registration status in the network and the name of the operator, the incoming call on the modem appears much earlier than in Telepathy.  In addition, I developed this component much earlier than I mastered the implementation of Telepathy.  The modem's API on the N900 is closed, but everything you need can be learned from open sources based on BlueZ reverse engineering. <br><br>  Integration with messaging service.  In Maemo, all work with short messages and IM services is closely related to the <a href="http://maemo.gitorious.org/maemo-rtcom/pages/Eventlogger">RTCOMM</a> system.  RTCOMM provides persistent log storage, so it was logical to use the RTCOMM API to read incoming messages.  In addition, the rtcomm-event-logger notifies other processes about adding or modifying data using DBUS signals. <br><br>  Integration with <a href="http://telepathy.freedesktop.org/wiki/">Telepathy</a> .  Gnome Mobile and Maemo have one great ability.  This feature also corresponds to the concept of the development of 3GPP telephone services.  This peculiarity lies in the fact that all telephone calls of the CS-domain are equal to VoIP-services and IM-services and their service is realized through Telepathy.  Since the integration with the messaging service and the modem was performed earlier, integration with Telepathy in this case is necessary for servicing VoIP calls.  Unfortunately, the C options for C are rather poorly documented in Telepathy itself, so I had to contact the source code for the Impathy project for help.  The main ‚Äúfootcloth‚Äù of this component is GObject, which implements the Telepathy Observer interface. <br><br>  The multimedia player in Maemo is implemented using the <a href="http://www.grancanariadesktopsummit.org/node/219">MAFW</a> framework, the Media Player application is only a front end for it.  Playlists playback and volume control is implemented through the MAFW. <br><br>  Basic specifications for AT teams include reporting of status and battery charge accessories.  All this can be obtained through libhal.  Profile management is implemented through libprofile.  To synchronize the time between devices, libtime had to be used.  Well, for drawing texts under the watch Fossil and SE - <a href="http://cairographics.org/">Cairo</a> . <br><br>  Now about the most interesting.  Receive notifications from the system, call control.  All notifications in the system (yellow teasers, calendar, alarm clock, etc.) are implemented by the D-BUS interface <a href="http://www.galago-project.org/specs/notification/0.9/index.html">org.freedesktop.Notifications</a> during the notification-daemon process.  When you still need to blink or blink something, hildon-sv-notification-daemon (com.nokia.HildonSVNotificationDaemon) comes in, which the notification-daemon makes the appropriate call.  For incoming calls, the Phone application calls hildon-sv-notification-daemon directly. <br><br>  Accordingly, the facts of calling methods of these interfaces can be found by setting the appropriate message filters using the <a href="http://dbus.freedesktop.org/doc/api/html/group__DBus.html">D-BUS low-level API</a> .  In both cases, it is important to know the handle issued by both demons for the request.  That is, it is necessary to track not only DBUS messages method_call, but also method_return, building a correlation between them.  The matter is further complicated by the fact that in DBUS low-level API for method_return messages it is possible to install only a global filter, so the implemented monitor code must be very fast and ultra-compact, so as not to load the device with the maintenance of this hook.  Additionally, I would like to draw the attention of those who are interested in defect 1719 to D-BUS.  Its presence sets a limit on the possibility of implementing only one call monitor per process. <br><br><h4>  Realized Opportunities </h4><br><br>  Abacus CallerID, SonyEricsson MBW-100: <br>  - incoming cellular and VoIP calls - number and name, <br>  - disable the ring tone, reset the incoming call, <br>  - incoming messages IM and SMS - "envelope". <br>  Sony Ericsson MBW-150, MBW-200: <br>  - incoming cellular and VoIP calls - number and name, <br>  - disable the ring tone, reset the incoming call, <br>  - incoming IM and SMS messages - "envelope", <br>  - control the volume and playback of the media player. <br>  Citizen i: Virt: <br>  - incoming cellular and VoIP calls - number and name, <br>  - disable the ring tone, reset the incoming call, <br>  - log of missed calls, <br>  - incoming IM and SMS messages - "envelope", <br>  - reading unread IM and SMS messages right on the clock, <br>  - phone profile management is basic and quiet, <br>  - display of the current profile, <br>  - display of the operator‚Äôs name and battery level, <br>  - notifications about incoming e-mails, notifications of the alarm clock and calendar, notifications of other applications. <br>  bracelets and stuff: <br>  ... all that they can from the above. <br><br>  In conclusion, I want to give a few videos that I shot during the development process.  I apologize for the quality of the video. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/t_U6FdjVIfs%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgDSvUHXFLnfTDRcUbNgisCWyyf1g" frameborder="0" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/FGy1857r6yg%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgjzI1S8jr8iE0xJkP6jATxeC-YVA" frameborder="0" allowfullscreen=""></iframe><br><br>  Many thanks to all who helped me with the publication on Habr√©! </div><p>Source: <a href="https://habr.com/ru/post/111845/">https://habr.com/ru/post/111845/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111835/index.html">Accelerating the reaction of Windows XP / 7. Careful use of SSD drives</a></li>
<li><a href="../111837/index.html">Using Razor outside of ASP.NET</a></li>
<li><a href="../111839/index.html">Ariel</a></li>
<li><a href="../111841/index.html">Fighting spam by law</a></li>
<li><a href="../111844/index.html">Where should the incoming call arrow be directed to in a spherical interface in a vacuum?</a></li>
<li><a href="../111846/index.html">Work with progress dialogs</a></li>
<li><a href="../111847/index.html">Extending the possibilities of StyleCop</a></li>
<li><a href="../111849/index.html">Prices for roaming in Russia will continue to decrease</a></li>
<li><a href="../111851/index.html">Sony Ericsson Xperia Arc video review</a></li>
<li><a href="../111852/index.html">Another way to use exotic fonts on a webpage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>