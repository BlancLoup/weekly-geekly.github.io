<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of tile games in JavaScript (Robbo)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear residents of Habrohabra! 
 This time I brought you a story about javascript, atari and canvas! The game is called Robbo and is the port of the 19...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of tile games in JavaScript (Robbo)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Dear residents of Habrohabra! </h4><br>  This time I brought you a story about javascript, atari and canvas!  The game is called Robbo and is the port of the 1989 creation of the same name. <br><img src="https://habrastorage.org/getpro/habr/post_images/2d1/c4c/1b6/2d1c4c1b615cc2929d7679b57602e463.png" alt="image"><br><br>  <a href="http://dizaina.net/z/robbo/">The toy itself</a> .  <a href="http://dizaina.net/z/robbo/%3Fnosound">Toy with the sound off</a> .  <a href="http://dizaina.net/z/robbo/%3Fnosound%3Fascii">Version for the game at work</a> .  <a href="https://github.com/Zibx/robbo">Link to github</a> . <br>  Management is carried out by arrows.  If there are cartridges, then shift + arrow shoots in the right direction. <br><a name="habracut"></a><br><br><h4>  Story </h4><br>  Who is not interested in the background - scroll right through the next few paragraphs to the section "Technical Implementation". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a child I had an Atari 130 XE computer.  Parents bought it when I was 2 years old.  According to their stories, it was at this age that I fell off the chair with the joystick, running away from the owl on the second level of Robbo. <br><br><h5>  Robbo </h5><br>  This game was written by Polish programmer Janus Pelc and released in 1989.  It was my favorite childhood game. <br><br>  At the institute, my mother was taught programming and she decided to teach me basic in 4 years old.  Then the first attempt was made to rewrite the robbo independently.  The bad thing was that I knew only the operators PRINT, INPUT and POKE.  It didn‚Äôt lead to anything good / Z couldn‚Äôt even imagine how it was possible to write such a game, what I was doing was similar to brute force on all turns.  The user clicked to the right and otprintilas state where the character is shifted one cell to the right, that is, it was askiart state machine in its purest form.  If I knew about the text quests, then they would be implemented by this method, but I did not know. <br><br>  The next iteration was in ninth grade.  It was already Visual Basic and AMD-K6 II 500. At that time, Upgrade magazine decided to release its first issue with the disk, and I just had some implementation of the game.  In MS Paint, a pile of sprites were painted with their trademark pioneers, after which I sent them this toy.  A few months later the screw died and the code was lost.  In the code there were only arrays, even the structures were not used, one algorithm for traversing the labyrinth, according to the right-hand rule of the NPC, occupied eight A4 pages of code (I'm not joking).  There was no normal Internet yet, just a dial-up. <br><br>  In grade 11, a new version was written on the same Visual Basic.  Here the code became noticeably better, I did not describe different behavior for 4 directions of movement. <br><br>  It's been 8 years.  Learning patterns, reading lots of literature and practical experience, learning a string of languages, loving functional style and js in particular, developing HTML 5. And I returned to Robbo again.  All these years, I sometimes ran the atari emulator (Atari800Win) in the evenings and played my favorite childhood game.  For 2 days I wrote code where there were much fewer lines than before.  Then came the epiphany that this should be refactored.  Refactoring lasted for several months.  This is a non-commercial project, that is, a hobby, because I tried to lick the code, although there are still flaws for which I am ashamed.  In more detail with what I encountered, I will describe in the technical part. <br><br><h5>  GnuRobbo. </h5><br>  There is a similar open source project GnuRobbo.  They implemented robbo on c ++ cross-platform (now there is even a working version for Android on Google Play).  The last few years, when I was drawn to remember robbo - I ran this particular implementation.  When I started working on this project I was tempted to see how they did it, and so, with the general similarity (if you switch the skin in classic), it feels like it's a robbo, but in reality there are a lot of different places.  It seems that the development was not saturated with love, no matter how strange it might sound. <br><br><h4>  Technically popular part. </h4><br><br>  Any toy where there is a living world is built around some realization of an infinite loop.  There is nothing complicated, the usual function call via setInterval.  This function is the calculation of the new state of the world and redrawing the changed parts. <br><br>  Having reviewed the game, I realized that many objects in this world implement the same behavior.  So a bomb, a stone, some guns, a starship can be moved by resting them. <br><br>  The objects themselves turned out to be extremely simple.  Here, for example, the door code (door.js): <br><pre><code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> R </span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-string"><span class="hljs-string">'use strict'</span></span>; R.objects.Door = { <span class="hljs-comment"><span class="hljs-comment">//    explodable: true, //    ,      eatable: true, eat: function( eater ){ //             if( eater.keys &gt; 0 ){ //      eater.set( 'keys', eater.keys - 1 ); //   this.game.setCell( this, 'Empty' ); //      this.game.playSound('door_default') } //  eat  ,     false,    //       .       , //           ,    . return false; } }; } )(window.R);</span></span></code> </pre> <br><br>  With this approach, making simple objects came out quickly.  But with lava, bombs, explosions, bullets and teleports had to tinker. <br><br><h5>  Bomb and explosion </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/043/05e/c57/04305ec57d42514a2069e389c8a93ed5.png" alt="image"><br>  A bomb is an object that explodes and carries everything that is one cell away from it.  In the original robbo, it really looks like an explosion, and in gnuRobbo they have beaten all the beauty. <br>  A large number of videos were recorded of how the bomb explodes in the emulator, after which the storyboard of the explosion sprites was rewritten on paper.  For two days I contemplated the numbers.  During this time, I learned that the explosion animation has 5 states; first, the explosion intensifies, and then fades, but it does not do this evenly in all directions, but according to a certain pattern.  At the forum, someone has already noticed that the explosions are different and assumed that this is random, but no, this could not be random.  In those days, getting pseudo-random numbers was expensive fun. <br><br>  Having seen enough of the numbers, I derived the regularities and two matrixes of explosions.  The matrix is ‚Äã‚Äãsuperimposed on neighboring cells and where the number is greater than zero, an explosion object is placed with animation corresponding to the number from the matrix.  If there was already an explosion, then a number from the matrix is ‚Äã‚Äãadded to its animation, after which max (5, animation) is made. <br>  1) The moment matrix after the bomb touches the bullet or a nearby explosion: <br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br>  At this point, the bomb is still alive as an object and visually. <br><br>  2) A matrix is ‚Äã‚Äãsuperimposed on the next clock: <br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  For one bomb, the result is identical to the original game. <br>  For a few bombs - not yet identical.  It looks like the original animation, but still needs some work <i>(ashamed)</i> . <br><br>  The explosion itself is represented by an object occupying one cell and reducing its animation by 1 for each step.  After the explosion, this object is able to call a callback or put in place a predetermined other object. <br><br>  In fact, there are many explosions in the game: <br>  The smoke from a burst cartridge, the destruction of an object, a bomb explosion, teleportation from, teleportation to (here the animation of the explosion goes in the reverse order) <br><br><h5>  Teleport </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/417/c59/8ec/417c598ec09c49f0b85aac42b3d2fe48.png" alt="image"><br>  The teleport works as a teleport itself.  Moves a robbo from one part of the card to another.  At the entry point, the robbo is dematerialized, and at the exit it materializes back.  If he enters on the right, he will come out on the left side.  Interesting cases begin when at the exit point the desired exit is blocked, sometimes all sides of the exit are closed, and sometimes the exit point can explode.  Teleports are not necessarily connected in pairs, they can be looped and a large number of outputs.  In my implementation, I made the opportunity to exit and not in another teleport, but this is for the future when I will make a game with my idea.  On the emulator, I checked all these states and wrote down what it leads to.  The love of optimization came to me from an assembler, so I reloaded the initial table -&gt; the final state and reduced the selection of the output cell to an expression without a conditional operator.  It was more a pick-up game, in this case it is not justified, but since I spent the time, I left it.  In fact, it turned out that we need to incrementally perform the xor operation of the current direction from 11 | 10 | 11 | 10. <br>  We have an input direction.  Suppose we entered on the right, which corresponds to direction 2 (entered on the right, then went to the left side).  The algorithm will try cells 2 (left), 1 (down) (10 ^ 11 = 01), 3 (up) (01 ^ 10 = 11), 0 (right) (11 ^ 11 = 0), and then return to the original state (in case all outputs are blocked). <br><br>  In the form of an algorithm, it looks like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tryCell, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; i++ ){ tryCell = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.game.getCell( R.addDirection( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.teleportX, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.teleportY, obj.direction ) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( tryCell.is( <span class="hljs-string"><span class="hljs-string">'Empty'</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; obj.direction = obj.direction ^ ( <span class="hljs-number"><span class="hljs-number">3</span></span> - i % <span class="hljs-number"><span class="hljs-number">2</span></span> ); }</code> </pre><br><br><h5>  Lava. </h5><br><img src="http://habrastorage.org/storage3/e08/907/85f/e0890785f328094177d9cc269c799db1.png" alt="image"><br>  An object that moves from left to right (or vice versa) as a whole line.  It sweeps away everything except walls.  At first I tried to implement this behavior at the level of a single cell, like other objects, but it turned out that it is much easier to examine all neighbors on a horizontal line bounded by walls in one step of one object, move them and tell them that in this world step their actions are no longer are needed. <br><br><h4>  Technical part </h4><br><br>  The game code is divided into logical modules, the main ones: controller, view, sprite manager, keyboard handler, objects (modulo each individual object and factory of objects). <br><br>  The model is mixed with the main controller, and the objects themselves are small controllers, responsible only for their behavior.  Separately, there is a view that initializes the canvases, monitors the update of the sprites, scrolls the playing field and asks R.sprites to draw the necessary image in the desired position. <br><br>  Initially, it seemed to me that sorting through the entire playing field and seeing whether an object is alive is not the most optimal approach.  So the list of active objects was born.  In the step of the world only their behavior is processed. <br><br>  The general functions of working with the card were brought to the controller, such as: <br>  swap - swap two objects.  Actively used when moving single objects (step, single shot, npc) <br>  getCell (x, y) - returns the object with the specified position <br>  getCell (obj) -&gt; returns an object in the coordinates obj.x, obj.y <br><br>  setCell (x, y, obj, data) - puts the object in the specified position.  Obj can be either another object or an object name (for example, 'Explosion').  In the case of an object name, the factory of objects will call. <br>  setCell (obj1, obj2, data) -&gt; does the same, only the coordinates are torn from obj1.x, obj1.y <br><br>  Everything looked simple until testing started on the original gameplay.  Then it turned out that in the original game, if you rest a stone on a bird flying up and down on the right, then in the next step the robbo will die, and if on the left, he will slip over it.  I had to sort the actionObjects in accordance with the workaround order of the original game. <br><br><h5>  Sprites </h5><br>  Redrawing the entire playing field at every step would be wrong in terms of performance (although not critical for modern computers).  Here I implemented a hash of variable object sprites, which consists of the key: y coordinates of the object, and there is a hash of all the objects changed from the last drawing on this line with key: object.x, and value: the object itself.  By this I killed two birds with one stone: an extra round of the entire field is not done and the modified cell is drawn only once, even if there were several changes (for example, the bird moved down into the cage, and then it was swallowed by lava, all in one step of the world) . <br><br>  The sprites themselves were initially honestly pulled from gnu robbo, but very soon I realized that this was done in vain.  It was easier to do the original immediately than to fiddle around and play pixel-catching (some of them addixelartili to higher resolution, some do-italiasilis, and some came up with their own), they also lacked 80 percent of the sprites of the walls (there were much more of them in the game than I expected) . <br><br>  With the animation was a similar problem.  As a result, I recorded video from the emulator and watched what was going to happen frame by frame.  As an example: when taking a step of characters - the animation of the shift of the sprite should take place already in a new place somewhere between the world. <br>  That is, a step was added to the main loop in which no movement of objects occurs, but only an image changes. <br><br><h4>  A separate chapter deserves a palette of sprites. </h4><br>  I did not immediately notice that the original robbo at each level uses its own set of colors. <br>  This is a very frequent decision of those years of game development and demoscene.  There was little memory, but I already wanted visual effects, because in old computers there was a simple opportunity to change the number from the palette to the color itself. <br>  The decision was made in the forehead - all colors torn from the original levels of the game were added to the config of each level, all sprites were reduced to 4 common colors.  At the loading level, there is a pixel-by-pixel repainting of the entire picture into a new color scheme. <br><br>  Just last week I made a separate project (there will be a post, if you're interested), which allows you to change the palette without pixel-by-pixel manipulations.  Amazingly, this method works in IE7. <br>  But I have not yet drawn this technology into the current game code. <br><br><h4>  Conclusion </h4><br>  The game still has some flaws. <br><br>  In the plans: <br><ul><li>  Hit the group bomb blast. </li><li>  Make support for older browsers. </li><li>  Extract the colors of the general background around the playing field and the numbers from the original game. </li><li>  Make ending lives (now it's old school, but then the toy itself is from those times). </li><li>  To complete touch control support for mobile platforms, to make smart tv support for playing from the TV remote. </li><li>  And, of course, port the final cartoon. </li></ul><br><br>  In remote plans: <br><ul><li>  Make a level editor with an object editor, where the user can draw his object, draw him a chain of sprites and select various behaviors from the extensive pre-find list.  This will make it possible to make robbo sokoban, pakmana (here we must also think about the intercellular movement), boulddash, tetris, and at least the arcanoid. </li><li>  Make a common database of levels where users can add their own, while others can vote for their favorites. </li></ul><br><br>  I promised myself to post this release before the new year and write in general about the development.  It seems to succeed.  There are still places for which I am ashamed (in particular, the whole work with loading levels, animation of level changes). <br>  All the upcoming holidays! </div><p>Source: <a href="https://habr.com/ru/post/207920/">https://habr.com/ru/post/207920/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207906/index.html">Papers: a simple game for tonight</a></li>
<li><a href="../207908/index.html">An animation of the SVG path element</a></li>
<li><a href="../207910/index.html">Briefly about the new: Samsung has developed the world's first 8-gigabit module of mobile DRAM-memory LPDDR4</a></li>
<li><a href="../207912/index.html">New Year's greetings from the robot</a></li>
<li><a href="../207918/index.html">The exhibition "Informatics in the USA": a documentary film about the exhibition</a></li>
<li><a href="../207922/index.html">Identification based on movement data (tracking)</a></li>
<li><a href="../207924/index.html">Intellij IDEA: Oracle Cloud Integration</a></li>
<li><a href="../207926/index.html">Oracle Business Intelligence Overview</a></li>
<li><a href="../207928/index.html">How we helped the blind grandfather. Making the indicator of the level of liquid in the cup with your own hands</a></li>
<li><a href="../207930/index.html">Basic Node.JS application using express</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>