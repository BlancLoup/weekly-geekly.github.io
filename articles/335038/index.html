<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Virtual network environment for testing network protocols. Use QEMU + YOCTO + TAP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The idea of ‚Äã‚Äãcreating a network test environment arose when the need came to launch and debug devices with IPsec and GRE protocols. The developers fa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Virtual network environment for testing network protocols. Use QEMU + YOCTO + TAP</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/9b1/e7a/972/9b1e7a9723d7443cb203ddf9f9dc213b.png"><br><br>  The idea of ‚Äã‚Äãcreating a network test environment arose when the need came to launch and debug devices with IPsec and GRE protocols.  The developers faced strong problems with similar problems.  The problem was with the unit test run.  They prepared a virtual network based on UML (user mode linux).  <a href="https://www.strongswan.org/uml/DFN_UML.pdf">This document</a> outlines what it is and how it works.  I will bring the virtual network under UML at the earliest opportunity, and at the first stage the test environment was raised on QEMU and on distributions prepared under YOCTO.  So this article describes: how to create your linux distribution, pick up and configure several QEMU instances, set up a virtual network and, as an example, put a GRE tunnel.  It turns out a very useful thing for debugging and testing routers.  So I invite all interested below. <br><a name="habracut"></a><br>  Ubuntu distribution was used as Host. <br><br><pre><code class="bash hljs">Linux 4.10.0-28-generic <span class="hljs-comment"><span class="hljs-comment">#32~16.04.2-Ubuntu SMP Thu Jul 20 10:19:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span></code> </pre> <br><h2>  Cooking distribution linux </h2><br>  So first we will prepare the distribution of linux for virtual machines.  For this we use the assembly system YOCTO.  Distribution is easy, and it also allows you to configure / compile the kernel and install additional packages.  Another plus is the cross-platform distribution of linux.  Having trained on virtual builds we can transfer distribution to embedded systems.  Distribution preparation can take about an hour or two.  Finished assembly can be found <a href="https://drive.google.com/file/d/0B5GBijEWWZaxZV91UURXYXVEc3c/view%3Fusp%3Dsharing">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Required Tools <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> apt-get install chrpath gawk texinfo python</code> </pre><br>  Maybe something else is needed. <br><br><h3>  a) Install yocto </h3><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$mk</span></span> yocto <span class="hljs-variable"><span class="hljs-variable">$cd</span></span> yocto <span class="hljs-variable"><span class="hljs-variable">$git</span></span> <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b pyro git://git.yoctoproject.org/poky.git <span class="hljs-variable"><span class="hljs-variable">$git</span></span> <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b pyro git://git.openembedded.org/meta-openembedded <span class="hljs-variable"><span class="hljs-variable">$source</span></span> ./poky/oe-init-build-env</code> </pre><br><h3>  b) Editing configuration files </h3><br>  The working directory will be "yocto / build" <br>  Let's fix the installation. <br>  In the file conf / bblayers.conf correct <br><br> <code>BBLAYERS ?= " \ <br> /home/user/yocto/poky/meta \ <br> /home/user/yocto/poky/meta-poky \ <br> /home/user/yocto/poky/meta-yocto-bsp \ <br> /home/user/yocto/meta-openembedded/meta-oe \ <br> /home/user/yocto/meta-openembedded/meta-networking \ <br> /home/user/yocto/meta-openembedded/meta-webserver \ <br> /home/user/yocto/meta-openembedded/meta-python \ <br> /home/user/yocto/meta-openembedded/meta-multimedia \ <br> " <br></code> <br>  Install some useful packages.  In the /conf/local.conf file <br><br> <code># We default to enabling the debugging tweaks. <br> EXTRA_IMAGE_FEATURES ?= "debug-tweaks" <br> <br> CORE_IMAGE_EXTRA_INSTALL = " \ <br> kernel-modules \ <br> lrzsz \ <br> setserial \ <br> strongswan \ <br> opkg \ <br> nbench-byte \ <br> lmbench \ <br> alsa-utils \ <br> i2c-tools \ <br> devmem2 \ <br> dosfstools \ <br> libdrm-tests \ <br> netkit-ftp \ <br> iproute2 \ <br> iptables \ <br> bridge-utils \ <br> socat \ <br> wget \ <br> curl \ <br> vlan \ <br> dhcp-server \ <br> dhcp-client \ <br> ntp \ <br> libstdc++ \ <br> nginx \ <br> ppp \ <br> proftpd \ <br> boost \ <br> openssl \ <br> openssh \ <br> fcgi \ <br> mc \ <br> ethtool \ <br> minicom \ <br> procps \ <br> tcpdump \ <br> file" <br></code> <br>  Additionally, you need to correct the sshd configuration file "yocto / poky / meta / recipes-connectivity / openssh / openssh / sshd_config". <br><br> <code># override default of no subsystems <br> #Subsystem sftp /usr/libexec/sftp-server <br> Subsystem sftp internal-sftp <br></code> <br>  This amendment is necessary in order not to install an additional sftp server.  It is used when mounting the file system via ssh. <br><br><h3>  c) Running the assembly </h3><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$bitbake</span></span> core-image-minimal</code> </pre><br>  You must wait. <br><br>  If the assembly ended in success, then at the output we get: <br><br> <code>rootfs - /yocto/build/tmp/deploy/images/qemux86/core-image-minimal-qemux86-20170803162854.rootfs.ext4 <br> <br> kernel - /yocto/build/tmp/deploy/images/qemux86/bzImage‚Äî4.10.17+git0+e92bd55409_6648a34e00-r0-qemux86-20170801184648.bin</code> <br>  The build system determines what has changed and appends files with a time stamp in the file name.  Links to the latest versions. <br><br> <code>¬´bzImage¬ª <br> ¬´core-image-minimal-qemux86.ext4¬ª</code> <br> <h3>  d) Check the assembly </h3><br>  Install qemu for the host platform.  In this case, x86 is 64 bits. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> apt-get install qemu-system-x86 <span class="hljs-variable"><span class="hljs-variable">$qemu</span></span>-system-x86_64 --version QEMU emulator version 2.0.0 (Debian 2.0.0+dfsg-2ubuntu1.34), Copyright (c) 2003-2008 Fabrice Bellard</code> </pre><br>  Run qemu. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$cd</span></span> ~/yocto/build/tmp/deploy/images/qemux86 <span class="hljs-variable"><span class="hljs-variable">$qemu</span></span>-system-x86_64 -hda ./core-image-minimal-qemux86.ext4 -kernel ./bzImage -append <span class="hljs-string"><span class="hljs-string">"console=ttyS0 root=/dev/hda initrd=/initrd"</span></span> -nographic</code> </pre><br><img src="https://habrastorage.org/web/b1f/bf8/fbe/b1fbf8fbee5d4bccb9f82f6ad5ecd71a.jpg"><br><br>  If we see the following picture, the virtual machine got up. <br><br><h2>  Virtual Network Configuration </h2><br>  Scripts and installations are <a href="https://github.com/framer/test-net">here https://github.com/framer/test-net</a> . <br><br><h3>  a) Creating a network diagram </h3><br>  For clarity, we will create a virtual network diagram. <br><br><img src="https://habrastorage.org/web/1b1/2b4/21c/1b12b421cbd94b65ac3f348dcef30222.png"><br><br>  H1, H2, R1, R2 - Virtual Machines. <br>  BR0, BR1, BR2, BR3 - Virtual Switches. <br><br>  Each virtual machine has a management interface (eth0) connected to the switch BR0.  We are also creating a network 192.168.40.0/24.  These interfaces and network will be used for installations and control. <br><br><h3>  b) Installing virtual switches </h3><br>  First, we will install virtual switches to which the TAP interfaces of virtual machines will be connected.  Install multiple virtual switches for different network segments.  You can install as follows: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$cd</span></span> ./src <span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> ./setup_bridge.sh 4 <span class="hljs-variable"><span class="hljs-variable">$ip</span></span> link</code> </pre><br><img src="https://habrastorage.org/web/912/175/6db/9121756dbc804bb1b00d1231c0f24df5.png"><br><br>  For the BR0 switch, we assign the control address and enable packet transfer between the interfaces. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ip</span></span> addr add 192.168.40.1/24 dev br0 <span class="hljs-variable"><span class="hljs-variable">$sysctl</span></span> -w net.ipv4.ip_forward=1</code> </pre><br><h3>  c) Settings file "conf.json" </h3><br>  The installation file is prepared according to the scheme.  If something needs to be changed or supplemented, then this file should be edited.  This file installs interfaces and management addresses.  Setting the addresses of the tested network will be after the launch of virtual machines. <br><br><h3>  d) Creating instances of virtual machines </h3><br>  First, we copy the previously created kernel and system root file into the ‚Äúsrc‚Äù directory. <br><br>  File names are as follows: <br>  bzImage - core <br>  rootfs is the root file system. <br>  If someone does not have its distribution, then ready-made assembly can be taken <a href="https://drive.google.com/file/d/0B5GBijEWWZaxZV91UURXYXVEc3c/view%3Fusp%3Dsharing">here</a> . <br><br>  To create instances, use the ‚Äúcreate_network.py‚Äù script. <br><br><pre> <code class="bash hljs">$./create_network.py</code> </pre><br>  The script creates instances of virtual machines.  Since there is no control network configuration yet, there is no access to the virtual machine through the network.  The script starts the virtual machines in the mode of intercepting I / O streams and makes the installation of the control network. <br><br>  After running the script directories are created for each virtual machine. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ls</span></span> .. -Al</code> </pre><br><img src="https://habrastorage.org/web/7a1/2ee/022/7a12ee0221e1496aafd541988a083083.png"><br><br><h3>  e) Starting the environment </h3><br>  To run the environment, do this: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> ./run_network.py</code> </pre><br><img src="https://habrastorage.org/web/9ee/26f/4b8/9ee26f4b88684b57b4ac71b39fa8feef.png"><br><br>  Run under sudo, as the machines create tap interfaces.  Machines work in the background.  A standard console is written to the file ‚Äúoutput.log‚Äù. <br><br>  Access to the machines via ssh.  There is one problem.  If we re-create the environment, the keys will be re-generated for ssh when the machine starts.  The host will determine that under those same addresses the machine is running with other keys and will start swearing.  In this case, you need to clean the file ".ssh / known_hosts". <br><br>  Once the machines are up, you can mount the root file system. <br><br><pre> <code class="bash hljs">$./mount_fs.py</code> </pre><br>  The mounted system files are located in the H1 / tmp, H2 / tmp, R1 / tmp, R2 / tmp directories. <br><br><h3>  e) Network settings </h3><br>  After starting the environment, the virtual machines have only the management network installed.  You can set the remaining network parameters according to the scheme, for all machines at once, by running the script: <br><br><pre> <code class="bash hljs"> <span class="hljs-variable"><span class="hljs-variable">$cd</span></span> ../scripts $./static.sh</code> </pre><br>  static.sh is an example of a network with static routing. <br><br>  Theoretically, the network is configured. <br><br>  Network diagnostics.  Network diagnostics can be performed on each virtual switch. <br><br>  Connect to H1 via ssh. <br>  On H1, run ping on H2. <br><br><pre> <code class="bash hljs">root@H1:~<span class="hljs-comment"><span class="hljs-comment"># ping 192.168.51.10</span></span></code> </pre><br>  On the host run diagnostics <br><br><pre> <code class="bash hljs">$ sudo tcpdump -i br2</code> </pre><br><img src="https://habrastorage.org/web/000/44f/9a5/00044f9a5b4842d68843db61897054f4.png"><br><br><h3>  f) Network shutdown </h3><br>  To stop and unmount the system file, run. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> ./stop_network.py</code> </pre><br><h2>  GRE configuration </h2><br><h3>  a) correct the network diagram </h3><br><img src="https://habrastorage.org/web/80d/98f/248/80d98f248f3243c8b47ad6758ab3ef53.png"><br><br><h3>  b) Starting the environment and setting the environment </h3><br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$sudo</span></span> run_network.py</code> </pre><br>  Wait and mount the system file. <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$mount_fs</span></span>.py</code> </pre><br>  Set environment settings <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$cd</span></span> ../scripts $./gre.sh</code> </pre><br><h3>  c) Network diagnostics </h3><br>  Connect to H1 via ssh. <br>  On H1, run ping on H2. <br><br><pre> <code class="bash hljs">root@H1:~<span class="hljs-comment"><span class="hljs-comment"># ping 192.168.51.10</span></span></code> </pre><br>  On the host run <br><br><pre> <code class="bash hljs">$ sudo tcpdump -i br2</code> </pre><br><img src="https://habrastorage.org/web/4fe/4bb/405/4fe4bb4058b14bfa9f7cfda1549b4cb1.png"><br><br><h2>  Conclusion </h2><br>  Why all this? <br><br>  First of all.  Anyone who is working on creating routers is wondering.  ‚ÄúAnd how will it work in real conditions?‚Äù And then this system comes to the rescue.  Having additional network cards on the host, you can connect a real card to the virtual switchboard and replace the virtual machine with a real device.  Automation of the creation of the environment allows you to prepare different scenarios of work and check the functionality of a real device. <br>  Secondly.  Probably for students. </div><p>Source: <a href="https://habr.com/ru/post/335038/">https://habr.com/ru/post/335038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335028/index.html">Using Hotspot Helper Extension</a></li>
<li><a href="../335030/index.html">Setting up the main and two backup operators on a Linux-router with NetGWM</a></li>
<li><a href="../335032/index.html">3CX 15.5 SP1 Beta Release and Acquisition of Askozia</a></li>
<li><a href="../335034/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ274 (August 1 - 6, 2017)</a></li>
<li><a href="../335036/index.html">Clearing the flow of calls without magic and SMS</a></li>
<li><a href="../335040/index.html">Basic Linux fortification: choosing hedgehogs and learning to dig trenches</a></li>
<li><a href="../335042/index.html">Look up from the bottom or Ubuntu Server for the developer of electronics. Part 2</a></li>
<li><a href="../335044/index.html">vCloud Director</a></li>
<li><a href="../335046/index.html">In the footsteps of Petya: find and exploit a software vulnerability</a></li>
<li><a href="../335048/index.html">Start learning Elixir right now! Translation of the entire series of articles is ready.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>