<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cisco IP SLA based caching DNS balancing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the network of any Internet provider you can find such a mandatory element as a caching DNS service. And since the work of the Internet without the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cisco IP SLA based caching DNS balancing</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/c17/649/5ff/c176495ff22a49a3ad96580830991b4a.png" alt="DNS Fail"></p><br><p>  In the network of any Internet provider you can find such a mandatory element as a caching DNS service.  And since the work of the Internet without the DNS service is impossible, there will be at least two such servers, with mandatory redundancy and balancing.  In this article I will try to describe one of the options for load balancing between several caching servers based on Cisco IP SLA. <a name="habracut"></a></p><br><h1>  Possible solutions </h1><br><h2>  Balancing on the client side </h2><br><p>  The easiest way to backup a caching DNS is to configure on the client side several entries with addresses of DNS servers.  DNS server addresses can be communicated to the client in various ways: </p><br><ul><li><p>  through the appropriate attributes of DHCP (for those subscribers who use IPoE technology and automatic configuration); </p><br></li><li><p>  via the LCP protocol for PPPoE subscribers (or any other PPP technology); </p><br></li><li>  specifying in the annex to the contract or instructions for subscribers whose IP connection is manually configured. </li></ul><br><p>  The client, in case of unavailability of the first server, automatically switch to the second, etc.  But this method has two obvious drawbacks. </p><br><p>  The first is that there is no full load balancing.  While the first server is available and working (and we presume that the server‚Äôs failure is an unpleasant thing, but extremely rare), the subscribers have no reason to switch to the second one, and it is idle. </p><br><p>  The second drawback stems entirely from the first, but is of much greater significance.  The criteria for switching to the backup server are fully determined by the settings on the client side.  For example, here is a <a href="https://support.microsoft.com/en-us/kb/2834226">description of the standard DNS client timings of Windows XP</a> .  From the article it follows that Windows XP switch to using a backup server only if the main server does not respond within one second.  Those.  You can imagine a situation where, as a result of an overload, a configuration error or a failure, the main server does not work satisfactorily, but responds within 0.95 seconds.  Obviously, with such a delay, the subscriber cannot speak about any normal operation of the Internet.  But, since the response time is less than one second, subscribers "will cry, prick, but continue to eat a cactus," or rather, they will experience a degradation of the service, but will not switch to an idle standby DNS server. </p><br><p>  Of course, this behavior of the DNS service is abnormal and must be detected by the monitoring system with the subsequent escalation of the problem.  But the issue of monitoring is away from the topic of the note. </p><br><h2>  Destination NAT </h2><br><p>  Another balancing method is destination NAT.  This is a solution that is actively used to distribute the load on clusters of web servers.  In this case, subscribers use the only address of the DNS server that is the address of the NAT interface, and real DNS servers are privately addressed.  When subscribers access the DNS server, a translation occurs in the Destination IP-address request to one of the servers.  With this approach, the load can be distributed evenly.  But this method is somewhat redundant, as full-fledged NAT, in the case of web servers, is justified by the fact that the transport there is provided by the TCP protocol, which is stateful, in contrast to the stateless UDP transport, usually used for DNS queries.  Unlike exchanging traffic with a web server, the client‚Äôs dialogue with the DNS server is very concise and involves only a request-response pair. </p><br><h2>  Static routing </h2><br><p>  A simpler way is static routes.  Imagine that we have three DNS servers with IP addresses: </p><br><ul><li>  10.0.0.1, </li><li>  10.0.0.2, </li><li>  10.0.0.3. </li></ul><br><p>  Loopback interface is configured on each of them. <em>10.10.10.10</em> .  The DNS service is configured to receive requests for this address, and the firewall has rules for TCP / UDP ports 53. </p><br><p>  In this case, any of these servers is ready to serve DNS requests with the destination address 10.10.10.10.  This will be the IP address of the DNS server used by all our subscribers.  It remains to distribute their requests between real servers.  There is nothing special to do.  We configure on the router where our servers are connected three static routes: </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span></code> </pre> <br><p>  As a result, we get the following picture: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">Router</span></span>#show ip route <span class="hljs-number"><span class="hljs-number">10.10</span></span>.<span class="hljs-number"><span class="hljs-number">10.10</span></span> <span class="hljs-type"><span class="hljs-type">Routing</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span>.<span class="hljs-number"><span class="hljs-number">10.10</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-type"><span class="hljs-type">Known</span></span> via <span class="hljs-string"><span class="hljs-string">"static"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">distance</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, metric <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">Routing</span></span> <span class="hljs-type"><span class="hljs-type">Descriptor</span></span> <span class="hljs-type"><span class="hljs-type">Blocks</span></span>: * <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-type"><span class="hljs-type">Route</span></span> metric <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, traffic share <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span> <span class="hljs-type"><span class="hljs-type">Route</span></span> metric <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, traffic share <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-type"><span class="hljs-type">Route</span></span> metric <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, traffic share <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Now the standard per-flow balancing mechanism will sequentially decompose requests from different subscribers along the three available routes: </p><br><p><img src="https://hsto.org/files/7de/320/1ba/7de3201baae64040bad04d0961300b2f.png" alt="Balancing scheme"></p><br><h1>  Apply IP SLAs DNS for Failover </h1><br><p>  Now that we have taken care of balancing, it remains to resolve the issue of switching traffic in case of failure of one of the servers.  This will help us with the Cisco IP SLA mechanism, or rather the <a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipsla/configuration/15-mt/sla-15-mt-book/sla_dns.html">IP SLAs DNS Operation</a> feature. </p><br><h2>  Description of work </h2><br><p>  Briefly, this function can be described as follows: </p><br><ol><li><p>  In the router configuration, three IP SLA records are created that periodically query each of the three DNS servers (for example, the standard A-RR request www.google.com).  The result of the query determines the status of the record. </p><br></li><li><p>  Three Track objects are associated with IP SLA records, which become <em>DOWN</em> if the status of the corresponding IP SLA is not <em>OK</em> . </p><br></li><li>  Three static routes from the section above are connected to their Track object. </li></ol><br><p>  Now, if at a certain moment one of the servers does not respond or does not respond correctly to the DNS query, the corresponding Track object will switch to the DOWN state, and the static route associated with it will disappear from the routing table.  As a result, the problem server will be excluded from the balancing mechanism. </p><br><h2>  Configuration example </h2><br><p>  IP SLA configuration: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sla</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.google</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name-server</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timeout</span></span> 5000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">frequency</span></span> 9 <span class="hljs-selector-tag"><span class="hljs-selector-tag">threshold</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sla</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.google</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name-server</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timeout</span></span> 5000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">frequency</span></span> 9 <span class="hljs-selector-tag"><span class="hljs-selector-tag">threshold</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sla</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.google</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name-server</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timeout</span></span> 5000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">frequency</span></span> 9 <span class="hljs-selector-tag"><span class="hljs-selector-tag">threshold</span></span> 10</code> </pre> <br><p>  Activating and setting tracking: </p><br><pre> <code class="hljs sql">ip sla schedule 1 life forever <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span> ip sla schedule <span class="hljs-number"><span class="hljs-number">2</span></span> life forever <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span> ip sla schedule <span class="hljs-number"><span class="hljs-number">3</span></span> life forever <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span> track <span class="hljs-number"><span class="hljs-number">1</span></span> ip sla <span class="hljs-number"><span class="hljs-number">1</span></span> track <span class="hljs-number"><span class="hljs-number">2</span></span> ip sla <span class="hljs-number"><span class="hljs-number">2</span></span> track <span class="hljs-number"><span class="hljs-number">3</span></span> ip sla <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  Setting routes with reference to tracking: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">track</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">track</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">track</span></span> 3</code> </pre> <br><h2>  Testing </h2><br><p>  Now, besides the routes themselves, we have three IP SLAs that are currently working, and the result of the last query is <em>OK</em> for all. </p><br><pre> <code class="hljs pgsql">Router# <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ip sla <span class="hljs-keyword"><span class="hljs-keyword">statistics</span></span> IPSLA operation id: <span class="hljs-number"><span class="hljs-number">1</span></span> Latest RTT: <span class="hljs-number"><span class="hljs-number">1</span></span> milliseconds Latest operation <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span> UTC+<span class="hljs-number"><span class="hljs-number">7</span></span> Wed Aug <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> Latest operation <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> code: OK Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> successes: <span class="hljs-number"><span class="hljs-number">373</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> failures: <span class="hljs-number"><span class="hljs-number">0</span></span> Operation <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> live: Forever IPSLA operation id: <span class="hljs-number"><span class="hljs-number">2</span></span> Latest RTT: <span class="hljs-number"><span class="hljs-number">1</span></span> milliseconds Latest operation <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span> UTC+<span class="hljs-number"><span class="hljs-number">7</span></span> Wed Aug <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> Latest operation <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> code: OK Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> successes: <span class="hljs-number"><span class="hljs-number">373</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> failures: <span class="hljs-number"><span class="hljs-number">0</span></span> Operation <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> live: Forever IPSLA operation id: <span class="hljs-number"><span class="hljs-number">3</span></span> Latest RTT: <span class="hljs-number"><span class="hljs-number">1</span></span> milliseconds Latest operation <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span> UTC+<span class="hljs-number"><span class="hljs-number">7</span></span> Wed Aug <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> Latest operation <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> code: OK Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> successes: <span class="hljs-number"><span class="hljs-number">373</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> failures: <span class="hljs-number"><span class="hljs-number">0</span></span> Operation <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> live: Forever</code> </pre> <br><p>  Let's try to disable the DNS service on the DNS-1 server.  During the next check (they happen every nine seconds), the corresponding IP SLA will report the problem: </p><br><pre> <code class="hljs pgsql">Router# <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ip sla <span class="hljs-keyword"><span class="hljs-keyword">statistics</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> IPSLA operation id: <span class="hljs-number"><span class="hljs-number">1</span></span> Latest RTT: NoConnection/Busy/Timeout Latest operation <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> UTC+<span class="hljs-number"><span class="hljs-number">7</span></span> Wed Aug <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> Latest operation <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> code: Timeout Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> successes: <span class="hljs-number"><span class="hljs-number">1</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> failures: <span class="hljs-number"><span class="hljs-number">1</span></span> Operation <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> live: Forever</code> </pre> <br><p>  And the corresponding route with next-hop 10.0.0.1 will disappear from the routing table: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">Router</span></span>#show ip route <span class="hljs-number"><span class="hljs-number">10.10</span></span>.<span class="hljs-number"><span class="hljs-number">10.10</span></span> <span class="hljs-type"><span class="hljs-type">Routing</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span>.<span class="hljs-number"><span class="hljs-number">10.10</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-type"><span class="hljs-type">Known</span></span> via <span class="hljs-string"><span class="hljs-string">"static"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">distance</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, metric <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">Routing</span></span> <span class="hljs-type"><span class="hljs-type">Descriptor</span></span> <span class="hljs-type"><span class="hljs-type">Blocks</span></span>: * <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span> <span class="hljs-type"><span class="hljs-type">Route</span></span> metric <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, traffic share <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-type"><span class="hljs-type">Route</span></span> metric <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, traffic share <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Client requests are now distributed between the two remaining servers.  If we restart the service again, then at the next IP check, the SLA will return the route and the server will again begin to participate in balancing. </p><br><h2>  Lack of method </h2><br><p>  The main and most significant drawback of this method is the minimum possible frequency of polling nine seconds.  Very often, this "efficiency" is critical.  Unfortunately, this is a limitation of Cisco functionality.  If someone tells you how to get around it, I will be very grateful. </p><br><h1>  Conclusion </h1><br><p>  We examined the use of static routing and Cisco IP SLA when balancing and reserving a cached DNS service.  Obvious advantages of the method: </p><br><ol><li>  ease of setup; </li><li>  everything works on the router and does not require additional funds; </li><li>  the response of the service is monitored, and not just, for example, ICMP accessibility echo request. </li></ol><br><p>  Disadvantage: </p><br><ol><li>  The minimum polling period is 9 seconds, which means the reaction time is up to 9 * 2 = 18 seconds. </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/307932/">https://habr.com/ru/post/307932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307922/index.html">How we shoot videos for YouTube. Office equipment and rollers</a></li>
<li><a href="../307924/index.html">Preliminary patent applications may appear in Russia</a></li>
<li><a href="../307926/index.html">Basics of game design: 20 board games. Part seven and last: Nikoli puzzles, crosswords</a></li>
<li><a href="../307928/index.html">SEO optimization. Start</a></li>
<li><a href="../307930/index.html">Cloud Technology Myths. Part 1: about "useless" technical support and "clever" services</a></li>
<li><a href="../307936/index.html">Angular2: RC4 to RC5 Unit Tests Migration Guide</a></li>
<li><a href="../307938/index.html">Java Stream API: what's good and what's not</a></li>
<li><a href="../307940/index.html">Making an "adult" application for Android using the "child" programming environment Scratch</a></li>
<li><a href="../307942/index.html">What are design patterns?</a></li>
<li><a href="../307944/index.html">How static analysis can complement unit testing with the example of NUnit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>