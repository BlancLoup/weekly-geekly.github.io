<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I accelerated strstr</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It took me recently to write an analogue of the function strstr (search for a substring in a string). I decided to speed it up. The result is an algor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I accelerated strstr</h1><div class="post__text post__text-html js-mediator-article"><p>  It took me recently to write an analogue of the function strstr (search for a substring in a string).  I decided to speed it up.  The result is an algorithm.  I did not find it on the first links in the search engine, but there are a bunch of other algorithms, so I wrote it. </p><br><p>  The graph comparing the speed of my algorithm, with the function strstr on 600 kb text of a Russian book, when searching for strings ranging in size from 1 to 255 bytes: </p><br><p><img src="https://habrastorage.org/files/365/f8c/73f/365f8c73f7404867870053fa00ab58ec.JPG" alt="image"></p><a name="habracut"></a><br><p>  The idea behind the algorithm is as follows.  First designations: </p><br><p>  S - The string in which the search will be performed will be called <br>  P - the string we are looking for will be called <br>  sl - string length S <br>  pl - the length of the string P <br>  PInd - plate compiled in the first stage. </p><br><p>  So the idea is this: If in the line S we choose elements with indices equal: pl <em>1, pl</em> 2, ..., pl <em>J, ..., pl</em> (sl / pl), then if in the segment pl <em>(J-1) .. .pl</em> (J + 1) includes the search string P, then the selected element must belong to the string P. Otherwise the string would not fit in length. </p><br><p>  The picture where it is drawn up to where P falls in, pl * 3: </p><br><p><img src="https://habrastorage.org/files/143/712/bad/143712bad7be42199f347173b0533fd5.JPG" alt="image"></p><br><p>  And again, since the selected element is included in the P line, usually a small number of times, then only these occurrences can be checked, not the entire range. </p><br><p>  Total algorithm is as follows: </p><br><h4>  Stage 1. Sorting P </h4><br><p>  For all elements (characters) of the string P, we sort the indices of these elements by the value of these elements.  That is, we do so that all the numbers of all elements equal to some value can be quickly obtained.  This label will continue to be called PInd: </p><br><p><img src="https://habrastorage.org/files/5d0/fb2/814/5d0fb2814cfb43cd92dd2f4218144ac7.JPG" alt="image"></p><br><p>  As can be seen from this table, when searching in step 2 with the search string P equal to "sort indexes" we will need to check a maximum of 2 variants of substrings in S. </p><br><p>  First, I used quick sorting and some other sorting to compile this label, and then I realized that since the elements of the string are single-byte, you can use bitwise. </p><br><h4>  Stage 2. Search </h4><br><p>  We pass through the line to the line S in jumps equal to pl, choosing the corresponding elements.  For each selected item, check if it is included in the string P. </p><br><p>  If it is included, then for all indexes from the PInd of the corresponding element, we check whether the substring S coincides with the beginning of the corresponding index from the PInd offset relative to the selected element and the search string P. </p><br><p>  If matched, then return the result, if not, continue. </p><br><p>  The worst case for this algorithm depends on how the strings are compared in the second stage.  If a simple comparison, then sl * pl + pl, if some more, then another.  I used a simple comparison, as in the usual strstr. </p><br><p>  Due to the fact that the algorithm jumps through the pl elements and checks only possible lines, it works faster. </p><br><p>  The best option is when the algorithm skips the entire string S and does not find the text or finds it the first time, then spends approximately sl / pl. <br>  Average speed, I do not know how to count. </p><br><p>  Here is one of my implementations of this algorithm, based on which the graph was built in the C language.  Here pl is limited, that is, the PInd table is built by the prefix P of length max_len, and not across the entire line.  That it was used in the construction of the schedule: </p><br><div class="spoiler">  <b class="spoiler_title">Here's a coded on si</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_strstr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * str1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * str2,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> slen)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> max_len = <span class="hljs-number"><span class="hljs-number">140</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !*str2 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)str1); <span class="hljs-comment"><span class="hljs-comment">//  unsigned char index_header_first[256]; unsigned char index_header_end[256]; unsigned char last_char[256]; unsigned char sorted_index[256]; memset(index_header_first,0x00,sizeof(unsigned char)*256); memset(index_header_end,0x00,sizeof(unsigned char)*256); memset(last_char,0x00,sizeof(unsigned char)*256); memset(sorted_index,0x00,sizeof(unsigned char)*256); // 1. char *cp2 = (char*)str2; unsigned char v; unsigned int len =0; unsigned char current_ind = 1; while((v=*cp2) &amp;&amp; (len&lt;max_len)){ if(index_header_first[v] == 0){ index_header_first[v] = current_ind; index_header_end[v] = current_ind; sorted_index[current_ind] = len; } else{ unsigned char last_ind = index_header_end[v]; last_char[current_ind] = last_ind; index_header_end[v] = current_ind; sorted_index[current_ind] = len; } current_ind++; len++; cp2++; } if(len &gt; slen){ return NULL; } // 2. unsigned char *s1, *s2; //    S+pl-1 unsigned char *cp = (unsigned char *) str1+(len-1); unsigned char *cp_end= cp+slen; while (cp&lt;cp_end){ unsigned char ind = *cp; //      P if( (ind = index_header_end[ind]) ) { do{ //         unsigned char pos_in_len = sorted_index[ind]; s1 = cp - pos_in_len; if((char*)s1&gt;=str1) { //  s2 = (unsigned char*)str2; while ( *s2 &amp;&amp; !(*s1^*s2) ) s1++, s2++; if (!*s2) return (char*)(cp-pos_in_len); } } while( (ind = last_char[ind]) ); } //   pl cp+=len; } return(NULL); }</span></span></code> </pre> </div></div><br><p>  Update: This is really not a direct replacement for strstr, since it requires an additional parameter - the length of the string S. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/303830/">https://habr.com/ru/post/303830/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303818/index.html">Indian regulator plans to make life difficult for high-frequency trading companies.</a></li>
<li><a href="../303820/index.html">Global trends that manage fintech companies: infographics</a></li>
<li><a href="../303824/index.html">User Behavior Analytics. How can Varonis help here?</a></li>
<li><a href="../303826/index.html">Release Fedora 24. Race for Versions</a></li>
<li><a href="../303828/index.html">The most popular models of refurbished servers</a></li>
<li><a href="../303832/index.html">Interview with Google Programmer Martin Horner about TensorFlow</a></li>
<li><a href="../303834/index.html">Simple graphics using D3.js</a></li>
<li><a href="../303836/index.html">What is space time really?</a></li>
<li><a href="../303838/index.html">Search for connections in social networks</a></li>
<li><a href="../303840/index.html">Java library for the efficient transfer of CSS and JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>