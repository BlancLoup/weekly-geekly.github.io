<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast implementation of incremental backup on Amazon S3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After moving my website from a shared hosting to a virtual server in the cloud, the question of data archiving came up close: if earlier the hoster wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast implementation of incremental backup on Amazon S3</h1><div class="post__text post__text-html js-mediator-article">  After moving my website from a shared hosting to a virtual server in the cloud, the question of data archiving came up close: if earlier the hoster was worried about the daily backup, now these worries are completely on the administrator‚Äôs shoulders.  Since storing large archives on your server is not only unsafe, but also (sometimes) expensive, it was decided to copy the bulk of the files to the Amazon S3 service.  Under a cat my method of implementation of an incremental backup is described.  The method is quite Nubovsky, but those who wish to repeat it will easily find ways to fine-tune to suit their needs. <br><a name="habracut"></a><br><h4>  First, we define tasks </h4><br>  We need: <br>  1. To do daily archives of web servers (catalogs of sites and databases).  It is necessary to keep archives for the last month. <br>  2. Make incremental archives - to save disk space.  Make a complete archive weekly, then 6 archives of modified files, then repeat the cycle. <br>  3. Store copies of archives on a third-party server (Amazon S3).  On the local server we will keep the archive for a week, the remaining archives will be present only on the server. <br>  My server runs under Debian OS, for other operating systems, you may need to make appropriate corrections to the installation commands and file paths. <br><br><h4>  Required components </h4><br>  <a href="https://labs.riseup.net/code/projects/backupninja">backupninja</a> : the program serves as a convenient wrapper for other utilities, allows you to centrally manage the backup process. <br>  Installation: apt-get install backupninja <br><br>  <a href="http://duplicity.nongnu.org/index.html">duplicity</a> : utility for creating incremental backups.  Able to work with remote servers. <br>  Installation: apt-get install duplicity 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://code.google.com/p/boto/">boto</a> : API for working with Amazon Web Services.  Duplicity is used to archive directly to AWS S3 service. <br>  Installation: apt-get install python-boto <br><br>  <a href="http://s3tools.org/s3cmd">s3cmd</a> : command line utility for working with Amazon S3. <br>  Installation: apt-get install s3cmd <br><br><h4>  Implementation </h4><br>  You need to start by registering with AWS.  The process does not present any difficulties, <a href="https://habrahabr.ru/users/maxout/" class="user_link">maxout is</a> well described in the topic <a href="http://habrahabr.ru/blogs/sysadm/90244/">Fast backup implementation in Amazon S3</a> .  In Urjupinsk, the registration went off with a bang with a card of the local branch of the Sberbank, which means there will be no problems in other cities and villages. <br><br>  Next, configure the backupninja.  The main configuration file of the program is /etc/backupninja.conf All options in the file are obvious, it makes no sense to bring them here.  In the simplest case, there is even no need to change anything, except to adjust the logging level (from fatal errors to debug information) and the composition of the task report sent to the admin mail. <br><br>  Settings for each individual job are stored by backupninja in separate files in the /etc/backup.d directory (by default).  The file name is preceded by a numeric prefix that specifies the order in which the task is executed.  Tasks in files without prefix and with prefix 0 will not be executed.  Tasks in files with the same prefix will be executed in parallel, each task with a prefix greater than the previous one will be executed after the completion of tasks with a smaller prefix.  In this way, we can, by setting the file prefix, control the sequence in which tasks are performed. <br><br>  In addition to the prefix, task files must have an extension corresponding to the type of task. <br><br>  Backupninja has a shell for configuring and testing ninjahelper task configurations.  It seems to me that it is more convenient to create and modify tasks in a text editor, and to test them from a shell. <br><br>  So, the database backup job configuration file.  I archive the database in two steps: first I make dumps of all databases, then I make incremental archives from the dumps.  Step one, file 20-all.mysql (I copied the blanks of files from / usr / share / docs / backupninja / examples and made the necessary changes to them) <br><blockquote><pre>  ### backupninja MySQL config file ###

 # hotcopy = &lt;yes |  no&gt; (default = no)
 # make a backup of the actual database binary files using mysqlhotcopy.
 hotcopy = no

 # sqldump = &lt;yes |  no&gt; (default = no)
 # make a backup using mysqldump.  this creates text files with sql commands
 # sufficient to recontruct the database.
 #
 sqldump = yes

 # sqldumpoptions = &lt;options&gt;
 # (default = --lock-tables --complete-insert --add-drop-table --quick --quote-na
 # arguments to pass to mysqldump
 # sqldumpoptions = --add-drop-table --quick --quote-names

 # compress = &lt;yes |  no&gt; (default = yes)
 # if yes, compress the sqldump output.
 compress = yes

 # dbhost = &lt;host&gt; (default = localhost)

 # backupdir = &lt;dir&gt; (default: / var / backups / mysql)
 # where to dump the backups.  hotcopy backups will be in a subdirectory
 # 'hotcopy' and sqldump backups will be in a subdirectory 'sqldump'
 backupdir = / home / backups / mysql

 # databases = &lt;all |  db1 db2 db3&gt; (default = all)
 # which databases to backup.  should either be the word 'all' or a
 # space separated list of database names.
 databases = all

 user = root </pre></blockquote><br>  In the configuration I indicated that: <br>  - it is necessary to do a dump using mysqldump; <br>  - dump must be compressed; <br>  - save compressed files in the directory / home / backups / mysql <br>  - it is necessary to backup all databases <br><br>  After the task is completed, files with database names compressed with gzip will appear in the / home / backups / mysql directory. <br><br>  The next task we do is an incremental database archive using duplicity, the 30-databases.dup file (I will only list the options I have changed; you need to copy the configuration file completely from /usr/share/docs/backupninja/examples/example.dup and make changes to it, otherwise the task will not be completed) <br><blockquote><pre>  ## additional options for duplicity
 ## I do not encrypt the archive, I increase the size of the volume to 512 megabytes, 
 ## I set the path and name for duplicity cache
 options = --no-encryption --volsize 512 --archive-dir / home / backups / duplicity --name vds1.databases

 ## temporary directory.  note that backupninja requires on disk 
 ## free space not less than the size of the volume
 tmpdir = / home / backups / tmp

 [source]
 ## what is included in the backup.  multiple sources can be set, one per line
 include = / home / backups / mysql / sqldump

 ## if you need to exclude something from the archive, specify here
 #exclude = /www/urup.ru/sxd/backup

 [dest]
 ## incremental backup (this is the default)
 incremental = yes

 ## How many days to do incremental backups before making a full backup again
 increments = 7

 ## How many days to store backups.  We store archives on the local server for the last 7 days.
 keep = 7

 ## Where to add backups.  duplicity can save on different services,
 ## including directly on AWS, but we need to store some of the archives for
 ## local disk, so we‚Äôll copy files to Amazon 
 ## in a separate assignment
 desturl = file: /// home / backups / mysql </pre></blockquote><br>  Once again, I‚Äôm noting that I only listed the modified lines of the configuration file.  In order for the task to work, you must copy the entire configuration from /usr/share/docs/backupninja/examples/example.dup and make the necessary changes in this file. <br><br>  Similarly, we do tasks for archiving web server directories.  Do not forget about the possibility to set several sources for inclusion in the archive and several for exclusion, one per line of configuration.  I archive each site in a separate task, I archive each archive into a separate directory with the site name in / home / backups / files / www / <br><br>  When creating archives, if this is important to you, you can encrypt files using GnuPG.  In this case it is necessary to remove the option - no-encryption. <br><br>  The last task will copy the created archive files to the AWS S3 server.  The file is called 50-upload.sh and is a regular shell script: <br><blockquote><pre>  #! / bin / sh

 # we synchronize local copies of archives with copies on Amazon
 s3cmd sync \
  --bucket-location = EU \
  --exclude 'sqldump / *' \
  / home / backups / files \
  / home / backups / mysql \
  s3: //vds1.backup

 # delete archives older than 30 days on Amazon
 duplicity --no-encryption --s3-use-new-style --archive-dir / home / backups / duplicity --name vds1.databases.s3 --force remove-older-than 30D s3 + http: // vds1 .backup / mysql </pre></blockquote><br>  For duplicity to work correctly with Amazon services, you need to install and configure boto.  The setting is to specify the credentials in the /etc/boto.cfg file <br><blockquote><pre>  [Credentials]
 aws_access_key_id = *
 aws_secret_access_key = * </pre></blockquote><br><br><h4>  Recovery from archives </h4><br>  Get the archive information: <br><blockquote><pre>  duplicity --no-encryption --s3-use-new-style collection-status s3 + http: //vds1.backup/mysql </pre></blockquote><br><br>  Unpack the local archive: <br><blockquote><pre>  duplicity --no-encryption file: //// home / backups / mysql / home / backups / mysql / sqldump </pre></blockquote><br>  The first parameter is the URL of the archive, the second is the directory into which the files will be unpacked.  Existing files will not be overwritten unless the --force option is specified. <br><br>  Unpack the archive from the Amazon server: <br><blockquote><pre>  duplicity --no-encryption --s3-use-new-style s3 + http: //vds1.backup/mysql / home / backups / mysql / sqldump </pre></blockquote><br><br>  Extract one file from the archive. <br><blockquote><pre>  duplicity --no-encryption --file-to-restore home / backups / mysql / sqldump / mysql.sql.gz --force file: /// home / backups / mysql / home / backups / mysql / sqldump / mysql1. sql.gz </pre></blockquote><br>  The file to be unpacked is indicated by the --file-to-restore key along with the full relative path (without the leading slash).  The first parameter is the URL of the archive, the second is the full path to the file being unpacked.  If the file already exists, it will not be overwritten, unless the --force option is specified. </div><p>Source: <a href="https://habr.com/ru/post/128710/">https://habr.com/ru/post/128710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128704/index.html">Genetic algorithm. Just about the difficult</a></li>
<li><a href="../128705/index.html">Jquery-ui inside a binary</a></li>
<li><a href="../128706/index.html">Using synonyms in SEO: bundles, holes, underpages</a></li>
<li><a href="../128707/index.html">Console application PassKeep</a></li>
<li><a href="../128709/index.html">Another implementation of the field "city" for Django</a></li>
<li><a href="../128711/index.html">Immersion into the scripts of the Unity3d game engine, part 1</a></li>
<li><a href="../128712/index.html">First results</a></li>
<li><a href="../128713/index.html">Attention! Competition! Win a Tech ‚àô Ed Russia 2011 Ticket!</a></li>
<li><a href="../128715/index.html">Google Wallet will start today - tomorrow</a></li>
<li><a href="../128716/index.html">Book's advantage over a blog or improve your blog.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>