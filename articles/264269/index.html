<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your cloud hosting in 5 minutes. Part 3: Consul, Registrator, Consul-Template</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! I continue the series of articles on how to build your cloud hosting in 5 minutes. In the last article we looked at tools that will help us s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your cloud hosting in 5 minutes. Part 3: Consul, Registrator, Consul-Template</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/264269/"><img src="https://habrastorage.org/files/57f/c1f/9a2/57fc1f9a2dd440f8b98d7991c516aa1a.png" alt="Docker friends"></a> <br><br>  Hi Habr!  I continue the series of articles on how to build your cloud hosting in 5 minutes.  In the <a href="http://habrahabr.ru/post/262397/">last article</a> we looked at tools that will help us solve the problem of service discovery.  In this part, we will begin to practice, build a cloud and see how these tools behave in real life. <br><br>  As before, all the work can be done by a regular programmer for 5 minutes, simply by running a set of scripts for <i>Ansible</i> , which I prepared especially for you and <a href="https://github.com/vkozlovski/ansible-cloud-hosting">uploaded to GitHub</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Despite the fact that our cloud has become more complicated and now it uses a larger number of tools, it has become easier to build it.  I completely rewrote a set of scenarios from past articles, deleted everything superfluous, simplified the rest as much as possible. <br><a name="habracut"></a><br><h4>  <font color="#d62631">Content</font> </h4><br><ul><li>  Part 0: <a href="https://habrahabr.ru/post/277657/">Virtualization</a> </li><li>  Part 1: <a href="https://habrahabr.ru/post/261415/">Ansible, Docker, Docker Swarm</a> </li><li>  Part 2: <a href="http://habrahabr.ru/post/262397/">Service Discovery</a> </li><li>  Part 3: Consul, Registrator, Consul-Template </li><li>  ... </li></ul><br><h1>  <font color="#d62631">Getting started</font> </h1><br>  You must have <i><a href="http://www.ansible.com/">Ansible</a></i> and <i><a href="https://www.docker.com/">Docker</a></i> installed on your client machine.  There should be 3 servers with authorization by key and <i>Debian 8.1 x64</i> on board ( <i>you can use any other distribution kit, making minor changes to the script</i> ). <br><br>  Download a <a href="">set of scripts</a> or clone the repository: <br><br><pre><code class="bash hljs">¬ª git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vkozlovski/ansible-cloud-hosting ¬ª <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ansible-cloud-hosting ¬ª git checkout v2.x</code> </pre> <br><h4>  <font color="#d62631">IP addresses</font> </h4><br>  We open the <b>stage</b> file and replace the IP addresses with the IP of our servers in it: <br><br><pre> <code class="markdown hljs">[dc1-cloud] 192.168.1.1 192.168.1.2 192.168.1.3</code> </pre><br>  If you want to build a cloud in several data centers, then simply add additional groups with the appropriate IP addresses ( <i>by analogy with how this has already been done</i> ): <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="markdown hljs">[dc1-cloud] 192.168.1.1 192.168.1.2 192.168.1.3 [dc2-cloud] 192.168.2.1 192.168.2.2 192.168.2.3 #--- in all DC ---# # cloud in all DC [cloud:children] dc1-cloud dc2-cloud #--- everything in DC ---# [dc1:children] dc1-cloud [dc2:children] dc2-cloud</code> </pre><br></div></div><br><h4>  <font color="#d62631">Certification Authority</font> </h4><br>  Now we need to generate keys for our certificate authority, which will sign certificates of <i>Docker</i> 'a clients and servers (for <i>more details, see the <a href="http://habrahabr.ru/post/261415/">first article</a></i> ).  To do this, I created a small assistant, so from the root directory of the project we execute the command: <br><br><pre> <code class="bash hljs">¬ª make gen-ca</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="bash hljs">Generating RSA private key, 4096 bit long modulus ...++ ................++ e is 65537 (0x10001) Enter pass phrase <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> certs/ca/ca-key.pem: Verifying - Enter pass phrase <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> certs/ca/ca-key.pem: Enter pass phrase <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> certs/ca/ca-key.pem: You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter <span class="hljs-string"><span class="hljs-string">'.'</span></span>, the field will be left blank. ----- Country Name (2 letter code) [AU]:US State or Province Name (full name) [Some-State]:California Locality Name (eg, city) []:Cupertino Organization Name (eg, company) [Internet Widgits Pty Ltd]:Ansible Cloud Hosting Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:example.com Email Address []:postmaster@example.com</code> </pre><br></div></div><br>  We answer questions ( <i>there are no specific requirements, you can specify any domain</i> ) and remember the password.  The password must be assigned to the variable <b>certs_ca_password</b> in the file <b>group_vars / all.yml</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Result group_vars / all.yml</b> <div class="spoiler_text"><pre> <code class="markdown hljs">--- common_packages: - sudo - htop - mc - git - apt-transport-https - python-setuptools # easy_install (necessary for install python pip) debian_release: jessie certs_ca_password: '1234' # ;)</code> </pre><br></div></div><br><h4>  <font color="#d62631">Certificates</font> </h4><br>  In this step, you need to generate certificates for <i><a href="https://consul.io/">Consul</a></i> .  To do this, I also created a small assistant, so from the root directory of the project we simply execute the command: <br><br><pre> <code class="bash hljs">¬ª make gen-consul-certs</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="bash hljs">Generating a 2048 bit RSA private key ..........................+++ .................................................+++ writing new private key to <span class="hljs-string"><span class="hljs-string">'privkey.pem'</span></span> ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter <span class="hljs-string"><span class="hljs-string">'.'</span></span>, the field will be left blank. ----- Country Name (2 letter code) [AU]:US State or Province Name (full name) [Some-State]:California Locality Name (eg, city) []:Cupertino Organization Name (eg, company) [Internet Widgits Pty Ltd]:Ansible Cloud Hosting Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:example.com Email Address []:postmaster@example.com Generating a 1024 bit RSA private key ...........................++++++ ..............++++++ writing new private key to <span class="hljs-string"><span class="hljs-string">'consul.key'</span></span> ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter <span class="hljs-string"><span class="hljs-string">'.'</span></span>, the field will be left blank. ----- Country Name (2 letter code) [AU]:US State or Province Name (full name) [Some-State]:California Locality Name (eg, city) []:Cupertino Organization Name (eg, company) [Internet Widgits Pty Ltd]:Ansible Cloud Hosting Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:example.com Email Address []:postmaster@example.com Please enter the following <span class="hljs-string"><span class="hljs-string">'extra'</span></span> attributes to be sent with your certificate request A challenge password []: An optional company name []: Using configuration from myca.conf Check that the request matches the signature Signature ok The Subject<span class="hljs-string"><span class="hljs-string">'s Distinguished Name is as follows countryName :PRINTABLE:'</span></span>US<span class="hljs-string"><span class="hljs-string">' stateOrProvinceName :PRINTABLE:'</span></span>California<span class="hljs-string"><span class="hljs-string">' localityName :PRINTABLE:'</span></span>Cupertino<span class="hljs-string"><span class="hljs-string">' organizationName :PRINTABLE:'</span></span>Ansible Cloud Hosting<span class="hljs-string"><span class="hljs-string">' commonName :PRINTABLE:'</span></span>example.com<span class="hljs-string"><span class="hljs-string">' emailAddress :IA5STRING:'</span></span>postmaster@example.com<span class="hljs-string"><span class="hljs-string">' Certificate is to be certified until Nov 22 16:25:08 2025 GMT (3650 days) Write out database with 1 new entries Data Base Updated ------------------------------------------------------------</span></span></code> </pre><br></div></div><br>  If you want to learn more about what exactly is happening at this step, you can read a <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-consul-with-tls-encryption-on-ubuntu-14-04">great article</a> on <i>DigitalOcean</i> . <br><br><h4>  <font color="#d62631">The secret key</font> </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/a2a/394/a80/a2a394a80b02104d3433a3a63470a603.png" alt="image"><br>  Now we need to generate a secret key that <i><a href="https://consul.io/">Consul</a></i> will use to encrypt its network traffic.  To do this, run the command: <br><br><pre> <code class="bash hljs">¬ª docker run --rm --entrypoint <span class="hljs-string"><span class="hljs-string">"/bin/consul"</span></span> progrium/consul:latest keygen L+3UkrkFeXHQBT97nTZI/g==</code> </pre><br>  The key must be assigned to the <b>docker_consul_encrypt</b> variable in the <b>group_vars / cloud.yml file</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Result group_vars / cloud.yml</b> <div class="spoiler_text"><pre> <code class="markdown hljs">--- # docker docker_api_version: 1.18 docker_key_server: "hkp://pgp.mit.edu:80" docker_key_id: "58118E89F3A912897C070ADBF76221572C52609D" # docker-consul docker_consul_encrypt: 'L+3UkrkFeXHQBT97nTZI/g==' docker_consul_start_join_wan: - "{{ hostvars[groups['dc1'][0]]['ansible_eth0']['ipv4']['address'] }}" # first host in DC1</code> </pre><br></div></div><br><h4>  <font color="#d62631">Settings for data center</font> </h4><br>  The <b>dc1.yml</b> file in the <b>group_vars</b> directory contains a configuration specific to a particular data center.  If you have more than one, you can create <b>dc2.yml</b> , <b>dc3.yml</b> , <b>...</b> and fill them in by analogy. <br><br><pre> <code class="markdown hljs">--- # docker-consul # first host in "my_name_dc" DC docker_consul_join: '{{ hostvars[groups["my_name_dc"][0]]["ansible_eth0"]["ipv4"]["address"] }}' docker_consul_dc: 'dc1' # docker-swarm-manager # first host in "my_name_dc" DC docker_swarm_manager_ip: '{{ hostvars[groups["my_name_dc"][0]]["ansible_eth0"]["ipv4"]["address"] }}'</code> </pre><br><h5>  <font color="#d62631">Consul</font> </h5><br>  If you build a cloud in several data centers, then I have good news for you - <i><a href="https://consul.io/">Consul</a></i> supports this out of the box.  The only thing you need to do is add one IP from each data center to the <b>docker_consul_start_join_wan</b> variable: <br><br><div class="spoiler">  <b class="spoiler_title">Example group_vars / cloud.yml</b> <div class="spoiler_text"><pre> <code class="markdown hljs">--- # docker docker_api_version: 1.18 docker_key_server: "hkp://pgp.mit.edu:80" docker_key_id: "58118E89F3A912897C070ADBF76221572C52609D" # docker-consul docker_consul_encrypt: 'L+3UkrkFeXHQBT97nTZI/g==' docker_consul_start_join_wan: - "{{ hostvars[groups['dc1'][0]]['ansible_eth0']['ipv4']['address'] }}" # first host in DC1 - "{{ hostvars[groups['dc2'][0]]['ansible_eth0']['ipv4']['address'] }}" # first host in DC2 ...</code> </pre><br></div></div><br><h1>  <font color="#d62631">Run</font> </h1><br>  If you have reached this step - you will receive a reward.  We launch the assistant: <br><br><pre> <code class="bash hljs">¬ª make run</code> </pre><br>  Now you can "sit back and relax." <br><br><img src="https://habrastorage.org/files/219/974/091/219974091997475bb27c646b292f716c.png"><br><br>  Owners of stools - take care of yourself. <br><br>  After the magic is over, I recommend restarting all the machines. <br><br>  Done! <br><br><h2>  <font color="#d62631">Consul UI</font> </h2><br>  Open the browser and go to any of the IP addresses of our machines ( <i><a href="http://192.168.1.1:8500/">http://192.168.1.1:8500/</a></i> ).  If you set up multiple data centers, you should see a similar picture: <br><img width="600" src="https://habrastorage.org/files/ee3/54c/b24/ee354cb24f8f40b29b87a1386c9b98e3.png"><br>  If you have one data center or you selected it from the list above: <br><img src="https://habrastorage.org/files/8cf/c64/764/8cfc647643174e108176fb842509d131.png"><br>  <i>Consul</i> displays the list of services our cloud consists of.  Green shows ‚Äúhealthy‚Äù services, yellow shows problematic ones ( <i><a href="http://habrahabr.ru/post/262397/">in the last article</a> I mentioned that Consul <a href="https://consul.io/docs/agent/checks.html">can check the health of services</a></i> ). <br><br><h2>  <font color="#d62631">Docker swarm</font> </h2><br>  Let's check <i>Docker Swarm</i> ( <i>you can read more about it in the <a href="http://habrahabr.ru/post/261415/">first article</a></i> ).  <i>Docker Swarm Manager is</i> installed on the first IP address of each data center from the list in the <b>stage</b> file.  For example from the list: <br><br><pre> <code class="markdown hljs">[dc1-cloud] 192.168.1.1 192.168.1.2 192.168.1.3 [dc2-cloud] 192.168.2.1 192.168.2.2 192.168.2.3 #--- in all DC ---# # cloud in all DC [cloud:children] dc1-cloud dc2-cloud #--- everything in DC ---# [dc1:children] dc1-cloud [dc2:children] dc2-cloud</code> </pre><br>  these will be <i>192.168.1.1</i> and <i>192.168.2.1</i> . <br><br>  In order to connect to the <i>Docker Swarm Manager</i> you need to run: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://192.168.1.1:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem info</code> </pre><br>  You should see something similar: <br><br><pre> <code class="bash hljs">Containers: 13 Images: 12 Role: primary Strategy: spread Filters: health, port, dependency, affinity, constraint Nodes: 3 debian1: 192.168.1.1:2376 ‚îî Containers: 5 ‚îî Reserved CPUs: 0 / 1 ‚îî Reserved Memory: 0 B / 519.2 MiB ‚îî Labels: executiondriver=native-0.2, kernelversion=3.16.0-4-amd64, operatingsystem=Debian GNU/Linux 8 (jessie), storagedriver=aufs debian2: 192.168.1.2:2376 ‚îî Containers: 4 ‚îî Reserved CPUs: 0 / 1 ‚îî Reserved Memory: 0 B / 519.2 MiB ‚îî Labels: executiondriver=native-0.2, kernelversion=3.16.0-4-amd64, operatingsystem=Debian GNU/Linux 8 (jessie), storagedriver=aufs debian3: 192.168.1.3:2376 ‚îî Containers: 4 ‚îî Reserved CPUs: 0 / 1 ‚îî Reserved Memory: 0 B / 519.2 MiB ‚îî Labels: executiondriver=native-0.2, kernelversion=3.16.0-4-amd64, operatingsystem=Debian GNU/Linux 8 (jessie), storagedriver=aufs CPUs: 3 Total Memory: 1.521 GiB Name: debian1</code> </pre><br>  If this is so, and it should be that way, then all that remains is to congratulate you.  If you have any difficulties - welcome to the comments. <br><br><h1>  <font color="#d62631">We are testing</font> </h1><br>  It's time to launch something in our steep cloud.  And what could it be if not <i>Nginx</i> ?  That's it! <br><br>  Run: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://178.62.232.38:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -d -p 80:80 -p 443:443 -e <span class="hljs-string"><span class="hljs-string">"SERVICE_80_NAME=http"</span></span> -e <span class="hljs-string"><span class="hljs-string">"SERVICE_443_NAME=https"</span></span> nginx</code> </pre><br>  You can read more about the environment variables that we pass here <a href="http://habrahabr.ru/post/262397/">in the last article</a> . <br><br>  We look at what machine <i>Nginx</i> was running: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://192.168.1.1:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e96b351a857e nginx <span class="hljs-string"><span class="hljs-string">"nginx -g 'daemon off"</span></span> 3 minutes ago Up 3 minutes 192.168.1.2:80-&gt;80/tcp, 192.168.1.2:443-&gt;443/tcp debian2/fervent_dubinsky ...</code> </pre><br>  Open in the browser <a href="http://192.168.1.2/">http://192.168.1.2:80/</a> : <br><img width="600" src="https://habrastorage.org/files/fb2/5f0/64d/fb25f064d1794a25be9bd94f1fbf33bb.png"><br><br>  There is a contact.  Now let's see if our service appeared in the <i>Consul</i> panel: <br><img src="https://habrastorage.org/files/fdc/4cc/c55/fdc4ccc5529248539a854a75423f99a4.png"><br>  There were 2 services ( <i>by the number of ports</i> ): <i>http</i> and <i>https</i> ( <i>we passed their names in the variables SERVICE_80_NAME and SERVICE_443_NAME</i> ). <br><br><h2>  <font color="#d62631">DNS</font> </h2><br>  Let's now check the work of the <i>DNS</i> service, which <i>Consul</i> kindly provided us.  To do this, run a container with <i>Debian</i> on any machine: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://192.168.1.1:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -ti debian:testing /bin/bash root@2e68749354b2:/<span class="hljs-comment"><span class="hljs-comment">#</span></span></code> </pre><br>  See if our service is <i>http</i> : <br><br><pre> <code class="bash hljs">root@2e68749354b2:/<span class="hljs-comment"><span class="hljs-comment"># ping http PING http.service.consul (172.17.0.6): 56 data bytes 64 bytes from 172.17.0.6: icmp_seq=0 ttl=64 time=0.076 ms 64 bytes from 172.17.0.6: icmp_seq=1 ttl=64 time=0.118 ms 64 bytes from 172.17.0.6: icmp_seq=2 ttl=64 time=0.075 ms ^C--- http.service.consul ping statistics --- 3 packets transmitted, 3 packets received, 0% packet loss round-trip min/avg/max/stddev = 0.075/0.090/0.118/0.000 ms</span></span></code> </pre><br>  The full address of our service is <i>http.service.consul</i> , but we can also access via short <i>http</i> ( <i>because we started Docker with the --dns-search service.consul parameter</i> ).  We can also use the longer version of <i>http.service.dc1.consul</i> indicating the data center ( <i>if you want to reach a service from another data center, for example</i> ).  For more information about this, you can read <a href="https://consul.io/docs/agent/dns.html">in the official documentation</a> . <br><br>  Let's run a few more copies of <i>nginx</i> .  Open another tab in the console ( <i>we will need the container with Debian</i> ) and run the command 2 times: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://178.62.232.38:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -d -p 80:80 -p 443:443 -e <span class="hljs-string"><span class="hljs-string">"SERVICE_80_NAME=http"</span></span> -e <span class="hljs-string"><span class="hljs-string">"SERVICE_443_NAME=https"</span></span> nginx</code> </pre><br>  <i>Docker Swarm</i> is smart enough to run all 3 services on different machines (it <i>looks like there are free 80 and 443 ports</i> ).  And if you try to run more copies of <i>Nginx</i> than your machines, he will report this: <br><br><pre> <code class="bash hljs">Error response from daemon: unable to find a node with port 443 available</code> </pre><br>  Now back to the container with <i>Debian</i> and put the package: <br><br><pre> <code class="bash hljs">root@2e68749354b2:/<span class="hljs-comment"><span class="hljs-comment"># apt-get update &amp;&amp; apt-get install dnsutils --no-install-recommends</span></span></code> </pre><br>  Let's see whether new <i>http</i> services have appeared: <br><br><pre> <code class="bash hljs">root@866f410a5f18:/<span class="hljs-comment"><span class="hljs-comment"># dig http.service.dc1.consul. ANY ; &lt;&lt;&gt;&gt; DiG 9.9.5-12+b1-Debian &lt;&lt;&gt;&gt; http.service.dc1.consul. ANY ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 17731 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0 ;; QUESTION SECTION: ;http.service.dc1.consul. IN ANY ;; ANSWER SECTION: http.service.dc1.consul. 0 IN A 192.168.1.1 http.service.dc1.consul. 0 IN A 192.168.1.2 http.service.dc1.consul. 0 IN A 192.168.1.3 ;; Query time: 4 msec ;; SERVER: 172.17.0.1#53(172.17.0.1) ;; WHEN: Thu Nov 26 10:22:41 UTC 2015 ;; MSG SIZE rcvd: 158</span></span></code> </pre><br>  Everything is working. <br><br>  If you access your service by the name <i>http</i> , then the load will be distributed according to the <i><a href="https://ru.wikipedia.org/wiki/Round-robin_%2528%25D0%25B0%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC%2529">Round-robin</a></i> algorithm.  If you now stop one of the containers with <i>Nginx</i> and rerun the above command, you will notice that it is no longer in the list. <br><br>  Thus, the load is distributed only between "live" services.  You also have the opportunity to take advantage of the health monitoring <a href="https://consul.io/docs/agent/checks.html">provided by</a> <i>Consul</i> , in which case you can distribute the load only between ‚Äúhealthy‚Äù services ( <i>do not confuse with just ‚Äúlive‚Äù</i> ). <br><br>  You can add and remove services dynamically and everything will continue to work without your intervention. <br><br><h1>  <font color="#d62631">Conclusion</font> </h1><br>  In this article, I wanted to tell you how to raise your personal cloud. <br><br>  If you were attentive, and I am sure that this is so, then you noticed that we did not use the <i>Consul-Template</i> .  I decided to open another part of my work for you and describe the process of automatic deployment of projects to our cloud in the next article.  It took some time to find a suitable option for this purpose and now it saves us a lot of time. <br><br>  What services ‚Äúfill‚Äù your cloud is up to you.  I worked on this configuration for a long time and did not encounter any problems. <br><br>  That's all.  Thank you all for your attention.  Stable clouds and good luck to you! <br><br>  <a href="https://twitter.com/vkozlovski">Follow me on Twitter</a> , I talk about working in a startup, my mistakes and the right decisions, about python and everything related to web development. <br><br>  PS <i>I'm looking for developers to the company, the details in my <a href="http://habrahabr.ru/users/vladkozlovski/">profile</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/264269/">https://habr.com/ru/post/264269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264255/index.html">Best practices from Google to develop Android applications</a></li>
<li><a href="../264257/index.html">How site developers create the future of TV</a></li>
<li><a href="../264259/index.html">Banana Pi: via U-Boot to Arch Linux</a></li>
<li><a href="../264261/index.html">Research gaming settings</a></li>
<li><a href="../264263/index.html">Accelerate the launch of BeagleBone or runit not for dummies</a></li>
<li><a href="../264271/index.html">Preparing ASP.NET5, issue number 2 - repeat the basics for the most beginners</a></li>
<li><a href="../264273/index.html">ESET & Intel Security on Black Hat USA 2015</a></li>
<li><a href="../264275/index.html">SIP registration, trunk, softphone and other scary words of cloud PBX</a></li>
<li><a href="../264277/index.html">HP is the leader of the Gartner Magic Quadrant for modular servers</a></li>
<li><a href="../264279/index.html">API interface for free PBX and telephony</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>