<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DNS Amplification (DNS gain)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago I ran into a problem (and its solution), given the relevance of this topic lately, as well as how many people are suffering from this ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DNS Amplification (DNS gain)</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago I ran into a problem (and its solution), given the relevance of this topic lately, as well as how many people are suffering from this trouble, decided to combine the information into one article.  Maybe someone else will find it useful. <br><img src="https://habrastorage.org/getpro/habr/post_images/52e/a5d/262/52ea5d262f0f5f9d033090a606c62f9a.gif" alt="image"><br><h4>  Start </h4><br><br>  A couple of weeks ago, I noticed a strange activity directed to my DNS server.  At once I will say that I use the gateway on Linux, respectively, the bind DNS server is installed there.  The activity was that on port 53 (DNS) of my server I had several UDP packets per second from different IP addresses: <br><br>  10: 41: 42.163334 IP 89.149.221.182.52264&gt; MY_IP.53: 22912+ NS ?.  (17) <br>  10: 41: 42.163807 IP MY_IP.53&gt; 89.149.221.182.52264: 22912 Refused- 0/0/0 (17) <br><a name="habracut"></a><br>  To which, as can be seen from the log, the server responded with failures.  Naturally it became interesting to me that for IP addresses they dig my DNS.  After looking at several addresses through whois, I determined that these are large hosting companies, I wrote a request to stop the attack on my server in technical support for some of them.  In response, I received a formal reply that this type of attack relates to the fact that they cannot block, and that they themselves suffer from this abnormal activity.  It was decided to deal with everything myself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  DNS Amplification (DNS gain).  Theory </h4><br>  The type of attack itself is not new - it was known about it back in 2006, <a href="http://www.securiteam.com/securityreviews/5GP0L00I0W.html">details in English can be found here</a> , however, it began to be actively used relatively recently.  In January-February 2009, several online publications published information about the large-scale use of this type of DDOS by cybercriminals, which can be found <a href="http://www.securitylab.ru/news/367776.php">here</a> and in English <a href="http://www.securecomputing.net.au/News/136355,new-style-of-dns-amplification-can-yield-powerful-ddos-attacks.aspx">here.</a> <br>  Explaining in simple terms, the essence of the gain is that the attacker sends a (usually short) request to a vulnerable DNS server that responds to the request with a packet that is significantly larger in size.  If you use the address of the victim‚Äôs computer (ip spoofing) as the source IP address, then the vulnerable DNS server will send a large number of unnecessary packets to the victim computer until it is completely paralyzed. <br><br><h4>  Practice </h4><br>  This type of attack is most effective on an old (unpatched) or incorrectly configured DNS server, which, as already mentioned, responds to short requests by attackers with large packets. <br>  Here is an example of such an interaction (by the way, such requests are most often used by attackers): <br>  Send an NS request to the server with the command <br> <b><code>#dig @SERVER_IP NS</code></b> <br>  where SERVER_IP is the IP address of the server.  As a result, in the log on port 53 of the server we get: <br>  11: 08: 47.994604 IP MY_IP.47816&gt; SERVER_IP.53: 5655+ NS ?.  (17) <br>  those.  just those 17 bytes of the request that we wanted to send. <br>  In the answer in the same log we see: <br>  11: 08: 47.995853 IP 192.168.100.254.53&gt; 192.168.100.100.47816: 5655 13/0/6 NS C.ROOT-SERVERS.NET., [| Domain] <br>  those.  the server responded with a hint in the form of the addresses of the root DNS servers, which is already 360 bytes.  These are the lengths of the DNS request and response, the total length of the packets is 60 and 402 bytes, respectively.  The gain is evident. <br><br><h4>  What to do? </h4><br>  First, of course, check the relevance of the version of your DNS server, regardless of which platform it is running.  Secondly, make sure that the server is configured securely enough and does not respond to "left" requests to everyone.  You can find many manuals and recommendations on the network; I <a href="http://www.cymru.com/Documents/secure-bind-template.html">will mention here only one document that I found not so long ago</a> . <br><br><h4>  What else can you do? </h4><br>  In my case, there was nothing special to do.  If you look at the very first log I gave, you can see that the attacker sends a request 17 bytes long and receives a REJECT of the same length (17 bytes), i.e.  no gain occurs.  But, apparently, ‚Äúddos-ery‚Äù especially not in a hurry to remove from their lists the addresses of DNS servers that are not affected by this vulnerability, and continue to bother them with their swotting ... This situation did not suit me.  It is unpleasant that someone receives unnecessary traffic to my server from my address (even though I am not guilty of this). <br>  At first, I began to put sender addresses on a black list, but that was not the case, the attack from the old addresses ceased, but more and more new ones appeared.  It was decided to use more sophisticated filtering methods and use iptables modules on my Linux server, which I had never reached before.  Kill two birds with one stone, so to speak, and an attacker to make -1 and deal with a pair of iptables modules. <br><br><h4>  String module </h4><br>  Of course, I could not close port 53 (DNS) completely - I have many clients who need it.  I decided to filter packets by the contents of DNS queries and remove those that contain the requests of the attackers, and they all contained ‚ÄúNS‚Äù as one.  For this task, the iptables string module is suitable, which just allows you to look into the contents of packages. <br>  In order to understand what to filter, let's look at the attacker's packet through wireshark. <br><img src="https://habrastorage.org/getpro/habr/post_images/1aa/9a1/1b0/1aa9a11b0277029c5d1c880ac998ab91.gif" alt="image"><br>  <a href="http://www.soslan.ru/tcp/tcp11.html">Here</a> and <a href="http://www.soslan.ru/tcp/tcp14.html">here</a> you can read about the structure of UDP packets and the DNS frame format, respectively.  For brevity, I will say that the first 14 bytes of a packet occupy data from the Ethernet protocol (in red), then there are 20 bytes of the IP protocol header (in blue), then 8 bytes - a UDP header (in green), after which DNS protocol data (in yellow).  The first 12 bytes of the DNS frame is occupied by the header, after which, finally, the DNS Query field begins (i.e., the query itself, in orange in Figure).  The packets sent by the attacker starting from the 54th (14 + 20 + 8 + 12) bytes contain the following data: 00 00 02 00 01 (in hexadecimal code), which corresponds to the ‚ÄúNS‚Äù query I mentioned earlier.  Thus, it is necessary to distinguish packets that, starting at 54 bytes, contain these bytes.  It will look like this: <br><br> <code>iptables -A INPUT --in-interface eth1 --protocol udp --dport 53 --match state --state NEW --match string --algo kmp --hex-string "|00 00 02 00 01|" --from 40 --to 45 --jump DROP <br></code> <br>  I will explain a little. <br>  --in-interface - indicates on which interface to catch packets.  You need to put only the external interface, which is attacked (there is no need to infringe on users within the network). <br>  --match state --state NEW - we only catch packets with the NEW state, so as not to check all transactions in a row, but only initiating packets (can it be sent to port 53). <br>  Next comes the most interesting - use the sting module.  We use the following parameters: <br>  - algo - indicates the search algorithm, in fact it does not matter, I specified kmp, but you can also specify bm; <br>  --hex-string - the same string in hexadecimal is written, which we are looking for; <br>  --from 40 - we are looking for starting from 40 bytes (note, not from 54 because the string starts the search, and accordingly, the countdown from the first byte of the IP protocol, that is, the Ethernet protocol is ejected, which is 14 bytes in length (in red in the figure above) A total of 54 - 14 = 40); <br>  --to 45 - search for up to 45 bytes of packet accordingly. <br><br><h4>  Module Recent </h4><br><br>  On this one could already stop.  Packages will no longer reach bind, but I haven‚Äôt been consoled by the idea that I have closed to ALL the opportunity to contact NS for my DNS server, so I decided to use another iptables module - recent. <br>  This module allows you to create dynamic tables of IP addresses depending on certain conditions, and then set allow and deny rules for these tables. <br>  Consider a simple example of using recent, consisting of two lines: <br><br> <code>iptables -A INPUT --protocol tcp --match state --state NEW --dport 22 --match recent --update --seconds 30 --name SSHT --jump DROP <br> iptables -A INPUT --protocol tcp --match state --state NEW --dport 22 --match recent --set --name SSHT --jump ACCEPT</code> <br>  Let's start to deal with the second rule.  Everyone who tries to log in (exactly log in because we use --state NEW) on port 22 (SSH) is skipped (--jump ACCEPT), but its IP address falls into a table named SSHT.  When they try to connect again from this address, the first rule begins to work, the meaning of which is to update (--update) an entry in the table and at the same time check when this entry was installed / updated last time.  If the record was installed / updated less than 30 seconds ago (--seconds 30), then - jump DROP is triggered and the packet is discarded.  Thus, brute forcers trying to hammer on the SSH port will be discarded if the frequency of sending their packets exceeds 1 packet in 30 seconds. <br>  Let's try to use recent for our needs: <br> <code>iptables -A INPUT --in-interface eth1 --protocol udp --dport 53 --match state --state NEW --match string --algo kmp --hex-string "|00 00 02 00 01|" --from 40 --to 45 --match recent --name DNST --update --seconds 600 --jump DROP <br> iptables -A INPUT --in-interface eth1 --protocol udp --dport 53 --match state --state NEW --match string --algo kmp --hex-string "|00 00 02 00 01|" --from 40 --to 45 --match recent --name DNST --set --jump ACCEPT <br></code> <br>  Thus, I allow to make NS requests for an external interface no more than once every 10 minutes. <br><br>  After adding these rules to the / proc / net / xt_recent of my server, a DNST file appeared in which the IP addresses of the attackers began to be written.  And the DNS server has ceased to give in to provocations: <br>  14: 10: 19.011818 IP 89.149.221.182.40320&gt; MY_IP.53: 23508+ NS ?.  (17) <br>  14: 10: 25.243499 IP 89.149.221.182.64984&gt; MY_IP.53: 25306+ NS ?.  (17) <br>  14: 11: 08.832827 IP 89.149.221.182.15864&gt; MY_IP.53: 48029+ NS ?.  (17) <br>  14: 11: 15.063058 IP 89.149.221.182.30959&gt; MY_IP.53: 64444+ NS ?.  (17) <br><br>  After a few days of working the rules, the number of packages by the attackers decreased several times.  Now I get 2-3 packets per minute, which are immediately discarded by the firewall. <br><br>  <b>UPD: In the last block of code, hurried and wrote an error, already corrected, thanks for noticing</b> </div><p>Source: <a href="https://habr.com/ru/post/51574/">https://habr.com/ru/post/51574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51568/index.html">Should I write on Habr√© topics about creating music on a PC?</a></li>
<li><a href="../51569/index.html">How to estimate the time of work?</a></li>
<li><a href="../51570/index.html">Effective crisis management</a></li>
<li><a href="../51572/index.html">6 Linux Hard Disk Analysis Applications</a></li>
<li><a href="../51573/index.html">lifehack in sms notification of the arrival of funds on the card</a></li>
<li><a href="../51575/index.html">Psyho VS North Kingdom. Copyright Infringement.</a></li>
<li><a href="../51576/index.html">Caring for users from the point of view of Nokia</a></li>
<li><a href="../51577/index.html">What is the best way to visualize Banana Research?</a></li>
<li><a href="../51578/index.html">Do I need a file manager?</a></li>
<li><a href="../51579/index.html">Clara stole from Karl ... pictures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>