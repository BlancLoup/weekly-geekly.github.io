<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Confrontation" through the eyes of a defender: A story about PHDays CTF from a competitor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This year, the main hacker contest PHDays changed the format: we moved away from the usual CTF. Instead, the real battle of hackers and security men t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Confrontation" through the eyes of a defender: A story about PHDays CTF from a competitor</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/pt/blog/304638/"><img src="https://habrastorage.org/files/7ed/721/86a/7ed72186a1934479ae4033457b7b9229.png"></a> <br><br>  This year, the main hacker contest PHDays changed the format: we moved away from the usual CTF.  Instead, the real battle of hackers and security men took place on the forum.  This time three teams fought: ‚Äúhackers‚Äù, ‚Äúdefenders‚Äù and SOC (security operations centers).  The events at the competition ground were as close to reality as possible.  The teams had at their disposal an emulation of the city, in which there is a bank, a telecom operator, an office of a large holding, an electric power company and other facilities. <br><br>  Information security engineer of the telecom operator <a href="https://www.linkedin.com/in/andrey-dugin-5921796">Andrei Dugin</a> , who participated in the CityF on the defense side, <a href="http://aodugin.blogspot.ru/search/label/PHDays">described in detail</a> his course of the competition and his impressions in his blog.  With the permission of the author, we have collected all his publications in one habratopik. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Description </h4><br>  On May 17-18, 2016, at the Positive Hack Days conference in Moscow, the Capture The Flag (CTF) competition, characteristic of major events in practical information security, was held.  This year, the organizers modified the contest somewhat, giving it the format of ‚Äúconfrontation‚Äù of the forces of good and evil in a virtual city, as announced on the <a href="http://www.phdays.ru/program/ctf/">PHDays conference</a> website. <br><br>  Naturally, there were a lot of people willing to try their hand at the competition.  Participants were divided not into 2, but into 3 functional areas: <br><br><ul><li>  <b>Hackers</b> - naturally, their goal was to gain unauthorized access to protected resources. </li><li>  <b>Defenders</b> - as the name implies, the main task is to prevent hacking and / or quickly eliminate its causes and consequences. </li><li>  <b>SOC</b> - operational monitoring of suspicious information security events, notification of ‚Äúdefenders‚Äù, joint analysis and response to incidents. </li></ul><br>  Since I participated in this competition as a member of the team of "defenders" of the infrastructure of the telecommunications operator, I will continue to talk about the event through the eyes of an information security engineer. <br><br>  Advocates and SOC work in tandem, protecting their services.  Our tandem was really very productive, as is customary in Russia :) <br><br>  According to the results of the two days of ‚Äúconfrontation‚Äù, I will briefly say that we as partners in SOC got a team of professionals from <a href="http://solarsecurity.ru/products/jsoc/">JSOC</a> , with whom we understood each other perfectly (not advertising for the sake of, but a statement of fact for).  So tightly, as with JSOC in this competition, we did not always work even with ‚Äúrelated‚Äù divisions in our company.  It sounds pathetic, but it's true, you can't throw out the words from the song. <br><br><img src="https://habrastorage.org/files/0da/85a/968/0da85a968c644e089efb2eebc0987c27.png"><br><br>  <i>The team of telecom-defenders "You Shall Not Pass" from large telecom operators and Solar JSOC, the team "False Positive"</i> <br><br>  Hackers, of course, in the competition work separately from their opponents (so that there is no fight), trying to gain unauthorized access to the protected resources. <br><br>  It turned out quite interesting, but the details of the competition later.  In many cases I try to understand the original reason for any transformation in the direction of complication.  It is logical that the conference should keep up with global trends, but then, perhaps, on a wave of impressions from participating in the competition, I would say that Positive Technologies seems to have even gone half a step ahead (deflection counted?) - for how long?  (deflection compensation to maintain neutrality). <br><br>  So, there are several obvious reasons, some of which are the result of others. <br><br>  1. To draw the attention of the state and business to: <br><br><ul><li>  the need to protect the Internet of Things and other critical infrastructure management systems that are connected to public networks. </li><li>  the need to comply with information security measures when working with banking systems; </li><li>  financial effect of hacking banking systems; </li><li>  possible implications for organizations whose information security develops on the residual principle. </li></ul><br>  2. To give specialists a sense of what work is like with the constant threat of infrastructure being hacked in some approximation to reality (why some will discuss this later). <br><br>  3. Make the event scale. <br><br>  4. Market promotion: <br><br><ul><li>  information security products and services; </li><li>  testing and popularization among the IS services of such a service as the SOC (Security Operation Center). </li></ul><br>  Which of the above is the root cause, and what the consequence is, I think, obviously. <br>  I do not pretend to the fullness and breadth of the analysis, because I described my viewing angle earlier. <br><br><h4>  Training </h4><br>  So, our national team of telecom defenders, in tandem with JSOC, defended IP-based public services specific to the telecoms operator: personal account, portal, services for sending paid messages, other VAS, etc.  Of course, an integral part of our task was to ensure the security of network equipment. <br><br>  Regarding the team: we had to work with competing colleagues with whom we had not known before, and I, when I only found out about it, thought that at first we, as in Avengers, would re-educate ourselves with each other, determining who cooler, and then we start the business to do.  Fortunately, I was wrong, and the reason is simple: we didn‚Äôt have time for that.  The unspoken principle was this: if you are cool - beautiful, well done, we believe in you, recognize your talent and do not dispute, WORK!  And I just reviewed the militants. <br><br>  In the ‚Äúvirtual city‚Äù where the events described above took place, there were 5 infrastructure facilities for which the struggle was fought: <br><br><ul><li>  city ‚Äã‚Äãoffice; </li><li>  bank 1; </li><li>  bank 2; </li><li>  energy company; </li><li>  telecommunication network. </li></ul><br>  Naturally, without normal technical support, neither the city would work, nor the means of protection.  For the operational monitoring of information security events, the prevention and repulsing of hacker attacks, the organizers provided us with: <br><br><ul><li>  remote access for pre-tuning prior to the start of the competition; </li><li>  jobs on the face-to-face phase of the competition; </li><li>  user statistics; </li><li>  network map; </li><li>  network and server infrastructure; </li><li>  admin login passwords for already prepared elements (network, server); </li><li>  computing power for deploying information security systems and operational monitoring; </li><li>  complete freedom to choose remedies; </li><li>  Assistance in obtaining test temporary licenses from manufacturers of commercial information security tools. </li></ul><br>  Of course, we got a remote access to our segment a bit in advance, for the commissioning and adjustment of the information security systems we need.  Otherwise, they would not have time to do anything properly.  It is a pity, of course, that some of this time fell on Easter and May.  Confronting opposition, and potatoes require integration into the soil, and also in a short time.  Each set priorities in its own way. <br><br>  Special thanks to our colleague <a href="http://catsvill-lab.blogspot.ru/">Gennady Shastin</a> , who, in fact, gathered the whole team and competently kicked everyone with the necessary strength and intensity of the necessary organs to the point of no return.  I used to know him as just a good qualified specialist, and then also the organizational skills showed up.  Gena, you, in fact, alone with the pusher started a locomotive, our team is unrealistic to thank you. <br><br>  There were no working places for us, only ethernet for connecting laptops and power outlets.  But this is normal: we would only perplex the organizers to carry the PC back.  Behind the laptop to work more habitually.  Workplaces in the form of stationary PCs were available only to user statisticians who had to depict the activity of the average user: read mail, click malicious links, sit on social networks and complain that they pay very little.  Interact with users was prohibited. <br><br>  The network map contained only L3 information on subnets and their topological location.  What network is in - it was necessary to find out independently.  On the one hand - the complexity of the problem, on the other - an extra injection drive.  That is, to find and neutralize servers, we used ARP tables of L3-terminating devices and scanners, deployed infrastructure elements like vsus, etc., updated, reconfigured, integrated ... All this, including network equipment, was on virtualka.  At the setup meeting, Sergey Pavlov from Positive Technologies promised that there would be at least more computing power than he had on his home computer, and he did not seem to be deceived.  But this equipment sweated from the load notably, we were not shy about requesting the necessary virtual machines, and the hackers were launching a carriage of scans at the same time. <br><br>  On the means of protecting information: I believed at the beginning, when Gene just started kicking us that ‚ÄúPositives‚Äù as organizers would try to impose their products and solutions for their PR, but no, there was not only complete freedom to choose any means, but also active assistance in obtaining temporary licenses from any commercial suppliers.  This is also easily explained: driving the use of their products, the organizers would limit defenders, sharply turning the confrontation into public testing and would give space for accusations of advertising and maneuver on excuses in the case of resonant hacking.  Yes, I myself would try to write off some kind of tough defense in this case to the coupled decision that it is no secret.  Plus, if you impose for a real confrontation - if you teach, train fairly deeply and for free, and let me give you a golden support during the competition, losing your man-hours, which was clearly not part of the organizers' plans. <br><br>  And so: dear defenders and "juices", here's a sip of freedom for you, look, do not choke.  Everything will be fine - well, okay, if everything is not quite good, you can always say: "But if you had our MaxPatrol scanner or MaxPatrol SIEM ...", but you can not say, depending on the situation.  True, I have not heard yet that such a talk or even hinted. <br><br>  In general, the preparation for the competition went very well.  Of course, it‚Äôs not without some nuances like the interruption of infrastructure, when the network smokes bamboo because of the load on the hypervisor, but these are working moments that are quite normal for the first event of this scale.  This year the bumps were filled, now the next one with preparation will be simpler, more predictable, and consequently, there will be time for fantasy. <br><br><h4>  Opinion on the resonance hacking hydro </h4><br><blockquote>  <i>Fights without rules.</i>  <i>The duel between fighters Ork and the Goblin is organized.</i>  <i>The fighters are beginners, but the crowd is a trump and with money.</i>  <i>Influential fan of such fights, the official, the roof of the organizers, makes a very big bet on the fact that Goblin will win.</i>  <i>And here Orc delivers a good blow to the body, after which the Goblin "floats."</i>  <i>The judge, contrary to the rules, counts it as a blow to the groin, setting aside Orc with a penalty point and giving time to restore the Goblin.</i>  <i>In the process, he quickly whispers to Ork: ‚ÄúYou need to lie down.</i>  <i>Dad said. "</i>  <i>And Ork, knowing full well that even if he wins and takes the prize, in the future the career of a fighter in this organization is closed for him, he begins to think quickly, looking at the Goblin gradually coming to himself, how to substitute a ‚Äúknockout‚Äù strike so that it is plausible. and convincing for the viewer.</i> </blockquote><br>  The very next day after PHDays VI, the entire Internet was filled with <a href="http://www.3dnews.ru/933180">news</a> about how a schoolboy hacked into a power station and how hackers, after a successful hack, stopped a hydroelectric station and flooded the city. <br><br>  I participated in the "defenders" of the telecom, so the opinion is based on an analysis of the situation and analogies from my bell tower, but without knowing the details of the SCADA hacking. <br><br>  As I wrote in the <a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-1.html">first part of</a> my series of reviews about PHDays, one of the key objectives for the organizers was to draw the attention of the state and business to the need to protect the Internet of Things and other critical infrastructure management systems connected to public networks.  Although I did not work with SCADA protection myself, I see from public sources that when any device starts to be controlled via IP, and even more so via the Internet, few people pay attention to its security.  As always, technologies are developed first, and then their safety.  As a result, the ‚Äúinternet of holey things‚Äù is formed.  How it can be threatened depends on which device is accessed.  This can be conveyed to the public through news, and in order to attract a journalist, you need something that will be perceived as a sensation.  And how much more sensational than stopping the power station and flooding the city with hackers, who are perceived, as a maximum, by boys with the posture of a monkey behind a laptop, who can steal passwords? <br><br><img src="https://habrastorage.org/files/f65/cf1/a48/f65cf1a484304f12b65d576a40603355.png"><br><br>  <i>Image: <a href="http://xakep.ru/">Xakep.ru</a></i> <br><br>  There is a team of "defenders", who have ruined the control system.  There is SOC, which connected everything to event monitoring.  Details of the preparation are described in the <a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-2.html">second part of the</a> same name.  These are, as far as I know, commercial companies in the information security profile who, at this competition, probably would like to promote, and therefore will take the protection of industrial facilities seriously.  And then, in spite of all the described seriousness of the protection, the hydroelectric power station is broken 2 times ... Is it really that bad with the IS of the automated process control system in Russia? <br><br>  My options for what happened: <br><br><ol><li>  Defenders poorly defended: either normal means of protection SCADA does not exist in nature, or carelessly reacted to the defense; </li><li>  SOC overlooked: either it was poorly integrated with monitoring or clicked; </li><li>  Restrictions by the organizers on the means of protection; </li><li>  Dad said. </li></ol><br>  With the first two everything is clear.  If it‚Äôs really SOC and the defenders clicked, there‚Äôs the road.  But I have a suspicion that the restrictions imposed by the organizers implied the possibility of hacking of the hydropower station by hackers.  The stakes were made by the ‚Äúdad‚Äù that the hydropower stations would be shut off and the city flooded. <br><br>  In order not to be unsubstantiated with the statement about the restrictions on the part of the organizers, let me say as a member of the ‚Äúdefenders‚Äù team of the telecom: restrictions on the use of protection were, and quite strong.  Use any means of protection, but from the fundamental means we were forbidden even to close the firewall from the SSH / RDP world to the protected resources, only to the network equipment itself, not to mention other unused services.  Change passwords, update, patch, reconfig as much as you like, but the service should be available ... And I generally wanted to set a default deny, as is done in real life (details about the degree of proximity to real life later).  But I was not allowed by the organizers. <br><br>  And strategically it is right: otherwise there will be no show, hackers will whine, telling that this is all dishonest, that the organizers have given a tremendous advantage to defenders and juices.  There will be no injection of the necessary information in the media; the management of industrial enterprises will dismiss protection.  He sacrificed a pawn (SOC and defenders of SCADA) in this game, but received a strategic advantage for several years ahead (future orders from business and the state for security).  And most importantly, the world thought about how not to let the bad guys leave people without light and with an excessive excess of water in the city. <br><br><img src="https://habrastorage.org/files/228/854/269/228854269bc14910bd6c4693b73d60a2.png"><br><br>  <i>Image: <a href="http://xakep.ru/">Xakep.ru</a></i> <br><br>  If everything developed this way, then most of all I would not want the ‚Äúdefenders‚Äù and the SOC who defended SCADA to be accused of breaking into the hydroelectric power station and flooding the city. <br><br>  More attentive colleagues and representatives of the organizer corrected me, adding that the defenders of the hydropower plant had not really broken.  After the hacking, the defenders and the SOC very accurately described the hacking process (that is, they saw everything, but did not do it, because, after all, the show was necessary) and the hackers confirmed it.  It was possible to loosen the scud only after the defenders had weakened and then completely removed the defense.  On the morning of the second day, it turns out, it was announced publicly from the stage.  It seems that after a sleepless night I wasn‚Äôt really able to perceive what was being broadcast there. <br><br>  But, nevertheless, after a few days, I see information on the Internet not about the fact that they didn‚Äôt protect the hydroelectric power station, but that it was hacked.  And over time, this confused phrase will only make it clear that the hydroelectric station can be hacked.  Continuing the logic - which means it needs to be protected.  That is, the shadow of the good name of the ‚Äúdefenders‚Äù and the SOC, if it fell, will very quickly resolve.  Probably, PR specialists know their business better than the data protection engineer (there wasn‚Äôt enough to be the opposite). <br><br>  Here it is, the official <a href="http://www.phdays.ru/press/news/64206/">information</a> from the organizers: <br><br><blockquote>  <i>The forum clearly showed what happens with an unsecured critical infrastructure.</i>  <i>Information security specialists are able to provide a very high level of protection without disrupting the process - but they very rarely turn around like at PHDays.</i>  <i>After disabling the protective equipment, the attackers penetrated the technological network of the automated control system through the corporate network, attacked the physical equipment of the system, hacked the hydropower station, discharged water, and disconnected the power lines.</i> </blockquote><br><h4>  Restrictions </h4><br>  On the official conference site there is a rather pretentious quote: <br><br><blockquote>  <i>This time, instead of the usual CTF competitions, we are organizing real hostilities.</i>  <i>Events on the site will be <b>as close to reality as possible</b> : a large-scale emulation of urban infrastructure will unfold at the PHDays VI CityF test site.</i> </blockquote><br>  That's about the bold and would like to talk. <br><br>  In the means of protecting information, we were practically not limited: whichever you want, put it this way, just say the requirements for the virtual machine.  You need to kick a vendor for a temporary license - say, we will.  Well, we were not shy. <br><br>  <b>VMware</b> .  At the deployment stage, the limitation was voiced: the solutions we chose for the competition to provide and monitor IS should be virtualized.  Hardware could be taken only portable, for them the organizers were not responsible.  In general, this is not such a big problem, because the virtual machine is much easier to get from the vendor, and the global trend is striving for ubiquitous virtualization, even entire networks and data centers are virtualized, making all kinds of NFV, SDN and SDDC.  Some manufacturers managed to poke about the virtual team, and one even refused to provide it.  I was not ready for such a serious relationship with hacker attacks. <br><br>  <b>Default permit</b> .  On the other hand, it was forbidden to execute default deny on the edge firewall.  And in the real world this is done first.  This angered me deeply, I cried and cursed, but continued to participate in the competition.  As I wrote earlier, one of the main goals of the ‚Äúconfrontation‚Äù was a show that could not have happened, if I had forbidden everything that was superfluous.  Hackers would have poked at the secreted interfaces, would have done nothing, and would have cheated the organizers in indulging the light side of the force.  So here is an approximation to reality almost zero.  They gave hackers a head start over the most tomatoes.  Because of such odds and <a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-3.html">hydropower plants broke, and the city was flooded</a> . <br><br>  <b>No ban for IP address</b> .  It was also forbidden to ban on src IP.  Naturally, if this were simply forbidden by words, then I could ‚Äúforget it‚Äù, especially at night, so that I could sleep more easily and in general so that I could sleep.  But the cunning organizers put everyone in one IP: both hackers and their own service-checker.  If we extinguished the excess, they resorted to us and said that ay-ay-ay, so it is impossible.  Moreover, the services were checked at all any that were initially available on the servers, even not needed in FIG.  Shaw, cho. <br><br>  It also turned out to be a curiosity at the very beginning of the confrontation: SOC discovered that someone was scanning us from an IP address that is not listed on the provided scheme.  Having found the junction point, I blocked it, removing the unknown subnet from the routing, despite the ban.  The junction point was inside the trusted segment, so the logic is simple: there is no diagram - I consider the tab and the intrigues of the hackers to be squeezed out of our network.  Naturally, at first the organizers came running in with a shout: ‚ÄúEverything is lost!  Our all does not work! ".  Then they realized that they did not reassemble the joint with our segment, and agreed with my actions. <br><br>  <b>Access to equipment</b> .  Of course, we were given admin access to both network devices and servers.  After all, it is difficult to protect what you can not configure.  Perhaps, but difficult.  To the active network equipment <b>level L2-access</b> access is not given.  The reason is simple: the show.  When the organizers noticed despondency on hacker physiognomies and boredom on ours, they raised some more vulnerable service somewhere without warning.  Well, SOC with defenders, respectively, begin: ‚Äúcatch him, push him!‚Äù.  So that we did not interfere with unnecessary securitized settings and did not see too much, we were not given access to the switches, and we were not handed them as an object of protection. <br><br>  Like, I did not forget anything.  If I remember - I will add.  In general, the restrictions, although there were, but not fierce.  Of course, the default permit still stirs my disturbed outlook, which I occasionally continue to grumble in conversations with the organizers, but the show is a show.  It was wrestling, not MMA. <br><br><h4>  Battle </h4><br>  It is necessary to proceed to the description of the process of opposition - the battle, so to speak, which lasted 29 hours - from 11:00 on May 17, 2016 to 16:00 on May 18, 2016. <br><br>  Preliminary teams of protection and rapid response were carried out: <br><br><ul><li>  network research; </li><li>  infrastructure inventory; </li><li>  installation and presetting of necessary protective equipment; </li><li>  reconfiguration and patching of leaky servers; </li><li>  change passwords that you can at least remember. </li></ul><br>  Naturally, the first thing that was done shortly before the start was a performance check and an inventory of resources.  Immediately, some servers unknown to us were discovered, many of which, in fact, turned out to be rather leaky.  As I have repeatedly written, the organizers wanted the show, and without such tricks it would not be very fun. <br><br>  The network diagram (simplified, without a branch office) was approximately as follows: <br><br><img src="https://habrastorage.org/files/d09/ad6/bf6/d09ad6bf60644e009de1f656ea1854db.png"><br><br>  The Internet was pseudo-and not real, hackers got into it from a limited segment.  If the Internet were real, it would have been impossible to understand where the attack of the competitor was, and where there was an outsider hacker, and there was no guarantee that someone wouldn‚Äôt get pissed off and start DDoS. <br><br>  First of all, I decided to censor the perimeter, that is, hang an ACL on the Internet side that would allow the ports of the DMZ servers detected by the scan, except for the managers (SSH / TELNET / RDP / SNMP) and databases (MySQL, Oracle), and close the rest according to the principle of default deny.  Warned the organizers, and immediately received a refusal: no, all ports from the pseudo-Internet should be available.  I can describe my reaction in two words ‚Äúsurprised‚Äù and ‚Äúoutraged‚Äù, which are expressed in one word together. <br><br><img src="https://habrastorage.org/files/514/c16/5a6/514c165a63714a6fa2bded7bfe7fa952.png"><br><br>  Having said to the organizers everything that I think about the design that was originally worn out, that we are not allowed to properly protect the infrastructure, we are forced to turn our bare ass on the Internet, that this is all hackers giveaway, etc., we accepted the new rules of the game and started working : <br><br><ul><li>  patch leaky servers in the DMZ; </li><li>  hung ACL on servers in the Servers1 and Servers2 subnets, allowing access to them from the DMZ and admins (organizers); </li><li>  moved the security scanner, deployed initially in the DMZ, to the Defense_servers subnet - there wasn‚Äôt enough to get the scanner; </li><li>  to servers in the subnet Defense_servers denied access from anywhere. </li></ul><br>  As I mentioned in the <a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-1.html">first part</a> , <a href="http://solarsecurity.ru/products/jsoc/">JSOC</a> worked with us in tandem, which integrated the infrastructure with its SIEM and monitored suspicious activity.  It is worth paying tribute to the children, they not only took the infrastructure under any cap (processes, inputs, network activity) of the infrastructure, but also monitored it with extrasensory speed.  Initially, until we learned each other‚Äôs IP addresses, less than a minute after the action, we heard questions from them: ‚Äúwho came to the xxx server from the address yyy?‚Äù, ‚ÄúSshd changed on the server, what is that?‚Äù And so on ... Well, and answered them like: ‚Äúok, my own, it's me, I updated the leaky server‚Äù.  If they also monitor commercial clients, then applause, I recommend. <br><br>  Periodically, when the organizers felt sad and ended the story for the story on the stage, the hackers were sad, but we were bored, Misha Levin snapped his fingers and a leaky server appeared in the DMZ.     ,      ,    ,   , , ,   .          -,   - ,     . <br><br><img src="https://habrastorage.org/files/6ac/987/16f/6ac98716ff384491ba9e3c4cb9cae2df.png"><br><br>  ,    - ,      ,   ,  ,  :     ? :   -  ? ,             .   . <br><br>    ,      <a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-4.html"> </a> ,     ,    .       :        ‚Äî , .  , ,         ,     .  ,           ,   ACL  .   ‚Äî    ,        .      ,    .        ‚Äî          .    ,      . <br><br>      ,      ,          .   ,        .  ,  ,        ,     DMZ     .    ,   .      ,   PHP, OpenSSL  SSH. ,     ,    .    ,        ,   .  ,     .      SOC  ,   ,    .    ,  , ,    ,     - :   ,   . <br><br> PHP,   ,  5.3.&lt;&gt;  5.4.&lt;&gt;   2013-2014 .  ,        .     ,        . <br><br> SSH      CVE-2015-5600,          CPU.     .  ,           ,     .     OpenSSL.      ,   ,       ,   SSH            DMZ.           SSH  RDP,     DMZ  ,  Balabit SCB,   , ,          .    ,     ,     .  ,            ,         SSH. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that Balabit is used as a means of controlling control sessions, it can additionally act as an integration layer when managing poorly / partially / no integrated networks, at night from May 17 to 18, the key factor of its use was the invulnerability of the proxy zorp-ssh module to CVE-2015-5600. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the technical solution turned out to be quite tricky and the possibilities were much greater than just protection from the mentioned vulnerability, I will write a separate post about the resulting traffic control traffic. Gene called it the ‚Äúarchitecture of the engineer Dugin‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At night, as expected, scans were flooded, and on the second day, the uprising of cars began, when new leaky servers began to grow like mushrooms after rain. Misha Levin waved his sleeve - and all the trump cards spilled out into the DMZ subnet.</font></font><br><br>  , 18      . ,    ,        .   ,     -,    ,       ,   ¬´¬ª   .                   .   JSOC  5 ,    ,       IPS (        )   . <br><br>    , ,     ,      SOC.                SOC, , .      ,     .               .      . <br><br><img src="https://habrastorage.org/files/3bb/7bb/574/3bb7bb57410a490db0c41d10e6e22468.png"><br><br>  16:00  ,         ,   ,         .    ,         . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Access was only possible through the hypervisor, and while we were restoring it with the network organizer, it was time for all participants to rest, which we began to do with great pleasure. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Custom SSH Security Method </font></font></h4><br><blockquote> <i>‚Äî      ,     ?   . <br> ‚Äî ,  -.   ,          .       : ¬´  ?¬ª.      ‚Äî      ,     .       . <br> ‚Äî   .           -,  ,      ? <br> ‚Äî        ‚Äî ,     ,  . <br><br> ‚Äî     Positive Hack Days  Balabit ?    ? <br> ‚Äî   .        . <br> ‚Äî ,  .</i> </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These are two real conversations in preparation for PHDays. Until a certain point, I myself did not think that they would be so tightly interconnected. Naturally, after talking with the organizers, I thought that I should be surprised, I threatened. In the course of the competition, the mood vector slowly shifted from the initial desire in the direction of "concreted". But miraculously it turned out that in the end they merged. And this story will go. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I wrote in </font></font><a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-5.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and spoke on the PHDays scene, a rather interesting and non-standard solution turned out to protect the vulnerable Unix servers managed via SSH. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let me remind you, the architecture itself looked simplistic as follows: </font></font><br><br><img src="https://habrastorage.org/files/ef2/f93/5a9/ef2f935a9b7a4cdb9a524e0dca9a9371.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, as mentioned in </font></font><a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-4.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="http://aodugin.blogspot.com/2016/05/phdays-ctf-5.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 5</font></font></a> ,  ACL  firewall   default deny    .         DMZ     .      SSH. <br><br> ,     DMZ,      CVE-2015-5600,          CPU.   2  ‚Äî      : ¬´  ‚Äî   ¬ª.  ,     ,  ,    . SSH   . ,     ,      .  ,           ,     ‚Äî  .  ,  .  ‚Äî  . , ,       Open Source   Unix,          ,     3    . <br><br>      Balabit SCB, ,     ,         .        Balabit  ,       ,      SSH   . <br><br>      Balabit,   .   SSH zorp-ssh    CVE-2015-5600,     ,      MaxPatrol, .   ,     ,  SSH    DMZ ,       . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider the example of SSH, but in the same way you can do with RDP, and with Telnet, and with VNC, and with ICA (although a little sweat). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the idea implemented in the network diagram, hackers got to the servers from the DMZ via all protocols and ports, passing through the border firewall. </font></font><br><br><img src="https://habrastorage.org/files/5e5/2ea/716/5e52ea716f164c6a9770de5f2ca5fbce.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since CheckPoint was used as a border firewall, not the ACL on the router, standard NAT-type firewalls could be configured to its fullest extent. </font><font style="vertical-align: inherit;">As a firewall that protects the data center server - Cisco ASAv. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order not to confuse the network terminology and the implementation of the NAT of two different manufacturers, I will describe the vendor-independent concept applicable to the equipment of any manufacturers that support this technology. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To turn SSH traffic on Balabit, you can go in the following ways:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Dedicated ports for servers. </font></font></h5><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Highlight the port range on Balabit. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implement dynamic many-to-one NAT on Edge CheckPoint so that packets arriving from the pseudo-Internet in the direction of the DMZ servers on the SSH port are translated into a packet, where src ip is replaced with IP CheckPoint, dst ip - with IP Balabit, dst port - to the dedicated port for this server on Balabit. </font></font></li></ul><br><br><img src="https://habrastorage.org/files/893/6a8/4ab/8936a84ab19649b99f75883796350b77.png"><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Open access for these TCP sessions to the Firewall data center: </font></font></li></ul><br><img src="https://habrastorage.org/files/631/00b/ecb/63100becb752425e925073595808b828.png"><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configure proxy rules on Balabit with a return to the required server, port 22 (SSH): </font></font></li></ul><br><img src="https://habrastorage.org/files/d3d/876/f0e/d3d876f0ed664331a3a7d6fd0a0e0900.png"><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Allow the output of such packets from Balabit towards the DMZ on both firewalls: </font></font></li></ul><br><img src="https://habrastorage.org/files/a77/2ef/0d7/a772ef0d709b4d17bec44400eaddff33.png"><br><br>  Is done.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The SSH session is not functionally broken, other traffic is not affected, the conditions of the game are met. </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. Dedicated address pool. </font></font></h5><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Highlight a subnet in the data center of the same dimension as the DMZ. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Put Balabit interface to it, which accepts traffic. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configure routing. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configure Balabit with IP addresses on the same subnet. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implement static one-to-one NAT on the edge firewall: </font></font></li></ul><br><img src="https://habrastorage.org/files/36f/b58/937/36fb589371a14b8493026bfc242645ae.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can, of course, not hide the SRC IP for the CheckPoint address, but then it is necessary that the DMZ be built on gray addresses. </font><font style="vertical-align: inherit;">On the "confrontation" DMZ built on the "white" ...</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Allow inbound traffic to the firewall data center: </font></font></li></ul><br><img src="https://habrastorage.org/files/0ca/d9d/668/0cad9d668c614e8e99be8a2b4f83ad08.png"><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configure the proxying rules on Balabit: </font></font></li></ul><br><img src="https://habrastorage.org/files/37c/74a/a8b/37c74aa8bb3d4aa0bc107b8661aad1f6.png"><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and permission on both firewalls: </font></font></li></ul><br><img src="https://habrastorage.org/files/54c/981/d73/54c981d73d2141a08b072ac763e8ca1d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where Balabit_ip0 is the Balabit address configured on the interface as the main one, and not IP alias (Balabit_ip1 ... 4). </font><font style="vertical-align: inherit;">You can, of course, configure it so that the src ip is Balabit_ip1 ... 4, but in the situation on PHDays it was superfluous.</font></font><br><br>  Is done.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The SSH session is not functionally broken, other traffic is not affected, the conditions of the game are met. </font></font><br><br><h4>  *** </h4><br>   ,         DMZ  Balabit,    firewall     : <br><br><img src="https://habrastorage.org/files/615/689/fe7/615689fe779f49d1b4c17c44ffb7aa31.png"><br><br>  ,        ,       : <br><br><img src="https://habrastorage.org/files/08a/da1/bca/08ada1bcac8d4cdaa447133ab8033cba.png"><br><br> ,            .   ¬´  ¬ª     .     : <br><br><ul><li>   1 ‚Äî       DMZ   Balabit,   firewall. </li><li>   2 ‚Äî       (),       Balabit    DMZ. </li></ul><br>  ,    ‚Äî  Balabit   . ,  ,  ,  5-10 ,       ,       ‚Ä¶ <br><br>      ,      L3  ,    .  ,         ,      -   .       MPLS L3VPN  vrf lite     ( )       Balabit   firewall. <br>        ‚Ä¶ <br><br>      :       PHDays? <br> :   ‚Ññ1 ‚Äì  . <br><br><h4>  findings </h4><br> ,        ,        .   ,    ,  ,        .           : default permit   firewall       DMZ.   ,        checklist,    . <br><br>         ,     SANS Top 20 Critical Security Controls,      .     ,     .         (DEF)  SOC,   ,    . <br><br> -,  ,  SOC     ,         ,     .  -   ‚Äî ,          ¬´¬ª <br><br><table><tbody><tr><th>  No </th><th> Control name </th><th> DEF </th><th> SOC </th></tr><tr><td>  one </td><td> Inventory <br> of Authorized and Unauthorized Devices </td><td>  + </td><td>  + </td></tr><tr><td>  2 </td><td> Inventory,of Authorized and Unauthorized Software </td><td>  + </td><td>  + </td></tr><tr><td>  3 </td><td> Secure <br> Configurations for Hardware and Software on Mobile Device Laptops, <br> Workstations, and Servers </td><td>  + </td><td>  + </td></tr><tr><td>  four </td><td> Continuous <br> Vulnerability Assessment and Remediation </td><td>  + </td><td>  + </td></tr><tr><td>  five </td><td> Controlled <br> Use of Administrative Privileges </td><td>  + </td><td>  + </td></tr><tr><td>  6 </td><td> Maintenance, <br> Monitoring, and Analysis of Audit Logs </td><td></td><td>  + </td></tr><tr><td>  7 </td><td>  Email <br> and Web Browser Protections </td><td>  + </td><td></td></tr><tr><td>  eight </td><td>  Malware <br> Defenses </td><td>  + </td><td>  + </td></tr><tr><td>  9 </td><td> Limitation <br> and Control of Network Ports, Protocols, and Services </td><td>  + </td><td></td></tr><tr><td>  ten </td><td>  Data <br> Recovery Capability </td><td></td><td></td></tr><tr><td>  eleven </td><td> Secure <br> Configurations for Network Devices such as Firewall Routers, and Switches </td><td>  + </td><td></td></tr><tr><td>  12 </td><td> Boundary <br> Defense </td><td>  + </td><td></td></tr><tr><td>  13 </td><td>  Data <br> Protection </td><td>  + </td><td>  + </td></tr><tr><td>  14 </td><td> Controlled <br> Access Based on the Need to Know </td><td>  + </td><td>  + </td></tr><tr><td> 15 </td><td> Wireless <br> Access Control </td><td></td><td></td></tr><tr><td>  sixteen </td><td>  Account <br> Monitoring and Control </td><td></td><td>  + </td></tr><tr><td>  17 </td><td>  Security <br> Skills Assessment and Appropriate Training to Fill Gaps </td><td>  + </td><td>  + </td></tr><tr><td>  18 </td><td> Application <br> Software Security </td><td>  + </td><td></td></tr><tr><td>  nineteen </td><td> Incident <br> Response and Management </td><td></td><td>  + </td></tr><tr><td>  20 </td><td> Penetration <br> Tests and Red Team Exercises </td><td>  + </td><td>  + </td></tr></tbody></table><br>  , ,            ¬´¬ª. ,       . <br><br>        : <br><br>  one. <br>  2 <br>  3 <br><br>           : <br><br>  one. <br>  2 <br>  3 <br><br>            ,   ,   -   ‚Äî        ,     . <br><br> ,         ,   ,  ,       :). <br><br> PS           PHDays ¬´¬ª,     -            ¬´ ¬ª.          <a href="http://samag.ru/archive/article/3209"></a> . <br><br> <b></b> : <a href="http://aodugin.blogspot.ru/"> </a> </div><p>Source: <a href="https://habr.com/ru/post/304638/">https://habr.com/ru/post/304638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304628/index.html">Everything you wanted to know about BPM, but were afraid to ask</a></li>
<li><a href="../304630/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ218 (July 27 - 3, 2016)</a></li>
<li><a href="../304632/index.html">Creation of the minimap on Unity</a></li>
<li><a href="../304634/index.html">HTML :: Phl module for processing HTML documents containing Perl code instructions</a></li>
<li><a href="../304636/index.html">How I changed the main domain in Google Apps</a></li>
<li><a href="../304640/index.html">Instant Run: how does it work?</a></li>
<li><a href="../304642/index.html">A little bit about improving database performance: Practical advice</a></li>
<li><a href="../304644/index.html">SO_TIMESTAMPING in pictures. Reception package</a></li>
<li><a href="../304646/index.html">One unobvious vulnerability of some VKontakte groups</a></li>
<li><a href="../304650/index.html">We build payment acceptance into a mobile application, or why you can forget about PCI DSS and PA DSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>