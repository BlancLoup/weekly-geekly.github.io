<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When GitHub shoots you in the head, a new framework is created. The idea, concept and implementation of "Rutetider"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrahabr! Ready-made architectural solution for mobile devices, including iOS , Android , Telegram-bots , as well as platforms that support the p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When GitHub shoots you in the head, a new framework is created. The idea, concept and implementation of "Rutetider"</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a96/7cf/f70/a967cff7070ee05dab279fa4598cb965.png"></div><br>  Hi, Habrahabr!  Ready-made architectural solution for mobile devices, including <b>iOS</b> , <b>Android</b> , <b>Telegram-bots</b> , as well as platforms that support the processing of <b>http requests</b> , acting as a pet-project of the author of the article, will be interesting to those who want to implement a ‚Äúpocket‚Äù schedule of classes for their universities and schools. <br><br>  Content of publication: <br><br><ul><li>  What preceded the creation of the framework. </li><li>  Problems of programmers who are solved with "Rutetider". </li><li>  Details of the architectural structure of the instrument. </li><li>  About the components that are the main framework, and modules that improve the development, as well as a variety of examples. </li></ul><a name="habracut"></a><br><h2>  Introduction </h2><br>  In order to contribute to the open-source community for the most part and to a lesser extent - in order to solve the problem of the unavailability of the university‚Äôs class schedule on mobile devices (in truth, accessibility, but extremely non-adaptive and ‚Äúlong‚Äù) - I had to take the best opportunity - write a Telegram-bot (if you're interested - <a href="https://habrahabr.ru/post/316868/">an article on Habrahabr</a> ), and to solve the problem not only for your university - a small framework. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc9/3e3/de7/bc93e3de72c472d057b2ffcfe31bb61f.png"></div><br>  It was decided to base the framework on the first solution, with the same tools as for the bot, but not to exclude the possibility of development on platforms that directly support the integrity of mobile applications ‚Äî iOS, Android, and in general on any other platforms (web an application with adaptive layout for phones, for example). <br><br>  Simply put, it was determined two types of access to the functional - REST-API and Python-library for programmers using directly Python. <br><br><h2>  And Rutetider </h2><br>  This is a set of methods and tools based on a template sequence that will allow you to create, perhaps not a flexible, but certainly <b>working application</b> .  First of all, this is a <b>‚Äúhere and now‚Äù</b> solution;  if the main goal is development - write everything from scratch on your own and do not use the framework. <br><br>  Another positive point is the available <a href="https://github.com/DmytryiStriletskyi/Rutetider/wiki">documentation</a> , which is filled not only with explanations of the work, but also with illustrations and instructions that significantly speed up understanding and development. <br><br><h2>  Framework architecture </h2><br><h3>  The basic principle </h3><br>  As mentioned above, it is very difficult, without having a lot of programming experience in general, to determine the correct and beautiful structure, so I had to lean against something sample, but with its pluses - quite obvious and working. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c80/378/949/c803789495b928e3f804807b37a07d10.png"></div><br>  Speaking on behalf of the user, he will need to go through a series of screens: the choice of the main option (the ability <b>to get a schedule</b> ) among the many possible others, the <b>faculty</b> , the <b>course</b> , then the <b>group</b> and the <b>date itself</b> (also among the many other useful features). <br><br>  From the scheme it should be clear that the programmer himself needs to ‚Äúcatch‚Äù the user's location and display the necessary menus with different content, as well as keep statistics if such a condition is worth it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5e1/a38/ec3/5e1a38ec38f00b6ba03973b237e4d074.png"></div><br><h3>  More on the necessary methods </h3><br>  In order not to break away from the context, we‚Äôll continue with a friend - it‚Äôs necessary to record the user's position on the platforms without the possibility of using any local storage (such as the user's phone), because the ‚ÄúBack‚Äù button does not know where to return, it needs "Feed" the same position.  Another example is to know what kind of data a student enters, then to determine the group by faculty and course, and select the schedule for the relevant date by group. <br><br>  In addition, the programmer can count on convenient work with dates for today and tomorrow, that is, there is an opportunity to make both accurate and relevant values, and get it. <br><br>  While we stopped at entering data, it is worth mentioning that the framework has methods that are ready to help further structure information about couples in universities - from the audience and time to the teacher's data. <br><br>  Keep an example of adding lecture options: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rutetider <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Timetable timetable = Timetable(database_url) timetable.add_lesson(<span class="hljs-string"><span class="hljs-string">'IT'</span></span>, <span class="hljs-string"><span class="hljs-string">'3'</span></span>, <span class="hljs-string"><span class="hljs-string">'PD-31'</span></span>, <span class="hljs-string"><span class="hljs-string">'18.10'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'451'</span></span>, <span class="hljs-string"><span class="hljs-string">'2'</span></span>, <span class="hljs-string"><span class="hljs-string">' ..'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># params: faculty, course, group_name, lesson_date, lesson_title, # lesson_classroom, lesson_order, lesson_teacher</span></span></code> </pre> <br><h3>  I still don't understand how this works. </h3><br>  I tried to add a bit of modularity to the tools so that some platforms could not use unnecessary functionality, but on the other side I ‚Äúhandcuffed‚Äù everyone who wanted to use ‚ÄúRutetider‚Äù - the presence of a server (most likely) and a database. <br><br>  The need to create a database is caused by the fact that the author does not have enough resources to provide everyone with free space for his schedule and other valuable information, so the programmer will have to create his own PostgreSQL and share a link to access (fortunately, there are a lot of free features, I‚Äôll have one <a href="https://github.com/DmytryiStriletskyi/Rutetider/wiki/%25D0%2591%25D0%25B0%25D0%25B7%25D1%258B-%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585-%25D0%25B4%25D0%25BB%25D1%258F-%25D1%2580%25D0%25B0%25D0%25B7%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25BA%25D0%25B8">I am telling here</a> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d48/7ea/1b7/d487ea1b7cfe5677d8d16864a2fa5a00.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/061/05b/9bc/06105b9bc2e5392205180a2b3f96c8b0.png"></div><br><br>  But searching for a server may not be necessary for someone, but it will definitely be necessary for those whose university updates the schedule every day or every week - in this case, creating a tool for entering the schedule by means of a parser, reading CSV or any convenient method is a must . <br><br>  And here we are all very lucky, because the information technology community supports developers: <a href="https://www.heroku.com/">Heroku Cloud Platform</a> for Python, Java, Node.js and <a href="https://firebase.google.com/">Firebase</a> , <a href="http://parseplatform.org/">Parse</a> , <a href="https://polljoy.com/">Polljoy</a> - iOS (the author did not use most of the sentences; if you have any additions or comments to this account - please inform). <br><br><h2>  What functionality can be expected </h2><br>  <b>Lectures</b> and <b>couples</b> - a component of the overall structure, responsible for working with the processing of classes.  If you saw an example of adding pairs, then look at getting them. <br><br><pre> <code class="python hljs">schedule = timetable.get_lessons(<span class="hljs-string"><span class="hljs-string">'PD-31'</span></span>, <span class="hljs-string"><span class="hljs-string">'18.10'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># params: group_name, lesson_date print(schedule) # {'lessons': { # '3': {'lesson_teacher': ' ..', 'lesson_classroom': # '451', 'lesson_order': '3', 'lesson_title': ''}, # '1': {'lesson_teacher': ' ..', 'lesson_classroom': '118', # 'lesson_order': '1', 'lesson_title': #''}, # '2': {'lesson_teacher': ' ..', 'lesson_classroom': '200', # 'lesson_order': '2', 'lesson_title': #' '}}}</span></span></code> </pre><br>  <b>Subscription</b> , but not to notifications, which may well be a useful feature in the future when the framework is relevant, but to receive a schedule with just one click. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14f/6d7/57b/14f6d757ba0dfe98cbd74bde103ef45b.png"></div><br>  Due to the fact that the architecture requires you to press several buttons and see as many screens in front of you and choose something, this functionality is extremely useful - the user must subscribe to a certain group once and he will no longer have to ‚Äústeam‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Swift code</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">import UIKit <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ViewController: UIViewController { fileprivate <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> databaseURL = <span class="hljs-string"><span class="hljs-string">"postgres://nwritrny:VQJnfVmooh3S0TkAghEgA--YOxoaPJOR@stampy.db.elephantsql.com:5432/nwritrny"</span></span> fileprivate <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> apiURL = <span class="hljs-string"><span class="hljs-string">"http://api.rutetiderframework.com"</span></span> @IBAction func subscribeAction(_ sender: Any) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> headers = [<span class="hljs-string"><span class="hljs-string">"content-type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> postData = NSMutableData(data: <span class="hljs-string"><span class="hljs-string">"url=\(databaseURL)"</span></span>.data(using: .utf8)!) postData.append(<span class="hljs-string"><span class="hljs-string">"&amp;user_id=1251252"</span></span>.data(using: .utf8)!) postData.append(<span class="hljs-string"><span class="hljs-string">"&amp;group_name=PD-3431"</span></span>.data(using: .utf8)!) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = NSMutableURLRequest(url: NSURL(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>: <span class="hljs-string"><span class="hljs-string">"\(apiURL)/subscribers/add_subscriber"</span></span>)! as URL, cachePolicy: .useProtocolCachePolicy, timeoutInterval: <span class="hljs-number"><span class="hljs-number">10.0</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.httpMethod = <span class="hljs-string"><span class="hljs-string">"PUT"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.allHTTPHeaderFields = headers <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.httpBody = postData as Data <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session = URLSession.shared <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataTask = session.dataTask(<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> as URLRequest, completionHandler: { (data, <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) -&gt; Void <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> != nil) { print(<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> httpResponse = <span class="hljs-built_in"><span class="hljs-built_in">response</span></span> as? HTTPURLResponse print(httpResponse) } }) dataTask.<span class="hljs-keyword"><span class="hljs-keyword">resume</span></span>() } @IBAction func getSubscriptionInfoAction(_ sender: Any) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> headers = [<span class="hljs-string"><span class="hljs-string">"content-type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> postData = NSMutableData(data: <span class="hljs-string"><span class="hljs-string">"url=\(databaseURL)"</span></span>.data(using: .utf8)!) postData.append(<span class="hljs-string"><span class="hljs-string">"&amp;user_id=1251252"</span></span>.data(using: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.Encoding.utf8)!) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = NSMutableURLRequest(url: NSURL(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>: <span class="hljs-string"><span class="hljs-string">"\(apiURL)/subscribers/get_subscriber_group"</span></span>)! as URL, cachePolicy: .useProtocolCachePolicy, timeoutInterval: <span class="hljs-number"><span class="hljs-number">10.0</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.httpMethod = <span class="hljs-string"><span class="hljs-string">"POST"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.allHTTPHeaderFields = headers <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.httpBody = postData as Data <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session = URLSession.shared <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataTask = session.dataTask(<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> as URLRequest, completionHandler: { (data, <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) -&gt; Void <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> != nil) { print(<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jsonData = data { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> json = try JSONSerialization.jsonObject(<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: jsonData) as? Dictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, Any&gt; print(json?[<span class="hljs-string"><span class="hljs-string">"group"</span></span>]) } catch <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>{ print(<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) } } }) dataTask.<span class="hljs-keyword"><span class="hljs-keyword">resume</span></span>() } }</code> </pre><br></div></div><br>  <b>Current dates</b> with the possibility of making and receiving a schedule for today and tomorrow. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json api_url = <span class="hljs-string"><span class="hljs-string">'http://api.rutetiderframework.com'</span></span> database_url = <span class="hljs-string"><span class="hljs-string">'postgres://nwritrny:VQJnfVmooh3S0TkAghEgA--YOxoaPJOR@stampy.db.elephantsql.com:5432/nwritrny'</span></span> <span class="hljs-comment"><span class="hljs-comment">#   ,           r = requests.post(api_url + '/currentdates/', data=json.dumps({ 'url': database_url}), headers={'content-type': 'application/json'}) print(r.status_code) # 200 #      ,     , #     . r = requests.put('http://api.rutetiderframework.com/currentdates/add_current_dates', data=json.dumps({ 'url': database_url, 'today': '07.04', 'tomorrow': '08.04'}), headers={'content-type': 'application/json'}) r = requests.post('http://api.rutetiderframework.com/currentdates/get_current_dates', data=json.dumps({ 'url': database_url}), headers={'content-type': 'application/json'}) print(r.json()) # {'dates': ['07.04', '08.04']}</span></span></code> </pre><br>  Important, but no less difficult for the initial understanding, the point is the <b>user's position</b> - because of the impossibility of using built-in or other convenient means. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f20/fbe/e6c/f20fbee6c372cdaea812297975c3ad5c.png"></div><br>  For example, if a user selects a group, then we need to know what choice the user has already made (faculty and course), and if he has made a wrong course, then react to pressing the ‚ÄúGo back‚Äù button. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@bot.message_handler(func=lambda mess: ' ' == mess.text, content_types=['text']) def handle_text(message): user_position = UserPosition(database_url).back_keyboard(str(message.chat.id)) if user_position == 1: UserPosition(database_url).cancel_getting_started(str(message.chat.id)) keyboard.main_menu(message) if user_position == 2: UserPosition(database_url).cancel_faculty(str(message.chat.id)) keyboard.get_all_faculties(message) if user_position == 3: UserPosition(database_url).cancel_course(str(message.chat.id)) faculty = UserPosition(database_url).verification(str(message.chat.id)) if faculty != "—ñ —ñ—ñ" and faculty != ' ': keyboard.stable_six_courses(message) if faculty == "—ñ —ñ—ñ": keyboard.stable_one_course(message) if faculty == " ": keyboard.stable_three_courses(message) if user_position == 4: UserPosition(database_url).cancel_group(str(message.chat.id)) faculty, course = UserPosition(database_url).get_faculty_and_course(str(message.chat.id)) groups_list = Timetable(database_url).get_all_groups(faculty, course) groups_list.sort() keyboard.group_list_by_faculty_and_group(groups_list, message)</span></span></code> </pre><br>  Going back one menu is a little more complicated, so let's break it down into a diagram. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d1a/589/3ff/d1a5893ff592a51981315a478573194e.png"></div><br>  To know which menu the user needs, if he wants to go back, we need to use the ‚Äúback_keyboard‚Äù method, which will tell you what position the user has stopped at.  The diagram shows that the position is equal to one (1) - a digit denoting the sequence number of the menu where the user is ‚Äústuck‚Äù, which means that you need to return to the index position zero (1-1 = 0).  And once again: the index - which menu is the last but one, the user's position - which menu now.  How you display the menu and where you store it is the business of your application, but getting the position is already the work of the framework. <br><br>  The final part of the architecture is <b>statistics</b> , there is nothing complicated here, but a lot of useful stuff.  For example, you can easily keep detailed statistics of your application - record the number of faculty chosen by users, and then easily get this number and display it in any admin panel. <br><br><div class="spoiler">  <b class="spoiler_title">Swift code</b> <div class="spoiler_text"><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializeDatabase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> request = <span class="hljs-type"><span class="hljs-type">NSMutableURLRequest</span></span>(url: <span class="hljs-type"><span class="hljs-type">NSURL</span></span>(string: <span class="hljs-string"><span class="hljs-string">"\(apiURL)/statistics/"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">URL</span></span>, cachePolicy: .useProtocolCachePolicy, timeoutInterval: <span class="hljs-number"><span class="hljs-number">10.0</span></span>) request.httpMethod = <span class="hljs-string"><span class="hljs-string">"POST"</span></span> request.allHTTPHeaderFields = headers <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session = <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataTask = session.dataTask(with: request <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">URLRequest</span></span>, completionHandler: callback) dataTask.resume() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addStatistic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> body = [<span class="hljs-string"><span class="hljs-string">"url"</span></span>: databaseURL, <span class="hljs-string"><span class="hljs-string">"user_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"1251252"</span></span>, <span class="hljs-string"><span class="hljs-string">"point"</span></span>: <span class="hljs-string"><span class="hljs-string">"faculty"</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"06.04.2017"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonBody: <span class="hljs-type"><span class="hljs-type">Data?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { jsonBody = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-type"><span class="hljs-type">JSONSerialization</span></span>.data(withJSONObject: body) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> request = <span class="hljs-type"><span class="hljs-type">NSMutableURLRequest</span></span>(url: <span class="hljs-type"><span class="hljs-type">NSURL</span></span>(string: <span class="hljs-string"><span class="hljs-string">"\(apiURL)/statistics/add_statistics"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">URL</span></span>, cachePolicy: .useProtocolCachePolicy, timeoutInterval: <span class="hljs-number"><span class="hljs-number">10.0</span></span>) request.httpMethod = <span class="hljs-string"><span class="hljs-string">"PUT"</span></span> request.allHTTPHeaderFields = headers request.httpBody = jsonBody <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session = <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataTask = session.dataTask(with: request <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">URLRequest</span></span>, completionHandler: callback) dataTask.resume() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStatistic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> body = [<span class="hljs-string"><span class="hljs-string">"url"</span></span>: databaseURL, <span class="hljs-string"><span class="hljs-string">"user_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"1251252"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonBody: <span class="hljs-type"><span class="hljs-type">Data?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { jsonBody = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-type"><span class="hljs-type">JSONSerialization</span></span>.data(withJSONObject: body) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> request = <span class="hljs-type"><span class="hljs-type">NSMutableURLRequest</span></span>(url: <span class="hljs-type"><span class="hljs-type">NSURL</span></span>(string: <span class="hljs-string"><span class="hljs-string">"\(apiURL)/statistics/get_statistics_general"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">URL</span></span>, cachePolicy: .useProtocolCachePolicy, timeoutInterval: <span class="hljs-number"><span class="hljs-number">10.0</span></span>) request.httpMethod = <span class="hljs-string"><span class="hljs-string">"POST"</span></span> request.allHTTPHeaderFields = headers request.httpBody = jsonBody <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session = <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataTask = session.dataTask(with: request <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">URLRequest</span></span>, completionHandler: callback) dataTask.resume() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data: Data?, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resp: URLResponse?, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> error: Error?)</span></span></span></span> { printResponse(resp, error: error) parseResponse(data) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data: Data?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jsonData = data { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> json = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-type"><span class="hljs-type">JSONSerialization</span></span>.jsonObject(with: jsonData) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">Dictionary</span></span>&lt;<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Any</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(json ?? <span class="hljs-string"><span class="hljs-string">"json is nil"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error{ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error) } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> response: URLResponse?, error: Error?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error!) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> httpResponse = response <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">HTTPURLResponse</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(httpResponse ?? <span class="hljs-string"><span class="hljs-string">"response is nil"</span></span>) } }</code> </pre><br></div></div><br><h2>  thank </h2><br>  I hope that you not only appreciated my approach to describing the work done and the flow of thoughts in general, but also showed a deeper interest.  And if you are completely fascinated, I will be happy to answer your questions or help with the development of my part. </div><p>Source: <a href="https://habr.com/ru/post/326222/">https://habr.com/ru/post/326222/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326212/index.html">Cloud-AI - cloud artificial intelligence found 10 LinkedIn vulnerabilities</a></li>
<li><a href="../326214/index.html">Why mobile pre-order is more than just payment technology.</a></li>
<li><a href="../326216/index.html">Tarantool as the main data storage for server applications written in .NET</a></li>
<li><a href="../326218/index.html">SMS history: how to transfer text via voice channel</a></li>
<li><a href="../326220/index.html">Pampering Writing Telegram bot on Google script</a></li>
<li><a href="../326226/index.html">IP and IT: the eternal dispute about the main thing</a></li>
<li><a href="../326230/index.html">How I was a developer, and now Timlid</a></li>
<li><a href="../326232/index.html">APS technology: control panel frontend and JS SDK features</a></li>
<li><a href="../326234/index.html">New version of Windows 10: sysadmin view</a></li>
<li><a href="../326236/index.html">Centrifugo - 3.5 million rpm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>