<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gulp.watch: catch errors correctly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In all modern frontend assembly systems, there is a watch mode, in which a special daemon is launched to automatically reassemble files immediately af...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gulp.watch: catch errors correctly</h1><div class="post__text post__text-html js-mediator-article"> In all modern frontend assembly systems, there is a <code>watch</code> mode, in which a special daemon is launched to automatically reassemble files immediately after they are saved.  He also has gulp.js, but with some features that make working with it a bit more complicated.  The work of gulp.js is based on processing files as streams of data (streams).  And errors in the streams can not always be intercepted, and when an error occurs, an uncaught exception will be thrown and the process will end. <br><br>  To prevent this from happening, and watcher could ignore individual errors and run again and again while saving files, several additional settings need to be made in gulp, which will be discussed in this article. <br><a name="habracut"></a><br><h2>  What's happening? </h2><br>  First, let's look at what is happening and why the watcher sometimes falls.  When writing a plugin for gulp, it is recommended to emit an <code>error</code> event when errors occur while the plugin is running.  But the nodejs streams on which the build system is based do not allow errors to go unnoticed.  In case no one has subscribed to the <code>error</code> event, an exception will be thrown so that the message reaches the user exactly.  As a result, when working with gulp, developers often see such errors <br><br><pre> <code class="hljs swift">events.js:<span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> er; <span class="hljs-comment"><span class="hljs-comment">// Unhandled 'error' event</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When using Continious-Integration (CI), when automatic checks are run on each commit, this can be useful (the build failed, the build was not collected, the responsible ones will receive letters).  But the ever-falling watcher in local development, which needs to be constantly restarted, is a big deal. <br><br><h2>  What to do? </h2><br>  On the Internet, you can find questions on this topic both <a href="http://stackoverflow.com/questions/23971388/prevent-errors-from-breaking-crashing-gulp-watch">on stackoverflow</a> and <a href="https://toster.ru/q/212922">on the toaster</a> .  In the answers to the questions offer several popular solutions. <br><br>  You can subscribe to the <code>error</code> event: <br><br><pre> <code class="javascript hljs">gulp.task(<span class="hljs-string"><span class="hljs-string">'less'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gulp.src(<span class="hljs-string"><span class="hljs-string">'less/*.less'</span></span>) .pipe(less().on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, gutil.log)) .pipe(gulp.dest(<span class="hljs-string"><span class="hljs-string">'app/css'</span></span>)); });</code> </pre><br><br>  You can connect the <a href="https://github.com/floatdrop/gulp-plumber">gulp-plumber</a> plugin, which not only subscribes to <code>error</code> for one plugin, but also automatically does this for all subsequent plug-ins connected via pipe: <br><br><pre> <code class="javascript hljs">gulp.task(<span class="hljs-string"><span class="hljs-string">'less'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gulp.src(<span class="hljs-string"><span class="hljs-string">'less/*.less'</span></span>) .pipe(plumber()) .pipe(less()) .pipe(gulp.dest(<span class="hljs-string"><span class="hljs-string">'app/css'</span></span>)); });</code> </pre><br><br><h2>  Why not do this </h2><br>  Although the problem looks solved, it is not.  Now the build errors are intercepted, we get messages to the console about it, the running daemon does not crash, but now we have a new problem. <br><br>  Suppose we have a CI server where our scripts are being built for display.  In order for our assembly to work with watch, we applied one of the solutions above.  But now it turns out that in case of errors in the build, our build is still marked as successful.  The gulp command always ends with code 0. It turns out that for the CI assembly we don‚Äôt need to swallow errors.  You can add your error handler only for watch mode, but this will complicate the description of the assembly and increase the chances of making a mistake.  Fortunately, there is a solution for how to set up the assembly in the same way, but at the same time support the work in both build mode and watch mode. <br><br><h2>  Decision </h2><br>  In fact, gulp is trying to listen for errors in file streams.  But due to the fact that usually the last call is <code>gulp.dest()</code> , writing the result to disk, and errors occur in intermediate plugins, the error does not reach the end of the chain, so the gulp will not know about it.  For example, consider the following chain: <br><br><pre> <code class="javascript hljs">stream1.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'error 1'</span></span>) }) stream2.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'error 2'</span></span>) }) stream3.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'error 3'</span></span>) }) stream1 .pipe(stream2) .pipe(stream3); stream1.emit(<span class="hljs-string"><span class="hljs-string">'error'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     "error 1"</span></span></code> </pre><br><br>  Unlike, for example, promise, errors in the streams do not spread further along the chain, they need to be intercepted in each stream separately.  On this occasion, there is a <a href="https://github.com/nodejs/io.js/pull/1521">pull-request in io.js</a> , but in the current versions it is not possible to pass an error to the end of the chain.  Therefore, gulp cannot catch errors in intermediate threads and we need to do this on our own. <br><br>  But gulp as a description task takes not only the function that returns the stream, but also the usual callback-style function, like many APIs in node.js.  In such a function, we ourselves will decide when the task has completed with an error, and when it is successful: <br><br><pre> <code class="javascript hljs">gulp.task(<span class="hljs-string"><span class="hljs-string">'less'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">done</span></span></span><span class="hljs-function">) </span></span>{ gulp.src(<span class="hljs-string"><span class="hljs-string">'less/*.less'</span></span>) .pipe(less().on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    done(error); })) .pipe(gulp.dest('app/css')) .on('end', function() { //      done(); }); });</span></span></code> </pre><br><br>  Such a description of the assembly looks a bit more, because we are now doing some of the work for the gulp, but now we are doing it right.  And if you write yourself a helper function, <a href="https://gist.github.com/just-boris/89ee7c1829e87e2db04c">like this</a> , the difference will be almost imperceptible: <br><br><pre> <code class="javascript hljs">gulp.task(<span class="hljs-string"><span class="hljs-string">'less'</span></span>, wrapPipe(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">success, error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gulp.src(<span class="hljs-string"><span class="hljs-string">'less/*.less'</span></span>) .pipe(less().on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, error)) .pipe(gulp.dest(<span class="hljs-string"><span class="hljs-string">'app/css'</span></span>)); }));</code> </pre><br><br>  But we will get the correct messages in the console both during development and reassembly while saving, and on the CI server during the build. </div><p>Source: <a href="https://habr.com/ru/post/259225/">https://habr.com/ru/post/259225/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259213/index.html">We write a simple code analyzer on Roslyn</a></li>
<li><a href="../259215/index.html">Application KolibriOS. Part 2: Core Exposure for Iron Developers</a></li>
<li><a href="../259217/index.html">Screen with an infinite number of pixels</a></li>
<li><a href="../259219/index.html">Cheat sheet on mongodb: e-commerce, migration, frequently used operations and a little about transactions</a></li>
<li><a href="../259223/index.html">jQuery is considered harmful</a></li>
<li><a href="../259227/index.html">Network warrior. Demand study</a></li>
<li><a href="../259229/index.html">Some aspects of pricing policy in the field of information recovery services</a></li>
<li><a href="../259231/index.html">‚ÄúWhen will there be courses in JavaScript ?!‚Äù or a second year at the Academy</a></li>
<li><a href="../259233/index.html">Run the direction of contextual advertising in web studios</a></li>
<li><a href="../259235/index.html">Analysis of the tasks of the 3rd qualification round of the Russian Code Cup 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>