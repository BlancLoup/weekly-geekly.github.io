<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Escape from the data center: how we transferred the site to another data center in an emergency order</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with the community our experience of unplanned relocation of a large project. First of all, it will be interesting to those who have m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Escape from the data center: how we transferred the site to another data center in an emergency order</h1><div class="post__text post__text-html js-mediator-article">  I want to share with the community our experience of unplanned relocation of a large project.  First of all, it will be interesting to those who have more than one dedicated server for a project in one data center.  There are no detailed technical solutions, but there is some common sense. <br><a name="habracut"></a><br><h5>  Initial data </h5><br><ul><li>  The project uses 10 servers that are in the same data center.  Servers with nginx, PHP, MySQL.  Without a full-fledged mail server and any other services worthy of mention; </li><li>  The site has more than 3.5 million page views per day; </li><li>  More than 12 million requests per day to nginx, excluding requests for images.  1/4 of them go to PHP; </li><li>  More than 250 GB of traffic per day from nginx, excluding images; </li><li>  Preliminary terms of restoring servers in the data center are more than a few days. </li></ul><br><h6>  At the time of failure, we had: </h6><ol><li>  One backup server; </li><li>  Customized version of the site.  We sometimes checked the site on a backup; </li><li>  Database copies using MySQL replication; </li><li>  Copies of files.  The backlog of synchronization, according to monitoring, did not exceed 20 minutes; </li><li>  Configured <a href="http://www.zytrax.com/books/dns/ch8/soa.html">SOA</a> DNS zone <a href="http://www.zytrax.com/books/dns/ch8/soa.html">record</a> , which allows for almost an hour for all users to change the DNS zone settings. </li></ol><br><h5>  Problems and solution </h5><br>  After the failure, we decided to move in two directions: <ul><li>  restore the site on an existing read-only server, caching everything and ‚Äúforever‚Äù; </li><li>  Order new servers in another data center to restore full operation of the site. </li></ul>  Thus, while we receive the server, after the site does not lose its position in the search results, and visitors can view the content without the ability to leave comments, log in, etc. <br><br>  We assumed the failure of the main servers or several servers at once.  But they thought that to remain without all 10 servers for a long time is unlikely.  Here is what we did not take into account: <ol><li>  The working configs of the backup server were not updated as regularly as on the main server, although they are all stored in the repository.  As a result, we got a part of the URL with errors, and some of the pages were not cached; </li><li>  Cache.  Letting visitors to the 1 st server without a cache instead of 10 is ‚Äúdeadly‚Äù for him.  Especially in the amount of the previous item; </li><li>  In the process of switching it may turn out that the project itself is not quite ready for the ‚Äúread only‚Äù mode.  Pages that are already in the cache, you need to fix it, and after developers fixes, you need to clear the cache.  Do not agree to delete the entire cache, created with such difficulty.  Every minute more and more users get a new IP, and the number of visitors on the site is growing.  Clearing the cache an hour later, after changing DNS, put the server; </li><li>  We did not find a data center where you can get more than one powerful dedicated server per day.  Even with all the backups, you still can not quickly begin restoring the site in full, if you do not take care of this in advance. </li></ol><br>  All this could be done in advance, and we were forced to act on the fact. <br><br>  On the first point, logs were analyzed for solving and editing configuration files for ‚Äúread only‚Äù mode were done.  Namely: <ul><li>  Gave users a cultural message about the impossibility of logging in; </li><li>  Stopped comments and other actions to write at the level of nginx, not allowing users to PHP; </li><li>  Used <i>return 503</i> in the required places, as well as <i>error_page 503 = /trouble.html</i> ; </li><li>  Also fixed bugs to cache all other pages. </li></ul><br>  On the second and third points, the following solution appeared.  Make sure that our IP is in priority and each request instead of 504 errors is guaranteed to create a page in the cache and, if necessary, update it.  Without worrying about the performance of nginx, as it was necessary to revive the site at least a little, we used <a href="http://wiki.nginx.org/IfIsEvil">Evil If</a> to generate a cache for our IP, bypassing other visitors. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our case, it looked like this: <pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> unix:/var/run/php-fpm/fpm-all.sock; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span> = <span class="hljs-number"><span class="hljs-number">8.8.8.8</span></span> ) { <span class="hljs-comment"><span class="hljs-comment">#if ( $remote_addr ~ (8.8.8.8|127.0.0.1) ) { #       fastcgi_pass unix:/var/run/php-fpm/fpm-private.sock; #   #set $nocache 1; #fastcgi_cache_bypass $nocache; }</span></span></code> </pre>  <i>Instead of 8.8.8.8 substitute your IP.</i> <br><br>  In addition, we had two PHP-FPM <i>pools</i> : <i>fpm-private</i> - for us, <i>fpm-all</i> - for the rest.  To update the cache, use the directive <a href="http_fastcgi_module.html">fastcgi_cache_bypass</a> . <br>  To create the cache, we run <i>wget -r -l0 -np - example.com</i> .  To update the cache, we uncommented the lines with $ nocache.  Thus, we got a working site for ourselves with the ability to generate a cache and update it, if necessary, from our IP.  After several hours of work, there were already a few dozen gigabytes of cache. <br><br>  We almost never touch upon the issue of optimizing server settings; such topics are well described in separate articles.  In this case, database queries were read-only, so MySQL optimization was simple - the database was not a bottleneck.  Nginx configuration has been reduced to adjusting timeouts and buffers to handle all connections.  There was a good load on the network, as there was no more additional server for uploading images.  The weak point was php.  Even after generating a large cache, some pages were generated for 20 seconds, since there was a queue in PHP-FPM. <br><br>  Regarding the last point - search for new servers.  We failed to resolve this issue promptly.  Data centers could only provide servers with maximum core i3-i7, and 8GB of RAM for 1-2 days, and more powerful servers had to wait even longer, plus time to conclude contracts and pay for servers.  We found a data center with which we managed to agree on getting 4 powerful servers for a hot standby in 3 days.  Now these servers are enough for the site to work, without a pair of heavy modules that are not critical to us.  Now we can switch to work in another data center if necessary. <br><br>  A solution to the problem of backup servers can be a preliminary agreement with the backup data center on the possible provision of additional servers in case of problems with the main server.  You can do even wiser and scale the site to more than one data center, which we have now done. <br><br><h5>  Results </h5><br><ol><li>  You can‚Äôt live without backups, you should check them regularly with your hands and anything.  There is no extra care; </li><li>  The backup server check must be complete.  In our case, there was not enough load testing, again because we did not foresee a similar situation; </li><li>  If you have only one backup server, then configure it immediately so that it works even in a limited mode with real load; </li><li>  Take time to simulate the most unlikely situation with a project team or architect and administrators - an explosion, a fire, other circumstances in the data center, when you lose access to the servers at once.  Debriefing and, as a result, documenting such a case, as well as preparing configuration files with testing their work, will correct most of the likely failures.  Then if a UFO arrives behind your servers, you will not say that you did not expect this, and you will be able to recover the project :); </li><li>  In our case, the site was completely unavailable for just over an hour.  A few more hours were interruptions in work.  Preparing for such a situation would allow us to spend an hour while DNS records were updated, to generate a cache in order to meet the first visitors, and in the future, do not lie down tightly under load. </li></ol><br>  In our case, the data center restored work a little more than a day.  Given that we worked in read-only mode, we did not have to transfer any data back.  After checking the servers, we moved the domain back. <br><br>  I hope my experience will be useful to you in a difficult moment, when you will lose access to servers indefinitely, and you will have backups, but there will be no backup cluster in another data center.  I would be glad if you share in the comments, how would you act in this situation? </div><p>Source: <a href="https://habr.com/ru/post/143073/">https://habr.com/ru/post/143073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143066/index.html">April 30, 1993 WWW became public domain</a></li>
<li><a href="../143067/index.html">Microsoft invested $ 300 million in Barnes & Noble Nook reader</a></li>
<li><a href="../143070/index.html">Freelancers from all over the world have created a black list of defaulters</a></li>
<li><a href="../143071/index.html">LG refuses Windows Phone in favor of Android</a></li>
<li><a href="../143072/index.html">The results of the 20th international competition of incomprehensible C code</a></li>
<li><a href="../143075/index.html">Siri on the protection of a stolen iPhone</a></li>
<li><a href="../143076/index.html">UK court closed access to The Pirate Bay</a></li>
<li><a href="../143077/index.html">My first Android project, my first Android customer</a></li>
<li><a href="../143078/index.html">Symantec: religious sites have more viruses than porn sites</a></li>
<li><a href="../143079/index.html">What the .git directory hides from us</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>