<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Travel Banking Transaction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, posts about the operation of ATMs flashed on Habr√©: one and two , but both of them described the principles of operation of ATMs and ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Travel Banking Transaction</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/439/5a6/7d4/4395a67d4207845da9ef8de48ab819a1.jpg" alt="image"><br><br>  Some time ago, posts about the operation of ATMs flashed on Habr√©: <a href="http://habrahabr.ru/post/216315/">one</a> and <a href="http://habrahabr.ru/post/217337/">two</a> , but both of them described the principles of operation of ATMs and card processing in general very superficially. <br>  For those interested in under the cat a lot of details of the card processing of the bank (a lot of letters). <br><a name="habracut"></a><br>  How does the simplified scheme of the work of the processing center of the bank: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16d/5ef/72e/16d5ef72e07849a06154a74c22ccd713.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Processing </h5><br>  FrontEnd is responsible for online messages: communication with ATMs and POS terminals, transfer of card authorizations to VISA. <br>  BackEnd - responsible for offline: closing the trading day, exchanging financial messages with VISA. <br>  <a href="http://en.wikipedia.org/wiki/hardware_security_module">HSM</a> (Hardware Security Module) - a module for working with security keys (described in more detail below). <br><br>  All encryption is performed using the <a href="http://ru.wikipedia.org/wiki/3DES">3DES algorithm</a> . <br><br><h5>  Connect to VISA </h5><br>  The bank has two types of connection to VISA: <br><ul><li>  online </li><li>  offline </li></ul><br><br><h6>  Online connection </h6><br>  <b>Transport level</b> <br>  Connection to VISA is carried out through a very specific provider, in 2006 it was Equant and its partner in Russia - Golden Telecom, as things are now - I do not know. <br><br>  It turns out that VISA is available in the local network of one provider.  This is a mandatory VISA requirement.  To connect, the provider runs its own fiber-optic cable to the bank for the main communication channel and for the backup one.  Installs end routers and allocates one port on each (primary and backup).  Router management is carried out only by the provider. <br><br>  So, the connection of the transport level with VISA is established, then the application level. <br><br>  <b>Application layer</b> <br>  The application layer communication is carried out according to a special protocol developed at VISA in times immemorial. <br><br>  In addition to all this, all messages must be transmitted encrypted.  For this, special people - security officers - generate key sequences of a given length on the HSM and the results are sent to VISA. <br><br><h6>  Offline connection </h6><br>  An offline connection is nothing more than the exchange of files with information about all transactions made during the transaction day.  That is, if the ATMs of Bank "A" were served cards not of Bank "A."  More on this is slightly lower in the ‚ÄúAlien Client in our ATM‚Äù scenario. <br><br>  It is necessary to tell a little about HSM. <br><br><h5>  HSM </h5><br>  HSM is a classic black box.  During initialization, it generates a closed and open component of the master key of the bank.  Nobody ever sees the closed component, it always remains in the HSM memory. <br><br>  The module itself has numerous levels of protection against hacking: software and physical.  At the slightest hint of a key compromise, the module's memory self-destructs without the possibility of recovery. <br><br>  Three parts of the open master key components are recorded on 3 magnetic cards and issued to bank security officers. <br><br>  So, the connection with VISA is established, and everything works.  Now we need to issue cards. <br>  When joining VISA, the bank is issued the so-called Bank Identification Number: that is, a subset of the card numbers available for issue.  For VISA, they always start at 4. <br><br>  BINs are distributed by card products, for example: <br><br><ul><li>  VISA Classic: 400001 </li><li>  VISA Gold: 400002 </li><li>  VISA instant issue: 400003 </li><li>  and so on </li></ul><br><br>  The format of the number looks like this: let's say we have a card with the number: 4408 0412 3456 7890 <br><br>  The card number consists of: <br><br><ul><li>  4 - VISA code </li><li>  4408 (04) - bank code (card product code) </li><li>  12 3456 7890 - authorization limit number.  Read more about the authorization limit below. </li></ul><br><br>  For those interested, <a href="http://adywicaksono.wordpress.com/2008/02/17/how-to-validate-credit-card-number/">here is</a> described how the card number is validated. <br><br>  For each BIN, a pair of keys is generated: IWK (issuer working key) and AWK (acquirer working key).  The procedure for generating and transferring the result to VISA is similar to that described above. <br><br>  After that, all this stuff is registered in FrontEnd and BackEnd processing.  In BackEnd for the issuance of cards and their embossing, in FrontEnd for servicing authorizations. <br><br>  Now we have a connection with VISA and cards have been issued;  in other words, we issued cards.  It remains for us to do the acquiring. <br><br><h5>  ATMs </h5><br>  I will not repeat and describe what is inside the ATM, it has already been described here.  I can only say that the protocol NDC + (NCR Direct Connect) was developed by the devil knows how many years ago <a href="http://ru.wikipedia.org/wiki/ncr_corporation">NCR</a> Corporation - one of the leading manufacturers of ATMs today. <br><br>  Three manufacturers are well known: <br><br><ul><li>  NCR </li><li>  Wincor Nixdorf GmBH (formerly Siemens Nixdorf) </li><li>  Diebold (former IBM) </li></ul><br><br>  Yes, both Siemens and IBM once produced ATMs, but subsequently they sold this business to Wincor Nixdorf and Diebold, respectively. <br>  Your humble servant is a Wincor Nixdorf certified engineer.  However, we had one age-old IBM, which was released before the sale of the business and that worked. <br>  I will not say that he worked like a clock, because he had to be tightened up and adjusted all the time so that he could breathe at least somehow, but for him it was possible to buy spare parts.  True, they cost three times more than the same for Wincor Nixdorf. <br>  So, we found out that there are two protocols on which ATMs operate.  I happened to work only with NDC +, I only heard about DDC, but I never saw it. <br>  Since I am familiar only with Wincor Nixdorf, suppose that our bank bought them. <br><br>  When a <a href="http://ru.wikipedia.org/wiki/cen/xfs">software is</a> installed on the ATM that manages all its numerous devices, it is necessary to prepare the ATM for operation. <br><br><h5>  Preparing ATM </h5><br><h6>  Training </h6><br>  ATM must be trained to issue notes.  There is a special procedure for this: the ATM counts 10 sheets from each cassette and invites the operator to enter the actual number of sheets counted.  If the actual quantity is different, the ATM will correct the optocouplers in the issue path and will suggest that you repeat the procedure. <br><br>  From the experience, I only got the ATM a couple of times wrong, that is, as a rule, they are already well calibrated from the factory. <br><br><h6>  Encryption keys </h6><br>  The ATM download 2 encryption keys: <br>  master key (MASTER KEY) - used to encrypt the PIN-block entered by the client. <br>  communication key (COMM KEY) - to encrypt the packet to FrontEnd processing. <br><br>  On HSM, the open and closed components of each key are generated, after which the open component is written into FrontEnd, and the closed component is loaded into an ATM. <br>  Both keys are loaded into the PIN keyboard (EPP Encrypted Pin Pad) and stored only there.  In fact, EPP is such a small HSM that cannot generate keys, but can store them very well.  When I worked closely with ATMs - the EPP had 7 levels of protection against physical intrusion. <br><br>  After that, we write down the processing address, set up a VPN or whatever the telecommunications fighters will think up, and you can download the ATM operation script. <br><br><h6>  Scenario </h6><br>  About the script has already been said in the article to which I referred, I just want to add a little. <br>  The entire ATM scenario is based on the so-called Financial Institution Table. <br>  FIT is nothing but BIN Bank issued by VISA. <br>  For example: for our own bank, we will allow you to make transfers from card to card, the ability to view the details on the deposit and deposit cash into the card account in addition to the usual possibilities (balance, cash withdrawal), and for everyone else, only balance and withdrawal. <br><br>  Thus, we need to load several FITs into an ATM: <br><br><ul><li>  400001, 400002, 400003 - let's allow everything and everyone </li><li>  999999 - only issue and balance </li></ul><br><br>  The script checks the client's card number and works by the first match in the FIT table. <br><br>  So, we have fully prepared the whole complex for work, the most important thing remains: to complete the transaction. <br><br><h5>  Transaction </h5><br>  The simplest scenario: our client in our ATM: <br><br><ol><li>  The client inserts the card into the ATM; </li><li>  ATM sees that our client and gives him options; </li><li>  Client chooses: issue, 100 rubles </li><li>  The ATM encrypts the PIN with a master key; </li><li>  Encrypts the entire message with the communication key and sends it to FrontEnd; </li><li>  FrontEnd receives the message; </li><li>  ID identifies the ATM (each ATM connects to its own port, so the ID get no problems); </li><li>  Decrypts the message of the open component of the communication key; </li><li>  BIN understands that our card; </li><li>  Decrypts the PIN block with the open component of the master key; </li><li>  It processes the request for write-off (is there any money, are the limits not exhausted, and so on); </li><li>  Encrypts the message with the open component of the communication key; </li><li>  Sends an ATM; </li><li>  ATM decrypts the message; </li><li>  Reports the result to the client; </li><li>  Notifies the host that money has been issued (also with encryption and all the rest). </li></ol><br><br>  It is worth noting that all encryption on the host side is carried out using HSM. <br>  That is, steps 8 and 9 in detail look like this: <br><br><ol><li>  The host sends an encrypted PIN block, master key and checksum to the HSM; </li><li>  HSM decodes a PIN block; </li><li>  Verifies the checksum after decryption with the sent; </li><li>  Encrypts an open PIN block using IWK and counts the checksum; </li><li>  If the checksums of the open PIN-block and the encrypted IWK are equal - the PIN is entered correctly. </li></ol><br><br>  The client receives his 100 rubles and leaves satisfied, but this is only half the battle. <br><br>  At this point, FrontEnd set the client to hold - froze on its authorization limit (the amount available for withdrawal) of 100 rubles, but its current account did not change at all. <br><br>  It is worth explaining a little here: there are no customer accounts in the processing - money flows along so-called ‚Äúauthorization limits‚Äù.  In fact, the authorization limit is nothing more than a client's card account, but it does not appear in the chart of accounts and balance sheet. <br><br>  In other words, the authorization limit is a technical entity that reflects the state of the real current account of the client in processing.  The difference of the authorization limit is that: <br><br><ol><li>  processing limits apply to the authorization limit: a limit on a one-time issue, a limit on a daily issue, and so on; </li><li>  The authorization limit can be changed during the trading day, the current account is only at the moment of closing the trading day. </li></ol><br><br>  In the evening of the current day or in the morning of the next day (but, as a rule, this is done at night), the operational day closes.  All card authorizations and hold amounts are unloaded from FrontEnd and loaded into BackEnd, where money flows through current customer accounts.  After that, the final reports are uploaded to the Automated Banking System, where current customer accounts are stored.  Based on these reports, there is a real movement of money, as well as in FrontEnd - new authorization limits (our client from the example above receives a new authorization limit, which is less than 100 rubles). <br><br>  Now it is more difficult: Alien client in our ATM: <br><br><ol><li>  The client inserts the card into the ATM; </li><li>  ATM understands that the client is a stranger, shows him only the balance and issue; </li><li>  Client chooses: issue, 200 rubles </li><li>  ATM encrypts the PIN with a master key; </li><li>  Encrypts the message with the communication key; </li><li>  Sends a message to FrontEnd; </li><li>  FrontEnd decrypts the message with the open component of the communication key; </li><li>  Determines that the BIN is not ours and you need to send it to VISA; </li><li>  FrontEnd encrypts the message with the AWK component (since we are an acquirer in this case) and sends it to VISA; </li><li>  VISA receives a message from us, decrypts it with the second component of our AWK and, according to BIN, determines which bank it is; </li><li>  Encrypts the message with the IWK component (as it refers to the issuer) of the bank that issued this card and sends the message; </li><li>  The issuing bank receives the message: </li><li>  Decrypts the message with the help of the closed IWK component (it is immediately clear that our card, BIN does not make sense to look); </li><li>  Decrypts the PIN block; </li><li>  Authorizes the card (gives the go-ahead for the issuance of 200 rubles); </li><li>  Encrypts the message with the closed component IWK and sends it to VISA; </li><li>  VISA decrypts the open component IWK of the issuing bank, encrypts the open component AWK of our bank and sends it to us; </li><li>  We decrypt the message with a closed AWK component; </li><li>  Write the result of the transaction; </li><li>  Encrypt the open component of the communication key of the ATM you need and send a message to it; </li><li>  The ATM receives the message, decrypts it and gives the customer money; </li><li>  Notifies the host that money has been issued (again, I encrypt all messages); </li><li>  We notify the issuing bank that the money has been successfully issued; </li></ol><br><br>  It was only an authorization, that is, no one transferred real money to anyone.  Now we need to receive a financial message about this transaction and receive a refund from another bank: 200 rubles of our money, which we gave it to the client. <br><br><ol><li>  We send a report to VISA (offline, slowly and sadly) that it‚Äôs not our client who received the card number so that he received 200 rubles at our ATM; </li><li>  VISA sends a request to the issuing bank to transfer 200 rubles to us and another 0.5% of the transaction amount, but not less than $ 3 by VISA itself for conducting the transaction through itself.  This is the so-called interchange fee; </li><li>  The issuing bank receives files from VISA, closes its transaction day in processing, then closes the day in the Automated Banking System and translates it through a correspondent.  VISA bank to our account of our 200 rubles; </li><li>  Calculated from VISA (covers interchange fee) </li></ol><br><br>  Of course, all such calculations are carried out in dollars, and the exchange difference plays a role here, but this is a completely different story ... <br><br>  <b>UPD:</b> In the comments, Comrade <a href="http://habrahabr.ru/users/spewow/" class="user_link">Spewow</a> cited a link to <a href="http://habrahabr.ru/post/166181/">an article on HSM and cryptography</a> <br><br>  <b>UPD2:</b> And I discovered an article <b>describing the</b> software architecture for ATMs (XFS) in more detail: <a href="http://habrahabr.ru/post/93507/">habrahabr.ru/post/93507</a> </div><p>Source: <a href="https://habr.com/ru/post/229393/">https://habr.com/ru/post/229393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229381/index.html">Insomnia: game artificial intelligence is so artificial (video)</a></li>
<li><a href="../229383/index.html">Flying single Apollo mission vehicle on the moon: the story of one project</a></li>
<li><a href="../229385/index.html">On an effective software development process</a></li>
<li><a href="../229389/index.html">Lync 2013. Changing the domain name sip address</a></li>
<li><a href="../229391/index.html">Sound Blaster ROAR: Boombox XXI Century</a></li>
<li><a href="../229395/index.html">Generate pictures for Android applications from SVG</a></li>
<li><a href="../229401/index.html">DKIM signature in MS Exchange</a></li>
<li><a href="../229403/index.html">Amateur approach to computational linguistics</a></li>
<li><a href="../229407/index.html">Parsek 2014: We continue to talk about space</a></li>
<li><a href="../229409/index.html">Agile practices in mobile development projects, July 16, Minsk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>