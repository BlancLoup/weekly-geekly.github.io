<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kubernetes Dailymotion Adventure: Building Infrastructure in the Clouds + on-premises</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note perev. : Dailymotion is one of the largest video hosting services in the world and therefore a notable Kubernetes user. In this article, system a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kubernetes Dailymotion Adventure: Building Infrastructure in the Clouds + on-premises</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/2w/sg/pd/2wsgpd04mceffldc5shv-aomsyw.png"><br><br>  <i><b>Note</b></i>  <i><b>perev.</b></i>  <i>: Dailymotion is one of the largest video hosting services in the world and therefore a notable Kubernetes user.</i>  <i>In this article, system architect David Donchez shares the results of creating a production platform for the company based on K8s, which began with a cloud installation in GKE and ended as a hybrid solution, which allowed to achieve better reaction time and save on infrastructure costs.</i> <br><br>  In deciding to rebuild the core <a href="https://www.dailymotion.com/">Dailymotion</a> API three years ago, we wanted to develop a more efficient way to host applications and facilitate <a href="https://medium.com/dailymotion/deploying-apps-on-multiple-kubernetes-clusters-with-helm-19ee2b06179e">the development and production processes</a> .  For this purpose, we decided to use the container orchestration platform and naturally chose Kubernetes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why is it worth creating your own Kubernetes-based platform? <a name="habracut"></a><br><br><h2>  Production level API in no time using Google Cloud </h2><br><blockquote>  Summer of 2016 </blockquote><br>  Three years ago, right after <a href="https://www.vivendi.com/">Vivendi</a> bought Dailymotion, our engineering teams focused on one global goal: to create a completely new Dailymotion product. <br><br>  Based on the analysis of containers, orchestration solutions and our past experience, we made sure that Kubernetes is the right choice.  Some developers already had an idea of ‚Äã‚Äãthe basic concepts and knew how to use it, which was a huge advantage for infrastructure transformation. <br><br>  In terms of infrastructure, a powerful and flexible system was needed to host new types of cloud-native applications.  We chose to stay in the cloud at the beginning of our journey in order to calmly build the most reliable local platform.  They decided to deploy their applications using the Google Kubernetes Engine, although they knew that sooner or later we would switch to our own data centers and apply a hybrid strategy. <br><br><h3>  Why choose GKE? </h3><br>  We made this choice mainly for technical reasons.  In addition, it was necessary to quickly provide the infrastructure that meets the needs of the company‚Äôs business.  We had some application requirements, such as geographic distribution, scalability, and fault tolerance. <br><br><img src="https://habrastorage.org/webt/xu/s7/oj/xus7oj23f2icpor8zqehfbuqe3u.png"><br>  <i>GKE clusters in Dailymotion</i> <br><br>  Since Dailymotion is a video platform available all over the world, we really wanted to improve the quality of service by reducing <i>latency</i> .  Previously, <a href="https://developer.dailymotion.com/">our API</a> was only available in Paris, which was not optimal.  I wanted to be able to host applications not only in Europe, but also in Asia and the United States. <br><br>  This delay sensitivity meant that we had to seriously work on the network architecture of the platform.  While most cloud services forced them to create their own network in each region and then connect them through a VPN or a certain managed service, Google Cloud made it possible to create a fully routable unified network covering all regions of Google.  This is a big plus in terms of operation and system efficiency. <br><br>  In addition, network services and load balancers from Google Cloud do an excellent job.  They simply allow you to use arbitrary public IP addresses from each region, and the wonderful BGP protocol takes care of the rest (i.e., redirects users to the nearest cluster).  Obviously, in the event of a failure, traffic will automatically go to another region without any human intervention. <br><br><img src="https://habrastorage.org/webt/ki/nu/lm/kinulmtbiqjzg7n9lnrz0bvqz58.png"><br>  <i>Google load balancing monitoring</i> <br><br>  Our platform also actively uses graphics processors.  Google Cloud makes it extremely efficient to use them directly in Kubernetes clusters. <br><br>  At that time, the infrastructure team focused mainly on the old stack deployed on physical servers.  That is why the use of a managed service (including Kubernetes master components) met our requirements and allowed us to train teams on working with local clusters. <br><br>  As a result, we were able to start accepting production traffic on the Google Cloud infrastructure just 6 months after the start of work. <br><br>  However, despite a number of advantages, working with a cloud provider is associated with certain costs, which can increase depending on the load.  That is why we carefully analyzed each used managed service, hoping to implement them on-premises in the future.  In fact, the introduction of local clusters began at the end of 2016 and at the same time a hybrid strategy was initiated. <br><br><h2>  Launching the Dailymotion Local Container Orchestration Platform </h2><br><blockquote>  Fall 2016 </blockquote><br>  In conditions when the whole stack was ready for production, and work on the API <a href="https://tartiflette.io/">continued</a> , there was time to concentrate on regional clusters. <br><br>  At that time, users watched more than 3 billion videos every month.  Of course, we have been operating our own branched Content Delivery Network for several years now.  We wanted to take advantage of this circumstance and deploy Kubernetes clusters in existing data centers. <br><br>  The infrastructure of Dailymotion totaled more than 2.5 thousand servers in six data centers.  All are configured using Saltstack.  We began to prepare all the necessary recipes for creating master and worker nodes, as well as an etcd cluster. <br><br><img src="https://habrastorage.org/webt/ba/kx/76/bakx76nb_2zroyhn5jrko3ewqec.jpeg"><br><br><h3>  Network part </h3><br>  Our network is fully routable.  Each server announces its IP on the network using Exabgp.  We compared several network plug-ins and <a href="https://www.projectcalico.org/">Calico</a> was the only one satisfying all the needs (due to the approach used at the L3 level).  It fits perfectly into the existing network infrastructure model. <br><br>  Since I wanted to use all the available infrastructure elements, first of all I had to deal with our home-grown network utility (used on all servers): use it to announce IP address ranges on a network with Kubernetes nodes.  We allowed Calico to assign IP addresses to pods, but did not use it and still do not use it for BGP sessions on network equipment.  In fact, Exabgp handles routing, which announces the subnets used by Calico.  This allows us to reach out to any pod from the internal network (and in particular from load balancers). <br><br><h3>  How we manage ingress traffic </h3><br>  To redirect incoming requests to the desired service, it was decided to use Ingress Controller due to its integration with Kubernetes ingress resources. <br><br>  Three years ago, nginx-ingress-controller was the most mature controller: Nginx was used for a long time and was known for its stability and performance. <br><br>  In our system, we decided to place the controllers on dedicated 10-gigabit blade servers.  Each controller was connected to the kube-apiserver endpoint of the corresponding cluster.  Exabgp was also used on these servers to announce public or private IP addresses.  The topology of our network allows us to use BGP from these controllers to route all traffic directly to pods without using a service like NodePort.  This approach helps to avoid horizontal traffic between nodes and improves efficiency. <br><br><img src="https://habrastorage.org/webt/1i/_w/vj/1i_wvjnlyr5ayfbsohwwf_nl1hc.png"><br>  <i>Movement of traffic from the Internet to pods</i> <br><br>  Now that you‚Äôve figured out our hybrid platform, you can delve into the process of traffic migration. <br><br><h2>  Migrating traffic from Google Cloud to Dailymotion infrastructure </h2><br><blockquote>  Fall 2018 </blockquote><br>  After almost two years of creating, testing and configuring, we finally got a full Kubernetes stack, ready to receive some of the traffic. <br><br><img src="https://habrastorage.org/webt/8x/vo/cw/8xvocwrmmroc6lkjbs8gyhggqy8.jpeg"><br><br>  The current routing strategy is quite simple, but quite satisfies the needs.  In addition to public IP (in Google Cloud and Dailymotion), AWS Route 53 is used to set policies and redirect users to the cluster of our choice. <br><br><img src="https://habrastorage.org/webt/g4/zi/xs/g4zixslqqh52usdkl3hrthlazs8.png"><br>  <i>Example Routing Policy Using Route 53</i> <br><br>  With Google Cloud, it‚Äôs easy, because we use a single IP for all clusters, and the user is redirected to the nearest GKE cluster.  The technology is different for our clusters because their IPs are different. <br><br>  During the migration, we sought to redirect regional requests to the respective clusters and evaluated the advantages of this approach. <br><br>  Since our GKE clusters are configured to automatically scale using Custom Metrics, they increase / decrease capacity depending on incoming traffic. <br><br>  In normal mode, all regional traffic is directed to the local cluster, and GKE serves as a reserve in case of problems (health-checks are carried out by Route 53). <br><br><h2>  ... </h2><br>  In the future, we want to fully automate routing policies to get an autonomous hybrid strategy that constantly improves user accessibility.  As for the pluses: the cost of the cloud was significantly reduced and even managed to reduce the response time of the API.  We trust the resulting cloud platform and are ready to redirect more traffic to it if necessary. <br><br><h2>  PS from the translator </h2><br>  You might also be interested in another recent Dailymotion publication about Kubernetes.  It is dedicated to deploying Helm applications to many Kubernetes clusters and <a href="https://medium.com/dailymotion/deploying-apps-on-multiple-kubernetes-clusters-with-helm-19ee2b06179e">was published</a> about a month ago. <br><br>  Read also in our blog: <br><br><ul><li>  " <a href="https://habr.com/ru/company/flant/blog/440278/">Switching Tinder to Kubernetes</a> ." </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/441754/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/441754/">Part 10: <b>Reddit</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/412571/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/412571/">Part 9: <b>CERN and 210 K8s clusters</b></a> ‚Äù; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/349940/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/349940/">Part 8: <b>Huawei</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/347098/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/347098/">Part 7: <b>BlackRock</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/345780/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/345780/">Part 6: <b>BlaBlaCar</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/342412/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/342412/">Part 5: <b>Monzo Digital Bank</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/339724/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/339724/">Part 4: <b>SoundCloud (authors Prometheus)</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/335814/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/335814/">Part 3: <b>GitHub</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/334770/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/334770/">Part 2: <b>Concur and SAP</b></a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/334140/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/334140/">Part 1: <b>4,200 hearths and TessMaster on eBay</b></a> . ‚Äù </li></ul></div><p>Source: <a href="https://habr.com/ru/post/460877/">https://habr.com/ru/post/460877/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460867/index.html">Sourcery to automatically convert to Realm object structures</a></li>
<li><a href="../460869/index.html">Real-time object recognition on iOS using YOLOv3</a></li>
<li><a href="../46087/index.html">Russian application names in Django</a></li>
<li><a href="../460873/index.html">Why Turok: Dinosaur Hunter for N64 is years ahead of its time</a></li>
<li><a href="../460875/index.html">How we at QIWI came to a common style of interaction between View and ViewModel within MVVM</a></li>
<li><a href="../460879/index.html">DUMP Kazan 2019 - Tatarstan Developers Conference. We accept applications for reports</a></li>
<li><a href="../460883/index.html">About life in a world of changing requirements and the benefits of small features</a></li>
<li><a href="../460885/index.html">Interesting reports on HighLoad ++ Siberia 2019 according to Plesk</a></li>
<li><a href="../460887/index.html">Not another programming language. Part 3: Physics</a></li>
<li><a href="../460891/index.html">How to distinguish good SCRUM from bad, using the approach of the founder of quantum computing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>