<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once again about passport.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I was transferred to support a project on express.js. When studying the project code, I found a little confusing work with authentication / a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Once again about passport.js</h1><div class="post__text post__text-html js-mediator-article">  Recently I was transferred to support a project on express.js.  When studying the project code, I found a little confusing work with authentication / authorization which was based, like 99.999% of cases, on the passport.js library.  This code worked, and following the principle of ‚Äúwork - don't touch‚Äù, I left it as it is.  When in a couple of days I was asked to add two more authorization strategies.  And then I started to remember that I was already doing a similar job, and it took a few lines of code.  Having looked through the documentation on passport.js, I almost did not budge in understanding what and how to do, because  there were considered cases where exactly one strategy is used, for which, for each separately, and examples are given.  But how to combine several strategies, why do you need to use the logIn () method (which is the same as login ()) - it still didn‚Äôt become clear.  Therefore, to understand now, and not to repeat the same search again and again, I made these notes for myself. <br><a name="habracut"></a><br>  A bit of history.  Initially, web applications used two types of authentication / authorization: 1) Basic and 2) using cookie-based sessions.  In Basic authentication / authorization, a certain header is transmitted in each request, and thus, each client is authenticated in each request.  When using sessions, client authentication is carried out only once (methods can be very different including Basic, and also by name and password that are sent in the form, and thousands of other methods that are called strategies in terms of passport.js).  The main thing is that after passing through authentication, the session ID (or in some implementations session data) is stored in the cookie in the cookie, and the user ID is stored in the session data. <br><br>  First you need to decide whether you will use in your application session authentication / authorization.  If you are developing a backend mobile application - then, most likely, no.  If this is a web application, then most likely, yes.  To use sessions, you need to activate cookie-parser, session middleware, and also initialize the session: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = express(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sessionMiddleware = session({ <span class="hljs-attr"><span class="hljs-attr">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisStore({<span class="hljs-attr"><span class="hljs-attr">client</span></span>: redisClient}), secret, <span class="hljs-attr"><span class="hljs-attr">resave</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">rolling</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">saveUninitialized</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">cookie</span></span>: { <span class="hljs-attr"><span class="hljs-attr">maxAge</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">httpOnly</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }, }); app.use(cookieParser()); app.use(sessionMiddleware); app.use(passport.initialize()); app.use(passport.session());</code> </pre> <br>  Here it is necessary to give some important explanations.  If you do not want redis to eat all the RAM after a couple of years of work, you need to take care of deleting session data in a timely manner.  The maxAge parameter is responsible for this, which equally sets this value for both the cookie and the value stored in redis.  Setting the resave value: true, rolling: true, extends the validity period by the specified maxAge value for each new request (if necessary).  Otherwise, the client session will be interrupted periodically.  And finally, the saveUninitialized parameter: false will not put empty sessions in redis.  This allows you to put session initialization and passport.js at the application level, without clogging redis with unnecessary data.  At the route level, initialization makes sense to place only if the passport.initialize () method needs to be called with different parameters. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If the session is not used, initialization will be significantly reduced: <br><br><pre> <code class="javascript hljs">app.use(passport.initialize());</code> </pre><br><br>  Next, you need to create an object of the strategy (this is how the authentication method is called in the terminology of passport.js).  Each strategy has its own configuration features.  What remains unchanged is that the callback function is passed to the strategy constructor, which forms the user object, available as request.user for the middleware in the queue: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> jwtStrategy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JwtStrategy(params, (payload, done) =&gt; UserModel.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: payload.userId}}) .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">) =&gt;</span></span> { done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user); }) .catch(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) =&gt;</span></span> { done(error, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }) );</code> </pre><br><br>  You need to be well aware that if a session is not used, this method will be called each time a protected resource is accessed, and a database query (as in the example) will significantly affect the performance of the application. <br><br>  Next you need to give a command to use the strategy.  Each strategy has a default name.  But you can set it explicitly, which allows you to use the same strategy with different parameters and logic callback functions: <br><br><pre> <code class="javascript hljs">passport.use(<span class="hljs-string"><span class="hljs-string">'jwt'</span></span>, jwtStrategy); passport.use(<span class="hljs-string"><span class="hljs-string">'simple-jwt'</span></span>, simpleJwtStrategy);</code> </pre><br><br>  Next, for the protected route, you need to set an authentication strategy and an important session parameter (by default, equal to true): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> authenticate = passport.authenticate(<span class="hljs-string"><span class="hljs-string">'jwt'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">session</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}); router.use(<span class="hljs-string"><span class="hljs-string">'/hello'</span></span>, authenticate, (req, res) =&gt; { res.send(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>); });</code> </pre><br><br>  If the session is not used, then all authenticated routes should be protected with authentication.  If a session is used, then authentication occurs once, and for this a special route is set, for example login: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> authenticate = passport.authenticate(<span class="hljs-string"><span class="hljs-string">'local'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">session</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}); router.post(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>, authenticate, (req, res) =&gt; { res.send({}) ; }); router.post(<span class="hljs-string"><span class="hljs-string">'/logout'</span></span>, mustAuthenticated, (req, res) =&gt; { req.logOut(); res.send({}); });</code> </pre><br><br>  When using a session, on protected routs, as a rule, very laconic middleware is used (which for some reason is not included in the passport.js library): <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mustAuthenticated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!req.isAuthenticated()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.status(HTTPStatus.UNAUTHORIZED).send({}); } next(); }</code> </pre><br><br>  So, there is only one last thing left - serialization and deserialization of the request.user object into / from a session: <br><br><pre> <code class="javascript hljs">passport.serializeUser(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, done</span></span></span><span class="hljs-function">) =&gt;</span></span> { done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user.id); }); passport.deserializeUser(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, done</span></span></span><span class="hljs-function">) =&gt;</span></span> { UserModel.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {id}}).then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) =&gt;</span></span> { done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }); });</code> </pre><br><br>  I want to emphasize once again that serialization and deserialization work only with strategies for which the {session: true} attribute is specified.  Serialization will be performed exactly once immediately after authentication.  Therefore, updating the data stored in the session will be very problematic, and therefore only the user ID (which does not change) is saved.  Deserialization will be performed at each request to a protected route.  In this connection, requests to the database (as in the example) significantly affect the performance of the application. <br><br>  Comment.  If you use several strategies at the same time, the same serialization / deserialization code will work for all of these strategies.  To account for the strategy for which authentication has been passed, for example, you can include a sign of the strategy in the user object.  It also does not make sense to call the initialize () method several times with different values.  It will still be rewritten by the values ‚Äã‚Äãfrom the last call. <br><br>  On this one could finish the story.  Since  except for what has already been said, in practice nothing else is required.  However, I had to, at the request of the front-end developers, add an object with a description of the error to 401 responses (by default, this is the ‚ÄúUnauthorized‚Äù string).  And this, as it turned out, cannot be done easily.  For such cases, you need to get into the core of the library a little deeper, which is not so pleasant.  The passport.authenticate method has a third optional parameter: a callback function with a function signature (error, user, info).  A minor problem is that neither the response object, nor any function of the type done () / next () is passed to this function, and therefore you have to convert it yourself into middleware: <br><br><pre> <code class="javascript hljs">route.post(<span class="hljs-string"><span class="hljs-string">'/hello'</span></span>, authenticate(<span class="hljs-string"><span class="hljs-string">'jwt'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">session</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}), (req, res) =&gt; { res.send({}) ; }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">strategy, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ passport.authenticate(strategy, options, (error, user , info) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(error); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TranslatableError(<span class="hljs-string"><span class="hljs-string">'unauthorised'</span></span>, HTTPStatus.UNAUTHORIZED)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options.session) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.logIn(user, (err) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(err); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(); }); } req.user = user; next(); })(req, res, next); }; }</code> </pre><br><br>  Useful links: <br><br>  1) <a href="http://toon.io/understanding-passportjs-authentication-flow/">toon.io/understanding-passportjs-authentication-flow</a> <br>  2) <a href="https://habr.com/post/201206/">habr.com/post/201206</a> <br>  3) <a href="https://habr.com/company/ruvds/blog/335434/">habr.com/company/ruvds/blog/335434</a> <br>  4) <a href="https://habr.com/post/262979/">habr.com/post/262979</a> <br>  5) <a href="https://habr.com/company/Voximplant/blog/323160/">habr.com/company/Voximplant/blog/323160</a> <br>  6) <a href="https://habr.com/company/dataart/blog/262817/">habr.com/company/dataart/blog/262817</a> <br>  7) <a href="https://tools.ietf.org/html/draft-ietf-oauth-pop-architecture-08">tools.ietf.org/html/draft-ietf-oauth-pop-architecture-08</a> <br>  8) <a href="https://oauth.net/articles/authentication/">oauth.net/articles/authentication</a> <br><br>  apapacy@gmail.com <br>  January 4, 2019 </div><p>Source: <a href="https://habr.com/ru/post/435106/">https://habr.com/ru/post/435106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435090/index.html">Hyundai motor group introduced the concept of wireless charging and autonomous parking</a></li>
<li><a href="../435094/index.html">Gamepad from Sega Mega Drive and Raspberry Pi Part 2 (the final six-button)</a></li>
<li><a href="../435096/index.html">The effect of warm tube radio</a></li>
<li><a href="../435098/index.html">ADB vs Spy Cam & Mic</a></li>
<li><a href="../435102/index.html">Little about lexical analysis</a></li>
<li><a href="../435108/index.html">Use Prolog</a></li>
<li><a href="../435112/index.html">Corporate Interview</a></li>
<li><a href="../435114/index.html">Spring Data JPA</a></li>
<li><a href="../435118/index.html">Save File Me - free client-side backup service</a></li>
<li><a href="../435120/index.html">Lambda functions in SQL ... let me think</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>