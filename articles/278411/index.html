<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authentication using Spring Security and JWT tokens</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Habr is alive! This post is unlikely to collect a bunch of views and comments, but I hope it will help a little Habra. 

 This article will loo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authentication using Spring Security and JWT tokens</h1><div class="post__text post__text-html js-mediator-article">  Hello!  <a href="https://habrahabr.ru/post/278353/">Habr is alive!</a>  This post is unlikely to collect a bunch of views and comments, but I hope it will help a little Habra. <br><br>  This article will look at the principle of authentication in web applications on the Spring platform using a relatively new authentication mechanism - <a href="https://jwt.io/">JSON Web Token (JWT)</a> .  This mechanism has already been tested and implemented for many programming languages. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Using a token allows the server to not worry about saving the state between requests (HTTP session), to reduce the number of queries to the database - the data necessary for recovery can be stored in the token.  Directly about the JWT token: the server mixes the payload in JSON format (header and body) with the secret key and generates a hash, attaching it as a signature to the payload.  The payload is encoded by the base64Url algorithm, so naturally, you should not transfer secret data in the token.  JWT standard does not provide payload encryption.  Encrypt separately yourself if you wish, and the token's task is only to provide authentication. <br><br>  It is assumed that the reader is familiar with the basics of Spring Secutity.  You can read about it <a href="https://habrahabr.ru/post/203318/">here.</a> <br><br><h5>  one).  Token generation </h5><br>  For my example, I took one of the <a href="https://github.com/jwtk/jjwt">implementations of</a> the JWT specification.  The token is generated as follows: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.security; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.jsonwebtoken.JwtBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.jsonwebtoken.Jwts; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.jsonwebtoken.SignatureAlgorithm; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.jsonwebtoken.impl.crypto.MacProvider; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.GrantedAuthority; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.UserDetailsService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetTokenServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetTokenService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserDetailsService userDetailsService; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TokenObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String username, String password)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (username == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || password == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; User user = (User) userDetailsService.loadUserByUsername(username); Map&lt;String, Object&gt; tokenData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (password.equals(user.getPassword())) { tokenData.put(<span class="hljs-string"><span class="hljs-string">"clientType"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>); tokenData.put(<span class="hljs-string"><span class="hljs-string">"userID"</span></span>, user.getUserId().toString()); tokenData.put(<span class="hljs-string"><span class="hljs-string">"username"</span></span>, authorizedUser.getUsername()); tokenData.put(<span class="hljs-string"><span class="hljs-string">"token_create_date"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date().getTime()); Calendar calendar = Calendar.getInstance(); calendar.add(Calendar.YEAR, <span class="hljs-number"><span class="hljs-number">100</span></span>); tokenData.put(<span class="hljs-string"><span class="hljs-string">"token_expiration_date"</span></span>, calendar.getTime()); JwtBuilder jwtBuilder = Jwts.builder(); jwtBuilder.setExpiration(calendar.getTime()); jwtBuilder.setClaims(tokenData); String key = <span class="hljs-string"><span class="hljs-string">"abc123"</span></span>; String token = jwtBuilder.signWith(SignatureAlgorithm.HS512, key).compact(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Authentication error"</span></span>); } } }</code> </pre> <br>  As a result, we get a string like <i>&lt;Heading&gt;. &lt;Body&gt;. &lt;Signature&gt;</i> , which we send to the client <br><br>  Now to Spring Security.  To implement our own authentication mechanism, we need to implement our <i>filter</i> and <i>authentication manager</i> . <br><br><h5>  2).  Filter implementation </h5><br>  A filter is an object of a class that implements the <i>javax.servlet.Filter</i> interface, which intercepts requests to specific URLs and performs some actions.  If there are several filters, they form a chain of filters ‚Äî an HTTP request after reception by the application passes through this chain.  Each filter in the chain can process the request, skip it to the following filters in the chain, or not skip it, immediately sending a response to the client. <br><br>  The task of our filter is to transfer the token from the request to the authentication manager and, in case of successful authentication, set the security context of the application. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.security; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.Authentication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.AuthenticationException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletResponse; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TokenAuthenticationFilter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractAuthenticationProcessingFilter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenAuthenticationFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"/rest/**"</span></span>); setAuthenticationSuccessHandler((request, response, authentication) -&gt; { SecurityContextHolder.getContext().setAuthentication(authentication); request.getRequestDispatcher(request.getServletPath() + request.getPathInfo()).forward(request, response); }); setAuthenticationFailureHandler((request, response, authenticationException) -&gt; { response.getOutputStream().print(authenticationException.getMessage()); }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Authentication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attemptAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AuthenticationException, IOException, ServletException </span></span>{ String token = request.getHeader(<span class="hljs-string"><span class="hljs-string">"token"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (token == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) token = request.getParameter(<span class="hljs-string"><span class="hljs-string">"token"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (token == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { TokenAuthentication authentication = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TokenAuthentication(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); authentication.setAuthenticated(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authentication; } TokenAuthentication tokenAuthentication = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TokenAuthentication(token); Authentication authentication = getAuthenticationManager().authenticate(tokenAuthentication); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authentication; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, ServletException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.doFilter(req, res, chain); } }</code> </pre><br><br>  We inherited from the abstract class <i>org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter</i> , which is specifically designed for authentication.  If the URL of the request coincides with the pattern <i>"/ rest / **", the</i> function call <i>attemptAccesshentication ()</i> will occur. <br>  Also in the constructor, we set up two handlers ‚Äî <i>AuthenticationSuccessHandler</i> and <i>AuthenticationFailureHandler</i> .  If <i>attemptAuthentication</i> returns an <i>Authentication</i> object, then the first handler will trigger, the second handler will fire when the <i>AuthenticationException</i> exception is <i>attempted</i> by the <i>attemptAthentication</i> method. <br>  As we can see, upon successful authentication, we set the security context of the application via <i>SecurityContextHolder.getContext (). SetAuthentication (authentication)</i> .  The context thus set is the <i>ThreadLocal</i> variable, i.e.  available while the workflow is alive with the client.  After setting the context, we send the user request to the servlet with the originally requested URL. <br><br><h5>  3).  Authentication Manager. </h5><br>  The authentication manager is a class object that implements the <i>org.springframework.security.authentication.AuthenticationManager</i> interface with the only <i>authenticate ()</i> method.  This method needs to pass a partially populated object that implements the <i>org.springframework.security.core.Authentication</i> interface (application security context). <br>  The task of the authentication manager is to complete the <i>Authentication</i> object in the case of successful authentication and return it.  When filling you need to set the user ( <i>principal</i> ), his rights ( <i>authorities</i> ), execute <i>setAuthenticated (true)</i> .  In case of failure, the authentication manager should throw an <i>AuthenticationException</i> exception. <br><br>  Here is an example implementation of the <i>org.springframework.security.core.Authentication</i> interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.security; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.Authentication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.GrantedAuthority; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.authority.SimpleGrantedAuthority; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.UserDetails; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TokenAuthentication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authentication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String token; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Collection&lt;? extends GrantedAuthority&gt; authorities; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isAuthenticated; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserDetails principal; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String token)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.token = token; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.details = request; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String token, Collection&lt;SimpleGrantedAutority&gt; authorities, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isAuthenticated, UserDetails principal)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.token = token; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.authorities = authorities; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isAuthenticated = isAuthenticated; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.principal = principal; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authorities; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDetails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> details; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (principal != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((UserDetails) principal).getUsername(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPrincipal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> principal; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAuthenticated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isAuthenticated; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAuthenticated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IllegalArgumentException </span></span>{ isAuthenticated = b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; } }</code> </pre><br><br>  Here is the authentication manager implementation: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.security; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.jsonwebtoken.Jwts; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.jsonwebtoken.impl.DefaultClaims; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.AuthenticationManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.AuthenticationServiceException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.Authentication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.AuthenticationException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.AuthenticationServiceException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.GrantedAuthority; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.context.SecurityContextHolder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.UserDetails; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.UserDetailsService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.GrantedAuthority; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.function.Function; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TokenAuthenticationManager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthenticationManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserDetailsService userDetailsService; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Authentication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication authentication)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AuthenticationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authentication <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TokenAuthentication) { TokenAuthentication readyTokenAuthentication = processAuthentication((TokenAuthentication) authentication); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> readyTokenAuthentication; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { authentication.setAuthenticated(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> authentication; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ex <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> AuthenticationServiceException) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ex; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TokenAuthentication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TokenAuthentication authentication)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AuthenticationException </span></span>{ String token = authentication.getToken(); String key = <span class="hljs-string"><span class="hljs-string">"key123"</span></span>; DefaultClaims claims; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { claims = (DefaultClaims) Jwts.parser().setSigningKey(key).parse(token).getBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationServiceException(<span class="hljs-string"><span class="hljs-string">"Token corrupted"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (claims.get(<span class="hljs-string"><span class="hljs-string">"TOKEN_EXPIRATION_DATE"</span></span>, Long.class) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationServiceException(<span class="hljs-string"><span class="hljs-string">"Invalid token"</span></span>); Date expiredDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(claims.get(<span class="hljs-string"><span class="hljs-string">"TOKEN_EXPIRATION_DATE"</span></span>, Long.class)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expiredDate.after(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buildFullTokenAuthentication(authentication, claims); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationServiceException(<span class="hljs-string"><span class="hljs-string">"Token expired date error"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TokenAuthentication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildFullTokenAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TokenAuthentication authentication, DefaultClaims claims)</span></span></span><span class="hljs-function"> </span></span>{ User user = (User) userDetailsService.loadUserByUsername(claims.get(<span class="hljs-string"><span class="hljs-string">"USERNAME"</span></span>, String.class)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.isEnabled()) { Collection&lt;GrantedAutority&gt; authorities = user.getAuthorities(); TokenAuthentication fullTokenAuthentication = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TokenAuthentication(authentication.getToken(), authorities, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fullTokenAuthentication; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationServiceException(<span class="hljs-string"><span class="hljs-string">"User disabled"</span></span>);; } } }</code> </pre><br><br><h5>  four).  How to put it all together </h5><br>  First, you need to install a filter.  This can be done in 2 ways. <br><br>  The first way is to define a filter in the <i>web.xml file of</i> our application. <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span>springSecurityTokenFilter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-class</span></span></span><span class="hljs-tag">&gt;</span></span>com.example.security.TokenAuthenticationFilter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-class</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-mapping</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span>springSecurityTokenFilter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url-pattern</span></span></span><span class="hljs-tag">&gt;</span></span>/rest/**<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url-pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-mapping</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  With this method, the authentication manager must be set in the filter constructor immediately, since the filter instance will not be available in the context of the Spring application.  If you need to have a filter or authentication manager as Spring Bins, you must use the second method. <br><br>  The second way is to install the filter in the Spring Security configuration. <br><br>  For example, we show the configuration using Java Config <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.security; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.security.RestTokenAuthenticationFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.example.security.TokenAuthenticationManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Qualifier; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.ComponentScan; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.config.annotation.web.builders.HttpSecurity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.userdetails.UserDetailsService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableWebSecurity</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableGlobalMethodSecurity</span></span>(securedEnabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecurityConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebSecurityConfigurerAdapter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span>(<span class="hljs-string"><span class="hljs-string">"userDetailsService"</span></span>) UserDetailsService userDetailsService; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> TokenAuthenticationManager tokenAuthenticationManager; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpSecurity http)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ http .headers().frameOptions().sameOrigin() .and() .addFilterAfter(restTokenAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class) .authorizeRequests() .antMatchers(<span class="hljs-string"><span class="hljs-string">"/rest/*"</span></span>).authenticated() } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(name = <span class="hljs-string"><span class="hljs-string">"restTokenAuthenticationFilter"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTokenAuthenticationFilter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restTokenAuthenticationFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RestTokenAuthenticationFilter restTokenAuthenticationFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTokenAuthenticationFilter(); tokenAuthenticationManager.setUserDetailsService(userDetailsService); restTokenAuthenticationFilter.setAuthenticationManager(tokenAuthenticationManager); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restTokenAuthenticationFilter; } }</code> </pre><br>  In line <br>  <i>.addFilterAfter (restTokenAuthenticationFilter (), UsernamePasswordAuthenticationFilter.class)</i> <br>  we added our filter to the filter chain after the <a href="http://docs.spring.io/spring-security/site/docs/4.0.3.RELEASE/apidocs/org/springframework/security/config/annotation/web/HttpSecurityBuilder.html">standard</a> <i>UsernamePasswordAuthenticationFilter</i> filter. <br><br>  This completes the basic configuration of the authentication mechanism in Spring Security using JSON Web Token. <br><br>  I wish you all success! <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/278411/">https://habr.com/ru/post/278411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278401/index.html">JavaScript parser for treasure hunters of photographic depths</a></li>
<li><a href="../278403/index.html">Dollar</a></li>
<li><a href="../278405/index.html">Creating applications for Firebird with the use of various components and drivers: ADO.NET Entity Framework 6</a></li>
<li><a href="../278407/index.html">The key to JetBrains products for all students on Stepic.org</a></li>
<li><a href="../278409/index.html">Introduction to practical analytics, or what is common in neural networks with diet pills</a></li>
<li><a href="../278413/index.html">Overview of synchronization primitives - mutex and cond</a></li>
<li><a href="../278421/index.html">Emotional landing page? Wow wow, easy</a></li>
<li><a href="../278423/index.html">Migration of UI patterns and gestures. Who has anyone that podtyril</a></li>
<li><a href="../278425/index.html">Understanding the neural network war (GAN)</a></li>
<li><a href="../278427/index.html">Connect to the Device Guard Webinar on Windows 10. Start March 3 at 11:00 (GMT)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>