<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Dream lazy" or the script engine on itself</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Developers of application software very often have the need to build in their product a kind of scripting language that would solve some of the tasks ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Dream lazy" or the script engine on itself</h1><div class="post__text post__text-html js-mediator-article">  Developers of application software very often have the need to build in their product a kind of scripting language that would solve some of the tasks that are not described in detail at the time of system design.  Really convenient: the possibility of expanding the functionality is there, and the complexity of creating such a solution is, at first glance, not great. <br><br>  This old dream could be called a ‚Äúdream of a bummer‚Äù if the existing publicly available embedded scripting tools would be simple.  Finished tools existed for a long time, for example, on the Windows platform, in the last century it was possible to use VBScript and Jscript interfaces through the IActiveScriptSite COM interface.  Currently, there are a large number of other solutions, for example, based on Lua, but they all have one unpleasant feature that greatly limits the desire to use them. <br><br>  Scripts work fine on their own, you can perform both logic and arithmetic on them, but there is absolutely no use for them if it is difficult or not possible: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ‚Ä¢ add functions and objects to access objects of the developed system, <br>  ‚Ä¢ conduct syntax control of the source script and generate syntax error messages, <br>  ‚Ä¢ run the script step by step, like a debugger, with notification of the execution point and status. <br><br>  And yet, I would like it to be done all this simply and intuitively and would not have to spend sleepless nights reading numerous documentation on the new API.  Alas, this is not always possible and very rarely. <br><br>  Application software is now often written in C #, and I would like to have something familiar, but flexible, and allows you to write scripts.  There is such a solution, and it deserves close attention.  This namespace <a name="habracut"></a>  System.CodeDom.Compiler with its class CSharpCodeProvider.  All this appeared in .NET 4.0, but for some reason most of the publications in C # did not address the issue of writing scripts in C #, using the very same C # language as the base.  And it is very, very convenient for writing and further support of the product. <br><br>  In this case, the most important and interesting method is CompileAssemblyFromSource (), which compiles, generates error messages, and we can easily write ‚ÄúHello world!‚Äù <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.CSharp; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.CodeDom.Compiler; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; namespace ConsoleApplication1 { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { //    StringBuilder sb = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringBuilder(); sb.AppendLine("using System;"); sb.AppendLine("namespace ConsoleApplication1"); sb.AppendLine("{"); sb.AppendLine(" public class MyScripter"); sb.AppendLine(" {"); sb.AppendLine(" public void Hello()"); sb.AppendLine(" {"); sb.AppendLine(" Console.WriteLine(\"Hello world!\");"); sb.AppendLine(" }"); sb.AppendLine(" }"); sb.AppendLine("}"); //  CSharpCodeProvider codeProvider = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CSharpCodeProvider(); CompilerResults compileResults = codeProvider.CompileAssemblyFromSource( <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CompilerParameters(), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> string[] { sb.ToString() }); //  ,    <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (CompilerError err <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> compileResults.Errors) Console.WriteLine("Error({0:1}): {2} {3}", err.Line, err.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>, err.ErrorNumber, err.ErrorText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compileResults.Errors.HasErrors) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; //   dll   byte[] dllBytes = File.ReadAllBytes(compileResults.PathToAssembly); Assembly asmDll = Assembly.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(dllBytes, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> objType = asmDll.GetType("ConsoleApplication1.MyScripter"); //      <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> oClassInst = Activator.CreateInstance(objType); //       MethodInfo entry = objType.GetMethod("Hello", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>[] {}); entry.Invoke(oClassInst, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } } }</code> </pre> <br>  Run for execution: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b20/cb2/9ff/b20cb29ffc474ce0b756a7acc47b9290.jpg" alt="image"></div><br>  So, in its simplest form, the C # script works successfully.  By simply changing the script text, we can influence its operation.  Actually, it remains only to transfer to the script as an example any object from the main program. <br><br>  An object of the string type is quite suitable for such an object: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.CSharp; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.CodeDom.Compiler; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> ConsoleApplication1 { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Program</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> sMyStr = <span class="hljs-string"><span class="hljs-string">"Before Script."</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    StringBuilder sb = new StringBuilder(); sb.AppendLine("using System;"); sb.AppendLine("namespace ConsoleApplication1"); sb.AppendLine("{"); sb.AppendLine(" public class MyScripter"); sb.AppendLine(" {"); sb.AppendLine(" public void Hello(ref string s)"); sb.AppendLine(" {"); sb.AppendLine(" Console.WriteLine(\"Hello world!\");"); sb.AppendLine(" s=\"After Script.\";"); sb.AppendLine(" }"); sb.AppendLine(" }"); sb.AppendLine("}"); //  CSharpCodeProvider codeProvider = new CSharpCodeProvider(); CompilerResults compileResults = codeProvider.CompileAssemblyFromSource( new CompilerParameters(), new string[] { sb.ToString() }); //  ,    foreach (CompilerError err in compileResults.Errors) Console.WriteLine("Error({0:1}): {2} {3}", err.Line, err.Column, err.ErrorNumber, err.ErrorText); if (compileResults.Errors.HasErrors) return; //   dll   byte[] dllBytes = File.ReadAllBytes(compileResults.PathToAssembly); Assembly asmDll = Assembly.Load(dllBytes, null); Type objType = asmDll.GetType("ConsoleApplication1.MyScripter"); //      object oClassInst = Activator.CreateInstance(objType); //       MethodInfo entry = objType.GetMethod("Hello", new Type[] { typeof(string).MakeByRefType() }); Object[] param = new Object[] { sMyStr }; Console.WriteLine(param[0]); //    entry.Invoke(oClassInst, param); //   Console.WriteLine(param[0]); //    } } }</span></span></code> </pre><br>  Run for execution: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a01/f95/128/a01f951289d44165ad07bd4c13c51f26.jpg" alt="image"></div><br>  It can be seen that now we can transfer and return values ‚Äã‚Äãfrom the script code.  If, as a parameter, we transfer not a link to a string, but some internal object of the information system, then we can well influence the system from the script. <br><br>  This mechanism has a debugger runtime mode, for this you need to connect a .pdb file, there are many other interesting features. <br><br>  The disadvantage of the approach can be considered only that when compiling dll is created in the OS temporary directory. <br><br>  The way to resolve this deficiency leads us to the use of the space System.Reflection.Emit, but this is a rather voluminous material suitable for a separate article.  This is difficult, because in this case the compiler and generation will have to write independently.  But what opportunities to invent your own syntax!  Yes, and you can name a new programming language in honor of yourself or your favorite cat. <br>  Good luck! <br><br>  <i>Arkady Pchelintsev, project architect</i> </div><p>Source: <a href="https://habr.com/ru/post/327096/">https://habr.com/ru/post/327096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327084/index.html">Classic and new internet marketing aids worth seeing</a></li>
<li><a href="../327086/index.html">Predictive analytics on the SCP platform</a></li>
<li><a href="../327088/index.html">How we built the cloud processing infrastructure for cross-product analytics</a></li>
<li><a href="../327090/index.html">On the MegaFon Card - technical details, part 2</a></li>
<li><a href="../327094/index.html">We write chat bot quiz using Microsoft Bot Framework</a></li>
<li><a href="../327098/index.html">Oculus Rift games that can already be played</a></li>
<li><a href="../327100/index.html">UX-recipe phone number and email confirmation</a></li>
<li><a href="../327104/index.html">How I built NAS at home</a></li>
<li><a href="../327106/index.html">Managing the "power of thought": a resident accelerator at ITMO University</a></li>
<li><a href="../327108/index.html">Amp. What is it and what does it eat?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>