<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create infrastructure as code with GitLab and Ansible</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All the power of GitLab CI in demonstrating Ansible playbooks with the ‚Äúinfrastructure as a code‚Äù approach. 


 GitLab CI is an effective tool for a w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create infrastructure as code with GitLab and Ansible</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/k1/nd/9x/k1nd9xwkakzlxpmrfbteljd-dv8.jpeg"></p><br><h2 id="vsya-mosch-gitlab-ci-v-demonstracii-pleybukov-ansible-pri-podhode-infrastruktura-kak-kod">  All the power of GitLab CI in demonstrating Ansible playbooks with the ‚Äúinfrastructure as a code‚Äù approach. </h2><br><p>  GitLab CI is an effective tool for a wide variety of scenarios, including infrastructure as code.  GitLab can be used with different tools, but in this demonstration we will take Ansible, because it is the developers most often use it in the ‚Äúinfrastructure-as-code‚Äù approach.  Here is a <a href="">demo with two routers</a> from the <a href="https://github.com/ansible/workshops">Ansible network course</a> . </p><a name="habracut"></a><br><p>  The beauty of <a href="https://about.gitlab.com/product/continuous-integration/">GitLab CI</a> is that the code from the <a href="https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html">Ansible Playbook</a> can be changed and delivered without installing any dependencies locally.  The demo project that causes SNMP strings to be updated on all devices every month in accordance with our security policy can be fully implemented at <a href="https://about.gitlab.com/pricing/">GitLab.com</a> , our code hosting service. </p><br><p>  To get started, open the Ansible playbook, where there are 4 tasks: </p><br><ul><li>  Gather router facts - collecting facts about routers. </li><li>  Display version - version display </li><li>  Display serial number - display the serial number </li><li>  Configure SNMP - SNMP configuration. </li></ul><br><p>  In this demo, we will focus on setting up SNMP strings, for which you need to perform a few simple steps. </p><br><h3 id="nachinaem-s-doski-zadach">  We start with the task board </h3><br><p>  Any plan on GitLab starts in the same way: <a href="https://about.gitlab.com/handbook/marketing/product-marketing/getting-started/101/">from the task</a> .  So, the first step of the GitLab workflow is to check the task board in <a href="https://gitlab.com/bdowney/ansible-demo/-/boards">the ansible-demo project</a> .  On the <a href="https://gitlab.com/bdowney/ansible-demo/issues">ansible-demo task board,</a> we already see the task: <a href="https://gitlab.com/bdowney/ansible-demo/issues/4">change the SNMP strings on all routers</a> .  The task has a link to the GitLab security policy wiki page, which states that the SNMP strings need to be updated every month, and there must be different strings for ‚Äúread only‚Äù and ‚Äúread and write‚Äù operations. </p><br><p><img src="https://habrastorage.org/webt/y3/3q/ts/y33qtsiyjxyaylvuyuapm3vcsge.png"><br>  <em>GitLab security policy requires you to update SNMP strings every month.</em> </p><br><p>  Then you need to check that the commands to configure the SNMP strings in the <a href="">demo with two routers</a> do not violate the GitLab security policy described in the task. </p><br><p><img src="https://habrastorage.org/webt/aq/n1/j2/aqn1j264ipqglox7ri0dvptyn8s.png"><br>  <em>Commands for configuring SNMP strings are available in the Ansible playbook.</em> </p><br><p> Then go back to the task, assign it to yourself and change the shortcut from <code>to-do</code> to <code>doing</code> in the right pane or simply drag the task on the board from one column to another. </p><br><h3 id="sozdanie-merdzh-rekvesta">  Create a merge request </h3><br><p>  Now you need to create from the task merge rekvest.  Make sure that the merge-request <a href="https://docs.gitlab.com/ee/user/project/merge_requests/work_in_progress_merge_requests.html">has the Work in Progress (WIP) flag</a> so that it does not get into the master prematurely.  Instead of a local connection, we use the GitLab <a href="https://docs.gitlab.com/ee/user/project/web_ide/">Web IDE</a> , because the changes in the SNMP strings are minor. </p><br><ul><li>  Open the CI / CD demo section. </li><li>  Go to the Ansible Playbook. </li><li>  Modify the SNMP section as follows: </li><li>  Please note that RO and RW are configured with different strings in accordance with the <a href="https://gitlab.com/bdowney/ansible-demo/wikis/Security-Policies">GitLab security policy</a> described in the <a href="https://gitlab.com/bdowney/ansible-demo/issues/1">task</a> . </li></ul><br><h3 id="kommit-izmeneniy">  Commit change </h3><br><p>  You updated the SNMP string according to the instructions, and now you need to commit the changes.  Open a parallel comparison of changes to make sure that the merge request contains the last commit. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ty/mu/tl/tymutlrb0j3nuqyzfwxoqc2th4w.png"></a> <br>  <em>The parallel comparison tool clearly shows the changes.</em> </p><br><h3 id="rezultaty">  results </h3><br><p>  Committing changes will automatically launch the GitLab CI pipeline.  He will perform the following tasks: </p><br><ul><li>  Syntax check. </li><li>  Trial runs. </li><li>  Testing for changes in laboratory / artificial environment. </li></ul><br><p>  We see the progress and output of each job in the GitLab CI pipeline, which updates the SNMP. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/lj/rs/j-/ljrsj-pjvo3nt9lium7i8hteppw.png"></a> <br>  <em>The output of your task indicates that the SNMP updates in the built environment were successful.</em> </p><br><p>  All of these tasks will be launched and documented in the merge request. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ti/bw/th/tibwthey3l5eh4y8ptkhmbatvnk.png"></a> <br>  <em>Checkboxes indicate that the task in the GitLab CI pipeline is complete.</em> </p><br><p>  Then log into the routers for a demo and see the changes. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/4p/aw/gk/4pawgkkbstl7zabuhx8rvkptw3i.png"></a> <br>  <em>Changes to the SNMP RO and RW strings are reflected in the routers.</em> </p><br><h3 id="revyu-merdzh-rekvesta">  Merge Request Review </h3><br><p>  You can perform an additional step - <a href="https://docs.gitlab.com/ee/user/project/merge_requests/merge_request_approvals.html">approval of the merge requisition</a> .  If you set up approval, several users will be able to check the changes before they get into production. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/he/9r/ao/he9raoggmoodfpympqay18gq4sq.png"></a> <br>  <em>Merge-request can be configured so that another user checks your work before they are in the wizard.</em> </p><br><h3 id="peredacha-v-master">  Transfer to master </h3><br><p>  Changes can be sent to the wizard immediately after testing.  The master is the main branch that contains the code for the work environment. </p><br><p>  When ready, click the <code>Resolve Work In Progress</code> button.  Then click <code>Merge</code> . </p><br><p>  When you enable the WIP status, the merge-request can be sent to the master, and the task can be closed. </p><br><p>  The new pipeline will run all the tests that you performed in the additional step of launching the playbook in production. </p><br><p>  Follow the progress and logs on the pipeline.  When the process is complete, log into the working routers and verify that the SNMP strings have changed. </p><br><h3 id="magiya-gitlab-ci">  Magic GitLab CI </h3><br><p>  All this is possible thanks to the magic of GitLab CI.  GitLab CI pipelines are series of sequential tasks that perform everything you need to test and implement Ansible code. </p><br><p>  The entire GitLab CI configuration fits in a simple YAML file that is stored in the <code>.gitlab-ci.yml</code> . </p><br><p>  In this demonstration, the <code>.gitlab-ci.yml</code> contains 3 steps. </p><br><ol><li>  Deploy: creates a network with two routers in AWS using Ansible. </li><li>  Demo (demo): performs a playbook that changes SNMP strings. </li><li>  Destroy: Destroys a network simulation with two routers. </li></ol><br><p>  GitLab CI runs in a basic way.  In this case, we use the Docker image, which contains all the necessary code and Ansible dependencies.  Specify the commands to be executed at each stage and the dependencies. </p><br><p><img src="https://habrastorage.org/webt/s_/ud/vj/s_udvjdum23ahe7xhvaerhl3pkw.png"><br>  <em>A simple YAML file contains three GitLab CI steps.</em> </p><br><p><img src="https://habrastorage.org/webt/fy/_5/ik/fy_5ikzv77w5g5rpjpvcccyc0zo.png"><br>  <em>The demonstration stage of GitLab CI, on which the Ansible playbook is performed.</em> </p><br><p>  We looked inside the pipeline and saw how GitLab CI can be used to create the infrastructure as a code, even without installing the Ansible dependencies on the computer.  This is just one example of how GitLab CI can be used to implement infrastructure as code.  See the full guide in the video: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/M-SgRTKSeOg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459984/">https://habr.com/ru/post/459984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459972/index.html">Development for Docker. Local environment. Part 1</a></li>
<li><a href="../459976/index.html">New build Nemesida WAF Free for NGINX</a></li>
<li><a href="../459978/index.html">Node.js developer tools. Remote procedure call on web sockets</a></li>
<li><a href="../459980/index.html">High tech Nigerian letters</a></li>
<li><a href="../459982/index.html">Roslyn Analyzers. How to write code quickly and accurately</a></li>
<li><a href="../459988/index.html">Dog ate on neural networks</a></li>
<li><a href="../459990/index.html">Immersion in the Move - Libra blockchain programming language from Facebook</a></li>
<li><a href="../459992/index.html">GOST R 57100-2016. What was it?</a></li>
<li><a href="../459994/index.html">Study: Linux is still the most popular OS in the cloud</a></li>
<li><a href="../459996/index.html">Germany. Munich. Advanced Immigration guide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>