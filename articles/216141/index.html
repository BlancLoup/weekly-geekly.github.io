<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rails 4 Engines. Gem development through mountable engine - we read server logs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that there was an overwhelming desire to write your own Rails gem. Firstly, academic interest - this has not yet been done, and secondl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rails 4 Engines. Gem development through mountable engine - we read server logs</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ddc/2f2/ced/ddc2f2cedb5fc43c00a344b9a425675d.jpg" align="right"><br>  It so happened that there was an overwhelming desire to write your own Rails gem.  Firstly, academic interest - this has not yet been done, and secondly, there is a problem, the solution of which is important for me personally and which I would like to use in several of my projects. <br><br>  On Habr√© there were already articles about the creation of gems ( <a href="http://habrahabr.ru/post/134609/">one</a> <a href="http://habrahabr.ru/post/57829/">two</a> <a href="http://habrahabr.ru/post/128378/">three</a> <a href="http://habrahabr.ru/post/134609/">times</a> ) <br><br>  But based on them, it is impossible to create a full-fledged gem - they are very outdated and, as a rule, constitute a translation of the mean official documentation.  And most importantly, they mostly describe the creation of the Readme and License files, and the gem functionality itself comes down to Hello World. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Problem </h4><br>  I do not know how anyone, but I regularly have a situation - screwed a new feature locally, checked it, it seems to work.  You start cap deploy, you look at the server, and there <blockquote>  ‚ÄúSorry, but something went wrong. <br>  If you are an application owner, check the logs for more information. ‚Äù </blockquote><br>  Well, then - ssh to the server, cd to the application folder and the excavation of logs.  Whatever fans of vim and emacs may say, but trying to find something in the log with their help is something else.  It's easier to run tailf and try to find it with your hands.  There is still rmate, but I somehow did not catch on. <br><br><h4>  Idea </h4><br>  Write a gem that will output the results of the tail command to the browser in the specified path.  It is advisable to be able to watch all .log files in the log / folder <br><a name="habracut"></a><br><h4>  Immediately show what happened in the end: </h4><br>  All you need is to register in a gemfile <br><pre><code class="bash hljs">gem <span class="hljs-string"><span class="hljs-string">'tail'</span></span></code> </pre> <br>  install gem <br><pre> <code class="bash hljs">bundle install</code> </pre><br>  and mount it ( <code>config/routes.rb</code> ) at the desired point of the application, for example <br><pre> <code class="ruby hljs">mount Tail::Engine, <span class="hljs-symbol"><span class="hljs-symbol">at:</span></span> <span class="hljs-string"><span class="hljs-string">"/tail"</span></span></code> </pre><br>  After that on your server <br><div class="spoiler">  <b class="spoiler_title">This page will appear:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/725/9ec/6ed/7259ec6edccc45f1b909f311bd0836c2.tiff"><br>  Locally works the same way. <br></div></div><br>  If the application uses Devise, you will first need to enter a username and password. <br><br><h4>  How to do </h4><br>  Sinatra-based gems are usually used for such cases ( <a href="https://github.com/ejschmitt/delayed_job_web">for example</a> ) <br>  Personally, for my gem, I do not see the point, because I use Rails and there is no need for a synatra. <br><br>  For a start, it makes sense to write the application itself, which will later be turned into a separate gem. <br>  In my case it will consist of one controller and one action: <br><br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LogsController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_filter</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">authenticate_user!</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">defined?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Devise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">web_logger</span></span></span><span class="hljs-class"> ||= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Log</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">web_logger</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">n</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">n</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">log_file_name</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_name</span></span></span><span class="hljs-class">] || "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{Rails.env}.log" </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@files</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@web</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_logger.tail(log_file_name) end end</span></span></span></span></code> </pre><br>  Everything is simple, we use one Singleton class, which gives the specified number of lines from the specified .log file.  Log class itself is of no interest.  Is that the way to get the log: <br><br><pre> <code class="ruby hljs">@files.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(file_name) ? <span class="hljs-string"><span class="hljs-string">`tail -n </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{@n}</span></span></span><span class="hljs-string"> log/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{file_name}</span></span></span><span class="hljs-string">`</span></span>.lines : []</code> </pre><br>  Ruby natively allows you to execute OS commands by simply enclosing it in these (hell knows how correctly they are called) characters: <code>`tail -n 40 production.log`</code> will return the last 40 lines from the file. <br><br>  The resulting lines are placed in a table, slightly refined by CSS and displayed on the screen. <br><br>  One line of JavaScript (the well-known framework - <a href="http://vanilla-js.com/">Vanilla.js</a> ) scrolls the screen down to the last line: <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">'window.scrollTo(0, document.body.scrollHeight);'</span></span></code> </pre><br><br><h4>  Making a gem from the application. <br></h4><br>  Articles on Habr√© and the respected Ryan Bates described the creation of a gem using the bundle gem command.  The last video dates back to November 2011. <br>  Now the creation of Rails gem'ov recommended to do through <a href="http://www.rusrails.ru/engines">engines</a> . <br><br>  Engine is essentially another Rails application that will run along with the original one and use (mutually) its resources.  Siamese twins, in general.  Or implants, as someone more like.  In the parent application, the connection point of the new engine / plugin / gem is indicated, and then all the functionality of the new application is available at this address.  The explanation is primitive, on the fingers, to whom the details are interesting - I have indicated the links below. <br><br>  Thus, it is quite convenient to implement all admins, statistics gems, activity monitoring, etc. In general, everything that, on the one hand, is relatively independently and not so closely intertwined with the main application, and on the other hand, uses the full functionality of Rails - models, controllers, views, etc. <br>  Otherwise, it will be necessary to seriously sweat with the order of application initialization, migrations, access control, security, etc.  Golovnyak is still, but nothing is impossible.  Who is interested - you can start with <a href="http://memo.undr.su/2011/04/01/chto-zhe-takoe-railtie-engine-i-plugin/">this article here</a> <br><br>  For gems that work only with limited Rails functionality (for example, creating a new helper or controller filter), it is better to use <a href="http://www.rusrails.ru/plugins">plugins</a> <br><br><h5>  So, create a future gem named tail </h5><br><pre> <code class="bash hljs">rails plugin new tail --mountable</code> </pre><br>  The <code>--mountable</code> key actually separates the creation of the mountable engine from a relatively simple plugin. <br><br><div class="spoiler">  <b class="spoiler_title">In my case, I wrote</b> <div class="spoiler_text">  rails plugin new tail --mountable --skip-active-record <br>  As I do not use work with base. <br></div></div><br>  Very fun team.  If you look at the folder structure created as a result, it will be a mixture of the usual Rails application and the result of the <code>bundle gem</code> command. <br><br><h4>  Three main points: <br></h4><br><h5>  The first </h5><br>  the lib folder will be the basis of the future gem and the most important file in it is <code>engine.rb</code> <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Tail</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Engine</span></span></span><span class="hljs-class"> &lt; ::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rails::Engine</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isolate_namespace</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Tail</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  A module called gem is created with an isolated namespace in which all your models, controllers, views and classes will be wrapped.  Those.  instead of the <code>SomeClass</code> class, you will have <code>Tail::SomeClass</code> , the same with routes and paths - instead of, for example, <code>messages_path</code> you will write <code>tail.messages_path</code> if you need to get into the gem web part. <br>  By itself, this is done in order to eliminate conflicts of the name of the gem and applications where it will be mounted. <br><br>  Pay attention to the folder structure <code>app/</code> in the application: in each of them added an additional subfolder called gem'a, to which the necessary files are added.  Affects file and helper paths. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="//habrastorage.org/files/664/629/2c1/6646292c13634d749851c50bd887e95f.tiff"><br></div></div><br><h5>  Second one </h5><br>  .gemspec file - besides the description of the pesonal information, it contains a list of dependencies on other gems and a list of files required for assembly. <br><br>  lib / version.rb is the gem version number.  It is recommended to use the notation described in <a href="http://semver.org/">semver.org</a> .  A simple thing, but I draw attention to it, because the next publication of gem'a without changing the version is not allowed. <br><br><h5>  And third: </h5><br>  test / dummy folder - this contains the fake application that is already mounted (/test/dummy/config/routes.rb).  Ie, in order to check the work of gem, it is enough to go to this folder and run rails server.  At localhost: 3000 / tail will be my application.  Really very comfortable. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="//habrastorage.org/files/7a6/9d3/f26/7a69d3f266e646dabf6b52378ad7afef.tiff"><br></div></div><br><h4>  Fill gem </h4><br><pre> <code class="bash hljs">rails generate resource <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre><br>  I do not use scaffold, because there is no need for CRUD and generation of views. <br><br>  I transfer the code from the existing classes to the generated files.  It is worth making sure that everything works by running the fake application from <code>test/dummy</code> . <br><br>  Everything, from this point on, gem can be connected and debugged in another application: <br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'tail'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">path:</span></span> <span class="hljs-string"><span class="hljs-string">'~/projects/tail'</span></span></code> </pre><br>  or <br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'tail'</span></span> , <span class="hljs-symbol"><span class="hljs-symbol">git:</span></span> <span class="hljs-string"><span class="hljs-string">'git://github.com/k2m30/tail.git'</span></span> <span class="hljs-comment"><span class="hljs-comment">#   push  github</span></span></code> </pre><br>  The main thing to remember is to update the version file and <code>bundle update tail</code> in an application that uses gem after each change. <br><br><h4>  Publication </h4><br>  To publish a gem on rubygems, you need to <a href="http://rubygems.org/sign_up">register</a> there. <br><br>  After that, in the folder of the gem project <br>  To build gem <br><pre> <code class="bash hljs">rake build</code> </pre><br>  Auxiliary team <br><pre> <code class="bash hljs">gem push</code> </pre><br>  It is not involved in gem creation, it‚Äôs just an easy way to specify rubygems credetnials for release.  It is necessary to enter only once. <br><br>  Actually publication. <br><pre> <code class="bash hljs">rake release</code> </pre><br>  Immediately after this, the gem <a href="https://rubygems.org/gems/tail">will appear</a> in the search for rubygems and will be available through gem install for other developers. <br><br><h4>  Total </h4><br>  1. To create a mountable Rails gem, do the following: <br>  create skeleton <br><pre> <code class="bash hljs">rails plugin new tail --mountable</code> </pre><br>  2. Fill it with a familiar Rails application. <br>  There are minor features, but they are few and <a href="http://www.rusrails.ru/engines">well described.</a> <br>  It's very easy to see what you did by running <code>rails server</code> in the <code>test/dummy/</code> folder <code>test/dummy/</code> <br><br>  3. Assemble a gem <br><pre> <code class="bash hljs">rake build</code> </pre><br>  4. Register at rubygems.org and specify your username and password: <br><pre> <code class="bash hljs">gem push</code> </pre><br>  Make a release <br><pre> <code class="bash hljs">rake release</code> </pre><br>  That's all, you are a happy owner of your own gem. <br><br>  By the way, at the time of publication, rubygems claims that my gem was downloaded 151 times already.  Not really believe it, but nice. <br><br>  In general, the development was focused on ease of installation and use - nothing superfluous.  Totally.  Although there are other options - for example, <a href="https://github.com/r7kamura/webtail">gem webtail</a> sends the contents of the log to the socket and, accordingly, you can watch the changes in the logs in real time.  Such a realization does not suit me, if only because an additional dance with firewalls is needed.  Although beautiful. <br><br>  I really hope that my article, and who knows it, the gem itself will be useful and will save someone time and nerves. <br><br><hr><br><h4>  Links </h4><br>  <a href="http://wangjohn.github.io/railties/rails/gsoc/2013/07/10/introduction-to-railties.html">http://wangjohn.github.io/railties/rails/gsoc/2013/07/10/introduction-to-railties.html</a> <br>  <a href="http://blog.thepete.net/2010/11/creating-and-publishing-your-first-ruby.html">http://blog.thepete.net/2010/11/creating-and-publishing-your-first-ruby.html</a> <br>  <a href="http://www.rusrails.ru/">Rails in russian</a> <br>  <a href="https://github.com/k2m30/tail">Gem itself on github.com</a> <br>  <a href="https://rubygems.org/gems/tail">He is on rubygems.org</a> </div><p>Source: <a href="https://habr.com/ru/post/216141/">https://habr.com/ru/post/216141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216129/index.html">The strategy of the game "mafia" in terms of transaction analysis</a></li>
<li><a href="../216131/index.html">Denial of Service Attacks: Testing Practice</a></li>
<li><a href="../216133/index.html">A game about crazy geek scientists and a little enchanting localization story</a></li>
<li><a href="../216135/index.html">Win 8.1 App using HTML & WinJS</a></li>
<li><a href="../216137/index.html">Students, where are you? You need PostgreSQL!</a></li>
<li><a href="../216145/index.html">Neuroplasticity - 8 changes in man, formed under the influence of technology</a></li>
<li><a href="../216149/index.html">Simple transmission to Google Analytics of form filling error events in Magento (and not only)</a></li>
<li><a href="../216153/index.html">"Forbid them to ban" or the reverse side of the registry of banned sites</a></li>
<li><a href="../216155/index.html">The realities of working in Smart TV application projects</a></li>
<li><a href="../216157/index.html">Unicorn became interested in the microworld</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>