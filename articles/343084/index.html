<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WebGL: transfer game from mobile platform to desktop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Creating a desktop version of the mobile game has become a real research mission for the Krasnodar studio Plarium. In this article, we will describe h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WebGL: transfer game from mobile platform to desktop</h1><div class="post__text post__text-html js-mediator-article">  Creating a desktop version of the mobile game has become a real research mission for the Krasnodar studio Plarium.  In this article, we will describe how we switched to the WebGL technology when moving the Vikings: War of Clans project to a new platform. <br><br><img src="https://habrastorage.org/webt/x0/dv/es/x0dvesauwzmvumvshe8iqgxi4oa.jpeg" alt="image"><br><a name="habracut"></a><br><h2>  Mastering WebGL </h2><br>  The game Vikings: War of Clans was created on the cross-platform engine Unity 3D, which allows you to run the application on more than 25 platforms: from a mobile device to the browser.  We already had experience with Adobe Flash, but for this project we chose WebGL technology, and here's why: <br><br><ul><li>  The business logic of an existing project could be moved almost unchanged. </li><li>  WebGL technology is compatible with almost all modern browsers and does not require additional plug-ins. </li><li>  Unity Technologies does not hide the fact that WebGL is a priority technology for them, and with each new version the engine progresses noticeably: documentation is improved, bugs are fixed, functionality is added. </li></ul><br>  It is worth noting that the developers of Unity provide high-quality technical support and extensive documentation.  When working on the project, we received all the necessary information about the limitations for WebGL in the user manual and in the forums dedicated to this engine, so that you will not be left without help. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Translation difficulties </h2><br>  In order to build a WebGL build, the Unity engine performs a complex chain of actions: using Mono C # compiler, the game code is converted into intermediate (IL) code, and then using IL2CPP technology, the code in C ++ is obtained, which in turn gives us the WebGL project through the Emscripten compiler.  As a result, not all .Net features provided by the Unity 3D engine are available in the final assembly.  For example, multithreading is not supported, System.Net.Sockets does not work, etc. <br><br>  To complete the transition to the web version, we had to fix a number of problems. <br><br>  <i>WebSockets implementation</i> .  For networking, a wrapper was written that, with minimal changes, allowed us to work with the server through web sockets.  A simple example is available in the <a href="https://www.assetstore.unity3d.com/en/%3F%26_ga%3D2.38304355.1753005909.1510002027-134523977.1481042991">Unity Asset Store</a> . <br><br>  <i>Lack of multithreading</i> .  If in the mobile version, different processes were launched in parallel in separate threads and were not interrupted until they were completely completed, then the single-threading characteristic of the web version required a different approach in order to prevent application hangs.  To do this, we transferred all actions to coroutine and thus achieved the distribution of the load over time. <br><br>  <i>Opening tabs</i> .  Unity transfers the recorded user actions to the buffer and transfers them during the internal frame update.  In such a situation, the browser protection does not allow to open another window.  The problem was solved by a small extension to the engine - a native browser plug-in, into which mouse events are directly thrown. <br><br><pre><code class="javascript hljs">OpenURL: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.open(Pointer_stringify(url)); }</code> </pre> <br>  So managed to achieve the opening of all the necessary windows.  About creating plugins for WebGL is written in the <a href="https://docs.unity3d.com/Manual/webgl-interactingwithbrowserscripting.html">official documentation</a> and in the <a href="https://blogs.unity3d.com/ru/2015/05/06/an-introduction-to-ilcpp-internals/">blog of developers</a> . <br><br>  <i>Fonts</i> .  At some point, there was a need to refine the display of characters.  In particular, the input of hieroglyphs should be done as follows: the user types in combinations of Latin letters, which are converted into Japanese, Chinese or Korean letters.  In Unity itself, this method is not provided, but this functionality is in browsers.  We implemented it using a separate plug-in.  In addition, WebGL, unlike native applications of the same Flash, does not have access to system fonts.  Therefore, we added them directly to the project, which, of course, increased the size of the assembly. <br><br>  <i>Texture quality settings</i> .  It took a lot of time to adjust the balance between the quality of texture compression and the size of the build.  It was necessary to experimentally find out which textures are transferred from the mobile version, you can pinch, and which not.  Gradually, we came to the optimal settings, which are now automatically set. <br><br>  In our game there are several atlases for textures, and, as a rule, we use DXT1- and DXT5-compression (depending on the presence or absence of an alpha channel in them).  The exceptions are two atlases: containing textures that are extremely bad at compressing (textures with a gradient, buttons with numbers or letters) and a satin for emoji symbols.  In these cases, we use RGBA32. <br><br>  To reduce the size of all other textures that are outside the atlases, the formats DXT1Crunched and DXT5Crunched are suitable.  At the moment, we have redefined the OnPreprocessTexture method of AssetPostprocessor, which allowed us to automatically apply these settings to all textures in the project. <br><br>  <i>Third-party services</i> .  Be prepared for the fact that third-party libraries that are effectively used in a mobile game may not work correctly or even not work at all when building a WebGL project.  In such a situation, the best way out is to find an alternative.  For example, for authorization on Facebook, we additionally used the native JavaScript plugin.  It allows you to identify the user already at the time of loading the page and obtain in advance the permissions (permissions) required for the game. <br><br>  <i>Moving from Unity 5.2 to 5.6</i> .  During the development process, we needed to switch from Unity 5.2 to version 5.6, in which Unity Loader was added and several critical issues were fixed (for example, a build crash during a page reload).  These changes greatly simplified the initialization of the application.  You can see the download code for the builds of both versions below. <br><br>  Unity 5.2: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = document.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); canvas.style.width = <span class="hljs-string"><span class="hljs-string">"100%"</span></span>; canvas.style.height = <span class="hljs-string"><span class="hljs-string">"100%"</span></span>; canvas.addEventListener(<span class="hljs-string"><span class="hljs-string">"contextmenu"</span></span>, function(e) { e.preventDefault() }), canvas.id = <span class="hljs-string"><span class="hljs-string">"canvas"</span></span>; gameContainer.appendChild(canvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (consts.isDebug) { createScript(<span class="hljs-string"><span class="hljs-string">'unity52/module_pre_debug.js?v='</span></span> + consts.appVersion); document.WebExistsGLCallback = function() { Module.postRun.push(unityHelper.postRun); createScript(<span class="hljs-string"><span class="hljs-string">'Debug/Release/fileloader.js?v='</span></span> + consts.appVersion); createScript(<span class="hljs-string"><span class="hljs-string">'unity52/module_post_debug.js?v='</span></span> + consts.appVersion); tracker.load(); }; createScript(<span class="hljs-string"><span class="hljs-string">'unity52/UnityConfig.js?v='</span></span> + consts.appVersion); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { createScript(<span class="hljs-string"><span class="hljs-string">'unity52/module_pre.js?v='</span></span> + consts.appVersion); document.WebExistsGLCallback = function() { Module.postRun.push(unityHelper.postRun); createScript(<span class="hljs-string"><span class="hljs-string">'Release/fileloader.js?v='</span></span> + consts.appVersion); createScript(<span class="hljs-string"><span class="hljs-string">'unity52/module_post.js?v='</span></span> + consts.appVersion); tracker.load(); }; createScript(<span class="hljs-string"><span class="hljs-string">'unity52/UnityConfig.js?v='</span></span> + consts.appVersion); }</code> </pre> <br>  Unity 5.6: <br><br><pre> <code class="cs hljs">unityHelper.url = consts.isDebug ? <span class="hljs-string"><span class="hljs-string">"Debug/Build/Debug.json"</span></span> : <span class="hljs-string"><span class="hljs-string">"Build/WebGL.json"</span></span>; Module = UnityLoader.instantiate(gameContainer, unityHelper.url, { onProgress: function(a, b) { preloader.setProgress(b); }, Module: { resolveBuildUrl: function(buildUrl) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (buildUrl.match(<span class="hljs-string"><span class="hljs-string">"/(http|https|ftp|file):\/\//"</span></span>) ? buildUrl :unityHelper.url.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, unityHelper.url.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + buildUrl) + <span class="hljs-string"><span class="hljs-string">"?v="</span></span> + consts.appVersion; }, postRun: [unityHelper.postRun], }, }).Module;</code> </pre> <br><h2>  New experience for new projects </h2><br>  On the implementation of the desktop version of Vikings: War of Clans took six months.  Most of the time, we created a new UI and spent about two months doing technical work to migrate to WebGL. <br><br>  Taken as Throne: Kingdom at War, we already knew what was to be done and in what time frame we could meet.  Due to this, the second project moved to the web platform faster - in just 4 months.  Note that in both cases, mobile games expanded their functionality, while their desktop versions were approaching the exit to production, so individual elements of the UI were adjusted already in the process. <br><br><img src="https://habrastorage.org/webt/q0/kp/km/q0kpkmnaqwjco7r5gbrowk4_zi8.jpeg" alt="image"><br><br><h2>  Developer Tips </h2><br><ul><li>  Separate the logic and representation in the architecture of your application, and also try to highlight a single code base for the project.  This will help avoid code duplication problems and make it easier to support all the platforms you use. </li><li>  In Unity WebGL, working with memory is different from other platforms.  Initially, you need to specify WebGLMemorySize in player settings (default is 256 MB).  The size of the allocated memory must be known in advance so that the browser can allocate space for your application.  After that, you can no longer change the buffer size.  Often, the content consumes a large amount of memory, and to determine its optimal size, you will have to test the application.  This is best done with the Unity Profiler. </li><li>  When developing a WebGL project, you will inevitably encounter templates.  Unity by default provides a simple HTML page with a progress bar to load your application, and also gives you the opportunity to implement your custom templates.  If your application uses an internal preloader (to load resources, connect to the server, etc.), then to avoid alternately displaying two preloaders, it is better to limit to one that is available in the template.  After loading your application through the Unity Loader, you should send events (events) about the loading process to the JS methods of the template, while hiding the template layer with the application for a while.  This way you will avoid duplicating the preloader textures. </li></ul><br>  We hope that the experience of the studio Plarium-South will open up new opportunities for your projects. </div><p>Source: <a href="https://habr.com/ru/post/343084/">https://habr.com/ru/post/343084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343058/index.html">Release Rust 1.22 (and 1.22.1)</a></li>
<li><a href="../343062/index.html">SQL Server 2017 JSON</a></li>
<li><a href="../343064/index.html">When hackers are faster than antiviruses</a></li>
<li><a href="../343068/index.html">Black Friday in the Infobox</a></li>
<li><a href="../343082/index.html">Data from Google Spreadsheets on your site</a></li>
<li><a href="../343086/index.html">Example of reengineering a real business process or when there is no forest behind the trees</a></li>
<li><a href="../343088/index.html">Black Friday in a new light: non-standard strategies from global brands</a></li>
<li><a href="../343090/index.html">‚ÄúSteal in 60 seconds‚Äù using one car sharing example</a></li>
<li><a href="../343092/index.html">Course Fortinet Getting Started</a></li>
<li><a href="../343094/index.html">Interviews with representatives of Google Play Apps and Games on the mobile gaming market in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>