<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linking a data model in C ++ with a QML view using a map example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post participates in the competition "Smart phones for smart posts" . 

 Let's try to solve the following problem: to show in the application a m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linking a data model in C ++ with a QML view using a map example</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage1/02956b0a/11ed15d6/0d32d6ad/efdcc0ed.png"><br><br>  <i>This post participates in the competition <a href="http://habrahabr.ru/company/Nokia/blog/132522/">"Smart phones for smart posts"</a> .</i> <br><br>  Let's try to solve the following problem: to show in the application a map with pins, that is, to make the standard functionality necessary for any LBS application.  Moreover, to do this in the MVC paradigm - that is, the data model and controller in C ++, and QML deals only with the display and logic associated with the UI.  For the map, we will use the standard Map element, and at the same time we will deal with the binding of the data model from C ++ and QML. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To work, you need the installed Qt SDK 1.1.4.  We create a new project: Qt Quick Application -&gt; Qt Quick Components for Meego / Harmattan, then everything is by default.  Since we will be using Qt Mobilitiy, we need to add to the pro file: <br><br><pre><code class="bash hljs">CONFIG += mobility</code> </pre> <br><br>  After that we have an empty project with some binding in C ++ and two qml files - main.qml and MainPage.qml.  We will not touch the Main, it contains the standard for the platform, the upper status bar and the lower menu.  In MainPage you need to import the necessary: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> QtMobility.location <span class="hljs-number"><span class="hljs-number">1.2</span></span></code> </pre><br><br>  and delete everything inside the Page element, replacing it with a Map: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">Map</span></span> { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: map anchors.fill:parent plugin: Plugin {<span class="hljs-attr"><span class="hljs-attr">name</span></span>:<span class="hljs-string"><span class="hljs-string">"nokia"</span></span>} zoomLevel: <span class="hljs-number"><span class="hljs-number">13</span></span> center: Coordinate { <span class="hljs-attr"><span class="hljs-attr">latitude</span></span>: <span class="hljs-number"><span class="hljs-number">55.755786</span></span>; longitude: <span class="hljs-number"><span class="hljs-number">37.617633</span></span> } }</code> </pre><br><br>  I‚Äôll draw your attention to the definition of Plugin - you just have to write it in order to get Nokia (Ovi) Maps tiles in the map.  It is possible to connect other plug-ins, but they are not out of the box.  Next, we determine the level of approximation and coordinates of the center of the map.  We start, and we see Moscow. <br><br>  Everything is good, but we need at least a finger scroll.  The native control cannot do this, so we do it ourselves.  On top of the map, add a MouseArea that will catch single tachi and move the map: <br><br><pre> <code class="cpp hljs"> MouseArea { anchors.fill:parent property <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastX : <span class="hljs-number"><span class="hljs-number">-1</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastY : <span class="hljs-number"><span class="hljs-number">-1</span></span> onPressed : { lastX = mouse.x; lastY = mouse.y; } onReleased : { lastX = <span class="hljs-number"><span class="hljs-number">-1</span></span>; lastY = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } onPositionChanged: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastX&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.pan(lastX- mouse.x, lastY - mouse.y) lastX = mouse.x lastY = mouse.y } } }</code> </pre><br><br>  The zoom with two fingers can be sorted out in a similar way using the PinchArea element. <br><br>  Now you need to draw pins.  The map control supports rendering various elements in itself, both graphically primitives and bitmaps, but this can be done dynamically through the addMapObject and removeMapObject methods, which is not very consistent with our desire to do MVC.  Another option is to use MapObjectView, but as the documentation says ‚ÄúFor model data, is currently only LandmarkModel is supported.  Using other types of models results in undefined behavior. ‚ÄùAnd the LandmarkModel is a dark forest with a bunch of restrictions and unnecessary actions.  We need something simpler.  So we will go our own way, but first we will deal with the model in C ++. <br><br>  The model will be simple: inside there will be a list of pins, each lat, lng and imageSource for url pictures for pin.  But in the view, we will not give the lat and lng anymore, but the absolute X and Y values ‚Äã‚Äãof the pin on the screen.  We also implement the AddPin method, which will add pins to the list, and DrawPins which will be called from the view with some changes and recalculate X and Y values. DrawPins must be declared as a public slot in order to be able to receive signals from the view. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PinList</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QAbstractListModel <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ void PinList::addPin(QString imageSource, double lat, double lng) { //      Pin *pin = new Pin(this); pin-&gt;imageSource = imageSource; pin-&gt;Lat = lat; pin-&gt;Lng = lng; beginInsertRows(QModelIndex(), this-&gt;Pins-&gt;length(), this-&gt;Pins-&gt;length()); this-&gt;Pins-&gt;append(pin); endInsertRows(); // view,    emit dataChanged(createIndex(0,0),createIndex(this-&gt;Pins-&gt;size(),0)); } //view       lat, lng   x,y (        0,0) void PinList::DrawPins(QString x,QString y,QString x_end,QString y_end, QString map_x, QString map_y) { //   map_first_lat = x.toDouble(); map_first_lng = y.toDouble(); map_second_lat = x_end.toDouble(); map_second_lng = y_end.toDouble(); map_x_end = map_x.toDouble(); map_y_end = map_y.toDouble(); // view,    emit dataChanged(createIndex(0,0),createIndex(this-&gt;Pins-&gt;size(),0)); } //  view     //     lat,lng  x,y QVariant PinList::data(const QModelIndex &amp; index, int role) const { if (index.row() &lt; 0 || index.row() &gt; this-&gt;Pins-&gt;count()) return QVariant(); const Pin* pin = this-&gt;Pins-&gt;at(index.row()); QVariant result; switch (role) { case ImageSource: result = QVariant(pin-&gt;imageSource); break; case X: if ( pin-&gt;Lng &gt; map_first_lng &amp;&amp; pin-&gt;Lng &lt; map_second_lng) { result =QVariant((map_x_end)*(pin-&gt;Lng - map_first_lng)/(map_second_lng - map_first_lng)); } break; case Y: if ( pin-&gt;Lat &gt; map_second_lat &amp;&amp; pin-&gt;Lat &lt; map_first_lat) { result = QVariant(map_y_end*(pin-&gt;Lat - map_first_lat)/(map_second_lat - map_first_lat)); } break; } return result; }</span></span></code> </pre><br><br>  Now you need to draw all this in view.  To do this, define what the pin looks like: <br><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">// Component { id: landmarkMapDelegate Item { id:land width: 20; height: 20 ; x: X y: Y Image { source:ImageSource } } }</span></span></code> </pre><br><br>  and draw a repeater over the map <br><br><pre> <code class="cpp hljs"> Item { anchors.fill:parent Repeater { model: pinlist delegate: landmarkMapDelegate } }</code> </pre><br><br>  Here it is important: the model is tied to the pinlist identifier.  It is this identifier that will then need to be specified for model binding in C ++. <br><br>  Let's declare the function DrawPins, which will consider lat and lng corners of the map, and transfer it to the model <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawPins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> topLeft = map.toCoordinate(Qt.point(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bottomRight = map.toCoordinate(Qt.point(map.width, map.height)) pinlist.DrawPins(topLeft.latitude,topLeft.longitude,bottomRight.latitude,bottomRight.longitude, map.width,map.height); }</code> </pre><br><br>  And call it on the OnPositionChanges card. <br><br>  Now it remains, in fact, to link our model and View: <br><br><pre> <code class="hljs erlang-repl"> //  PinList* pinList = new PinList(<span class="hljs-number"><span class="hljs-number">0</span></span>); //   pinList-&gt;addPin(<span class="hljs-string"><span class="hljs-string">"qrc:/icons/pin.png"</span></span>, <span class="hljs-number"><span class="hljs-number">55.745</span></span>, <span class="hljs-number"><span class="hljs-number">37.6175</span></span>); pinList-&gt;addPin(<span class="hljs-string"><span class="hljs-string">"qrc:/icons/pin.png"</span></span>, <span class="hljs-number"><span class="hljs-number">55.7575</span></span>, <span class="hljs-number"><span class="hljs-number">37.619697</span></span>); pinList-&gt;addPin(<span class="hljs-string"><span class="hljs-string">"qrc:/icons/pin.png"</span></span>, <span class="hljs-number"><span class="hljs-number">55.751667</span></span>, <span class="hljs-number"><span class="hljs-number">37.617778</span></span>); //    viewer-&gt;rootContext()-&gt;setContextProperty(<span class="hljs-string"><span class="hljs-string">"pinlist"</span></span>, pinList); // qml viewer-&gt;setMainQmlFile(QLatin1String(<span class="hljs-string"><span class="hljs-string">"qml/untitled/main.qml"</span></span>));</code> </pre><br>  Everything. <br><br>  <a href="">Sources</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/134302/">https://habr.com/ru/post/134302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134295/index.html">How we got to Silicon Valley</a></li>
<li><a href="../134296/index.html">Jelastic PaaS - usage statistics for databases, servers and JVM in November</a></li>
<li><a href="../134297/index.html">CiEx: Take Kadropotok</a></li>
<li><a href="../134298/index.html">WiFi-AC - a new generation of Wi-Fi</a></li>
<li><a href="../134300/index.html">Rating Top-50 digital agencies of Russia-2011</a></li>
<li><a href="../134303/index.html">REST vs SOAP. Part 2. How easier and more efficient to organize communication platforms?</a></li>
<li><a href="../134305/index.html">The dark side of ContentProvider</a></li>
<li><a href="../134306/index.html">How far from the idea of ‚Äã‚Äãthe game to its realization: an interview with the developers of the Yocto Technology Group</a></li>
<li><a href="../134307/index.html">SFTP support in midnight commander</a></li>
<li><a href="../134308/index.html">Google+ has introduced face recognition on uploaded photos.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>