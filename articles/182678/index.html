<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a multiplayer realtime game on node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few months ago, my colleagues and I decided to make a multiplayer realtime game that could work on the web. We decided to use node.js for our server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a multiplayer realtime game on node.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/c11/e8f/d46/c11e8fd46da88a4e51545f972840cc66.jpg" align="right"><br><br>  A few months ago, my colleagues and I decided to make a multiplayer realtime game that could work on the web.  We decided to use node.js for our server.  This decision led to a very convincing success - our server worked for several months without a single crash or process restart. <br><br>  We decided to write our game on node.js, because we heard a lot of good things about this platform and really wanted to play a little with it.  And it was amazing - we quickly entered the topic.  For node.js there are many interesting libraries that can solve completely different tasks.  A side benefit of using node for the server part is, in fact, javascript - a very easy to use language.  This allowed us to focus on the problems that occur in all real-time games, without too much fuss, restrictions and the need to compile code, as happens when using less dynamic languages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also, node.js has proven to be a very lightweight language, even at peak times.  <b>For our game, the node.js process used only one thread and consumed only about 3-4% CPU while simultaneously running 8-10 copies of the game, each with its own collision detection engine.</b> <br><a name="habracut"></a><br><br><h4>  Initial approach </h4><br>  The initial (naive) approach when writing a multiplayer realtime game looks like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info = {}; info.position = {<span class="hljs-attr"><span class="hljs-attr">x</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>}; info.velocity = {<span class="hljs-attr"><span class="hljs-attr">x</span></span>:<span class="hljs-number"><span class="hljs-number">0.5</span></span>,<span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">0.2</span></span>}; info.currentWeapon = <span class="hljs-number"><span class="hljs-number">1</span></span>; info.radius = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.netChannel.send( info );</code> </pre> <br>  <b>The server forwards all received data packets to each connected client:</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">broadcastInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sendingClient, messageInfo </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aClient <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> allClients) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aClient != sendingClient) { aClient.connection.send( messageInfo ); } } }</code> </pre><br><h5>  Main problem </h5><br>  With this approach, you can not trust the information about the location of the user, which he sends to you.  The user will always report that he is there, where he needs to, gets into all opponents with one hundred percent accuracy and has a full stock of health. <br><br><h5>  Another problem with this approach is that you can never truly display a moving object. </h5><br>  Sometimes this effect is called a bouncing ball.  It is connected with the need to extrapolate the position of the object until the next packet arrives, based on the speed of the object, and further ‚Äúadjusting‚Äù the position, etc ... When the ball is at the top of the parabola along which it moves, the speed is zero.  Therefore, predicting its movement based on speed, we will get exactly the same point in which it is located, and the ball will hang in the air until it suddenly collapses sharply down. <br><br><img src="https://habrastorage.org/storage2/16b/933/34e/16b93334e656ea4e415765af4a70660c.jpg"><br><br>  Finally, another major problem is packet loss.  If one of the packets shown in the figure with a dashed line does not reach the recipient, the object will follow an incorrect trajectory.  And the further - the worse.  Of course, time is measured in milliseconds, and this is not the end of the world.  However, in fact, it looks very unnatural, since the objects of the real world can not move instantly. <br><br><h4>  Another approach is client-server model. </h4><br>  In the process of developing the game, we decided to find out how to solve this problem in practice.  After all, someone has already done multiplayer realtime games.  We found several interesting sources of information, in particular, the free source code of Quakeworld and some technical descriptions from Valve employees. <br><br><img src="https://habrastorage.org/storage2/f72/542/01a/f7254201a25e37dc7d472cc8621a039e.jpg"><br><br>  In this model, there is a single authoritative server that simulates the game.  As well as customers sending only their input data.  For example, I send only information that my space bar was pressed, and the server determines what it means in terms of the game.  Thanks to this model, we are freed from the many problems of the previous implementation. <br><br><h5>  Rendering world </h5><br>  Our nervous system can adapt to the delay.  If we use the same short delay time to draw an object, the person easily adjusts to it and stops noticing the delay at all.  The key to resolving our problem is that we are rendering the world to all customers in the past tense, the way it was N milliseconds ago.  The number N is chosen arbitrarily.  For example, we used 75 milliseconds. <br><br><h5>  Basic procedure </h5><br><img src="https://habrastorage.org/storage2/dd9/012/9a8/dd90129a8c936e63c748861f5e63cbfc.jpg"><br><br><ul><li>  Initially, we configure the system so that the client receives from the server high-precision changes in the world at discrete time intervals. </li><li>  We keep changing the world in an array. </li><li>  When it comes time to draw the players on the scene, we do it at a time equal to the current time minus the interpolation time. </li><li>  Let's call this point in time - the rendering time, which is actually equal to the current time minus 75 milliseconds. </li><li>  With each rendering, we find two changes, between which is our rendering time. </li><li>  Once the changes are found, we use the linear interpolation function to position the objects exactly on their trajectories. </li><li>  If a packet was lost, for example, if we did not receive a 343 packet (see figure), we can still use interpolation between the two received packets 342 and 344. </li></ul><br><h4>  RealtimeMultiplayerNodeJS </h4><br>  We faithfully believe in open-source, so we decided at the end of development to clean up the code a bit and put it as an open-source project.  Since we didn‚Äôt really succeed in choosing good names, we called it RealtimeMultiplayerNodeJS. <br><br>  RealtimeMultiplayerNodeJS is a framework designed specifically for creating multiplayer realtime games using HTML5 and a client-server model.  In this model, users send only input data, and the game itself is modeled on the server.  Clients interpolate the world between its two states based on the current rendering time. <br><br><h5>  How to use the project </h5><br><ol><li>  Download <a href="https://github.com/onedayitwillmake/RealtimeMultiplayerNodeJs">repository</a> </li><li>  Start the server ‚Äúnode js / DemoHelloWorld / server.js‚Äù in the terminal </li><li>  Open the "/DemoHelloWorld.html" page (Note that the file must be visible from the server so that you can connect using websockets) </li></ol><br><h5>  Physics Demonstration </h5><br>  This demo is made in order to show the idea of ‚Äã‚Äãsynchronized physical processes when all modeling takes place on the server.  To create the world used Box2D.js.  It also shows the synchronization of the interaction of several users, as well as an example of sending a message to the server with its subsequent interpretation again on the client side. <br><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/24149718&amp;xid=25657,15700022,15700186,15700191,15700253&amp;usg=ALkJrhhY0lqTt3eeXKuvXBGVAdKWt0ZN6w" width="504" height="315" frameborder="0" title="Video of RealtimeMultiplayerNodeJS" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><br><h5>  DemoHelloWorld </h5><br>  The most simple but interesting demo that we were able to come up with.  Objects move from left to right. <br><br><img src="https://habrastorage.org/storage2/ee9/d4d/bd2/ee9d4dbd26a6172f4a0aac1d80e00bbc.jpg"><br><br><h5>  DemoCircle </h5><br>  Demonstration of a simple CircleCollision collision engine, which provides the simplest information about collisions and generates an event when two objects collide.  This demo also shows the implementation of a special type of object that is controlled by a connected user using the keyboard. <br><br><img src="https://habrastorage.org/storage2/184/652/cd1/184652cd18518bd0896f758774f37543.jpg"><br><br><h5>  Finally, just to emphasize the main idea - an entity interpolation diagram made in the ASCII technique: </h5><br><pre> <code class="hljs ruby"> (actual time) (snapshot interval) <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| _ (rendered time) |</span></span> / \ <span class="hljs-params"><span class="hljs-params">| / vv / |</span></span> ------<span class="hljs-params"><span class="hljs-params">|-----|</span></span>----v<span class="hljs-params"><span class="hljs-params">|---|</span></span>----<span class="hljs-params"><span class="hljs-params">|----|</span></span>--v---------&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>.0sec <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>sec <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>sec <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>sec time <span class="hljs-params"><span class="hljs-params">| |</span></span> \ / \------\/----<span class="hljs-regexp"><span class="hljs-regexp">/ | | (interpolation time)</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/182678/">https://habr.com/ru/post/182678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182666/index.html">The digest of news from the world of mobile development in the last week ‚Ññ15 (June 3 - 9, 2013)</a></li>
<li><a href="../182670/index.html">Understanding scope or Scope in AngularJS</a></li>
<li><a href="../182672/index.html">How to create a simple tower defense game on Unity3D, part two</a></li>
<li><a href="../182674/index.html">Android is behind the ‚ÄúInternet of Things‚Äù - and it's everywhere</a></li>
<li><a href="../182676/index.html">Access to hidden UEFI BIOS settings from Insyde</a></li>
<li><a href="../182684/index.html">Bees can communicate through weak electric fields</a></li>
<li><a href="../182686/index.html">Bruce Schneier: The Illusion of Security</a></li>
<li><a href="../182688/index.html">Microsoft Dryad vs Apache Hadoop. Uncomplicated Big Data Battle</a></li>
<li><a href="../182690/index.html">We optimize Boid's on Unity</a></li>
<li><a href="../182698/index.html">Edward Snowden: an informant who gave secrets to the NSA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>