<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vesta CP: Installing Ruby and Python Web Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr. 
 I love when everything is in its place, everything is clean and tidy. 
 Therefore, once a quarter, raking creative mess.  For me it is impo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vesta CP: Installing Ruby and Python Web Applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0f7/ada/02e/0f7ada02ee2c4bf4937a0636892aaef7.jpg"><br><br>  Hi Habr. <br><blockquote>  I love when everything is in its place, everything is clean and tidy. <br>  Therefore, once a quarter, raking creative mess. </blockquote>  For me it is important to have a stable OS with the confidence that after the next daily update, nothing will break.  Many developers choose the OS based on the availability of current versions of software.  I can cook Centos and in " <i>yum-y install yum-cron</i> " I am 99.98% sure. <br><br>  I'll tell you how you can use the latest versions of ruby ‚Äã‚Äãand python for web development.  Also according to the results, 4 web applications from one regular user will be installed on the server: <i>djangocms</i> (python 3.4.3), <i>quokka</i> (python 2.7.9), <i>redmine</i> (ruby 2.2.1), <i>refinerycms</i> (ruby 2.0.0).  No attention will be paid to subtle application launch parameters (database selection, number of verker, connections, logs, etc.).  I wanted to describe LocomotiveCMS, but <u>it</u> turned out to be a locomotive with a bunch of manual edits for the setup. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For comfort and convenience we will use the control panel VestaCP.  Because she is simply gorgeous and ideologically dear. <br><a name="habracut"></a><br><h4>  System preparation </h4><br>  So, we have a test VPS with Centos 6, root access.  Contrary to the official manual, we will put a panel with the option "-d". <br><br><pre><code class="bash hljs">curl -O http://vestacp.com/pub/vst-install.sh bash vst-install.sh -d</code> </pre> <br>  Thus, we will limit the installation only to the "epel" repository, without the "remi" (i.e. without the latest versions of mysql and php). <br>  Add domain templates for nginx: <br><br><div class="spoiler">  <b class="spoiler_title">cat&gt; /usr/local/vesta/data/templates/web/nginx/socket.tpl ...</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat &gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/vesta/data/templates/web/nginx/socket.tpl &lt;&lt; EOF upstream %domain%_app_server { server unix:/tmp/%domain%.sock fail_timeout=0; } server { listen %ip%:%proxy_port%; server_name %domain_idn% %alias_idn%; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/domains/%domain%.error.log error; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/domains/%domain%.access.log; location /static/ { <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> %docroot%/static/; } location /media/ { <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> %docroot%/media/; } location / { proxy_set_header X-Forwarded-For \<span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; proxy_set_header Host \<span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; proxy_set_header X-Forwarded-Proto \<span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>; proxy_redirect off; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!-f \<span class="hljs-variable"><span class="hljs-variable">$request_filename</span></span>) { proxy_pass http://%domain%_app_server; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; } } include %home%/%user%/conf/web/nginx.%domain%.conf*; } EOF cat &gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/vesta/data/templates/web/nginx/socket.stpl &lt;&lt; EOF server { listen %ip%:%proxy_ssl_port%; server_name %domain_idn% %alias_idn%; ssl on; ssl_certificate %ssl_pem%; ssl_certificate_key %ssl_key%; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/domains/%domain%.error.log error; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/httpd/domains/%domain%.access.log; location /static/ { <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> %sdocroot%/static/; } location /media/ { <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> %sdocroot%/media/; } location / { proxy_set_header X-Forwarded-For \<span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; proxy_set_header Host \<span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; proxy_set_header X-Forwarded-Proto \<span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>; proxy_redirect off; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!-f \<span class="hljs-variable"><span class="hljs-variable">$request_filename</span></span>) { proxy_pass http://%domain%_app_server; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; } } include %home%/%user%/conf/web/snginx.%domain%.conf*; } EOF chown admin.admin /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/vesta/data/templates/web/nginx/socket*</code> </pre><br></div></div><br>  Further installation of packages: mongodb for quokka, supervisor of the third branch, and dev-packages: <br><br><div class="spoiler">  <b class="spoiler_title">yum install ...</b> <div class="spoiler_text"><pre> <code class="bash hljs">yum install mongodb-server -y chkconfig mongod on service mongod start yum install http://mirror.symnds.com/distributions/gf/el/6/gf/i386/gf-release-6-6.gf.el6.noarch.rpm -y yum --enablerepo=gf-plus install supervisor -y chkconfig supervisord on service supervisord start yum groupinstall <span class="hljs-string"><span class="hljs-string">"Development tools"</span></span> -y yum install ImageMagick-devel mysql-devel zlib-devel bzip2-devel openssl-devel ncurses-devel \ sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel libjpeg-devel \ libyaml-devel libffi-devel -y yum install git mercurial nodejs -y</code> </pre> <br></div></div><br>  And the last thing required from root is the supervisor setting: <br><br><div class="spoiler">  <b class="spoiler_title">cat /etc/supervisord.d/reguser.ini</b> <div class="spoiler_text"><pre> <code class="hljs ruby">[<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>djangocms.test.site] directory=<span class="hljs-regexp"><span class="hljs-regexp">/home/reguser</span></span><span class="hljs-regexp"><span class="hljs-regexp">/web/</span></span><span class="hljs-string"><span class="hljs-string">%(program_name)</span></span>s/public_html command=<span class="hljs-regexp"><span class="hljs-regexp">/home/reguser</span></span><span class="hljs-regexp"><span class="hljs-regexp">/.pyenv/shims</span></span><span class="hljs-regexp"><span class="hljs-regexp">/gunicorn -b unix:/tmp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/%(program_name)s.sock project.wsgi:application user=reguser autostart=true autorestart=true redirect_stderr=true [program:quokka.test.site] directory=/home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/reguser/web</span></span><span class="hljs-regexp"><span class="hljs-regexp">/%(program_name)s/public</span></span>_html command=<span class="hljs-regexp"><span class="hljs-regexp">/home/reguser</span></span><span class="hljs-regexp"><span class="hljs-regexp">/.pyenv/shims</span></span><span class="hljs-regexp"><span class="hljs-regexp">/gunicorn -b unix:/tmp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/%(program_name)s.sock manage:app user=reguser autostart=true autorestart=true redirect_stderr=true [program:redmine.test.site] directory=/home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/reguser/web</span></span><span class="hljs-regexp"><span class="hljs-regexp">/%(program_name)s/public</span></span>_html/ <span class="hljs-comment"><span class="hljs-comment">#command=/home/reguser/.rbenv/shims/unicorn -l /tmp/%(program_name)s.sock -E production command=/home/reguser/.rbenv/shims/thin start --socket /tmp/%(program_name)s.sock -e production user=reguser autostart=true autorestart=true redirect_stderr=true [program:refinerycms.test.site] directory=/home/reguser/web/%(program_name)s/public_html/ command=/home/reguser/.rbenv/shims/unicorn -l /tmp/%(program_name)s.sock user=reguser autostart=true autorestart=true redirect_stderr=true</span></span></code> </pre> <br></div></div><br>  That's all that is required from the super user. <br><br>  We add a user (reguser) to Vesta, enable SSH Access in bash and create 4 domains: <br>  <i>djangocms.test.site</i> , <i>quokka.test.site</i> , <i>redmine.test.site</i> , <i>refinerycms.test.site</i> . <br>  In the settings of each domain, we specify the previously added nginx profile called ‚Äúsocket‚Äù. <br>  Thus, nginx will listen to unix-sockets that will be created by the supervisor, with regular user rights. <br><br>  On the pages of each domain, the unpleasant ‚Äú502 Bad Gateway‚Äù will be displayed, which means we are on the right path. <br><br><h4>  Customization of the user environment </h4><br>  If in the "system" we have everything neatly, then in the "hamster" we will have many, many self-collection garbage. <br>  However, we will not see anything.  For us, all the dirty work will be done by PyEnv and RbEnv. <br><br><pre> <code class="bash hljs">su - reguser</code> </pre> <br>  First decide the issue RbEnv.  The <a href="http://rbenv.org/">significant</a> page of <a href="http://rbenv.org/">rbenv.org</a> will send us to the githab, where we are independently aware of the shims philosophy. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/sstephenson/rbenv.git ~/.rbenv <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'export PATH="$HOME/.rbenv/bin:$PATH"'</span></span> &gt;&gt; ~/.bash_profile <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'eval "$(rbenv init -)"'</span></span> &gt;&gt; ~/.bash_profile . ~/.bash_profile <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> rbenv git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build</code> </pre> <br>  We look at the available versions and collect the latest versions of the branches 2.0 and 2.2: <br><br><pre> <code class="bash hljs">rbenv install -l rbenv install 2.0.0-p643 rbenv install 2.2.1</code> </pre> <br>  Oddly enough, but PyEnv is a fork of RbEnv, more <a href="https://github.com/yyuu/pyenv">here</a> .  We do almost the same thing: <br><br><pre> <code class="bash hljs">curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'export PATH="$HOME/.pyenv/bin:$PATH" eval "$(pyenv init -)" eval "$(pyenv virtualenv-init -)"'</span></span> &gt;&gt; ~/.bash_profile . ~/.bash_profile pyenv install -l pyenv install 2.7.9 pyenv install 3.4.3</code> </pre> <br><h4>  Install Redmine </h4><br>  You must first create a mysql database in Vesta: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/web/redmine.test.site/public_html rm -rf * hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --updaterev 3.0-stable https://bitbucket.org/redmine/redmine-all . <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'production: adapter: mysql2 database: reguser_redmine host: localhost username: reguser_redmine password: "password" encoding: utf8 '</span></span> &gt; config/database.yml</code> </pre> <br>  Next, a very important line, it creates a .ruby-version file in the current directory, thereby indicating the desired version of shims.  The same thing happens with python versions with <i>pyenv local xxx</i> . <br><br><pre> <code class="bash hljs">rbenv <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 2.2.1 gem install bundler bundle install --without development <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> rake generate_secret_token RAILS_ENV=production rake db:migrate RAILS_ENV=production rake redmine:load_default_data</code> </pre>  The choice of thin or unicorn (as indicated in the supervisor): <br><pre> <code class="bash hljs">gem install thin <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'gem "thin"'</span></span> &gt;&gt; Gemfile gem install unicorn <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'gem "unicorn"'</span></span> &gt;&gt; Gemfile</code> </pre> <br>  The first went.  It remains to distort the supervisor from the console ' <i>supervisorctl restart redmine.test.site</i> ', or through the web the muzzle ... and the redmine is ready for work <a href="http://redmine.test.site/">redmine.test.site</a> : <br><br><img src="https://habrastorage.org/files/2d2/796/013/2d2796013e4a4347b4093b6901694b3f.png"><br><br><h4>  RefineryCMS installation </h4><br>  All the same, taking into account the official manual: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/web/refinerycms.test.site/public_html/ rbenv <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 2.0.0-p643 gem install rails --version 4.1.8 gem install execjs rails new . -m http://refinerycms.com/t/edge gem install unicorn</code> </pre> <br>  A page inviting you to create an admin is waiting for <a href="http://refinerycms.test.site/refinery">refinerycms.test.site/refinery</a> : <br><br><img src="https://habrastorage.org/files/785/3fb/288/7853fb2888364a44b341fff44a50d13b.png"><br><br><h4>  Installing DjangoCMS </h4><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/web/djangocms.test.site/public_html pyenv <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 3.4.3 pip install djangocms-installer</code> </pre> <br>  A dialogue will follow.  Choose ‚ÄúLanguages‚Äù = ‚Äúen, ru‚Äù, ‚ÄúTwitter Theme‚Äù = ‚Äúyes‚Äù, ‚Äúwith examples‚Äù = ‚Äúyes‚Äù.  The rest is the default. <br><br><pre> <code class="bash hljs">djangocms -p . project</code> </pre> <br>  Upon completion, they will be asked to provide a login password and postal address. <br><br><pre> <code class="bash hljs">python manage.py cms check <span class="hljs-comment"><span class="hljs-comment"># check cms pip install gunicorn</span></span></code> </pre> <br>  And here it is <a href="http://djangocms.test.site/">djangocms.test.site</a> : <br><img src="https://habrastorage.org/files/34e/15c/e57/34e15ce577ae4beda1e5235a8ee5cc25.png"><br><br><h4>  QUOKKA installation </h4><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/web/quokka.test.site/public_html git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/quokkaproject/quokka . pyenv <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 2.7.9 pip install -r requirements.txt sed -i <span class="hljs-string"><span class="hljs-string">"s|^GRAVATAR.*$|&amp;\n 'use_ssl': True,|"</span></span> quokka/settings.py python manage.py populate python manage.py createsuperuser ln -s quokka/static static pip install gunicorn</code> </pre> <br>  And here is the last beast <a href="http://quokka.test.site/">quokka.test.site</a> : <br><br><img src="https://habrastorage.org/files/580/bde/384/580bde3848eb4cf9b0fcefd738ccc3c5.png"><br><br>  It is worth noting that, unlike RbEnv / RVM, in PyEnv you can create virtualenv.  These things are not mutually exclusive. <br>  I hope my guide with the installation of various web applications was interesting. <br><br>  Thank. <br><br><div class="spoiler">  <b class="spoiler_title">In conclusion, cat</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/75e/86f/81a/75e86f81a9eb4fb8a72087f567ddaefb.png"><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/252955/">https://habr.com/ru/post/252955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252939/index.html">Link censorship by Skype (continued)</a></li>
<li><a href="../252941/index.html">Introduction to fetch</a></li>
<li><a href="../252943/index.html">Demo on Alcatel-Lucent booth, OpenTouch platform overview</a></li>
<li><a href="../252947/index.html">3/14/15 9:26:53 Century Celebration of the "Day of the Pi Number", as well as a story about how to get your very personal piece of pi</a></li>
<li><a href="../252949/index.html">Google Code closes and invites everyone to go to GitHub</a></li>
<li><a href="../252957/index.html">Powershell for testers</a></li>
<li><a href="../252959/index.html">Microsoft has released EMET 5.2</a></li>
<li><a href="../252963/index.html">How to steal money that is not. Or something new about cryptocurrencies</a></li>
<li><a href="../252965/index.html">Neuroplasticity in artificial neural networks</a></li>
<li><a href="../252967/index.html">How not to configure antifraud rules on user geography</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>