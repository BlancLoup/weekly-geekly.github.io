<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Scaling TLS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr, this is a report from one of the ‚Äúnon-main‚Äù halls of Highload ++ 2016. Artem Ximaera Gavrichenkov, technical director of Qrator Labs, talks abou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Scaling TLS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/570/e41/f97/570e41f97d4246b69713a978d2f6d09e.jpg"><br><br>  <i>Habr, this is a report from one of the ‚Äúnon-main‚Äù halls of Highload ++ 2016. Artem <a href="https://habrahabr.ru/users/ximaera/" class="user_link">Ximaera</a> Gavrichenkov, technical director of Qrator Labs, talks about application encryption, including in high-load projects.</i>  <i>Video and presentation at the end of the post - thanks to <a href="http://www.highload.ru/">Oleg Bunin</a> .</i> <br><br>  Greetings  We continue to be in the session about HTTPS, TLS, SSL and all that. <br>  What I‚Äôm going to talk about now is not some tutorial.  As my university lecturer on databases, Sergey Dmitrievich Kuznetsov, said: ‚ÄúI will not teach you how to set up a Microsoft SQL server ‚Äî let Microsoft do it;  I will not teach you how to configure Oracle - let Oracle do it;  I will not teach you how to configure MySQL - do it yourself. " 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the same way, I will not teach you how to configure NGINX - this is all on the site <a href="https://nginx.org/ru/">of Igor Sysoev</a> .  What we will discuss is a kind of general view of the problems and opportunities for solving problems that arise when implementing encryption on public services. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/592/5ee/c58/5925eec58f6b46889f13a8dbf70e7b00.png"><br><br>  A small excursion into a completely new history: as you know, recently the topic of encryption of public services has risen to some new level - it is well known and the slide above shows how approximately this happened. <br><br>  It all started in 2010, in my opinion, with the invention of the <a href="https://ru.wikipedia.org/wiki/SPDY">SPDY protocol by</a> Google, the de jure "Speedy" could work without encryption, but de facto its implementation depended on the expansion of NPN ( <a href="https://tools.ietf.org/html/draft-agl-tls-nextprotoneg-00">Next Protocol Negotiation</a> ), which was in TLS'e - and in the standard TCP transport layer protocol it was not.  Therefore, SPDY did not work de facto without encryption. <br><br>  For a long time in the industry there were disputes and lively discussions on the topics: ‚ÄúDoes Speedy Help?‚Äù;  ‚ÄúDoes he accelerate work?‚Äù;  ‚ÄúDoes it reduce the load or not?‚Äù During this time, many managed to implement it and many people ended up with encryption in one way or another. <br><br>  4 years have passed and Google search staff <a href="https-as-ranking-signal.html">announced in their blog</a> that from now on (2014), the presence of the HTTPS site will improve the ranking of the site when it comes out in search.  This has become a serious acceleration - not everyone thinks about user security, but almost everyone thinks about the place in search results. <br><br>  Therefore, from this point on, HTTPS began to be used by those who had never thought about it before, and had not seen such a problem for themselves. <br><br>  A year later, the HTTP / 2 standard was finalized and published, in which, again, the requirement that it should work only on top of TLS was not recorded.  However, de facto, every modern browser in HTTP / 2 without TLS is not able.  And finally, in 2016, a number of companies, with the support of the Electronic Frontier Foundation, founded the non-commercial project Let's Encrypt, which issues certificates to everyone automatically, quickly and free of charge. <br><br><img src="https://habrastorage.org/files/c56/450/b1b/c56450b1b0e043a4ae73b1a0a63edf65.png"><br><br>  Something like this is a graph of the number of active Let's Encrypt certificates issued, the scale in millions.  The implementation is very active, the other statistics below are from Firefox telemetry. <br><br><img src="https://habrastorage.org/files/ff9/4ed/2ec/ff94ed2ecee04b5f95262b4e257ec13c.png"><br><br>  During the year from November 2015 to November 2016, the number of web pages visited by Firefox users on HTTPS, in comparison with HTTP, increased by a quarter to a third.  Thank you very much for this Let's Let's Encrypt and, by the way, they have started (and <a href="https://www.generosity.com/community-fundraising/make-a-more-secure-web-with-let-s-encrypt">have already ended</a> ) the crowdfunding campaign, so do not pass by. <br><br>  This is only one side of the story - speaking about it, it is impossible not to mention the second thread. <br><br><img src="https://habrastorage.org/files/9d2/51e/291/9d251e291560471abffd50560c7953fe.png"><br><br>  It concerns the revelations of a well-known employee of the corporation Booz Allen Hamilton.  Who knows who I am talking about?  Edward Snowden, yes. <br><br>  At that time, this served as some marketing towards HTTPS: "We are being watched, let's protect our users."  Google, after another revelation was published about the fact that the NSA "sort of" intercepted internal communications in Google's data center.  The company's engineers wrote <a href="https://plus.google.com/%2BBrandonDowney/posts/SfYy8xbDWGG">obscene words</a> in their blog about the US government and encrypted all internal communications as well. <br><br>  Accordingly, about a month later a post about HTTPS accounting was published during ranking - <i>some conspiracy therapists may see some connection in this event</i> . <br><br>  Since that time, that is, 2013-2014, we have two factors for promoting TLS and it has really become popular.  It became so popular that, as it turned out, the encryption infrastructure and libraries were not ready for such popularity. <br><br><img src="https://habrastorage.org/files/61b/ce8/ea3/61bce8ea3f714e28955c776bc30d0dfd.png"><br><br>  In 2014, as many as two critical vulnerabilities were discovered in the most popular, at that time, SSL library.  Someone even tried to move on this issue to another popular alternative - TLS, which turned out to be even worse.  The IETF in February 2015 even issued a separate RFC, which described the well-known attacks on TLS and datagram TLS (over UDP).  This is documentary evidence of the high optimism of the IETF working group, because in February 2015 they announced that they "will now sum up all attacks," and since then there have been three more. <br><br><img src="https://habrastorage.org/files/9a6/5f7/7d4/9a65f77d47e1493ab5a64b3753f3f04f.png"><br><br>  And the very first of them was found 20 days after the RFC was published.  In fact, this story is about that - in the discipline of project management can be found mention of such a term as "technological debt". <br><br>  Relatively speaking, if you solve some problem and you understand that its solution will take 6 months, but you need 3, and if you put a crutch <i>here</i> , then in principle you can do it in three months - in fact, at this moment you take the universe has time in debt.  Because the crutch, which will be substituted, sooner or later will collapse - you have to fix it.  If there are a lot of such crutches, then a ‚Äútechnological default‚Äù will occur and you simply cannot do anything new until you disassemble everything old. <br><br>  Encryption as it was at the end of the 2000s was made by enthusiasts.  But when the people really began to use it, it turned out that there were a lot of jambs and they needed to be somehow corrected.  And the most important joint is the awareness of the target audience, that is, you, about how it all works and how to tune it. <br><br>  Let's go over and look at the main points with a sight, just for a big setup. <br><br>  Let's start with platitudes.  To raise a service ‚Äî you need to configure it; in order to configure it ‚Äî you need a certificate so that you have to buy a certificate.  <b>Who?</b> <br><br><img src="https://habrastorage.org/files/ae1/2ec/af6/ae12ecaf6836431686d126fc5e078832.png"><br><br>  The SSL and TLS protocols naturally include the public key infrastructure.  There is a set of certificate authorities, respectively, if you have a service - it must have a certificate that can be signed either by a certificate authority or by someone whom it has signed.  That is, an unbroken chain must be built from you to someone whom the browser and user device trust.  To whom?  For example: <br><br><img src="https://habrastorage.org/files/57b/ff6/ea6/57bff6ea663f4818933d0b6897e05657.png"><br><br>  I downloaded vanilla Firefox and there are about 100 pieces of certificates - trusted certificate authorities.  That is, you have a large choice, in the sense of buying a certificate. <br><br><h3>  What are these hundreds of companies? </h3><br><img src="https://habrastorage.org/files/63d/283/d08/63d283d084694d998495d0087685c122.png"><br><br>  According to the ideology, these companies can be trusted because signing certificates, tracking security, is their main business.  Skipping this is difficult, otherwise the company will simply go bankrupt - a simple economic model.  It should have been relatively small companies that are independent of large corporations and independent of governments.  Well, not counting the fact that some of them are the government, in particular, the Japanese, Taiwan and Valencia. <br><br><img src="https://habrastorage.org/files/300/cfb/e09/300cfbe09eb143cc857f288d8c943be1.png"><br><br>  And others were bought by large corporations for awesome sums. <br><br><img src="https://habrastorage.org/files/f20/56a/e6f/f2056ae6fbe447e6a946c46999107278.png"><br><br>  Thus, to date, we can not say with certainty how certain certification centers behave.  They should have and must still protect their interests as a player in the market, as a certificate authority.  But, again, if you are a government employee or belong to a large organization, then if a large client comes to her who wants to do something for a lot of money, then you are ordered to do it.  The question is what can you do about it. <br><br><img src="https://habrastorage.org/files/86e/715/2b2/86e7152b2f194eca9b0662faf04fca84.png"><br><br>  How did it happen that the original model works so strangely now?  Why are these companies owned, for example, the Ministry of Communications and Communications of China (which your browser trusts) still remain certification centers? <br><br>  The point here is that it is quite difficult to stop being a certificate authority. <br><br><img src="https://habrastorage.org/files/0bd/c7c/b59/0bdc7cb595364bb7b4354c005fe0312a.png"><br><br>  The Visual History is a certificate authority called <a href="https://www.wosign.com/english/">WoSign</a> .  If I'm not mistaken, since 2009 he has been a trusted certificate authority in all popular browsers and operating systems.  He became the center of a fairly correct trajectory after an audit of Ernst &amp; Young (now E &amp; Y), organized an aggressive marketing campaign and distributed certificates to everyone right and left, and everything was fine. <br><br><img src="https://habrastorage.org/files/6fd/a2e/d25/6fda2ed2569546d3aa65934dfa06c3a0.png"><br><br>  In 2016, Mozilla Foundation employees wrote a whole page on their Wiki with a list of various violations that WoSign allowed at different times.  Basically, these violations are dated 2015-2016. <br><br>  What were they?  As you know, you can not get a certificate for the "left" domain.  You must somehow prove that you are the owner of this domain - as a rule, you must either receive something by physical mail, or place a certain token on the site at a strictly defined address.  WoSign at least once issued a certificate for AliCDN, which was not requested by AliExpress itself (they use the services of Symantec) - however, the certificate was issued and published. <br><br><img src="https://habrastorage.org/files/4f9/e1e/016/4f9e1e01628c43a7833df2373cb66450.png"><br><br>  WoSign allowed to use non-privileged ports for verification - that is, any user (not only the administrator) of this server could receive a certificate for any domain on this server hosted.  WoSign allowed the use of domains 3, 4 and the following levels for verification of the second level domain.  Thus, the researchers, within the framework of the WoSign resistance test, managed to get a valid certificate for GitHub. <br><br><img src="https://habrastorage.org/files/935/dd0/141/935dd0141ff94c2c81bcdaaa550c28eb.png"><br><br>  WoSign allowed to use any files, that is, to specify an arbitrary path on the site where the token will be placed - thus, the researchers managed to get signed certificates for Google and Facebook. <br><br><img src="https://habrastorage.org/files/650/edf/623/650edf6235f84310a2d375e3d4844a54.png"><br><br>  Well, in principle, this is all nonsense, because under certain conditions, WoSign made it possible to issue any certificate for any domain without checking at all (laughter in the audience). <br><br>  After this, all the little things fade into the background, but all was Mozilla led about 13 complaints.  WoSign issued certificates in hindsight, using software on the validation server that did not have patches, including updating the parts responsible for security, for many years. <br><br><img src="https://habrastorage.org/files/92e/a14/e44/92ea14e447d94f1781950076df89e6cc.png"><br><br>  WoSign bought StartCom and refused to publish any information, which violates the policies of the Mozilla Foundation, but in comparison with everything else, it is not so painful. <br><br><h3>  What is the result? </h3><br><img src="https://habrastorage.org/files/ed0/478/5e8/ed04785e8e1647da8f70bf8fc1e124b0.png"><br><br>  In September of this year, WoSign was banned for a year in Chrome and Firefox, but Microsoft still continues to trust Microsoft and the Windows operating system. <br><br>  You can not just stop being a certificate authority. <br><br>  And we say this, in fact, about trifles.  If you talk about the same Verisign (Symantec), then you need to understand that you can‚Äôt just take and withdraw the Symantec root certificate, because they signed the same AliExpress, they signed Google, they signed a lot of people and users will have problems with access to resources.  Therefore, one way or another, by clicking the fingers, as it was once supposed, it is impossible to revoke a certificate. <br><br>  Large certificate authorities, there is such an expression, they are ‚Äú <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D647959">Too big to fail</a> ‚Äù - too large to cease to exist. <br><br>  There is an alternative to the TLS (Public Key Infrastructure) PKI, it is called <a href="https://tools.ietf.org/html/rfc6698">DANE</a> , built around DNSSEC, but it has so many infrastructure problems ‚Äî including delays and delays ‚Äî that it‚Äôs pointless to talk about it now, you need to somehow live. <br><br><h3>  How to live with it? </h3><br>  I promised to give advice on how to choose the Certificate Authority.  Based on the above, my advice is as follows: <br><br><img src="https://habrastorage.org/files/5b1/ab2/31c/5b1ab231c2984422ae50ca8b7ba2a34f.png"><br><br>  <b>Take for free</b> - there won't be much difference. <br><br>  If there is an API that allows you to automate the issue of certificate and warm-up certificates - great. <br><br>  The second useful advice today (that is, we are talking about a distributed structure with a lot of balancers) - get not one certificate, but two or three certificates.  Buy one from Verisign, the second from the Polish Unizeto, and get the third for free from Let's Encrypt.  This does not greatly increase OPEX (operating costs), but it will seriously help you in case of unforeseen situations, which we will talk about later. <br><br><img src="https://habrastorage.org/files/c25/b2c/718/c25b2c7185204fc39c9a9f5610076ba9.png"><br><br>  The question immediately: ‚ÄúHere, Let's Encrypt do not write out extended validity certificates (extended validity period and a beautiful green icon in the browser), what to do about it?‚Äù In fact, this is a <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25B0%25D1%2582%25D1%2580_%25D0%25B1%25D0%25B5%25D0%25B7%25D0%25BE%25D0%25BF%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8">security theater</a> , because there are few who don‚Äôt It looks, so the mobile browser in Windows Phone does not even know how to display this icon.  The user does not look at the presence of the icon in principle, not to mention its color. <br><br><img src="https://habrastorage.org/files/654/6d9/539/6546d95393514d7b92fa0c2e97e1d271.png"><br><br>  Therefore, if you are not a bank and your security audit does not force you to buy extended validity, there will be no real benefit from it. <br><br><img src="https://habrastorage.org/files/e6e/8dd/b03/e6e8ddb03e7b4213ad40f6aede58ea01.png"><br><br>  It is better to buy certificates with a short period of validity, because if something happens to the Certificate Authority, you will have room to maneuver.  Diversify. <br><br><img src="https://habrastorage.org/files/856/c67/8a2/856c678a21e748a99abf478ef3d0efec.png"><br><br>  Let's talk more about the lifetime of certificates.  Long-lived certificates (a year or two or three) have a number of advantages.  For example, the fifth point does not hurt, when you do not need to renew the certificate every 2-3 months - you put it once and forgot it for three years.  In addition, certificate authorities usually offer significant discounts to those who buy certificates for a year, three and five years. <br><br><h3>  At this point, the pluses end and the minuses begin. </h3><br><img src="https://habrastorage.org/files/d6f/7f8/321/d6f7f832101f40fc897348d46f504ca2.png"><br><br>  If something happened over the certificates, for example, you lost the private key and it went to someone else - there is a mechanism in TLS that allows you to revoke the certificate back.  Called CRL and OCSP, there are two of them.  The problem is that at the moment they both work in the soft fail mode, that is, if the browser failed to connect to the CRL server and check the status of the certificate, then ‚Äúand hell with it‚Äù - the certificate is supposedly normal. <br><br>  Adam Langley of Google compared the soft fail CRL and OCSP with a seat belt in a car that is constantly stretched, and when you get into an accident it breaks.  There is no sense in this, because the same attacker who can do man in the middle and substitute a stolen key - he can also block access to the CRL and OCSP, so these mechanisms simply will not work. <br><br>  Hard fail CRL and OCSP, that is, those that will display an error if the CRL server is unavailable, are currently not used by almost anyone. <br><br>  And again about the pain in the fifth point - yes, it is inevitable.  But to be honest, you still have to automate the deployment of the certificate.  Deployment is just what needs to be done, because replacing a certificate with your hands is the same technical debt. <br><br><img src="https://habrastorage.org/files/8c9/bd3/49a/8c9bd349acbb459a9227a6ab22e2f3cd.png"><br><br>  It will not bite you instantly, but sooner or later problems can begin. <br><br><img src="https://habrastorage.org/files/b03/235/f5d/b03235f5d09941b5a1e22ba54f965bae.png"><br><br>  What does automated certificate management allow?  You can add, delete and change them with one finger movement.  You can release them with a short period of validity, you can use a lot of keys, you can configure client authorization by certificates.  You will be able to very easily and very quickly handle situations from the series: ‚ÄúOps, the intermediate certificate was withdrawn from our certification center‚Äù.  This is not a theoretical story - it happened in October 2016. <br><br><img src="https://habrastorage.org/files/529/ce5/d50/529ce5d5095a4924bdcc0964c12d92a3.png"><br><br>  One of the largest CA - GlobalSign, with a long history and very reliable, in October 2016 carried out technical work on the reclassification of root and intermediate certificates ... and accidentally withdrew all its intermediate certificates.  Engineers quickly found the problem, but you need to understand that the CRL and OCSP include all browsers of all users - this is a fairly loaded service.  GlobalSign, like everyone else, uses the CDN for this purpose, which was Cloudflare in the case of GlobalSign and, for some reason, Cloudflare was unable to promptly reset the cache - incorrect lists of revoked certificates continued to crawl on the Internet for several hours. <br><br><img src="https://habrastorage.org/files/a57/d83/7aa/a57d837aa74f48afa6656f424b420bf4.png"><br><br>  And cached in browsers.  Moreover, the CRL and OCSP cache in the browser and the operating system work for about four days.  That is, for four days, an error message was displayed when trying to access Wikipedia, Dropbox, Spotify, and Financial Times ‚Äî all of these companies suffered.  Of course, there are options for a more rapid solution to this problem, and they, as a rule, consist in changing the certificate authority and changing the certificate - then everything will be fine.  But this still needs to be reached. <br><br>  Note that in a situation where everything depends on CDN, everything depends on attendance - that is, whether the wrong answer had time to cached on this CDN node, sites with high attendance suffer more, because the likelihood is much higher. <br><br><img src="https://habrastorage.org/files/08a/979/854/08a979854d5c4013a79710763238622d.png"><br><br>  We said that ‚Äúto solve the situation is simple - you need to replace the certificate,‚Äù but first you need to understand what is happening.  What is the situation with revoked root certificates from the point of view of the resource manager? <br><br>  Prime time, everything is fine, the load is below average - there are no problems, nothing gets out of monitoring ... and at the same time traffic has dropped by 30%.  The problem is of a distributed nature and it is very difficult to catch it - you need to understand that here you depend on the vendor, not controlling either the CRL or the OCSP, therefore an unknown damned nonsense occurs and you don‚Äôt know what to do. <br><br><img src="https://habrastorage.org/files/4cd/aac/0c5/4cdaac0c510c454e8babc174abf6c4ac.png"><br><br><h3>  What helps to find such problems </h3><br>  Firstly, if you have a lot of balancers and certificates for them from different vendors (as we said), you will see a correlation.  Where there was a certificate from GlobalSign - problems started there, on the other balancers everything is fine - that's the connection. <br><br>  It should be understood that there were no distributed services for checking the CRL and OCSP as of November 2016.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, there was no service simultaneously distributed enough to monitor Cloudflare and at the same time able to walk in CRL and OCSP for an arbitrary domain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But we still have a tool called tcpdump, which also clearly shows what the problem is - sessions break at about the time of the ‚ÄúTLS server hello‚Äù, that is, it‚Äôs obvious that the problems are somewhere in TLS, which means that although would be pretty clear where to look. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An additional advantage of the fact that you have different keys on different machines is that if one of them is leaked, then at least you will find out where. That is, you can write root cause analysis.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some deployment ideology says that the private key should never leave the machine on which it was generated. This is ‚Äútechnological nihilism‚Äù, but such a situation exists. </font></font><br><br><img src="https://habrastorage.org/files/941/db0/ef8/941db0ef8e01456ca95d6d680d5ec904.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Returning to the story with GlobalSign, we see that TLS is still at the forefront of technology. However, we still have insufficient tools and still insufficient understanding of why such problems will arise. </font></font><br><br><img src="https://habrastorage.org/files/591/50a/d85/59150ad85dd1499a94427d8bfe1ad742.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the search for the source of the problems can be spent hours, and when it is discovered, it should be solved very quickly. Therefore - automation of certificate management. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This requires either a certificate authority providing an API - for example, Let's Encrypt, which is a good choice if you do not need a </font></font><a href="https://en.wikipedia.org/wiki/Wildcard_certificate"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wildcard certificate.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In 80% of cases, you do not need a wildcard, since it is primarily a way to save money - buy not 20 certificates, but one. </font><font style="vertical-align: inherit;">But since Let's Encrypt gives them away for free, you may not need a wildcard. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, there is also a toolkit for automating certificate management with other certificate authorities, such as SSLmate and similar things. </font><font style="vertical-align: inherit;">Well, in the end, if none of this suits you, you will have to write your own plugin for Ansible. </font></font><br><br><img src="https://habrastorage.org/files/6c8/ca6/769/6c8ca67697cd4058831132e637bee755.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, 25 minutes of the report passed, the 50th slide is before us and we were finally able to buy a certificate (laughter in the hall).</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to tune it? </font><font style="vertical-align: inherit;">At what points should stop?</font></font></h3><br><img src="https://habrastorage.org/files/453/4a9/a94/4534a9a9478c48a8afa05c05ff699098.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first is that HTTP describes a header called Strict Transport Security, which indicates that: for those clients who once came to it via HTTPS, that later it is worth going to it via HTTPS, and never going to HTTP. This header should be on any server that supports HTTPS simply for the reason that voluntary encryption from the series ‚Äúif it works out to encrypt, we work, but no, it doesn't‚Äù simply does not work. Tools like the SSLstrip are already too popular. Users will not look ‚Äúthere is a lock or not‚Äù - they will simply work with the page, so their browser must remember and know in advance that you need to go via HTTPS. HTTPS only makes sense when it is enforced.</font></font><br><br><img src="https://habrastorage.org/files/284/643/57f/28464357fd994747b49d7a3003c20b01.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another useful header is Public Key Pinning, that is, when binding a public key, and we said earlier that it‚Äôs difficult for us to trust certification authorities, so when a user visits the site we can give him a list of public key hashes that can be used to identify this site. That is - other certificates, besides those listed, cannot be used by this site. If the browser sees such a certificate, it is either a theft or some kind of fraud.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, Public Key Pinning also needs to include all keys that will be valid for a period - that is, if you set up for a period of 30 or 60 days, you must have hashes of all certificates that will be on this site for 30 or 60 days . All future certificates that you just release now, and will only be used in a month. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Again, it‚Äôs very difficult to do with your hands, it‚Äôs a big pain, so automation is needed.</font></font><br><br><img src="https://habrastorage.org/files/d7c/e29/b9f/d7ce29b9fbe245bd85e6a224bb9dc1b8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other issues are ciphers. The Mozilla wiki has a link where you can find a config generator for almost all popular web servers: NGINX, Apache, HAProxy, and lighttpd (if someone has one). Go there periodically, go there often - it may be worth automating this process somehow. If you have a regular cryptographer, then everything is fine, but it is not clear what you are doing here. If you do not have a full-time cryptographer, then the Mozilla Foundation has it. It follows that all the necessary changes in ciphers - all the work that cryptographers do in an attempt to understand ‚Äúhow ciphers can be vulnerable‚Äù is available on this page. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a golden rule of cryptography: ‚ÄúDo not invent your own cryptography‚Äù. it refers not only to development, but also to administration.</font></font><br><br><img src="https://habrastorage.org/files/bf8/465/cf1/bf8465cf189b447dbb533dd25feb39ec.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are a lot of unobvious things, for example - this is the list of those ciphers that Mozilla recommends installing by default. Note that underlined - two identical cipher, fully, which must be supported by the server and issued to the client in the list of available. They differ only in that one of them is an AES cipher with a key length of 256, and the other is 128 in length. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the cipher with a length of 128 is sufficiently reliable, why do we need 256? If there is 256, why do we need 128? Who knows why? </font></font><br><br><img src="https://habrastorage.org/files/b6e/12f/9a8/b6e12f9a89a44929afdf9f9103b7be80.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let me tell you a story about Randall (Rijndael) - the name sounds like it's already some Tolkien.</font></font><br><br><img src="https://habrastorage.org/files/2fc/933/30c/2fc93330c36948fdbeafc3543d4f36d5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The AES encryption standard was ordered by the US federal government in 1998: a competition and tender was organized that won the French cipher Rijndael (the word is so strange because it is made up of the names of its two inventors ‚Äî and both are French). In 2001, the code was finally approved by the NSA and began to be used, including in the Department of Defense and the US Army. And here the developers of the cipher came across the requirements of the American army, which, to put it mildly, are outdated. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What were they?</font></font></b> <br><br><img src="https://habrastorage.org/files/66d/b0a/882/66db0a88295c4d62a389ac15b7e46767.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The military demanded that the cipher provided had 3 levels of security. Three different security levels. Moreover, the weakest of them is used for the least important data, and the most stable one is used for the most important data (directly Top Secret). Cryptographers faced with this situation very carefully read the requirements for the tender and found out that there is no requirement that the weakest cipher was not strong - so they issued ciphers with three levels of keys, where even the weakest (128-bit) still cannot be cracked / decrypted in the foreseeable future.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, AES-256 is an absolutely redundant thing that was needed because the military wanted it so much. </font><font style="vertical-align: inherit;">AES-128 is quite sufficient today, but it already has very little value, because AES supports in most modern processors - out of the box and at the level of iron, so we do not bother about this topic. </font><font style="vertical-align: inherit;">I am telling this as an illustration of the fact that in the list of ciphers that is published by the Mozilla Foundation there will be things that you may not be obvious.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Or here's another example. </font></font></h3><br><img src="https://habrastorage.org/files/841/984/fa2/841984fa2ea74611922ed80c5ea508c6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How modern encryption may not be obvious to the average person. There is such a property of session encryption algorithms called </font></font><a href="https://ru.wikipedia.org/wiki/Perfect_forward_secrecy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perfect Forward Secrecy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it does not have a normal translation into Russian, so everyone uses the English term. This property is Perfect Forward Secrecy has a lot of cipher, including ephemeral </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB_%25D0%2594%25D0%25B8%25D1%2584%25D1%2584%25D0%25B8_%25E2%2580%2594_%25D0%25A5%25D0%25B5%25D0%25BB%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">varieties of the protocol Diffie-Hellman'a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , very common. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This property implies that as soon as the session key is generated, it cannot be recovered or hacked using the original private key, the one that corresponds to the public key and is recorded in the certificate.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Perfect Forward Secrecy property makes it impossible to passive traffic analysis and analysis in what is called out-of-path analysis - analysis of the saved traffic history is impossible. There are very many DPIs and WAF solutions, because about 70% of HTTPS requests use certain types of algorithms that support PFS and pass through these DPI solutions like a knife through butter, without any analysis. Moreover, of these 70% of traffic, about 10% is legitimate traffic, and the rest is bots and hackers who know how to get through the DPI. Maybe at that moment someone already knew where I was going.</font></font><br><br><img src="https://habrastorage.org/files/ae8/3a2/ef2/ae83a2ef24c14d99b01316a166400bb0.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If it so happens that the state requires you to reveal the private keys of your service and transfer them to the opportunity to decrypt the traffic that was once collected and stored three months before, thanks to PFS and Diffie-Hellman, we can only wish good luck of the way. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Protocol summary </font></font></h3><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is no doubt that SSLv2 (version two) is already dead. If someone has it, stop using it right now, this is a very carelessly written protocol. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SSLv3 and TLSv1.0 are exactly the same dead and should not be used with the exception that TLS is not supported in IE6 at all, thank God very few people use it at the moment, but in principle such people still remain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More importantly, a whole bunch of TVs do not support TLS in principle, it only supports older versions of the SSL protocol. Some chatter is connected with this around certification of systems for work with payment cards - </font></font><a href="https://ru.wikipedia.org/wiki/PCI_DSS"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCI DSS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Just over a year ago, the PCI DSS Board decided that, starting in June 2016, SSLv3 and early versions of TLS (that is, version 1.0) cannot be used on services that process public card data. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In principle, reasonable requirements, with the exception that a bunch of vendors then grabbed rusty agricultural killing tools and went to the PCI DSS board with the words: ‚ÄúIn this case, we cannot work with either TVs or old smartphones ‚Äî these are huge amounts of traffic.‚Äù and we can not do anything ourselves. " </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In February 2016, the PCI DSS Board postponed the fulfillment of this requirement either until 2018, or 2019. We stop here and sigh, because SSL of any version is vulnerable, and TLS of any version is not supported by a bunch of TVs, in particular Korean ones.</font></font> It's a shame. <br><br><img src="https://habrastorage.org/files/586/04e/dbe/58604edbece34d7dac20c106e6724753.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nevertheless, the TLS protocol continues to live and develop (with the exception of version 1.0). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The current version is 1.2 and is currently in development 1.3. And it is possible that TLS is growing even too quickly, because in TLS 1.2 version there was an opportunity to implement a rather interesting mechanism: to force the server to sign a strictly defined token shipped to it by the client and, accordingly, to receive this signature, under certain conditions. That is, we can say that: ‚ÄúWe went over an encrypted connection to this server, so many times, during such a certain period of time‚Äù. What is the necessary prototype for the organization of the blockchain - please, </font></font><a href="https://github.com/ewust/DDoSCoin"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDoSCoin cryptocurrency</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a concept, and on GitHub there is a rather detailed document and you can look at the code.</font></font><br><br><img src="https://habrastorage.org/files/49d/9d0/23e/49d9d023e8684c75a3caea224debb04c.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, literally tops </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OCSP stapling is a very useful thing. </font><font style="vertical-align: inherit;">We have already said that OCSP certificate revocation is soft fail. </font><font style="vertical-align: inherit;">On the other hand, it is possible to implement OCSP stapling - when the server itself goes to the validation server and receives the necessary signature from there, which it then gives to the client. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For most high-load sites, certificate authorities may even require such a thing, since it is unprofitable for them to take on such a burden. </font><font style="vertical-align: inherit;">Keep it yourself.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem is that in some cases OCSP stapling results in a real hard fail and, for example, if the OCSP server for a certification authority is not available for a certain time and you do not have time to get a valid signature from it for a particular moment, then you have a downtime and you are offended . Therefore, before you enable stapling, you need to get the data and understand who your certification authority is at the moment and what is its structure. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, when implementing TLS, you need to understand that </font></font><a href="https://ru.wikipedia.org/wiki/TLS"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TLS'ny handshake</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is expensive and time </font><a href="https://ru.wikipedia.org/wiki/TLS"><font style="vertical-align: inherit;">consuming</font></a><font style="vertical-align: inherit;"> . That is, the packet-rate increases, the load, the pages slowly open - so even if you didn‚Äôt use keep-alive connection with a certain lifespan for some reason, Adam Langley himself ordered in TLS.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another important thing that I will not dwell on in detail is that if you have some kind of unencrypted content, you need to do something about it. </font><font style="vertical-align: inherit;">If you are a large company with a large infrastructure, then you can come to your banner network and say: "Give me this in encrypted form." </font><font style="vertical-align: inherit;">Because if you are a small service, then in return you will not hear anything good.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Three final points that should be stored in memory </font></font></h3><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Use short-lived certificates </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Automate everything </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Believe the fund Mozilla - he will not say bad </font></font></li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/s5mQnYJAJ60" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/326824/">https://habr.com/ru/post/326824/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326812/index.html">International Space Apps Challenge: NASA Hackathon</a></li>
<li><a href="../326814/index.html">Working with ConstraintLayout via XML Markup</a></li>
<li><a href="../326816/index.html">Let's start with mathematics. Vectorization of calculations in the implementation of technology RAID-6</a></li>
<li><a href="../326818/index.html">Week before the International Mobile Conference MBLT17</a></li>
<li><a href="../326822/index.html">The main thing is the tail. Software development pipeline technology</a></li>
<li><a href="../326826/index.html">Bash Scripts, Part 5: Signals, Background Tasks, Script Management</a></li>
<li><a href="../326828/index.html">Permafrost, coal mine and piqlFilm: a new approach to data storage and protection</a></li>
<li><a href="../326830/index.html">We write Telegram-bot on Rust, which will run the code on ... Rust?</a></li>
<li><a href="../326832/index.html">How to approach the analysis of the site in terms of a hacker and identify vulnerabilities?</a></li>
<li><a href="../326834/index.html">Amateur CNC?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>