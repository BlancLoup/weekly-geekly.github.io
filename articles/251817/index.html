<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Check LibreOffice project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We offer the reader another article about checking the well-known open-source project. This time we checked the LibreOffice project, which is an offic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Check LibreOffice project</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/535/cb5/fb5/535cb5fb57b5f402a36685444634f1a4.png" align="left">  We offer the reader another article about checking the well-known open-source project.  This time we checked the LibreOffice project, which is an office suite.  More than 480 programmers take part in its development.  The code turned out to be a very high quality and regularly tested static Coverity analyzer.  But, as in any other large project, new errors and omissions were found, which we will describe in the article.  For a change, this time we will be accompanied not by unicorns, but by cows. <br><a name="habracut"></a><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1502">LibreOffice</a> is a powerful office suite, fully compatible with 32/64-bit systems.  Translated into more than 30 languages ‚Äã‚Äãof the world.  Supports most popular operating systems, including GNU / Linux, Microsoft Windows and Mac OS X. <br><br>  LibreOffice is free and open source.  Written in languages: Java, Python, C ++.  The part of the project that was written in C ++ (and a little bit in C, <a href="http://www.viva64.com/go.php%3Furl%3D1485">C ++ / CLI</a> ) was subjected to analysis.  Version: 4.5.0.0.alpha0 + (Git revision: 368367). <br><br>  The analysis was performed using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static code analyzer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider what errors were found, and what can be done with them.  I want to note that some errors may not be errors.  I am not familiar with the code, and could have mistaken a completely correct code.  However, since this code is confusing the analyzer and me, something is wrong.  This code smells, and it is good to refactor it in order to reduce the likelihood of its misunderstanding in the process of project development. <br><br><h2>  Typos </h2><br>  Any code is not without typos.  Many, of course, are and are corrected at the testing stage, but some remain to live inside programs for a long time.  As a rule, they are in rarely used functions or do not have a strong influence on the operation of the program. <br><br>  For example, we encountered the following comparison function, which only works for one third: <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SvgGradientEntry</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>==(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SvgGradientEntry&amp; rCompare) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getOffset() == rCompare.getOffset() &amp;&amp; getColor() == getColor() &amp;&amp; getOpacity() == getOpacity()); } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0090/">warning</a> : <a href="http://www.viva64.com/ru/d/0090/">V501</a> operator: getColor () == getColor () svggradientprimitive2d.hxx 61 <br><br>  This mistake probably doesn‚Äôt do much harm.  Probably, this operator '==' is not used at all.  However, once the analyzer was able to find this error, it will be able to find more serious ones immediately after writing a new code.  Therefore, the main value of static analysis is not in one-time runs, but in regular use. <br><br>  How could one try to avoid such an error?  I do not know.  Perhaps, if we train ourselves to more carefully align the blocks of the same type of code, then the error would be more noticeable.  For example, the function can be arranged as follows: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>==(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SvgGradientEntry&amp; rCompare) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getOffset() == rCompare.getOffset() &amp;&amp; getColor() == getColor() &amp;&amp; getOpacity() == getOpacity(); }</code> </pre> <br>  Now it has become more noticeable that in the right column there is not enough ‚ÄúrCompare‚Äù.  Although to be honest, not very noticeable.  May not help.  Humans tend to make mistakes.  And therefore the static analyzer is a good helper. <br><br>  And here is an example where a typo could clearly have been avoided.  Someone unsuccessfully wrote code to exchange values ‚Äã‚Äãbetween two variables. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f0/4c5/7fb/6f04c57fbb36c0d0a526e399f1ec4656.png"><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TabBar::ImplGetColors(....) { .... aTempColor = rFaceTextColor; rFaceTextColor = rSelectTextColor; rSelectTextColor = rFaceTextColor; .... }</code> </pre> <br>  PVS-Studio warning: <a href="http://www.viva64.com/ru/d/0190/">V587</a> An odd sequence of assignments of this kind: A = B;  B = A ;.  Check lines: 565, 566. tabbar.cxx 566 <br><br>  In the last line, instead of 'rFaceTextColor' one should use 'aTempColor'. <br><br>  There was no need to write code for exchanging values ‚Äã‚Äã"manually."  It would be easier and more reliable to use the standard function std :: swap (): <br><pre> <code class="cpp hljs">swap(rFaceTextColor, rSelectTextColor);</code> </pre> <br>  We continue.  I think it is impossible to defend myself from the next mistake.  Pure typo: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SAL_CALL Theme::disposing (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { ChangeListeners aListeners; maChangeListeners.swap(aListeners); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lang::<span class="hljs-function"><span class="hljs-function">EventObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aEvent</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">static_cast</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;XWeak*&gt;(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ChangeListeners::const_iterator iContainer(maChangeListeners.begin()), iContainerEnd(maChangeListeners.end()); iContainerEnd!=iContainerEnd; ++iContainerEnd) { .... } }</code> </pre> <br>  PVS-Studio warning: V501 operator: iContainerEnd! = IContainerEnd theme.cxx 439 <br><br>  The loop will not be executed, since the condition ‚ÄúiContainerEnd! = IContainerEnd‚Äù is always false.  Summed up the similar names of iterators.  In fact, it was necessary to write: "iContainer! = IContainerEnd".  By the way, there seems to be another mistake here.  It is strange that the iterator ‚ÄúiContainerEnd‚Äù increases. <br><br>  Consider another bad cycle: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lcl_FillSubRegionList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( IDocumentMarkAccess::<span class="hljs-keyword"><span class="hljs-keyword">const_iterator_t</span></span> ppMark = pMarkAccess-&gt;getBookmarksBegin(); &lt;&lt;&lt;&lt;---- ppMark != pMarkAccess-&gt;getBookmarksBegin(); &lt;&lt;&lt;&lt;---- ++ppMark) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ::sw::mark::IMark* pBkmk = ppMark-&gt;get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pBkmk-&gt;IsExpanded() ) rSubRegions.InsertEntry( pBkmk-&gt;GetName() ); } }</code> </pre> <br>  PVS-Studio Warning: V625 Consider inspecting the 'for' operator.  Initial and final values ‚Äã‚Äãof the iterator are the same.  uiregionsw.cxx 120 <br><br>  The cycle will not be executed.  In the condition, the iterator 'ppMark' must be compared with 'pMarkAccess-&gt; getBookmarksEnd ()'.  I don‚Äôt have any ideas how to protect myself from such an error with the help of code-writing rules.  Just a typo. <br><br>  By the way, sometimes there is an error, but it does not affect the correct execution of the program.  Now I‚Äôll demonstrate one of these typos: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> PolyPolygonEditor::DeletePoints(....) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bPolyPolyChanged = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>&lt; sal_uInt16 &gt;::const_reverse_iterator aIter;( rAbsPoints.rbegin() ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( aIter = rAbsPoints.rbegin(); aIter != rAbsPoints.rend(); ++aIter ) .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0119/">warning</a> : <a href="http://www.viva64.com/ru/d/0119/">V530</a> The return value of the function 'rbegin' is required to be utilized.  polypolygoneditor.cxx 38 <br><br>  Error here: aIter; (rAbsPoints.rbegin ()); <br><br>  We wanted to initialize an iterator.  But accidentally wedged a semicolon.  The iterator remains uninitialized.  And the expression "(rAbsPoints.rbegin ());"  dangles in the air and does nothing. <br><br>  The situation is saved by the fact that in the loop the iterator is still initialized with the desired value.  In general, there is no error, but it is better to remove the extra expression.  By the way, this cycle was duplicated using Copy-Paste, so it is worth looking back at line 69 and 129 in the same file. <br><br>  Finally a typo in the class constructor: <br><pre> <code class="cpp hljs">XMLTransformerOOoEventMap_Impl::XMLTransformerOOoEventMap_Impl( XMLTransformerEventMapEntry *pInit, XMLTransformerEventMapEntry *pInit2 ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pInit ) AddMap( pInit ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pInit ) AddMap( pInit2 ); }</code> </pre> <br>  PVS-Studio warning: V581 The conditional expressions of the 'if' are agreed alongside each other are identical.  Check lines: 77, 79. eventoootcontext.cxx 79 <br><br>  The second 'if' statement should check the 'pInit2' pointer. <br><br><h2>  May be so conceived, but very suspicious </h2><br>  There are several code snippets that seem to contain typos.  But I'm not sure.  Perhaps so conceived. <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VCL_DLLPUBLIC</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MouseSettings</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStartDragWidth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStartDragHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; .... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ImplHandleMouseEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( .... )</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> nDragW = rMSettings.GetStartDragWidth(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> nDragH = rMSettings.GetStartDragWidth(); .... }</code> </pre> <br>  Warning: <a href="http://www.viva64.com/ru/d/0277/">V656</a> Variables 'nDragW', 'nDragH' are initialized.  It's probably not an error or un-optimized code.  Consider inspecting the 'rMSettings.GetStartDragWidth ()' expression.  Check lines: 471, 472. winproc.cxx 472 <br><br>  It is not clear whether the variables nDragW and nDragH must be initialized with the same value or not.  If yes, then there is not enough comment.  Or it would be better to explicitly write: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> nDragW = rMSettings.GetStartDragWidth(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> nDragH = nDragW;</code> </pre> <br>  Similar situation: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Edit::ImplDelete(....) { .... maSelection.Min() = aSelection.Min(); maSelection.Max() = aSelection.Min(); .... }</code> </pre> <br>  V656 Variables 'maSelection.Min ()', 'maSelection.Max ()' are initialized through the call to the same function.  It's probably not an error or un-optimized code.  Consider inspecting the 'aSelection.Min ()' expression.  Check lines: 756, 757. edit.cxx 757 <br><br>  For those who work with the project, everything is immediately clear.  I do not work, and therefore I don‚Äôt know if there is a mistake or not. <br><br>  And the last case.  There are three functions in a class: <ul><li>  GetVRP () </li><li>  GetVPN () </li><li>  GetVUV () </li></ul>  However, here, to initialize the constant 'aVPN', the function GetVRP () is used. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ViewContactOfE3dScene::createViewInformation3D(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> basegfx::<span class="hljs-function"><span class="hljs-function">B3DPoint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aVRP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rSceneCamera.GetVRP())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> basegfx::<span class="hljs-function"><span class="hljs-function">B3DVector </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aVPN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rSceneCamera.GetVRP())</span></span></span></span>; &lt;&lt;&lt;--- <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> basegfx::<span class="hljs-function"><span class="hljs-function">B3DVector </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aVUV</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rSceneCamera.GetVUV())</span></span></span></span>; .... }</code> </pre> <br>  PVS-Studio Warning: V656 Variables 'aVRP', 'aVPN' are initialized through the call to the same function.  It's probably not an error or un-optimized code.  Consider inspecting the 'rSceneCamera.GetVRP ()' expression.  Check lines: 177, 178. viewcontactofe3dscene.cxx 178 <br><br>  The analyzer issued another warning V656.  I am pretty sure that there is a real mistake.  But I will not give the code, as it is cumbersome.  I ask the developers to look here: <ul><li>  V656 Variables 'oNumOffset1', 'oNumOffset2' are initialized.  It's probably not an error or un-optimized code.  Check lines: 68, 69. findattr.cxx 69 </li></ul><br><h2>  Copy paste </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/59a/a73/b9f/59aa73b9fd985b920788d77fabcf2f1d.png"><br><br>  I have to admit that, without Copy-Paste, programming will at times be extremely tedious and boring.  Without Ctrl-C, Ctrl-V programming will not work, as it would not want to disable these shortcuts.  Therefore, I will not urge not to copy the code.  But I urge everyone: copying the code, be careful and alert! <br><pre> <code class="cpp hljs">uno::Sequence&lt; OUString &gt; SwXTextTable::getSupportedServiceNames(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { uno::Sequence&lt; OUString &gt; aRet(<span class="hljs-number"><span class="hljs-number">4</span></span>); OUString* pArr = aRet.getArray(); pArr[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"com.sun.star.document.LinkTarget"</span></span>; pArr[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"com.sun.star.text.TextTable"</span></span>; pArr[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"com.sun.star.text.TextContent"</span></span>; pArr[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"com.sun.star.text.TextSortable"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aRet; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0108/">warning</a> : <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'pArr [2]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 3735, 3736. unotbl.cxx 3736 <br><br>  Classic <a href="http://www.viva64.com/ru/b/0260/">last line effect</a> .  I am almost sure that the last line was obtained from the penultimate.  Replaced "Content" with "Sortable", but forgot about the index '2'. <br><br>  Very similar case: <br><pre> <code class="cpp hljs">Sequence&lt;OUString&gt; FirebirdDriver::getSupportedServiceNames_Static() { Sequence&lt; OUString &gt; aSNS( <span class="hljs-number"><span class="hljs-number">2</span></span> ); aSNS[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"com.sun.star.sdbc.Driver"</span></span>; aSNS[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"com.sun.star.sdbcx.Driver"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aSNS; }</code> </pre> <br>  PVS-Studio warning: V519 The 'aSNS [0]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 137, 138. driver.cxx 138 <br><br>  But the worst thing is that sometimes due to Copy-Paste, errors multiply.  I will show it on an example.  Unfortunately, the code will be somewhat difficult to read.  Be patient. <br><br>  So, the program has this function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPropertyValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ::com::sun::star::uno::Any&amp; rAny, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ::com::sun::star::uno::Reference&lt; ::com::sun::star::beans::XPropertySet &gt; &amp;, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> OUString&amp; rPropertyName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bTestPropertyAvailability = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>;</code> </pre> <br>  Note that the last 'bTestPropertyAvailability' argument is optional. <br><br>  I also have to say what sal_True is: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> sal_True ((sal_Bool)1)</span></span></code> </pre> <br>  Now actually a mistake.  See how the function GetPropertyValue () is called: <br><pre> <code class="cpp hljs">sal_Int32 PPTWriterBase::GetLayoutOffset(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ::com::sun::star::uno::Any aAny; sal_Int32 nLayout = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( GetPropertyValue( aAny, rXPropSet, OUString( <span class="hljs-string"><span class="hljs-string">"Layout"</span></span> ) ), sal_True ) aAny &gt;&gt;= nLayout; DBG(<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"GetLayoutOffset %"</span></span> SAL_PRIdINT32 <span class="hljs-string"><span class="hljs-string">"\n"</span></span>, nLayout)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nLayout; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0257/">warning</a> : Consider inspecting the expression for 'GetPropertyValue' function call.  It is possible that one of the closing ')' brackets was positioned incorrectly.  pptx-epptbase.cxx 442 <br><br>  If you look closely, it turns out that one of the closing parentheses is not in its place.  As a result, the GetPropertyValue () function receives not the 'sal_True' as the last argument, but the default value (equal to 'false'). <br><br>  But this is only half the trouble.  Additionally, the work of the 'if' operator deteriorated.  The condition looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (foo(), sal_True)</code> </pre> <br>  <a href="http://www.viva64.com/go.php%3Furl%3D1503">Operator comma</a> returns its right hand side.  As a result, the condition is always true. <br><br>  The error in this code is not related to Copy-Paste.  Common typo.  Not there is a bracket.  It happens. <br><br>  The sad thing is that this error was propagated in other parts of the program.  If in one place the error is corrected, then the probability is high that in other places it will remain. <br><br>  Copy-Paste led to this error in 9 more places: <ul><li>  epptso.cxx 993 </li><li>  epptso.cxx 3677 </li><li>  pptx-text.cxx 518 </li><li>  pptx-text.cxx 524 </li><li>  pptx-text.cxx 546 </li><li>  pptx-text.cxx 560 </li><li>  pptx-text.cxx 566 </li><li>  pptx-text.cxx 584 </li><li>  pptx-text.cxx 590 </li></ul>  In conclusion, section 3 of the last non-critical warning.  Just one extra check: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CHECK_N_TRANSLATE( name ) \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (sServiceName == SERVICE_PERSISTENT_COMPONENT_##name) \ sToWriteServiceName = SERVICE_##name void OElementExport::exportServiceNameAttribute() { .... CHECK_N_TRANSLATE( FORM ); &lt;&lt;&lt;&lt;---- CHECK_N_TRANSLATE( FORM ); &lt;&lt;&lt;&lt;---- CHECK_N_TRANSLATE( LISTBOX ); CHECK_N_TRANSLATE( COMBOBOX ); CHECK_N_TRANSLATE( RADIOBUTTON ); CHECK_N_TRANSLATE( GROUPBOX ); CHECK_N_TRANSLATE( FIXEDTEXT ); CHECK_N_TRANSLATE( COMMANDBUTTON ); .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0106/">warning</a> : <a href="http://www.viva64.com/ru/d/0106/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 177, 178. elementexport.cxx 177 <br><br>  Nothing terrible, but a defect.  Two more extra checks can be found here: <ul><li>  querydesignview.cxx 3484 </li><li>  querydesignview.cxx 3486 </li></ul><br><h2>  Brave use of the realloc () function </h2><br>  The realloc () function is used so obviously insecurely that I don‚Äôt risk calling it a mistake.  Apparently, this is a conscious decision of the authors.  If the memory could not be allocated using malloc () / realloc (), then let the program better immediately fall.  There is nothing to "kick".  Anyway, if the program continues to work, it is unlikely that any good will come of this.  But it is not fair to count the messages issued by the analyzer for false positives.  Therefore, consider what the analyzer did not like. <br><br>  For example, let's study the implementation of the add () function in the FastAttributeList class: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FastAttributeList::add(sal_Int32 nToken, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sal_Char* pValue, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> nValueLength ) { maAttributeTokens.push_back( nToken ); sal_Int32 nWritePosition = maAttributeValues.back(); maAttributeValues.push_back( maAttributeValues.back() + nValueLength + <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maAttributeValues.back() &gt; mnChunkLength) { mnChunkLength = maAttributeValues.back(); mpChunk = (sal_Char *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>( mpChunk, mnChunkLength ); } <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(mpChunk + nWritePosition, pValue, nValueLength); mpChunk[nWritePosition + nValueLength] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0340/">warning</a> : <a href="http://www.viva64.com/ru/d/0340/">V701</a> realloc () possible leak: when realloc () fails in allocating memory, original pointer 'mpChunk' is lost.  Consider assigning realloc () to a temporary pointer.  fastattribs.cxx 88 <br><br>  The main problem with this code is that the result of the realloc () function is not checked.  Of course, a situation where it will not be possible to allocate memory is very rare.  But imagine - it happened.  Then realloc () returns NULL.  Then an emergency situation will arise, when the function strncpy () starts copying the data do not understand where: <br><pre> <code class="cpp hljs"> mpChunk = (sal_Char *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>( mpChunk, mnChunkLength ); } <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(mpChunk + nWritePosition, pValue, nValueLength);</code> </pre> <br>  But the analyzer does not like the other.  Suppose there is some kind of error handler.  And the program will continue its execution.  Here only memory leak arises.  The variable mpChunk will be written to 0, and it is no longer possible to free memory.  I will explain this error pattern in a little more detail.  Many do not think and misuse realloc (). <br><br>  Consider an artificial code example: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); .... p = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(p, <span class="hljs-number"><span class="hljs-number">10000</span></span>);</code> </pre> <br><br>  If the memory cannot be allocated, the variable 'p' will be ‚Äúcorrupted‚Äù.  Now there is no way to free the memory, the pointer to which was stored in the 'p'. <br><br>  In this form, the error is obvious.  But in practice, such code is quite common.  The analyzer generates 8 more warnings on this topic, but there is no sense to consider them.  Anyway, LibreOffice believes that memory can always be allocated. <br><br><h2>  Errors in logic </h2><br>  Met a series of funny mistakes in the conditions.  The reasons, apparently, are different: inattention, typos, insufficient knowledge of the language. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/17b/c0b/2eb/17bc0b2eba89000f90662bb925c290c9.png"><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ScPivotLayoutTreeListData::PushDataFieldNames(....) { .... ScDPLabelData* pLabelData = mpParent-&gt;GetLabelData(nColumn); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pLabelData == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; pLabelData-&gt;maName.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0111/">warning</a> : <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'pLabelData' might take place.  Check the logical condition.  pivotlayouttreelistdata.cxx 157 <br><br>  Logical error in the condition.  If the pointer is zero, then we dereference it.  As I understand it, here it was necessary to use the operator ||. <br><br>  Similar error: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grabFocusFromLimitBox</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( OQueryController&amp; _rController )</span></span></span><span class="hljs-function"> </span></span>{ .... vcl::Window* pWindow = VCLUnoHelper::GetWindow( xWindow ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pWindow || pWindow-&gt;HasChildPathFocus() ) { pWindow-&gt;GrabFocusToDocument(); } .... }</code> </pre> <br>  PVS-Studio warning: V522 Dereferencing of the null pointer 'pWindow' might take place.  Check the logical condition.  querycontroller.cxx 293 <br><br>  Here, on the contrary, instead of '||'  should have written '&amp;&amp;'. <br><br>  Now for a slightly more complicated condition: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> SbxDataType { SbxEMPTY = <span class="hljs-number"><span class="hljs-number">0</span></span>, SbxNULL = <span class="hljs-number"><span class="hljs-number">1</span></span>, .... }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SbModule::GetCodeCompleteDataFromParse(CodeCompleteDataCache&amp; aCache) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( (pSymDef-&gt;GetType() != SbxEMPTY) || (pSymDef-&gt;GetType() != SbxNULL) ) .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0137/">warning</a> : <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  sbxmod.cxx 1777 <br><br>  For simplicity, I will rewrite the expression: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type != <span class="hljs-number"><span class="hljs-number">0</span></span> || type != <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  The condition is always true. <br><br>  Two similar errors can be found here: <ul><li>  V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  sbxmod.cxx 1785 </li><li>  V547 Expression is always false.  Probably the '||'  operator should be used here.  xmlstylesexporthelper.cxx 223 </li></ul><br>  There are two places where the condition is redundant.  I think these are errors: <br><pre> <code class="cpp hljs">sal_uInt16 ScRange::ParseCols(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sal_Unicode* p = rStr.getStr(); .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> formula::FormulaGrammar::CONV_XL_R1C1: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((p[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'C'</span></span> || p[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'c'</span></span>) &amp;&amp; <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> != (p = lcl_r1c1_get_col( p, rDetails, &amp;aStart, &amp;ignored ))) { .... }</code> </pre> <br>  PVS-Studio warning: V590 Consider inspecting the 'p [0] ==' C '||  p [0]! = 'c' 'expression.  The expression is misprint.  address.cxx 1593 <br><br>  The condition (p [0] == 'C' || p [0]! = 'C') can be shortened to (p [0]! = 'C').  I am sure that this is an error and the condition should be like this: (p [0] == 'C' || p [0] == 'c'). <br><br>  An identical error can be found in the same file below: <ul><li>  V590 Consider inspecting the 'p [0] ==' R '||  p [0]! = 'r' 'expression.  The expression is misprint.  address.cxx 1652 </li></ul><br>  Perhaps, errors in logic can be attributed to the situation when the pointer is dereferenced at the beginning, and then only checked for equality to zero.  This is a very <a href="http://www.viva64.com/ru/examples/v595/">common mistake</a> in all programs.  Usually it arises due to inattention in the process of refactoring code. <br><br>  Typical example: <br><pre> <code class="cpp hljs">IMPL_LINK(....) { .... SystemWindow *pSysWin = pWindow-&gt;GetSystemWindow(); MenuBar *pMBar = pSysWin-&gt;GetMenuBar(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pSysWin &amp;&amp; pMBar ) { AddMenuBarIcon( pSysWin, <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); } .... }</code> </pre> <br>  PVS-Studio warning: V595 The 'pSysWin' pointer was used before it was verified against nullptr.  Check lines: 738, 739. updatecheckui.cxx 738 <br><br>  The 'pSysWin' pointer is dereferenced in the 'pSysWin-&gt; GetMenuBar ()' expression.  Then it is checked for equality to zero. <br><br>  I suggest that the creators of LibreOffice also pay attention to these places: <a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V595.txt">LibreOffice-V595.txt</a> . <br><br>  And last, this time a more complicated situation.  If you are tired, you can skip this place.  Consider the usual listing: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> BRC_Sides { WW8_TOP = <span class="hljs-number"><span class="hljs-number">0</span></span>, WW8_LEFT = <span class="hljs-number"><span class="hljs-number">1</span></span>, WW8_BOT = <span class="hljs-number"><span class="hljs-number">2</span></span>, WW8_RIGHT = <span class="hljs-number"><span class="hljs-number">3</span></span>, WW8_BETW = <span class="hljs-number"><span class="hljs-number">4</span></span> };</code> </pre> <br>  Note that named constants are not powers of two.  These are just numbers.  Including there is 0. <br><br>  They work with these constants as if they represent a power of two.  Try to mask select and check individual bits: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SwWW8ImplReader::Read_Border(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((nBorder &amp; WW8_LEFT)==WW8_LEFT) aBox.SetDistance( (sal_uInt16)aInnerDist.Left(), BOX_LINE_LEFT ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((nBorder &amp; WW8_TOP)==WW8_TOP) aBox.SetDistance( (sal_uInt16)aInnerDist.Top(), BOX_LINE_TOP ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((nBorder &amp; WW8_RIGHT)==WW8_RIGHT) aBox.SetDistance( (sal_uInt16)aInnerDist.Right(), BOX_LINE_RIGHT ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((nBorder &amp; WW8_BOT)==WW8_BOT) aBox.SetDistance( (sal_uInt16)aInnerDist.Bottom(), BOX_LINE_BOTTOM ); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0233/">warning</a> : <a href="http://www.viva64.com/ru/d/0233/">V616</a> The 'WW8_TOP' is called in the bitwise operation.  ww8par6.cxx 4742 <br><br>  These are wrong actions.  For example, the condition ((nBorder &amp; WW8_TOP) == WW8_TOP) is always true.  For the explanation I will substitute numbers: ((nBorder &amp; 0) == 0). <br><br>  The check on WW8_LEFT will also work incorrectly if the nBorder variable has the WW8_RIGHT value equal to 3. Substitute ((3 &amp; 1) == 1).  It turns out that WW8_RIGHT is taken as WW8_LEFT. <br><br><h2>  Skeleton in the closet </h2><br>  The analyzer from time to time detects abnormal places in the code.  This is not a mistake, but a cunning idea.  Touching them makes no sense, but it may be interesting to see.  Here is one of those cases where the analyzer did not like the argument of the free () function: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* This operator is supposed to be unimplemented, but that now leads * to compilation and/or linking errors with MSVC2008. (Don't know * about MSVC2010.) As it can be left unimplemented just fine with * gcc, presumably it is never called. So do implement it then to * avoid the compilation and/or linking errors, but make it crash * intentionally if called. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SimpleReferenceObject::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>[](<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * <span class="hljs-comment"><span class="hljs-comment">/* pPtr */</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre> <br><h2>  Safety engineering </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/935/914/816/935914816666a4cf004cb33b65a526b1.png"><br><br>  The analyzer revealed a number of points that make the program code dangerous.  The dangers are diverse in nature, but I decided to put them in one section. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* errstr )</span></span></span><span class="hljs-function"> </span></span>{ FILE* ferr = getErrorFile( <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ferr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>( ferr, errstr ); fflush( ferr ); } }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0235/">warning</a> : <a href="http://www.viva64.com/ru/d/0235/">V618</a> It‚Äôs dangerous to call the format.  The example of the safe code: printf ("% s", str);  unoapploader.c 405 <br><br>  If there are control characters in the string 'errstr', anything can happen.  The program may fall, it may write garbage to the file, or something else will happen ( <a href="http://www.viva64.com/ru/b/0129/">details</a> ). <br><br>  It will be correct to write like this: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>( ferr, <span class="hljs-string"><span class="hljs-string">"%s"</span></span>, errstr );</code> </pre> <br>  Two more places where the printf () function is incorrectly used: <ul><li>  climaker_app.cxx 261 </li><li>  climaker_app.cxx 313 </li></ul><br>  Now about the dangerous use of <a href="http://www.viva64.com/go.php%3Furl%3D1504">dynamic_cast</a> . <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~LazyFieldmarkDeleter() { <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;Fieldmark&amp;&gt; (*m_pFieldmark.get()).ReleaseDoc(m_pDoc); }</code> </pre> <br>  PVS-Studio warning: <a href="http://www.viva64.com/ru/d/0098/">V509</a> The 'dynamic_cast &lt;T &amp;&gt;' operator should be located inside the try..catch block.  Raising exception inside the destructor is illegal.  docbm.cxx 846 <br><br>  When working with links, if the conversion cannot be performed, the dynamic_cast statement throws an exception std :: bad_cast. <br><br>  If an exception occurs in the program, the stack collapses, during which objects are destroyed by calling destructors.  If the destructor of the object being destroyed when the stack collapses throws another exception, and this exception leaves the destructor, the C ++ library immediately crashes the program by calling the terminate () function.  It follows from this that destructors should never propagate exceptions.  The exception thrown inside the destructor must be processed inside the same destructor. <br><br>  For the same reason, it is dangerous to call the operator new in destructors.  This statement, when there is a shortage of memory, will throw an exception std :: bad_alloc.  It is a good idea to wrap it in a try-catch block. <br><br>  Example of dangerous code: <br><pre> <code class="cpp hljs">WinMtfOutput::~WinMtfOutput() { mpGDIMetaFile-&gt;AddAction( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MetaPopAction() ); .... }</code> </pre> <br>  Warnings PVS-Studio: V509 The operator should not be located inside the camera.  Raising exception inside the destructor is illegal.  winmtf.cxx 852 <br><br>  Other dangerous actions in the destructor: <ul><li>  V509 The 'dynamic_cast &lt;T &amp;&gt;' operator should not be located inside the try..catch block  Raising exception inside the destructor is illegal.  ndtxt.cxx 4886 </li><li>  V509 The operator should not be located inside the try..catch block.  Raising exception inside the destructor is illegal.  export.cxx 279 </li><li>  V509 The operator should not be located inside the try..catch block.  Raising exception inside the destructor is illegal.  getfilenamewrapper.cxx 73 </li><li>  V509 The operator should not be located inside the try..catch block.  Raising exception inside the destructor is illegal.  e3dsceneupdater.cxx 80 </li><li>  V509 The operator should not be located inside the try..catch block.  Raising exception inside the destructor is illegal.  accmap.cxx 1683 </li><li>  V509 The operator should not be located inside the try..catch block.  Raising exception inside the destructor is illegal.  frmtool.cxx 938 </li></ul><br>  By the way, since we were talking about operator new, I would note the danger of this code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-function">oslFileHandle SAL_CALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osl_createFileHandleFromOSHandle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( HANDLE hFile, sal_uInt32 uFlags)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !IsValidHandle(hFile) ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// EINVAL FileHandle_Impl * pImpl = new FileHandle_Impl(hFile); if (pImpl == 0) { // cleanup and fail (void) ::CloseHandle(hFile); return 0; // ENOMEM } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0293/">warning</a> : <a href="http://www.viva64.com/ru/d/0293/">V668 It was</a> no use.  The exception will be generated in the case of memory allocation error.  file.cxx 663 <br><br>  The 'new' operator generates an exception when there is insufficient memory.  Thus, checking the pointer that the operator returned does not make sense.  It is always not equal to 0. If there is not enough memory, the CloseHandle () function will not be called: <br><pre> <code class="cpp hljs">FileHandle_Impl * pImpl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileHandle_Impl(hFile); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pImpl == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// cleanup and fail (void) ::CloseHandle(hFile); return 0; // ENOMEM }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I could be wrong. I do not know the project LibreOffice. Perhaps the developers use a special version of the libraries in which the operator 'new' does not throw an exception, but returns nullptr. If this is the case, then please simply ignore the warnings with the number V668. They can be turned off so that they do not interfere. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the new operator throws an exception, I recommend viewing the following 126 messages: </font></font><a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V668.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LibreOffice-V668.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following danger lies in the implementation of one of the functions of DllMain:</font></font><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved )</span></span></span><span class="hljs-function"> </span></span>{ .... CreateThread( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, ParentMonitorThreadProc, (LPVOID)dwParentProcessId, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;dwThreadId ); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font><a href="http://www.viva64.com/ru/d/0359/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="http://www.viva64.com/ru/d/0359/"><font style="vertical-align: inherit;">V718</font></a><font style="vertical-align: inherit;"> The 'CreateThread' function should not be called from the 'DllMain' function. dllentry.c 308 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many functions cannot be called inside the DllMain () function, as this may cause the application to freeze or other errors. These functions include CreateThread (). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The situation with DllMain is well described in an article on MSDN: </font></font><a href="http://www.viva64.com/go.php%3Furl%3D1487"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamic-Link Library Best Practices</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code may work, but it is dangerous and someday may fail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a situation where the wcsncpy () function can cause a buffer overflow:</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> .... WCHAR wszTitle[MAX_COLUMN_NAME_LEN]; WCHAR wszDescription[MAX_COLUMN_DESC_LEN]; } SHCOLUMNINFO, *LPSHCOLUMNINFO; HRESULT STDMETHODCALLTYPE CColumnInfo::GetColumnInfo( DWORD dwIndex, SHCOLUMNINFO *psci) { .... wcsncpy(psci-&gt;wszTitle, ColumnInfoTable[dwIndex].wszTitle, (<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(psci-&gt;wszTitle) - <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call of the 'wcsncpy' function will lead to overflow of the buffer 'psci-&gt;wszTitle'. columninfo.cxx 129 <br><br>  (sizeof(psci-&gt;wszTitle) ‚Äî 1) .      : <br><pre> <code class="cpp hljs">(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(psci-&gt;wszTitle) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(psci-&gt;wszTitle[<span class="hljs-number"><span class="hljs-number">0</span></span>]) - <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>   ,      ,     memset().  Example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __rtl_digest_updateMD2 (DigestContextMD2 *ctx) { .... sal_uInt32 state[<span class="hljs-number"><span class="hljs-number">48</span></span>]; .... <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span> (state, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">48</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(sal_uInt32)); }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0208/">V597</a> The compiler could delete the 'memset' function call, which is used to flush 'state' buffer.  The RtlSecureZeroMemory () function should be used to erase the private data. digest.cxx 337 <br><br>         .      ,    ,    . <br><br>       memset(),         .     .      -  . <br><br>  Details: <ol><li> <a href="http://www.viva64.com/ru/d/0208/">V597. The compiler could delete the 'memset' function call, which is used to flush 'Foo' buffer</a> . </li><li> <a href="http://www.viva64.com/ru/k/0041/">  ‚Äî ?</a> </li><li> <a href="http://www.viva64.com/go.php%3Furl%3D1028">Zero and forget ‚Äî caveats of zeroing memory in C</a> . </li></ol>  ,     : <a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V597.txt">LibreOffice-V597.txt</a> . <br><br><h2>   </h2><br><pre> <code class="cpp hljs">Guess::Guess() { language_str = DEFAULT_LANGUAGE; country_str = DEFAULT_COUNTRY; encoding_str = DEFAULT_ENCODING; } Guess::Guess(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * guess_str) { Guess(); .... }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0215/">V603</a> The object was created but it is not being used. If you wish to call constructor, 'this-&gt;Guess::Guess(....)' should be used. guess.cxx 56 <br><br> ,   ,     ++.       . ,   ,     . -       . <a href="http://www.viva64.com/ru/b/0127/"></a> . <br><br>    : camera3d.cxx 46 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">sal_uInt32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readIdent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> nItems = rStrings.size(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sal_Char** pStrings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sal_Char*[ nItems+<span class="hljs-number"><span class="hljs-number">1</span></span> ]; .... <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pStrings; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nRet; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font><a href="http://www.viva64.com/ru/d/0226/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="http://www.viva64.com/ru/d/0226/"><font style="vertical-align: inherit;">V611, it</font></a><font style="vertical-align: inherit;"> was allocated using the 'delete' operator. </font><font style="vertical-align: inherit;">Consider inspecting this code. </font><font style="vertical-align: inherit;">It's probably better to use 'delete [] pStrings;'. </font><font style="vertical-align: inherit;">profile.hxx 103 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correctly: delete [] pStrings ;. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another warning about incorrect memory release:</font></font><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V611 The memory was allocated using the 'new T []' operator. </font><font style="vertical-align: inherit;">Consider inspecting this code. </font><font style="vertical-align: inherit;">It's probably better to use 'delete [] pStrings;'. </font><font style="vertical-align: inherit;">profile.hxx 134</font></font></li></ul><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kConventionShift = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kFlagMask = ~((~<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;&lt; kConventionShift);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PVS-Studio warning: V610 Undefined behavior. </font></font> Check the shift operator '&lt;&lt;'. The left operand '(~int (0))' is negative. grammar.hxx 56 <br><br>     -    ( <a href="http://www.viva64.com/ru/b/0142/"></a> ). <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">sal_Int32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMRest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_nRest;} OUString LwpBulletStyleMgr::RegisterBulletStyle(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pIndent-&gt;GetMRest() &gt; <span class="hljs-number"><span class="hljs-number">0.001</span></span>) .... }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0308/">V674</a> The '0.001' literal of the 'double' type is compared to a value of the 'long' type. Consider inspecting the 'pIndent-&gt;GetMRest() &gt; 0.001' expression. lwpbulletstylemgr.cxx 177 <br><br>  Something is wrong here.       0.001. <br><br>      : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SHGetSpecialFolderPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( HWND hwndOwner, _Out_ LPTSTR lpszPath, _In_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> csidl, _In_ BOOL fCreate )</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAILED(hr) (((HRESULT)(hr)) &lt; 0) OUString UpdateCheckConfig::getDesktopDirectory() { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">( ! FAILED( SHGetSpecialFolderPathW( .... ) ) ) .... }</span></span></code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0357/">V716</a> Suspicious type conversion: BOOL -&gt; HRESULT. updatecheckconfig.cxx 193 <br><br>  ,  SHGetSpecialFolderPath()   HRESULT. ,   ,   BOOL.   ,      FAILED. <br><br>    : updatecheckconfig.cxx 222 <br><br>        FAILED.     HRESULT : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> UniscribeLayout::LayoutText( ImplLayoutArgs&amp; rArgs ) { .... HRESULT nRC = ScriptItemize(....); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !nRC ) <span class="hljs-comment"><span class="hljs-comment">// break loop when everything is correctly itemized break; .... }</span></span></code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0134/">V545</a> Such conditional expression of 'if' operator is incorrect for the HRESULT type value 'nRC'. The SUCCEEDED or FAILED macro should be used instead. winlayout.cxx 1115 <br><br> ,        : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Reader::ClearTemplate() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pTemplate ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> == pTemplate-&gt;release() ) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pTemplate, pTemplate = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0243/">V626</a> Consider checking for misprints. It's possible that ',' should be replaced by ';'. shellio.cxx 549 <br><br>  : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TabBar::ImplInit( WinBits nWinStyle ) { .... mbMirrored = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; mbMirrored = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... }</code> </pre> <br>  PVS-Studio: V519 The 'mbMirrored' variable is assigned values twice successively.  Perhaps this is a mistake. Check lines: 415, 416. tabbar.cxx 416 <br><br>   : V519 The 'aParam.mpPreviewFontSet' variable is assigned values twice successively.  Perhaps this is a mistake. Check lines: 4561, 4562. output2.cxx 4562 <br><br>   ,   : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallRsc2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !rsc_strnicmp( ...., <span class="hljs-string"><span class="hljs-string">"-fp="</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> ) || !rsc_strnicmp( ...., <span class="hljs-string"><span class="hljs-string">"-fo="</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> ) || !rsc_strnicmp( ...., <span class="hljs-string"><span class="hljs-string">"-presponse"</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span> ) || &lt;&lt;&lt;&lt;---- !rsc_strnicmp( ...., <span class="hljs-string"><span class="hljs-string">"-rc"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ) || !rsc_stricmp( ...., <span class="hljs-string"><span class="hljs-string">"-+"</span></span> ) || !rsc_stricmp( ...., <span class="hljs-string"><span class="hljs-string">"-br"</span></span> ) || !rsc_stricmp( ...., <span class="hljs-string"><span class="hljs-string">"-bz"</span></span> ) || !rsc_stricmp( ...., <span class="hljs-string"><span class="hljs-string">"-r"</span></span> ) || ( <span class="hljs-string"><span class="hljs-string">'-'</span></span> != *.... ) ) .... }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0291/">V666</a> Consider inspecting third argument of the function 'rsc_strnicmp'. It is possible that the value does not correspond with the length of a string which was passed with the second argument. start.cxx 179 <br><br>   "-presponse" 10,   9 . <br><br>  'break'  : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OUString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExtensionFolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (xResultSet-&gt;next()) { title = Reference&lt;sdbc::XRow&gt;( xResultSet, UNO_QUERY_THROW )-&gt;getString(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Title */</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> title; }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/d/0228/">V612</a> An unconditional 'break' within a loop. dp_manager.cxx 100 <br><br>    : <ul><li> V612 An unconditional 'break' within a loop. svdfppt.cxx 3260 </li><li> V612 An unconditional 'break' within a loop. svdfppt.cxx 3311 </li><li> V612 An unconditional 'break' within a loop. personalization.cxx 454 </li></ul><br>    : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BSTR </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PromptNew</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hWnd)</span></span></span><span class="hljs-function"> </span></span>{ .... ADOConnection* piTmpConnection = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ::CoInitialize( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); hr = CoCreateInstance( CLSID_DataLinks, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, CLSCTX_INPROC_SERVER, IID_IDataSourceLocator, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)&amp;dlPrompt ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( FAILED( hr ) ) { piTmpConnection-&gt;Release(); dlPrompt-&gt;Release( ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connstr; } .... }</code> </pre> <br>  PVS-Studio: V522 Dereferencing of the null pointer 'piTmpConnection' might take place. adodatalinks.cxx 84 <br><br>    CoCreateInstance()   ,     'piTmpConnection'   NULL. <br><br><h2>  </h2><br>            .    ,     . <br><br>          ,    .  ,       .     . ,       . <br><br> ,    PVS-Studio  . <br><br><h3>     </h3><br>  ,     ,       ,   . ,      . , , ,     ,          . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/103/d3f/d1b/103d3fd1b2c93f29433e39c21bc47d33.png"><br><br>  Example: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getexe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> exename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maybeempty)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* cmdbuf; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cmdlen; _dupenv_s(&amp;cmdbuf, &amp;cmdlen, exename.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!cmdbuf) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maybeempty) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(); } <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Error "</span></span> &lt;&lt; exename &lt;&lt; <span class="hljs-string"><span class="hljs-string">" not defined. "</span></span> <span class="hljs-string"><span class="hljs-string">"Did you forget to source the environment?"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">command</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cmdbuf)</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(cmdbuf); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command; }</code> </pre> <br>  'exename'    .   : <a href="http://www.viva64.com/ru/d/0303">V813</a> Decreased performance. The 'exename' argument should probably be rendered as a constant reference. wrapper.cxx 18 <br><br>      : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getexe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;exename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maybeempty)</span></span></span></span></code> </pre> <br>              ¬´¬ª.  ,     ,    20  ¬´     const   ¬ª  : <br><br>  . ¬´  C++. 55        ¬ª ‚Äî .:  , 2006. ‚Äî 300 .: . ISBN 5-94074-304-8 <br><br>      <a href="http://www.viva64.com/ru/d/0135/">V801</a> . ,   465 ,         : <a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V801-V813.txt">LibreOffice-V801-V813.txt</a> . <br><br><h3>    </h3><br>       .        ¬´ 6.       ¬ª  : <br><br>  .    ++. 35        : .  from English ‚Äî .:  , 2000. ‚Äî 304 .: . ( ¬´ ¬ª). ISBN 5-94074-033-2.  32.973.26-018.1. <br><br>     ,     'A++' '++A'   .    ,    ,      ( <a href="http://www.viva64.com/ru/b/0093/"></a> ). <br><br>  Code example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> InterfaceMap::<span class="hljs-function"><span class="hljs-function">iterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key &amp;rKey)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> InterfaceMap::iterator iter = m_pMap-&gt;begin(); <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> InterfaceMap::iterator end = m_pMap-&gt;end(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( iter != end ) { equalImpl equal; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( equal( iter-&gt;first, rKey ) ) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; iter++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> iter; }</code> </pre> <br>  PVS_Studio: <a href="http://www.viva64.com/ru/d/0165/">V803</a> Decreased performance. In case 'iter' is iterator it's more effective to use prefix form of increment. Replace iterator++ with ++iterator. interfacecontainer.h 405 <br><br>  ¬´iter++¬ª    "++iter".  ,        .  ,   ,    257 ,       : <a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V803.txt">LibreOffice-V803.txt</a> . <br><br><h3> ,    </h3><br>  ,   ,    .   : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMsiProp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* buff = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;( <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>( nbytes ) ); .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(buff) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font><a href="http://www.viva64.com/ru/d/0179/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="http://www.viva64.com/ru/d/0179/"><font style="vertical-align: inherit;">V805</font></a><font style="vertical-align: inherit;"> Decreased performance. </font><font style="vertical-align: inherit;">It is not necessary to identify the string by using 'strlen (str)&gt; 0' construct. </font><font style="vertical-align: inherit;">A more efficient way is to check: str [0]! = '\ 0'. </font><font style="vertical-align: inherit;">sellang.cxx 49 The </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inefficiency is that you need to </font><font style="vertical-align: inherit;">loop </font><font style="vertical-align: inherit;">through all the characters in the string until a </font></font><a href="http://www.viva64.com/ru/t/0088/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminal zero is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> encountered </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But it suffices to check only one byte:</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buff[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This code is not very beautiful, so it would be better to have a special function: </font></font><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsEmptyStr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> || s[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here there was an extra check for pointer 0 equality. </font><font style="vertical-align: inherit;">I do not really like it and you can think about other options. </font><font style="vertical-align: inherit;">But still, this function will work faster than strlen (). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other ineffective checks: </font></font><a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V805.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LibreOffice-V805.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3>  Other </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are some more warnings of the analyzer that may seem interesting: </font></font><a href="http://www.viva64.com/external-pictures/txt/LibreOffice-V804_V811.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LibreOffice-V804_V811.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Number of false positives </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the article I mentioned 240 warnings that seemed interesting to me. </font><font style="vertical-align: inherit;">In total, the analyzer issued about 1500 general </font><font style="vertical-align: inherit;">level </font><font style="vertical-align: inherit;">( </font></font><a href="http://www.viva64.com/ru/general-analysis/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 1 and 2 level </font><font style="vertical-align: inherit;">warnings </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Does this mean that the analyzer generates a lot of false positives?</font></font> Not.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Most warnings are quite relevant, but there‚Äôs no point in talking about them in the article. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From time to time, we receive positive feedback from our users, in which they say: ‚ÄúThe PVS-Studio analyzer produces few false positives, which is very convenient.‚Äù We also believe that there are few false positives. But how so? The article tells only about 16% of messages. What's the rest of it? Is it a false positive? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, there are false positives. From this you can not get anywhere. To suppress them, there are a number of </font></font><a href="http://www.viva64.com/ru/d/0021/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mechanisms</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . However, most of the warnings didn‚Äôt reveal an error, but pointed out the code that smells bad. I will try to explain with examples. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer issued </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">206</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> warnings. </font></font><a href="http://www.viva64.com/ru/d/0326/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V690</font></font></a>  ,      ,     .     : <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryTypeReader</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegistryTypeReader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> RegistryTypeReader&amp; toCopy)</span></span></span></span>; .... }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> RegistryTypeReader::RegistryTypeReader(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RegistryTypeReader&amp; toCopy) : m_pApi(toCopy.m_pApi) , m_hImpl(toCopy.m_hImpl) { m_pApi-&gt;acquire(m_hImpl); }</code> </pre> <br>      .  , operator =     206 .   ? <br><br>     . <br><br>   ,   ,         .      ,      V690,        206 . <br><br>  .       : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pInit ) AddMap( pInit ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pInit ) AddMap( pInit2 );</code> </pre> <br>      V581. ,  ,    V581     - .   ,    70 .    .   ,    : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lcl_parseDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bSuccess) { ++nPos; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bSuccess) { bSuccess = readDateTimeComponent(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, nPos, nDay, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); .... }</code> </pre> <br>    'bSuccess'.       ? <br><br>     70     .       ,   -  ,     .    V581    70 . <br><br>       ,    - .   : <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lcl_parseDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bSuccess) { ++nPos; bSuccess = readDateTimeComponent(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, nPos, nDay, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); .... }</code> </pre> <br>  ,       .         ,          ,    . ,   ,     ,      ,     . <br><br>  <b>Note.</b>    ,      .     <a href="http://www.viva64.com/ru/d/0345/"> </a> .    ,       ,      .                 . <br><br><h2>  Conclusion </h2><br>         ,   ,  LibreOffice  .     Coverity      .       . <br><br>     ?     .      .    <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a>          . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/647/db8/dd2/647db8dd2f28dc4777263f7987eea570.png"><br><br>      . ,     .   LibreOffice   .  I apologize.    . <br><br><h2>  This article is in English. </h2><br>        ,      : Andrey Karpov. <a href="http://www.viva64.com/en/b/0308/">LibreOffice Project's Check</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/251817/">https://habr.com/ru/post/251817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251801/index.html">SummaryJS Release 3</a></li>
<li><a href="../251803/index.html">Krita 2.9: Draft Brush Profiles, Locked Settings, and Cumulative Cancellation</a></li>
<li><a href="../251805/index.html">The digest of interesting materials for the mobile developer # 92 (February 21 - March 1)</a></li>
<li><a href="../251807/index.html">Another post about building a front-end project</a></li>
<li><a href="../251815/index.html">Bond James Bond. Robotic fake handwriting for marketers and social engineers</a></li>
<li><a href="../251821/index.html">Krita 2.9: Selection of canvas areas with a brush</a></li>
<li><a href="../251823/index.html">The dangers of using open-uri</a></li>
<li><a href="../251827/index.html">MailChimp UX Team: How We Do Research [Part 3 of the book]</a></li>
<li><a href="../251829/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ37 (February 23 - March 1, 2015)</a></li>
<li><a href="../251831/index.html">Basic principles of system analysis in SEBoK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>