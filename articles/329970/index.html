<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of CQRS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is based on material from various articles on CQRS, as well as projects where this approach was applied. 

 Management systems of enterpr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of CQRS</h1><div class="post__text post__text-html js-mediator-article">  This article is based on material from various articles on CQRS, as well as projects where this approach was applied. <br><br>  Management systems of enterprises, projects, employees have long entered our lives.  And users of such enterprise applications are increasingly demanding: requirements for scalability increase, complexity of business logic, requirements for systems change quickly, and reporting is required in real time. <br><br>  Therefore, when developing, it is often possible to observe the same problems in the organization of code and architecture, as well as in their complexity.  With the wrong approach to design, sooner or later there may come a moment when the code becomes so complicated and confusing that every change requires more time and resources. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Typical approach to the design of the application </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/web/0b3/02c/571/0b302c571c1f40bbb77baaeaaa05d5b2.png" alt="image"></div><br>  Layered architecture is one of the most popular ways to organize a web application structure.  In its simple variation, as in the above diagram, the application is divided into 3 parts: the data layer, the business logic layer and the user interface layer. <br><br>  There is a Repository in the data layer that abstracts us from the data store. <br>  In the business logic layer, there are objects that encapsulate business rules (usually their names vary within Services / BusinessRules / Managers / Helpers).  User requests pass from the UI through the business rules, and further through the Repository work with the data storage is performed. <br><br>  With this architecture, requests for receiving and changing data are usually made in the same place - in the business logic layer.  This is a fairly simple and familiar way of organizing code, and such a model can be suitable for most applications, if in these applications the number of users does not change significantly over time, the application does not experience large loads and does not require significant expansion of functionality. <br><br>  But if a web resource becomes quite popular, it may be a question that one server is not enough for it.  And then the question arises about the distribution of the load between multiple servers.  The easiest way to quickly distribute the load is to use multiple copies of the resource and database replication.  And given that all the actions of such a system are not divided in any way, this creates new problems. <br><br>  Classic multi-layered architecture does not provide an easy solution to such problems.  Therefore, it would be nice to use approaches in which these problems are solved from the very beginning.  One such approach is CQRS. <br><br><h3>  Command and Query Responsibility Segregation (CQRS) </h3><br>  CQRS is a software design approach in which code that changes state is separated from code that simply reads that state.  This separation may be logical and based on different levels.  In addition, it can be physical and include different links (tiers), or levels. <br><br>  The basis of this approach is the principle of Command-query separation (CQS). <br><br>  The basic idea of ‚Äã‚ÄãCQS is that there are two types of methods in an object: <br><ul><li>  <b>Queries:</b> Methods return a result without changing the state of the object.  In other words, Query has no <i>side effects</i> . </li><li>  <b>Commands:</b> Methods change the state of an object without returning a value. </li></ul><br>  For an example of this separation, consider the User class with the single method IsEmailValid: <br><blockquote><ol><li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public class</font> <font color="#2b91af">User</font> { <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ; <font color="#0000ff">private set</font> ; } <font color="#0000ff">public bool</font> IsEmailValid( <font color="#0000ff">string</font> email) { <font color="#0000ff">bool</font> isMatch = <font color="#2b91af">Regex</font> .IsMatch( <font color="#A31515">"email pattern"</font> , email); <font color="#0000ff">if</font> (isMatch) { Email = email; <font color="#008000">// Command</font> } <font color="#0000ff">return</font> isMatch; <font color="#008000">// Query</font> } }</font></code> </li> </ol></blockquote><br>  In this method, we ask (do Query) whether the transmitted email is valid.  If yes, then we get in response to True, otherwise False.  In addition to returning the value, it is also determined here that in the case of a valid email, immediately assign its value (do the Command) to the Email field. <br><br>  Despite the fact that the example is rather simple, a less trivial situation is likely, if we imagine the Query method, which, when called in several levels of nesting, changes the state of different objects.  At best, lucky if you do not have to deal with similar methods and their long debugging.  Similar side effects from calling Query are often discouraged, as it is difficult to understand the system. <br><br>  If we use the principle of CQS and divide the methods into Command and Query, we get the following code: <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">User</font> </li><li>  { </li><li>  <font color="#0000ff">public string</font> Email { <font color="#0000ff">get</font> ;  <font color="#0000ff">private set</font> ;  } </li><li></li><li>  <font color="#0000ff">public bool</font> IsEmailValid ( <font color="#0000ff">string</font> email) <font color="#008000">// Query</font> </li><li>  { </li><li>  <font color="#0000ff">return</font> <font color="#2b91af">Regex</font> .IsMatch ( <font color="#A31515">"email pattern"</font> , email); </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> ChangeEmail ( <font color="#0000ff">string</font> email) <font color="#008000">// Command</font> </li><li>  { </li><li>  <font color="#0000ff">if</font> (IsEmailValid (email) == <font color="#0000ff">false</font> ) </li><li>  <font color="#0000ff">throw new</font> <font color="#2b91af">ArgumentOutOfRangeException</font> (email); </li><li></li><li>  Email = email; </li><li>  } </li><li>  } </li></ol></blockquote><br>  Now a user of our class will not see any state changes when calling IsEmailValid, he will only get the result - whether the email is valid or not.  And in the case of calling the ChangeEmail method, the user explicitly changes the state of the object. <br><br>  In CQS, Query has one feature.  Since Query does not change the state of an object in any way, then methods like Query can be well parallelized by dividing the load on read operations. <br><br>  If CQS operates on methods, then CQRS rises to the object level.  To change the state of the system, the <b>Command</b> class is created, and to select data, the <b>Query</b> class.  Thus, we get a set of objects that change the state of the system, and a set of objects that return data. <br><br>  Typical system design, where there is a UI, business logic and database: <br><br><img src="https://habrastorage.org/web/e86/18f/f23/e8618ff230ac43a0aeaf4cb77770e4c5.png" alt="image"><br><br>  CQRS says that you don‚Äôt need to mix Command and Query objects, you need to explicitly select them.  A system divided in this way will look like this: <br><br><img src="https://habrastorage.org/web/ad1/8f6/b93/ad18f6b93ba8460fb6c7d148d9b5fce2.png" alt="image"><br><br>  The separation pursued by the CQRS is achieved by grouping query operations in one level, and commands in another.  Each level has its own data model, its own set of services and is created using its own combination of patterns and technologies.  More importantly, these two levels can even be in two different links (tiers) and be optimized separately, without affecting each other. <br><br>  Just understanding that commands and requests are different things has a profound effect on software architecture.  For example, it suddenly becomes easier to foresee and code each level of the domain.  The domain layer in the command stack only needs data, business rules, and security rules to perform tasks.  On the other hand, the level of the subject area in the query stack may be no more complicated than a direct SQL query. <br><br><h3>  How to start with CQRS? </h3><br>  <b>1. Team stack</b> <br><br>  In CQRS, only the execution of tasks that modify the state of the application is assigned to the command stack.  The team has the following properties: <br><ul><li>  Changes the state of the system; </li><li>  Returns nothing; </li><li>  The command context stores the data needed to execute it. </li></ul><br>  The announcement and use of the command can be divided into 3 parts: <br><ul><li>  A command class that represents the data; </li><li>  Class command handler; </li><li>  A class with a method or methods that take a command at the input and call exactly the handler that implements the command with the given type. </li></ul><br>  The essence of commands and requests is that they have a common feature by which they can be combined.  In other words, they have a common type.  In the case of commands, it will look like this: <br><blockquote><ol><li>  <font color="#0000ff">public interface</font> <font color="#2b91af">ICommand</font> </li><li>  { </li><li>  } </li></ol></blockquote><br>  The first step is declared interface, which, as a rule, contains nothing.  It will be used as a parameter, which can be obtained on the server side directly from the user interface (UI), or otherwise formed to send a command to the handler. <br><br>  Next, a command handler interface is declared. <br><blockquote><ol><li>  <font color="#0000ff">public interface</font> <font color="#2b91af">ICommandHandler</font> &lt; <font color="#0000ff">in</font> TCommand&gt; <font color="#0000ff">where</font> TCommand: <font color="#2b91af">ICommand</font> </li><li>  { </li><li>  <font color="#0000ff">void</font> Execute (TCommand command); </li><li>  } </li></ol></blockquote><br>  It contains only 1 method that accepts data with the type of interface declared earlier. <br><br>  After that, it remains to determine the method of centralized invocation of command handlers depending on the specific type of command transmitted (ICommand).  This role can be performed by a service bus or a dispatcher. <br><blockquote><ol><li>  <font color="#0000ff">public interface</font> <font color="#2b91af">ICommandDispatcher</font> </li><li>  { </li><li>  <font color="#0000ff">void</font> Execute &lt; <font color="#2b91af">TCommand</font> &gt; ( <font color="#2b91af">TCommand</font> command) <font color="#0000ff">where</font> <font color="#2b91af">TCommand</font> : ICommand; </li><li>  } </li></ol></blockquote><br>  Depending on the needs, he can have one or more methods.  In simple cases, it may be sufficient to have one method whose task is to determine by the type of the passed parameter which implementation of the command handler to invoke.  Thus, the user does not have to do it manually. <br><br>  <b>Sample command</b> .  Suppose there is an online store, for it you need to create a team that will create a product in the store.  In the beginning, we will create a class, where in its name we indicate what action this command performs. <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">CreateInventoryItem</font> : <font color="#2b91af">ICommand</font> </li><li>  { </li><li>  <font color="#0000ff">public</font> <font color="#2b91af">Guid</font> InventoryItemid { <font color="#0000ff">get</font> ;  } </li><li>  <font color="#0000ff">public string</font> Name { <font color="#0000ff">get</font> ;  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">CreateInventoryItem</font> ( <font color="#2b91af">Guid</font> inventoryItemld, <font color="#0000ff">string</font> name) </li><li>  { </li><li>  InventoryItemId = inventoryItemId; </li><li>  Name = name; </li><li>  } </li><li>  } </li></ol></blockquote><br>  All classes that implement ICommand contain data ‚Äî properties and a constructor with their values ‚Äã‚Äãset during initialization ‚Äî and nothing more. <br><br>  The implementation of the handler, that is, the command itself, is reduced to fairly simple actions: a class is created that implements the ICommandHandler interface.  The type argument specifies the previously declared command. <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">InventoryCommandHandler</font> : <font color="#2b91af">ICommandHandler</font> &lt; <font color="#2b91af">CreateInventoryItem</font> &gt; </li><li>  { </li><li>  <font color="#0000ff">private readonly</font> IRepository &lt; <font color="#2b91af">InventoryItem</font> &gt; _repository; </li><li></li><li>  <font color="#0000ff">public</font> InventoryCommandHandlers (IRepository &lt; <font color="#2b91af">InventoryItem</font> &gt; repository) </li><li>  { </li><li>  _repository = repository; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> Execute ( <font color="#2b91af">CreateInventoryItem</font> message) </li><li>  { </li><li>  <font color="#0000ff">var</font> item = <font color="#0000ff">new</font> <font color="#2b91af">InventoryItem</font> (message.InventoryItemld, message.Name); </li><li>  _repository.Save (item); </li><li>  } </li><li></li><li>  <font color="#008000">// ...</font> </li><li>  } </li></ol></blockquote><br>  Thus, we implement a method that accepts this command as input, and we indicate what actions we want to perform based on the transmitted data.  Command handlers can be combined logically and implement several ICommandHandler interfaces with one type of command in one such class.  This will result in overloading of methods, and when calling the Execute method, an appropriate command type will be selected. <br><br>  Now, to call the appropriate command handler, you need to create a class that implements the ICommandDispatcher interface.  Unlike the last two, this class is created once and can have different implementations depending on the strategy of registering and invoking command handlers. <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">CommandDispatcher</font> : <font color="#2b91af">ICommandDispatcher</font> </li><li>  { </li><li>  <font color="#0000ff">private readonly</font> IDependencyResolver _resolver; </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">CommandDispatcher</font> (IDependencyResolver resolver) </li><li>  { </li><li>  _resolver = resolver; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> Execute &lt; <font color="#2b91af">TCommand</font> &gt; ( <font color="#2b91af">TCommand</font> command) <font color="#0000ff">where</font> <font color="#2b91af">TCommand</font> : ICommand </li><li>  { </li><li>  <font color="#0000ff">if</font> (command == <font color="#0000ff">null</font> ) <font color="#0000ff">throw new</font> <font color="#2b91af">ArgumentNullException</font> ( <font color="#A31515">"command"</font> ); </li><li></li><li>  <font color="#0000ff">var</font> handler = _resolver. Resolve &lt; <font color="#2b91af">ICommandHandler</font> &lt; <font color="#2b91af">TCommand</font> &gt;&gt; (); </li><li></li><li>  <font color="#0000ff">if</font> (handler == <font color="#0000ff">null</font> ) <font color="#0000ff">throw new</font> <font color="#2b91af">CommandHandlerNotFoundException</font> ( <font color="#0000ff">typeof</font> ( <font color="#2b91af">TCommand</font> )); </li><li></li><li>  handler.Execute (command); </li><li>  } </li><li>  } </li></ol></blockquote><br>  One way to call the desired command handler is to use a DI container, in which all implementations of handlers are registered.  Depending on the transferred command, the instance will be created that processes this type of command.  Then the dispatcher simply calls its Execute method. <br><br>  <b>2. Request stack</b> <br><br>  The request stack deals only with data retrieval.  Requests use a data model that best matches the data used at the presentation level.  You hardly need any business rules ‚Äî they usually apply to commands that change state. <br><br>  The request has the following properties: <br><ul><li>  Does not change the state of the system; </li><li>  The request context stores the data necessary for its execution (paging, filters, etc.); </li><li>  Returns the result. </li></ul><br>  Announcement and use of requests can also be divided into 3 parts: <br><ul><li>  The query class that represents the data with the return type; </li><li>  Request handler class; </li><li>  A class with a method or methods that accept an input request and call exactly the handler that implements the request with the given type. </li></ul><br>  As well as for commands, similar interfaces are declared for requests.  The only difference is that they indicate what should be returned. <br><blockquote><ol><li>  <font color="#0000ff">public interface</font> <font color="#2b91af">IQuery</font> &lt; <font color="#2b91af">TResult</font> &gt; </li><li>  { </li><li>  } </li></ol></blockquote><br>  Here, the type of the returned data is specified as the type argument.  This can be an arbitrary type, for example, string or int []. <br><br>  After the request handler is declared, the return type is also indicated. <br><blockquote><ol><li>  <font color="#0000ff">public interface</font> <font color="#2b91af">IQueryHandler</font> &lt; <font color="#0000ff">in</font> TQuery, <font color="#0000ff">out</font> <font color="#2b91af">TResult</font> &gt; <font color="#0000ff">where</font> TQuery: IQuery &lt; <font color="#2b91af">TResult</font> &gt; </li><li>  { </li><li>  <font color="#2b91af">TResult</font> Execute (TQuery query); </li><li>  } </li></ol></blockquote><br>  Similar to commands, a dispatcher is declared to invoke the request handlers. <br><blockquote><ol><li>  <font color="#0000ff">public interface</font> <font color="#2b91af">IQueryDispatcher</font> </li><li>  { </li><li>  <font color="#2b91af">TResult</font> Execute &lt; <font color="#2b91af">TQuery</font> , <font color="#2b91af">TResult</font> &gt; ( <font color="#2b91af">TQuery</font> query) <font color="#0000ff">where</font> <font color="#2b91af">TQuery</font> : IQuery &lt; <font color="#2b91af">TResult</font> &gt;; </li><li>  } </li></ol></blockquote><br>  <b>Request example.</b>  Suppose you need to create a query that returns users by search criteria.  Here also with the help of a meaningful class name we indicate what the request will be made. <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">FindUsersBySearchTextQuery</font> : <font color="#2b91af">IQuery</font> &lt; <font color="#2b91af">User</font> []&gt; </li><li>  { </li><li>  <font color="#0000ff">public string</font> SearchText { <font color="#0000ff">get</font> ;  } </li><li>  <font color="#0000ff">public bool</font> InactiveUsers { <font color="#0000ff">get</font> ;  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">FindUsersBySearchTextQuery</font> ( <font color="#0000ff">string</font> searchText, <font color="#0000ff">bool</font> inactiveUsers) </li><li>  { </li><li>  SearchText = searchText; </li><li>  InactiveUsers = inactiveUsers; </li><li>  } </li><li>  } </li></ol></blockquote><br>  Next, create a handler that implements IQueryHandler with arguments of the request type and the type of its return value. <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">UserQueryHandler</font> : <font color="#2b91af">IQueryHandler</font> &lt; <font color="#2b91af">FindUsersBySearchTextQuery</font> , <font color="#2b91af">User</font> []&gt; </li><li>  { </li><li>  <font color="#0000ff">private readonly</font> IRepository &lt; <font color="#2b91af">User</font> &gt; _repository; </li><li></li><li>  <font color="#0000ff">public</font> UserQueryHandler (IRepository &lt; <font color="#2b91af">User</font> &gt; repository) </li><li>  { </li><li>  _repository = repository; </li><li>  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">User</font> [] Execute ( <font color="#2b91af">FindUsersBySearchTextQuery</font> query) </li><li>  { </li><li>  <font color="#0000ff">var</font> users = _repository.GetAll (); </li><li>  <font color="#0000ff">return</font> users.Where (user =&gt; user.Name.Contains (query.SearchText)). ToArray (); </li><li>  } </li><li>  } </li></ol></blockquote><br>  After that, it remains to create a class to call the request handlers. <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">QueryDispatcher</font> : <font color="#2b91af">IQueryDispatcher</font> </li><li>  { </li><li>  <font color="#0000ff">private readonly</font> IDependencyResolver _resolver; </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">QueryDispatcher</font> (IDependencyResolver resolver) </li><li>  { </li><li>  _resolver = resolver; </li><li>  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">TResult</font> Execute &lt; <font color="#2b91af">TQuery</font> , <font color="#2b91af">TResult</font> &gt; ( <font color="#2b91af">TQuery</font> query) <font color="#0000ff">where</font> <font color="#2b91af">TQuery</font> : IQuery &lt; <font color="#2b91af">TResult</font> &gt; </li><li>  { </li><li>  <font color="#0000ff">if</font> (query == <font color="#0000ff">null</font> ) <font color="#0000ff">throw new</font> <font color="#2b91af">ArgumentNullException</font> ( <font color="#A31515">"query"</font> ); </li><li></li><li>  <font color="#0000ff">var</font> handler = _resolver. Resolve &lt; <font color="#2b91af">IQueryHandler</font> &lt; <font color="#2b91af">TQuery</font> , <font color="#2b91af">TResult</font> &gt;&gt; (); </li><li></li><li>  <font color="#0000ff">if</font> (handler == <font color="#0000ff">null</font> ) <font color="#0000ff">throw new</font> <font color="#2b91af">QueryHandlerNotFoundException</font> ( <font color="#0000ff">typeof</font> ( <font color="#2b91af">TQuery</font> )); </li><li></li><li>  <font color="#0000ff">return</font> handler.Execute (query); </li><li>  } </li><li>  } </li></ol></blockquote><br><h3>  Call commands and requests </h3><br>  In order to be able to call commands and requests, it is enough to use the appropriate dispatchers and send a specific object with the necessary data.  In an example, it looks like this: <br><blockquote><ol><li>  <font color="#0000ff">public class</font> <font color="#2b91af">UserController</font> : <font color="#2b91af">Controller</font> </li><li>  { </li><li>  <font color="#0000ff">private</font> IQueryDispatcher _queryDispatcher; </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">UserController</font> (IQueryDispatcher queryDispatcher) </li><li>  { </li><li>  _queryDispatcher = queryDispatcher; </li><li>  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">ActionResult</font> SearchUsers ( <font color="#0000ff">string</font> searchString) </li><li>  { </li><li>  <font color="#0000ff">var</font> query = <font color="#0000ff">new</font> <font color="#2b91af">FindUsersBySearchTextQuery</font> (searchString); </li><li></li><li>  <font color="#2b91af">User</font> [] users = _queryDispatcher.Execute (query); </li><li></li><li>  <font color="#0000ff">return</font> View (users); </li><li>  } </li><li>  } </li></ol></blockquote><br>  Having a controller for processing user requests, it is enough to transfer the object of the desired dispatcher as a dependency, then create the request object or command object and transfer it to the dispatcher's Execute method. <br><br>  So we get rid of the need to constantly increase dependencies with an increase in the number of system functions and reduce the number of potential errors. <br><br>  <b>Register Handlers</b> <br><br>  You can register handlers in different ways.  With the help of the DI-container you can register separately or automatically looking at the assembly with the necessary types.  The second option might look like this: <br><blockquote> <code><font color="black"><font color="#0000ff">using</font> SimpleInjector; <br> <br> <font color="#0000ff">var</font> container = <font color="#0000ff">new</font> <font color="#2b91af">Container</font> (); <br> <br> container.Register( <font color="#0000ff">typeof</font> (ICommandHandler&lt;&gt;), <font color="#2b91af">AppDomain</font> .CurrentDomain.GetAssemblies()); <br> <br> container.Register( <font color="#0000ff">typeof</font> (IQueryHandler&lt;,&gt;), <font color="#2b91af">AppDomain</font> .CurrentDomain.GetAssemblies()); <br></font></code> </blockquote><br>  It uses the container <a href="https://simpleinjector.readthedocs.io/en/latest/quickstart.html">SimpleInjector</a> .  When registering handlers with the Register method, the first argument specifies the type of interfaces for command and request handlers, and the second argument is the assembly that searches for classes that implement these interfaces.  Thus, it is not necessary to specify specific handlers, but only a common interface, which is extremely convenient. <br><br>  What if when you call Command / Query you need to check access rights, write information to the log, and the like? <br>  Their centralized call allows you to add actions before or after the execution of the handler, without changing any of them.  It is enough to make changes to the dispatcher itself, or to create a decorator, which, through a DI-container, replaces the original implementation (in the SimpleInjector documentation, examples of such <a href="https://simpleinjector.readthedocs.io/en/latest/aop.html">decorators are</a> described quite well). <br><br><img src="https://habrastorage.org/web/17d/e15/fb1/17de15fb1ba44a9d9ca811b769ddf9be.png" alt="image"><br><br>  <b>Advantages of CQRS</b> <br><ul><li>  Fewer dependencies in each class; </li><li>  The principle of sole responsibility (SRP) is respected; </li><li>  Fits almost everywhere; </li><li>  Easier to replace and test; </li><li>  Easier expands functionality. </li></ul><br>  <b>CQRS restrictions</b> <br><ul><li>  When using CQRS, many small classes appear; </li><li>  When using a simple CQRS implementation, it can be difficult to use a group of commands in a single transaction; </li><li>  If common logic appears in Command and Query, you need to use inheritance or composition.  This complicates the design of the system, but for experienced developers is not an obstacle; </li><li>  It‚Äôs hard to stick with CQS and CQRS.  The simplest example is a method to fetch data from a stack.  Data sampling is Query, but we need to change the state and make the stack size -1.  In practice, you will seek a balance between strict adherence to principles and production necessity; </li><li>  Bad lies on CRUD-applications. </li></ul><br>  <b>Where not suitable</b> <br><ul><li>  In small applications / systems; </li><li>  In predominantly CRUD applications. </li></ul><br><h3>  Conclusion </h3><br>  For applications to be truly effective, they need to adapt to the requirements of the business.  The CQRS-based architecture greatly simplifies the expansion and modification of working business processes and supports new scenarios.  You can manage extensions in complete isolation.  For this, it is enough to add a new handler, register and tell it how to process messages of the required type only.  The new component will be automatically called only when the corresponding message appears and work side by side with the rest of the system.  Easy, simple and efficient. <br><br>  CQRS allows you to optimize the pipeline of commands and requests in any way.  At the same time, optimization of one pipeline will not break the work of another.  In the most basic form of CQRS, one common database is used and different modules are called for read and write operations from the application layer. <br><br>  <b>Sources</b> <br>  ‚Üí <a href="http://blog.byndyu.ru/2014/07/command-and-query-responsibility.html">Alexandre Bindu's blog - CQRS in practice</a> <br>  ‚Üí <a href="https://msdn.microsoft.com/ru-ru/magazine/mt147237.aspx">At the forefront - CQRS for a regular application.</a> <br>  ‚Üí <a href="https://habrahabr.ru/post/313110/">How we tried DDD, CQRS and Event Sourcing and what conclusions did</a> <br>  ‚Üí <a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf">CQRS Documents by Greg Young</a> <br>  ‚Üí <a href="https://github.com/gregoryyoung/m-r">Simple CQRS example</a> <br>  ‚Üí <a href="https://abdullin.com/post/dddd-cqrs-and-other-enterprise-development-buzz-words/">DDDD, CQRS and Other Enterprise Development Buzz-words</a> </div><p>Source: <a href="https://habr.com/ru/post/329970/">https://habr.com/ru/post/329970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329960/index.html">Marie Meeker report from the Code Conference: the main thing</a></li>
<li><a href="../329962/index.html">Safety Guide for Web Developers</a></li>
<li><a href="../329964/index.html">Identity-as-a-Service (IDaaS). What is it?</a></li>
<li><a href="../329966/index.html">Psychology of testing (of course, not exhaustive). Personal translation from the book ‚ÄúThe Art of Testing‚Äù by G. Myers</a></li>
<li><a href="../329968/index.html">‚ÄúPreparing for the transition to Angular 4‚Äù: Tinkoff.ru about JS-development</a></li>
<li><a href="../329972/index.html">Creating a 2.5D software engine</a></li>
<li><a href="../329974/index.html">Andrei Satarin, Yandex: ‚ÄúThe biggest mistake is the lack of understanding of the system‚Äù</a></li>
<li><a href="../329978/index.html">Was Gartner right in predicting a change in approach to providing information security?</a></li>
<li><a href="../329980/index.html">"Confrontation" PHDays VII: Beginners are lucky or rob banks, break GSM</a></li>
<li><a href="../329982/index.html">Determining the number of a Telegram user using brute force in the address book</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>