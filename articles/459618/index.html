<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A few obscure docker-compose features.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In many instructions from the Internet, they describe a certain minimum of actions, and as a result, a minimum of commands and capabilities. 


 I dec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A few obscure docker-compose features.</h1><div class="post__text post__text-html js-mediator-article"><p>  In many instructions from the Internet, they describe a certain minimum of actions, and as a result, a minimum of commands and capabilities. </p><br><p>  I decided to make some sort of low-lit features, features.  The article does not pretend to be unique, this is me, as a reminder, and perhaps some Padawans will help, starting their journey with docker-compose. </p><a name="habracut"></a><br><h4 id="ispolzovanie-neskolkih-docker-composeyml-faylov">  Using multiple docker-compose.yml files </h4><br><p>  There are complex configurations, where there is a certain base layer of containers, which, say, is always needed.  And it usually happens that we take from the neighboring team \ another project \ Internet and finish it to fit our needs.  But if there are several commands, then the basic part can be transferred to a common, internal repository.  And we get an identical basic part of most projects, which is also versioned. </p><br><p>  We describe an example of a basic docker-compose-base.yml. </p><br><p>  Suppose this is a customized nginx image with certificates, tuning, and say metrics.  And the exporter for prometheus: </p><br><pre><code class="plaintext hljs">version: '2' services: nginx: image: nginx nginx-exporter: image: nginx/nginx-prometheus-exporter</code> </pre> <br><p>  Now we will describe an example of our docker-compose-app.yml application: </p><br><pre> <code class="plaintext hljs">version: '2' services: backend: image: internal.local/super-app:0.1.2</code> </pre> <br><p>  To start you need a familiar team with one difference.  We will specify 2 docker-compose files: </p><br><pre> <code class="plaintext hljs">docker-compose up -d -f docker-compose-base.yml -f docker-compose-app.yml</code> </pre> <br><p>  And voila, we get a set of services, as if they were described in a single docker-compose file! </p><br><p>  There is also a second use case for multiple files, through the use of the extends directive. </p><br><p>  docker-compose-base.yml: </p><br><pre> <code class="plaintext hljs">version: '2' services: nginx: image: nginx nginx-exporter: image: nginx/nginx-prometheus-exporter</code> </pre><br><p>  docker-compose-app.yml: </p><br><pre> <code class="plaintext hljs">version: '2' services: backend: image: internal.local/super-app:0.1.2 ###      web: extends: #     (   ) file: docker-compose-base.yml #       service: nginx web-exporter: extends: file: docker-compose-base.yml service: nginx-exporter</code> </pre> <br><p>  Addition from <a href="https://habr.com/ru/users/islava/" class="user_link">iSlava</a> : <br>  You can describe all compose files in environment variables, and use docker-compose up -d without specifying the files manually: </p><br><pre> <code class="plaintext hljs">COMPOSE_PATH_SEPARATOR=: COMPOSE_FILE=docker-compose-base.yml:docker-compose-app.yml</code> </pre> <br><p>  Which option to choose - you choose.  All individually, I just wanted to show the options =) </p><br><h4 id="nasledovanie-v-docker-compose">  Docker-compose inheritance </h4><br><p>  The following example requires docker-compose <strong>&gt; = 2.4</strong> <br>  It is also a rather interesting feature, and it is actually mentioned in few places. <br>  This functionality allows us to describe several services of the same type in the docker-compose file, while not duplicating their description, namely inheriting. <br>  For example, we have this file: </p><br><pre> <code class="plaintext hljs">version: '2.4' services: backend: image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro</code> </pre> <br><p>  And there was a need to raise several containers, but with some differences, we can of course "accumulate" and change, and we can do this: </p><br><pre> <code class="plaintext hljs">version: '2.4' services: backend: &amp;base-app #          image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro backend-2: &lt;&lt;: *base-app # ports: #    - 8081:8080</code> </pre> <br><p>  Thus, we get the opportunity to change in one place than to rule in the description of each container. <br>  There is another option to bring to the root area, for example: </p><br><pre> <code class="plaintext hljs">version: '2.4' services: x-backend: #   "x-"  ,    . &amp;base-app image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro backend: &lt;&lt;: *base-app # backend-2: &lt;&lt;: *base-app # ports: #    - 8081:8080</code> </pre> <br><h4 id="ogranicheniya-po-resursam">  Resource Limits </h4><br><p>  Starting from version 2.2, you can use resource limits for containers, in fact, from version 2.1, but not everything has been delivered there =) <br>  There is a nuance!  <u>In version <strong>3,</strong> these features are removed!</u>  There is an emphasis on docker swarm. </p><br><p>  The simplest example of limiting resources by CPU, MEM: </p><br><pre> <code class="plaintext hljs">version: '2.2' services: backend: cpus: 1.5 #   . cpuset: '0,3' #     . mem_limit: 1gb #  1  memswap_limit: 2gb # SWAP   . oom_kill_disable: true #   ,    OOM Killer        ,       . image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro</code> </pre> <br><h4 id="upakovka-obrazov-v-arhiv">  Packing images to archive </h4><br><p>  Unfortunately, it is not always possible to push the images in your docker registry or your cloud.  Sometimes it's worth having to collect images from a docker-compose file and send, say, a file archive.  I sometimes do this for a long time with my hands, so I sketched a simple script, all of a sudden someone will come in handy: </p><br><pre> <code class="plaintext hljs">#!/bin/bash dc=${1} if [ ! -z ${dc} ] &amp;&amp; [ -f ${dc} ]; then echo "Saving docker images from file ${dc}..." images=`grep image: ${dc} | awk '{print $2}'` docker save ${images} | gzip &gt; docker-images.gz echo "Success!" else echo "ERROR! You must set path to docker-compose.yml as argument!" fi</code> </pre> <br><p>  We save in the file we will tell docker-compose-images-save.sh <br>  We give the right to perform: <br> <code>chmod +x docker-compose-images-save.sh</code> <br>  Run, and pass the path to the docker-compose file as an argument: <br> <code>./docker-compose-images-save.sh /home/some_user/docker-compose-app.yml</code> <br>  At the output we get in the folder from where the script called the archive with images - <code>docker-images.gz</code> <br>  In any available way we send to a remote server. <br>  Now on the remote server is enough to perform: <br> <code>gzip -cd docker-images.gz | docker load</code> <br>  All images will be loaded into the local registry, after which you can safely run here. <br>  <code>docker-compose up -d</code> , since all the images are already in the local registry on the Internet, the docker will not work. </p><br><h4 id="probrasyvaem-ipv6">  IPv6 forwarding </h4><br><p>  In certain tasks, ipv6 is extremely useful, take at least a caveat that Roskomnadzor passes all traffic through ipv6 without problems, and the same telegram bot works without problems. <br>  I will consider the situation when ipv6 is not on your machine, be it a virtual machine, or a server on the Internet. <br>  You need to make sure that ipv6 is enabled at the system level: </p><br><pre> <code class="plaintext hljs"> sysctl net.ipv6.conf.all.disable_ipv6</code> </pre> <br><p>  The value should be 0, if not, change: </p><br><pre> <code class="plaintext hljs"> sysctl -w net.ipv6.conf.all.disable_ipv6=0</code> </pre> <br><p>  Install miredo (This is a service with a built-in VPN to the server, which will give us a public ipv6) </p><br><pre> <code class="plaintext hljs"> apt-get install miredo -y</code> </pre> <br><p>  Check that the service is running: </p><br><pre> <code class="plaintext hljs"> systemctl status miredo</code> </pre> <br><p>  Check that we got the ipv6 address: </p><br><pre> <code class="plaintext hljs"> ifconfig teredo</code> </pre> <br><p>  Register in /etc/docker/daemon.json </p><br><pre> <code class="plaintext hljs"> { "ipv6": true, "fixed-cidr-v6": "2001:db8:1::/64" }</code> </pre> <br><p>  Restart docker: </p><br><pre> <code class="plaintext hljs"> systemctl restart docker</code> </pre> <br><p>  Well, it remains to enable NAT for ipv6 so that the internal addresses of our container can go to the outside world through our teredo interface: </p><br><pre> <code class="plaintext hljs"> ip6tables -t nat -A POSTROUTING -o teredo -j MASQUERADE</code> </pre> <br><p>  We raise the docker container we need, and it can be published via the ipv6 address. </p><br><blockquote>  The given example with sysctl and iptables will work before the reboot, if you need to do it on an ongoing basis, you should see the instructions for your distribution, there are differences. </blockquote><p>  I hope someone the information provided here will be useful. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459618/">https://habr.com/ru/post/459618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459606/index.html">Distributed social networks</a></li>
<li><a href="../459610/index.html">These dangerous routers: the most large-scale hacks of recent network equipment and ways to protect</a></li>
<li><a href="../459612/index.html">How Qualcomm has ripped off the mobile industry for almost 20 years in a row.</a></li>
<li><a href="../459614/index.html">Utko-robot muddies the water in the rice fields</a></li>
<li><a href="../459616/index.html">MIPT Opens the First Advanced Master Program in Russia in Computer Science and Software Engineering</a></li>
<li><a href="../45962/index.html">Markup. Transitional vs Strict</a></li>
<li><a href="../459620/index.html">TDDx2, BDD, DDD, FDD, MDD and PDD, or anything else you want to know about Driven Development</a></li>
<li><a href="../459622/index.html">How in 1995 they wrote games for Sega Saturn</a></li>
<li><a href="../459624/index.html">Combat drones</a></li>
<li><a href="../459628/index.html">The Open Invention Network has more than three thousand licensees - what does this mean for open source software?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>