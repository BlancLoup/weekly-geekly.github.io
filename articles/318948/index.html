<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Finding GDI Object Leaks: How to Drive a Mastodon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Strictly speaking, this is the original text of the article, and the blog is already a translation. Here the article is published a little later and o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Finding GDI Object Leaks: How to Drive a Mastodon</h1><div class="post__text post__text-html js-mediator-article">  <i>Strictly speaking, this is the original text of the article, and the <a href="http://codingsight.com/gdi-leak-handling/">blog is</a> already a translation.</i>  <i>Here the article is published a little later and only because it receives a translation tag.</i> <br><br>  In 2016, when most programs are executed in sandboxes, of which even the most incompetent developer cannot harm the system, it is strange to face a problem that will be discussed further.  To be honest, I hoped that she had gone into the distant past with Win32Api, but recently I ran into it.  Before that, I had only heard the creepy tales of <s>older,</s> more experienced developers, what this could be. <br><br><h3>  Problem </h3><br>  Leak or use too many GDI objects. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Symptoms: </h3><br><ul><li>  In the Task Manager on the Details tab, the GDI objects column shows a threatening 10,000 (If this column is not present, you can add it by clicking on the table header with the right button and selecting the Select Columns option) </li><li>  When developing in C # or another language performed by the CLR, an exception is thrown that does not shine with specificity: <br><blockquote>  Message: A generic error occurred in GDI +. <br>  Source: System.Drawing <br>  TargetSite: IntPtr GetHbitmap (System.Drawing.Color) <br>  Type: <b>System.Runtime.InteropServices.ExternalException</b> </blockquote><br>  Also, with certain settings or a version of the system, the exclusion may not be present, but your application will not be able to draw a single object. <br></li><li>  When developing in C / C ++, all GDI methods like Create% SOME_GDI_OBJECT% began to return NULL </li></ul><a name="habracut"></a><br><h3>  Why? </h3><br>  On Windows family systems, no more than 65535 GDI objects can be created simultaneously.  The number, in fact, is unbelievably large and should not come close to under any normal scenario.  The process is set to a limit of 10,000, which although you can change (in the registry, change the value of HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Windows \ GDIProcessHandleQuota from 256 to 65535), but Microsoft strongly does not recommend increasing this limit.  If this is done, then one process will have the opportunity to put the system so that it cannot even draw an error message.  In this case, the system can only come to life after a reboot. <br><br><h3>  How to fix? </h3><br>  If you live in a tidy CLR-controlled world, then the probability of 9 out of 10 is that you have a memory leak in your application.  The problem, though unpleasant, is rather ordinary, and there are at least a dozen excellent tools for finding it.  I will not dwell on this in detail.  You will only need to use any profiler to see if the number of wrapper objects over GDI resources is increasing: Brush, Bitmap, Pen, Region, Graphics.  If this is true, then you are lucky, you can close the tab with the article. <br><br>  If there is no leakage of wrapper objects, it means that you have direct use of GDI functions in the code and a scenario in which they are not deleted. <br><br><h3>  What will others advise you? </h3><br>  The official Microsoft manual or other articles on this subject that you find on the Internet will advise something like the following: <br><br>  Find all <b>Create</b> % SOME_GDI_OBJECT% and find out if there is a corresponding <b>DeleteObject</b> (or ReleaseDC for HDC objects), and if there is, then perhaps there is a script in which it will not be called. <br><br>  There is a slightly improved version of this method, it contains an additional first step: <br><br>  Download the utility <a href="http://www.nirsoft.net/utils/gdi_handles.html">GDIView</a> .  It can show a specific number of GDI objects by type and the only thing that is alarming is that the sum of all does not correspond to the value in the last column.  You can try not to pay attention to this, if it helps to narrow down the search zone in any way. <br><br><img src="https://habrastorage.org/files/7d7/b76/ecc/7d7b76eccd5e413582abd34d6b4048af.png"><br><br>  The project I am working on has a code base of more than 9 million lines and about the same in third-party libraries, hundreds of GDI function calls spread across dozens of files.  I spent a lot of energy and coffee before I realized that it‚Äôs simply impossible to analyze it manually without missing anything. <br><br><h3>  What will I offer? </h3><br>  If this method seems to you too long and requires extra gestures, it means that you have not gone through all the stages of despair with the previous one.  You can try the previous steps a few more times, but if it does not help, then do not discount this option. <br><br>  Looking for a leak, I wondered: ‚ÄúWhere are the objects that flow away?‚Äù It was absolutely impossible to put breakpoints in all places where API functions are called.  In addition, there was no complete certainty that this does not happen in the .net framework or one of the third-party libraries that we use.  A few minutes of googling led me to the <a href="http://www.rohitab.com/apimonitor">Api Monitor</a> utility, which allowed me to log and debug calls to any system functions.  I easily found a list of all the functions generating GDI objects, honestly found them and selected them in the Api Monitor, after which I set breakpoints. <br><br><img src="https://habrastorage.org/files/7fc/981/05f/7fc98105f4c247d8a86e73bcd80f435a.png"><br><br>  Then I <b>started the process for debugging in Visual Studio</b> , and here I chose it in the process tree.  The first breakpoint worked instantly: <br><br><img src="https://habrastorage.org/files/9ce/62c/5b7/9ce62c5b7a4f4dc4ae5383f9dc3eaa6f.png"><br><br>  There were too many challenges.  I quickly realized that I would drown in this stream and need to come up with something else.  I removed the breakpoints from the functions and decided to see the log.  These were thousands and thousands of challenges.  It became obvious that they could not be analyzed manually. <br><br><img src="https://habrastorage.org/files/fc8/799/fd9/fc8799fd9d294c06a533c06a28e3ada6.png"><br><br>  <b>Task:</b> Find those calls to GDI functions that do not correspond to deletion.  The log contains everything you need: a list of function calls in chronological order, their return values ‚Äã‚Äãand parameters.  It turns out that I need to take the return value of the function Create% SOME_GDI_OBJECT% and find the call to DeleteObject with this value as an argument.  I selected all the entries in the Api Monitor, pasted it into a text file and received something like a CSV with a TAB separator.  I started VS, where I thought to write a program to parse it, but before it was loaded, I had a better idea: export the data to the database and write a query in order to get what interests me.  It was the right choice, because it allowed me to quickly ask questions and get answers to them. <br><br>  There are many tools to import data from CSV into the database, so I will not stop at this ( <a href="https://dev.mysql.com/doc/workbench/en/wb-admin-export-import-table.html">mysql</a> , <a href="https://support.discountasp.net/kb/a1179/how-to-import-a-csv-file-into-a-database-using-sql-server-management-studio.aspx">mssql</a> , <a href="http://stackoverflow.com/questions/14947916/import-csv-to-sqlite">sqlite</a> ). <br><br>  I got this table: <br><br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- mysql code CREATE TABLE apicalls ( id int(11) DEFAULT NULL, `Time of Day` datetime DEFAULT NULL, Thread int(11) DEFAULT NULL, Module varchar(50) DEFAULT NULL, API varchar(200) DEFAULT NULL, `Return Value` varchar(50) DEFAULT NULL, Error varchar(100) DEFAULT NULL, Duration varchar(50) DEFAULT NULL )</span></span></code> </pre> <br>  Wrote the mysql function to get the handle of the object to be deleted from the call to api: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> getHandle(api <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(api,<span class="hljs-string"><span class="hljs-string">','</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- for ReleaseDC where HDC is second parameter. ex: 'ReleaseDC ( 0x0000000000010010, 0xffffffffd0010edf )' IF start = 0 THEN SET start := INSTR(api, '('); END IF; SET result := SUBSTRING_INDEX(SUBSTR(api, start + 1), ')', 1); RETURN TRIM(result); END</span></span></code> </pre><br>  Finally, a query that finds all current objects: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> creates.id, creates.handle chandle, creates.API, dels.API deletedApi <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> a.id, a.<span class="hljs-string"><span class="hljs-string">`Return Value`</span></span> handle, a.API <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> apicalls a <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> a.API <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'Create%'</span></span>) creates <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.id, d.API, getHandle(d.API) handle <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> apicalls d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> API <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'DeleteObject%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> API <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'ReleaseDC%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) dels <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dels.handle = creates.handle <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> creates.API <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'Create%'</span></span>;</code> </pre>  <i>(Strictly speaking, it will simply find all Delete calls to all Create calls.)</i> <br><br><img src="https://habrastorage.org/files/4b5/548/8b2/4b55488b24ef45378344115eb672421e.png"><br>  <i>The figure immediately shows calls for which there was not a single Delete.</i> <br><br>  The last question remains: <b>How to find where these methods are called from in the context of my code?</b>  And here one tricky trick helped me: <br><br><ol><li>  Run the debug application in VS. </li><li>  Find it in Api Monitor and select. </li><li>  Select the desired function Api and put a breakpoint. </li><li>  Patiently click ‚ÄúNext‚Äù until it is called up with parameters of interest.  (So ‚Äã‚Äãhow was the conditional breakpoints from vs missing? </li><li>  When you reach the desired call, go to VS and press break all. </li><li>  The VS debugger will be stopped at the place where the leaking object is created and it remains only to find why it is not deleted. <br></li></ol><br><img src="https://habrastorage.org/files/66b/e6a/2b1/66be6a2b187142d3afd9b1fbbc98feed.png"><br>  <i>(The code is written solely for example)</i> <br><br><h3>  Summary: </h3><br>  The algorithm is long and complex, many tools are involved in it, but it gave me a result much faster than a dumb search for errors on a huge code base. <br><br>  Here it is, for those who were too lazy to read, or who had already forgotten how it all began, while reading: <br><br><ol><li>  Search GDI Wrapper Object Memory Leaks </li><li>  If they are, eliminate and repeat the first step. </li><li>  If they are not there, then look for calls to the api functions directly. </li><li>  If there are not many of them, then search for a scenario in which the object may not be deleted. </li><li>  If there are a lot of them or it is impossible to track them, then you need to download the Api Monitor and configure it to log calls to GDI functions. </li><li>  Run the debug application in VS </li><li>  Reproduce leakage (this initializes the program so that cached objects are not mazol eyes in the log). </li><li>  Connect with Api Monitor. </li><li>  Reproduce the leak. </li><li>  Copy the log to a text file, import into any database that is at hand (the scripts in the article for mysql, but easily adapt to any RDBMS) </li><li>  Match the Create and Delete methods (the SQL script is earlier in this article), find those that do not have the Delete call </li><li>  Set a breakpoint on the required method in Api Monitor. </li><li>  Press continue until the method is called with the desired parameters.  Cry for lack of conditional breakpoints. </li><li>  When the method is called with the necessary parameters, click Break All in VS. </li><li>  Find why this object is not deleted. </li></ol><br>  I really hope that this article will save someone a lot of time and will be useful. </div><p>Source: <a href="https://habr.com/ru/post/318948/">https://habr.com/ru/post/318948/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318936/index.html">Solution Architecture in 2017: interview with Eli Feldman, SRT EPAM</a></li>
<li><a href="../318938/index.html">Game HellWorm. Development history</a></li>
<li><a href="../318940/index.html">We're friends with Prometheus with Cach√©</a></li>
<li><a href="../318944/index.html">In search of free tickets, the study of the game Aeroflot: Mission 2017</a></li>
<li><a href="../318946/index.html">How to find a way to win the Russian AI Cup 2016, but in the wrong direction</a></li>
<li><a href="../318950/index.html">NativeScript, what kind of beast and what is it for?</a></li>
<li><a href="../318952/index.html">Let's Encrypt and nginx: configuration in Debian and Ubuntu</a></li>
<li><a href="../318954/index.html">Processing preprocessor directives in Objective-C</a></li>
<li><a href="../318958/index.html">json-api-normalizer: an easy way to make friends with Redux and the JSON API</a></li>
<li><a href="../318960/index.html">Scala type classes (with a little overview of the cats library)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>