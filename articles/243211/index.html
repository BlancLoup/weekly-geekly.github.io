<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oil Rows in R</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúPrice charts are great to predict the past‚Äù 
 Peter Lynch 


 I somehow could not deal with time series in practice. I, of course, read about them an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oil Rows in R</h1><div class="post__text post__text-html js-mediator-article">  <i>‚ÄúPrice charts are great to predict the past‚Äù</i> <i><br></i>  <i>Peter Lynch</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/94c/a8e/061/94ca8e0618b141a385b73ee8886108e0.png"></div><br>  I somehow could not deal with <a href="https://en.wikipedia.org/wiki/Time_series">time series</a> in practice.  I, of course, read about them and had some idea in the course of the course on how the analysis is carried out in general, but it is well known that what is said in textbooks on statistics and machine learning does not always reflect the real state of affairs. <br><a name="habracut"></a><br>  Probably, many are following with interest the pirouettes that the <a href="http://www.oil-price.net/">oil price curve</a> makes.  The schedule looks chaotic, too regular, and making some predictions on it is a very ungrateful task.  Of course, you can bring down all the power of statistical, economic-mathematical and expert methods to the time series, but we will try to deal with <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2585%25D0%25BD%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7">technical analysis</a> - of course, based on R. <br><br>  When working with normal time series, you can use the standard approach: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Visual analysis </li><li>  Decomposition of a series and study of its component: seasonality, cyclicity, trend </li><li>  Building a mathematical model and forecasting </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cb0/979/509/cb097950936844529cb56d74c1966654.png"></div><br><br>  There is a very convenient data source - <a href="https://www.quandl.com/">Quandl</a> ;  it provides an interface for Matlab, Python, R. For R, just install one package: <code>install.packages("Quandl")</code> .  I am interested in <a href="https://www.quandl.com/DOE/RBRTE-Europe-Brent-Crude-Oil-Spot-Price-FOB">Europe Brent Crude Oil Spot Price</a> - the <a href="https://en.wikipedia.org/wiki/Spot_contract">spot price</a> for Brent crude oil (below we use three sets of data in different details). <br><br><pre> <code class="hljs scala">library(<span class="hljs-type"><span class="hljs-type">Quandl</span></span>) oil.ts &lt;- <span class="hljs-type"><span class="hljs-type">Quandl</span></span>(<span class="hljs-string"><span class="hljs-string">"DOE/RBRTE"</span></span>, trim_start=<span class="hljs-string"><span class="hljs-string">"1987-11-10"</span></span>, trim_end=<span class="hljs-string"><span class="hljs-string">"2015-01-01"</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"zoo"</span></span>) oil.tsw &lt;-<span class="hljs-type"><span class="hljs-type">Quandl</span></span>(<span class="hljs-string"><span class="hljs-string">"DOE/RBRTE"</span></span>, trim_start=<span class="hljs-string"><span class="hljs-string">"1987-11-10"</span></span>, trim_end=<span class="hljs-string"><span class="hljs-string">"2015-01-01"</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"zoo"</span></span>, collapse=<span class="hljs-string"><span class="hljs-string">"weekly"</span></span>) oil.tsm &lt;-<span class="hljs-type"><span class="hljs-type">Quandl</span></span>(<span class="hljs-string"><span class="hljs-string">"DOE/RBRTE"</span></span>, trim_start=<span class="hljs-string"><span class="hljs-string">"1987-11-10"</span></span>, trim_end=<span class="hljs-string"><span class="hljs-string">"2015-01-01"</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"ts"</span></span>, collapse=<span class="hljs-string"><span class="hljs-string">"monthly"</span></span>) plot(oil.tsm, xlab=<span class="hljs-string"><span class="hljs-string">"Year"</span></span>, ylab=<span class="hljs-string"><span class="hljs-string">"Price, $"</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"l"</span></span>) lines(lowess(oil.tsm), col=<span class="hljs-string"><span class="hljs-string">"red"</span></span>, lty=<span class="hljs-string"><span class="hljs-string">"dashed"</span></span>)</code> </pre><br><div style="text-align:center;"><img src="http://habrastorage.org/files/3af/bf9/2ca/3afbf92ca215444f8b5779e790d33812.png"></div><br><br>  If we consider prices on the scale of decades, then we can see several peaks and falls and the direction of the trend, but in general it is difficult to draw any significant conclusions, so we examine the components of the series. <br><br><pre> <code class="hljs lisp">plot(<span class="hljs-name"><span class="hljs-name">decompose</span></span>(<span class="hljs-name"><span class="hljs-name">oil</span></span>.tsm, type=<span class="hljs-string"><span class="hljs-string">"multiplicative"</span></span>))</code> </pre><br><br><div style="text-align:center;"><img src="http://habrastorage.org/files/958/7e9/ef4/9587e9ef486042aa9f7bb2834bf4f7a9.png"></div><br><br>  It seems that everything is clear with the trend - in the 21st century there is a steady upward trend until recently (with the exception of interesting years), a number of <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25B0%25D1%2580%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">non</a> - <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25B0%25D1%2580%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">stationary</a> - the <a href="https://en.wikipedia.org/wiki/Augmented_Dickey%25E2%2580%2593Fuller_test">Dicky-Fuller advanced test</a> also proves this: <br><br><pre> <code class="hljs pgsql">&gt;library(tseries) &gt;library(forecast) &gt;adf.test(oil.tsm, alternative=c(<span class="hljs-string"><span class="hljs-string">'stationary'</span></span>)) Augmented Dickey-Fuller Test data: oil.tsm Dickey-Fuller = <span class="hljs-number"><span class="hljs-number">-2.7568</span></span>, Lag <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> = <span class="hljs-number"><span class="hljs-number">6</span></span>, p-<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-number"><span class="hljs-number">0.2574</span></span> alternative hypothesis: stationary</code> </pre><br>  On the other hand, with a fairly high degree of confidence, it can be argued that the first-order differences of the series are stationary, i.e.  This is an <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B2%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2580%25D1%258F%25D0%25B4">integrated first-order time series</a> (this fact will further allow us to apply the <a href="https://ru.wikipedia.org/wiki/ARIMA">Box-Jenkins methodology</a> ). <br><br><pre> <code class="hljs haskell">&gt;adf.test(diff(oil.tsm), alternative=c('stationary')) <span class="hljs-type"><span class="hljs-type">Augmented</span></span> <span class="hljs-type"><span class="hljs-type">Dickey</span></span>-<span class="hljs-type"><span class="hljs-type">Fuller</span></span> <span class="hljs-type"><span class="hljs-type">Test</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">: diff(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oil</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tsm</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dickey</span></span></span><span class="hljs-class">-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fuller</span></span></span><span class="hljs-class"> = -8.0377, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lag</span></span></span><span class="hljs-class"> order = 6, p-value = 0.01 alternative hypothesis: stationary &gt; ndiffs(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oil</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tsm</span></span></span><span class="hljs-class">) [1] 1</span></span></code> </pre><br>  In addition, it turns out that there is a seasonal component, which is difficult to see on the general chart.  If you look closely, then besides the rather high <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BE%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">volatility</a> , you can see two price hikes during the year (which may be due to the increased consumption of oil in the winter period and the holiday season).  On the other hand, there is a random component, the weight of which increases especially in critical years (for example, the 2008 financial crisis). <br>  Sometimes it is preferable to work with data after a <a href="http://www.machinelearning.ru/wiki/index.php%3Ftitle%3D%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_%25D0%2591%25D0%25BE%25D0%25BA%25D1%2581%25D0%25B0-%25D0%259A%25D0%25BE%25D0%25BA%25D1%2581%25D0%25B0">one-parameter Box-Cox transformation</a> , which allows to stabilize the variance and bring the data to a more normal form: <br><br><pre> <code class="hljs pgsql">L &lt;- BoxCox.lambda(ts(oil.ts, frequency=<span class="hljs-number"><span class="hljs-number">260</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>="loglik") Lw &lt;- BoxCox.lambda(ts(oil.tsw, frequency=<span class="hljs-number"><span class="hljs-number">52</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>="loglik") Lm &lt;- BoxCox.lambda(oil.tsm, <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>="loglik")</code> </pre><br>  As for the most slippery topic, namely, extrapolation, in the article <a href="https://caia.org/sites/default/files/3.RESEARCH%2520REVIEW.pdf">‚ÄúCrude Oil Price Forecasting Techniques: a Comprehensive Review of Literature‚Äù the</a> authors note that, depending on the length of the time gap, the models are applicable: <br><br><ol><li>  for the medium and long term, nonlinear models are more like - the same neural networks, support vector machines; </li><li>  for the short term, <a href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA</a> often surpasses neural networks. </li></ol><br>  After all the formalities, we will use the function <code>nnetar()</code> that is present in the <code>forecast</code> package, with which it is possible to construct a neural network model of the series without any difficulties.  At the same time we will do it for three rows - from more detailed (by day) to less detailed (by months).  At the same time, let's see what will happen in the medium term - for example, over 2 years (in the graphs this is displayed in blue). <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># Fit NN for long-run fit.nn </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nnetar</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ts</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">oil.ts</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">frequency</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">260),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lambda</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">L,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fcast.nn</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">forecast</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fit.nn</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">520,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lambda</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">L)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fit.nnw</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nnetar</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ts</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">oil.tsw</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">frequency</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">52),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lambda</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">Lw,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fcast.nnw</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">forecast</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fit.nnw</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">104,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lambda</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">Lw)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fit.nnm</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nnetar</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">oil.tsm</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lambda</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">Lm,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fcast.nnm</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">forecast</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fit.nnm</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">h</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">24,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lambda</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">Lm)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">par</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mfrow</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">c(3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">plot</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fcast.nn</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">include</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1040)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">plot</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fcast.nnw</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">include</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">208)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">plot</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fcast.nnm</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">include</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">48)</span></span></span></span></span></span></code> </pre><br></div></div><br><div style="text-align:center;"><img src="http://habrastorage.org/files/8e1/8a0/801/8e18a08013b6491a92c9a50484aa0494.png"></div><br><br>  What worked out well on the top chart was <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2583%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">retraining</a> : the neural network caught the last pattern in the row and began to copy it.  On the average chart, the network not only copies the last pattern, but also combines it well with the trend, which gives some realism to the forecast.  In the lower graph it turned out ... some kind of unintelligible curve.  Graphs well illustrate how predictions change depending on data smoothing.  In any case, for products with high (for various reasons) volatility, predictions for such a time period cannot be trusted, so we will immediately move on to the short-term period, and at the same time compare several different models - <a href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA</a> , <a href="http://robjhyndman.com/hyndsight/tbats-with-regressors/">tbats</a> and neural network.  We will use the data for the last half year and especially highlight the month of December in the series short.test - for testing purposes. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"># Fit ARIMA, NN <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ETS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> short-run short &lt;- ts(oil.ts[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(oil.ts) &gt; "2014-06-30" &amp; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(oil.ts) &lt; "2014-12-01"], frequency=<span class="hljs-number"><span class="hljs-number">20</span></span>) short.test &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(oil.ts[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(oil.ts) &gt;= "2014-12-01",]) h &lt;- length(short.test) fit.arima &lt;- auto.arima(short, lambda=L) fcast.arima &lt;- forecast(fit.arima, h, lambda=L) fit.nn &lt;- nnetar(short, size=<span class="hljs-number"><span class="hljs-number">7</span></span>, lambda=L) fcast.nn &lt;- forecast(fit.nn, h, lambda=L) fit.tbats &lt;-tbats(short, lambda=L) fcast.tbats &lt;- forecast(fit.tbats, h, lambda=L) par(mfrow=c(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) plot(fcast.arima, <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>=<span class="hljs-number"><span class="hljs-number">3</span></span>*h) plot(fcast.nn, <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>=<span class="hljs-number"><span class="hljs-number">3</span></span>*h) plot(fcast.tbats, <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>=<span class="hljs-number"><span class="hljs-number">3</span></span>*h)</code> </pre><br></div></div><br><div style="text-align:center;"><img src="//habrastorage.org/files/773/8f7/948/7738f794839945a6aad53d937052fe85.png"></div><br><br>  The neural network, having retrained, went somewhat into the astral, and ARIMA showed a very interesting relationship - interesting in terms of proximity to the real picture.  Below is a comparison of the predictions of each model with real data in December and <a href="https://en.wikipedia.org/wiki/Mean_absolute_percentage_error">mean absolute percentage error</a> : <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs lisp">par(<span class="hljs-name"><span class="hljs-name">mfrow=c</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) plot(<span class="hljs-name"><span class="hljs-name">short</span></span>.test, type=<span class="hljs-string"><span class="hljs-string">"l"</span></span>, col=<span class="hljs-string"><span class="hljs-string">"red"</span></span>, lwd=5, xlab=<span class="hljs-string"><span class="hljs-string">"Day"</span></span>, ylab=<span class="hljs-string"><span class="hljs-string">"Price, $"</span></span>, main=<span class="hljs-string"><span class="hljs-string">"December prices"</span></span>, ylim=c(<span class="hljs-name"><span class="hljs-name">min</span></span>(<span class="hljs-name"><span class="hljs-name">short</span></span>.test, fcast.arima$mean, fcast.tbats$mean, fcast.nn$mean), max(<span class="hljs-name"><span class="hljs-name">short</span></span>.test, fcast.arima$mean, fcast.tbats$mean, fcast.nn$mean))) lines(<span class="hljs-name"><span class="hljs-name">as</span></span>.numeric(<span class="hljs-name"><span class="hljs-name">fcast</span></span>.nn$mean), col=<span class="hljs-string"><span class="hljs-string">"green"</span></span>, lwd=3,lty=2) lines(<span class="hljs-name"><span class="hljs-name">as</span></span>.numeric(<span class="hljs-name"><span class="hljs-name">fcast</span></span>.tbats$mean), col=<span class="hljs-string"><span class="hljs-string">"magenta"</span></span>, lwd=3,lty=2) lines(<span class="hljs-name"><span class="hljs-name">as</span></span>.numeric(<span class="hljs-name"><span class="hljs-name">fcast</span></span>.arima$mean), col=<span class="hljs-string"><span class="hljs-string">"blue"</span></span>, lwd=3, lty=2) legend(<span class="hljs-string"><span class="hljs-string">"topright"</span></span>, legend=c(<span class="hljs-string"><span class="hljs-string">"Real Data"</span></span>,<span class="hljs-string"><span class="hljs-string">"NeuralNet"</span></span>,<span class="hljs-string"><span class="hljs-string">"TBATS"</span></span>, <span class="hljs-string"><span class="hljs-string">"ARIMA"</span></span>), col=c(<span class="hljs-string"><span class="hljs-string">"red"</span></span>,<span class="hljs-string"><span class="hljs-string">"green"</span></span>, <span class="hljs-string"><span class="hljs-string">"magenta"</span></span>,<span class="hljs-string"><span class="hljs-string">"blue"</span></span>), lty=c(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), lwd=c(<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)) grid()</code> </pre><br></div></div><br><br><div style="text-align:center;"><img src="http://habrastorage.org/files/ead/e0d/5f7/eade0d5f7a1c449288e7405e84e464c1.png"></div><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs matlab">mape &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r, f)</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum( abs(r - f$mean[1:len])</span></span></span><span class="hljs-function"> / </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">) / </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-function"> * 100) } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(short.test, fcast.arima)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(short.test, fcast.nn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(short.test, fcast.tbats)</span></span></span></span></code> </pre><br></div></div><br><table><tbody><tr><td>  ARIMA </td><td>  Nnet </td><td>  Tbats </td></tr><tr><td>  1.99% </td><td>  18.26% </td><td>  4.00% </td></tr></tbody></table><br><br><h2>  Instead of conclusion </h2><br>  I will not comment on long-term forecasts: it is obvious that they are already incorrect and incorrect in this situation.  But ARIMA showed very good results for the short term.  Also pay attention to the following facts.  Oil prices dropped: <br><br><ol><li>  in September by 5%; </li><li>  in October - by 10%; </li><li>  in November - by 15%; </li><li>  for December ...? </li></ol><br>  It kind of hints at us that the process of changing the price of oil is far from a process that is regulated by random parameters. </div><p>Source: <a href="https://habr.com/ru/post/243211/">https://habr.com/ru/post/243211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243201/index.html">The smartest marketers in the world. Learn from Amazon</a></li>
<li><a href="../243203/index.html">FreeBSD, dhcp, ip unnumbered and everything is all all ...</a></li>
<li><a href="../243205/index.html">Finger Trees (Part 2. Operations)</a></li>
<li><a href="../243207/index.html">Python implementation of the event-driven paradigm using coroutines</a></li>
<li><a href="../243209/index.html">Are you a pirate? Are you a pirate?</a></li>
<li><a href="../243213/index.html">Asterisk + Lua + regular update of DEF codes</a></li>
<li><a href="../243215/index.html">Internet Explorer: Moving to live Edge mode - the next step for the web to just work</a></li>
<li><a href="../243217/index.html">InterSystems iKnow. Part one. iKnow and beach holidays</a></li>
<li><a href="../243219/index.html">RFM analysis on the knee (Excel)</a></li>
<li><a href="../243221/index.html">Meeting of mobile game developers, November 27, Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>