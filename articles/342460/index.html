<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do not use lambdas as listeners in Kotlin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to your attention the translation of the article ‚Äú Don't use lambdas as listeners in Kotlin‚Äù by Alex Gherschon 

 From the transla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do not use lambdas as listeners in Kotlin</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I present to your attention the translation of the article ‚Äú <a href="http://galex.co.il/2017/11/07/Dont_Use_lambdas_as_listeners_in_Kotlin_Update.html">Don't use lambdas as listeners in Kotlin‚Äù</a> by Alex Gherschon <br><br>  <b>From the translator</b> : Kotlin is a very powerful language that allows you to write code more concisely and faster.  But, lately, there have been too many articles that describe the good sides of the language, thinking about the pitfalls, and they are, because the language introduces new designs that are a black box for a beginner.  This article, which is a translation, discusses the use of lambdas as listeners on Android.  It will help not to step on the same rake, which the author also stepped on, because, ultimately, the specificity of the platform does not go away when the language is changed. <br><a name="habracut"></a><br>  I stumbled upon this problem in my first application I write on Kotlin, and it drove me crazy! <br><br><h2>  Introduction </h2><br>  I use <a href="https://developer.android.com/guide/topics/media-apps/audio-focus.html">AudioFocus</a> in a podcast listening application.  When a user wants to listen to an episode, you need to <b>request audio focus</b> by passing the <a href="https://developer.android.com/reference/android/media/AudioManager.OnAudioFocusChangeListener.html">OnAudioFocusChangeListener</a> implementation (because we can lose audio focus when playing if the user uses another application that also requires audio focus): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestAudioFocus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"requestAudioFocus() called"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> focusRequest: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> = audioManager.requestAudioFocus(onAudioFocusChange, AudioManager.STREAM_MUSIC, AudioManager.AUDIOFOCUS_GAIN) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> focusRequest == AudioManager.AUDIOFOCUS_REQUEST_GRANTED }</code> </pre> <br>  In this listener, we want to handle various states: <br><br><pre> <code class="hljs erlang-repl">when (focusChange) { AudioManager.AUDIOFOCUS_GAIN -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"resume playing"</span></span>) AudioManager.AUDIOFOCUS_LOSS -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"abandon focus and stop playing"</span></span>) AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"pause but keep focus"</span></span>) }</code> </pre><br>  When the episode is over or the user stops it, you need to <b>release the audio focus</b> : <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abandonAudioFocus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"abandonAudioFocus() called"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> focusRequest: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> = audioManager.abandonAudioFocus(onAudioFocusChange) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> focusRequest == AudioManager.AUDIOFOCUS_REQUEST_GRANTED }</code> </pre><br><h2>  Road to madness </h2><br>  With my passion for new things, I decided to implement the listener, <b>onAudioFocusChange</b> , using lambda.  I do not remember whether it was suggested by IntelliJ IDEA or not, but, in any case, it was declared as follows: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onAudioFocusChange: (focusChange: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span></code> </pre><br>  In <b>onCreate (),</b> this variable is assigned lambda: <br><br><pre> <code class="hljs erlang-repl">onAudioFocusChange = { focusChange: Int -&gt; Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"In onAudioFocusChange focus changed to = $focusChange"</span></span>) when (focusChange) { AudioManager.AUDIOFOCUS_GAIN -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"resume playing"</span></span>) AudioManager.AUDIOFOCUS_LOSS -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"abandon focus and stop playing"</span></span>) AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"pause but keep focus"</span></span>) } }</code> </pre><br>  And everything worked well, because  Now we can request audio focus, which will stop other applications (for example, Spotify) and play our episode. <br><br>  The release of the audio focus, too, seemed to work, because  I received <a href="https://developer.android.com/reference/android/media/AudioManager.html">AUDIOFOCUS_REQUEST_GRANTED</a> as a result when calling the <b>AudioManager</b> class <b>abandonAudioFocus</b> class: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">14.610</span></span> D/MainActivity: requestAudioFocus() <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">14.618</span></span> D/AudioManager: requestAudioFocus status : <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">14.619</span></span> D/MainActivity: granted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">34.519</span></span> D/MainActivity: abandonAudioFocus() <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">34.521</span></span> D/MainActivity: granted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre><br>  But as soon as we want to request the audio focus again, we immediately lose it and receive the <a href="https://developer.android.com/reference/android/media/AudioManager.html">AUDIOFOCUS_LOSS</a> event: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38.307</span></span> D/MainActivity: requestAudioFocus() <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38.312</span></span> D/AudioManager: requestAudioFocus status : <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38.312</span></span> D/MainActivity: granted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38.321</span></span> D/AudioManager: AudioManager dispatching onAudioFocusChange(<span class="hljs-number"><span class="hljs-number">-1</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MainActivityKt$sam$<span class="pgsql"><span class="pgsql">OnAudioFocusChangeListener</span><span class="hljs-meta"><span class="pgsql"><span class="hljs-meta">$4186</span></span></span><span class="pgsql">f324</span><span class="hljs-meta"><span class="pgsql"><span class="hljs-meta">$828</span></span></span><span class="pgsql">aa1f </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">11</span></span></span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">-04</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">16</span></span></span><span class="pgsql">:</span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">17</span></span></span><span class="pgsql">:</span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">38.322</span></span></span><span class="pgsql"> D/MainActivity: </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">In</span></span></span><span class="pgsql"> onAudioFocusChange focus changed </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">to</span></span></span><span class="pgsql"> = </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">-1</span></span></span></span></code> </pre><br>  Why do we lose it as soon as requested?  What is going on? <br><br><h2>  Behind the scenes </h2><br>  The best tool to understand the problem is the <b>Kotlin Bytecode bytecode viewer</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/222/6bf/66c/2226bf66cbd2f1ed686a6459fe51ca9f.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e3f/d44/6ab/e3fd446abf39afac9c2a2d9ba6b2de25.png" alt="image"><br><br>  Let's see what is assigned to our <b>onAudioFocusChange</b> variable: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onAudioFocusChange = (Function1)<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>.INSTANCE;</code> </pre><br>  You can see that lambdas are converted to classes of the form FunctionN, where N is the number of parameters.  The concrete implementation is hidden here, and we need another tool to view it, but that‚Äôs another story. <br><br>  Let's see the <b>OnAudioFocusChangeListener</b> implementation: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivityKt</span></span></span><span class="hljs-class">$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sam</span></span></span><span class="hljs-class">$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnAudioFocusChangeListener</span></span></span><span class="hljs-class">$4186</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f324</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnAudioFocusChangeListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// $FF: synthetic field private final Function1 function; MainActivityKt$sam$OnAudioFocusChangeListener$4186f324(Function1 var1) { this.function = var1; } // $FF: synthetic method public final void onAudioFocusChange(int focusChange) { Intrinsics.checkExpressionValueIsNotNull(this.function.invoke(Integer.valueOf(focusChange)), "invoke(...)"); } }</span></span></code> </pre><br>  And now let's check how it is used.  <b>RequestAudioFocus</b> method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestAudioFocus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Log.d(Companion.getTAG(), <span class="hljs-string"><span class="hljs-string">"requestAudioFocus() called"</span></span>); (...) Object var10001 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onAudioFocusChange; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onAudioFocusChange == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Intrinsics.throwUninitializedPropertyAccessException(<span class="hljs-string"><span class="hljs-string">"onAudioFocusChange"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(var10001 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Object var2 = var10001; var10001 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainActivityKt$sam$OnAudioFocusChangeListener$<span class="hljs-number"><span class="hljs-number">4186f</span></span>324((Function1)var2); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> focusRequest = var10000.requestAudioFocus((OnAudioFocusChangeListener)var10001, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); Log.d(Companion.getTAG(), <span class="hljs-string"><span class="hljs-string">"granted = "</span></span> + (focusRequest == <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> focusRequest == <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  The <b>abandonAudioFocus</b> method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abandonAudioFocus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Log.d(Companion.getTAG(), <span class="hljs-string"><span class="hljs-string">"abandonAudioFocus() called"</span></span>); (...) Object var10001 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onAudioFocusChange; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onAudioFocusChange == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Intrinsics.throwUninitializedPropertyAccessException(<span class="hljs-string"><span class="hljs-string">"onAudioFocusChange"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(var10001 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Object var2 = var10001; var10001 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainActivityKt$sam$OnAudioFocusChangeListener$<span class="hljs-number"><span class="hljs-number">4186f</span></span>324((Function1)var2); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> focusRequest = var10000.abandonAudioFocus((OnAudioFocusChangeListener)var10001); Log.d(Companion.getTAG(), <span class="hljs-string"><span class="hljs-string">"granted = "</span></span> + (focusRequest == <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> focusRequest == <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  You may have noticed the problem line in both places: <br><br><pre> <code class="java hljs">var10001 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainActivityKt$sam$OnAudioFocusChangeListener$<span class="hljs-number"><span class="hljs-number">4186f</span></span>324((Function1)var2);</code> </pre><br>  In fact, the following happens: our lambda / Function1 is initialized in onCreate (), but each time we pass it as a <a href="https://stackoverflow.com/questions/17913409/what-is-a-sam-type-in-java">SAM</a> to a function, it is wrapped in a new instance of the class that implements the listener interface, which means that two instances will be created The listener and <b>AudioManager API</b> cannot delete when calling <b>abandonAudioFocus () the</b> listener that was created earlier and used when calling <b>requestAudioFocus ()</b> .  Since the original listener is never deleted, we receive the event <a href="https://developer.android.com/reference/android/media/AudioManager.html">AUDIO_FOCUS_LOSS</a> in it. <br><br><h2>  The right approach </h2><br>  Students must remain anonymous internal classes, so here‚Äôs the correct way to define it: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onAudioFocusChange: AudioManager.OnAudioFocusChangeListener onAudioFocusChange = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : AudioManager.OnAudioFocusChangeListener { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAudioFocusChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(focusChange: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"In onAudioFocusChange (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${this.toString().substringAfterLast("@")}</span></span></span><span class="hljs-string">), focus changed to = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$focusChange</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (focusChange) { AudioManager.AUDIOFOCUS_GAIN -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"resume playing"</span></span>) AudioManager.AUDIOFOCUS_LOSS -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"abandon focus and stop playing"</span></span>) AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -&gt; TODO(<span class="hljs-string"><span class="hljs-string">"pause but keep focus"</span></span>) } } }</code> </pre><br>  Now the <b>onAudioFocusChange</b> variable refers to the same listener instance, which is correctly passed to the <b>AudioManager</b> class <b>requestAudioFocus</b> and <b>abandonAudioFocus</b> <b>methods</b> .  Fine! <br><br><h2>  Code example </h2><br>  You can look at the generated bytecode and see the problem personally <a href="https://github.com/galex/lambdas-listeners">in this repository on GitHub</a> . <br><br><h2>  Conclusion (but not quite) </h2><br>  With great power comes great responsibility.  Do not use lambdas instead of anonymous inner classes for listeners.  I got an important lesson and I hope that he, too, has benefited you. <br><br><h2>  P.S </h2><br>  As one of the readers pointed out in the comments (thanks, Pavlo!) We can declare a lambda as follows and everything will work correctly: <br><br><pre> <code class="hljs pgsql">onAudioFocusChange = AudioManager.OnAudioFocusChangeListener { focusChange: <span class="hljs-type"><span class="hljs-type">Int</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.d(TAG, "In onAudioFocusChange focus changed to = $focusChange") // <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> stuff }</code> </pre><br><h2>  <a href="http://galex.co.il/2017/11/07/Dont_Use_lambdas_as_listeners_in_Kotlin_Update.html">PostScript Explanation</a> </h2><br><h2>  Is <b>lateinit</b> to <b>blame</b> ? </h2><br>  Some readers claimed that the problem was in declaring a listener with the <b>lateinit</b> modifier.  To check whether it is <b>lateinit</b> or not, let's try to implement a lambda with this modifier and without it and look at the result. <br><br>  To remind what we are talking about, here is the code of these two lambdas: <br><br><pre> <code class="hljs sql">// <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lateinit <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> lateinit <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onAudioFocusChangeListener1: (focusChange: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>) -&gt; Unit // <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> lateinit <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val onAudioFocusChangeListener2: (focusChange: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>) -&gt; Unit = { focusChange: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> -&gt; Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"In onAudioFocusChangeListener2 focus changed to = $focusChange"</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stuff</span></span> } // <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> onCreate() onAudioFocusChangeListener1 = { focusChange: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> -&gt; Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"In onAudioFocusChangeListener1 focus changed to = $focusChange"</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stuff</span></span> }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">With lateinit (onAudioFocusChangeListener1)</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Declaration private Function1&lt;? super Integer, Unit&gt; onAudioFocusChangeListener1; // in onCreate() this.onAudioFocusChangeListener1 = MainActivity$onCreate$1.INSTANCE; // Class implementation final class MainActivity$onCreate$1 extends Lambda implements Function1&lt;Integer, Unit&gt; { public static final MainActivity$onCreate$1 INSTANCE = new MainActivity$onCreate$1(); MainActivity$onCreate$1() { super(1); } public final void invoke(int focusChange) { Log.d(MainActivity.Companion.getTAG(), "In onAudioFocusChangeListener1 focus changed to = " + focusChange); } } // In onCreate(), a button uses a SAM converted lambda to call the AudioManager API Function1 listener = this.onAudioFocusChangeListener1; ((Button) findViewById(C0220R.id.obtain)).setOnClickListener(new MainActivity$onCreate$2(this, listener)); // Inside MainActivity$onCreate$2 the call to the AudioManager API if (function1 != null) { mainActivityKt$sam$OnAudioFocusChangeListener$4186f324 = new MainActivityKt$sam$OnAudioFocusChangeListener$4186f324(function1); } else { Object obj = function1; } Log.d(MainActivity.Companion.getTAG(), "granted = " + (access$getAudioManager$p.requestAudioFocus((OnAudioFocusChangeListener) mainActivityKt$sam$OnAudioFocusChangeListener$4186f324, 3, 1) == 1));</span></span></code> </pre><br></div></div><br>  Our lambda is wrapped inside a class that implements the interface (SAM Transform), but we don‚Äôt own a reference to the converted class, which is the problem. <br><br><div class="spoiler">  <b class="spoiler_title">Without lateinit (onAudioFocusChangeListener2)</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Declaration of the lambda private final Function1&lt;Integer, Unit&gt; onAudioFocusChangeListener2 = MainActivity$onAudioFocusChangeListener2$1.INSTANCE; // Class implementation final class MainActivity$onAudioFocusChangeListener2$1 extends Lambda implements Function1&lt;Integer, Unit&gt; { public static final MainActivity$onAudioFocusChangeListener2$1 INSTANCE = new MainActivity$onAudioFocusChangeListener2$1(); MainActivity$onAudioFocusChangeListener2$1() { super(1); } public final void invoke(int focusChange) { Log.d(MainActivity.Companion.getTAG(), "In onAudioFocusChangeListener1 focus changed to = " + focusChange); } } // In onCreate(), a button uses a SAM converted lambda to call the AudioManager API Function1 listener = this.onAudioFocusChangeListener2; ((Button) findViewById(C0220R.id.obtain)).setOnClickListener(new MainActivity$onCreate$2(this, listener)); // Inside MainActivity$onCreate$2 the call to the AudioManager API if (function1 != null) { mainActivityKt$sam$OnAudioFocusChangeListener$4186f324 = new MainActivityKt$sam$OnAudioFocusChangeListener$4186f324(function1); } else { Object obj = function1; } Log.d(MainActivity.Companion.getTAG(), "granted = " + (access$getAudioManager$p.requestAudioFocus((OnAudioFocusChangeListener) mainActivityKt$sam$OnAudioFocusChangeListener$4186f324, 3, 1) == 1));</span></span></code> </pre><br></div></div><br>  It can be seen that the same problem without <b>lateinit</b> , so we can not blame this modifier. <br><br><h2>  Recommended way </h2><br>  To fix the problem, I recommend using an anonymous inner class: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> onAudioFocusChangeListener3: AudioManager.OnAudioFocusChangeListener = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : AudioManager.OnAudioFocusChangeListener { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAudioFocusChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(focusChange: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"In onAudioFocusChangeListener2 focus changed to = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$focusChange</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// do some stuff } }</span></span></code> </pre><br>  Which translates to the following in Java: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// declaration private final OnAudioFocusChangeListener onAudioFocusChangeListener3 = new MainActivity$onAudioFocusChangeListener3$1(); // class definition public final class MainActivity$onAudioFocusChangeListener3$1 implements OnAudioFocusChangeListener { MainActivity$onAudioFocusChangeListener3$1() { } public void onAudioFocusChange(int focusChange) { Log.d(MainActivity.Companion.getTAG(), "In onAudioFocusChangeListener2 focus changed to = " + focusChange); } } // In onCreate(), a button uses a SAM converted lambda to call the AudioManager API OnAudioFocusChangeListener listener = this.onAudioFocusChangeListener3; ((Button) findViewById(C0220R.id.obtain)).setOnClickListener(new MainActivity$onCreate$2(this, listener)); // Inside MainActivity$onCreate$2 the call to the AudioManager API Log.d(MainActivity.Companion.getTAG(), "Calling AudioManager.requestAudioFocus()"); int focusRequest = MainActivity.access$getAudioManager$p(this.this$0).requestAudioFocus(this.$listener, 3, 1);</span></span></code> </pre><br>  The anonymous class implements the necessary interface and we have a single instance (the compiler does not need to do <a href="https://kotlinlang.org/docs/reference/java-interop.html">the SAM transformation</a> , since there are no lambdas here).  Fine! <br><br><h2>  The best way </h2><br>  The most concise way is to still declare a lambda and use what the documentation calls <a href="https://kotlinlang.org/docs/reference/java-interop.html">the conversion method</a> : <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> onAudioFocusChangeListener4 = AudioManager.OnAudioFocusChangeListener { focusChange: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> -&gt; Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"In onAudioFocusChangeListener3 focus changed to = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$focusChange</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// do some stuff }</span></span></code> </pre><br>  This indicates to the compiler that this is the type to use when <a href="https://kotlinlang.org/docs/reference/java-interop.html">converting SAM</a> .  Java Result Code: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// declaration private final OnAudioFocusChangeListener onAudioFocusChangeListener4 = MainActivity$onAudioFocusChangeListener4$1.INSTANCE; // Class definition final class MainActivity$onAudioFocusChangeListener4$1 implements OnAudioFocusChangeListener { public static final MainActivity$onAudioFocusChangeListener4$1 INSTANCE = new MainActivity$onAudioFocusChangeListener4$1(); MainActivity$onAudioFocusChangeListener4$1() { } public final void onAudioFocusChange(int focusChange) { Log.d(MainActivity.Companion.getTAG(), "In onAudioFocusChangeListener3 focus changed to = " + focusChange); } } // In onCreate(), a button uses a SAM converted lambda to call the AudioManager API OnAudioFocusChangeListener listener = this.onAudioFocusChangeListener4; ((Button) findViewById(C0220R.id.obtain)).setOnClickListener(new MainActivity$onCreate$2(this, listener)); // Inside MainActivity$onCreate$2 the call to the AudioManager API Log.d(MainActivity.Companion.getTAG(), "Calling AudioManager.requestAudioFocus()"); int focusRequest = MainActivity.access$getAudioManager$p(this.this$0).requestAudioFocus(this.$listener, 3, 1);</span></span></code> </pre><br><h2>  Conclusion (now completely) </h2><br>  As <b>Roman Dawydkin</b> remarkably noted in <a href="http://slack.kotlinlang.org/">Slack</a> : <br><br><blockquote>  You can use a lambda as a listener only if you use it once. </blockquote><br>  Not a problem if lambda is used in a functional style or as a callback function.  A problem manifests itself only when it is used as a listener in an <b>API written in Java,</b> which expects the same instance in the Observer pattern.  If the API is written in Kotlin, then there is no <a href="https://kotlinlang.org/docs/reference/java-interop.html">SAM conversion</a> , respectively, and there is no problem.  Someday all API will be like that! <br><br>  I hope that this topic is now very clear to everyone. <br><br>  I would like to thank Rhaquel Gherschon for reading and <a href="https://twitter.com/BladeCoder">Christophe Beyls</a> for the comments on this article! <br><br>  Hooray! <br><br>  <b>From the translator</b> : This is just one of the pitfalls.  Another example is <a href="https://android.jlelse.eu/kotlin-and-rx2-how-i-wasted-5-hours-because-of-wrong-brackets-581021717774">incorrect brackets in the RxJava + SAM + Kotlin combination.</a> </div><p>Source: <a href="https://habr.com/ru/post/342460/">https://habr.com/ru/post/342460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342446/index.html">CRM systems: what is it? Simple words</a></li>
<li><a href="../342448/index.html">What is a business process and business process description</a></li>
<li><a href="../342450/index.html">Shazam Vice President EMEA, LATAM and Canada Josh Partridge: ‚ÄúIT specialists lack understanding of business processes‚Äù</a></li>
<li><a href="../342456/index.html">My first compiler on LLVM</a></li>
<li><a href="../342458/index.html">Using Heap Overflow with JavaScript</a></li>
<li><a href="../342462/index.html">Not a single cryptocurrency: our blockchain factoring platform</a></li>
<li><a href="../342464/index.html">uSpeech - startup development (3). Increase website conversion with A / B testing</a></li>
<li><a href="../342466/index.html">Where the technical line with a car is rolling: hakatons in Avito</a></li>
<li><a href="../342468/index.html">Connect (); 2017: live broadcast</a></li>
<li><a href="../342470/index.html">FPConf 2017. Interview with Denis Shevchenko</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>