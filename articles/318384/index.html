<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience in porting a project to Python 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the experience of porting a project from Python 2.7 to Python 3.5. Unusual ambushes and other interesting nuances. 

 A little bit abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience in porting a project to Python 3</h1><div class="post__text post__text-html js-mediator-article">  I want to share the experience of porting a project from Python 2.7 to Python 3.5.  Unusual ambushes and other interesting nuances. <br><img align="left" src="https://habrastorage.org/files/624/607/77b/62460777b54c48ce9c7562e11bd32612.png"><br>  A little bit about the project: <br><br><ul><li>  Browser: site + game logic (hierarchical finite automata + a bunch of rules); </li><li>  Age: 4 years (started in 2012); </li><li>  64k loc logic + 57k loc tests; </li><li>  2400 commits. </li></ul><br><a name="habracut"></a><br>  The porting was performed using the <a href="https://docs.python.org/2/library/2to3.html">2to3</a> utility with the subsequent recovery of the tests.  How long it took to say difficult, the project - a hobby - I do it in my spare time. <br><br><div class="spoiler">  <b class="spoiler_title">2to3</b> <div class="spoiler_text">  2to3 converts Python 2 sources to Python 3.  To do this, it applies a set of heuristics to them (their list can be customized).  In general, there are no problems with the utility, but if you have a large and / or complex project, it is better to familiarize yourself with the list of heuristics before launching. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>After processing the source, I highly recommend that you subtract the changes, since performance is not something that is put at the forefront when converting.</b> <br><br>  It is also possible that some of your names will overlap with methods being deleted / modified.  For example, 2to3 changed the code that worked with my has_key method of my own class (this is the method of the Python 2 dictionary and removed in Python 3). <br></div></div><br><h2>  Price of progress </h2><br>  So, about what you can stumble, if you start to move progress in the direction of Python 3. I will start with the most interesting. <br><br><h3>  Banking Rounding </h3><br><blockquote>  ‚ÄúCHEEEEEOOOOOO!!?‚Äù O_O </blockquote><br>  Something like this was my reaction when, as I was dealing with the next test, I saw the following in the console: <br><br><pre><code class="python hljs">round(<span class="hljs-number"><span class="hljs-number">1.5</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span> round(<span class="hljs-number"><span class="hljs-number">2.5</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  <i>"Banking" rounding - rounding to the nearest even.</i>  These are new rounding rules, replacing the ‚Äúschool‚Äù rounding up. <br><br>  The meaning of ‚Äúbanking‚Äù rounding is that when working with large amounts of data and complex calculations, it reduces the likelihood of error accumulation.  In contrast to the usual "school" rounding, which always results in half values ‚Äã‚Äãto a larger number. <br><br>  For most, this change is not critical, but it can lead to a completely unexpected change in the behavior of the program.  In my case, for example, the location of the roads on the game map has changed. <br><br><div class="spoiler">  <b class="spoiler_title">Please note it works for any accuracy.</b> <div class="spoiler_text"><pre> <code class="python hljs">round(<span class="hljs-number"><span class="hljs-number">1.65</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1.6</span></span> round(<span class="hljs-number"><span class="hljs-number">1.55</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1.6</span></span></code> </pre></div></div><br><h3>  Integer division became fractional </h3><br>  If you relied on integer arithmetic with the int type (when <code>1/4 == 0</code> ), then get ready for a lengthy reading of the code, because now <code>1/4 == 0.25</code> and perform an automatic replacement <code>/</code> on (integer division operator) from -for the lack of information about the types of variables. <br><br>  Guido van Rossum <a href="http://python-history.blogspot.com.by/2009/03/problem-with-integer-division.html">explained</a> in detail the <a href="http://python-history.blogspot.com.by/2009/03/problem-with-integer-division.html">reason for this change</a> . <br><br><h3>  New semantics map </h3><br>  The behavior of the map function changed during iteration over several sequences. <br><br><ul><li>  In Python 2, if one sequence is shorter than the others, it is complemented by <code>None</code> objects. </li><li>  In Python 3, if one sequence is shorter than the others, the iteration stops. </li></ul><br>  Python 2: <br><br><pre> <code class="python hljs">map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x, y: (x, y), [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-number"><span class="hljs-number">1</span></span>]) [(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)]</code> </pre><br>  Python 3: <br><br><pre> <code class="python hljs">list(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x, y: (x, y), [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-number"><span class="hljs-number">1</span></span>])) [(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)]</code> </pre><br><h3>  In class bodies in generators and list expressions, class attributes cannot be used. </h3><br>  The code below will work in Python 2, but will throw a <code><nobr>NameError: name 'x' is not defined</nobr></code> exception <code><nobr>NameError: name 'x' is not defined</nobr></code> in Python 3: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> x = <span class="hljs-number"><span class="hljs-number">5</span></span> y = [x <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>)]</code> </pre><br>  This is due to changes in the scope of generators, list expressions and classes.  <a href="http://stackoverflow.com/questions/13905741/accessing-class-variables-from-a-list-comprehension-in-the-class-definition">Detailed analysis on Stackoverflow</a> . <br><br>  But the following code will work: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_y</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [x <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> x = <span class="hljs-number"><span class="hljs-number">5</span></span> y = make_y(x)</code> </pre><br><h3>  New and removed methods from standard classes </h3><br>  If you relied on the presence or absence of methods with specific names, then unexpected problems may arise.  For example, in one place where the Black Wolf was going on, I distinguished lines from lists by the presence of the <code>__iter__</code> method.  In Python 2, it does not have lines, in Python 3 it appeared and the code broke. <br><br><h3>  Semantics of operations has become stricter </h3><br>  Some operations, which by default worked in Python 2, stopped working in <nobr>Python 3</nobr> .  In particular, the comparison of objects without explicitly specified comparison methods is prohibited. <br><br>  Expression <code>object() &lt; object()</code> : <br><br><ul><li>  In Python 2, returns <code>True</code> or <code>False</code> (depending on the identity of the objects). </li><li>  In Python 3, it will throw a <code>TypeError: unorderable types: object() &lt; object()</code> . </li></ul><br><h3>  Standard Classes Implementation Changes </h3><br>  I think there are many different ones, but I am faced with a change in the behavior of the dictionary.  The following code will have different effects in Python 2 and Python 3: <br><br><pre> <code class="python hljs">D = {<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>} print(list(D.values()))</code> </pre><br>  In Python 2, it always prints <code>[1, 3, 2]</code> (or at least the same sequence for a specific Python assembly on a particular machine). <br><br>  In Python 3, the sequence of elements differs with each launch.  Accordingly, the results of executing code relying on this ‚Äúfeature‚Äù will differ. <br><br>  Of course, I did not specifically rely on a fixed sequence of elements in the dictionary, but as it turned out, I did it implicitly. <br><br><h3>  Memory and CPU Usage </h3><br>  Unfortunately, due to the combination of porting, moving to a new server and refactoring, it was not possible to make specific measurements. <br><br><h2>  findings </h2><br>  My main conclusion is that Python has become more idiomatic: <br><br><ul><li>  indefinite behavior has become truly indefinite; </li><li>  The recommended programming style is more recommended; </li><li>  bad practices become harder to follow; </li><li>  good practices become easier to follow. </li></ul><br>  In the code, it became easier to detect semantic errors that could have been hidden for years in the past. <br><br>  The second conclusion: if you are tied up with mathematical operations, it is better to start implementing them immediately in the correct 3 key for Python, even if you are going to drag out with the move until the 20th year. <br><br>  Write the code in Python 2 using <a href="https://docs.python.org/2/library/__future__.html">__future__</a> and there will be no problems with the move. </div><p>Source: <a href="https://habr.com/ru/post/318384/">https://habr.com/ru/post/318384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318370/index.html">Office 2 - Search Approach</a></li>
<li><a href="../318372/index.html">VulnHub: Parsing the DC416 by Dick Dastardly</a></li>
<li><a href="../318374/index.html">Competitiveness: Parallelism</a></li>
<li><a href="../318376/index.html">Console to the masses. Go to the bright side. Part two</a></li>
<li><a href="../318380/index.html">Family business in IT. How we sold our startup</a></li>
<li><a href="../318386/index.html">Creating an editor quest and dialogs for the Unreal engine: Part 2 technical aspects</a></li>
<li><a href="../318388/index.html">Backup network spheres (samba) in Linux based on Windows Server Backup</a></li>
<li><a href="../318390/index.html">How to talk with assholes. 7 strategies for communicating with inappropriate people</a></li>
<li><a href="../318392/index.html">The digest of interesting materials for the mobile # 185 developer (December 19-25)</a></li>
<li><a href="../318394/index.html">Camouflage and video game feedback</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>