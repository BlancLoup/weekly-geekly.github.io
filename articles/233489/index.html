<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking GIMP source code with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To test GIMP, first you need to learn how to compile it. This is not an easy task, because of which verification has been postponed several times. How...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking GIMP source code with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/154/ac2/0a2/154ac20a216b5651b77a964d42d24544.png" alt="PVS-Studio and GIMP" align="left"><br>  To test GIMP, first you need to learn how to compile it.  This is not an easy task, because of which verification has been postponed several times.  However, the project is well-known, and it is interesting to evaluate the quality of the source code.  Therefore, laziness was defeated, and the project was analyzed. <br><a name="habracut"></a><br><h2>  Gimp </h2><br>  I do not like the <a href="http://www.gimp.org/">GIMP</a> interface, although sometimes I use this graphic editor.  It makes no sense to buy Photoshop only to adapt a picture with a unicorn several times a month for another article.  Paint and GIMP programs are more than enough for me. <br><br>  It can be said that I am not a professional user enough to judge convenience.  However, to argue that it is inconvenient to sit on a chair because of protruding nails, it is not at all necessary to be a carpenter or furniture expert.  I can list a number of deficiencies in the GIMP that bother me.  For example, when opening a file, you cannot insert the full path to the file in the Location field if the path contains letters in Russian.  There are many such shortcomings. <br><br>  Being familiar with the clumsy GIMP interface, I expected that in the code I would find a lot of blunders.  I was wrong.  It turns out that developers are already using static analysis in their work.  Moreover, use heavy artillery.  One of the most powerful static analyzers is used - Coverity. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The fact that the use of Coverity, I judge by the mention on the Internet: <br><br>  <i>The Coverity project, organized with the support of the US government and engaged in finding errors in open source programs, reports that the list of checked projects will include about 100 applications for working with graphics, including popular Scribus, GIMP, Inkscape, Krita, Blender and many others (from the publication in 2007).</i> <br><br><h2>  Test results </h2><br>  Let's see what can be found in the GIMP code after Coverity.  The analysis was performed using <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> version 5.18. <br><br>  <b>Fragment N1-N3</b> <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> gdouble; <span class="hljs-function"><span class="hljs-function">GimpBlob * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_blob_square</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gdouble xc, gdouble yc, gdouble xp, gdouble yp, gdouble xq, gdouble yq)</span></span></span><span class="hljs-function"> </span></span>{ GimpBlobPoint points[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* Make sure we order points ccw */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xp * yq - yq * xp &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { xq = -xq; yq = -yq; } .... }</code> </pre> <br>  PVS-Studio warning: V501 '-' operator: xp * yq - yq * xp gimpink-blob.c 162 <br><br>  The expression "xp * yq - yq * xp" is very strange.  The value "xp * yq" is deducted from itself. <br><br>  Identical checks can be found just below in this file.  Lines: 195 and 278. <br><br>  <b>Fragment N4</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gint64 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_g_value_get_memsize</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GValue *value)</span></span></span><span class="hljs-function"> </span></span>{ .... GimpArray *<span class="hljs-built_in"><span class="hljs-built_in">array</span></span> = g_value_get_boxed (value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>) memsize += (<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> (GimpArray) + <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>-&gt;static_data ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>-&gt;length); .... }</code> </pre> <br>  PVS-Studio warning: V502 Perhaps the '?:' Operator works in a different way.  The '?:' Operator has a lower limit than the '+' operator.  gimp-utils.c 233 <br><br>  Confusion in the priorities of operators.  To the size of a certain object you need to add 0 or ‚Äúarray-&gt; length‚Äù.  But the priority of the operator '+' is higher than the operator '?:'.  The expression works as follows: <br><pre> <code class="cpp hljs">memsize += ((<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> (GimpArray) + <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>-&gt;static_data) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>-&gt;length);</code> </pre> <br>  Perhaps the programmer was aware of this, so he used brackets.  But then, the brackets are not in place.  The correct option is: <br><pre> <code class="cpp hljs">memsize += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> (GimpArray) + (<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>-&gt;static_data ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>-&gt;length);</code> </pre> <br>  <b>Fragment N5, N6</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> cmsFLAGS_NOOPTIMIZE 0x0100 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> cmsFLAGS_BLACKPOINTCOMPENSATION 0x2000 static void lcms_layers_transform_rgb (...., gboolean bpc) { .... transform = cmsCreateTransform ( src_profile, lcms_format, dest_profile, lcms_format, intent, cmsFLAGS_NOOPTIMIZE | bpc ? cmsFLAGS_BLACKPOINTCOMPENSATION : 0); .... }</span></span></code> </pre> <br>  PVS-Studio warning: V502 Perhaps the '?:' Operator works in a different way.  The '?:' Operator has a lower than the '|'  operator.  lcms.c 1016 <br><br>  Depending on the variable 'bpc', the function must be passed the flag "cmsFLAGS_BLACKPOINTCOMPENSATION" or the combination of the flags "cmsFLAGS_BLACKPOINTCOMPENSATION |  cmsFLAGS_NOOPTIMIZE. <br><br>  The priority of the operator '|'  higher than the priority of the ternary operator '?:'.  As a result, the condition for the '?:' Operator is the expression ‚ÄúcmsFLAGS_NOOPTIMIZE |  bpc.  This condition is always true.  The cmsFLAGS_BLACKPOINTCOMPENSATION flag is always passed to the function. <br><br>  The correct option is: <br><pre> <code class="cpp hljs">transform = cmsCreateTransform ( src_profile, lcms_format, dest_profile, lcms_format, intent, cmsFLAGS_NOOPTIMIZE | (bpc ? cmsFLAGS_BLACKPOINTCOMPENSATION : <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  A similar error can be found here: lcms.c 1016. <br><br>  <b>Fragment N7</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> gint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_resource_lrfx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span> (effectname, <span class="hljs-string"><span class="hljs-string">"oglw"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt;&lt;=== .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span> (effectname, <span class="hljs-string"><span class="hljs-string">"iglw"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span> (effectname, <span class="hljs-string"><span class="hljs-string">"oglw"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt;&lt;=== .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span> (effectname, <span class="hljs-string"><span class="hljs-string">"bevl"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) .... }</code> </pre> <br>  PVS-Studio warning: V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 602, 688. psd-layer-res-load.c 602 <br><br>  Two identical conditions in an if-elseif-elseif- ... sequence <br><br>  <b>Fragment N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_text_get_transformation</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GimpText *text, GimpMatrix3 *matrix)</span></span></span><span class="hljs-function"> </span></span>{ g_return_if_fail (GIMP_IS_TEXT (text)); g_return_if_fail (matrix != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] = text-&gt;transformation.coeff[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] = text-&gt;transformation.coeff[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>]; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>] = text-&gt;offset_x; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] = text-&gt;transformation.coeff[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] = text-&gt;transformation.coeff[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>]; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>] = text-&gt;offset_y; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; &lt;&lt;&lt;=== }</code> </pre> <br>  PVS-Studio warning: V519 The 'matrix-&gt; coeff [2] [1]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 567, 568. gimptext.c 568 <br><br>  <a href="http://www.viva64.com/ru/b/0260/">The effect of the last line</a> .  At the very end, the wrong index is used.  It should be: <br><pre> <code class="cpp hljs">matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; matrix-&gt;coeff[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0</span></span>;</code> </pre> <br>  <b>Fragment N9</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warp_one</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first_time) gimp_pixel_rgn_init (&amp;dest_rgn, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>, x1, y1, (x2 - x1), (y2 - y1), TRUE, TRUE); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gimp_pixel_rgn_init (&amp;dest_rgn, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>, x1, y1, (x2 - x1), (y2 - y1), TRUE, TRUE); .... }</code> </pre> <br>  PVS-Studio warning: V523 The 'then' statement is equivalent to the 'else' statement.  warp.c 1366 <br><br>  Suspiciously, regardless of the condition, the same action is performed. <br><br>  <b>Fragment N10, N11, N12</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_wire_read</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GIOChannel *channel, guint8 *buf, gsize count, gpointer user_data)</span></span></span><span class="hljs-function"> </span></span>{ g_return_val_if_fail (count &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, FALSE); .... }</code> </pre> <br>  PVS-Studio warning: V547 Expression 'count&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. gimpwire.c 99 <br><br>  The ‚Äúcount&gt; = 0‚Äù check does not make sense, since the 'count' variable is unsigned.  Perhaps this is not a serious mistake, but it is worth mentioning it. <br><br>  Similar checks: gimpwire.c 170;  gimpcageconfig.c 428. <br><br>  More interesting cases found using the V547 diagnostic will be discussed below. <br><br>  <b>Fragment N13</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> GimpPlugInImageType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">image_types_parse</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gchar *name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gchar *image_types)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*image_types &amp;&amp; ((*image_types != <span class="hljs-string"><span class="hljs-string">' '</span></span>) || (*image_types != <span class="hljs-string"><span class="hljs-string">'\t'</span></span>) || (*image_types != <span class="hljs-string"><span class="hljs-string">','</span></span>))) { image_types++; } .... }</code> </pre> <br>  Warning: V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  gimppluginprocedure.c 808 <br><br>  For clarity, I will explain on an artificial example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A = ...; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( A != <span class="hljs-number"><span class="hljs-number">1</span></span> || A != <span class="hljs-number"><span class="hljs-number">2</span></span> || A != <span class="hljs-number"><span class="hljs-number">3</span></span>)</code> </pre> <br>  Whatever the variable A is, the condition is always satisfied. <br><br>  <b>Fragment N14</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> gunichar </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">basic_inchar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(port *pt)</span></span></span><span class="hljs-function"> </span></span>{ .... gunichar c; .... c = g_utf8_get_char_validated(pt-&gt;rep.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.curr, len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* Valid UTF-8 character? */</span></span> { len = g_unichar_to_utf8(c, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); pt-&gt;rep.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.curr += len; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; } <span class="hljs-comment"><span class="hljs-comment">/* Look for next valid UTF-8 character in buffer */</span></span> pt-&gt;rep.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.curr = g_utf8_find_next_char( pt-&gt;rep.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.curr, pt-&gt;rep.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.past_the_end); .... }</code> </pre> <br>  PVS-Studio warning: V547 Expression 'c&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. Scheme.c 1654 <br><br>  All characters will be considered valid UTF-8 characters.  The variable 'c' is of unsigned type.  Therefore, the condition (c&gt; = 0) is always true. <br><br>  <b>Fragment N15</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ABS(a) (((a) &lt; 0) ? -(a) : (a)) static gint32 load_thumbnail (...., gint32 thumb_size, ....) { .... guint32 size; guint32 diff; .... diff = ABS(thumb_size - size); .... }</span></span></code> </pre> <br>  PVS-Studio warning: V547 Expression '(thumb_size - size) &lt;0' is always false.  Unsigned type value is never &lt;0. file-xmc.c 874 <br><br>  The program does not work as the programmer intended.  Suppose that the variable 'thumb_size' is equal to 10, and the variable 'size' is equal to 25. <br><br>  At first glance, it seems that the result of the calculation will be the value 15. In fact, the result will be 0xFFFFFFF1 (4294967281). <br><br>  The expression "thumb_size - size" has an unsigned type.  As a result, we get the number 0xFFFFFFF1u.  The ABS macro does nothing in this case. <br><br>  <b>Fragment N16</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> gchar * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">script_fu_menu_map</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gchar *menu_path)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> gchar *suffix = menu_path + <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span> (mapping[i].old); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! *suffix == <span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V562 It‚Äôs odd to compare 0 or 1 with a value of 47:! * Suffix == '/'.  script-fu-scripts.c 859 <br><br>  Again trouble with the priority of operations.  First, the expression "! * Suffix" is evaluated.  As a result, we get 0 or 1. This zero or one is compared with the '/' symbol, which makes no sense. <br><br>  The correct option is: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*suffix != <span class="hljs-string"><span class="hljs-string">'/'</span></span>)</code> </pre> <br>  <b>Fragment N17</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_file_chooser_response</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkFileChooser *chooser, gint response_id, GFigObj *obj)</span></span></span><span class="hljs-function"> </span></span>{ .... gfig_context-&gt;current_obj = obj; gfig_save_callbk (); gfig_context-&gt;current_obj = gfig_context-&gt;current_obj; .... }</code> </pre> <br>  PVS-Studio warning: V570 The 'gfig_context-&gt; current_obj' variable is assigned to itself.  gfig-dialog.c 1623 <br><br>  The variable is copied to itself. <br><br>  <b>Fragment N18</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">size </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g_strlcpy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gchar *dest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gchar *src, gsize dest_size)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">GList * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_brush_generated_load</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... gchar *<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* the empty string is not an allowed name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) g_strlcpy (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, _(<span class="hljs-string"><span class="hljs-string">"Untitled"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>)); .... }</code> </pre> <br>  Warning PVS_Studio: V579  It is possibly a mistake.  Inspect the third argument.  gimpbrushgenerated-load.c 119 <br><br>  The ‚Äúsizeof (string)‚Äù operator computes the size of the pointer, not the size of the buffer. <br><br>  <b>Fragment N19</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_image</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... gint c; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (has_alpha &amp;&amp; (data[rowoffset + k + <span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">128</span></span>)) c |= <span class="hljs-number"><span class="hljs-number">0</span></span> &lt;&lt; (thisbit ++); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> .... }</code> </pre> <br>  PVS-Studio warning: V684 A value of the variable 'c' is not modified.  Consider inspecting the expression.  It is possible that '1' should be present instead of '0'.  file-xbm.c 1136 <br><br>  The expression ‚Äúc | = 0 &lt;&lt; (thisbit ++);‚Äù does not change the value of the variable 'c'. <br><br>  According to my observation, such code can be found when they wanted to reset a certain bit, but they were mistaken.  In this case, the code should look like this: <br><pre> <code class="cpp hljs">c &amp;= ~(<span class="hljs-number"><span class="hljs-number">1u</span></span> &lt;&lt; (thisbit ++));</code> </pre> <br>  <b>Fragment N20</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_item_get_popup_size</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., gint *popup_width, gint *popup_height)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scaling_up) { *popup_width = gimp_item_get_width (item); *popup_width = gimp_item_get_height (item); } .... }</code> </pre> <br>  PVS-Studio warning: V537 Consider reviewing the correctness of 'popup_width' item's usage.  gimpitem-preview.c 126 <br><br>  A typo or consequence of Copy-Paste.  The correct option is: <br><pre> <code class="cpp hljs">*popup_width = gimp_item_get_width (item); *popup_height = gimp_item_get_height (item);</code> </pre> <br>  <b>Fragment N21</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">gboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gimp_draw_tool_on_vectors_curve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., GimpAnchor **ret_segment_start, GimpAnchor **ret_segment_end, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret_segment_start) *ret_segment_start = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret_segment_start) *ret_segment_end = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V581 The conditional expressions of the 'if' are agreed alongside each other are identical.  Check lines: 1212, 1213. gimpdrawtool.c 1213 <br><br>  A typo or consequence of Copy-Paste.  The correct option is: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret_segment_start) *ret_segment_start = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret_segment_end) *ret_segment_end = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre><br>  <b>Fragment N22-N40</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">ObjectList_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object_list_append_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectList_t *des, ObjectList_t *src)</span></span></span><span class="hljs-function"> </span></span>{ GList *p; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = src-&gt;<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>; p; p = p-&gt;next) object_list_append(des, object_clone((Object_t*) p-&gt;data)); object_list_set_changed(des, (src) ? TRUE : FALSE); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> des; }</code> </pre> <br>  PVS-Studio warning: V595 The 'src' pointer was used before it was verified against nullptr.  Check lines: 536, 538. imap_object.c 536 <br><br>  From the condition "(src)? TRUE: FALSE" it can be concluded that the pointer 'src' can be equal to nullptr. <br><br>  However, above this pointer is boldly dereferenced in the expression ‚Äúp = src-&gt; list‚Äù, which is an error. <br><br>  There are other places where V595 warning is issued.  These places should also be checked: <ul><li>  The 'l' pointer.  Check lines: 262, 265. gimpimage-item-list.c 262 </li><li>  The 'quantobj' pointer.  Check lines: 965, 971. gimpimage-convert-type.c 965 </li><li>  The 'slist' pointer.  Check lines: 683, 685. gimpfont.c 683 </li><li>  The 'dock_window-&gt; p-&gt; context' pointer.  Check lines: 487, 504. gimpdockwindow.c 487 </li><li>  The 'layer_renderer' pointer.  Check lines: 1245, 1275. gimplayertreeview.c 1245 </li><li>  The 'shell-&gt; display' pointer.  Check lines: 574, 588. gimpdisplayshell-dnd.c 574 </li><li>  The 'ops' pointer.  Check lines: 265, 267. gimpgegltool.c 265 </li><li>  The 'dialog' pointer.  Check lines: 234, 249. file-save-dialog.c 234 </li><li>  The 'shell' pointer.  Check lines: 738, 763. view-actions.c 738 </li><li>  The 'fname' pointer.  Check lines: 1426, 1437. scheme.c 1426 </li><li>  The 'sgip-&gt; table' pointer.  Check lines: 148, 161. sgi-lib.c 148 </li><li>  The 'sgip-&gt; length' pointer.  Check lines: 154, 167. sgi-lib.c 154 </li><li>  The 'pixels' pointer.  Check lines: 1482, 1508. psd-load.c 1482 </li><li>  The 'img_a-&gt; alpha_names' pointer.  Check lines: 1735, 1741. psd-load.c 1735 </li><li>  The 'brush' pointer.  Check lines: 432, 451. brush.c 432 </li><li>  The 'curve_list-&gt; data' pointer.  Check lines: 126, 129. curve.c 126 </li><li>  The 'outline_list-&gt; data' pointer.  Check lines: 183, 187. pxl-outline.c 183 </li><li>  The 'id_ptr' pointer.  Check lines: 896, 898. sample-colorize.c 896 </li></ul><br><h2>  Conclusion </h2><br>  It is difficult to judge the seriousness of the errors found.  I would be pleased if something was corrected thanks to the article. <br><br>  Although, as I said, I don‚Äôt like the GIMP interface, I‚Äôm very grateful to the developers for their work.  I made quite a few pictures for the articles in GIMP.  Thank. <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="http://www.viva64.com/en/b/0273/">Checking GIMP's Source Code with PVS-Studio</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/233489/">https://habr.com/ru/post/233489/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../233479/index.html">Understanding and working with data in WordPress. Part 1. Introduction</a></li>
<li><a href="../233481/index.html">Growth Hacking - 5 rules of success</a></li>
<li><a href="../233483/index.html">The best interesting and useful for the year</a></li>
<li><a href="../233485/index.html">Twitter is going to declare war on the "Troll"</a></li>
<li><a href="../233487/index.html">As I entered the mobile gaming market, I stood and left. Yandex Workshop</a></li>
<li><a href="../233491/index.html">Your screenshot service for a restful sleep</a></li>
<li><a href="../233493/index.html">How to charge a smartphone from a cat, a child and in the forest</a></li>
<li><a href="../233497/index.html">Disable full time synchronization between the virtual machine and the VMware ESXi hypervisor</a></li>
<li><a href="../233501/index.html">Understanding your own code</a></li>
<li><a href="../233503/index.html">Identification of Linux kernel loadable modules [part 1]: source code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>