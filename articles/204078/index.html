<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make sure that the flash drive works in USB 3.0?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the modern IT industry it often happens that the assurances of the device manufacturer regarding its functionality are not true. From skepticism ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make sure that the flash drive works in USB 3.0?</h1><div class="post__text post__text-html js-mediator-article">  In the modern IT industry it often happens that the assurances of the device manufacturer regarding its functionality are not true.  From skepticism about this, let's move on to solving a specific technical problem ... <br><a name="habracut"></a><br><br><h2>  Formulation of the problem </h2><br>  In our lab it turned out to be USB flash drive <b>Kingston DataTraveler 3.0</b> .  According to the manufacturer, the device supports USB 3.0.  Check if this is in fact, without disassembling the flash drive and without violating the warranty. <br><br><h3>  Hardware test </h3><br>  Looking closely at the connector, behind the four " <i>near</i> " contacts that support USB 2.0, we, as expected, found five " <i>long-range</i> " contacts that are used only in <b><i>USB 3.0 Super Speed</i></b> mode.  We measure the resistance of USB 3.0 signal lines relative to the earth, we get values ‚Äã‚Äãother than infinity.  Conclusion: USB 3.0 contacts are physically present and do not end in a dead end.  The measurement was performed with an ohmmeter at the limit used to test semiconductor diodes.  To access the ‚Äúfar‚Äù contacts of the USB 3.0 connector, you can construct an adapter or use a thin and long probe, such as a needle.  The result is a necessary but not sufficient condition for the device to operate in USB 3.0 Super Speed ‚Äã‚Äãmode.  It may happen that the signal circuits end with terminating resistors, but are not connected to the controller.  Therefore, we proceed to the next test - software. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Software test </h3><br>  The experiment is performed on a fairly new, still unexplored <b>Tyan S5533 motherboard</b> , built on <a href="http://wccftech.com/intel-denlow-server-platform-2013-detailed-added-compatibility-broadwell-server-chips/">the Denlow chipset</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/eb7/5fa/58f/eb75fa58fe7e462339142a74725a0202.png" alt="  Tyan S5533" title="Tyan S5533 motherboard" width="640"></a> <br><br>  <b>Figure 1</b> .  <i>Tyan S5533 motherboard in ITX format</i> <br><br>  To eliminate the influence of drivers running in the operating system session, our test will be ‚Äúextremely low-level‚Äù, we will run under DOS, and monitor the results by viewing the Memory Mapped I / O dump of the USB controller. <br><br>  The sequence of actions is as follows. <br><br>  1) Using the beta version of the <a href="">USB</a> Book Labs development utility <a href="">USB.EXE</a> , we determine the address of the block of configuration registers of the XHCI controller, in our example it is bus = 0, device = 14h, function = 0.  We also define the base address of the operating register block in the Memory Mapped I / O space, in our example it is equal to F7500000h. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/67a/b7b/39b/67ab7b39b8bbb049800ac7e0794222ec.png" alt="image"><br><br>  <b>Figure 2</b> .  <i>The results of the utility USB.EXE.</i>  <i>The address of the XHCI configuration register block: bus = 0, device = 14h, function = 0.</i>  <i>The base address of the XHCI operating registers is F7500000h.</i> <br><br>  2) As is known, for compatibility with software that does not support a USB 3.0 XHCI controller, on this platform, by default, USB 3.0 ports are serviced by a USB 2.0 EHCI controller.  Our task is to transfer them to the maintenance mode by the USB 3.0 XHCI controller.  We use the documentation of the <a href="http://composter.com.ua/documents/8-series-chipset-pch-datasheet.pdf">Intel 8 Series / C220 Series Chipset Family Platform Controller Hub Datasheet</a> and any utility that allows you to edit the contents of the system logic registers. <br><br>  We program the register USB 3.0 Port Routing Mask Register.  We write to the address bus = 0, device = 14h, function = 0, register = 0DCh bytes with a value of 0FFh. <br><br>  We program the register USB 3.0 Port Super Speed ‚Äã‚ÄãEnable Register.  We write to the address bus = 0, device = 14h, function = 0, register = 0D8h bytes with a value of 0FFh. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d97/8d8/348/d978d8348927a84cb91158f95bc2f487.png" alt="image"><br><br>  <b>Fig.3</b> .  <i>Register USB 3.0 Port Routing Mask Register</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a9/e68/10f/5a9e6810f12b6b8512db2dd93d474785.png" alt="image"><br><br>  <b>Fig.4</b> .  <i>Register USB 3.0 Port Super Speed ‚Äã‚ÄãEnable Register</i> <br><br>  3) Read and decode according to Fig.5 and Fig.6 the initial state of several bit fields from the lower 16-bits of the 32-bit register PORTSCNUSB3 before connecting the device to the port under study.  The register is located at offset 0570h from the base address of the block of operating registers of the controller, its address is F7500000h + 0570h = F7500570h <br><br>  The read value = 02A0h = 00 <b>00.00</b> 10.1010.00 <b>00</b> b <br>  D0 = Current Connect Status = 0.  The device is not connected. <br>  D1 = Port Enabled / Disabled = 0.  The port is not used. <br>  D [13-10] = Port Speed ‚Äã‚Äã= 0000b.  Speed ‚Äã‚Äãis not defined. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/baa/93b/603/baa93b6031cceefe2be66cc9ce1aa26c.png" alt="image"><br><br>  <b>Fig.5</b> .  <i>USB 3.0 Port Status and Control Register, bits [4-0]</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5dd/bbb/742/5ddbbb742895c185c8f02bc1deef999a.png" alt="image"><br><br>  <b>Fig.6</b> .  <i>USB 3.0 Port Status and Control Register, bits [13-10]</i> <br><br>  4) Connect a USB 3.0 flash drive, then reread the register and decrypt the same bit fields. <br><br>  The read value = 1203h = 00 <b>01.00</b> 10.0000.00 <b>11</b> b <br>  D0 = Current Connect Status = 1.  The device is connected. <br>  D1 = Port Enabled / Disabled = 1.  The port is in use. <br>  D [13-10] = Port Speed ‚Äã‚Äã= 0100b.  The speed is 5.0 Gbit / S, USB 3.0 Super Speed ‚Äã‚Äãmode works. <br><br>  5) For self-checking, we connect a USB 2.0 flash drive to the same port, then reread the register and decrypt the same bit fields.  The read value = 02A0h, which corresponds to no connection.  So it should be, the PORTSCNUSB3 register "does not see" the USB 2.0 device, since it is serviced by another subsystem and the connection status is available through another register - PORTSCNUSB2, consideration of which is beyond the scope of our research. <br><br><h2>  Summary </h2><br>  The test flash drive <i>does support USB 3.0 mode</i> . <br><br>  If you formalize and program the described actions as a DOS program or a UEFI application, you will get a small utility that allows you to quickly determine in which speed mode the USB device works.  To simplify our example, we implemented it for a particular case - the Tyan S5533 USB subsystem subsystem and the use of the first port, so the address of the PORTSCNUSB3 register in our example is constant.  In general, in order for the program to work on all platforms, the address of the PORTSCNUSB3 register must be calculated based on the contents of the XHCI Capabilities fields, in accordance with the USB 3.0 XHCI specification.  On the other hand, universality can be achieved much simpler and more elegant using UEFI protocols instead of direct interaction with controller registers. <br><br><h3>  Information sources </h3><br><ul><li>  <a href="http://composter.com.ua/documents/xHCI_Specification_for_USB.pdf">EXtensible Host Controller Interface Specification</a> </li><li>  <a href="http://composter.com.ua/documents/8-series-chipset-pch-datasheet.pdf">Intel 8 Series Chipset Documentation</a> </li></ul><br><br><h3>  UPD </h3><br>  As the "guinea pig" was used device Kingston DataTraveler 100 G3, 16 GB: <br><img src="https://habrastorage.org/getpro/habr/post_images/ead/cd2/23b/eadcd223bdef68a33e64029c87f7a83a.png" alt="image"><br><br><h3>  UPD-II </h3><br>  1. Device descriptors that can be viewed using various information utilities indicate the potential capabilities of the device.  The speed mode set for the USB port when the device is connected does not always correspond to the capabilities declared in the descriptors. <br><br>  A device declaring USB 3.0 support may operate in USB 2.0 mode due to manufacturing faults, a faulty cable, and many other reasons.  At the same time, the contents of the descriptors may indicate support for USB 3.0 mode. <br><br>  The USB specification recommends that the device issue a different set of descriptors depending on the actual set speed.  But we have no guarantee that this recommendation is observed by the developers of the flash drive. <br><br>  Of course, the contents of the device descriptors are a more reliable source of information than the inscription on the flash drive and the vows of the seller.  But for the reasons stated above, confidence is different from 100 percent. <br><br>  It is the desire to bring the accuracy to 100% led us to extremely low-level research. <br><br>  2. Another method is to track in the device manager which controller is the parent of a flash drive (USB 2.0 EHCI or USB 3.0 XHCI) is also inefficient, since, according to the specification, the USB 3.0 XHCI controller can support all kinds of devices: from Low-Speed ‚Äã‚Äãto Super Speed.  Therefore, from the fact that for a flash drive the parent controller is xHCI, it does not follow that the device operates in Super Speed ‚Äã‚Äãmode. </div><p>Source: <a href="https://habr.com/ru/post/204078/">https://habr.com/ru/post/204078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204066/index.html">How i was kul hacker</a></li>
<li><a href="../204068/index.html">Configuring WebRTC + Eclipse 4.3 + ubuntu 13.10</a></li>
<li><a href="../204070/index.html">Perfect posture with LUMOback</a></li>
<li><a href="../204074/index.html">The deflationary nature of BTC - is it bad?</a></li>
<li><a href="../204076/index.html">Genomics Computers</a></li>
<li><a href="../204080/index.html">Thinking about the book "Atlas Shrugged"</a></li>
<li><a href="../204082/index.html">We need a project director / producer</a></li>
<li><a href="../204084/index.html">MS disables sandboxing for Internet Explorer 11 by default.</a></li>
<li><a href="../204086/index.html">Lecture notes "Haskell as the first programming language." Part 1</a></li>
<li><a href="../204088/index.html">Good news: Maya for game developers at a price of 70 euros.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>