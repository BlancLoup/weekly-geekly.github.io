<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fighting a thirty-year bug</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The first edition said about a twenty-year bug. In fact, he is 30 years old. Thanks Sidnekin . 

 Today, reading some data, my program processed 36'91...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fighting a thirty-year bug</h1><div class="post__text post__text-html js-mediator-article">  <i>The first edition said about a twenty-year bug.</i>  <i>In fact, he is 30 years old.</i>  <i>Thanks <a href="https://twitter.com/Sidhekin/status/391160990873571329">Sidnekin</a> .</i> <br><br>  Today, reading some data, my program processed 36'916 possible dates.  Two of these 36'916 failed the test.  I did not attach any importance to this, because these dates were from the data provided by the client, and such data is often surprising.  However, looking at the source data, it turned out that the test did not pass on January 1, 2011 and January 1, 2007. There was a bug in the program I wrote a month ago.  But it turned out that this bug is 30 years old. <br><br>  Anyone who doesn‚Äôt really understand the software ecosystem will find it odd written below, but it makes sense.  Because of the decision taken long ago to bring money to one company, my client spent money to pay me so that I could fix a bug introduced by one company by chance, and another one on purpose.  To explain this, I will have to tell you about a third company that added a feature that eventually became a bug, and a few more facts that affected an incomprehensible bug that I fixed today. <br><a name="habracut"></a><br>  In the good old days, Apple computers sometimes dropped the date to January 1, 1904.  The reason is simple: at that time <a href="http://en.wikipedia.org/wiki/Apple_II_system_clocks">, Apple computers used battery-powered system time</a> to keep track of the date and time.  What happened when the battery sat down?  Apple computers counted their dates as the <a href="http://lowendmac.com/tech/1-1-2k.shtml">number of seconds since the beginning of the era</a> .  <a href="http://en.wikipedia.org/wiki/Epoch_(reference_date)">The epoch</a> in this case is just a reference date.  And for Apple computers, this date was January 1, 1904.  When the battery sat down this number became a new date.  But why did this really happen? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In those days, Apple used 32 bits to store the number of seconds from the starting date.  One bit can contain two values: 0 or 1. Two bits - four values: 00, 01, 10, 11. Three bits - eight values: 000, 001, 010, 011, 100, 101, 110, 111. And so on .  How many values ‚Äã‚Äãare contained in 32 bits?  32 bits contain 2 <sup>32</sup> (or 4'294'967'296) values.  For Apple dates, this was about 136 years, so <a href="http://lowendmac.com/lab/04/0115.html">old Apple computers cannot work with dates after 2040,</a> and if the battery in the system clock was down, the date was again 0 seconds after the era and you had to manually set the current number every time you turn on the computer (before buying a new battery). <br><br>  However, Apple‚Äôs decision to store dates as the number of seconds <i>after an</i> epoch meant that it was impossible to store dates <i>before an</i> epoch.  As we shall see, this had far-reaching consequences.  It was a feature, not a bug, added by Apple.  Among other things, this meant that the Macintosh operating system was immune to the Y2K problem (although many programs on the Mac did not have, since they had their own dates to circumvent the limitations of the Macs). <br><br>  Moving further, we encounter <a href="http://en.wikipedia.org/wiki/Lotus_1-2-3">Lotus 1-2-3</a> , a killer IBM application that helped launch the PC revolution, although in fact, <a href="http://en.wikipedia.org/wiki/VisiCalc">VisiCalc</a> at Apple gave rise to personal computers.  It can be said that, if it were not for 1-2-3, then the PCs most likely did not leave their niche and computer technologies developed quite differently.  However, Lotus 1-2-3 incorrectly considered the 1900th leap year.  When Microsoft released Multiplan, its first spreadsheet program, <a href="http://www.memecentral.com/mylife.htm">it failed to conquer the market</a> .  So when developing Excel, it was decided not only to copy the column naming rules from Lotus 1-2-3, but also to make the products fully, up to a bug, compatible, including intentional handling from 1900 as a leap year, the <a href="http://support.microsoft.com/kb/214326">problem is still relevant since then</a>  So for 1-2-3 it was a bug, but for Excel it was a feature that guaranteed to all 1-2-3 users the ability to import spreadsheets into Excel without differences in dates, even if they were wrong. <br><br>  Over time, Microsoft decided to release an Excel version for the Apple Macintosh, but there was a problem.  As already mentioned, Macintosh did not understand the dates until January 1, 1904, and for Excel, the era was January 1, 1900.  So Excel corrected to recognize the epoch and store the date relative to the corresponding epoch.  <a href="http://support.microsoft.com/kb/214330">The Microsoft Support article describes this problem quite clearly</a> .  And this leads to <i>my</i> bug. <br><br>  My current client receives spreadsheets from many of his clients.  These tables could be made on Windows, or they could be made on Mac.  As a result, the epoch in these tables may be January 1, 1900, or January 1, 1904.  How to find out which one?  <a href="http://msdn.microsoft.com/en-us/library/dd906747(v%3Doffice.12).aspx">The file format in Excel stores such information</a> , but the <a href="http://search.cpan.org/dist/Spreadsheet-ParseExcel-Stream/">parser that I use</a> does not provide it and believes that you yourself know what epoch you are dealing with in this file.  I probably should have spent a lot of time trying to figure out how to read the Excel binary format and send a patch to the parser developer, but I had other things to do with my $ client and I sketched the heuristics to determine what era this file belongs to.  She was simple. <br><br>  Excel can store, for example, July 5, 1998, but this number can be formatted as ‚Äú07-05-98‚Äù (useless American format), ‚ÄúJul 5, 98‚Äù, ‚ÄúJuly 5, 1998‚Äù, ‚Äú5-Jul. 98 ‚Äùand many other useless options (ironically, the only format that my version of Excel does not offer is ISO 8601).  Inside, the unformatted value is either 35981 for the era of 1900, or 34519 for the era of 1904 (these numbers correspond to the number of days that have passed since the era).  I used a robust parser to extract the year from the formatted date.  and then the Excel parser to extract the year from the unformatted value.  If they differed by four, then the dates in the file were counted from 1904. <br><br>  Why not use formatted dates right away?  Because July 5, 1998 <i>can</i> be formatted as "July 1998", losing the day.  We get spreadsheets from so many companies and they create them in so many different ways that they expect us (from <i>me</i> in this case) to understand.  Excel understands what's what, then I have to! <br><br>  It was here that 39082 gave me a push.  Remember how Lotus 1-2-3 considered the 1900th leap year, and how it was honestly copied to Excel?  Since it adds one day to 1900, many date calculating functions can be wrong for one day.  This means that 39082 <i>may</i> be January 1, 2011 (on a Mac), or <i>maybe</i> December 31, 2006 (on Windows).  This is great, of course, that my parser extracts 2011 from a formatted value.  But since the Excel parser does not know from which epoch the dates in this file are calculated, it assumes by default that it is from 1900, returns the year 2006, my program sees that there is a difference of <i>five</i> years, considers that it is a mistake, writes it to the log and returns unformatted value. <br><br>  To get around this, I came up with the following (pseudocode): <br><br><pre><code class="javascript hljs">difference = formatted_year - parsed_year <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">0</span></span> == difference ) assume <span class="hljs-number"><span class="hljs-number">1900</span></span> date system <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">4</span></span> == difference ) assume <span class="hljs-number"><span class="hljs-number">1904</span></span> date system <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">5</span></span> == difference and parsed month is December and parsed day is <span class="hljs-number"><span class="hljs-number">31</span></span> ) assume <span class="hljs-number"><span class="hljs-number">1900</span></span> date system</code> </pre> <br><br>  Now all 36'916 dates are parked correctly. <br><br>  <b>Note</b> : for fun, if you have a Mac with Excel, you can try entering the date before 1904 and format it in a different format.  You can enter it, but you cannot format it, because Excel will consider it to be plain text.  At the same time, for Microsoft Excel, all days of the week until March 1, 1900 are incorrect because of a bug in a program released in January 1983. <br><br>  <b>Update</b> : I was told that <a href="http://www.reddit.com/r/programming/comments/1opg85/fighting_a_20yearold_software_bug/">Spreadseet :: ParseExcel understands the 1904 flag</a> .  Unfortunately, I use Spreadsheet :: ParseExcel :: Stream, which does not understand.  Even on huge machines we do not have enough memory when using the standard parser, so we use streaming.  My attempts to circumvent this restriction ran into <a href="http://stackoverflow.com/questions/19122203/spreadsheetparseexcelstream-losing-its-parser">another bug</a> . <br><br>  <b>Update 2</b> : <a href="http://books.google.fr/books%3Fid%3DVi8EAAAAMBAJ%26lpg%3DPA30%26dq%3Dmacintosh%2Bspreadsheet%2Barrow%2Bkeys%2Bmultiplan%26pg%3DPA30%26hl%3Den">It turns out Microsoft first released Excel for Mac</a> . <br><br>  <b>Update 3</b> : <a href="http://www.joelonsoftware.com/items/2006/06/16.html">According to Joel Spolsky</a> , a bug in Lotus 1-2-3 could be a deliberate attempt to simplify the program.  I had read hints earlier that Lotus did this intentionally, but since I‚Äôm not sure about 100, I didn‚Äôt write about it. </div><p>Source: <a href="https://habr.com/ru/post/198174/">https://habr.com/ru/post/198174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198162/index.html">Send Hyper-V Server 2012 R2 and Windows Server 2012 R2</a></li>
<li><a href="../198164/index.html">New type of DDoS attack: TCP bug found in Windows</a></li>
<li><a href="../198166/index.html">The mathematical model predicts the outcome of the Kickstarter campaign with 76% confidence 4 hours after its start.</a></li>
<li><a href="../198170/index.html">New US Navy Destroyer Running Linux</a></li>
<li><a href="../198172/index.html">Creating an active 3d mold (discussion of theoretical possibility)</a></li>
<li><a href="../198178/index.html">Display issues in MacBook Air 2013</a></li>
<li><a href="../198186/index.html">We create the first application on NancyFX. Part two. Bootstrapper</a></li>
<li><a href="../198192/index.html">X86 emulator on javascript</a></li>
<li><a href="../198196/index.html">Veeam Management Pack for VMware v6.5 released for Microsoft System Center: what's new?</a></li>
<li><a href="../198198/index.html">Open data from existing state portals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>