<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Decryption of updates of one popular cellular modem: Dmitry Sklyarov method</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes you want to look into the firmware code of a device. But apart from the firmware itself, which is encrypted, there is nothing. And how can t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Decryption of updates of one popular cellular modem: Dmitry Sklyarov method</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/pt/blog/276949/"><img src="https://habrastorage.org/files/57a/a3d/184/57aa3d1842b14680807dda10915ba656.png"></a> <br><br>  Sometimes you want to look into the firmware code of a device.  But apart from the firmware itself, which is encrypted, there is nothing.  And how can the reverse with this live?  The article discusses the real situation when, using basic knowledge in computer science and logic, we managed to solve an almost hopeless task. <br><br>  The name of the modem manufacturer is removed, and some file names are specially changed, as I want to focus on the task itself - and on an interesting approach to its solution.  By the way, this method does not work in the latest models of modems from this manufacturer.  But it is possible that it can be used in other cases. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Definition of structure </h4><br>  Let's start by defining the firmware file structure.  There are three update files of different versions for one modem: <br><br><ul><li>  v2.8_image.bin </li><li>  v3.7_image.bin </li><li>  v3.7.4_image.bin </li></ul><br>  At a close look, all three files have inside the structure described by the TLV (Tag-Length-Value) scheme.  For example, for <code>v3.7.4_image.bin</code> : <br><br><img src="https://habrastorage.org/files/fd9/7a2/6ea/fd97a26ea2e14776864e12f769a8eb78.png"><br><br>  All values ‚Äã‚Äãare Little-endian, Tag has a length of 16 bits, Length - 32 bits. <br>  At the first level of nesting in the file there is only a tag 0x7240, and the data for it occupies the entire file.  At the second level of nesting (inside the tag data 0x7240) the tag 0x0003 (0x0A bytes) is located, then 0x0000 (0x4BDE0E bytes), then the tags 0x0001 and 0x0002 (in the screenshot did not fit).  At the third level of nesting (inside the tag data 0x0003) the tag 0x0002 is encapsulated, storing the 4-byte version number of the file 030704FF (if you discard all FF, you get 3.7.4). <br><br>  The remaining tags located on the second level of nesting (tags 0x0000, 0x0001 and 0x0002) contain descriptions of individual files ‚Äúpackaged‚Äù in one image. <br>  For each file, the name (tag 0x0001), flags (tag 0x0002), size (tag 0x0003), a 16-byte value (tag 0x0004) and the actual file data (tag 0x0005) are indicated. <br><br>  If you disassemble the tags on all three levels of nesting, you get something like this structure: <br><br><img src="https://habrastorage.org/files/106/29d/f71/10629df7164949909cf52e073cc40a63.png"><br><br>  Thus, you can extract encrypted data for all components from the firmware files ( <code>CPUImage</code> , <code>AutoInstall</code> and <code>WebUI</code> ).  As it turned out, the contents of <code>AutoInstall</code> in all three versions of the firmware are the same, the insides of <code>WebUI</code> same for v3.7 and v3.7.4, but differ in v2.8, and the <code>CPUImage</code> is unique for each version. <br><br><h4>  2. Guesses by algorithms </h4><br>  Tag 0x0004 at the third level of nesting contains a 16-byte data set with high entropy.  This hash value is quite possible, and the most popular 128-bit hash is MD5. <br><br>  If you look at the extracted files, you will notice that in them many bytes at the same offset coincide.  Here, for example, the beginning of two files (highlighted differences): <br><br><img src="https://habrastorage.org/files/aa7/c1f/6ee/aa7c1f6eef78454b800a6a00f6d0b5b1.png"><br><br>  However, if you try to find the same sequence within the same file, there will not be long repeats. <br><br>  A similar effect occurs when using encryption by superimposing a constant gamut of a very long length.  And the most popular encryption algorithm that works this way is RC4. <br><br><h4>  3. Attack on stream cipher with constant key </h4><br>  If several messages are encrypted using the same key (and therefore the gamma), you can try to uncover fragments of these messages by copying them together.  And in those places where there were zero bytes in one of the messages, the plaintext will appear in the other. <br><br>  Taking the files <code>AutoInstall</code> and <code>WebUI</code> , we get interesting results: <br><br><pre>  00000000: EB 3C 90 6D 6B 64 6F 73 66 73 00 00 02 04 01 00 l &lt;—ímkdosfs
 00000010: 02 00 02 F8 0F F8 03 00 20 00 40 00 00 00 00 00 ‚òª ‚òª‚òº @
 00000020: 00 00 00 00 00 00 29 29 6E 1F 3B 15 47 43 54 2D 4C) n ‚ñº; ¬ßGCT-L
 00000030: 54 45 20 20 20 20 46 41 54 31 32 20 20 20 0E 1F TE FAT12 ‚ô´ ‚ñº
 00000040: BE 5B 7C AC 22 C0 74 0B 56 B4 0E BB 07 00 CD 10 * [| ¬¨ "At‚ôÇV“ë ‚ô´‚Äù ‚Ä¢ H‚ñ∫
 00000050: 5E EB F0 32 E4 CD 16 CD 19 EB FE 54 68 69 73 20 ^ lr2dN‚ñ¨N ‚Üì anyThis
 00000060: 69 73 20 6E 6F 74 20 61 20 62 6F 6F 74 61 62 6C is not a bootabl
 00000070: 65 20 64 69 73 6B 2E 20 20 50 6C 65 61 73 65 20 e disk.  Please
 00000080: 69 6E 73 65 72 74 20 61 20 62 6F 6F 74 61 62 6C insert a bootabl
 00000090: 65 20 66 6C 6F 70 70 79 20 61 6E 64 0D 0A 70 72 e floppy and pr
 000000A0: 65 73 73 20 61 6E 79 20 6B 65 79 20 74 6F 20 74 Ess any key to t
 000000B0: 72 79 20 61 67 61 69 6E 20 2E 2E 2E 20 0D 0A 00 ry again ... ‚ô™ ‚óô
 000000C0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
 ...
 00008800: 02 43 44 30 30 31 01 00 00 20 00 20 00 20 00 20 CD001
 00008810: 00 20 00 20 00 20 00 20 00 20 00 20 00 20 00 20 </pre><br><h4>  4. Getting the start of gamma </h4><br>  Modern cellular modems like to connect to create a virtual CD-ROM from which you can install drivers or related software.  Probably the same idea was used here. <br><br>  However, when the modem is connected to modern operating systems (Windows 7/8, Linux, MacOS X), this CD-ROM either does not appear at all, or is present for only a fraction of a second, after which it disappears.  I had to find a 2002 laptop with Windows XP, where when I connected the modem, the CD-ROM also disappeared shortly after it appeared, but it took as long as 5 seconds.  During this time, it was possible to have time to read all sectors of a logical volume and get an image of <code>606 208 == 0x94000</code> size <code>606 208 == 0x94000</code> bytes, which corresponds to the size of the <code>AutoInstall</code> file.  And the MD5 value from the read image turned out to be <code>897279F34B7629801D839A3E18DA0345</code> , which corresponds to the value of the 0x0004 tag for this file. <br><br>  Now it remains to XORit the read image with the contents of <code>AutoInstall</code> and get the first 600 kilobytes of gamma.  <code>CPUImage</code> this gamma we can decipher the beginnings of the <code>CPUImage</code> and <code>WebUI</code> (having a length of 4 971 976 and 2 093 056 bytes, respectively). <br><br><h4>  5. FDD Image Reconstruction </h4><br>  If you decrypt the beginning of the WebUI file (the first 606 208 bytes) and fill in the rest with zeros, and interpret everything as a FAT image, the file system structure will be visible and even the contents of some files will be available: <br><br><pre>  Name |  Size |  Date | Time
 bru | Folder | 05/31/12 | 22: 17
 cgi-bin | Folder | 05/31/12 | 22: 17
 cors | Folder | 05/31/12 | 22: 17
 css | Folder | 05/31/12 | 22: 17
 eng | Folder | 05/31/12 | 22: 17
 img | Folder | 05/31/12 | 22: 17
 js | Folder | 05/31/12 | 22: 17
 en | Folder | 05/31/12 | 22: 17
 name.html |  2248 | 05/31/12 | 22: 17
 easyXDM.js | 101924 | 05.31.12 | 22: 17
 easyXDM.debug.js | 113900 | 05/31/12 | 22: 17
 easyXDM.min.js |  19863 | 05/31/12 | 22: 17
 easyXDM.Widgets.js |  11134 | 05/31/12 | 22: 17
 easyXDM.Widgets.debug.js |  11134 | 05/31/12 | 22: 17
 easyXDM.Widgets.min.js |  3114 | 05/31/12 | 22: 17
 json2.js |  17382 | 05/31/12 | 22: 17
 easyxdm.swf |  1758 | 05/31/12 | 22: 17
 MIT-license.txt |  1102 | 05/31/12 | 22: 17 </pre><br>  If a browser is connected to the modem, go to the web interface at <code>http://&lt;   &gt;/dir</code> , then you will see exactly the same file system, and you can download any file. <br><br>  Thus, to restore the WebUI disk image, you need to expand the files downloaded via the web interface into the places where they should be in accordance with the data in the boot sector, the FAT table and the directory descriptions.  The only difficulty is the ‚Äúru‚Äù folder at the root.  The cluster with the description of files in this folder does not fall into the first 606 208 bytes, and its contents must be recreated manually. <br><br>  According to the information from the web interface, the following files should be in the ‚Äúru‚Äù directory: <br><br><pre>  Name |  Size |  Date | Time
 Manualupdate.html |  3981 | 05/31/12 | 22: 17
 Index.html |  5327 | 05/31/12 | 22: 17
 Network.html |  3328 | 05/31/12 | 22: 17 </pre><br>  Fortunately, there is a folder in the root ‚Äúeng‚Äù, in which files with the same names and creation dates are located.  And to get the correct data for the folder ‚Äúru‚Äù you just need to fix it: <br><br><ul><li>  the start cluster number of the current directory, </li><li>  size of each file </li><li>  numbers of starting clusters of each file. </li></ul><br>  The cluster number of the ‚Äúru‚Äù directory (0x213) can be obtained from the root directory. <br>  File sizes (3981 == 0xF8D, 5327 == 0x14CF and 3328 == 0xD00, respectively) can be found in the web interface. <br><br>  The numbers of starting clusters for files will have to be guessed, but this is not very difficult.  According to information in the boot sector, each cluster occupies 4 sectors or 2048 bytes.  For the ‚Äúru‚Äù directory, one cluster is enough, for the <code>Manualupdate.html</code> and <code>Network.html</code> ‚Äî two, and for the <code>Index.html</code> need three clusters.  Since clusters are usually allocated sequentially when writing to an empty disk, files will start in clusters 0x214, 0x216 and 0x219, respectively.  The recovered data for the ‚Äúru‚Äù directory will look like this: <br><br><pre>  00000000: 2E 20 20 20 20 20 20 20 20 20 20 10 00 00 2C AA.  ‚ñ∫, to
 00000010: BF 40 BF 40 00 00 2C AA BF 40 13 02 00 00 00 00 ‚îê @ ‚îê @, k‚îê @
 00000020: 2E 2E 20 20 20 20 20 20 20 20 20 10 00 00 2C AA .. ‚ñ∫, to
 00000030: BF 40 BF 40 00 00 2C AA BF 40 00 00 00 00 00 00 ‚îê @ ‚îê @, k‚îê @
 00000040: 42 68 00 74 00 6D 00 6C 00 00 00 0F 00 56 FF FF Bh tml V&nbsp;
 00000050: FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF&nbsp;
 00000060: 01 6D 00 61 00 6E 00 75 00 61 00 0F 00 56 6C 00 manua ‚òº Vl
 00000070: 75 00 70 00 64 00 61 00 74 00 00 00 65 00 2E 00 update.
 00000080: 4D 41 4E 55 41 4C 7E 31 48 54 4D 20 00 00 2C AA MANUAL ~ 1HTM,
 00000090: BF 40 BF 40 00 00 2C AA BF 40 14 02 8D 0F 00 00 ‚îê @ ‚îê @, k‚îê @ ¬∂‚òªH‚òº
 000000A0: 41 69 00 6E 00 64 00 65 00 78 00 0F 00 33 2E 00 Ai ndex 3.
 000000B0: 68 00 74 00 6D 00 6C 00 00 00 00 00 FF FF FF FF html&nbsp;
 000000C0: 49 4E 44 45 58 7E 31 20 48 54 4D 20 00 00 2C AA INDEX ~ 1 HTM, 
 000000D0: BF 40 BF 40 00 00 2C AA BF 40 16 02 CF 14 00 00 ‚îê @ ‚îê @, ‚îê @ ‚ñ¨‚òª‚ïß¬∂
 000000E0: 41 6E 00 65 00 74 00 77 00 6F 00 0F 00 98 72 00 An etwo ‚òº Shr
 000000F0: 6B 00 2E 00 68 00 74 00 6D 00 00 00 6C 00 00 00 k.  html
 00000100: 4E 45 54 57 4F 52 7E 31 48 54 4D 20 00 00 2C AA NETWOR ~ 1HTM,
 00000110: BF 40 BF 40 00 00 2C AA BF 40 19 02 00 0D 00 00 ‚îê @ ‚îê @, k‚îê @ ‚Üì ‚òª ‚ô™
 00000120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 </pre><br>  Carefully assembling the reconstructed folder ‚Äúru‚Äù and the contents of all files received from the web interface into a disk image (given that the first cluster corresponds to sector 0x23), we get a plain-text version of the WebUI file, the MD5 value for which coincides with <code>48D1C3194E45472D28ABFBEB6BBF1CC6</code> from the update header. <br><br>  We now have the decrypted AutoInstall and WebUI files, and we know the first 2,093,056 bytes of gamma. <br><br><h4>  6. Let's look at CPUImage </h4><br><br>  After we decrypted the first 2 megabytes of CPUImage, it finally makes sense to run the disassembler.  After determining the processor command system (ARM Little-Endian), the base address of the download (you need to throw out the first 0x34C bytes of the file) and localization of the location for decrypting updates, you can see the following code: <br><br><pre>  ROM: 0008ADD0 loc_8ADD0 
 ROM: 0008ADD0 LDR R1, = byte_2ADC60
 ROM: 0008ADD4 LDRB R2, [R1, R0]
 ROM: 0008ADD8 LDRB R1, [R4]
 ROM: 0008ADDC ADD R0, R0, # 1
 ROM: 0008ADE0 ADD R2, R2, R1
 ROM: 0008ADE4 ADD R2, R2, R6
 ROM: 0008ADE8 AND R6, R2, # 0xFF
 ROM: 0008ADEC LDRB R2, [R10, R6]
 ROM: 0008ADF0 STRB R2, [R4], # 1
 ROM: 0008ADF4 STRB R1, [R10, R6]
 ROM: 0008ADF8 MOV R1, # 0x15
 ROM: 0008ADFC BL sub_27C0EC
 ROM: 0008AE00 SUBS R11, R11, # 1
 ROM: 0008AE04 AND R0, R1, # 0xFF
 ROM: 0008AE08 BNE loc_8ADD0 </pre><br>  This is nothing more than loading the encryption key, located at 0x2ADC60 and having a length of 0x15 bytes, into the RC4 algorithm.  However, <code>0x2ADC60==2'808'928</code> , that is, the key, is located outside the area for which we know the gamma. <br><br>  True, we have three versions of updates.  Suddenly in v3.7 or v2.8 key in a better place?  Alas, in earlier firmware, the key location address will be <code>0x2AD70C</code> and <code>0x2A852C</code> , which is also outside the decoded area :( <br><br><h4>  7. And again XOR </h4><br>  If we interconnect CPUImage from v3.7 and v3.7.4 updates, then at <code>0x34C + 0x2AD70C == 0x2ADA58</code> we will find the line "SungKook" James "Shin", which is the same RC4 key, on which all files included in in updates. <br><br>  It remains to make sure that the gamma at the output of RC4, initialized with this key, coincides with that obtained earlier from <code>AutoInstall</code> and <code>WebUI</code> , and that the MD5 from the decoded <code>CPUImage</code> coincides with the value from the update header. <br><br>  Now you can begin to analyze the actual firmware, but that's another story. <br><br>  <b>Author</b> : Dmitry Sklyarov, Head of Application Research, Positive Technologies </div><p>Source: <a href="https://habr.com/ru/post/276949/">https://habr.com/ru/post/276949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276937/index.html">Algorithm for creating a list of all permutations or placements</a></li>
<li><a href="../276939/index.html">DUMP-2016 Developer Conference: Ekaterinburg, April 8</a></li>
<li><a href="../276941/index.html">Deploying Linux distribution with SCCM 2012</a></li>
<li><a href="../276943/index.html">GPU vs CPU: Why are GPUs used to analyze financial data</a></li>
<li><a href="../276945/index.html">How we ported the good old Russian quest</a></li>
<li><a href="../276951/index.html">WhatsApp architecture Facebook bought for $ 19 billion</a></li>
<li><a href="../276953/index.html">We are looking for Mega developers: turn on the idea generator</a></li>
<li><a href="../276955/index.html">Rumors confirmed - Opera Software is sold to China</a></li>
<li><a href="../276957/index.html">Carefully about counting single bits</a></li>
<li><a href="../276961/index.html">Nginx 1.9.11 released with support for dynamic modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>