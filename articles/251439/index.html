<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The output temperature, traffic jams and exchange rates on the LED matrix Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a Raspberry Pi on hand with such a thing connected to it: 



 There is still a button. So there was a desire by pressing a button to display...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The output temperature, traffic jams and exchange rates on the LED matrix Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article">  There is a Raspberry Pi on hand with such a thing connected to it: <br><br><img src="https://habrastorage.org/files/1b4/0ee/349/1b40ee3495ad4276a91843752014346f.jpg" width="200"><img src="https://habrastorage.org/files/bc5/6ce/783/bc56ce783ea94d5aabe916c2ec2bbf35.JPG" width="300"><br><br>  There is still a button.  So there was a desire by pressing a button to display something useful on the LED matrix, and not <a href="https://www.youtube.com/watch%3Fv%3D0r7xG4yVLCU">pampering</a> .  And still to learn a python - OOP, flows, parsing and other.  We can say that this is my first useful python project.  So this article will be at the same time useful for those who want to make a home informer, and, moreover, I hope, instructive. <br><a name="habracut"></a><br>  For the correct operation of the matrix with python, we need this kind of <a href="https://github.com/rm-hull/max7219">thing</a> .  And we will load information for a conclusion with 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="http://bank-ua.com/xml/">bank-ua.com</a> </li><li>  worldweatheronline.com </li></ul><br>  These services are taken for example, completely free.  You can use anything else.  If you wish, you can withdraw and traffic jams on Yandex, but they are not so easy to get. <br><br><div class="spoiler">  <b class="spoiler_title">Getting points Yandex.Probok</b> <div class="spoiler_text">  We will need: <br>  PHP web server ‚Äî for example, <a href="http://www.penguintutor.com/linux/light-webserver">www.penguintutor.com/linux/light-webserver</a> ; <br>  xvfb - sudo apt-get install xvfb; <br>  CutyCapt - <a href="http://cutycapt.sourceforge.net/">cutycapt.sourceforge.net</a> ; <br>  Result: a picture with jams and a text file with the value of the points of jams. <br><br>  save.php <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $f = <span class="hljs-string"><span class="hljs-string">"@/probki.txt"</span></span>; $fileHandle = fopen($f, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">"Unable to open the "</span></span>.$f); fwrite($fileHandle, $_GET[<span class="hljs-string"><span class="hljs-string">"val"</span></span>]); fclose($fileHandle); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> file_get_contents($f); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br>  probki.html <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//api-maps.yandex.ru/2.1/?lang=ru_RU"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">html</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css">, </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#map</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> ymaps.ready(init); </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">init</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> myMap = </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">new</span></span></span><span class="actionscript"> ymaps.Map(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"map"</span></span></span><span class="actionscript">, { </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// .      . center: [50.47,30.54], zoom: 12, controls: [] }); //    ""    . var actualProvider = new ymaps.traffic.provider.Actual({}, { infoLayerShown: true }); //      . actualProvider.setMap(myMap); actualProvider.state.events.add("change", function () { var jamlevel = actualProvider.state.get("level"); if (jamlevel!== null) { //   -      PHP ,     ,   . document.getElementById("val").src="save.php?val="+jamlevel; } }); } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bgcolor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#555555"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"position: absolute;left: 30px; top: 0px; z-index: 2;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://clck.yandex.ru/redir/dtype=stred/pid=7/cid=1228/*http://pogoda.yandex.ru/kyiv"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://info.weather.yandex.net/kyiv/2_white.uk.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">border</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$ &lt;img width="</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://clck.yandex.ru/click/dtype=stred/pid=7/cid=1227/*http://img.yandex.ru/i/pix.gif"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">border</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--        --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"position: absolute; right: 30px; top: 0px; z-index: 3;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://info.maps.yandex.net/traffic/kiev/tends_200.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  ."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">border</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"map"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!--    PHP  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"val"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display:none"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now, if you open this file in the browser, we will see a map with traffic jams, a weather widget and traffic jams, and most importantly, a probki.txt file with the value of traffic jams and their picture will appear in the "@" folder.  After that we can force our server to open this page automatically according to the set schedule.  So, add the following to cron: <br><br><pre> <code class="bash hljs">/usr/bin/xvfb-run -a -s <span class="hljs-string"><span class="hljs-string">"-screen 0 1600x1200x16"</span></span> /usr/bin/CutyCapt --url=http://mywebsite/probki.html --out=/var/www/mywebsite/@/probki.jpg --javascript=on --delay=5000 --min-width=1600 --min-height=1200</code> </pre></div></div><br>  To reduce the number of API calls, you can cache the results once every half hour and when you click the button, read the cached value. <br><br><div class="spoiler">  <b class="spoiler_title">Caching weather, exchange rates and traffic jams</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ########################################################### echo $(date +%F/%T%Z) "UpdateInfo started" &gt; /var/log/updateinfo rm -f /var/www/mywebsite/@/currrate.xml /usr/bin/wget http://bank-ua.com/export/currrate.xml -P /var/www/mywebsite/@/ -q -N echo $(date +%F/%T%Z) "UpdateInfo currate" &gt;&gt; /var/log/updateinfo rm -f /var/www/mywebsite/@/weather.json /usr/bin/wget "http://api.worldweatheronline.com/free/v1/weather.ashx?q=Kyyiv&amp;format=json&amp;extra=localObsTime&amp;num_of_days=5&amp;includelocation=yes&amp;lang=uk&amp;key=13a4e16719a757403c5db6f4a8f3067e4534b4d8" -O /var/www/mywebsite/@/weather.json -q -N echo $(date +%F/%T%Z) "UpdateInfo weather" &gt;&gt; /var/log/updateinfo rm -f /var/www/mywebsite/@/probki.jpg rm -f /var/www/mywebsite/@/probki.txt /usr/bin/xvfb-run -a -s "-screen 0 1600x1200x16" /usr/bin/CutyCapt --url=http://mywebsite/probki.php --out=/var/www/mywebsite/@/probki.jpg --javascript=on --delay=5000 --min-width=1600 --min-height=1200 echo $(date +%F/%T%Z) "UpdateInfo Traffic" &gt;&gt; /var/log/updateinfo</span></span></code> </pre></div></div><br>  Now we will start the most interesting.  In order for the buttons connected to the copy to start doing something, you need to write a script daemon that would react to changes in the state of GPIO.  Consider an example of such a script written in Python that will handle long and short presses of each button and their combinations. <br><br>  Suppose we have four buttons.  I wrote to handle the buttons sequentially, without a loop.  It's easier and I do not think that someone will have so many buttons that you have to write a cycle. <br><br>  The logic is simple.  We are transferring the specified GPIO pin to high voltage read mode.  Next, we enter an infinite loop with a small pause, in which we remember the current values ‚Äã‚Äãof the pins and compare them with the previous ones.  If the value is different, the status of the button has changed.  And by adding another timer, we can make the trigger of a long button press according to this logic: if the button was pressed and now not pressed, and it took more than 2 seconds from the time, we react to long button presses. <br><br>  Similarly, you can handle combinations of buttons by adding the condition for two (or more) buttons at the same time.  So, the following script handles long and short pressing of four buttons and simultaneous pressing of the first and second. <br><br><div class="spoiler">  <b class="spoiler_title">buttondaemon.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># This Python file uses the following encoding: utf-8 import RPi.GPIO as GPIO import time import os import sys import logging logger = logging.getLogger('buttons_daemon') hdlr = logging.FileHandler('/MyLogs/main.log') formatter = logging.Formatter('%(asctime)s %(levelname)s %(message)s') hdlr.setFormatter(formatter) logger.addHandler(hdlr) logger.setLevel(logging.WARNING) suffix = " &gt; /dev/null&amp;" #adjust for where your switch is connected button1Pin = 18 button2Pin = 13 button3Pin = 16 button4Pin = 15 prev_input1 = 0 prev_input2 = 0 prev_input3 = 0 prev_input4 = 0 btimer12 = 0 btimer1= 0 btimer2= 0 btimer3= 0 btimer4= 0 GPIO.setmode(GPIO.BOARD) GPIO.setup(button1Pin,GPIO.IN, pull_up_down=GPIO.PUD_DOWN) GPIO.setup(button2Pin,GPIO.IN, pull_up_down=GPIO.PUD_DOWN) GPIO.setup(button3Pin,GPIO.IN, pull_up_down=GPIO.PUD_DOWN) GPIO.setup(button4Pin,GPIO.IN, pull_up_down=GPIO.PUD_DOWN) while True: #assuming the script to call is long enough we can ignore bouncing input1 = GPIO.input(button1Pin) input2 = GPIO.input(button2Pin) input3 = GPIO.input(button3Pin) input4 = GPIO.input(button4Pin) if (input1): btimer1 += 1 if (input2): btimer2 += 1 if (input3): btimer3 += 1 if (input4): btimer4 += 1 #Some button up if ((not input1) and (not input2) and (not input3) and (not input4) and ( (prev_input1) or (prev_input2) or (prev_input3) or (prev_input4) ) ): #Button 12 if ((prev_input1) and (prev_input2) and (not prev_input3) and (not prev_input4) ): if ((btimer1&gt;20) and (btimer2&gt;20)): logger.warning("Button12 long"); os.system("sudo /leds+buttons/button12long"+suffix) else: logger.warning("Button12"); os.system("sudo /leds+buttons/button12"+suffix) #Button 1 if ((prev_input1) and (not prev_input2) and (not prev_input3) and (not prev_input4) ): if (btimer1&gt;20): logger.warning("Button1 long"); os.system("sudo /leds+buttons/button1long"+suffix) else: logger.warning("Button1"); os.system("sudo /leds+buttons/button1"+suffix) #Button 2 if ((prev_input2) and (not prev_input1) and (not prev_input3) and (not prev_input4) ): if (btimer2&gt;20): logger.warning("Button2 long"); os.system("sudo /leds+buttons/button2long"+suffix) else: logger.warning("Button2"); os.system("sudo /leds+buttons/button2"+suffix) #Button 3 if ((prev_input3) and (not prev_input2) and (not prev_input1) and (not prev_input4) ): if (btimer3&gt;20): logger.warning("Button3 long"); os.system("sudo /leds+buttons/button3long"+suffix) else: logger.warning("Button3"); os.system("sudo /leds+buttons/button3"+suffix) #Button 4 if ((prev_input4) and (not prev_input2) and (not prev_input3) and (not prev_input1) ): if (btimer4&gt;20): logger.warning("Button4 long"); os.system("sudo /leds+buttons/button4long"+suffix) else: logger.warning("Button4"); os.system("sudo /leds+buttons/button4"+suffix) btimer1=0 btimer2=0 btimer3=0 btimer4=0 prev_input1 = input1 prev_input2 = input2 prev_input3 = input3 prev_input4 = input4 time.sleep(0.2)</span></span></code> </pre></div></div><br>  When you click a particular button or combination, the corresponding bash script from the / leds + buttons folder will be called.  Create dummy files with the corresponding name as in the script.  An example of such a file (button1long): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo Button 1 pressed | wall #Do something exit</span></span></code> </pre><br>  Now from our Python script make a demon.  Create a file in the /etc/init.d folder called buttondaemon <br><br><div class="spoiler">  <b class="spoiler_title">buttondaemon</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh # /etc/init.d/buttondaemon ### BEGIN INIT INFO # Provides: buttondaemon # Required-Start: $remote_fs $syslog # Required-Stop: $remote_fs $syslog # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 # Short-Description: Daemon to control button events # Description: Daemon which starts python script to control GPIO button events. ### END INIT INFO # If you want a command to always run, put it here # Carry out specific functions when asked to by the system case "$1" in start) echo "Starting button daemon" # run application you want to start sudo python /leds+buttons/buttondaemon.py&amp; ;; stop) echo "Stopping button daemon" # kill application you want to stop kill -9 $(ps -ef | grep -v "grep" | grep buttondaemon.py | awk '{ print $2 }') &amp;&gt; /dev/null ;; *) echo "Usage: /etc/init.d/buttondaemon {start|stop}" exit 1 ;; esac exit 0</span></span></code> </pre><br>  The start command starts our Python script, and the stop command stops it.  Give all the scripts the necessary rights.  Now we can try typing in the console: <br><br><pre> <code class="bash hljs">sudo /etc/init.d/buttondaemon start</code> </pre><br>  and shake the buttons, depending on what is displayed on the screen.  Voila! </div></div><br>  Now we have to bring something to the LED-matrix.  Create a python script that will work out at the touch of a button.  For some reason, the urlget runs for at least a second in two seconds, while the same link is opened by the browser instantly.  In order to see the beginning of the script, and not stick 2 seconds in an empty matrix, the script will show the animation while the data is loaded. <br><br>  First show the current temperature and precipitation.  To understand that the temperature on the screen, in the upper right corner, we will show a point symbolizing the degree sign. <br><br>  To show two-digit numbers on the screen compactly, draw tsiferki in the amount of 3x6: <br><br><div class="spoiler">  <b class="spoiler_title">digits.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- rows = 6 columns = 3 symbol = [[[0 for x in range(columns)] for x in range(rows)] for x in range(10)] symbol[1] = [ [0,0,1], [0,1,1], [0,0,1], [0,0,1], [0,0,1], [0,0,1], ] symbol[2] = [ [1,1,1], [0,0,1], [1,1,1], [1,0,0], [1,0,0], [1,1,1], ] symbol[3] = [ [1,1,1], [0,0,1], [0,1,1], [0,0,1], [0,0,1], [1,1,1], ] symbol[4] = [ [1,0,0], [1,0,0], [1,0,1], [1,1,1], [0,0,1], [0,0,1], ] symbol[5] = [ [1,1,1], [1,0,0], [1,1,1], [0,0,1], [0,0,1], [1,1,1], ] symbol[6] = [ [1,1,1], [1,0,0], [1,1,1], [1,0,1], [1,0,1], [1,1,1], ] symbol[7] = [ [1,1,1], [0,0,1], [0,1,0], [0,1,0], [0,1,0], [0,1,0], ] symbol[8] = [ [1,1,1], [1,0,1], [0,1,0], [1,0,1], [1,0,1], [1,1,1], ] symbol[9] = [ [1,1,1], [1,0,1], [1,0,1], [1,1,1], [0,0,1], [1,1,1], ] symbol[0] = [ [1,1,1], [1,0,1], [1,0,1], [1,0,1], [1,0,1], [1,1,1], ]</span></span></code> </pre></div></div><br>  About precipitation separately.  I wanted to show them on the same screen with the temperature.  Therefore, they are displayed in the form of points from zero to three in the upper left corner. <br><br>  All requests for traffic and exchange rates do this time against the background in parallel streams.  The change of data on the matrix is ‚Äã‚Äãanimated by a shift.  If you cannot upload any data, a sad smiley will be shown instead. <br><br><div class="spoiler">  <b class="spoiler_title">informer.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import max7219.led as led import max7219.font as font import threading, sys, time import digits import urllib2 import json import xml.etree.ElementTree as ET debug=0 def log(message): if debug==1: print(message) device = led.matrix(cascaded=1) device.brightness(0) hourglass = [ [0,1,1,1,1,1,1,0], [0,1,0,0,0,0,1,0], [0,0,1,0,0,1,0,0], [0,0,0,1,1,0,0,0], [0,0,0,1,1,0,0,0], [0,0,1,0,0,1,0,0], [0,1,0,0,0,0,1,0], [0,1,1,1,1,1,1,0], ] jopa = [ [0,0,1,1,1,1,1,0], [0,1,1,1,1,1,1,1], [0,1,0,0,1,0,0,1], [0,1,1,1,1,1,1,1], [0,0,1,1,0,1,1,0], [0,0,1,1,1,1,1,0], [0,0,1,1,1,1,1,0], [0,0,1,0,1,0,1,0], ] sad = [ [0,0,1,1,1,1,0,0], [0,1,0,0,0,0,1,0], [1,0,1,0,0,1,0,1], [1,0,0,0,0,0,0,1], [1,0,0,1,1,0,0,1], [1,0,1,0,0,1,0,1], [0,1,0,0,0,0,1,0], [0,0,1,1,1,1,0,0], ] #Thread with wait animation class TAnimationThread (threading.Thread): def __init__(self, threadID): threading.Thread.__init__(self) self.threadID = threadID self.Continue=True def run(self): log("Starting animation") counter=0 while (self.Continue): DrawAnimation(counter) counter+=1 if counter==7: counter=0 time.sleep(0.8) def stop(self): self.Continue = False log("Stopping animation") def DrawAnimation(counter): #draw log("Drawing animation"+str(counter)) if counter==0: for j in range(8): for i in range(8): if hourglass[j][i] == 1: device.pixel(i, 7-j, 1, redraw=False) elif counter&gt;0 and counter&lt;5: device.pixel(1+counter, 1, 1, redraw=False) elif counter==5 or counter==6: device.pixel(counter-2, 2, 1, redraw=False) else: device.clear() device.flush() def fetch_traffic(url): global TrafficData try: response = urllib2.urlopen(url) TrafficData = int(response.read()) log("Traffic fetched") except BaseException: TrafficData=-100 log(TrafficData) def fetch_currrate(url): global CurrencyData try: response = urllib2.urlopen(url) root = ET.fromstring(response.read()) CurrencyData=float(root[16][5].text)/100 log("Currency fetched") except BaseException: CurrencyData=-100 log(CurrencyData) #Let's begin log("Starting animation thread") AnimationThread = TAnimationThread(1) AnimationThread.start() log("Starting traffic thread") TrafficThread = threading.Thread(target=fetch_traffic, args=("http://tarasius.name/@/probki.txt",)) TrafficThread.start() CurrencyThread = threading.Thread(target=fetch_currrate, args=("http://tarasius.name/@/currrate.xml",)) CurrencyThread.start() # Get and show temperature log("Starting weather fetch") try: response = urllib2.urlopen("http://tarasius.name/@/weather.json") data = json.loads(response.read()) response.close() temp = int(data["data"]["current_condition"][0]["temp_C"]) precip = float(data["data"]["current_condition"][0]["precipMM"]) temp1 = abs(temp)/10 temp2 = abs(temp)%10 except BaseException: temp=-100 precip=-100 temp1=-100 temp2=-100 log("Stopping animation thread") AnimationThread.stop() device.clear() device.flush() m = [[0 for x in range(8)] for x in range(64)] if precip==-100: #cloudcover was unavailable for j in range(8): for i in range(8): if sad[i][j] == 1: m[j][7-i]=1 #draw cloudcover elif precip&gt;1.5: m[0][7] = 1 m[2][7] = 1 m[4][7] = 1 elif precip&lt;=1.5 and precip&gt;0.5: m[1][7] = 1 m[3][7] = 1 elif precip&lt;=0.5 and precip&gt;0.1: m[2][7] = 1 if temp&gt;-100: if temp&lt;0: #Draw minus m[0][3] = 1 if temp1==0: m[1][3]=1 m[2][3]=1 m[3][3]=1 if temp1&lt;&gt;0: #Draw first digit for j in range(digits.rows): for i in range(digits.columns): if digits.symbol[temp1][j][i] == 1: m[i+1][5-j] = 1 #draw second digit for j in range(digits.rows): for i in range(digits.columns): if digits.symbol[temp2][j][i] == 1: m[i+5][5-j] = 1 #draw celsium sign m[7][7] = 1 log("Drawing temperature") for i in range(8): for j in range(8): if m[j][i]==1: device.pixel(j, i, 1, redraw=False) device.flush() time.sleep(5) #Show traffic #Draw first digit TrafficThread.join() if TrafficData==10: for j in range(8): for i in range(8): if jopa[j][i] == 1: m[10+i][j]=1 elif TrafficData==-100: for j in range(8): for i in range(8): if sad[j][i] == 1: m[10+i][7-j]=1 else: #draw car m[10][6]=1 m[10][3]=1 m[11][7]=1 m[11][6]=1 m[11][5]=1 m[11][4]=1 m[11][3]=1 m[11][2]=1 m[12][5]=1 m[12][4]=1 TrafficData = TrafficData%10 #draw second digit for j in range(digits.rows): for i in range(digits.columns): if digits.symbol[TrafficData][j][i] == 1: m[i+15][5-j]=1 log("Drawing traffic") for step in range(9): device.clear() for i in range(8): for j in range(8): if m[i+step+2][j]==1: device.pixel(i, j, 1, redraw=False) device.flush() time.sleep(0.2) time.sleep(5) #Show currency CurrencyThread.join() if CurrencyData==-100: for j in range(8): for i in range(8): if sad[j][i] == 1: m[22+i][7-j]=1 else: cur=str(CurrencyData) for d in range(5): if cur[d]==".": digit=-1 else: digit=int(cur[d]) if digit==-1: m[22+d*5][0]=1 else: for j in range(digits.rows): for i in range(digits.columns): if digits.symbol[digit][j][i] == 1: m[i+21+d*5][5-j]=1 log("Drawing currency") for step in range(36): device.clear() for i in range(8): for j in range(8): if m[i+step+11][j]==1: device.pixel(i, j, 1, redraw=False) device.flush() time.sleep(0.2) device.clear() device.flush() sys.exit()</span></span></code> </pre></div></div><br>  Having tested that everything works, let's hang up the call to the informer on the button: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo "Button 1 pressed" | wall python /leds+buttons/informer.py &gt; /dev/null&amp; exit</span></span></code> </pre><br>  The result of all this should be something like this - 7 degrees, clearly, traffic jams 2 points, the euro exchange rate to hryvnia 32.02: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/UrgwORmMARE%3Ffeature%3Doembed&amp;xid=17259,15700002,15700019,15700186,15700190,15700253&amp;usg=ALkJrhj6aSdDsCnzjR61WZvOIYABACQ0gg" frameborder="0" allowfullscreen=""></iframe><br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/251439/">https://habr.com/ru/post/251439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251427/index.html">Getting to know GStreamer: items and containers</a></li>
<li><a href="../251431/index.html">How to recognize the manipulation and quickly neutralize them</a></li>
<li><a href="../251433/index.html">Started voting for the new features of the browser Vivaldi</a></li>
<li><a href="../251435/index.html">We stamp windows: automated deployment of Windows virtual machines to Hyper-V using Vagrant (part 1)</a></li>
<li><a href="../251437/index.html">Creating a convenient export of photos in VK. Part 1. iPhoto</a></li>
<li><a href="../251441/index.html">Few obscure frontend tricks</a></li>
<li><a href="../251443/index.html">Visual Studio 2015 CTP6 released</a></li>
<li><a href="../251445/index.html">Vulnerability in WP-Slimstat plugin 3.9.5 and below for WordPress</a></li>
<li><a href="../251447/index.html">In search of the best signal of the mobile Internet in the spring of 2015</a></li>
<li><a href="../251449/index.html">Complete energy autonomy or how to survive with solar panels in the outback (part 2. practical)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>