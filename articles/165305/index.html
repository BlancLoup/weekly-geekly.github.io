<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic visualization of geocoded data (Twitter) using R</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""New Year is sweeping the country" 
 I am an ardent fan of geosocial services. They allow you to visually see the physical realization of social space...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic visualization of geocoded data (Twitter) using R</h1><div class="post__text post__text-html js-mediator-article"><h5>  "New Year is sweeping the country" </h5><br>  I am an ardent fan of geosocial services.  They allow you to visually see the physical realization of social space.  This is what <a href="http://ru.wikipedia.org/wiki/%25D0%2591%25D1%2583%25D1%2580%25D0%25B4%25D1%258C%25D1%2591,_%25D0%259F%25D1%258C%25D0%25B5%25D1%2580">Bourdieu</a> wrote about, but what was available to him only in the form of a mental construct.  Foursquare is generally my unrequited love.  But about this sometime next time, and today we will talk about Twitter. <br>  Shortly before the end of the previous 2012 year, I wanted to see what the ‚Äúwave‚Äù of the New Year greetings tweets looks like.  See how it goes through time zones.  No sooner said than done.  Used tools: R, Python and ffmpeg. <br><img src="https://habrastorage.org/storage2/393/064/256/3930642567a8dd18168b595fe2ebf457.png"><br><a name="habracut"></a><br><h4>  Data collection </h4><br>  While the spouse took up the holiday preparations and didn‚Äôt remember about me, using python and <a href="http://pypi.python.org/pypi/tweetstream">tweetstream</a> we did the primitive tweet-stream <a href="https://dev.twitter.com/docs/api/1.1/post/statuses/filter">statuses / filter</a> parser. <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tweetstream stream = tweetstream.FilterStream(<span class="hljs-string"><span class="hljs-string">'TWITTER_LOGIN'</span></span>, <span class="hljs-string"><span class="hljs-string">'TWITTER_PASSWORD'</span></span>, track = keywords_list) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tweet <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> stream: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tweet[<span class="hljs-string"><span class="hljs-string">'coordinates'</span></span>]: <span class="hljs-comment"><span class="hljs-comment">#      date-time  # ( API Twitter     ) try: timestamp = datetime.datetime.strptime(tweet['created_at'], '%Y-%m-%d %H:%M:%S') except ValueError: timestamp = datetime.datetime.strptime(tweet['created_at'][4:-10]+tweet['created_at'][-4:], '%b %d %H:%M:%S %Y') #  4  - ""    timestamp += datetime.timedelta(hours=4) #       timestamp = datetime.datetime.strftime(timestamp, '%Y-%m-%d %H:%M:%S') #     cursor.execute('INSERT INTO tweets(link, latitude, longitude, date) VALUES ("http://www.twitter.com/{0}/status/{1}", "{2}", "{3}", "{4}")'.format( tweet['user']['screen_name'], tweet['id'], str(tweet['coordinates']['coordinates'][0]), str(tweet['coordinates']['coordinates'][1]), str(tweet['created_at']) )) db.commit()</span></span></code> </pre> <br>  <code>keywords_list</code> - A list of keywords, hash tags and phrases related to Happy New Year greetings.  Do not forget that this API call does not take into account the morphology, so you should try to enter as many relevant word forms as possible into the keywords.  My list is: <br><ul><li>  #happy New Year, </li><li>  #New Year2013, </li><li>  #NG2013, </li><li>  # Oncoming2013, </li><li>  #New Year, </li><li>  #Happy New Year, </li><li>  # NEW YEAR, </li><li>  happy New Year, </li><li>  holiday greetings, </li><li>  new 2013 </li><li>  with the year of the snake, </li><li>  Happy New Year of the Snake </li><li>  New Year, </li><li>  new year. </li></ul><br>  Everything, the spouse paid attention to excess hands, so we start the parser and we hasten to the rescue.  Finally, we contribute to the ‚Äúincrease in entropy‚Äù: <br><img src="https://habrastorage.org/storage2/beb/81d/1fe/beb81d1fe6bf96d909dfd64e0f0e8995.png"><br><br><h4>  Review of the data </h4><br>  <s>Night from Friday to Monday, the</s> first days of the new year flew by unnoticed.  The holiday has passed, the parser can be turned off and look at the "catch".  Total recruited ~ 10 thousand tweets.  Geotags on Twitter are not popular.  For mobility, I dumped a dump into a .csv table like "link - latitude - longitude - timestamp".  Ship the table in R: <br><pre> <code class="hljs pgsql">twits &lt;- <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>.csv2(<span class="hljs-string"><span class="hljs-string">'ny_tweets.csv'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>=F) colnames(twits) &lt;- c(<span class="hljs-string"><span class="hljs-string">'Link'</span></span>, <span class="hljs-string"><span class="hljs-string">'Longitude'</span></span>, <span class="hljs-string"><span class="hljs-string">'Latitude'</span></span>, <span class="hljs-string"><span class="hljs-string">'Timestamp'</span></span>) twits$<span class="hljs-type"><span class="hljs-type">Timestamp</span></span> &lt;- strptime(twits$<span class="hljs-type"><span class="hljs-type">Timestamp</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-string"><span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span></span>) twits$Latitude &lt;- round(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(twits$Latitude)), digits=<span class="hljs-number"><span class="hljs-number">1</span></span>) twits$Longitude &lt;- round(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(twits$Longitude)), digits=<span class="hljs-number"><span class="hljs-number">1</span></span>) twits$Longitude &lt;- sapply(twits$Longitude, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(x){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x &lt; (<span class="hljs-number"><span class="hljs-number">-169</span></span>)){ x&lt;<span class="hljs-number"><span class="hljs-number">-360</span></span>+x } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {x} })</code> </pre><br>  We translate timestamps into the appropriate format, round latitude and longitude - we will watch Twitter activity on the grid in one tenth of a degree.  The last longitude transformation is necessary for further visualization in order not to lose messages from Chukotka. <br>  Now we load <a href="http://ggplot2.org/">ggplot2</a> and see the distribution in time: <br><pre> <code class="hljs lisp">library('ggplot2') p &lt;- ggplot() p &lt;- p + geom_histogram(<span class="hljs-name"><span class="hljs-name">aes</span></span>(<span class="hljs-name"><span class="hljs-name">x=twits</span></span>$Timestamp, fill = ..count..), binwidth = <span class="hljs-number"><span class="hljs-number">3600</span></span>) p &lt;- p + ylab('') + xlab(' ( )') p &lt;- p + theme(<span class="hljs-name"><span class="hljs-name">legend</span></span>.position = 'none') p &lt;- p + ggtitle(<span class="hljs-name"><span class="hljs-name">expression</span></span>(' <span class="hljs-string"><span class="hljs-string">""</span></span> ')) p</code> </pre><br><img src="http://habrastorage.org/storage2/6bd/3e8/b0d/6bd3e8b0d92d05fa7354cea4759aa4ec.png"><br>  Everything looks approximately as expected, which pleasantly pleases.  We can continue. <br><br><h4>  Map drawing </h4><br>  Ggplot2 offers a rich set of tools for quickly building informative and cute graphs.  Full documentation with examples: <a href="http://docs.ggplot2.org/">ggplot docs</a> . <br>  To draw a map, we will use the geom_polygon function, which allows us to draw polygons according to given coordinates.  The contours of the countries will be taken from the <a href="http://cran.r-project.org/web/packages/maps/index.html">maps</a> library.  The drawing variant described in the article <a href="https://uchicagoconsulting.wordpress.com/tag/r-ggplot2-maps-visualization/">‚ÄúHow to draw good looking maps in R‚Äù</a> was taken as a basis.  We slightly modify the described version, adjusting it to our own needs and ‚Äúideas about beauty‚Äù: <br><pre> <code class="hljs mel">#    # countries -    ,    library(<span class="hljs-string"><span class="hljs-string">'maps'</span></span>) full_map &lt;- map_data(<span class="hljs-string"><span class="hljs-string">'world'</span></span>) table(full_map$region) need.map &lt;- subset(full_map, region %in% countries &amp; long&gt;<span class="hljs-number"><span class="hljs-number">-25</span></span> &amp; long&lt;<span class="hljs-number"><span class="hljs-number">190</span></span> &amp; lat&gt;<span class="hljs-number"><span class="hljs-number">25</span></span>) #   p &lt;- ggplot() p &lt;- p + geom_polygon(aes(x=need.map$long, y=need.map$lat, <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = need.map$group), colour=<span class="hljs-string"><span class="hljs-string">'white'</span></span>, fill=<span class="hljs-string"><span class="hljs-string">'grey20'</span></span>, alpha=<span class="hljs-number"><span class="hljs-number">.5</span></span>) #  <span class="hljs-string"><span class="hljs-string">""</span></span>     <span class="hljs-string"><span class="hljs-string">" "</span></span> # cities -  dataframe  <span class="hljs-string"><span class="hljs-string">"  -  - "</span></span> p &lt;- p + geom_point(aes(cities$Long, cities$Lat), colour=<span class="hljs-string"><span class="hljs-string">'skyblue'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>=<span class="hljs-number"><span class="hljs-number">1.5</span></span>) #    , ,     ,   p &lt;- p + theme(axis.line=element_blank(),axis.<span class="hljs-keyword"><span class="hljs-keyword">text</span></span>.x=element_blank(), axis.<span class="hljs-keyword"><span class="hljs-keyword">text</span></span>.y=element_blank(),axis.ticks=element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(), legend.position = <span class="hljs-string"><span class="hljs-string">'none'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>=element_text(family=<span class="hljs-string"><span class="hljs-string">'mono'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>=<span class="hljs-number"><span class="hljs-number">20</span></span>, face=<span class="hljs-string"><span class="hljs-string">'bold'</span></span>, colour=<span class="hljs-string"><span class="hljs-string">'dodgerblue3'</span></span>) ) p &lt;- p + scale_x_continuous(limits = c(<span class="hljs-number"><span class="hljs-number">-15</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>)) p &lt;- p + scale_y_continuous(limits = c(<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">82</span></span>)) p &lt;- p + ggtitle(<span class="hljs-keyword"><span class="hljs-keyword">expression</span></span>(<span class="hljs-string"><span class="hljs-string">'#HappyNewYear in Russian Twitter - 2013'</span></span>))</code> </pre><br>  I want to somehow revive the picture and add information.  Let's put a clock in the frame.  Here is an interesting option with a clock: <a href="http://www.drewconway.com/zia/%3Fp%3D2800">Create an animated clock in ggplot2 (and ffmpeg)</a> .  But it uses a polar coordinate system that does not suit us, because  will require extra gestures in the form of creating sub-graphics.  You have to do your "bike".  We take the function to calculate the coordinates of the circle in the center and diameter (peeped <a href="http://stackoverflow.com/questions/6862742/draw-a-circle-with-ggplot2">here</a> ): <br><pre> <code class="hljs matlab">draw.circle &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(center,diameter=1, npoints = 100)</span></span></span><span class="hljs-function">{ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">diameter</span></span></span><span class="hljs-function"> / 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tt</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0,2*pi,length.out = npoints)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xx</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">center</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tt)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yy</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">center</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[2]</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tt)</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">roundcoef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data.frame(x = xx, y = yy)</span></span></span><span class="hljs-function">) }</span></span></code> </pre><br>  Now we count the points for three circles: a white background backdrop, a gray ‚Äúupper‚Äù background and 12 points on the circle for the hour serifs: <br><pre> <code class="hljs pgsql">curtime &lt;- c(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(format(frame.time, <span class="hljs-string"><span class="hljs-string">'%H'</span></span>)), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(format(frame.time, <span class="hljs-string"><span class="hljs-string">'%M'</span></span>))) clock.center &lt;- c(<span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>) circdat &lt;- draw.circle(clock.center, diameter=<span class="hljs-number"><span class="hljs-number">20</span></span>) circdat2 &lt;- draw.circle(clock.center, diameter=<span class="hljs-number"><span class="hljs-number">19.7</span></span>) circdat3 &lt;- draw.circle(clock.center, diameter=<span class="hljs-number"><span class="hljs-number">18</span></span>, npoints=<span class="hljs-number"><span class="hljs-number">13</span></span>)</code> </pre><br>  We consider the position of the arrows: <br><pre> <code class="hljs lua">arrow.r = c(<span class="hljs-number"><span class="hljs-number">5.5</span></span>,<span class="hljs-number"><span class="hljs-number">8.8</span></span>) #   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(curtime[<span class="hljs-number"><span class="hljs-number">1</span></span>]&gt;=<span class="hljs-number"><span class="hljs-number">12</span></span>){curtime[<span class="hljs-number"><span class="hljs-number">1</span></span>]=curtime[<span class="hljs-number"><span class="hljs-number">1</span></span>]<span class="hljs-number"><span class="hljs-number">-12</span></span>} hourval &lt;- <span class="hljs-built_in"><span class="hljs-built_in">pi</span></span>*(<span class="hljs-number"><span class="hljs-number">.5</span></span> - (curtime[<span class="hljs-number"><span class="hljs-number">1</span></span>]+(curtime[<span class="hljs-number"><span class="hljs-number">2</span></span>]/<span class="hljs-number"><span class="hljs-number">60</span></span>))/<span class="hljs-number"><span class="hljs-number">6</span></span>) minval &lt;- <span class="hljs-built_in"><span class="hljs-built_in">pi</span></span>*(<span class="hljs-number"><span class="hljs-number">.5</span></span> - curtime[<span class="hljs-number"><span class="hljs-number">2</span></span>]/<span class="hljs-number"><span class="hljs-number">30</span></span>) hour.x &lt;- <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span>.center[<span class="hljs-number"><span class="hljs-number">1</span></span>] + arrow.r[<span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(hourval) hour.y &lt;- <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span>.center[<span class="hljs-number"><span class="hljs-number">2</span></span>] + arrow.r[<span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(hourval) minute.x &lt;- <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span>.center[<span class="hljs-number"><span class="hljs-number">1</span></span>] + arrow.r[<span class="hljs-number"><span class="hljs-number">2</span></span>] * <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(minval) minute.y &lt;- <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span>.center[<span class="hljs-number"><span class="hljs-number">2</span></span>] + arrow.r[<span class="hljs-number"><span class="hljs-number">2</span></span>] * <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(minval)</code> </pre><br>  Draw a clock (functions geom_polygon, geom_segment, geom_point): <br><pre> <code class="hljs django"><span class="xml"><span class="xml">#  :     p </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">geom_polygon</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aes</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">circdat$x,y</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">circdat$y),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colour</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'grey100'</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fill</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'grey100'</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alpha</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">.5)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">geom_polygon</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aes</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">circdat2$x,y</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">circdat2$y),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colour</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'grey80'</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fill</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'grey80'</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alpha</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">.5)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">geom_point</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aes</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">circdat3</span></span></span></span><span class="xml"><span class="hljs-tag">$</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">circdat3</span></span></span></span><span class="xml"><span class="hljs-tag">$</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colour</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'skyblue'</span></span></span></span><span class="xml"><span class="hljs-tag">) #  , , ""   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">geom_segment</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aes</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clock.center[1],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clock.center[2],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xend</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">hour.x,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">yend</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">hour.y),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colour</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'dodgerblue3'</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">geom_segment</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aes</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clock.center[1],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clock.center[2],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xend</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">minute.x,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">yend</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">minute.y),</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1.5,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colour</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'dodgerblue4'</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">geom_point</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aes</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">clock.center</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">clock.center</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">]), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colour</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'blue4'</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span></span></span></code> </pre><br>  This is what happened (on the map there are also test data on ‚Äúactivity‚Äù, but only in Moscow and the surrounding area): <br><img src="http://habrastorage.org/storage2/e44/511/327/e445113273e15702e846286511ccbbc2.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Draw frames </h4><br>  Baseline - a table with the coordinates and time of publication of the tweet.  At the exit, we want to get a set of frames.  Let's do this: we will set the time of the 1st frame, the time of the last frame and the time difference between adjacent frames in the settings.  The total number of frames will be calculated in R. Next is the cycle from 1 to the last frame.  In each frame, the ‚Äúcurrent‚Äù time will be calculated.  Next - from the source table we will select tweets that fall in the required time interval (30 minutes before the ‚Äúcurrent‚Äù frame time - the ‚Äúcurrent‚Äù frame time). <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">start</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt;- '<span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>' finish.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt;- '<span class="hljs-number"><span class="hljs-number">2013</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>' seconds.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.frame &lt;- <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt;- strptime(<span class="hljs-built_in"><span class="hljs-built_in">start</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>='<span class="hljs-variable"><span class="hljs-variable">%Y-%</span></span>m-%d <span class="hljs-variable"><span class="hljs-variable">%H:%</span></span>M:%S') finish.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt;- strptime(finish.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>='<span class="hljs-variable"><span class="hljs-variable">%Y-%</span></span>m-%d <span class="hljs-variable"><span class="hljs-variable">%H:%</span></span>M:%S') frames &lt;- as.numeric(difftime(finish.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">start</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, units='secs'))/seconds.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.frame <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:frames){ frame.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;- <span class="hljs-built_in"><span class="hljs-built_in">start</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + i*seconds.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.frame frame.twits &lt;- subset(twits, Timestamp &lt;= frame.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &amp; Timestamp &gt; frame.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - ma.period) ...</code> </pre><br>  Next, we make the ‚Äúlatitude - longitude‚Äù contingency table (recall that the values ‚Äã‚Äãof latitude and longitude were previously converted from continuous to discrete by rounding to one-tenth).  And we ‚Äúexpand‚Äù the contingency table in the dataframe of 3 columns: latitude, longitude, frequency (number of tweets at a given point).  We remove the lines in which the frequency is zero or the coordinates are outside the established limits. <br><pre> <code class="hljs php"> ... frame.twits &lt;- melt(table(frame.twits$Latitude, frame.twits$Longitude)) colnames(frame.twits) &lt;- c(<span class="hljs-string"><span class="hljs-string">'Lat'</span></span>, <span class="hljs-string"><span class="hljs-string">'Long'</span></span>, <span class="hljs-string"><span class="hljs-string">'Volume'</span></span>) frame.twits$Lat &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(frame.twits$Lat)) frame.twits$Long &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(frame.twits$Long)) frame.twits &lt;- frame.twits[frame.twits$Volume&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> &amp; frame.twits$Long&gt;=<span class="hljs-number"><span class="hljs-number">-25</span></span> &amp; frame.twits$Long&lt;=<span class="hljs-number"><span class="hljs-number">190</span></span> &amp; frame.twits$Lat&gt;=<span class="hljs-number"><span class="hljs-number">25</span></span> &amp; frame.twits$Lat&lt;=<span class="hljs-number"><span class="hljs-number">85</span></span>,] ...</code> </pre><br>  The transformation of latitude and longitude into numerical variables is necessary because after the ‚Äúfolding-unfolding‚Äù of the data, they are converted into categorical (factor in the terminology of R). <br>  It remains to calculate the colors of the points.  To do this, the maximum possible volume of tweets at one point for the whole future ‚Äúmovie‚Äù is calculated in the preliminary cycle.  It takes the maximum ( <code>max.color</code> ), and colors for all other points are calculated relative to it (logarithm - to ‚Äúalign‚Äù the scale): <br><pre> <code class="hljs mel"> ... frame.colors &lt;- round(<span class="hljs-number"><span class="hljs-number">1</span></span> + (<span class="hljs-number"><span class="hljs-number">8</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>(frame.twits$Volume)/<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">color</span></span>), digits=<span class="hljs-number"><span class="hljs-number">0</span></span>) ...</code> </pre><br>  Now you can draw points (if any): <br><pre> <code class="hljs mel"> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(nrow(frame.twits)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>){ p &lt;- p + geom_point(aes(frame.twits$Long,frame.twits$Lat, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>=frame.twits$Volume * <span class="hljs-number"><span class="hljs-number">5</span></span>), colour=twits.colors[frame.colors], alpha = <span class="hljs-number"><span class="hljs-number">.75</span></span>) } ...</code> </pre><br>  It seems to be all, you can save the image and close the loop, but for the next "animate the picture" I decided to add some real messages to the frame.  To do this, I randomly selected dozens of tweets from the general array, collected message texts for them and created another dataframe - publication time, tweet text, ‚Äúlifetime‚Äù, ‚Äúappearance time‚Äù, ‚Äúextinction time‚Äù, color, coordinates, size and transparency .  The lifetime, coordinates, color and size are generated when the script is initialized with random deviations from the ‚Äúoptimal‚Äù values: <br><pre> <code class="hljs django"><span class="xml"><span class="xml">twit.texts$x </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rnorm</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nrow</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">twit.texts</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mean</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">100,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sd</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">30)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">twit.texts</span></span></span></span><span class="xml"><span class="hljs-tag">$</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rnorm</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nrow</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">twit.texts</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mean</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">56,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sd</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">15)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">twit.texts</span></span></span></span><span class="xml"><span class="hljs-tag">$</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rnorm</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nrow</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">twit.texts</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mean</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">10,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sd</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">2)</span></span></span></span></span></span></code> </pre><br>  Output to the frame is controlled using transparency: if the ‚Äúcurrent‚Äù frame time does not fit into the ‚Äúlifetime‚Äù of a tweet, its ‚Äúopacity‚Äù is zero.  If the current tweet "exists" - its opacity is calculated depending on the proximity to the center of the life period.  It turns out that the tweet "appears" and smoothly disappears.  In code, it looks like this: <br><pre> <code class="hljs php"> ... twit.texts$opacity &lt;- <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(by(twit.texts, <span class="hljs-number"><span class="hljs-number">1</span></span>:nrow(twit.texts), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(row)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(frame.time &lt; row$t.start | frame.time &gt; row$t.end){ row$opacity &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { row$opacity &lt;- <span class="hljs-number"><span class="hljs-number">0.7</span></span> * (<span class="hljs-number"><span class="hljs-number">1</span></span> - (abs(<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric(difftime(row$Timestamp, frame.time, unit=<span class="hljs-string"><span class="hljs-string">'sec'</span></span>))) / (row$t.delta * seconds.in.frame / <span class="hljs-number"><span class="hljs-number">2</span></span>))) } })) p &lt;- p + geom_text(aes(x=twit.texts$x, y=twit.texts$y, label=iconv(twit.texts$Text,to=<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)), colour=twit.texts$color, size=twit.texts$size, alpha = twit.texts$opacity) ...</code> </pre><br>  The output is organized using geom_text. <br>  Now that's it.  You can save the frame and close the loop. <br><pre> <code class="hljs mel"> ... f.name &lt;- as.<span class="hljs-keyword"><span class="hljs-keyword">character</span></span>(i) repeat{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(nchar(f.name) &lt; nchar(as.<span class="hljs-keyword"><span class="hljs-keyword">character</span></span>(frames))){ f.name &lt;- paste(<span class="hljs-string"><span class="hljs-string">'0'</span></span>, f.name, sep=<span class="hljs-string"><span class="hljs-string">''</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> }} ggsave(p, <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=paste(<span class="hljs-string"><span class="hljs-string">'frames/img'</span></span>, f.name, <span class="hljs-string"><span class="hljs-string">'.png'</span></span>, sep=<span class="hljs-string"><span class="hljs-string">''</span></span>), width=<span class="hljs-number"><span class="hljs-number">6.4</span></span>, height=<span class="hljs-number"><span class="hljs-number">3.6</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">scale</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, dpi=<span class="hljs-number"><span class="hljs-number">100</span></span>) }</code> </pre><br>  The length of f.name "zeros" is adjusted so that all names "fit" under one mask by the number of characters. <br><br><h4>  We collect video </h4><br>  To build the final video, <a href="http://ffmpeg.org/">ffmpeg was</a> used: <br> <code>ffmpeg -f image2 -i img%04d.png -q:v 0 -vcodec mpeg4 -r 24 happynewyear.mp4</code> <br>  However, not all so simple.  The video is not fully assembled - the .png files received from ggplot2 have different color depths.  Perhaps this problem could be solved in some more correct way, but I used the <a href="http://www.pythonware.com/products/pil/">Python Imaging Library</a> : <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image path = <span class="hljs-string"><span class="hljs-string">u'/path/to/frames/'</span></span> dirList=os.listdir(path) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> filename <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dirList: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> filename[<span class="hljs-number"><span class="hljs-number">-3</span></span>:] == <span class="hljs-string"><span class="hljs-string">'png'</span></span>: im = Image.open(path + filename).convert(<span class="hljs-string"><span class="hljs-string">'RGB'</span></span>) im.save(path + filename)</code> </pre><br>  Now all frames are collected in one video.  The video is ready, you can upload to YouTube.  Add a couple of YouTube-effects (because if the gun hangs on the wall, you need to shoot from time to time). <br>  The final: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/zktB5F4dtiM%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700190,15700253&amp;usg=ALkJrhh_FlyTOOG71hQOZVKZYgfw-SQiJQ" frameborder="0" allowfullscreen=""></iframe><br>  In this text I have described not all parts of the R-script, but some of the quotes from the code are arranged according to the principle of the problem being solved, and not according to the logic of the work.  Therefore, in the application I post a link to the full code with a small number of comments: <a href="http://pastebin.com/eWRwtE9J">pastebin.com</a> <br><br><h4>  Possible options for development </h4><br><ol><li>  Add date because  The 12-hour dial is not too informative when you need to visualize the time interval of several days. </li><li>  Add a strip with a histogram or something like a probability density graph for the total amount of data at each time point. </li></ol><br><br><h4>  Questions to the community </h4><br><ol><li>  Is there a library for R comparable in simplicity to maps, but with more relevant information on modern geopolitics?  Without USSR, Yugoslavia and Czechoslovakia? </li><li>  How can you try to optimize the calculation of the colors of the palette of dots so as not to ‚Äúrun‚Äù the entire cycle ‚Äúidle‚Äù beforehand? </li><li>  Is it possible to "overcome" ggplot2 or ffmpeg, so that additional frame color conversion is not required (exclude PIL from the process)? </li><li>  And in general - I will listen to other indications of my own humanitarian curvature and optimization possibilities. </li></ol><br>  Thank! <br><br><h4>  useful links </h4><br><ol><li>  <a href="https://uchicagoconsulting.wordpress.com/tag/r-ggplot2-maps-visualization/">How to draw good looking maps in R</a> - using maps and ggplot2 to draw maps; </li><li>  <a href="http://www.drewconway.com/zia/%3Fp%3D2800">Create an animated clock in R with ggplot2 (and ffmpeg)</a> - animated analog clock on R; </li><li>  <a href="http://rpsychologist.com/parsing-data-from-a-text-file-and-plotting-where-people-live-using-ggplot2-and-openstreetmaps/">Simple data mining and plotting data on a map with ggplot2</a> - using OSM maps in R. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/165305/">https://habr.com/ru/post/165305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165293/index.html">VM Depot launched - a repository of virtual machine images on Linux for the Windows Azure community</a></li>
<li><a href="../165295/index.html">Catalana numbers</a></li>
<li><a href="../165297/index.html">Writing a bot for the game of Balls 2.0</a></li>
<li><a href="../165299/index.html">Method for constructing readable texts</a></li>
<li><a href="../165301/index.html">Who is a manager</a></li>
<li><a href="../165307/index.html">Rational use of HP Blade servers</a></li>
<li><a href="../165309/index.html">How we write weekly reports for clients</a></li>
<li><a href="../165311/index.html">Samsung has introduced a working device with a flexible display.</a></li>
<li><a href="../165313/index.html">Registration on the portal of public services: simple step by step instructions</a></li>
<li><a href="../165317/index.html">Safe "ctrl + v" in the terminal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>