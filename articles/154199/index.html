<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mail.Ru Mail for WP7: development, close-up</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, the Mail application started under WP7. When we thought about whether we needed a standalone application for Windows Phone, or just a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mail.Ru Mail for WP7: development, close-up</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/498/848/a88/498848a88cdf27d38cc028da628be70e.png" alt="image" width="240" height="400" align="right"><br>  Not so long ago, the Mail application started under WP7.  When we thought about whether we needed a standalone application for Windows Phone, or just adapting Mail.Ru for IE Mobile and its analogs, the question was quickly resolved.  The owners of smartphones on WP7 should have their own full-fledged Mail application, fully adapted to the platform. <br><br>  About what requirements we made to the application, what problems we faced and how we solved them, we will tell under the cut. <br><br><a name="habracut"></a><br><h5>  Concept </h5><br>  We immediately decided that, first of all, an application should quickly process large amounts of data and ensure high speed even when loading large lists (for example, a list of incoming emails).  In some aspects, the application should resemble the built-in mail client so that there is no discomfort when working with it.  At the same time, the application should have advanced features that distinguish it from the embedded client. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <table><tbody><tr><td><img src="https://habrastorage.org/storage2/51b/9e0/18d/51b9e018d3e8d9e8a521ed0af9fa5b13.png"></td><td><img src="https://habrastorage.org/storage2/043/244/06d/04324406dbb4b2f7f4b356c0c8d539c2.png"></td><td><img src="https://habrastorage.org/storage2/0fd/a9c/fab/0fda9cfab593f916ddac0a4fb5d29b26.png"></td></tr></tbody></table><br><br>  In particular, it focuses on the management of gestures using all the capabilities of the touch interface.  Switching between folders and moving from letter to letter with one finger movement is both convenient and consistent with the spirit of the platform.  Another feature is instantaneous synchronization with webmail.  All user actions in the application are immediately displayed in the web interface;  all new letters are immediately visible in the application. <br><br>  Everyone who developed applications for WP7 knows that development within the framework of standard controls is done once or twice;  moving them one step left or right increases the time required to complete the task. <br><br>  So, in order of what difficulties we faced. <br><br><h5>  Switch between folders </h5><br><br>  To switch between folders, it was decided to use the Pivot control.  Everything is simple - page switching, each page is loaded on demand. <br><br>  For a ‚Äústandard user‚Äù everything works fine - after registering in the mailbox there are only 5 folders, the application loads quickly.  But some users of folders can have a lot (and a lot). <br><br>  For testing, user folders were added to the live mailbox (there were 40 in total).  In such a situation, the launch of the application from the moment of tap on the tile on the start screen to display the incoming list took almost 30 seconds.  This result did not suit us. <br><br>  A detailed study of performance problems revealed that the bottleneck was the ObservableCollection container, which kept the list of folders.  After the container received data about the folders, the list was loaded one by one.  Multiple addition of ObservableCollection does not support.  And when you add each new element is rebuilt UI.  For Pivot, this turned out to be unacceptable.  Yes, Microsoft writes in the recommendations: ‚ÄúMinimize the number of control pages when it‚Äôs possible,‚Äù but overwhelmed the desire to make the switch gestures.  As a solution, the inherited class SilentObservableCollection was derived, which added three methods AddSilently, InsertSilently and RemoveSilently, as well as the Notify method.  As the name suggests, the first three methods allow you to rebuild the list without rebuilding the UI with each change.  The latter method allows you to change the UI after the folder list is updated. <br><br><table><tbody><tr><td><img src="https://habrastorage.org/storage2/10e/ce5/f5e/10ece5f5e83fb9c5e6e659e86299a02c.png"></td><td><img src="https://habrastorage.org/storage2/b16/3cf/88c/b163cf88c4309f3fd698c84fd4f052a8.png"></td><td><img src="https://habrastorage.org/storage2/9c8/72d/3d0/9c872d3d05d41c6bc62467ce7b2f3b4b.png"></td></tr></tbody></table><br><br><h5>  Switch between letters </h5><br><br>  Then it was necessary to make switching between letters on the svaypu.  Initially, for this task, as in the case of the list of folders, the Pivot element was used.  A number of problems arose with him. <br><br>  First, it immediately creates all the pages under the letters (although the letters themselves are loaded as you move to them), which again takes a lot of time to open the reading page. <br>  The list of letters for Pivot is a list of loaded headers.  If you move down this list, then blocks of 20 letters are loaded to the existing list.  If you move far enough, opening a letter can take several minutes while Pivot builds pages for each letter. <br><br>  Secondly, the Pivot is looped.  And, unlike Panorama, where by the background offset you can roughly understand which page you are on, in Pivot the transition from the last page to the first page is no different from the transition to the next page.  This was very misleading in the case of the list of letters.  It was unclear where the first letter was, in which direction to flip through to see the following, why, after some letter, you again get to the first. <br><br>  To overcome all these problems, a control was written under the name LongListPivot.  It resolves both the problems described.  It is not looped, that is, the transition from the first letter to the last does not occur.  And there is only one page.  Data change on this page occurs at the moment when it is behind the screen.  After moving the finger, the current letter leaves the screen, is replaced by the next one, which comes from the other side of the screen.  Plus, when approaching the last letter in the list, as well as in the case of the list of letters in the folder, the next block of 20 letters is loaded. <br><br><h5>  View letters </h5><br><br>  The next task, the solution of which took the most time, was to view letters with html-markup. <br><br>  It seems, everything is simple: there is an element of WebBrowser.  Place it on the page, load the text into it - and you're done.  But there are scenarios for using the application when the application of this element is impossible.  For example, if there are many recipients, and the user opens the entire list.  Or if the letter has several attachments.  All this leads to the fact that the cap of the letter is stretched, and the content slides to the bottom of the screen.  As a result of this, as well as the fact that WebBrowser has its own internal scrolling of content, we find that the letter scrolls inside a small area. <br><br>  We considered this solution: to determine the height of the letter and rigidly specify the height for WebBrowser, to exclude its internal scrolling, and fit it into the general flow of elements inside the ScrollViewer.  But, first, in WP7, one control cannot be more than 2048 pixels wide or high (which is only 2.5 of the screen height).  Secondly, there is no way to determine the height of the contents of the letter. <br><br>  WebBrowser does not provide information about the page loaded into it, nor does it offer program interfaces to control the display of content (scrolling, width and scale).  The only thing left for the programmer is to send commands to JavaScript using InvokeScript and receive notifications via the ScriptNotify event. <br><br>  Further development of the letter reading page moved to a new level - to CSS + JavaScript.  Thanks to our colleagues from mobile webmail, we managed to solve all the problems that were in the way: how to set the letter width, scale, scrolling. <br><br><h5>  Links in letters </h5><br><br>  Another of the tasks was the processing of links.  Links should not open inside the embedded element WebBrowser, displaying the text of the letter, and in the system browser.  For this interception click on the element WebBrowser.  Further, through JavaScript, the html layout element was determined, which is at the touch position, it was checked whether this element is a link, and, if so, the address was opened in an external browser. <br><br>  The problem was with letters from one of the aggregators of discount services.  The source code of notifications from it in html is about 300-500 Kb.  When attempting to display such a letter, the program terminated with an out of memory error.  In the end, it was decided to display all letters with html markup and more than 100 KB in the adapted text form. <br><br><h5>  Work with attachments </h5><br><br>  One of the features of the Windows Phone platform is an isolated data store.  There are problems in working with attachments.  The mail program fully works with images from the gallery attached to the letter, as well as with pictures taken using the camera of the smartphone.  In the Mail application, you can view the images attached to your inbox and, if you wish, save them to the gallery.  The program can also play the video and audio files sent. <br><br>  With the MS Office and Adobe Reader documents the situation is as follows: the program generates a link to download these attachments and sends them to an external browser.  The browser, saving the attachment, sends it to Office or to Adobe Reader.  The attached file remains in these programs.  However, if you try to open it again from the Mail application, the path will have to be repeated: a link will be formed, the attachment will be downloaded by an external browser and open in the appropriate program. <br><br><table><tbody><tr><td><img src="https://habrastorage.org/storage2/72c/774/c94/72c774c942bb824de8099dd7e95c3fd3.png"></td><td><img src="https://habrastorage.org/storage2/095/efc/73b/095efc73bb4c1e1c0ff0b2583b818824.png"></td><td><img src="https://habrastorage.org/storage2/1d3/d90/d80/1d3d90d80b7c21269edc02d2c17a939a.png"></td></tr></tbody></table><br><br><h5>  Testing </h5><br><br>  We should also talk about testing.  Testing WP-applications is associated with several difficulties due to the characteristics of the devices themselves.  For example, while it is impossible to maintain and display the logs of the testing process and take screenshots of the screen directly from the device. <br><br>  Despite the fact that we published 5 beta builds of the application, none of them was given to users.  From the moment of publication of the assembly to the moment when it becomes available for download, it takes three days.  During this time, most build errors are detected by our tester, corrected, and the beta version becomes obsolete.  To organize the testing, 4 development accounts were established, with the help of which 12 devices were unlocked.  Periodically, at the end of the next development stage, the latest, up-to-date version was installed on most devices and feedback, comments and complaints were collected. <br><br>  Otherwise, thanks to the clear requirements of Microsoft to manufacturers of devices running Windows Phone, the application, with rare exceptions, works the same on different models of smartphones (there is no such fragmentation as among devices running Android). <br><br><h5>  Conclusion </h5><br><br>  We hope that this information was useful to you.  We would also be very interested to read about the experiences of other developers under WP: if you have already encountered similar tasks and decided on them differently, tell us about it in the comments. <br><br>  We, in turn, continue to work on improving the application.  Comments and suggestions you can send to us at <a href="">mailapps@corp.mail.ru</a> .  Download Mail.Ru Mail for Windows Phone 7 can be in the <a href="http://www.windowsphone.com/ru-ru/store/app/%25D0%25BF%25D0%25BE%25D1%2587%25D1%2582%25D0%25B0/f18d0050-619b-43d8-875e-d7fe9b078b56/">Windows Phone Store</a> . <br><br>  Balashov Vadim, mobile application developer <br>  Mail.Ru <br><br></div><p>Source: <a href="https://habr.com/ru/post/154199/">https://habr.com/ru/post/154199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154187/index.html">C / C ++ web application with FastCGI - it‚Äôs just</a></li>
<li><a href="../154189/index.html">Published free e-books on Windows Azure technology from the Patterns & Practices team</a></li>
<li><a href="../154191/index.html">DBSlayer proxy on BASH in 5 minutes or another way to send JSON from MySQL</a></li>
<li><a href="../154193/index.html">Recognition of custom gestures</a></li>
<li><a href="../154197/index.html">Call Manager & Skype connect via CUBE</a></li>
<li><a href="../154203/index.html">Office supplies that may disappear in the future</a></li>
<li><a href="../154205/index.html">NetApp: Compatibility Matrix</a></li>
<li><a href="../154207/index.html">Microsoft creates a prototype wearable manipulator in 3D space</a></li>
<li><a href="../154209/index.html">IOS development techniques used by me in the Pictograph contest</a></li>
<li><a href="../154211/index.html">CSS internal shadows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>