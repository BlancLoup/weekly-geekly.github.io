<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LinOTP + RADIUS. Authentication with one-time passwords</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Basic information 
 This tutorial describes the process of integrating LinOTP and FreeRadius on machines running CentOS and setting up SSH user aut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LinOTP + RADIUS. Authentication with one-time passwords</h1><div class="post__text post__text-html js-mediator-article"><h2>  1. Basic information </h2><br>  This tutorial describes the process of integrating LinOTP and FreeRadius on machines running CentOS and setting up SSH user authentication using the OTP generated using Google Authenticator software (or anyone using a similar algorithm). <br><a name="habracut"></a><br><h2>  2. Baseline </h2><br>  This instruction implies that we have three machines running CentOS 6.7.  They are on the same subnet and network connectivity is configured between them.  The names and addresses of the machines are shown in the table below. <br><br><pre>  Hostname IP Address Reference Name Operating System
 linotp 10.1.0.114 LinOTP CentOS 6.7 Server
 radius-p 10.1.0.122 RADIUS CentOS 6.7 Server
 client 10.1.0.113 CentOS 6.7 Client
 admin-PC 10.1.0.120 Workstation (AWP) Windows 7 </pre><br><br>  Linotp software is deployed on the LinOTP server according to the instructions from the official website ( <a href="http://linotp.org/doc/2.6/part-installation/server-installation/pip_install.html">document ‚ÄúLinOTP Server Installation‚Äù</a> ).  Software version linotp 2.7.2. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the RADIUS server, the freeradius server is deployed.  I will not describe the package installation in detail, because  it is executed trivially with the help of the yum manager.  A complete list of packages required for installation is given below: <br><br><ul><li>  freeradius-2.2.6-6.el6_7.i686; </li><li>  freeradius-perl-2.2.6-6.el6_7.i686; </li><li>  perl-devel-5.10.1-141.el6.i686; </li><li>  perl-Pod-Escapes-1.04-141.el6.i686; </li><li>  perl-version-0.77-141.el6.i686; </li><li>  perl-Test-Harness-3.17-141.el6.i686; </li><li>  perl-ExtUtils-ParseXS-2.2003.0-141.el6.i686; </li><li>  perl-Digest-SHA-5.47-141.el6.i686; </li><li>  perl-libs-5.10.1-141.el6.i686; </li><li>  perl-Module-Pluggable-3.90-141.el6.i686; </li><li>  perl-5.10.1-141.el6.i686; </li><li>  perl-ExtUtils-MakeMaker-6.55-141.el6.i686; </li><li>  perl-DBI-1.609-4.el6.i686; </li><li>  perl-CPAN-1.9402-141.el6.i686; </li><li>  perl-pod-simple-3.13-141.el6.i686. </li></ul><br>  Machine Client is a RADIUS client on which OTP authentication will take place.  To support RADIUS authentication, the pam_radius-1.3.17-2.el5 package is installed on the machine. <br>  The Windows-based workstation machine simulates an administrator's workstation that will access the client‚Äôs machine via SSH using the OTP.  This machine is Windows 7, put the SSH client and GAUTH software - the OTP generator. <br><br><h2>  3. What we get in the end </h2><br>  The purpose of this work is to configure authentication on the Client via the RADIUS server using the OTP (generated on the LinOTP Server). <br><br>  The RADIUS server in this configuration does not store user accounts in its database ‚Äî this task is entrusted to the LinOTP Server.  The RADIUS server stores the NAS database, i.e.  list of servers and network equipment, the users of which it authenticates.  This configuration uses the text configuration file /etc/raddb/clients.conf for this. <br><br>  The LinOTP server in this configuration is used to manage user tokens.  Information about users and their tokens is stored in a MySQL database, also deployed on the LinOTP server.  The linotp software itself does not have the functionality to control the KNS of users, thus it is necessary to add users and their data to the MySQL table manually. <br><br><h2>  4. Configuration steps </h2><br><h3>  4.1.  RADIUS Configuration Procedure </h3><br>  The settings described in this section are made on the RADIUS server, i.e.  by car radius-p. <br><h3>  4.1.1.  Installing Perl Plugins </h3><br><br><pre><code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">perl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-MCPAN</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">shell</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpan</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LWP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpan</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LWP</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:UserAgent</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpan</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LWP</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:UserAgent</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Determined</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpan</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LWP</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Protocol</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::https</span></span></code> </pre> <br>  Some of the installed modules may give the following error when installing: <br><br><pre>  Running make install
   make test had returned bad status
 Failed during this command:
  MSCHILLI / LWP-Protocol-https-6.06.tar.gz: make_test NO </pre><br><br>  In this case, you should use the force install command, for example: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">cpan</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">force</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LWP</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Protocol</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::https</span></span></code> </pre><br>  A successful installation will be indicated by a message of the form: <br><br><pre>  Failed during this command:
  MSCHILLI / LWP-Protocol-https-6.06.tar.gz: 'make_test FAILED but not ignored because' force 'in effect </pre><br><h3>  4.1.2.  Radius Setup </h3><br>  Add the NAS client radius in the /etc/raddb/clients.conf file.  In our case it is: <br><br><pre>  client 10.1.0.113 {
         secret = testing123
         shortname = client
 } </pre><br><br>  Add the line to / etc / raddb / users <br><pre>  DEFAULT Auth-type: = perl </pre><br>  <i>*** However, this is not the best option.</i>  <i>In this case, you force the authentication type, which makes it impossible for radius to simultaneously authenticate users to the users who are authenticated via linOTP, for example, their accounts are stored in mysql (and the corresponding settings are made in RADIUS).</i> <i><br></i>  <i>I am in practice, just faced with this situation.</i>  <i>In this case, this directive (DEFAULT Auth-type: = perl) is not necessary to register, but instead added a condition to the / etc / raddb / sites-enabled / default file in the authorize section:</i> <i><br></i> <pre>  <i>if (Sql-Group == sql) {pap}</i> <i>
         </i>  <i>else {update control {</i> <i>
                                </i>  <i>Auth-Type: = perl</i> <i>
                                </i>  <i>}</i> <i>
                </i>  <i>}</i> </pre> <i><br></i>  <i>This condition (written in the unlang language built in radius) includes the ‚Äúperl‚Äù authentication type only for users who are not members of the user group authenticated through sql.</i> <i><br></i> <br><br>  In the / etc / freeradius / modules / perl file, modify the following directive: <br><br><pre>  perl {
          module = &lt;linotp_radius.pm file path&gt; </pre><br><br>  In the / etc / freeradius / sites-enabled / default file, modify the ‚Äúauthenticate‚Äù section as follows: <br><br><pre>  authenticate {
 perl </pre><br><br><h3>  4.1.3.  Creating file - connector linotp_radius.pm </h3><br>  Create a file linotp_radius.pm with the following content: <br><br><pre> <code class="hljs rust">#________START______ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> strict; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> LWP; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> LWP::UserAgent::Determined; # <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ... # This is very important ! Without this script will not get the filled hashesh from main. <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> vars qw(%RAD_REQUEST %RAD_REPLY %RAD_CHECK $URL); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Data::Dumper; $ENV{<span class="hljs-symbol"><span class="hljs-symbol">'PERL_LWP_SSL_VERIFY_HOSTNAME</span></span>'} = <span class="hljs-number"><span class="hljs-number">0</span></span>; $URL = <span class="hljs-string"><span class="hljs-string">"https://&lt;IP   LinOTP&gt;/validate/simplecheck"</span></span>; # This is hash wich hold original request from radius #my %RAD_REQUEST; # In this hash you add values that will <span class="hljs-keyword"><span class="hljs-keyword">be</span></span> returned to NAS. #my %RAD_REPLY; #This is <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> check items #my %RAD_CHECK; # # This the remapping of <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values # <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_REJECT=&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* immediately reject the request */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_FAIL=&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* module failed, don't reply */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_OK=&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* the module is OK, continue */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_HANDLED=&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* the module handled the request, so stop. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_INVALID=&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* the module considers the request invalid. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_USERLOCK=&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* reject the request (user is locked out) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_NOTFOUND=&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* user not found */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_NOOP=&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* module succeeded without doing anything */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_UPDATED=&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* OK (pairs modified) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> constant RLM_MODULE_NUMCODES=&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>;# <span class="hljs-comment"><span class="hljs-comment">/* How many return codes there are */</span></span> # Function to handle authorize sub authorize { # For debugging purposes only # &amp;log_request_attributes; # Here<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> your authorization code comes # You can call another function from here: &amp;test_call; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle authenticate sub authenticate { # For debugging purposes only # &amp;log_request_attributes; my $ua = LWP::UserAgent-&gt;new(); my $req = HTTP::Request-&gt;new(GET =&gt; $URL . <span class="hljs-string"><span class="hljs-string">"?user="</span></span> . $RAD_REQUEST{<span class="hljs-symbol"><span class="hljs-symbol">'User</span></span>-Name'} . <span class="hljs-string"><span class="hljs-string">"&amp;pass="</span></span> . $RAD_REQUEST{<span class="hljs-symbol"><span class="hljs-symbol">'User</span></span>-Password'} ); my $response = $ua-&gt;request( $req ); die <span class="hljs-string"><span class="hljs-string">"Error at $URL\n "</span></span>, $response-&gt;status_line, <span class="hljs-string"><span class="hljs-string">"\n Aborting"</span></span> unless $response-&gt;is_success; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($response-&gt;content =~ m/:\-\)/i) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $RAD_REPLY{<span class="hljs-symbol"><span class="hljs-symbol">'Reply</span></span>-Message'} = <span class="hljs-string"><span class="hljs-string">"LinOTP server denied access!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_REJECT; } } # Function to handle preacct sub preacct { # For debugging purposes only # &amp;log_request_attributes; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle accounting sub accounting { # For debugging purposes only # &amp;log_request_attributes; # You can call another subroutine from here &amp;test_call; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle checksimul sub checksimul { # For debugging purposes only # &amp;log_request_attributes; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle pre_proxy sub pre_proxy { # For debugging purposes only # &amp;log_request_attributes; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle post_proxy sub post_proxy { # For debugging purposes only # &amp;log_request_attributes; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle post_auth sub post_auth { # For debugging purposes only # &amp;log_request_attributes; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RLM_MODULE_OK; } # Function to handle xlat sub xlat { # For debugging purposes only # &amp;log_request_attributes; # Loads some external perl and evaluate it my ($filename,$a,$b,$c,$d) = @_; &amp;radiusd::radlog(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"From xlat $filename "</span></span>); &amp;radiusd::radlog(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"From xlat $a $b $c $d "</span></span>); local *FH; open FH, $filename or die <span class="hljs-string"><span class="hljs-string">"open '$filename' $!"</span></span>; local($/) = undef; my $sub = &lt;FH&gt;; close FH; my $eval = qq{ sub handler{ $sub;} }; eval $eval; eval {main-&gt;handler;}; } # Function to handle detach sub detach { # For debugging purposes only # &amp;log_request_attributes; # Do some logging. &amp;radiusd::radlog(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"rlm_perl::Detaching. Reloading. Done."</span></span>); } # # <span class="hljs-literal"><span class="hljs-literal">Some</span></span> functions that can <span class="hljs-keyword"><span class="hljs-keyword">be</span></span> called from other functions # sub test_call { # <span class="hljs-literal"><span class="hljs-literal">Some</span></span> code goes here } sub log_request_attributes { # This shouldn<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">be</span></span> done <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> production environments! # This is only meant <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> debugging! <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (keys %RAD_REQUEST) { &amp;radiusd::radlog(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"RAD_REQUEST: $_ = $RAD_REQUEST{$_}"</span></span>); } } <span class="hljs-number"><span class="hljs-number">1</span></span>; #___________END</code> </pre><br>  This file was placed in the / etc / raddb / folder, but you can place it in another place, the main thing to remember is that the path to this file must be specified in / etc / freeradius / modules / perl (mentioned above). <br><br>  At this stage, the radius should start successfully with the / usr / sbin / radiusd ‚ÄìX command and, when trying to connect to the Radius Client, send a request to the LinOTP server.  This can be verified by connecting to the client via ssh and simultaneously listening to traffic on the LinOTP server using TCPDUMP.  You should see packets on port 443 TCP. <br><br><h3>  4.2.  LinOTP setup procedure </h3><br>  LinOTP was configured according to the official developer documentation ( <a href="https://www.linotp.org/doc/latest/part-management/quickstart.html">see LinOTP document - QuickStart Guide</a> ). <br><br>  LinOTP by itself does not have the functionality to create users, it can only read information about UZ (accounts) of users from LDAP, MySQL or text files.  This instruction implies that we use MySQL deployed on the same server as LinOTP as the base for UZ. <br><br><h3>  4.2.1.  Formation of the base of user UZ </h3><br>  When creating a useridresolver (this is just an indication, a kind of ‚Äúconnector‚Äù to the UZ database, from which LinOTP will take user data), during initial initialization of the LinOTP server, you must specify the ‚Äúpassword‚Äù field in the SQL table mapping with user data.  This password is only needed for user access to the self service portal.  If we do not plan to use this portal, then this can be not done. <br><br>  If this was not done at the initialization stage, then it can be added later.  column to table.  Example: <br>  ALTER TABLE usertable ADD password VARCHAR (200); <br><br>  Next, generate a password hash for the user with the command: <br><br><pre> <code class="hljs sql">/opt/LINOTP/bin/linotp-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-sqlidresolver-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> -u &lt; &gt; -i &lt;  <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>  &gt; -p &lt; &gt;</code> </pre> <br><br>  At the output we get a string of the form: <br><br><pre>  user7; 2; {SSHA512} 3QWyB5u2TkPLDc2mjIJxtcCLOVHSjLS / MyYjPGNIENchm5riFHF3M9CW7csaxADAFml8WkH / Whd1A047nUAaeWk2dFZod1ZhYzN3cTRNUkpRdlhrLmVsdFVSeUNIaUdWVEZVT1ZycW5BSlVXajVHbHVvckhHSmNYOWp5M3FQLi8 =; </pre><br><br>  All that is highlighted in yellow is the resulting password hash.  Next, add it to the appropriate field in the table: <br><br><pre>  update usertable set password = &lt;hash obtained using&gt; where user = 'user7'; </pre><br>  In my example, the useridresolver configuration looks like this: <br><br><img src="https://habrastorage.org/files/776/2ef/e8f/7762efe8f97d4bd6b86b014505253d2f.jpg"><br>  <i>Figure 1 - Sample useridresolver configuration</i> <br><br>  Particular attention should be paid to the field "Attribute mapping", which is not fully visible in the figure.  Here are its contents: <br><br><pre>  {"userid": "id", "username": "user", "email": "mail", "surname": "sn", "givenname": "givenName", "password": "password"} </pre><br>  And below is the MySQL table (located on the LinOTP server) in which the users' KNOs are stored and with which the mapping is configured: <br><br><pre>  mysql&gt; select * from usertable;
 + ---- + ------- + ------------------------ + -------- + - --------- + ----------- +
 |  id |  user |  mail |  sn |  givenName | password |
 + ---- + ------- + ------------------------ + -------- + - --------- + ----------- +
 |  1 |  user6 |  user6@localdomain.mail |  ivan |  petrov | &lt;hash&gt; |
 |  2 |  user7 |  user7@localdomain.mail |  sergey |  fedorov | &lt;hash&gt; |
 + ---- + ------- + ------------------------ + -------- + - --------- + ----------- + </pre><br><br>  I suppose additional comments are unnecessary.  The ‚Äúuserid‚Äù field in the useridresolver is mapped in the ‚Äúid‚Äù field in the MySQL database.  The ‚Äúusername‚Äù field in the useridresolver is in the ‚Äúuser‚Äù field in the MySQL database, etc. <br>  And so, in the end, what we see in the LinOTP interface is to go to the ‚ÄúUser view‚Äù tab: <br><br><img src="https://habrastorage.org/files/71b/b7f/516/71bb7f516d404cf195050842026c0421.jpg"><br>  <i>Figure 2 - Displaying users in the LinOTP interface</i> <br><br><h3>  4.2.2.  LinOTP policy setup </h3><br>  Policies are a key element of LinOTP and allow flexible configuration of authentication options, types and restrictions on the number of tokens, etc. <br><br>  To demonstrate LinOTP operation, the following set of policies will suffice: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6d/b89/4ef/f6db894efe17b791e475c580a68cf336.jpg" alt="image"><br>  <i>Figure 3 - Token Assignment Policies</i> <br><br>  This policy determines the maximum number of tokens that can be issued for a user - the ‚Äúmaxtoken‚Äù parameter. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6d/132/88f/f6d13288f14d0caefb00dbd03610a6ef.jpg" alt="image"><br>  <i>Figure 4 - Self-Service Portal Policies</i> <br><br>  This policy regulates the types of tokens and operations on them that users can independently perform through the self-service portal. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c7b/0ef/000/c7b0ef000f8cfa26b52ff9604c7e0dac.jpg" alt="image"><br>  <i>Figure 5 - System Policies</i> <br><br>  Required permission to read and modify system settings by the administrator (it makes sense to set additional settings in scope = system to restrict administrators). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/20d/515/e9d/20d515e9d822affa8bc213958adfdf56.jpg" alt="image"><br>  <i>Figure 6 - Authentication Policies</i> <br><br>  This policy requires entering OTP-PIN and OTP when authenticating to the target system (Client).  Parameter otppin = 0 is responsible for this.  When it is set to 2, authentication will be performed only via OTP.  If you set it to ‚Äú1‚Äù, authentication will be performed using the combination User Password + OTP (the password is the same as for access to the self-service portal). <br><br>  Example: parameter otppin = 0;  user3 has a token with OTP-PIN = 123456 and generated OTP = 234567.  In this case, the password of user3 when accessing ssh to the Client will be &lt;OTP-PIN&gt; i.e.  123456234567. <br><br><h3>  4.2.3.  Creating tokens for users </h3><br>  After LinOTP is connected to the base of user KS (useridresolver is configured) and the minimum set of policies has been created, you can proceed to creating tokens for users. <br>  Go to the ‚ÄúUser view‚Äù tab, select the user for which you want to create a token.  In the left menu, click "Enroll".  You will see a window with the settings of the new token. <br><br><img src="https://habrastorage.org/files/dfc/ef0/0de/dfcef00de03f4959931ae2f58504f745.jpg"><br>  <i>Figure 8 - Creating a token</i> <br><br>  <b>Token type</b> - token type.  Many different tokens are supported.  To support google authenticator (which will be used in this example), select ‚ÄúHMAC time based‚Äù.  This type of token will generate one-time passwords (OTP), tied to the current time (sometimes called TOTR).  <b><i>Hence the time synchronization requirement on all our machines ‚Äî the RADIUS Server, the LinOTP Server, and the Client.</i></b> <br>  <b>Token Seed</b> - you can ask to generate a random sequence (which was done in this example) - ‚Äúgenerate a random seed‚Äù or set your own ‚Äúenter seed‚Äù. <br>  <b>Token settings</b> - to support Google authenticator, just check the box ‚ÄúGoogle authenticator compliant‚Äù, otherwise you can independently set the length of the generated OTP token - ‚ÄúOTP digits‚Äù, the algorithm used - ‚ÄúHash algorithm‚Äù, the time window in which this OTP will act "Time step". <br>  An arbitrary description of the token - ‚ÄúDescription‚Äù - can be left empty at all, it does not affect anything. <br>  <b>Token Pin</b> - pin code of this token.  At least 6 digits for google authenticator. <br>  After entering all the necessary data, click "Enroll".  Token created. <br><br>  You will see a window with information about the token: QR code of the token for reading by the Google Authenticator application installed on the mobile device and a string containing the secret required, for example, to import the token into the GAUTH software client running under Windows. <br>  Copy the "otpauth: // totp / TOTP ...." Line at the bottom of the window and save.  You will need this when configuring the OTP client on Windows. <br><br><img src="https://habrastorage.org/files/b09/571/d06/b09571d0615a4c20b95ca1bf5b4cb15f.jpg"><br>  <i>Figure 9 - Created Token</i> <br><br>  After that, the window can be closed.  This token will appear in the list of tokens on the ‚ÄúToken view‚Äù tab in the LinOTP interface. <br><br><h3>  4.3.  Client setup procedure </h3><br><h3>  4.3.1.  Install the necessary software </h3><br>  In order for the Client to support authentication via RADIUS, it is necessary to install the libpam-radius-auth package on the Client (10.1.0.113 in the example).  This is also done with the help of the yum manager. <br><br><h3>  4.3.2. Configuring Client Authentication via RADIUS </h3><br>  It is necessary to configure authentication through the radius server.  To do this, edit the ‚Äúother-server other-secret 3‚Äù line in the /etc/pam_radius_auth.conf file.  Replace ‚Äúother server‚Äù with the IP address of the RADIUS server, i.e.  10.1.0.122, and ‚Äúother-secret‚Äù to the secret specified in section 4.1.2, i.e.  "Testing123".  The result is the following: <br><br><pre>  10.1.0.122 testing123 3 </pre><br>  Edit the /etc/pam.d/sshd file.  Add a line to it: <br><br><pre>  sufficient /lib/security/pam_radius_auth.so </pre><br>  above the lines <br><br><pre>  # Standard Un * x authentication.
 @include common-auth </pre><br>  You also need to create a user account on the Client with the same name as the user on LinOTP for which the token was created.  In this example, user7. <br><br><pre>  useradd ‚Äìm ‚Äìd / home / user7 user7 </pre><br><br><h3>  4.3.3.  The procedure for setting arm </h3><br>  On the AWP you need to install the OTP generator, for example GAUTH.  You can get this software here.  It is installed from the installer file contained in the downloaded archive.  The installation process is trivial. <br>  After installation, it is recommended to fix the key in the registry as described below.  Without this edit, the software will work, but at startup it will produce an error that does not please the eye.  This is a GAUTH bug, described in the FAQ for this software. <br>  You need to add a parameter of type String named key to the following branch: <br>  HKEY_CURRENT_USER \ Software \ GoogleAuth \ GoogleAuth \ 1.0.0. <br>  After that, run the client GAUTH through the START - programs - Google Auth.  The corresponding icon will appear in the tray.  Click on it with the right mouse button and select ‚ÄúModify key‚Äù.  In the opened window we insert the secret from the string saved during the creation of the token. <br>  Example line: otpauth: // totp / TOTP00013B2A? Secret = APY ***** JH &amp; counter = 0 <br>  In this case, the secret to be inserted will be: <br>  APY ***** JH <br>  Click "Save key". <br><br><img src="https://habrastorage.org/files/0f7/56e/e95/0f756ee952474addba2bb16d0ed6dfa2.jpg"><br>  <i>Figure 10 - Import secret to GAUTH</i> <br><br>  Now, when you hover the mouse over the icon in the tray, a six-digit OTP will appear and in brackets near it the time that this OTP will be valid. <br><br><img src="https://habrastorage.org/files/4d4/4ea/53c/4d44ea53ca0e43ffa5846f76701bdabb.jpg"><br>  <i>Figure 11 - Generated OTP</i> <br><br><h2>  5. Verifying authentication operation using OTP </h2><br>  We start on putS client workstation ‚Äúputty‚Äù.  Connect to the Client (in the example - 10.1.0.113).  Specify the name of the user for which the token was created (in the example, user7), enter &lt;OTP-PIN&gt; as a password without spaces or dashes, in one word (for example, 123456665494, where 123456 is a PIN and 665494 is a generated OTP). <br>  If everything is done correctly, the clock on all servers and the workstation is synchronized, then user access user7 must be authorized. </div><p>Source: <a href="https://habr.com/ru/post/270571/">https://habr.com/ru/post/270571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270555/index.html">Veeam Cloud Connect in Microsoft Azure</a></li>
<li><a href="../270557/index.html">What is useful you can extract from the report on the clouds in Russia</a></li>
<li><a href="../270559/index.html">The book "Learning C + + through game programming"</a></li>
<li><a href="../270563/index.html">Creating a VPN tunnel between two apartments based on routers with dd-wrt</a></li>
<li><a href="../270565/index.html">ABBYY helps startups</a></li>
<li><a href="../270573/index.html">How to find the longest continuous series of events using SQL</a></li>
<li><a href="../270577/index.html">Database generalization level</a></li>
<li><a href="../270579/index.html">Speeding up work with Emmet, or my first step to open source</a></li>
<li><a href="../270581/index.html">The Linux Piter conference program has been published.</a></li>
<li><a href="../270583/index.html">Highload Dev Conf'2015 was held on October 17 in Minsk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>