<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Port forwarding or how to get to the network for NAT using Node.JS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I want to share another way of port forwarding, now on Node.JS! 

 What is it for? Suppose there is a remote computer to which you want to conn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Port forwarding or how to get to the network for NAT using Node.JS</h1><div class="post__text post__text-html js-mediator-article">  Hello!  I want to share another way of port forwarding, now on Node.JS! <br><br>  What is it for?  Suppose there is a remote computer to which you want to connect, for example, via ssh, rdp, http (s), proxy, vnc, etc.  But, alas, it does not have a public IP for one reason or another. <br><img src="https://habrastorage.org/getpro/habr/post_images/d2c/9d0/18f/d2c9d018fa6aabbb929d7a433bbccd13.png" alt="image"><br><a name="habracut"></a><br>  <i>This example assumes your device has an external IP.</i> <br><br>  What then can be done?  Connect using a remote PC to yours (which listens, for example, port 3000), having <i>forwarded a certain port</i> , for example, 22. As a result, going through ssh to localhost: 3000, we will establish a connection with the remote PC. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>What is needed for this?</b>  On your and remote PC: <br><br>  We clone <a href="https://github.com/mgrybyk/node-tunnel">github.com/mgrybyk/node-tunnel</a> and install the npm modules: <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> node-tunnel</code> </pre> <pre> <code class="bash hljs">npm install</code> </pre> <br>  <b>Run</b> <br><br>  On your PC, run: <br><br><pre> <code class="bash hljs">node server</code> </pre> <br>  in another terminal: <br><br><pre> <code class="bash hljs">node client</code> </pre> <br>  On the remote PC, create a .env file, where we indicate which port to forward: <br><br> <code>N_T_AGENT_DATA_HOST=localhost <br> N_T_AGENT_DATA_PORT=22</code> <br> <br><pre> <code class="bash hljs">node agent</code> </pre> <br>  At this setting is completed, we can connect: <br><br><pre> <code class="bash hljs">ssh -p 8000 localhost</code> </pre> <br>  Ssh session to remote machine is set! <br><br>  <i>To start (and to play) server, client and agent can be run on the same device, then, by connecting to localhost: 8000 via ssh, you will go to yourself.</i>  <i>You can specify another host instead of localhost;</i>  <i>instead of ssh, you can use another TCP port, for example, http (s)</i> <br><br>  But what to do if <b>you do not have an external IP</b> ?  We need to find an intermediate point where it is available, for example, a free container on <a href="https://aws.amazon.com/free/">AWS</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ec/917/b13/5ec917b13ad0d037454290fd88656d62.png" alt="image"><br><br>  The essence is about the same, for example, now take the rdp port and give the names of the agent and the client. <br>  The names of the individual agent and clients must match. <br><br>  On the remote PC, edit the .env file, this time also specifying the Windows PC host within your network: <br><br> <code>N_T_SERVER_HOST=    IP <br> N_T_AGENT_DATA_HOST=Windows PC    <br> N_T_AGENT_DATA_PORT=3389 <br> N_T_AGENT_NAME=test-rdp</code> <br> <br>  And run: <br><br><pre> <code class="bash hljs">node agent</code> </pre> <br>  On a PC with an external IP, we simply start the <code>node server</code> first tilting the repository and installing the npm modules. <br><br>  On your PC, create a .env file, specifying the port that the client will listen to: <br><br> <code>N_T_SERVER_HOST=    IP <br> N_T_CLIENT_NAME=test-rdp <br> N_T_CLIENT_PORT=3388</code> <br> <br>  Run the <code>node client</code> .  Great!  Now we can connect via RDP to localhost: 3388 by opening the rdp session to the PC inside the agent network. <br><br>  <b>More customers?</b> <br><br>  You can tell how to configure (create .env) client, a friend.  Having started the client, he will also be able to access rdp there as well. <br><br>  <b>.env</b> <br><br>  For convenience, you can create many files such as .env.ssh, .env.rdp, .env.proxy, etc., and then run agent / client / server, passing the file name as an argument, for example: <br><br><pre> <code class="bash hljs">node client .env.rdp</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Encryption</b> <div class="spoiler_text">  ATTENTION!  Traffic encryption is not ready yet, until I figured out how to do it better. <br>  When data is encrypted, its length increases, which is why the message is often divided into two.  After that, on the other side they need to be glued together before letting go further.  It looks too crooked :( <br></div></div><br>  Wow, I will begin the most difficult, I will try to explain in a few words <b>how it works</b> . <br>  Used the standard module <a href="https://nodejs.org/api/net.html">Net</a> , which works on <i>TCP</i> . <br><br>  Clients and agents connect to the server, which forwards traffic from the agent to the client and back.  This is the main magic. <br><br>  The client, server, and agent have two important parts. <br><br>  The first is a socket for establishing a connection;  to make it clear who is who, let's call it - a service socket. <br><br>  The second is a socket for data transfer.  This is where the creation of pipes occurs: <br><br><pre> <code class="javascript hljs">agentSocket.pipe(clientSocket) clientSocket.pipe(agentSocket)</code> </pre> <br>  <b>Ssh example</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/589/629/85d/58962985da09272eb970448257fbd03f.png" alt="image"><br><br><ol><li>  Connecting to client </li><li>  Client redirects traffic to server </li><li>  The server redirects traffic to the agent. </li><li>  The agent creates a connection to the specified host: port and forwards traffic there. <br>  Well, and vice versa: the response of the SSH server to the agent, then - the server, client, ssh client. <br></li></ol><br>  <i>... a little for each separately</i> <br><br>  <b>Server</b> <br><br><ul><li>  Server is waiting on clients and agents </li><li>  When an agent arrives, the server creates a dedicated server for it, through which all traffic will continue </li><li>  When a client connects with the same name as the agent, the server sends the client port of the server to the client </li><li>  there may be many agents, but the names must be unique </li><li>  there can be many clients for each agent, a bunch of "many to one" </li></ul><br>  Knowing who is who, the server created for the agent redirects traffic from the agent to the client and back.  No encryption!  It works like this: <br><br><ol><li>  The client comes, we save the link to the socket </li><li>  The server notifies the agent that there is a client and it is time to open a connection. </li><li>  When the agent arrives - the server "paypit" agent's socket on the first available client socket and back </li><li>  The server notifies the client that the pipe has been created and it is time to forward traffic. <br>  In the future, the server does not listen to the ‚Äúdata‚Äù event of the client and agent. <br></li></ol><br>  <b>Agent</b> <br><br>  After establishing a connection with the server, the agent waits for commands from clients.  As soon as the command arrives, the agent establishes a connection to the specified host: port, and then redirects traffic from the server to the open connection and back. <br><br>  <b>Client</b> <br><br>  the client creates a local server (port N_T_CLIENT_PORT).  Upon successful connection to the remote server, it redirects all traffic from the remote server to the local server and back. <br><br>  <i>It's all!</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/373/733/e32/373733e32e1052dac2529ed6466062af.jpg" alt="image"><br><br>  Thanks for reading. <br><br>  I hope you had at least a little bit of interest, a bit of it is understandable and, maybe, even this application is useful, as it was useful for me and my colleagues. <br><br>  ‚Üí <a href="https://github.com/mgrybyk/node-tunnel">Github</a> <br><br><div class="spoiler">  <b class="spoiler_title">Interesting modules</b> <div class="spoiler_text">  Who needs to work with pipes, I recommend to watch <a href="https://www.npmjs.com/package/through2">through2</a> . <br><br>  With it, you can wedge in the middle of a chain of pipes for various purposes, for example, logging, error handling, after all, replacing all keywords with your own ones or even ones with zeros :) <br></div></div><br><div class="spoiler">  <b class="spoiler_title">PS</b> <div class="spoiler_text">  I am writing an article for the first time and with Russian is bad.  Please do not judge strictly. <br><br>  <b>Pps</b> <br>  Initially, the application was written for myself, since it was just interesting to do something similar on Node.  I use it myself for ssh, rdp, proxy, vnc and other purposes :) <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/332876/">https://habr.com/ru/post/332876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332866/index.html">Linear programming in python by the scipy library</a></li>
<li><a href="../332868/index.html">ASP.NET Developer Path ‚Üí PHP</a></li>
<li><a href="../332870/index.html">Interview with a programmer from Tinkoff Bank Andrei Stepanov about the language of Python and ML</a></li>
<li><a href="../332872/index.html">CSS and iOS Safari</a></li>
<li><a href="../332874/index.html">Bank "Otkrytie" holds a small business lending harvest</a></li>
<li><a href="../332878/index.html">Enter the rating of the participant "Habra" and "Toaster" on "My Circle"</a></li>
<li><a href="../332880/index.html">The critical vulnerability of the BIND authentication mechanism allows you to steal and modify DNS server records</a></li>
<li><a href="../332882/index.html">Hacking Clocktower - The First Fear</a></li>
<li><a href="../332884/index.html">About mobile library and love for React Native</a></li>
<li><a href="../332886/index.html">Dark moments of SELinux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>