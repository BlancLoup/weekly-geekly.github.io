<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The architecture of the SPA-application exchange in 2019</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, habrovchane! 


 I have been reading this resource since its inception, but the time to write an article appeared only now, which means it‚Äô...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The architecture of the SPA-application exchange in 2019</h1><div class="post__text post__text-html js-mediator-article"><p>  Greetings, habrovchane! </p><br><p>  I have been reading this resource since its inception, but the time to write an article appeared only now, which means it‚Äôs time to share my experience with the community.  I hope for novice developers, the article will help to improve the quality of design, and experienced ones will act as a checklist so as not to forget important elements at the architecture stage.  For the impatient - the final <a href="https://github.com/dkazakov8/exchange_habr">repository</a> and <a href="https://dkazakov8.github.io/exchange_habr/dist/">demos</a> . </p><br><a name="habracut"></a><br><p>  Suppose you are settled in a "dream company" - one of the exchanges with a free choice of technologies and resources to do everything "as it should."  At the moment, all that the company has is </p><br><h3>  Task from business </h3><br><p>  Develop a SPA application for the trade interface in which you can: </p><br><ul><li>  see the list of trading pairs grouped by the currency being traded; </li><li>  when you click on the trading pair, see the information on the current price, change in 24 hours, ‚Äúthe order book‚Äù; </li><li>  change the language of the application to English / Russian; </li><li>  change the theme to dark / light. </li></ul><br><p>  The task is rather short, which will allow focusing on the architecture, rather than writing large volumes of business functionality.  The result of the initial efforts should be a logical and well-thought-out code that allows you to proceed directly to the implementation of business logic. </p><br><p>  Since there are no technical requirements in the customer specification, let them be comfortable for development: </p><br><ul><li>  <b>Cross-browser compatibility</b> : 2 latest versions of popular browsers (without IE); </li><li>  <b>screen width</b> :&gt; = 1240px; </li><li>  <b>design</b> : by analogy with other exchanges, because  The designer has not yet been hired. </li></ul><br><p>  Now is the time to identify the tools and libraries used.  I will be guided by the principles of ‚Äúturnkey‚Äù development and <a href="https://ru.wikipedia.org/wiki/KISS_(%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF)">KISS</a> , that is, taking only those opensource libraries that would require an inadequate amount of time for self-realization, including time to train future fellow developers. </p><br><ul><li>  <b>version control system</b> : Git + Github; </li><li>  <b>backend</b> : CoinGecko <a href="https://www.coingecko.com/en/api">API</a> ; </li><li>  <b>build / transfer</b> : Webpack + Babel; </li><li>  <b>Package Installer</b> : Yarn (npm 6 incorrectly updated dependencies); </li><li>  <b>code quality control</b> : ESLint + Prettier + Stylelint; </li><li>  <b>view</b> : React (see how convenient the hooks are); </li><li>  <b>store</b> : MobX; </li><li>  <b>Autotests</b> : <a href="https://www.cypress.io/">Cypress.io</a> (complex solution for javascript instead of modular assembly like Mocha / Karma + Chai + Sinon + Selenium + Webdriver / Protractor); </li><li>  <b>Styles</b> : SCSS via PostCSS (configuration flexibility, friendly with Stylelint); </li><li>  <b>graphics</b> : <a href="https://www.highcharts.com/blog/products/highstock/">HighStock</a> (it is much easier to configure than <a href="https://ru.tradingview.com/HTML5-stock-forex-bitcoin-charting-library/">TradingView</a> , but for the real application you would take the latter); </li><li>  <b>error registration</b> : Sentry; </li><li>  <b>utilities</b> : Lodash (time saving); </li><li>  <b>routing</b> : turnkey; </li><li>  <b>localization</b> : turnkey; </li><li>  <b>work with queries</b> : turnkey; </li><li>  <b>performance metrics</b> : turnkey; </li><li>  <b>typing</b> : not in my shift. </li></ul><br><p>  Thus, only React, MobX, HighStock, Lodash and Sentry will be from the libraries in the final application file.  I think this is justified, as they have excellent documentation, speed and are familiar to many developers. </p><br><h3>  Code Quality Control </h3><br><p>  I prefer to break the dependencies in <i>package.json</i> into semantic parts, so after the initiation of the git repository I will group the first step in the style of the code in the <i>./eslint-custom</i> folder, with <i>package.json</i> : </p><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"upd"</span></span>: <span class="hljs-string"><span class="hljs-string">"yarn install --no-lockfile"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"eslint-custom"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:./eslint-custom"</span></span> } }</code> </pre> <br><p>  Normal <code>yarn install</code> will not check if the dependencies have changed inside <i>eslint-custom</i> , so I will use <code>yarn upd</code> .  In general, this practice looks more universal, since devops will not have to change the deployment recipe if developers need to change the package installation method. </p><br><p>  There is no point in using the yarn.lock <i>file</i> , since all dependencies will be without semver ‚Äúcaps‚Äù (in the form of <code>"react": "16.8.6"</code> ).  Experience has shown that it is better to manually update versions and test them thoroughly as part of individual tasks than relying on the lock file, giving package authors the opportunity to break the application with a minor update at any time (the lucky ones who have not encountered this). </p><br><p>  In the <i>eslint-custom</i> package dependencies will be as follows: </p><br><div class="spoiler">  <b class="spoiler_title">eslint-custom / package.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"eslint-custom"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Custom linter rules for this project"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"MIT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"babel-eslint"</span></span>: <span class="hljs-string"><span class="hljs-string">"10.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.16.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-config-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-import"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.17.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-react"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.12.4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-react-hooks"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.6.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.17.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"prettier-eslint"</span></span>: <span class="hljs-string"><span class="hljs-string">"8.8.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint"</span></span>: <span class="hljs-string"><span class="hljs-string">"10.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint-config-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint-scss"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.6.0"</span></span> } }</code> </pre></div></div><br><p>  To bind the three tools, it took 5 auxiliary packages ( <i>eslint-plugin-prettier, eslint-config-prettier, stylelint-prettier, stylelint-config-prettier, prettier-eslint</i> ) <i>‚Äîthat</i> price must be paid today.  For maximum convenience, all that is <a href="https://github.com/AlexJuarez/eslint-plugin-import-order-autofix">needed is</a> automatic <a href="https://github.com/AlexJuarez/eslint-plugin-import-order-autofix">sorting of imports</a> , but unfortunately, this plugin loses lines when reformatting a file. </p><br><p>  The configuration files for all tools will be in <i>* .js</i> format ( <i>eslint.config.js</i> , <i>stylelint.config.js</i> ) so that the code formatting works on them.  Let the rules be in <i>* .yaml</i> format, broken down by semantic modules.  Full versions of configurations and rules - in the <a href="https://github.com/dkazakov8/exchange_habr/tree/master/eslint-custom">repository</a> . </p><br><p>  It remains to add commands to the main <i>package.json</i> ... </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"upd"</span></span>: <span class="hljs-string"><span class="hljs-string">"yarn install --no-lockfile"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"format:js"</span></span>: <span class="hljs-string"><span class="hljs-string">"eslint --ignore-path .gitignore --ext .js -c ./eslint-custom/eslint.config.js --fix"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"format:style"</span></span>: <span class="hljs-string"><span class="hljs-string">"stylelint --ignore-path .gitignore --config ./eslint-custom/stylelint.config.js --fix"</span></span> } }</code> </pre><br><p>  ... and configure your IDE to apply formatting while saving the current file.  To guarantee a commit, you need to use git-hook, which will check and format all project files.  Why not only those that are present in the commit?  For the principle of collective responsibility for the entire code base, so that no one has the temptation to bypass validation.  For the same while creating a commit, all linter warnings will be considered errors with the help of <code>--max-warnings=0</code> . </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"husky"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hooks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"pre-commit"</span></span>: <span class="hljs-string"><span class="hljs-string">"npm run format:js -- --max-warnings=0 ./ &amp;&amp; npm run format:style ./**/*.scss"</span></span> } } }</code> </pre><br><h3>  Build / Transfer </h3><br><p>  I will use the modular approach again and bring all the Webpack and Babel settings to the folder ./webpack-custom.  The config will be based on the following file structure: </p><br><pre> <code class="pgsql hljs">. |<span class="hljs-comment"><span class="hljs-comment">-- webpack-custom | |-- config | |-- loaders | |-- plugins | |-- rules | |-- utils | `-- package.json | `-- webpack.config.js</span></span></code> </pre><br><p>  Properly configured collector will provide: </p><br><ul><li>  the ability to write code using the syntax and capabilities of the latest EcmaScript specification, including convenient proposals (decorators of classes and their properties for MobX will definitely be useful here); </li><li>  local server with Hot Reloading; </li><li>  assembly performance metrics; </li><li>  checking for cyclic dependencies; </li><li>  analysis of the structure and size of the final file; </li><li>  optimization and minification for production assembly; </li><li>  interpretation of modular <i>* .scss</i> files and the ability to make ready <i>* .css</i> files from the bundle; </li><li>  inline-insert <i>* .svg</i> files; </li><li>  polyfills / style prefixes for target browsers; </li><li>  solution to the problem of caching files on production. </li></ul><br><p>  And it will also be convenient to configure.  I will solve this problem with the help of two <i>* .env example</i> files: </p><br><div class="spoiler">  <b class="spoiler_title">.frontend.env.example</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">AGGREGATION_TIMEOUT=0 BUNDLE_ANALYZER=false BUNDLE_ANALYZER_PORT=8889 CIRCULAR_CHECK=true CSS_EXTRACT=false DEV_SERVER_PORT=8080 HOT_RELOAD=true NODE_ENV=development SENTRY_URL=false SPEED_ANALYZER=false PUBLIC_URL=false # https://webpack.js.org/configuration/devtool DEV_TOOL=cheap-module-source-map</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">.frontend.env.prod.example</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">AGGREGATION_TIMEOUT=0 BUNDLE_ANALYZER=false BUNDLE_ANALYZER_PORT=8889 CIRCULAR_CHECK=false CSS_EXTRACT=true DEV_SERVER_PORT=8080 HOT_RELOAD=false NODE_ENV=production SENTRY_URL=false SPEED_ANALYZER=false PUBLIC_URL=/exchange_habr/dist # https://webpack.js.org/configuration/devtool DEV_TOOL=false</code> </pre></div></div><br><p>  Thus, to run the assembly, you need to create a file called <i>.frontend.env</i> and the mandatory presence of all parameters.  This approach will solve several problems at once: it is not necessary to make separate configuration files for the Webpack and maintain their consistency;  locally, you can configure as much as a specific developer needs;  Deploying devops will only copy the file for a production assembly ( <code>cp .frontend.env.prod.example .frontend.env</code> ), enriching with values ‚Äã‚Äãfrom the repository, respectively, frontend developers can manage the recipe through variables without admins.  Additionally, it will be possible to make an example of configuration for stands (for example, from source maps). </p><br><p>  To separate styles into files with <i>CSS_EXTRACT</i> enabled, <i>I</i> will use <a href="https://github.com/webpack-contrib/mini-css-extract-plugin">mini-css-extract-plugin</a> - it allows using Hot Reloading.  That is, if you enable <i>HOT_RELOAD</i> and <i>CSS_EXTRACT</i> in local development, then <br>  only they will be reloaded when changing styles files - but, unfortunately, everything, and not just the modified file.  With <i>CSS_EXTRACT</i> turned off, only the modified style module will be updated. </p><br><p>  The HMR for working with React Hooks is enabled fairly standardly: </p><br><ul><li>  <code>webpack.HotModuleReplacementPlugin</code> in plugins; </li><li>  <code>hot: true</code> in <i>webpack-dev-server</i> parameters; </li><li>  <code>react-hot-loader/babel</code> to <i>babel-loader</i> plugins; </li><li>  <code>options.hmr: true</code> <i>mini-css-extract-plugin</i> ; </li><li>  <code>export default hot(App)</code> in the main component of the application; </li><li>  <i>@ hot-loader / react-dom</i> instead of the usual <i>react-dom</i> (conveniently through <code>resolve.alias: { 'react-dom': '@hot-loader/react-dom' }</code> ); </li></ul><br><p>  The current <i>react-hot-loader</i> version does not support component <code>React.memo</code> with <code>React.memo</code> , so when writing decorators for MobX, you will need to take this into account for the convenience of local development.  Another inconvenience caused by this is that when <i>Highlight Updates</i> is enabled in the React Developer Tools, all components are updated with any interaction with the application.  Therefore, when working locally on performance optimization, the <i>HOT_RELOAD</i> setting should be disabled. </p><br><p>  Optimization of assembly in Webpack 4 is performed automatically when specifying <code><a href="https://webpack.js.org/configuration/mode">mode</a> : 'development' | 'production'</code>  <code><a href="https://webpack.js.org/configuration/mode">mode</a> : 'development' | 'production'</code> .  In this case, I will rely on the standard optimization (+ including the <code>keep_fnames: true</code> parameter in the <i>terser-webpack-plugin</i> to save the names of the components), since it is already well-tuned. </p><br><p>  Separate attention should be divided into chunks and client caching control.  For correct work you need: </p><br><ul><li>  in output.filename for js and css files specify <code>isProduction ? '[name].[contenthash].js' : '[name].js'</code>  <code>isProduction ? '[name].[contenthash].js' : '[name].js'</code> (with a .css extension, respectively), so that the name of the file is based on its content; </li><li>  in optimization, change the parameters to <code>chunkIds: 'named', moduleIds: 'hashed'</code> , so that the internal module counter in the webpack does not change; </li><li>  make runtime in a separate chunk; </li><li>  bring caching groups to splitChunks (for this application, four points are enough - lodash, sentry, highcharts and vendor for the remaining dependencies from <i>node_modules</i> ).  Since the first three will be rarely updated, they will remain in the client browser cache as long as possible. </li></ul><br><div class="spoiler">  <b class="spoiler_title">webpack-custom / config / configOptimization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @docs: https://webpack.js.org/configuration/optimization * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TerserPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'terser-webpack-plugin'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">runtimeChunk</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'runtime'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">chunkIds</span></span>: <span class="hljs-string"><span class="hljs-string">'named'</span></span>, <span class="hljs-attr"><span class="hljs-attr">moduleIds</span></span>: <span class="hljs-string"><span class="hljs-string">'hashed'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mergeDuplicateChunks</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">splitChunks</span></span>: { <span class="hljs-attr"><span class="hljs-attr">cacheGroups</span></span>: { <span class="hljs-attr"><span class="hljs-attr">lodash</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\lodash'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">sentry</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\@sentry'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'sentry'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">highcharts</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\highcharts'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'highcharts'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">vendor</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">priority</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'vendor'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, }, }, <span class="hljs-attr"><span class="hljs-attr">minimizer</span></span>: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TerserPlugin({ <span class="hljs-attr"><span class="hljs-attr">terserOptions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">keep_fnames</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, }), ], };</code> </pre></div></div><br><p>  To speed up the build in this project I use <a href="https://github.com/webpack-contrib/thread-loader">thread-loader</a> - when parallelizing to 4 processes, it gave build acceleration by 90%, which is better than the happypack with similar settings. </p><br><p>  Settings for loaders, including for babel, in individual files (like <i>.babelrc</i> ) make, I believe, unnecessary.  But the cross-browser compatibility configuration is more convenient to keep in the <code>browserslist</code> parameter of the main <i>package.json</i> , since it is also used for autoprefixer styles. </p><br><p>  For convenience, Prettier made the parameter <i>AGGREGATION_TIMEOUT</i> , which allows you to set a delay between detecting changes in files and rebuilding an application in dev-server mode.  Since I configured to reformat files when saving to the IDE, this causes 2 rebuilds - the first to save the original file, the second to finish formatting.  2000 milliseconds is usually enough for the webpack to wait for the final version of the file. </p><br><p>  The rest of the configuration does not deserve special attention, since it is disclosed in hundreds of training materials for beginners, so you can proceed to the design of the application architecture. </p><br><h3>  Style themes </h3><br><p>  Previously, to create themes, you had to do several versions of <i>* .css</i> files and reload the page when changing themes, loading the necessary set of styles.  Now everything is easily solved using <a href="https://developer.mozilla.org/ru/docs/Web/CSS/Using_CSS_custom_properties">Custom CSS Properties</a> .  This technology is supported by all target browsers of the current application, but there are also polyfills for IE. </p><br><p>  Let's say there will be 2 themes - light and dark, the color sets for which will be in </p><br><div class="spoiler">  <b class="spoiler_title">styles / themes.scss</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">.light { --n0: rgb(255, 255, 255); --n100: rgb(186, 186, 186); --n10: rgb(249, 249, 249); --n10a3: rgba(249, 249, 249, 0.3); --n20: rgb(245, 245, 245); --n30: rgb(221, 221, 221); --n500: rgb(136, 136, 136); --n600: rgb(102, 102, 102); --n900: rgb(0, 0, 0); --b100: rgb(219, 237, 251); --b300: rgb(179, 214, 252); --b500: rgb(14, 123, 249); --b500a3: rgba(14, 123, 249, 0.3); --b900: rgb(32, 39, 57); --g400: rgb(71, 215, 141); --g500: rgb(61, 189, 125); --g500a1: rgba(61, 189, 125, 0.1); --g500a2: rgba(61, 189, 125, 0.2); --r400: rgb(255, 100, 100); --r500: rgb(255, 0, 0); --r500a1: rgba(255, 0, 0, 0.1); --r500a2: rgba(255, 0, 0, 0.2); } .dark { --n0: rgb(25, 32, 48); --n100: rgb(114, 126, 151); --n10: rgb(39, 46, 62); --n10a3: rgba(39, 46, 62, 0.3); --n20: rgb(25, 44, 74); --n30: rgb(67, 75, 111); --n500: rgb(117, 128, 154); --n600: rgb(255, 255, 255); --n900: rgb(255, 255, 255); --b100: rgb(219, 237, 251); --b300: rgb(39, 46, 62); --b500: rgb(14, 123, 249); --b500a3: rgba(14, 123, 249, 0.3); --b900: rgb(32, 39, 57); --g400: rgb(0, 220, 103); --g500: rgb(0, 197, 96); --g500a1: rgba(0, 197, 96, 0.1); --g500a2: rgba(0, 197, 96, 0.2); --r400: rgb(248, 23, 1); --r500: rgb(221, 23, 1); --r500a1: rgba(221, 23, 1, 0.1); --r500a2: rgba(221, 23, 1, 0.2); }</code> </pre></div></div><br><p>  In order for these variables to be applied globally, they need to be written to <code>document.documentElement</code> , respectively, a small parser is needed to convert this file to a javascript object.  Later I will explain why it is more convenient than to store it in javascript right away. </p><br><div class="spoiler">  <b class="spoiler_title">webpack-custom / utils / sassVariablesLoader.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertSourceToJsObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">source</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themesObject = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fullThemesArray = source.match(<span class="hljs-regexp"><span class="hljs-regexp">/\.([^}]|\s)*}/g</span></span>) || []; fullThemesArray.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fullThemeStr</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> theme = fullThemeStr .match(<span class="hljs-regexp"><span class="hljs-regexp">/\.\w+\s{/g</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\W/g</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); themesObject[theme] = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> variablesMatches = fullThemeStr.match(<span class="hljs-regexp"><span class="hljs-regexp">/--(.*:[^;]*)/g</span></span>) || []; variablesMatches.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">varMatch</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [key, value] = varMatch.split(<span class="hljs-string"><span class="hljs-string">': '</span></span>); themesObject[theme][key] = value; }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> themesObject; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkThemesEquality</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">themes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themesArray = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(themes); themesArray.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">themeStr</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themeObject = themes[themeStr]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> otherThemesArray = themesArray.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> t !== themeStr); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(themeObject).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">variableName</span></span></span><span class="hljs-function"> =&gt;</span></span> { otherThemesArray.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">otherThemeStr</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> otherThemeObject = themes[otherThemeStr]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!otherThemeObject[variableName]) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>( <span class="hljs-string"><span class="hljs-string">`checkThemesEquality: theme </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${otherThemeStr}</span></span></span><span class="hljs-string"> has no variable </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${variableName}</span></span></span><span class="hljs-string">`</span></span> ); } }); }); }); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sassVariablesLoader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">source</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themes = convertSourceToJsObject(source); checkThemesEquality(themes); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`module.exports = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">JSON</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.stringify(themes)}</span></span></span><span class="hljs-string">`</span></span>; };</code> </pre></div></div><br><p>  It also checks the consistency of topics - that is, the full compliance of a set of variables, the difference between which the assembly falls. </p><br><p>  When using this loader, a completely beautiful object with parameters is obtained, and a couple of lines are enough for the theme change utility: </p><br><div class="spoiler">  <b class="spoiler_title">src / utils / setTheme.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> themes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'styles/themes.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> root = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTheme</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">theme</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(themes[theme]).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[key, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { root.style.setProperty(key, value); }); }</code> </pre></div></div><br><p>  I prefer to translate these css-variables into standard for <i>* .scss</i> : </p><br><div class="spoiler">  <b class="spoiler_title">src / styles / constants.scss</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/py/b5/jf/pyb5jfs2g07r-ypnnkoudkdxe7s.png"><br></div></div><br><p>  IDE WebStorm, as seen in the screenshot, shows the colors in the panel on the left and by clicking on a color opens a palette where you can change it.  The new color will automatically be substituted into the <i>themes.scss</i> , the Hot Reload will work and the application will instantly change.  This is exactly the level of convenience of development, which is expected in 2019. </p><br><h3>  Principles of code organization </h3><br><p>  In this project I will adhere to duplication of folder names of components, files and styles, for example: </p><p></p><pre> <code class="pgsql hljs">. |<span class="hljs-comment"><span class="hljs-comment">-- components | |-- Chart | | `-- Chart.js | | `-- Chart.scss | | `-- package.json</span></span></code> </pre><br><p>  Accordingly, <i>package.json</i> will have the content <code>{ "main": "Chart.js" }</code> .  For components with multiple named exports (for example, utilities), the name of the main file will begin with an underscore: </p><br><pre> <code class="pgsql hljs">. |<span class="hljs-comment"><span class="hljs-comment">-- utils | `-- _utils.js | `-- someUtil.js | `-- anotherUtil.js | `-- package.json</span></span></code> </pre><br><p>  And the rest of the files will be exported as: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./someUtil'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./anotherUtil'</span></span>;</code> </pre><br><p>  This will get rid of duplicate file names, so as not to get lost in the top ten open <i>index.js</i> / <i>style.scss</i> .  You can solve this with plugins for IDE, but why not in a universal way. </p><br><p>  Components will be grouped by page, except for common ones like Message / Link, and if possible use named exports (without <code>export default</code> ) to maintain uniformity of names, ease of refactoring and search by project. </p><br><h3>  Customize the rendering and storage of MobX </h3><br><p>  The file that serves as the entry point for the Webpack will look like this: </p><br><div class="spoiler">  <b class="spoiler_title">src / app.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./polyfill'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./styles/reset.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./styles/global.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initSentry, renderToDOM } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initAutorun } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./autorun'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { store } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stores'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> App <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'components/App'</span></span>; initSentry(); initAutorun(store); renderToDOM(App);</code> </pre></div></div><br><p>  As when working with observables, the console displays something like <code>Proxy {0: "btc", 1: "eth", 2: "usd", 3: "test", Symbol(mobx administration): ObservableArrayAdministration}</code> , in polyfills I will make the utility for reduction in a standard type: </p><br><div class="spoiler">  <b class="spoiler_title">src / polyfill.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { toJS } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.js = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consoleJsCustom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(...args.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arg</span></span></span><span class="hljs-function"> =&gt;</span></span> toJS(arg))); };</code> </pre></div></div><br><p>  Also, global styles and style normalization for different browsers are connected in the main file, if you have a key for Sentry, errors start to be logged in .env.frontend, MobX storage is created, tracking of changes in parameters is initiated using autorun and the component wrapped in <i>react-hot-loader</i> is mounted in the dom. </p><br><p>  The storage itself will be a non-observable class, the parameters of which will be non-observable classes with observable parameters.  Thus it is assumed that the parameter set will not be dynamic - therefore, the application will be more predictable.  This is one of the few places where JSDoc comes in handy to enable autocompletion in the IDE. </p><br><div class="spoiler">  <b class="spoiler_title">src / stores / RootStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { I18nStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./I18nStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RatesStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RatesStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { GlobalStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./GlobalStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RouterStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RouterStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { CurrentTPStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./CurrentTPStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { MarketsListStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./MarketsListStore'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * @name RootStore */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i18n = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> I18nStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rates = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RatesStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.global = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GlobalStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouterStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentTP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrentTPStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketsList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MarketsListStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre></div></div><br><p>  The example of MobX Store can be analyzed using the example of GlobalStore, which at the moment will have the only purpose - to store and install the current style theme. </p><br><div class="spoiler">  <b class="spoiler_title">src / stores / GlobalStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable, setTheme } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> themes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'styles/themes.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themesList = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(themes); @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; setTheme(themesList[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } themesList = themesList; currentTheme = <span class="hljs-string"><span class="hljs-string">''</span></span>; setTheme(theme) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentTheme = theme; setTheme(theme); } }</code> </pre></div></div><br><p>  Sometimes the parameters and the class method manually using decorators set the type, for example: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalStore</span></span></span><span class="hljs-class"> </span></span>{ @observable currentTheme = <span class="hljs-string"><span class="hljs-string">''</span></span>; @action.bound setTheme(theme) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentTheme = theme; setTheme(theme); } }</code> </pre><br><p>  But I see no point in this, since the old Proposal class decorators support their automatic transformation, so the following utility suffices: </p><br><div class="spoiler">  <b class="spoiler_title">src / utils / makeObservable.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { action, computed, decorate, observable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeObservable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *   -   this +    *     * *   -   computed * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> classPrototype = target.prototype; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> methodsAndGetters = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyNames(classPrototype).filter( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">methodName</span></span></span><span class="hljs-function"> =&gt;</span></span> methodName !== <span class="hljs-string"><span class="hljs-string">'constructor'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> methodName <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> methodsAndGetters) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> descriptor = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor( classPrototype, methodName ); descriptor.value = decorate(classPrototype, { [methodName]: <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> descriptor.value === <span class="hljs-string"><span class="hljs-string">'function'</span></span> ? action.bound : computed, }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...constructorArguments</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">/** * ,   rootStore,   * observable * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> target(...constructorArguments); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> staticProperties = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(store); staticProperties.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">propName</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propName === <span class="hljs-string"><span class="hljs-string">'rootStore'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> descriptor = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor(store, propName); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty( store, propName, observable(store, propName, descriptor) ); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> store; }; }</code> </pre></div></div><br><p>  To use, you need to adjust the plugins in <i>loaderBabel.js</i> : <code>['@babel/plugin-proposal-decorators', { legacy: true }], ['@babel/plugin-proposal-class-properties', { loose: true }]</code> , and in the ESLint settings, set parserOptions.ecmaFeatures.legacyDecorators accordingly <code>parserOptions.ecmaFeatures.legacyDecorators: true</code> .  Without these settings, only the class descriptor without a prototype is transferred to the decorator‚Äôs target, and despite careful research of the <a href="https://tc39.github.io/proposal-decorators/">current version of Proposal</a> , I have not found a way to wrap the methods and static properties. </p><br><p>  In general, the storage configuration is complete, but it would be good to unlock the potential of MobX autorun.  For this, tasks like ‚Äúwait for a response from the authorization server‚Äù or ‚Äúdownload translations from the server‚Äù are best suited, then write the answers to the stop and directly render the application to the DOM.  Therefore, I will run a bit into the future and create a story with localization: </p><br><div class="spoiler">  <b class="spoiler_title">src / stores / I18nStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ru <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'localization/ru.json'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> en <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'localization/en.json'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> languages = { ru, en, }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> languagesList = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(languages); @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">I18nStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setLocalization(<span class="hljs-string"><span class="hljs-string">'ru'</span></span>); }, <span class="hljs-number"><span class="hljs-number">500</span></span>); } i18n = {}; languagesList = languagesList; currentLanguage = <span class="hljs-string"><span class="hljs-string">''</span></span>; setLocalization(language) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentLanguage = language; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i18n = languages[language]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore.global.shouldAppRender = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre></div></div><br><p>  As you can see, there are some <i>* .json</i> files with translations, and in the class constructor, asynchronous loading is emulated using setTimeout.  When executed in the newly created GlobalStore, <code>this.rootStore.global.shouldAppRender = true</code> put <code>this.rootStore.global.shouldAppRender = true</code> . </p><br><p>  Thus, from <i>app.js</i> you need to transfer the rendering function to the <i>autorun.js</i> file: </p><br><div class="spoiler">  <b class="spoiler_title">src / autorun.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* eslint-disable no-unused-vars */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { autorun } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { renderToDOM } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> App <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'components/App'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> loggingEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logReason</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">autorunName, reaction</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!loggingEnabled || reaction.observing.length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logString = reaction.observing.reduce( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str, { name, value }</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${str}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name}</span></span></span><span class="hljs-string"> changed to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${value}</span></span></span><span class="hljs-string">; `</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`autorun-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${autorunName}</span></span></span><span class="hljs-string">`</span></span>, logString); } <span class="hljs-comment"><span class="hljs-comment">/** * @param store {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initAutorun</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">store</span></span></span><span class="hljs-function">) </span></span>{ autorun(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reaction</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (store.global.shouldAppRender) { renderToDOM(App); } logReason(<span class="hljs-string"><span class="hljs-string">'shouldAppRender'</span></span>, reaction); }); }</code> </pre></div></div><br><p>  In the <i>initAutorun</i> function, <i>there</i> can be any number of <i>autorun</i> constructions with callbacks that will work only when they themselves initiate and change a variable inside a particular callback.  In this case, the console will <code>autorun-shouldAppRender GlobalStore@3.shouldAppRender changed to true;</code>  , and caused the application to be rendered in the DOM.  A powerful tool that allows you to log all changes in the stack and respond to them accordingly. </p><br><h3>  Localization and React Hooks </h3><br><p>  Translation into other languages ‚Äã‚Äãis one of the most voluminous tasks, in small companies it is often underestimated tenfold, and in large ones it is unnecessarily over-complicated.  From its implementation depends on how much nerves and time will not be wasted at once in several departments in the company.  I will only touch on the client part in the article with a basis for future integration with other systems. </p><br><p>  For the convenience of developing frontend, you must be able to: </p><br><ul><li>  set semantic names for constants; </li><li>  insert dynamic variables; </li><li>  specify the singular / plural; </li><li>  easy to connect localization anywhere - by function or reactant component; </li><li>         ; </li><li>       /  ; </li><li>  ; </li><li> ()   ; </li><li> ()         ,         . </li></ul><br><p>    ,  ,  :         <i>messages.js</i>      (      )      .         .             (     / ),    .    ( , , )  .   . </p><br><p>       ,    <i>currentLanguage</i>   <i>i18n</i>    ,   ,     . </p><br><div class="spoiler"> <b class="spoiler_title">src/components/TestLocalization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useLocalization } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messages = { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'  {count} {count: ,,}'</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestLocalization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getLn = useLocalization(__filename, messages); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{getLn(messages.hello, { count: 1 })}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestLocalizationConnected = observer(TestLocalization);</code> </pre></div></div><br><p>        ,       MobX-     ,  , Connected. ,       ESLint,       . </p><br><p>  observer     <code>mobx-react-lite/useObserver</code> ,    <i>HOT_RELOAD</i>      <i>React.memo</i> (  <i>PureMixin</i> / <i>PureComponent</i> ),       <i>useObserver</i>   : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/observer.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useObserver } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx-react-lite'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyStaticProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">base, target</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> hoistBlackList = { <span class="hljs-attr"><span class="hljs-attr">$$typeof</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">compare</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(base).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (base.hasOwnProperty(key) &amp;&amp; !hoistBlackList[key]) { <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty( target, key, <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor(base, key) ); } }); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">observer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">baseComponent, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseComponentName = baseComponent.displayName || baseComponent.name; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrappedComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props, ref</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> useObserver(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyObserver</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> baseComponent(props, ref); }, baseComponentName); } wrappedComponent.displayName = baseComponentName; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> memoComponent = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HOT_RELOAD === <span class="hljs-string"><span class="hljs-string">'true'</span></span>) { memoComponent = wrappedComponent; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options.forwardRef) { memoComponent = React.memo(React.forwardRef(wrappedComponent)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { memoComponent = React.memo(wrappedComponent); } copyStaticProperties(baseComponent, memoComponent); memoComponent.displayName = baseComponentName; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memoComponent; }</code> </pre></div></div><br><p>     <code>displayName</code>   ,   React-     ( stack trace   ). </p><br><p>      RootStore: </p><br><div class="spoiler"> <b class="spoiler_title">src/hooks/useStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { store } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stores'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> storeContext = React.createContext(store); <span class="hljs-comment"><span class="hljs-comment">/** * @returns {RootStore} * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">useStore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> React.useContext(storeContext); }</code> </pre></div></div><br><p>       ,   observer: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{store.i18n.currentLanguage}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestComponentConnected = observer(TestComponent);</code> </pre><br><p>      TestLocalization ‚Äî     useLocalization: </p><br><div class="spoiler"> <b class="spoiler_title">src/hooks/useLocalization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { declOfNum } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./useStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> showNoTextMessage = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceDynamicParams</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values, formattedMessage</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isPlainObject(values)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formattedMessage; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> messageWithValues = formattedMessage; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(values).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { messageWithValues = formattedMessage.replace(<span class="hljs-string"><span class="hljs-string">`{</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string">}`</span></span>, value); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageWithValues; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePlurals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values, formattedMessage</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isPlainObject(values)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formattedMessage; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> messageWithPlurals = formattedMessage; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(values).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pluralPattern = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">`{</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string">:\\s([^}]*)}`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pluralMatch = formattedMessage.match(pluralPattern); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pluralMatch &amp;&amp; pluralMatch[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { messageWithPlurals = formattedMessage.replace( pluralPattern, declOfNum(value, pluralMatch[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">','</span></span>)) ); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageWithPlurals; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">useLocalization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filename, messages</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-attr"><span class="hljs-attr">i18n</span></span>: { i18n, currentLanguage }, } = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text, values</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key = _.findKey(messages, message =&gt; message === text); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> localizedText = _.get(i18n, [filename, key]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!localizedText &amp;&amp; showNoTextMessage) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error( <span class="hljs-string"><span class="hljs-string">`useLocalization: no localization for lang '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentLanguage}</span></span></span><span class="hljs-string">' in </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${key}</span></span></span><span class="hljs-string">`</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> formattedMessage = localizedText || text; formattedMessage = replaceDynamicParams(values, formattedMessage); formattedMessage = replacePlurals(values, formattedMessage); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formattedMessage; }; }</code> </pre></div></div><br><p>  <i>replaceDynamicParams</i>  <i>replacePlurals</i>     ‚Äî            , ,    , ,  ,      .. </p><br><p>         Webpack ‚Äî <i>__filename</i> ‚Äî    ,   ,       .         ,       ‚Äî        ,       ,     .     ,     : </p><br><pre> <code class="javascript hljs">useLocalization: no localization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> lang <span class="hljs-string"><span class="hljs-string">'ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> src\components\TestLocalization\TestLocalization.js hello</code> </pre><br><p>         <i>ru.json</i> : </p><br><div class="spoiler"> <b class="spoiler_title">src/localization/ru.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"src\\components\\TestLocalization\\TestLocalization.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hello"</span></span>: <span class="hljs-string"><span class="hljs-string">"  {count} {count: ,,}"</span></span> } }</code> </pre></div></div><br><p>   ,   .      <i>src/localization/en.json</i>       ¬´ ¬ª    <i>setLocalization</i>  I18nStore. </p><br><p>    ¬´¬ª   React  Message: </p><br><div class="spoiler"> <b class="spoiler_title">src/components/Message/Message.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useLocalization } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Message</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { filename, messages, text, values } = props; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getLn = useLocalization(filename, messages); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getLn(text, values); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ConnectedMessage = observer(Message); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filename, messages</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessageHoc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fullProps = { filename, messages, ...props }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ConnectedMessage</span></span></span></span><span class="xml"><span class="hljs-tag"> {</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...fullProps</span></span></span></span><span class="xml"><span class="hljs-tag">} /&gt;</span></span></span><span class="xml">; }; }</span></span></code> </pre></div></div><br><p>        __filename (    id     ),       ,   : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Message = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'components/Message'</span></span>).init( __filename, messages ); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">text</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{messages.hello}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">values</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">count:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> }} /&gt;</span></span></span></span></code> </pre><br><p>   ‚Äî      <i>useLocalization</i>       (      <i>currentLanguage</i> ,     Message ‚Äî   .    ,          ,      . </p><br><p>     ,           (    ,       ,      ,  /              production).       id      ,          <i>messages.js</i>   <i>*.json</i>     ,    .               (      / ),      production.       ,    ,   . </p><br><p>     MobX + Hooks    .     ,   backend,    ,    ,   . </p><br><h3>  Work with API </h3><br><p>         ( backend,      ) ‚Äî   ,   ,     .        ,      .     : </p><br><div class="spoiler"> <b class="spoiler_title">src/stores/CurrentTPStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { apiRoutes, request } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api'</span></span>; @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentTPStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; } id = <span class="hljs-string"><span class="hljs-string">''</span></span>; symbol = <span class="hljs-string"><span class="hljs-string">''</span></span>; fullName = <span class="hljs-string"><span class="hljs-string">''</span></span>; currency = <span class="hljs-string"><span class="hljs-string">''</span></span>; tradedCurrency = <span class="hljs-string"><span class="hljs-string">''</span></span>; low24h = <span class="hljs-number"><span class="hljs-number">0</span></span>; high24h = <span class="hljs-number"><span class="hljs-number">0</span></span>; lastPrice = <span class="hljs-number"><span class="hljs-number">0</span></span>; marketCap = <span class="hljs-number"><span class="hljs-number">0</span></span>; change24h = <span class="hljs-number"><span class="hljs-number">0</span></span>; change24hPercentage = <span class="hljs-number"><span class="hljs-number">0</span></span>; fetchSymbol(params) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { tradedCurrency, id } = params; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { marketsList } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requestParams = { id, <span class="hljs-attr"><span class="hljs-attr">localization</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">community_data</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">developer_data</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">tickers</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request(apiRoutes.symbolInfo, requestParams) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetchSymbolSuccess(data, tradedCurrency)) .catch(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetchSymbolError); } fetchSymbolSuccess(data, tradedCurrency) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { id, symbol, name, <span class="hljs-attr"><span class="hljs-attr">market_data</span></span>: { high_24h, low_24h, price_change_24h_in_currency, price_change_percentage_24h_in_currency, market_cap, current_price, }, } = data; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.symbol = symbol; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullName = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currency = symbol; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tradedCurrency = tradedCurrency; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastPrice = current_price[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.high24h = high_24h[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.low24h = low_24h[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.change24h = price_change_24h_in_currency[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.change24hPercentage = price_change_percentage_24h_in_currency[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketCap = market_cap[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); } fetchSymbolError(error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); } }</code> </pre></div></div><br><p>  ,  ,      .      <i>fetchSymbol</i> ,    id    ,    .     ,   ‚Äî        (       <code>@action.bound</code> ),       Sentry     : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/initSentry.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sentry <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@sentry/browser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initSentry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SENTRY_URL !== <span class="hljs-string"><span class="hljs-string">'false'</span></span>) { Sentry.init({ <span class="hljs-attr"><span class="hljs-attr">dsn</span></span>: SENTRY_URL, }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> originalErrorLogger = <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consoleErrorCustom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...args</span></span></span><span class="hljs-function">) </span></span>{ Sentry.captureException(...args); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> originalErrorLogger(...args); }; } }</code> </pre></div></div><br><p>    ,        : </p><br><div class="spoiler"> <b class="spoiler_title">src/api/_api.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { omitParam, validateRequestParams, makeRequestUrl, makeRequest, validateResponse, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(validateRequestParams(route, params)) .then(makeRequestUrl(route, params)) .then(makeRequest) .then(validateResponse(route, params)); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apiRoutes = { <span class="hljs-attr"><span class="hljs-attr">symbolInfo</span></span>: { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">params</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`https://api.coingecko.com/api/v3/coins/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.id}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: omitParam, <span class="hljs-attr"><span class="hljs-attr">localization</span></span>: _.isBoolean, <span class="hljs-attr"><span class="hljs-attr">community_data</span></span>: _.isBoolean, <span class="hljs-attr"><span class="hljs-attr">developer_data</span></span>: _.isBoolean, <span class="hljs-attr"><span class="hljs-attr">tickers</span></span>: _.isBoolean, }, <span class="hljs-attr"><span class="hljs-attr">responseObject</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">symbol</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">genesis_date</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> _.isString(v) || _.isNil(v), <span class="hljs-attr"><span class="hljs-attr">last_updated</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">country_origin</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">coingecko_rank</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">coingecko_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">community_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">developer_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">liquidity_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">market_cap_rank</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">block_time_in_minutes</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">public_interest_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: _.isPlainObject, <span class="hljs-attr"><span class="hljs-attr">links</span></span>: _.isPlainObject, <span class="hljs-attr"><span class="hljs-attr">description</span></span>: _.isPlainObject, <span class="hljs-attr"><span class="hljs-attr">market_data</span></span>: _.isPlainObject, localization(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.localization === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(value); }, community_data(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.community_data === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(value); }, developer_data(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.developer_data === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(value); }, <span class="hljs-attr"><span class="hljs-attr">public_interest_stats</span></span>: _.isPlainObject, tickers(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.tickers === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isArray(value); }, <span class="hljs-attr"><span class="hljs-attr">categories</span></span>: _.isArray, <span class="hljs-attr"><span class="hljs-attr">status_updates</span></span>: _.isArray, }, }, };</code> </pre></div></div><br><p>    request : </p><br><ol><li>    apiRoutes    ; </li><li>     ,   route.params,     ,    <i>omitParam</i> ; </li><li>   URL    <code>route.url</code> ‚Äî   ,      ,   ‚Äî    get-  URL; </li><li>     fetch,     JSON; </li><li>     ,   <code>route.responseObject</code>  <code>route.responseArray</code> (     ).       ,   ‚Äî   ,     ; </li><li>      /  /   /       ,      (   <i>fetchSymbolError</i> )  . </li></ol><br><p>               . ,     Sentry,         response: </p><br><p><img src="https://habrastorage.org/webt/mk/7y/8s/mk7y8sh2cushkehhykrrufsvkre.png"></p><br><p>        ‚Äî            (       ),    . </p><br><h3>    </h3><br><p>    ,       ,        . ,    : </p><br><ul><li>          ; </li><li>    pathname  search; </li><li>      / ; </li><li>   location     ; </li><li>      beforeEnter,      isLoading,   ; </li><li>      :   ,    ,   ,   beforeEnter,     ; </li><li>     /   ; </li><li>   /        ; </li><li>     . </li></ul><br><p>     ¬´¬ª,            -,     ‚Äî     .       : </p><br><div class="spoiler"> <b class="spoiler_title">src/routes.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routes = { <span class="hljs-attr"><span class="hljs-attr">marketDetailed</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'marketDetailed'</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/market/:market/:pair'</span></span>, <span class="hljs-attr"><span class="hljs-attr">masks</span></span>: { <span class="hljs-attr"><span class="hljs-attr">pair</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/^[a-zA-Z]{3,5}-[a-zA-Z]{3}$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">market</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/^[a-zA-Z]{3,4}$/</span></span>, }, beforeEnter(route, store) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { pair, market }, } = route; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [symbol, tradedCurrency] = pair.split(<span class="hljs-string"><span class="hljs-string">'-'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> prevMarket = store.marketsList.currentMarket; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimisticallyUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ store.marketsList.currentMarket = market; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(optimisticallyUpdate) .then(store.marketsList.fetchSymbolsList) .then(store.rates.fetchRates) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> store.marketsList.fetchMarketList(market, prevMarket)) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> store.currentTP.fetchSymbol({ symbol, tradedCurrency, }) ) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); }); }, }, <span class="hljs-attr"><span class="hljs-attr">error404</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'error404'</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/error404'</span></span>, }, };</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">src/routeComponents.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { MarketDetailed } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'pages/MarketDetailed'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Error404 } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'pages/Error404'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routeComponents = { <span class="hljs-attr"><span class="hljs-attr">marketDetailed</span></span>: MarketDetailed, <span class="hljs-attr"><span class="hljs-attr">error404</span></span>: Error404, };</code> </pre></div></div><br><p> ,  ,          ‚Äî         <code>&lt;Link route={routes.marketDetailed}&gt;</code> ,    . Webpack       ,      . </p><br><p>   ,    location      . </p><br><div class="spoiler"> <b class="spoiler_title">src/stores/RouterStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { routes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'routes'</span></span>; @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RouterStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._fillRouteSchemaFromUrl(); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'popstate'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._fillRouteSchemaFromUrl(); }); } currentRoute = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _fillRouteSchemaFromUrl() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathnameArray = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.pathname.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routeName = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._getRouteNameMatchingUrl(pathnameArray); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!routeName) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> currentRoute = routes.error404; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, currentRoute.path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentRoute; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> route = routes[routeName]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routePathnameArray = route.path.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> params = {}; routePathnameArray.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pathParam, i</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> urlParam = pathnameArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathParam.indexOf(<span class="hljs-string"><span class="hljs-string">':'</span></span>) === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramName = pathParam.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); params[paramName] = urlParam; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, route, { params, <span class="hljs-attr"><span class="hljs-attr">isLoading</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); } _getRouteNameMatchingUrl(pathnameArray) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.findKey(routes, route =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routePathnameArray = route.path.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (routePathnameArray.length !== pathnameArray.length) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; routePathnameArray.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathParam = routePathnameArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> urlParam = pathnameArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathParam.indexOf(<span class="hljs-string"><span class="hljs-string">':'</span></span>) !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathParam !== urlParam) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramName = pathParam.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramMask = _.get(route.masks, paramName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramMask &amp;&amp; !paramMask.test(urlParam)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); } replaceDynamicParams(route, params) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(params).reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pathname, [paramName, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pathname.replace(<span class="hljs-string"><span class="hljs-string">`:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string">`</span></span>, value); }, route.path); } goTo(route, params) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (route.name === <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.name) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_.isEqual(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.params, params)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.isLoading = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.params = params; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPathname = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replaceDynamicParams(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute, params); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, newPathname); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPathname = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replaceDynamicParams(route, params); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, newPathname); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._fillRouteSchemaFromUrl(); } }</code> </pre></div></div><br><p>     ‚Äî         <i>routes.js</i>       .          ‚Äî       404. ,       ¬´          ¬ª,     ,      ,   ‚Äî ,        'test-test'. </p><br><p>   <i>currentRoute</i>   ,   <i>params</i> (   URL)  <code>isLoading: true</code> .      React- Router: </p><br><div class="spoiler"> <b class="spoiler_title">src/components/Router.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { routeComponents } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'routeComponents'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRouteComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, isLoading</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Component = routeComponents[route.name]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Component) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error( <span class="hljs-string"><span class="hljs-string">`getRouteComponent: component for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ route.name }</span></span></span><span class="hljs-string"> is not defined in routeComponents`</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Component</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">isLoading</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{isLoading}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; } function useBeforeEnter() { const store = useStore(); const { currentRoute } = store.router; React.useEffect(() =&gt; { if (currentRoute.isLoading) { const beforeEnter = _.get(currentRoute, 'beforeEnter'); if (_.isFunction(beforeEnter)) { Promise.resolve() .then(() =&gt; beforeEnter(currentRoute, store)) .then(() =&gt; { currentRoute.isLoading = false; }) .catch(error =&gt; console.error(error)); } else { currentRoute.isLoading = false; } } }); return currentRoute.isLoading; } function Router() { const { router: { currentRoute }, } = useStore(); const isLoading = useBeforeEnter(); return getRouteComponent(currentRoute, isLoading); } export const RouterConnected = observer(Router);</span></span></code> </pre></div></div><br><p>    ,        ,     <code>currentRoute == null</code> .    ‚Äî      <code>isLoading === true</code> ,           false   ,    <code>route.beforeEnter</code> ( ).            <code>console.error</code> ,    ,     . </p><br><p>  ,    ‚Äî     ,   .  React-  2 : </p><br><ol><li>    componentWillMount / componentDidMount / useEffect  ,     ,   .        ‚Äî     ,          ¬´¬ª.   ‚Äî       ‚Äî        ; </li><li>    ( )        ,   .  ‚Äî      ‚Äî  ,          .   ‚Äî      /  ‚Äî   real-time   ,     /    . </li></ol><br><p>       ,         ‚Äî      (  ,  ,            ..),         . </p><br><p>        <i>beforeEnter</i> ,  : ¬´ ¬ª,     ( , ,      ),    ‚Äî    (         ‚Äî    500 ;          ;   ,       ;        ..).   ¬´¬ª     ,        MVP   . </p><br><p>        : </p><br><div class="spoiler"> <b class="spoiler_title">src/components/Link.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkRouteParamsWithMasks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (route.masks) { <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(route.masks).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, paramMask]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> value = _.get(params, paramName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramMask &amp;&amp; !paramMask.test(value)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error( <span class="hljs-string"><span class="hljs-string">`checkRouteParamsWithMasks: wrong param for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string"> in Link to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ route.name }</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${value}</span></span></span><span class="hljs-string">`</span></span> ); } }); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Link</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { currentRoute } = store.router; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { route, params, children, onClick, ...otherProps } = props; checkRouteParamsWithMasks(route, params); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> filledPath = store.router.replaceDynamicParams(route, params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{filledPath}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{e</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> { e.preventDefault(); if (currentRoute.isLoading) { return false; } store.router.goTo(route, params); if (onClick) { onClick(); } }} {...otherProps} &gt; {children} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LinkConnected = observer(Link);</code> </pre></div></div><br><p>     <i>route</i> ,    <i>params</i> ( )     (        )   <i>href</i>  .  ,           <i>beforeEnter</i> ,    .      ¬´,  ¬ª,       ,           ‚Äî    . </p><br><h3>  </h3><br><p>  - (  ,   ,   ,   ,    )     .     .                 . </p><br><p>     ‚Äî         ,   ‚Äî  ,       .        : </p><br><div class="spoiler"> <b class="spoiler_title">src/api/utils/metrics.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> metricsArray = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sendMetricsCallback = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startMetrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, apiRoutes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">promiseCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ clearTimeout(sendMetricsCallback); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apiRouteName = _.findKey(apiRoutes, route); metricsArray.push({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: apiRouteName, <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(), }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; }; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopMetrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, apiRoutes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">promiseCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apiRouteName = _.findKey(apiRoutes, route); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> metricsData = _.find(metricsArray, [<span class="hljs-string"><span class="hljs-string">'id'</span></span>, apiRouteName]); metricsData.time = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime() - metricsData.time; clearTimeout(sendMetricsCallback); sendMetricsCallback = setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Metrics sent:'</span></span>, metricsArray); metricsArray = []; }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; }; }</code> </pre></div></div><br><p>     middleware   <i>request</i> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(startMetrics(route, apiRoutes)) .then(validateRequestParams(route, params)) .then(makeRequestUrl(route, params)) .then(makeRequest) .then(validateResponse(route, params)) .then(stopMetrics(route, apiRoutes)) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { stopMetrics(route, apiRoutes)(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> error; }); }</code> </pre><br><p>  ,   ,       2 ,       (    )  .        ‚Äî      ,       ‚Äî          ,     ( )     ,    . </p><br><p>      -   ‚Äî   <a href="https://dkazakov8.github.io/exchange_habr/dist/"></a>     . </p><br><h3>   </h3><br><p>     end-to-end   ,     <a href="https://docs.cypress.io/guides/overview/why-cypress.html"></a>    Cypress.       :  ;    ,     ;    Continious Integration. </p><br><p>             javascript    Chai / Sinon ,       .       ,      ,    ‚Äî ./tests,  <i>package.json</i>     ‚Äî <code>"dependencies": { "cypress": "3.2.0" }</code> </p><br><p>            .          Webpack    : </p><br><div class="spoiler"> <b class="spoiler_title">tests/cypress/plugins/index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../../node_modules/@cypress/webpack-preprocessor'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../../webpack-custom/webpack.config'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> options = webpack.defaultOptions; options.webpackOptions.module = webpackConfig.module; options.webpackOptions.resolve = webpackConfig.resolve; on(<span class="hljs-string"><span class="hljs-string">'file:preprocessor'</span></span>, webpack(options)); };</code> </pre></div></div><br><p>           .    <i>module</i> (   )  <i>resolve</i> (          ).   ESLint      ( <i>describe</i> , <i>cy</i> )    <i>eslint-plugin-cypress</i> .    ,       : </p><br><div class="spoiler"> <b class="spoiler_title">tests/cypress/integration/mixed.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'Market Listing good scenarios'</span></span>, () =&gt; { it(<span class="hljs-string"><span class="hljs-string">'Lots of mixed tests'</span></span>, () =&gt; { cy.visit(<span class="hljs-string"><span class="hljs-string">'/market/usd/bch-usd'</span></span>); cy.location(<span class="hljs-string"><span class="hljs-string">'pathname'</span></span>).should(<span class="hljs-string"><span class="hljs-string">'equal'</span></span>, <span class="hljs-string"><span class="hljs-string">'/market/usd/bch-usd'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    ,       cy.wait('@symbolsList') .its('response.body') .should(data =&gt; { expect(data).to.be.an('array'); }); //    cy.wait('@rates'); cy.wait('@marketsList'); cy.wait('@symbolInfo'); cy.wait('@chartData'); //       cy.get('#marketTab-eth').click(); cy.location('pathname').should('equal', '/market/eth/bch-usd'); cy.wait('@rates'); cy.wait('@marketsList'); //    cy.contains(''); cy.get('#langSwitcher-en').click(); cy.contains('Markets list'); //    cy.get('body').should('have.class', 'light'); cy.get('#themeSwitcher-dark').click(); cy.get('body').should('have.class', 'dark'); }); });</span></span></code> </pre></div></div><br><p>      Cypress    fetch,   ,      : </p><br><div class="spoiler"> <b class="spoiler_title">tests/cypress/support/index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { apiRoutes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> polyfill = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; before(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> polyfillUrl = <span class="hljs-string"><span class="hljs-string">'https://unpkg.com/unfetch/dist/unfetch.umd.js'</span></span>; cy.request(polyfillUrl).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { polyfill = response.body; }); }); Cypress.on(<span class="hljs-string"><span class="hljs-string">'window:before:load'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span> =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.fetch; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.eval(polyfill); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.fetch = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.unfetch; }); before(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { cy.server(); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.symbolsList.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'symbolsList'</span></span>); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.rates.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.marketsList.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'marketsList'</span></span>); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.symbolInfo.url({ id: </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'bitcoin-cash'</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> }</span></span></span><span class="hljs-string">)}**`</span></span>).as( <span class="hljs-string"><span class="hljs-string">'symbolInfo'</span></span> ); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.chartData.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'chartData'</span></span>); });</code> </pre></div></div><br><p>  ,       . </p><br><h3>  ,  ? </h3><br><p> ,      - .         ,      ,   -    / - / . </p><br><p>    ,    ,          , - ,   -   ,       (real-time ,  serviceWorker,   CI,   ,       ,  -,  ,     ..). </p><br><p>    ( Gzip)  : </p><br><p><img src="https://habrastorage.org/webt/p6/im/fk/p6imfkqh0-lf8zlr2apy_8zjqcm.png"></p><br><p>     React Developer Tools   : </p><br><p><img src="https://habrastorage.org/webt/im/jn/_l/imjn_lzweyq7yijk7ohnlafcpgo.png"></p><br><p>      React Hooks + MobX   ,   Redux. ,          .           ,  ,      ,          .       .   ! </p><br><p> <a href="https://github.com/dkazakov8/exchange_habr"> </a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/450360/">https://habr.com/ru/post/450360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450332/index.html">How the rendering of The Witcher 3 is implemented: lightning, witches sneak and other effects</a></li>
<li><a href="../45034/index.html">To start or introductory course in esoteric language</a></li>
<li><a href="../450340/index.html">How to analyze a competitor's site for free. Step-by-step instruction</a></li>
<li><a href="../450344/index.html">Under the white flag post, or How I saved your video course from appearing on the tracker</a></li>
<li><a href="../450354/index.html">Announced Windows Vision Skills (Preview)</a></li>
<li><a href="../450362/index.html">Consider agents "Auditor"</a></li>
<li><a href="../450368/index.html">We get the absolute exchange rates from the paired cross-exchange rates</a></li>
<li><a href="../450372/index.html">How Amazon's algorithms determine who should fire</a></li>
<li><a href="../450374/index.html">RAM Expansion Board for Apple IIgs</a></li>
<li><a href="../45038/index.html">Test regular expressions in OnLine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>