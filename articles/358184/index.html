<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Linux Kernel Sequence Files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A characteristic feature of modern programming is in using the global network as a source of reference information, in particular, a source of pattern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Linux Kernel Sequence Files</h1><div class="post__text post__text-html js-mediator-article">  A characteristic feature of modern programming is in using the global network as a source of reference information, in particular, a source of patterns for solving unknown or little-known problems to a specific programmer.  Such an approach saves a lot of time and often gives quite qualitative results.  However, the solutions laid out in the network, although usually correct, do not always take into account all the subtleties of solving a particular problem, which leads to the appearance of sections in codes that usually work correctly, but under not quite standard circumstances become sources of unpleasant surprises. <br><br>  Consider the topic of using sequence files in the Linux kernel.  Such files are considered the most convenient mechanism for printing from kernel mode.  But in practice, using them correctly is much more difficult than you can think about. <br><br>  In the network there are many materials on this topic.  The best is the source code of the kernel itself, with fairly detailed comments.  The problem of this source of information in its scope.  If you do not know exactly what to look for, then it is better to have only a limited time, and not try.  When I became interested in the topic, Google found several seemingly excellent sources of information: the famous book <a href="http://www.tldp.org/LDP/lkmpg/2.6/html/x861.html">The Linux Kernel Module Programming Guide</a> and a <a href="https://www.linux.com/learn/kernel-newbie-corner-kernel-debugging-proc-sequence-files-part-3">series of articles by Rob Day (Rob Day) on the topic of</a> interest.  Sources are not new, but very solid. <br><a name="habracut"></a><br>  Consider first in more detail when it is natural to use sequence files.  The most typical situation is to create your own file in the / proc file system.  Reading the files of this system, you can get a wide variety of information about the hardware used, its drivers, RAM, processes, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It would seem that a printout of anything is the simplest of all that is in programming.  But working in the kernel mode of the OS imposes many limitations that may seem completely unimaginable to the developer of application software.  In kernel mode, the print buffer size is limited by the virtual memory page size.  For architecture, x86 is four kilobytes.  Therefore, a good program when printing out data of a larger volume must first achieve maximum filling of this buffer, then print it out, and then repeat this iteration again until complete printing data is exhausted.  You can, of course, type character by character, which would make everything much simpler, but we are talking about good programs. <br><br>  The above sources were slightly worse than expected.  In the book, for example, some information turned out to be altogether incorrect, and this is what motivated me to write this note.  Incorrect was the easiest for perception and use of the information given in the form of a diagram.  Using such a scheme can lead to serious errors.  Although the example given in the book works correctly and follows this very scheme.  This is due to the fact that in this example, when accessing / proc / iter, only a few bytes are printed at a time.  If you use it as a template for printing texts that are larger than a page of memory, then surprises will arise.  The series of articles mentioned above does not contain obvious errors, but does not report on some details that are important for understanding the topic. <br><br>  So, we first consider the correct scheme of how to work with the file sequence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0t/9q/lf/0t9qlfqbhu3y7x1abgwo-uc4tmu.png"></div><br>  To work with such a file you need to create functions start, stop, next and show.  The names of these functions can be any, chose the shortest and corresponding in meaning.  When these functions are present and properly connected to the kernel systems, they start working automatically when accessing the file associated with them in the / proc directory.  The most confusing is the use of the stop function, which can be called in three different contexts.  Calling it after start means ending the print job.  Calling it after show means that when the last print operation was performed to the buffer (usually the seq_printf function is used for this), the page buffer overflow occurred and this print operation was canceled.  And its call after next is the most interesting case that occurs when printing some data to the buffer ends and you need to either shut down or use new data.  For example, suppose that our file in the / proc directory, when accessing it, first produces some information on block devices, and then on character ones.  First, the start function initializes printing by block devices, and the next function and, possibly, show use this initialization data for the subsequent printing step by step of the necessary information on block devices.  When everything is ready, after the last call to next, the considered case of calling stop will be made, after which start is called, which this time should already initiate further printing on character devices. <br><br>  I will give a slightly modified example (the contents of the file evens.c) from the article by Rob Day.  It had to replace the call of a function, which is absent in modern kernels, with its actual equivalent.  Comments in English replaced by in Russian. <br><br><pre><code class="plaintext hljs">#include &lt;linux/module.h&gt; #include &lt;linux/moduleparam.h&gt; #include &lt;linux/init.h&gt; #include &lt;linux/kernel.h&gt; #include &lt;linux/proc_fs.h&gt; #include &lt;linux/fs.h&gt; #include &lt;linux/seq_file.h&gt; #include &lt;linux/slab.h&gt; static int limit = 10; //  ,     module_param(limit, int, S_IRUGO); //,  ,    static int* even_ptr; //  , ,   //   /** * start */ static void *ct_seq_start(struct seq_file *s, loff_t *pos) { printk(KERN_INFO "Entering start(), pos = %Ld, seq-file pos = %lu.\n", *pos, s-&gt;count); if (*pos &gt;= limit) { // are we done? printk(KERN_INFO "Apparently, we're done.\n"); return NULL; } //   ,        even_ptr = kmalloc(sizeof(int), GFP_KERNEL); if (!even_ptr) //  return NULL; printk(KERN_INFO "In start(), even_ptr = %pX.\n", even_ptr); *even_ptr = (*pos)*2; return even_ptr; } /** * show */ static int ct_seq_show(struct seq_file *s, void *v) { printk(KERN_INFO "In show(), even = %d.\n", *(int*)v); seq_printf(s, "The current value of the even number is %d\n", *(int*)v); return 0; } /** * next */ static void *ct_seq_next(struct seq_file *s, void *v, loff_t *pos) { printk(KERN_INFO "In next(), v = %pX, pos = %Ld, seq-file pos = %lu.\n", v, *pos, s-&gt;count); (*pos)++; //  if (*pos &gt;= limit) //? return NULL; *(int*)v += 2; //    return v; } /** * stop */ static void ct_seq_stop(struct seq_file *s, void *v) { printk(KERN_INFO "Entering stop().\n"); if (v) printk(KERN_INFO "v is %pX.\n", v); else printk(KERN_INFO "v is null.\n"); printk(KERN_INFO "In stop(), even_ptr = %pX.\n", even_ptr); if (even_ptr) { printk(KERN_INFO "Freeing and clearing even_ptr.\n"); kfree(even_ptr); even_ptr = NULL; } else printk(KERN_INFO "even_ptr is already null.\n"); } /** *         */ static struct seq_operations ct_seq_ops = { .start = ct_seq_start, .next = ct_seq_next, .stop = ct_seq_stop, .show = ct_seq_show }; /** *        /proc */ static int ct_open(struct inode *inode, struct file *file) { return seq_open(file, &amp;ct_seq_ops); }; /** *         /proc */ static struct file_operations ct_file_ops = { .owner = THIS_MODULE, .open = ct_open, .read = seq_read, .llseek = seq_lseek, .release = seq_release }; /** *   ,       */ static int __init ct_init(void) { proc_create("evens", 0, NULL, &amp;ct_file_ops); return 0; } /** *   ,       */ static void __exit ct_exit(void) { remove_proc_entry("evens", NULL); } module_init(ct_init); module_exit(ct_exit); MODULE_LICENSE("GPL");</code> </pre> <br>  Functions for working with sequence files use two pointers with overlapping functionality (this is also a somewhat confusing moment).  One of them should point to the current object to be printed into the buffer by the show-v function in the program, and the other (pos) is usually used to point to the counter. <br><br>  For those who may for the first time want to run their program in kernel mode, I give an example Makefile for a successful build.  Of course, for a successful build, you must have Linux kernel source headers in the system. <br><br><pre> <code class="plaintext hljs">obj-m += evens.o all: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules clean: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</code> </pre><br>  Connecting to the kernel is done with the sudo insmod evens.ko command, checking the functionality of the / proc / evens file that appeared after this with the cat / proc / evens command, reading the event log explaining the system operation with the sudo cat / var / log / messages command. <br><br>  In order for the page buffer to overflow, you need to set the limit parameter to a larger value, for example, 200. This value can be entered both in the program text and used when loading the module - sudo insmod evens.ko limit = 200. <br><br>  Log analysis may clarify the remaining unclear points.  For example, you may notice that before calling stop after next or start, the system zeros v.  You may also notice that before calling start after stop, the system prints the contents of the buffer. <br><br>  I would be grateful if someone would report any inaccuracies found in my note or that should be mentioned. <br><br>  Sources can also be found <a href="https://github.com/litwr2/seq-files-linux-kernel">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/358184/">https://habr.com/ru/post/358184/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358174/index.html">Planar transformer: technology, calculations, cost</a></li>
<li><a href="../358176/index.html">Basics of game code optimization</a></li>
<li><a href="../358178/index.html">Antipattern testing software</a></li>
<li><a href="../358180/index.html">Magnasanti - the largest and most terrible city of SimCity</a></li>
<li><a href="../358182/index.html">Use GPG to encrypt messages and files.</a></li>
<li><a href="../358186/index.html">Arduino for beginners. Part 2</a></li>
<li><a href="../358188/index.html">Telegram is trying to get the key transfer order canceled to decrypt user messages.</a></li>
<li><a href="../358190/index.html">CredSSP encryption oracle remediation - error when connecting via RDP to a virtual server (VPS / VDS)</a></li>
<li><a href="../358192/index.html">Marvin Minsky "The Emotion Machine": Chapter 3 "Suffering, pain, grief"</a></li>
<li><a href="../358198/index.html">Notification Center. Tame 200+ mailings</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>