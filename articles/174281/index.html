<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Carberp: an endless story</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The cybercrime group Carberp was one of the first groups that massively used a family of malicious programs aimed at compromising remote banking syste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Carberp: an endless story</h1><div class="post__text post__text-html js-mediator-article">  The cybercrime group Carberp was one of the first groups that massively used a family of malicious programs aimed at compromising remote banking systems and conducting fraudulent operations against the largest banks in Russia.  Many members of the core Carberp group have <a href="http://www.welivesecurity.com/2012/07/02/all-carberp-botnet-organizers-arrested/">already been arrested</a> , but this family of malicious programs is still actively and continues to evolve.  Our colleague <a href="https://twitter.com/matrosov">Alexander Matrosov</a> made an analysis of the latest modification of the Carberp banking Trojan, which we want to present below. <br><br><a name="habracut"></a>  The screenshot shows the statistics of ESET Virus Radar, which shows the regions most affected by Carberp infection during the last month. <br><br><img src="https://habrastorage.org/storage2/1de/e0b/e0d/1dee0be0d6e2970f6c11d272130bb15a.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can see that the <b>region most affected by Carberp is still Russia</b> .  If we look at the history of detection of this malicious code, we will see that <b>the Carberp group was the most active in the spring and summer of 2012</b> .  After the mass arrests in the summer of 2012, the botnet was still active, although the number of detections began to decline. <br><br><img src="https://habrastorage.org/storage2/736/859/7bf/7368597bf6a9a5664be9e6e3a5bad012.png"><br><br>  <b>The Carberp Group still holds the first position among similar groups that are involved in banking fraudulent operations in Russia and Ukraine.</b>  Next we look at the latest, updated version of the bot code, as well as additional plugins that are used by it. <br><br>  <b>The method of introducing malicious code</b> <br><br>  When analyzing one of the latest Carberp droppers, we discovered a special technique for introducing malicious code into trusted processes based on <a href="http://habrahabr.ru/company/eset/blog/174169/">Power Loader</a> .  At the start of its execution, the dropper tries to open one of the public (shared) sections and add the shellcode to the end of one of the sections, the list of which is presented below: <br><br><img src="https://habrastorage.org/storage2/a4c/26c/057/a4c26c057c1b43e0261689df4d6a5925.png"><br><br>  Next, the dropper uses similar methods that Gapz uses, with the exception of small changes in the code. <br><br><img src="https://habrastorage.org/storage2/62e/a9d/983/62ea9d9839928ee7a36f84f1c6032e07.png"><br><br>  At the final stage, the introduction of malicious code into the trusted explorer.exe process is carried out in order to bypass the antivirus software and execute its further actions as a trusted process. <br><br><img src="https://habrastorage.org/storage2/77b/eec/36c/77beec36c78795780433499d95f7f4df.png"><br><br>  This technique is not new and uses the Shell_TrayWnd implementation method, which was already described in some underground Russian forums a few years ago. <br><br>  <b>On-the-fly modification of banking software written in Java</b> <br><br>  We have already described a method for modifying Java code for banking clients in another Trojan family, <b>Win32 / Spy.Ranbyus</b> .  Ranbyus modifies the JVM (Java Virtual Machine) during its execution in order to track the execution of the banking software code.  Carberp modifies Java banking software using the open source Javassist library.  This library allows you to manage java bytecode on the fly (during execution).  Malicious code Carberp uses a modification of this bytecode in one of the most popular online banking systems, <b>BIFIT's iBank 2</b> . <br><br>  In the process of analyzing the latest Carberp sample, the following lines were found that are present in the client software of the online banking system iBank2, with an interesting link to the correction of Java code. <br><br><img src="https://habrastorage.org/storage2/1e1/fed/748/1e1fed748facc931303ab1b57847fdd8.png"><br><br>  After using the iBank2 client on an infected computer, the malicious code loads the additional module AgentX.jar (detected by ESET as <b>Java / Spy.Banker.AB</b> ).  When this module is successfully loaded, Carberp tries to load the Javassist library.  Java / Spy.Banker is a special Carberp component designed to modify payment documents on the fly. <br>  The decompiled Java class, which is used to modify the client's iBank2 code, looks like this: <br><br><img src="https://habrastorage.org/storage2/f27/5c1/1bf/f275c11bf0b100ae557fb5d2697fae88.png"><br><br>  After making changes to iBank2, attackers can control all payments made using this banking software.  BIFIT's iBank2 system does not check the integrity of its code, and after modifying it, it continues to work as if nothing had happened, that is, it can perform cash transaction operations.  But in this case, cash transactions go through the cybercrime group Carberp. <br><br>  The Java / Spy.Banker module has the functionality to bypass the two-factor authentication system using one-time passwords.  The decompiled java class to bypass this check is presented below. <br><br><img src="https://habrastorage.org/storage2/ea2/11e/1c0/ea211e1c0afa98a9309bfd1f0921ce49.png"><br><br>  The decompiled code to confirm the payment in this case is as follows: <br><br><img src="https://habrastorage.org/storage2/e42/c91/798/e42c917986bfcc6f265ef0012caeb51f.png"><br><br>  The AgentX module is not an ordinary malware component, since it does not change the Java system itself, but uses a legitimate library to modify the code.  It presents a certain difficulty in recognizing malicious activity in AgenX.jar without manual analysis of this module.  At the time of this writing, the AgentX.jar module had a very low detection rate. <br><br>  <b>Using legitimate software as a component of malicious code</b> <br><br>  The malicious code described by us, which uses legitimate libraries to perform its functions, is not alone.  Last week <a href="http://blog.crysys.hu/2013/03/teamspy/">, information appeared</a> about a targeted attack that some European countries underwent.  The attack was carried out using a special malicious toolkit TeamSpy.  TeamSpy used the modified components of the well-known TeamViewer software.  ESET discovered this backdoor, which has been used by TeamViewer modules since 2010 ( <a href="http://www.welivesecurity.com/2011/01/14/sheldor-shocked/">Sheldor-Shocked</a> ).  The malicious <b>Win32 / Sheldor code</b> was used by the cybercriminal group Carberp to manually transfer money from infected systems, starting in 2010.  The Carberp group uses other legitimate software for remote access to infected computers;  In the table below we list the variations of such software used by the Carberp group. <br><br><img src="https://habrastorage.org/storage2/684/a2f/528/684a2f528ddf8bfdc3957c25a572328e.png"><br><br>  Using legitimate software tools by cybercrime groups is one of the ways to get remote access to infected systems.  In this case, it greatly complicates the detection of malicious activity.  Malicious code families such as <b>Win32 / Sheldor</b> and <b>Win32 / RDPdoor</b> make some changes to the original components.  At the same time, software such as Mipko and Ammyy are used unchanged.  In some cases, it would be inappropriate to detect legitimate software as malicious, from an antivirus point of view. <br><br>  <b>Conclusion</b> <br><br>  In this post, we summarized the latest changes that were recorded in the activity of the cybercrime group Carberp.  The most interesting changes relate to the Java / Spy.Banker component (AgentX.jar) and the most popular banking software in Russia and Ukraine, which is attacked through a modification of the java-code.  Another interesting observation is the increasing use of legal software as components of malicious code to gain remote access.  In this case, the detection mechanism of such software that would lead to the absence of false positives (false positive) seems to be rather difficult, especially if attackers modify this software every few months. </div><p>Source: <a href="https://habr.com/ru/post/174281/">https://habr.com/ru/post/174281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174259/index.html">The fourth galaxy is here</a></li>
<li><a href="../174267/index.html">Don Jones "Creating a unified IT monitoring system in your environment" Chapter 3. Connecting everything into a single IT management cycle</a></li>
<li><a href="../174269/index.html">Path olympiadnik in industrial programming</a></li>
<li><a href="../174271/index.html">Multipath (multipath) modification for the TCP protocol: the first experiment</a></li>
<li><a href="../174275/index.html">Advanced Active Directory Services WS2012 - information from Microsoft Ex-Architect</a></li>
<li><a href="../174283/index.html">Sloth-driven development</a></li>
<li><a href="../174291/index.html">How to increase turnout in the US presidential election with Azure technology</a></li>
<li><a href="../174293/index.html">Bridging the gap between System Center and VMware with the new Veeam Management Pack 6.0</a></li>
<li><a href="../174295/index.html">Why problems arise in communications in big cities and how they are solved</a></li>
<li><a href="../174297/index.html">Fuel - the world's smallest "emergency" charger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>