<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking open source UEFI for Intel Galileo with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The development of firmware, even if it is not being done in assembler for exotic architectures, but in C for i386 / amd64 is quite a difficult task, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking open source UEFI for Intel Galileo with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/46f/80b/7c0/46f80b7c024a4994bf5dee9057407b7d.png">  The development of firmware, even if it is not being done in assembler for exotic architectures, but in C for i386 / amd64 is quite a difficult task, and the cost of an error can be extremely high, even until the target hardware platform fails, so the use of various error prevention techniques in the very early stages of development - the need. <br><br>  Unfortunately, formal verification or the use of MISRA C in the case of UEFI firmware can only be dreamed of (on the other hand, few people want to spend a couple of years and 50% of the project‚Äôs budget on firmware development), so today we‚Äôll talk about static analysis, or rather the PVS-Studio static analyzer popular on Habr√©, which we will try to find errors in the open source UEFI code for Intel Galileo. <br><br>  For the results of the check, I ask for kat. <br><a name="habracut"></a><br><h4>  <b>Setting up the environment</b> </h4>  As Captain Obviously tells me, to analyze any code, we need the analyzer, the code itself and the build environment for it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The analyzer lies <a href="http://www.viva64.com/ru/pvs-studio-download/">on the site of its developer</a> , after installation we write him a letter asking for a short time to provide the key, which allows seeing not only the first level warnings (namely, this is done in the trial versions), but everything in general - in our case it is better to perebdet than not to finish. <br><br>  The firmware code is part of <a href="http%253A%252F%252Fdownloadmirror.intel.com%252F23197%252Feng%252FBoard_Support_Package_Sources_for_Intel_Quark_v1.1.0.7z">Quark BSP</a> and is based on <abbr title="EFI Development Kit">EDK</abbr> 2010.SR1, like all current implementations of UEFI, with the exception of Apple products. <br><br>  EDK has its own build system, so we will use PVS-Studio Standalone to check the code collected by it.  How to prepare Quark_EDKII package for assembly - <a href="http%253A%252F%252Fdownloadmirror.intel.com%252F23197%252Feng%252Fquark-x1000-bsp-build-sw-rel-user-guide..pdf">read in this document</a> , I will not dwell on it here in more detail. <br><br><h4>  <b>Run analyzer</b> </h4>  We launch PVS-Studio Standalone, click the Analyze your files ... button, the Compiler Monitoring window opens, in which we press the single Start Monitoring button.  Now open the console in the folder with Quark_EDKII and execute the <i>quarkbuild -r32 S QuarkPlatform command</i> to build the release version of the firmware.  We are waiting for the end of the assembly, in the Compiler Monitoring window we observe the increase in the number of detected calls to the compiler, after the end of the assembly we press the Stop Monitoring button and wait for the analysis to finish. <br><br><h4>  <b>Analysis results</b> </h4>  For the current version of Quark_EDKII_v1.1.0, the analyzer displays 96 warnings of the first level, 100 - of the second and 63-third (with default settings, i.e., only General Analysis is selected).  Sort them by the number of warnings and proceed to search for errors. <br><br>  <b>Warning</b> : V521 Such expressions using the ',' operator are dangerous.  Make sure the expression is correct. <br>  <b>File</b> : quarkplatformpkg \ pci \ dxe \ pcihostbridge \ pcihostbridge.c, 181, 272 <br>  <b>Code</b> : <pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TotalRootBridgeFound = <span class="hljs-number"><span class="hljs-number">0</span></span>, IioResourceMapEntry = <span class="hljs-number"><span class="hljs-number">0</span></span>; TotalRootBridgeFound &lt; HostBridge-&gt;RootBridgeCount, IioResourceMapEntry &lt; MaxIIO; IioResourceMapEntry++) {</code> </pre>  <b>Comment</b> : improper use of the comma operator in the condition.  Let me remind you that this operator has the lowest priority, it calculates the values ‚Äã‚Äãof both operands, but itself takes the value of the right one.  In this case, the condition is completely analogous to IioResourceMapEntry &lt;MaxIIO, and the TotalRootBridgeFound &lt;HostBridge-&gt; RootBridgeCount check, although fulfilled, does not affect the continuation or interruption of the cycle. <br>  <b>The proposed fix</b> : replace the comma with &amp;&amp; in the condition. <br><br>  <b>Warning</b> : V524 It is the odd that the body of the AllocateRuntimePages function is fully equivalent to the body of the AllocatePages. <br>  <b>File</b> : mdepkg \ library \ smmmemoryallocationlib \ memoryallocationlib.c, 208 and on <br>  <b>Code</b> : <pre> <code class="hljs vbscript">/** Allocates one <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more <span class="hljs-number"><span class="hljs-number">4</span></span>KB pages of type EfiBootServicesData. Allocates the number of <span class="hljs-number"><span class="hljs-number">4</span></span>KB pages of type EfiBootServicesData <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> returns a pointer <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the allocated buffer. The buffer returned <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> aligned <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> a <span class="hljs-number"><span class="hljs-number">4</span></span>KB boundary. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> Pages <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> returned. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> there <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> enough memory remaining <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> satisfy the <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> returned. @param Pages The number of <span class="hljs-number"><span class="hljs-number">4</span></span> KB pages <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> allocate. @return A pointer <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the allocated buffer <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> allocation fails. **/ VOID * EFIAPI AllocatePages ( <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> UINTN Pages ) { return InternalAllocatePages (EfiRuntimeServicesData, Pages); }</code> </pre>  <b>Comment</b> : The code contradicts the comment and allocates EfiRuntimeServicesData memory instead of the implied EfiBootServicesData.  The difference between them is that the memory of the second type will be automatically released at the end of the <abbr title="Boot device selection">BDS</abbr> phase, and the memory of the first type must be freed by explicitly calling FreeMem before the end of the aforementioned phase, otherwise it will remain inaccessible for the OS forever.  As a result, a seemingly small error can lead to completely incomprehensible memory leaks and the fragmentation of the OS accessible address space. <br>  <b>The proposed fix</b> : replacing the memory type with EfiBootServicesData in all non-Runtime functions of this file. <br><br>  <b>Warning</b> : It is the odd that the body of the OhciSetLsThreshold 'function is fully equivalent to the body of the OhciSetPeriodicStart' function. <br>  <b>File</b> : quarksocpkg \ quarksouthcluster \ usb \ ohci \ pei \ ohcireg.c, 1010, 1015 and quarksocpkg \ quarksouthcluster \ usb \ ohci \ dxe \ ohcireg.c, 1010, 1040 <br>  <b>Code</b> : <pre> <code class="hljs pgsql">EFI_STATUS OhciSetLsThreshold ( <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> USB_OHCI_HC_DEV *Ohc, <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> UINT32 <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> ) { EFI_STATUS Status; Status = OhciSetOperationalReg (Ohc-&gt;PciIo, HC_PERIODIC_START, &amp;<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Status; }</code> </pre>  <b>Comment</b> : another copy-paste victim, this time the HC_PERIODIC_START bit is set and checked instead of HC_LS_THREASHOLD. <br>  <b>Suggested fix</b> : replace the bit with the correct one. <br><br>  <b>Warning</b> : V528 It is odd that the pointer to 'char' type is compared with the '\ 0' value.  Probably meant: * MatchLang! = '\ 0'. <br>  <b>File</b> : quarkplatformpkg \ platform \ dxe \ smbiosmiscdxe \ miscnumberofinstallablelanguagesfunction.c, 95 <br>  <b>Code</b> : <pre> <code class="hljs lua"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (MatchLang = Languages, (*Offset) = <span class="hljs-number"><span class="hljs-number">0</span></span>; MatchLang != <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; (*Offset)++) { // // Seek to the <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> of current <span class="hljs-built_in"><span class="hljs-built_in">match</span></span> language. // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (EndMatchLang = MatchLang; *EndMatchLang != <span class="hljs-string"><span class="hljs-string">'\0'</span></span> &amp;&amp; *EndMatchLang != <span class="hljs-string"><span class="hljs-string">';'</span></span>; EndMatchLang++); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((EndMatchLang == MatchLang + CompareLength) &amp;&amp; AsciiStrnCmp(MatchLang, BestLanguage, CompareLength) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { // // Find the current best Language <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the supported languages // <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } // // best language <span class="hljs-built_in"><span class="hljs-built_in">match</span></span> be <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the supported language. // ASSERT (*EndMatchLang == <span class="hljs-string"><span class="hljs-string">';'</span></span>); MatchLang = EndMatchLang + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre>  <b>Comment</b> : as a result of an error with checking the un-denoted pointer, the cycle became infinite, and only the fact that there was a break saves from looping. <br>  <b>Proposed fix</b> : add missing dereference. <br><br>  <b>Warning</b> : V535 The variable 'Index' is being used for this loop. <br>  <b>File</b> : mdemodulepkg \ core \ pismmcore \ dispatcher.c, 1233, 1269, 1316 <br>  <b>Code</b> : <pre> <code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; HandleCount; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>++) <span class="hljs-comment"><span class="hljs-comment">{ FvHandle = HandleBuffer[Index]; ... for (Index = 0; Index &lt; sizeof (mSmmFileTypes)/sizeof (EFI_FV_FILETYPE); Index++) { ... }</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; AprioriEntryCount; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>++) <span class="hljs-comment"><span class="hljs-comment">{ ... }</span></span> }</code> </pre>  <b>Comment</b> : sample code that works only due to lucky coincidence.  HandleCount in the outer loop is almost always equal to 1, in the mSmmFileTypes array, there is also exactly one element at the moment, and AprioriEntryCount is not less than 1, so the outer loop ends.  It is clear that a completely different behavior was meant, but copy-paste has its own opinion on this. <br>  <b>Suggested fix</b> : introduce independent counters for each cycle. <br><br>  <b>Warning</b> : V547 Expression '(0)&gt; (1 - Dtr1.field.tCMD)' is always false.  Unsigned type value is never &lt;0. <br>  <b>File</b> : quarksocpkg \ quarknorthcluster \ memoryinit \ pei \ meminit.c, 483, 487 <br>  <b>Code</b> : <pre> <code class="hljs rust">#define MMAX(a,b) ((a)&gt;(b)?(a):(b)) ... #pragma pack(<span class="hljs-number"><span class="hljs-number">1</span></span>) typedef <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">union</span></span></span><span class="hljs-class"> {</span></span> uint32_t raw; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> ... uint32_t tCMD :<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/**&lt; bit [5:4] Command transport duration */</span></span> ... } field; } RegDTR1; <span class="hljs-comment"><span class="hljs-comment">/**&lt; DRAM Timing Register 1 */</span></span> #pragma pack() ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mrc_params-&gt;ddr_speed == DDRFREQ_800) { Dtr3.field.tXP = MMAX(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> - Dtr1.field.tCMD); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Dtr3.field.tXP = MMAX(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> - Dtr1.field.tCMD); }</code> </pre>  <b>Comment</b> : the simplest macro and automatic type casting hit back.  Since  tCMD is a bit field of the uint32_t type, then in condition 0&gt; 1 - tCMD both parts will be automatically converted to uint32_t, which will make it false for any tCMD value. <br>  <b>The proposed fix</b> : <pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mrc_params-&gt;ddr_speed == DDRFREQ_800) { Dtr3.field.tXP = Dtr1.field.tCMD &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> ; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Dtr3.field.tXP = Dtr1.field.tCMD &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> - Dtr1.field.tCMD; }</code> </pre> <br>  <b>Warning</b> : V547 Expression 'PollCount&gt; = ((1000 * 1000) / 25)' is always false.  The value range of unsigned char type: [0, 255]. <br>  <b>File</b> : quarksocpkg \ quarksouthcluster \ i2c \ common \ i2ccommon.c, 297 <br>  <b>Code</b> : <pre> <code class="hljs kotlin">UINT8 PollCount; ... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { Data = *((<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> UINT32 *) (UINTN)(Addr)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Data &amp; I2C_REG_RAW_INTR_STAT_TX_ABRT) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Status = EFI_ABORTED; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Data &amp; I2C_REG_RAW_INTR_STAT_TX_OVER) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Status = EFI_DEVICE_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Data &amp; I2C_REG_RAW_INTR_STAT_RX_OVER) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Status = EFI_DEVICE_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Data &amp; I2C_REG_RAW_INTR_STAT_STOP_DET) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Status = EFI_SUCCESS; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } MicroSecondDelay(TI2C_POLL); PollCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PollCount &gt;= MAX_STOP_DET_POLL_COUNT) { Status = EFI_TIMEOUT; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (TRUE);</code> </pre>  <b>Comment</b> : The MAX_STOP_DET_POLL_COUNT macro expands to 40,000, and PollCount cannot be greater than 255, resulting in an infinite loop. <br>  <b>Suggested fix</b> : change the PollCount type to UINT32. <br><br>  <b>Warning</b> : V560 A part of conditional expression is always true: (0x00040000). <br>  <b>File</b> : quarksocpkg \ quarknorthcluster \ library \ intelqnclib \ pciexpress.c, 370 <br>  <b>Code</b> : <pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((QNCMmPci32 (<span class="hljs-number"><span class="hljs-number">0</span></span>, Bus, Device, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Function</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CapOffset + PCIE_LINK_CAP_OFFSET)</span></span></span><span class="hljs-function">) &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">B_QNC_PCIE_LCAP_CPM</span></span></span><span class="hljs-function">) != </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">B_QNC_PCIE_LCAP_CPM</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre>  <b>Comment</b> : instead of the bitwise AND, the logical expression crept into the expression, as a result, the check became useless. <br>  <b>The proposed fix</b> : <pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((QNCMmPci32 (<span class="hljs-number"><span class="hljs-number">0</span></span>, Bus, Device, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Function</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CapOffset + PCIE_LINK_CAP_OFFSET)</span></span></span><span class="hljs-function">) &amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">B_QNC_PCIE_LCAP_CPM</span></span></span><span class="hljs-function">) != </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">B_QNC_PCIE_LCAP_CPM</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  <b>Warning</b> : V560 A part of conditional expression is always true: 0x0FFFFF000. <br>  <b>File</b> : quarksocpkg \ quarknorthcluster \ library \ intelqnclib \ intelqnclib.c, 378 <br>  <b>Code</b> : <pre> <code class="hljs lisp">return QNCPortRead(<span class="hljs-name"><span class="hljs-name">QUARK_NC_HOST_BRIDGE_SB_PORT_ID</span></span>, QUARK_NC_HOST_BRIDGE_HMBOUND_REG) &amp;&amp; HMBOUND_MASK<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre>  <b>Comment</b> : the same as in the previous case, only worse, this time the return value suffered <br>  <b>The proposed fix</b> : <pre> <code class="hljs lisp">return QNCPortRead(<span class="hljs-name"><span class="hljs-name">QUARK_NC_HOST_BRIDGE_SB_PORT_ID</span></span>, QUARK_NC_HOST_BRIDGE_HMBOUND_REG) &amp; HMBOUND_MASK<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  <b>Warning</b> : V560 A part of conditional expression is always true: 0x00400. <br>  <b>File</b> : quarksocpkg \ quarksouthcluster \ usb \ ohci \ pei \ ohcireg.c, 1065 and quarksocpkg \ quarksouthcluster \ usb \ ohci \ dxe \ ohcireg.c, 1070 <br>  <b>Code</b> : <pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Field &amp; (RH_DEV_REMOVABLE <span class="hljs-params"><span class="hljs-params">||</span></span> RH_PORT_PWR_CTRL_MASK)) {</code> </pre>  <b>Comment</b> : this time there was no luck with a beat OR. <br>  <b>The proposed fix</b> : <pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Field &amp; (RH_DEV_REMOVABLE | RH_PORT_PWR_CTRL_MASK)) {</code> </pre> <br>  <b>Warning</b> : V649 There are two "if" statements with identical conditional expressions.  The first 'if' statement contains function return.  This means that the statement is senseless. <br>  <b>File</b> : s: \ quarkplatformpkg \ platform \ dxe \ smbiosmiscdxe \ miscsystemmanufacturerfunction.c, 155 <br>  <b>Code</b> : <pre> <code class="hljs kotlin"> SerialNumStrLen = StrLen(SerialNumberPtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SerialNumStrLen &gt; SMBIOS_STRING_MAX_LENGTH) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EFI_UNSUPPORTED; } ... SKUNumStrLen = StrLen(SKUNumberPtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SerialNumStrLen &gt; SMBIOS_STRING_MAX_LENGTH) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EFI_UNSUPPORTED; } ... FamilyStrLen = StrLen(FamilyPtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SerialNumStrLen &gt; SMBIOS_STRING_MAX_LENGTH) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EFI_UNSUPPORTED; }</code> </pre>  <b>Comment</b> : copy-paste failed again, damn it.  We receive one value, we check another, we have not clear behavior of function. <br>  <b>The proposed fix</b> : <pre> <code class="hljs objectivec"> SerialNumStrLen = StrLen(SerialNumberPtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SerialNumStrLen &gt; SMBIOS_STRING_MAX_LENGTH) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EFI_UNSUPPORTED; } ... <span class="hljs-built_in"><span class="hljs-built_in">SKUNumStrLen</span></span> = StrLen(<span class="hljs-built_in"><span class="hljs-built_in">SKUNumberPtr</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">SKUNumStrLen</span></span> &gt; SMBIOS_STRING_MAX_LENGTH) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EFI_UNSUPPORTED; } ... FamilyStrLen = StrLen(FamilyPtr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FamilyStrLen &gt; SMBIOS_STRING_MAX_LENGTH) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EFI_UNSUPPORTED; }</code> </pre> <br><h4>  <b>Conclusion</b> </h4>  I tried to select only obviously erroneous code, not paying attention to problems like the dangerous use of shift operators, reassignment of the same variable, conversion of literals and integer type variables into pointers, etc., that speak about low code quality rather than there is an error in it, but even so the list was quite impressive.  Projects for desktop motherboards are on average 4-5 times larger (about 4000 compiler calls on the counter in the Monitoring window instead of 800 in our case), and there are the same typical errors. <br><br>  Unfortunately, Intel has not yet posted the source code Quark_EDKII on GitHub, so I haven‚Äôt sent pull requests for this project to anyone yet.  Perhaps <a href="https://habr.com/users/izard/" class="user_link">izard</a> is aware of who exactly is responsible for the project in Intel and who should be sent a link in order for the bugs to be fixed. <br><br>  Thanks to the readers for their attention, and to the developers of PVS-Studio for the useful program and the test key. </div><p>Source: <a href="https://habr.com/ru/post/258721/">https://habr.com/ru/post/258721/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258709/index.html">Transparent transition PgQ -> RabbitMQ</a></li>
<li><a href="../258711/index.html">Podcast "Five Minute PHP"</a></li>
<li><a href="../258715/index.html">The long-awaited domestic processor Baikal-T1 was released</a></li>
<li><a href="../258717/index.html">Windows Preinstallation Network Download Guide (WinPE)</a></li>
<li><a href="../258719/index.html">Remote user experience: Windows Server 2012R2 RDS and Azure RemoteApp</a></li>
<li><a href="../258723/index.html">Entity Framework and performance, second attempt</a></li>
<li><a href="../258725/index.html">How Valera took a trainee team and started teaching him how to design</a></li>
<li><a href="../258727/index.html">Project "Oberon 2013"</a></li>
<li><a href="../258729/index.html">Registration is now open for the third annual championship for developers of the Russian Developers Cup</a></li>
<li><a href="../258731/index.html">Google WebFonts and FontFaceObserver. Use third-party fonts on your website</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>