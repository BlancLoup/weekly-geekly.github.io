<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hide 1C for the fireproof wall</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many system administrators, thinking about the security of their company's data and, in particular, about the security of the 1C database, neglect a s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hide 1C for the fireproof wall</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/e9e78dcb/9d670eb9/a313f7c1/a1859fdb.png" alt="image" align="left">  Many system administrators, thinking about the security of their company's data and, in particular, about the security of the 1C database, neglect a simple but effective solution - isolate the server from users.  This article analyzes security threats arising when placing the client part of 1C and 1C servers in one network segment, and discusses the process of transferring the server part of 1C to another network segment.  This article does not contain fundamentally new solutions, but can serve as a reference tool that combines information from various sources. <br><a name="habracut"></a><br><h5>  Initial data </h5><br><ul><li>  1C Enterprise 8 client-server version; </li><li>  1C Enterprise server deployed on the basis of the operating system Windows Server 2003; </li><li>  1C Enterprise uses a dedicated MS SQL server deployed based on the Windows Server 2003 operating system; </li><li>  user access to 1C through terminal servers deployed based on Windows Server 2003; </li><li>  all servers are located in a segment of a single network deployed based on an Active Directory domain. </li></ul><br><h5>  Security threats </h5><br>  To identify security threats, we draw up a traffic flow pattern in the existing network. <br><img src="https://habrastorage.org/storage/24dc73b9/cb460143/6eebc97b/84c3d3b5.png" alt="image"><br>  <b>Figure 1. Initial traffic flows</b> <br><br>  Notes to illustration <br><ul><li>  By "LDAP" is meant not one port, but a collection.  Ports and protocols used in Active Directory are described in the Microsoft Knowledge Base article Services and Network Ports in Microsoft Windows Server Systems.  Depending on what the terminal server requires from the domain controller, these may be different sets.  In this article I will use the following set of ports and protocols: <br><table><tbody><tr><td>  <b>Port</b> </td><td>  <b>Protocol</b> </td><td>  <b>Purpose</b> </td></tr><tr><td>  88 </td><td>  UDP </td><td>  Kerberos.  This port listens on the lsass.exe process (Local Security Authority Service). </td></tr><tr><td>  135 </td><td>  Tcp </td><td>  RPC </td></tr><tr><td>  139 </td><td>  Tcp </td><td>  NetBIOS Session Service </td></tr><tr><td>  389 </td><td>  TCP / UDP </td><td>  Domain Controller Locator </td></tr><tr><td>  445 </td><td>  Tcp </td><td>  SMB </td></tr><tr><td>  1025 </td><td>  Tcp </td><td>  Used by the lsass.exe process.  More information <a href="http://support.microsoft.com/kb/224196/en-us">here</a> . </td></tr><tr><td>  - </td><td>  ICMP </td><td>  ICMP is used to obtain various information, so packets of this protocol must freely pass in the direction of the domain controllers. </td></tr></tbody></table><br><br>  This list is enough to log in to the domain and run netlogon scripts. </li><li>  By "SMB" is meant a set of ports through which the file exchange via the SMB protocol is implemented.  This set of ports is a subset of the ‚ÄúLDAP‚Äù set and is shown in places for clarity. </li><li>  By ‚ÄúRDP‚Äù is meant connection via RDP protocol.  Ports 3389: 3390 are used for this (why two are described below). </li><li>  By "1C" refers to the ports necessary for the 1C client to work with the server.  These are ports 1541, 1560: 1591 (Information about ports is obtained from ‚Äú1C: Enterprise 8.2 - Client-server version of the Administrator's Guide‚Äù). </li><li>  By ‚ÄúMS SQL‚Äù is meant the port for working with MS SQL Server (by default, port 1433). </li></ul><br>  What we have: <br><ul><li>  Windows Server 2003 operating system has vulnerabilities that are not related to 1C and MS SQL, but attacks using these vulnerabilities can help to gain control over the data of the listed applications; </li><li>  users can transfer files from a remote session to computers on the network via SMB protocol; </li><li>  various network viruses also pose security risks; </li><li>  since users are in the same network segment with servers, especially smart ones can try to connect to them via MS SQL and 1C ports. </li></ul><br><h5>  Tasks </h5><br><ol><li>  Minimize the risks of implementation of operating system vulnerabilities. </li><li>  Make it impossible to transfer files using SMB protocol from terminal servers to users' computers. </li><li>  Exclude the possibility of user access to the servers 1C and MS SQL. </li><li>  Minimize the number of users who can transfer files to their computers using the RDP protocol. </li></ol><br><h6>  Requirements for implementation </h6><br>  Provide simplicity and ease of use of 1C Enterprise resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Decision </h5><br>  Let's make the scheme of movement of necessary traffic flows. <br><img src="https://habrastorage.org/storage/7b2e695e/634009fe/0da61a29/129a11a6.png" alt="image"><br>  <b>Figure 2. Required traffic flows</b> <br>  As you can see, for the full functioning of 1C you need not so much. <br><table><tbody><tr><td>  <b>Computer</b> </td><td>  <b>Outgoing connections</b> </td><td>  <b>Inbound connections</b> </td></tr><tr><td>  AD DC </td><td>  Not required </td><td>  All network computers </td></tr><tr><td>  1C server </td><td>  Database Server 1C </td><td>  Terminal servers </td></tr><tr><td>  Database Server 1C </td><td>  Not required </td><td>  1C server </td></tr><tr><td>  Terminal servers </td><td>  1C server </td><td>  Users </td></tr></tbody></table><br>  The table shows that the network can be divided into three segments: <br><ol><li>  "Server 1C" + "Database Server 1C"; </li><li>  "Terminal Servers"; </li><li>  "Users" + "AD DC". </li></ol><br>  Next, I will use the terminology from the <a href="http://www.cse-cst.gc.ca/its-sti/publications/itsg-csti/itsg38-eng.html">Information Technology Security Guideline.</a>  <a href="http://www.cse-cst.gc.ca/its-sti/publications/itsg-csti/itsg38-eng.html">Network Security Zoning</a> : <br>  <i>Operation Zone (OZ) is a standard environment for everyday operations, in which most user systems and servers are located.</i>  <i>Confidential information can be processed here, but it is not suitable for storing large amounts of confidential information or for critical applications.</i> <i><br></i>  <i>Restricted Zone (RZ) - provides a controlled network environment for critical services or for large amounts of confidential information.</i> <br>  To perform tasks 1-3, we divide the network into several zones: <br><ol><li>  RZ1C - this zone will include ‚Äú1C Server‚Äù and ‚ÄúDB 1C Server‚Äù. </li><li>  RZTS - this zone will include terminal servers. </li><li>  OZ - the AD DC domain controller and users will enter this zone. </li></ol><br>  Traffic will be regulated by a router, in which we will enter the necessary rules. <br><img src="https://habrastorage.org/storage/7ccb500e/11d47ce8/60453537/38a93aa0.png" alt="image"><br>  <b>Figure 3. Network zoning scheme</b> <br>  To solve problem 4, do the following: <br><ul><li>  we will create a new connection on each terminal server in addition to the standard one, it will function on port 3390; </li><li>  let's allow all users to connect to port 3389 and only TerminalDisk users to port 3390; </li><li>  in the properties of connections on terminal servers, disable the ability for clients to mount local disks on port 3389 and allow local disks on port 3390. </li></ul><br>  In this way, we can only allow local users to mount local disks. <br><br><h5>  Implementation </h5><br><h6>  Routing </h6><br>  As a router in this article, I will use a computer with three network cards with the operating system of the GNU / Linux family.  Routing software - iptables.  The iptables configuration script is shown below. <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo 1 &gt; /proc/sys/net/ipv4/ip_forward OZ=192.168.0.0/24 RZTS=192.168.2.0/24 RZ1C=192.168.1.0/24 ADDC=192.168.0.1 #     iptables ‚ÄìF iptables ‚ÄìX iptables ‚Äì-flush #     iptables ‚ÄìP INPUT DROP iptables ‚ÄìP OUTPUT DROP iptables ‚ÄìP FORWARD DROP #     ESTABLISHED  RELATED   TCP  UDP iptables ‚ÄìA FORWARD ‚Äìp tcp ‚Äìm state --state ESTABLISHED,RELATED ‚Äìj ACCEPT iptables ‚ÄìA FORWARD ‚Äìp udp ‚Äìm state --state ESTABLISHED,RELATED ‚Äìj ACCEPT #   RDP   OZ-&gt;RZTS iptables ‚ÄìA FORWARD --src $OZ --dst $RZTS ‚Äìp tcp --dport 3389:3390 ‚Äìj ACCEPT #  DNS-   RZTS-&gt;ADDC, RZ1C-&gt;ADDC iptables -A FORWARD ‚Äì-src $RZTS --dst $ADDC -p udp --dport 53 -j ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C ‚Äì-dst $ADDC ‚Äìp udp --dport 53 ‚Äìj ACCEPT #    Active Directory iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp udp --dport 88 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp udp --dport 88 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp tcp --dport 135 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp tcp --dport 135 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp tcp --dport 139 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp tcp --dport 139 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp tcp --dport 389 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp tcp --dport 389 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp udp --dport 389 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp udp --dport 389 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp tcp --dport 445 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp tcp --dport 445 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp tcp --dport 1025 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp tcp --dport 1025 ‚Äìj ACCEPT #   1 iptables ‚ÄìA FORWARD --src $RZTS --dst $RZ1C ‚Äìp tcp --dport 1541 ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZTS --dst $RZ1C ‚Äìp tcp --dport 1560:1591 ‚Äìj ACCEPT #  ,    iptables ‚ÄìA FORWARD --src $RZTS --dst $ADDC ‚Äìp icmp ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $RZ1C --dst $ADDC ‚Äìp icmp ‚Äìj ACCEPT iptables ‚ÄìA FORWARD --src $OZ --dst $ADDC ‚Äìp icmp ‚Äìj ACCEPT # REJECT   iptables ‚ÄìA FORWARD ‚Äìj REJECT # REJECT   iptables ‚ÄìA INPUT ‚Äìj REJECT</span></span></code> </pre> <br><br><h6>  Script Notes </h6><br>  The DROP action simply ‚Äúdrops‚Äù the packet and iptables ‚Äúforgets‚Äù about its existence.  ‚ÄúDiscarded‚Äù packages stop their movement completely, i.e.  they are not transferred to other tables, as is the case with the ACCEPT action.  It should be remembered that this action can have negative consequences, since it can leave unclosed "dead" sockets both on the server side and on the client side, the best method of protection would be to use the REJECT action especially when protecting against port scans ( <a href="http://www.opennet.ru/docs/RUS/iptables/">Iptables Tutorial</a> ). <br><br>  If the HASP keys are not installed on the terminal server and the license manager is located on another network, you need to perform several actions. <br><ol><li>  Allow UDP and TCP packets to pass through the router on port 475 in the two-way direction License_server &lt;-&gt; Client_1C. <br><br> <code>iptables ‚ÄìA FORWARD --src _ --dst _ ‚Äìp udp --dport 475 ‚Äìj ACCEPT <br> iptables ‚ÄìA FORWARD --src _ --dst _ ‚Äìp tcp --dport 475 ‚Äìj ACCEPT <br> iptables ‚ÄìA FORWARD ‚Äì-src _ --dst _ ‚Äìp udp --sport 475 ‚Äìj ACCEPT <br> iptables ‚ÄìA FORWARD ‚Äì-src _ --dst _ ‚Äìp tcp --sport 475 ‚Äìj ACCEPT <br></code> <br></li><li>  Specify the address of the license server in the nethasp.ini file (should be located in the same directory with the executable file of the program). <br> <code>--------------------- nethasp.ini------------------------------- <br> [NH_COMMON] <br> NH_TCPIP = Enabled <br> ... <br> [NH_TCPIP] <br> NH_SERVER_ADDR = 168.192.1.10 // ip- ,    . <br> NH_TCPIP_METHOD = TCP <br> NH_USE_BROADCAST = Disabled <br> --------------------------------------------------------------- <br></code> </li></ol><br><br><h6>  Map Local Client Disks </h6><br>  Through visual wizards, we cannot simply add a new listening port on the terminal server: for this, these connections must be available from different interfaces or using different protocols, which is what the error that appears when trying to deceive fate says. <br><img src="https://habrastorage.org/storage/a2e6bd7f/0fa9a9c4/54b5159d/364b1c3a.png" alt="image"><br>  <b>Figure 4. Attempting to create a new connection with existing parameters</b> <br>  However, we are not satisfied with this scenario. <br>  <code>HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\_</code> connection is named ‚ÄúRDP-Tcp‚Äù, and information about it is stored in the registry key <code>HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\_</code> <br>  To create a new connection, you must: <br><ul><li>  export the specified registry branch to a file with the extension * .reg; </li><li>  open this file with a text editor; </li><li>  change in the export file <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\_</code> to <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\_2</code> </li><li>  find the PortNumber line in the export file and change the numeric value to 0xd3e (3390 in the decimal system, although any other can be used); </li><li>  import the resulting file into the registry. </li></ul><br>  After the described manipulations, we will create a <code>TerminalDisk</code> group and add to it those whom we will entrust the local disk mapping. <br>  Then, in the properties of our new connection, we indicate that only the <code>TerminalDisk</code> group can connect to it and allow the mapping of local disks, and in the properties of the old connection, we prohibit the mapping of disks and the clipboard. <br><br><h5>  Conclusion </h5><br>  In the future, you can strengthen the scheme by introducing an intrusion detection system. <br>  That's all.  I hope someone this material will be useful.  Regards and best regards. <br><br><h5>  Sources </h5><br><ol><li>  Information Security Technology Guideline (ITSG-38) - Network Security Zoning (Design Considerations for Services within Zones) - <a href="http://www.cse-cst.gc.ca/its-sti/publications/itsg-csti/itsg38-eng.html">http://www.cse-cst.gc.ca/its-sti/publications/itsg-csti/itsg38- eng.html</a> . </li><li>  Services and network ports in Microsoft Windows server systems - <a href="http://support.microsoft.com/kb/832017">http://support.microsoft.com/kb/832017</a> . </li><li>  Restricting Active Directory replication traffic to a specific port - <a href="http://support.microsoft.com/kb/224196/en-us">http://support.microsoft.com/kb/224196/en-us</a> . </li><li>  Guide to iptables (iptables Tutorial 1.1.19) - <a href="http://www.opennet.ru/docs/RUS/iptables/">http://www.opennet.ru/docs/RUS/iptables/</a> . </li><li>  How can I add a new RDP terminal server to Windows 2000/2003?  - <a href="http://www.petri.co.il/add_a_new_rdp_listening_port_to_terminal_server.htm">http://www.petri.co.il/add_a_new_rdp_listening_port_to_terminal_server.htm</a> . </li><li>  1C: Enterprise 8.2.  Client-server option.  Admin Guide. </li><li>  1C typical problems when working with HASP - <a href="http://itunion.com.ua/article.php%3Fid%3D39">http://itunion.com.ua/article.php?id=39</a> . </li></ol></div><p>Source: <a href="https://habr.com/ru/post/122037/">https://habr.com/ru/post/122037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122031/index.html">Interview Mark Shuttleworth: in Ubuntu, the default browser will be Google Chrome</a></li>
<li><a href="../122033/index.html">Kinect for Windows SDK beta</a></li>
<li><a href="../122034/index.html">PDF rendering using HTML5 and JavaScript (pdf.js)</a></li>
<li><a href="../122035/index.html">Startup from scratch: the story of Github</a></li>
<li><a href="../122036/index.html">Arrays vs containers in matmodelling problems</a></li>
<li><a href="../122038/index.html">Automatically add files to the WiX installer</a></li>
<li><a href="../122039/index.html">UserEcho visualization flexibly transforms to customer requests</a></li>
<li><a href="../122042/index.html">Introducing Evernote for Windows Phone 7</a></li>
<li><a href="../122043/index.html">Approach to testing code in real life. Part two</a></li>
<li><a href="../122044/index.html">One of the users of the Bitcoin system stole 25 thousand "coins" (approximately 300 thousand US dollars)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>