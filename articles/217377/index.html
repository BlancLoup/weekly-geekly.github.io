<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Find people in photos on Android using OpenCV</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I ran into one interesting puzzle for the mobile ‚Äúhorse‚Äù on Android ‚Äî it is necessary to determine the outlines of the people in the photogr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Find people in photos on Android using OpenCV</h1><div class="post__text post__text-html js-mediator-article">  Recently, I ran into one interesting puzzle for the mobile ‚Äúhorse‚Äù on Android ‚Äî it is necessary to determine the outlines of the people in the photographs (if there were any, naturally).  After searching the Internet, it was decided to use the open source project <a href="http://opencv.org/">OpenCV</a> , which can work on the Android platform. <br><br>  Much has already been <a href="http://habrahabr.ru/search/%3Fq%3DOpenCV">written</a> about him, but this subject was not found by me and was collected from several sources and personal observations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e4/52a/18c/7e452a18c70043ce3180fd78a7759d08.jpg" width="575"></div><br><a name="habracut"></a><br><h3>  Customization </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/126/665/304/1266653044ab64eff74a3644cb9e3762.png" alt="folders" align="right">  A small description of how to include the library in a project on Android Studio (using gradle): <br>  To get started, you need to download the latest version of the library from the <a href="http://sourceforge.net/projects/opencvlibrary/files/opencv-android/2.4.8/OpenCV-2.4.8-android-sdk.zip/download">site</a> and copy the contents of the <code>OpenCV-2.4.8-android-sdk/sdk/java</code> folder from the archive to the <code>libs/OpenCV</code> folder of your project (create if necessary). <br>  Next we connect this module to the <b>gradle</b> files: <br>  In the root project folder, edit <code>settings.gradle</code> and add our module: <br><pre> <code class="java hljs">include <span class="hljs-string"><span class="hljs-string">':app'</span></span>,<span class="hljs-string"><span class="hljs-string">':app:libs:OpenCV'</span></span></code> </pre><br>  In the build gradle file of our application (not in the root file, but <code>app/build.gradle</code> ) we add the line <code>compile project(':app:libs:OpenCV')</code> to the <code>dependencies</code> section in order to get: <br><pre> <code class="java hljs">dependencies { compile <span class="hljs-string"><span class="hljs-string">'com.android.support:appcompat-v7:+'</span></span> <span class="hljs-function"><span class="hljs-function">compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">':app:libs:OpenCV'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> }</span></span></code> </pre><br>  And create the build.gradle file in the OpenCV folder with the code: <br><pre> <code class="java hljs">buildscript { repositories { mavenCentral() } dependencies { classpath <span class="hljs-string"><span class="hljs-string">'com.android.tools.build:gradle:0.6.+'</span></span> } } apply plugin: <span class="hljs-string"><span class="hljs-string">'android-library'</span></span> repositories { mavenCentral(); } android { compileSdkVersion <span class="hljs-number"><span class="hljs-number">19</span></span> buildToolsVersion <span class="hljs-string"><span class="hljs-string">"19"</span></span> defaultConfig { minSdkVersion <span class="hljs-number"><span class="hljs-number">8</span></span> targetSdkVersion <span class="hljs-number"><span class="hljs-number">19</span></span> } sourceSets { main { manifest.srcFile <span class="hljs-string"><span class="hljs-string">'AndroidManifest.xml'</span></span> java.srcDirs = [<span class="hljs-string"><span class="hljs-string">'src'</span></span>] resources.srcDirs = [<span class="hljs-string"><span class="hljs-string">'src'</span></span>] aidl.srcDirs = [<span class="hljs-string"><span class="hljs-string">'src'</span></span>] renderscript.srcDirs = [<span class="hljs-string"><span class="hljs-string">'src'</span></span>] res.srcDirs = [<span class="hljs-string"><span class="hljs-string">'res'</span></span>] assets.srcDirs = [<span class="hljs-string"><span class="hljs-string">'assets'</span></span>] } } }</code> </pre><br>  Well, as a matter of fact, that's all, the OpenCV Android SDK is connected and we can proceed to the implementation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Installing libraries on the device </h3><br>  At the first stage of exploring OpenCV, I was confused by some feature of working under Android ‚Äî the need to install the <a href="https://play.google.com/store/apps/details%3Fid%3Dorg.opencv.engine%26hl%3Dru">OpenCV Manager</a> application separately, with which your creation will interact directly.  Quite a strange decision, because it will be necessary to explain to the end user the fact that in order to use your application he will need to install another program in the market (the user will redirect your application directly, which will not let a person get lost, but it can still scare him away) . <br><br>  There is another way to connect: <a href="http://docs.opencv.org/trunk/doc/tutorials/introduction/android_binary_package/dev_with_OCV_on_Android.html">static initialization</a> , but the developers claim that it exists only for development purposes and, as it seems to me, can be removed in new versions (it‚Äôs mostly for development purposes. release package is recommended to communicate with OpenCV Manager via the async initialization described above.). <br><br>  But in the context of this article, we only benefit from it.  no need to mess around with connecting <a href="http://habrahabr.ru/post/203014/">NDK</a> and building / connecting sish libraries into a project.  So let's continue. <br><br>  To install OpenCV Manager on the emulator, we will use the adb utility from our Android SDK.  To do this, start the virtual device, wait for it to load and execute the command: <br>  <code>/PATH_TO_ANDROID_SDK/platform-tools/adb install /PATH_TO_OPENCV/OpenCV-2.4.8-android-sdk/apk/OpenCV_2.4.8_Manager_2.16_armv7a-neon.apk</code> (by selecting the appropriate one under the ABI apk). <br><br><h3>  Work with images </h3><br>  All OpenCV initialization in the application consists in implementing the BaseLoaderCallback interface callback, where there is one onManagerConnected method in which we can and can already start working with OpenCV, and calling the static OpenCVLoader.initAsync method, passing in the required parameters (including callback).  If your application does not find OpenCV Manager, then ask the user to install it.  Connection: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); <span class="hljs-comment"><span class="hljs-comment">//    OpenCVLoader.initAsync(OpenCVLoader.OPENCV_VERSION_2_4_8, this, mLoaderCallback); } private BaseLoaderCallback mLoaderCallback = new BaseLoaderCallback(this) { @Override public void onManagerConnected(int status) { switch (status) { case LoaderCallbackInterface.SUCCESS: { //   OpenCV } break; default: { super.onManagerConnected(status); } break; } } };</span></span></code> </pre><br>  Now we can safely work with our library. <br><br>  In this example, we create a Bitmap from the url of the photo, then translate it into an OpenCV Mat object (image matrix), convert it from color to grayscale (this is required for the analyzer) and call the static method of the <code>HOGDescriptor.detectMultiScale</code> object (to which we first add a standard human detector contours from the <code>HOGDescriptor.getDefaultPeopleDetector</code> method).  After the call, the locations variable will contain objects of rectangular areas where people are located (x, y, width, height), and in weights - search relevance (but, as practice has shown, it does not quite correspond to reality with such images). <br><br>  For simplicity, I uploaded photos to facebook and combined the methods of uploading and processing photos into one.  Method code itself: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">peopleDetect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( String path )</span></span></span><span class="hljs-function"> </span></span>{ Bitmap bitmap = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> execTime; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   URL url = new URL( path ); HttpURLConnection connection = (HttpURLConnection) url.openConnection(); connection.setDoInput(true); connection.connect(); InputStream input = connection.getInputStream(); BitmapFactory.Options opts = new BitmapFactory.Options(); opts.inPreferredConfig = Bitmap.Config.ARGB_8888; bitmap = BitmapFactory.decodeStream(input, null, opts); long time = System.currentTimeMillis(); //     OpenCV       Mat mat = new Mat(); Utils.bitmapToMat(bitmap, mat); //    RGB    Imgproc.cvtColor(mat, mat, Imgproc.COLOR_RGB2GRAY, 4); HOGDescriptor hog = new HOGDescriptor(); //         MatOfFloat descriptors = HOGDescriptor.getDefaultPeopleDetector(); hog.setSVMDetector(descriptors); //  ,       ( locations -  , weights -  (  )  ) MatOfRect locations = new MatOfRect(); MatOfDouble weights = new MatOfDouble(); //  ,   .    locations  weights hog.detectMultiScale(mat, locations, weights); execTime = ( (float)( System.currentTimeMillis() - time ) ) / 1000f; //      Point rectPoint1 = new Point(); Point rectPoint2 = new Point(); Scalar fontColor = new Scalar(0, 0, 0); Point fontPoint = new Point(); //    -          if (locations.rows() &gt; 0) { List&lt;Rect&gt; rectangles = locations.toList(); int i = 0; List&lt;Double&gt; weightList = weights.toList(); for (Rect rect : rectangles) { float weigh = weightList.get(i++).floatValue(); rectPoint1.x = rect.x; rectPoint1.y = rect.y; fontPoint.x = rect.x; fontPoint.y = rect.y - 4; rectPoint2.x = rect.x + rect.width; rectPoint2.y = rect.y + rect.height; final Scalar rectColor = new Scalar( 0 , 0 , 0 ); //      Core.rectangle(mat, rectPoint1, rectPoint2, rectColor, 2); Core.putText(mat, String.format("%1.2f", weigh), fontPoint, Core.FONT_HERSHEY_PLAIN, 1.5, fontColor, 2, Core.LINE_AA, false); } } fontPoint.x = 15; fontPoint.y = bitmap.getHeight() - 20; //     Core.putText(mat, "Processing time:" + execTime + " width:" + bitmap.getWidth() + " height:" + bitmap.getHeight() , fontPoint, Core.FONT_HERSHEY_PLAIN, 1.5, fontColor, 2, Core.LINE_AA, false); Utils.matToBitmap( mat , bitmap ); } catch (IOException e) { e.printStackTrace(); } return bitmap; }</span></span></code> </pre><br>  At the exit, we get a bitmap with areas of supposed finding of people superimposed on it, the weight of this search result and some additional information.  The processing speed of one photo (up to a thousand pixels in width and height) on the Samsung Galaxy S3 is about 1-6 seconds.  Below are search results with runtime. <br><br>  <b>In the first photo, the analyzer did not find a single person, as we would not like</b> <br>  Image-1.jpg width: 488 height: 420 executionTime: 1.085 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/829/8c9/963/8298c9963eed721dabb0548dba577d1b.jpg" alt="image" width="575"></div><br><br>  <b>Further, the result is better, but also not</b> <br>  Image-2.jpg width: 575 height: 400 executionTime: 1.226 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ed/4b1/5e2/9ed4b15e27210383ddb529cc1cb3d400.jpg" alt="image" width="575"></div><br><br>  <b>Yes, and the third disappoint</b> <br>  Image-3.jpg width: 618 height: 920 executionTime: 6.459 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/043/5f7/8ce/0435f78ce1c69af632f97d30df997b47.jpg" alt="image" width="575"></div><br><br>  <b>Already something</b> <br>  Image-4.jpg width: 590 height: 505 executionTime: 3.084 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/948/0a3/90d/9480a390d632c132da401f7b9f4b3bd8.jpg" alt="image" width="575"></div><br><br>  <b>Turning to a more ‚Äúlive‚Äù photo, the result was a bit unexpected for me.</b> <br>  Image-5.jpg width: 604 height: 453 executionTime: 1.913 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c6/8fe/001/3c68fe001843de9e79d3036ac3599d24.jpg" alt="image" width="575"></div><br><br>  <b>Monument partially recognized</b> <br>  Image-6.jpg width: 960 height: 643 executionTime: 4.106 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c5/e3b/a7d/6c5e3ba7d5e592b57420699d29e9704b.jpg" alt="image" width="575"></div><br><br>  <b>And here is the first photo that really shows why the library is ‚Äúsharpened‚Äù</b> <br>  Image-7.jpg width: 960 height: 643 executionTime: 2.638 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/16f/904/1a5/16f9041a536b452f38813b6a556d7cf5.jpg" alt="image" width="575"></div><br><br>  <b>In clear contrast, did not get the desired effect.</b> <br>  Image-8.jpg width: 960 height: 857 executionTime: 3.293 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dde/c3c/bbb/ddec3cbbb7efd17bc56e8c1bc24add16.jpg" alt="image" width="575"></div><br><br>  <b>Nothing defined here</b> <br>  Image-9.jpg width: 960 height: 642 executionTime: 2.264 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/893/874/f25/893874f2508953287179ff928eca5337.jpg" alt="image" width="575"></div><br><br>  <b>Photography with people in the background</b> <br>  Image-10.jpg width: 960 height: 643 executionTime: 2.188 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/162/03c/9d9/16203c9d9af1c21e768943dff0254f2a.jpg" alt="image" width="575"></div><br><br>  <b>Close-up but without success</b> <br>  Image-11.jpg width: 960 height: 639 executionTime: 2.273 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b91/b9b/fcc/b91b9bfcc5d8f44adf378f2b4a3223cf.jpg" alt="image" width="575"></div><br><br>  <b>Instead of four, a little more.</b> <br>  Image-12.jpg width: 960 height: 640 executionTime: 2.669 <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/022/970/499/022970499ef2fc73abff04e3ffaa8c11.jpg" alt="image" width="575"></div><br><br>  As can be seen from the obtained results, the library is more designed to identify photos / videos from surveillance cameras, where you can select an object and confirm it with the following frames, and for photos, with previously unknown plans, gives a fairly large recognition error (you can filter by weight, but then risk losing a lot of images).  The speed of image analysis does not allow using OpenCV for a large number of photos, and even when working in real time, at given powers and algorithms, it may not keep pace with the flow of frames. <br><br>  For my purposes, the library did not fit, but maybe my mini research will be useful for you. <br><br>  Thanks for reading! <br><br>  Project on <a href="https://github.com/gektor650/DetectPeopleOpenCV">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/217377/">https://habr.com/ru/post/217377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217363/index.html">Spatial parameters of the average habrauser</a></li>
<li><a href="../217365/index.html">No block! Nowhere to retreat - behind offline</a></li>
<li><a href="../217369/index.html">Weekday automation or ‚ÄúI need a program for 3D packaging‚Äù</a></li>
<li><a href="../217371/index.html">Own company - a year long race</a></li>
<li><a href="../217375/index.html">Quine in assembler? It's simple</a></li>
<li><a href="../217379/index.html">Create a ‚ÄúDelightful‚Äù Product (Minimum Delightful Product)</a></li>
<li><a href="../217381/index.html">We are friends with a regular Volvo speakerphone with Russian letters</a></li>
<li><a href="../217385/index.html">Remote installation of programs on Windows (XP SP3 and newer) without using third-party utilities</a></li>
<li><a href="../217387/index.html">Cocos2D-X and so easy on all devices</a></li>
<li><a href="../217389/index.html">Calculate the day of the week in the mind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>