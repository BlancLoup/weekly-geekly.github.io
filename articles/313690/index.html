<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The cellars of the Tower of Babel, or the internationalization of databases with access through ORM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Engraving by M. Escher, "Relativity", 1953 
 Introduction 


 In the previous article on the example of the domain nature of the product, we looked at...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The cellars of the Tower of Babel, or the internationalization of databases with access through ORM</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/59/cb/d4/59cbd400d6b90552886277.jpeg" alt="Engraving by M. Escher &amp; quot;  Relativity &amp; quot;"><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D1%2582%25D0%25BD%25D0%25BE%25D1%2581%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C_(%25D0%25BB%25D0%25B8%25D1%2582%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%258F)"><i>Engraving by M. Escher, "Relativity", 1953</i></a> </p><br><h1>  Introduction </h1><br><p>  In the <a href="https://habrahabr.ru/company/custis/blog/313284/">previous article</a> on the example of the domain nature of the product, we looked at our own data types for multilingual applications.  We learned to describe and use entity attributes that have meanings in various languages.  But the issues of storage and processing in a relational DBMS, as well as the problems of effective work in the application code are still relevant. </p><br><p>  The IT community uses various ways to store multilingual data.  These methods are fundamentally different in the efficiency of requests, resistance to the addition of new localizations, data volume, convenience for the consumer application. </p><br><p>  However, there is still no <i>Database Internationalization for Dummies</i> solution in the industry.  Together with you, we will try to fill this gap a bit: we will describe possible ways, evaluate their advantages and disadvantages, and choose effective ones.  We are not going to reinvent the silver bullet, but the scenario we‚Äôll be looking at is pretty typical for enterprise applications.  We hope it will be useful to many. </p><br><p>  The following code snippets are in C #.  On GitHub, you can find <a href="">examples of the implementation</a> of internationalization mechanisms using two different ORM and DBMS bundles: <a href="http://nhibernate.info/">NHibernate</a> + <a href="http://www.oracle.com/technetwork/database/enterprise-edition/overview/index.html">Oracle Database</a> and <a href="https://docs.microsoft.com/en-us/ef/">Entity Framework Core</a> + <a href="https://www.microsoft.com/en-us/sql-server/developer-get-started/">SQL Server</a> .  Developers using the mentioned ORM will be interested in finding out specific techniques and difficulties in working with multilingual data, as well as blocking framework defects and prospects for their elimination.  The principles and examples of working with multilingual data outlined below can be easily transferred to other languages ‚Äã‚Äãand technologies. </p><br><a name="habracut"></a><br><h1>  Conditions of the problem </h1><br><p>  Our application should work with several languages ‚Äã‚Äãat once.  On any of them, depending on the user's environment, operational and reference data will be displayed and entered.  At the same time, there are scenarios that require the ability to work with data in all languages ‚Äã‚Äãat once in one session. </p><br><p>  For example, consider the domain entity of a product that is already familiar to us and has a name in various languages. </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Product</span></span> {    <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Id {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }    <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Code { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }    <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MultiCulturalString Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><p>  We formulate requirements for the storage and processing of entity data with multilingual attributes: </p><br><ol><li>  Storage, reading and writing of such entities must be through the ORM (mostly), and the means of the DBMS (at least for the purpose of maintenance). </li><li>  Multilingual attributes can be several. </li><li>  Localization requirement must be met. </li><li>  It should be possible to quickly search and sort by localized values ‚Äã‚Äãof a multilingual attribute: <br><ul><li>  only for a given locale; </li><li>  taking into account the specified algorithm for processing alternative resources (if there is no value for the requested locale). </li></ul></li><li>  It should be possible to search by localized values ‚Äã‚Äãof a multilingual attribute among all locales. </li><li>  It should be possible to expand to localize not only string attributes, but also attributes of other types ( <code>MultiCultural&lt;T&gt;</code> is useful). </li><li>  The amount of stored data and traffic between the database and the application must be valid. </li></ol><br><p>  Recall that the alternative resource processing algorithm <code>IEnumerable&lt;CultureInfo&gt; IResourceFallbackProcess.GetFallbackChain(CultureInfo initial)</code> can return different localization search orders for different initial locales: </p><br><ul><li>  for <code>initial</code> locale <code>ru-RU</code> : <code>ru-RU -&gt; ru</code> ; </li><li>  <code>initial</code> <code>en-US</code> locales: <code>en-US -&gt; en -&gt; ru</code> ; </li><li>  <code>initial</code> <code>kz-KZ</code> locale: <code>kz-KZ -&gt; kz -&gt; ru</code> ; </li><li>  <code>initial</code> locales for <code>zh-CH</code> : <code>zh-CH -&gt; zh-CHS -&gt; zh-Hans -&gt; zh -&gt; en</code> . </li></ul><br><h1>  Overview of existing features </h1><br><h2>  DBMS </h2><br><p>  What features are in the largest modern DBMS for internationalization?  It: </p><br><ul><li>  Unicode; </li><li>  Collation (rules for comparing characters, case sensitivity, etc.); </li><li>  Date-time with time zone / offset. </li></ul><br><p>  These features are supported by many large vendors.  Here are links to some articles: </p><br><ul><li>  Microsoft: <a href="https://msdn.microsoft.com/en-us/library/ms190245.aspx">International Considerations for Databases and Database Engine Applications</a> ; </li><li>  Oracle: <a href="https://docs.oracle.com/database/121/NLSPG/ch6unicode.htm">Designing Database Schemas to Support Multiple Languages</a> . </li></ul><br><p>  However, there are no ‚Äústandard‚Äù storage schemes for multilingual data.  There are none of them in the latest SQL standard: 2016. </p><br><p>  Among the curious academic publications, one can note the master's thesis of the ex-head <a href="https://www.microsoft.com/en-us/research/group/multilingual-systems/">of the Multilingual Systems Research Group at</a> Microsoft <a href="https://www.microsoft.com/en-us/research/publication/multilingual-information-processing-on-relational-database-architectures/">Multilingual Information Processing</a> , 2005. The paper deals with the problems of cross-language queries, multilingual join operators, query algebra for new types of storage multilingual data and the mentioned operators. </p><br><h2>  ORM </h2><br><p>  Documentation on NHibernate pleased with the presence of the article <a href="http://nhibernate.info/doc/howto/various/localization-techniques">Localization techniques</a> .  It discusses two storage methods (with variations): </p><br><ol><li>  One column in which the user data type is stored is the <i>locale data</i> dictionary. </li><li>  Separate tables for storing localized attributes (1-2 pieces). </li></ol><br><p>  It is noteworthy that this article does not even mention the rather obvious and popular storage method - multicolumn (column per locale). </p><br><p>  No relevant materials could be found on the Entity Framework. </p><br><h1>  Storage Comparison </h1><br><p>  To begin with, we will create comparison criteria.  To do this, we reformulate the requirements described above into more technical ones.  As we will see further, they are all pretty tough. </p><br><p>  <strong>Localizability.</strong>  Initially, the requirement means no changes in the code when a new localization is added to the application.  With regard to applications with localized data, for example, we can say that there are no changes in the data schema and ORM mappings. </p><br><p>  <strong>Search and sort for a given locale.</strong>  In terms of a multilingual string, this means the ability to use indexes on the results of the <code>String MultiCulturalString.GetString(IResourceFallbackProcess resourceFallbackProcess, CultureInfo culture, bool useFallback)</code> function <code>String MultiCulturalString.GetString(IResourceFallbackProcess resourceFallbackProcess, CultureInfo culture, bool useFallback)</code> for all combinations of values ‚Äã‚Äãof its parameters that are meaningful in this application.  The application <code>IResourceFallbackProcess</code> is probably the only <code>useFallback = false</code> , when <code>useFallback = false</code> <code>resourceFallbackProcess</code> does not matter, therefore the number of necessary indices for localized data is not more than <code>2N</code> , where <code>N</code> is the number of different locales used in all entries in the multilingual attribute. </p><br><p>  <strong>Search among all locales.</strong>  Support is required for the function of the form <code>MultiCulturalString.FindLocalizedStringCulture(String localizedString)</code> with the return type <code>CultureInfo</code> . </p><br><p>  <strong>Search for a suitable location.</strong>  The user's locale is always specific, that is, it determines not only the language, but also regional parameters.  And for storage in most cases it is enough to use neutral locales (which do not specify the specificity of a region), ‚Äúclosest‚Äù to the selected specific ones. </p><br><p>  Therefore, from the above ten locales it is enough for us to provide storage for only four neutral ones: <code>ru</code> , <code>en</code> , <code>kz</code> , <code>zh-Hans</code> .  And in ORM, it is possible to support the functionality of casting a specific locale to neutral by assigning an attribute and (or) saving an entity. </p><br><p>  <strong>Suitability for ORM.</strong>  The selected ORM should have enough extension points so that we can put all our multilingual storage fantasies into practice.  Otherwise you <a href="https://goo.gl/s89eAY">have to write a</a> new framework. </p><br><h2>  Multicolumn storage </h2><br><p>  This option requires you to know in advance the list of necessary localizations.  And for each new locale in use, we need to add a new column and a couple of indices.  And so for each multilingual attribute in all tables of localizable entities.  You may have to change the ORM mapping in the code and (or) database client configuration, especially for static models. </p><br><p>  But do not immediately get upset.  Changes in the code and configuration, most likely, will not become a big problem for an application in which the list of used locales and / or dynamic entities are rarely known and rarely changes.  In addition, as we shall see later, the requirement of localizability one way or another will have to be relaxed for all the considered options. </p><br><img src="https://habrastorage.org/webt/na/zf/ez/nazfezj3qbehifvelpflwdamrac.png" alt="Multicolumn storage chart"><br><br>  With the creation of indexes for each of the <code>name_*</code> -columns for the case when we do not use the search for a suitable localization, everything seems to be obvious.  But what will the query look like in which the <code>IResourceFallbackProcess</code> should work? <br><p>  Consider, for example, such a query: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enUS = CultureInfo.GetCultureInfo(<span class="hljs-string"><span class="hljs-string">"en-US"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> productName = <span class="hljs-string"><span class="hljs-string">"..."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = GetRepository&lt;Product&gt;()   .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.Name.ToString(enUS) == productName)   .SingleOrDefault();</code> </pre> <br><p>  I think you will agree that it may well be implemented by the following SQL query: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pr.id_product, pr.code, pr.name_ru, pr.name_en, pr.name_kz, pr.name_zh_hans <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_product pr <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pr.name_en, <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pr.name_ru, <span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @p1 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pr.name_en, <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pr.name_ru, <span class="hljs-string"><span class="hljs-string">''</span></span>)), pr.id_product</code> </pre> <br><p>  To get an ‚Äúhonest‚Äù <code>null</code> instead of an empty string when the requested value is missing, from the point of view of a multilingual string, use one of the overloads <code>MultiCulturalString.GetString</code> .  Then the filtering expression in SQL will be slightly easier: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pr.id_product, pr.code, pr.name_ru, pr.name_en, pr.name_kz, pr.name_zh_hans <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_product pr <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pr.name_en, pr.name_ru) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @p1 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pr.name_en, pr.name_ru), pr.id_product</code> </pre> <br><p>  We get that even at least one index per locale we need to build on an expression with <code>isnull</code> , which is a SQL mapping of the search chain for alternative resources.  Such indices are usually called functional, in SQL Server these are indices above computable columns.  In the above description of the <code>t_product</code> table <code>t_product</code> these indexes have the suffix <code>_stdfallback</code> . </p><br><p>  About the type of request in the case of searching for a string among all localizations, we will provide the reader with an opportunity to dream up. </p><br><p>  This method of storage and access is implemented for one of our company's clients. </p><br><h2>  Single-column serialized storage </h2><br><p>  In this embodiment, the multilingual attribute occupies only one column.  A multilingual string can be serialized in both binary and human-readable form.  Or, for example, in Oracle, a column may have an object type. </p><br><p>  Given the current trends in the development of the SQL standard, you should pay attention to XML or JSON storage.  Oracle Database, SQL Server, DB2, PostgreSQL, MySQL have pretty strong support for XML and (or) JSON. </p><br><p>  Making such a decision, we need to take care of the possibility of obtaining (and someone - and recording) localized values ‚Äã‚Äãby means of the DBMS.  A universal and well encapsulating specific variant of serialization will be the creation of a custom scalar function that accepts a serialized value, a locale and a string for searching for a suitable localization, and returns a localized string. </p><br><img src="https://habrastorage.org/webt/wp/z_/1j/wpz_1j3hoav-fyrqcpxs5t8feo0.png"><br><br>  The SQL query for the search will look something like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pr.id_product, pr.code, pr.name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_product pr <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> McsGetString(pr.name, <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'en,ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @p1 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> McsGetString(pr.name, <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'en,ru'</span></span>), pr.id_product</code> </pre> <br><p>  When a new locale appears, we still have to add new functional indexes based on the results of the <code>McsGetString</code> function.  Adding only indexes is a safer action than adding new columns.  Unlike multi-column storage, ORM mappings will probably not have to be changed. </p><br><h2>  Relational storage </h2><br><p>  Here we have a separate table for storing localized values.  Variations of such storage are numerous.  Consider only one of them. </p><br><img src="https://habrastorage.org/webt/83/zi/vw/83zivwizt4wovef2fnxuf03tsdm.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      SQL query for searching only one locale looks quite simple: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pr.id_product, pr.code, pl.name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_product pr <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_product_localizable pl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pr.id_product = pl.id_product <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pl.locale = <span class="hljs-string"><span class="hljs-string">'en'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pl.name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @p1 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pl.name, pr.id_product</code> </pre> <br><p>  The SQL query, taking into account the search for suitable localizations, is already more cumbersome: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pr.id_product, pr.code, pl_en.name, pl_ru.name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_product pr <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_product_localizable pl_ru <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pr.id_product = pl_ru.id_product <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pl_ru.locale = <span class="hljs-string"><span class="hljs-string">'ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> t_product_localizable pl_en <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pr.id_product = pl_en.id_product <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pl_en.locale = <span class="hljs-string"><span class="hljs-string">'en'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pl_en.name, <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pl_ru.name, <span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @p1 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pl_en.name, <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(pl_ru.name, <span class="hljs-string"><span class="hljs-string">''</span></span>)), pr.id_product</code> </pre> <br><p>  Such a request presents us with a whole bunch of surprises. </p><br><p>  First, the cost of the request is already noticeably higher than in the previous versions. </p><br><p>  Secondly, using such a query, it is problematic to instantiate an entity with a fully initialized multilingual attribute.  Either we have to add a <code>LEFT JOIN</code> for all locales whose list you need to know in advance, or stop using the <code>MultiCulturalString</code> attribute, replacing it with a <code>String</code> and reducing the number of covered scenarios.  Another option is to support lazy loading of values ‚Äã‚Äãfor different locales within a multilingual string.  Each of the alternatives has the right to life according to the specific requirements for the product. </p><br><p>  Thirdly, we are going to support the work with multilingual attributes in existing ORMs.  But we can hardly find such an extension point to add a <code>JOIN</code> to the SQL query, while remaining within the framework of a simple LINQ query: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result =  GetRepository&lt;Product&gt;()   .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.Name.ToString(enUS) == productName)   .SingleOrDefault();</code> </pre> <br><p>  Connections with the <code>t_product_localizable</code> table can be replaced with subqueries, but this does not fundamentally change anything. </p><br><p>  A very interesting result, isn't it?  But the requirement of localization is satisfied. </p><br><h2>  findings </h2><br><p>  As we expected, it was not possible to find a silver bullet among the options considered.  In each of these, one or more requirements are more or less violated.  However, this is not a reason to do nothing.  We need to make a compromise decision, choose a middle ground. </p><br><p>  We considered the single-column serialized storage variant to be the most balanced and promising.  Therefore, in the next section, we propose to consider the features of the implementations of this option for <a href="http://nhibernate.info/">NHibernate</a> + <a href="http://www.oracle.com/technetwork/database/enterprise-edition/overview/index.html">Oracle Database</a> bundles and the <a href="https://docs.microsoft.com/en-us/ef/">Entity Framework Core</a> + <a href="https://www.microsoft.com/en-us/sql-server/developer-get-started/">SQL Server</a> .  Serialization of multilingual attributes will be done in XML, and for access to localized values ‚Äã‚Äãfrom the database - use the means of the DBMS. </p><br><h1>  We expand ORM </h1><br><p>  So, we will make an attempt to support work with entities that contain an attribute of the <code>MultiCulturalString</code> type, as well as a query to search for such entities by the localized attribute value. </p><br><p>  We will not consider the question of searching for a multilingual attribute in all locales, giving it to the interested reader. </p><br><p>  In the implementation we proceed from the following principles: </p><br><ol><li>  Entities are described by POCO classes (in Java - POJO). </li><li>  Entities are separated from mapping to database objects, including from conversions to database format and back. </li><li>  Whenever possible, we use the native API of a multilingual string in queries.  Thus we will receive transparent use of one API both on the client, and on the server. </li><li>  The division into assemblies should be fine for better separation of responsibilities, dependency control, and reuse. </li></ol><br><p>  We give a diagram of dependencies with small division into assemblies. <br><br></p><p><img src="https://habrastorage.org/webt/59/cb/d4/59cbd400a09c2869949614.png" alt="Dependency diagram"></p><br><p>  We will serialize the values ‚Äã‚Äãof the multilingual string in XML.  In .NET, responsibility for the content of the serialized data ( <code>ISerializable</code> , <code>ISerializationSurrogate</code> ) and the final serialized view ( <code>IFormatter</code> ) are <code>IFormatter</code> .  And if it is quite logical to place the first responsibility on the object itself being serializable, the second one strongly depends on the use.  Therefore, for formatting, apply the <code>XmlFormatter: IFormatter</code> found on the Internet, using <code>ISerializable</code> objects. </p><br><h2>  NHibernate + Oracle Database </h2><br><p>  NHibernate, perhaps, has long been the most functional ORM under .NET.  At the same time, it contains contradictory stratifications that have arisen at different stages of its development.  Now versions are extremely rare, there are few contributors left.  Some long-awaited corrections of defects, apparently, will never come out. </p><br><p>  To load and save the values ‚Äã‚Äãof a multilingual string, we need to implement an <code>IUserType</code> in which to use the mentioned <code>XmlFormatter</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Multilingual string in XML looks pretty obvious.</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MultiCulturalString</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MultiCulturalString"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://custis.ru/i18n"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ru</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ru</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">en</span></span></span><span class="hljs-tag">&gt;</span></span>Chocolate Alina<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">en</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MultiCulturalString</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">The ‚Äúheart‚Äù of the function for accessing localized values ‚Äã‚ÄãMcsGetString uses XQuery.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XMLCast</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">XMLQuery</span></span>(<span class="hljs-string"><span class="hljs-string">'declare namespace i18n="http://custis.ru/i18n"; for $mcs_locale in $mcs/i18n:MultiCulturalString/* where $mcs_locale/name() = $locale return $mcs_locale/text()'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">PASSING</span></span> a_mcs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"mcs"</span></span>, a_locale <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"locale"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURNING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONTENT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> VARCHAR2(<span class="hljs-number"><span class="hljs-number">4000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> l_value <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual;</code> </pre> </div></div><br><p>  To use this function in <a href="http://nhibernate.info/doc/nhibernate-reference/queryhql.html">HQL</a> , it is enough to add the implementation of <code>ISQLFunction</code> to the NHibernate configuration.  But besides, we want the LINQ-to-Database call to <code>MultiCulturalString.ToString()</code> overloads to turn into a call to the <code>McsGetString</code> function.  However, for this, NHibernate has an extension point: it is enough to implement <code>IHqlGeneratorForMethod</code> and also register the implementation in the configuration.  The <code>IHqlGeneratorForMethod</code> implementation <code>IHqlGeneratorForMethod</code> expected to convert one expression tree to another. </p><br><p>  Here, strictly speaking, that's all.  Are we really great, but is everything so seamless with NHibernate?  Unfortunately no! </p><br><div class="spoiler">  <b class="spoiler_title">Such a simple test will not work.</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">[Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> TestNh2500() {   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> = SessionFactory.OpenSession())   {       var product = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Product       {           Code = ProductCode,           <span class="hljs-type"><span class="hljs-type">Name</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MultiCulturalString(ru, ProductNameRu)               .SetLocalizedString(en, ProductNameEn)       };       <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.Save(product);   }   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> = SessionFactory.OpenSession())   {       var product = <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.AsQueryable&lt;Product&gt;()           .SingleOrDefault(p =&gt; p.Name.ToString(zhCHS)) == ProductNameEn);       <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsNotNull(product);       <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(ProductCode, product.Code);   }   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> = SessionFactory.OpenSession())   {       var product = <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.AsQueryable&lt;Product&gt;()           .SingleOrDefault(p =&gt; p.Name.ToString(ruRU)) == ProductNameEn);       // The next <span class="hljs-type"><span class="hljs-type">line</span></span> throws AssertionException       <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">IsNull</span></span>(product);   } }</code> </pre> <br><p>  The same SQL will be generated for both queries: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span>       product0_.id_product <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> id1_0_,       product0_.code <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> code0_,       product0_.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> name0_   <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>       t_product product0_   <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>       McsGetString(product0_.name, <span class="hljs-string"><span class="hljs-string">'zh-CHS'</span></span>, <span class="hljs-string"><span class="hljs-string">'zh-CHS,zh-Hans,zh,en'</span></span>)=:p0;</code> </pre> </div></div><br><p>  The whole thing is in the <a href="https://nhibernate.jira.com/browse/NH-2500">NH-2500</a> defect: LINQ requests even of different sessions are cached at the session factory level and reused, despite the different values ‚Äã‚Äãof the request parameters.  Although the bug has been critical for six years, the fix will only be included in the future version 5.1.  In the meantime, you can release fork NHibernate.  If you need to correct any other defects of NHibernate, the low dynamics of the product makes the risks of "swelling" of your edits low. </p><br><h2>  Entity Framework Core + SQL Server </h2><br><p>  Not so long ago, <a href="https://docs.microsoft.com/en-us/ef/core/what-is-new/">EF Core 2.0 was released</a> , and further development is behind this cross-platform branch.  For our examples, we chose it, not <a href="https://docs.microsoft.com/en-us/ef/ef6/">EF 6</a> , since we hope for a speedy solution to the problems described below. </p><br><p>  Unfortunately, in EF Core we cannot implement support for a custom type, including <code>MultiCulturalString</code> .  But already in version 2.1 of the framework, this possibility will appear (see <a href="https://github.com/aspnet/EntityFrameworkCore/issues/242">issue # 242</a> ). </p><br><div class="spoiler">  <b class="spoiler_title">For now, let's create a proxy class for our product with the RawName string attribute.</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Product</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> String Code { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> MultiCulturalString Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductProxy</span></span> : <span class="hljs-title"><span class="hljs-title">Product</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> MultiCulturalString Name   {       <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Name;       <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>       {           _rawName = ConvertToStoredValue(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>);           <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Name = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>;       }   }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> String RawName   {       <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _rawName;       <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>       {           <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Name = ParseStoredValue(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>);           _rawName = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>;       }   }   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String _rawName;   ... }</code> </pre> </div></div><br><p>  It is the proxy class that will participate in our <code>DbContext</code> .  As you guessed, the <code>Name</code> attribute will not participate in the mapping at all.  And of course, the reader would like to use the <code>RawName</code> attribute used in mapping to be <code>protected</code> , since ORM doesn‚Äôt interfere.  But do not rush! </p><br><p>  Already familiar to us request </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = GetRepository&lt;ProductProxy&gt;()   .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.Name.ToString(enUS) == productName)   .SingleOrDefault();</code> </pre> <br><p>  will work in EF without additional efforts from our side.  But only on the client!  After all, the <code>Name</code> attribute does not map to the database. </p><br><p>  It is a great help that EF allows you to receive warnings about client execution of a part of a request or to ban it altogether using <code>DbContextOptionsBuilder.ConfigureWarnings</code> . </p><br><p>  And even after <a href="https://github.com/aspnet/EntityFrameworkCore/issues/242">issue # 242</a> is made, we can only use static functions for mapping on the database function.  Using the instance function <code>ToString</code> fails, see <a href="https://github.com/aspnet/EntityFrameworkCore/issues/9213">issue # 9213</a> . </p><br><p>  A possible (albeit temporary) output for us seems to be the declaration of extension methods <code>DbUserDefinedMethods.McsGetString(this String mcs, ...)</code> , with signatures that coincide with multiple <code>MultiCulturalString.ToString</code> overloads, without taking into account the first parameter <code>this</code> .  Requests will have a somewhat artificial look: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = GetRepository&lt;ProductProxy&gt;()   .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function"> =&gt;</span></span> p.RawName.McsGetString(enUS) == productName)   .SingleOrDefault();</code> </pre> <br><p>  Such extension methods are registered in the model builder, and the conversion from one expression tree to another is specified, the implementation of which practically does not differ from the implementation of the <code>IHqlGeneratorForMethod</code> for NHibernate. </p><br><p>  In addition, the EF computability of the expression is analyzed on the server side without taking into account the transformation of the registered function.  Therefore, <code>DbUserDefinedMethods.McsGetString</code> overloads that contain the unknown ORM types <code>CultureInfo</code> and <code>IResourceFallbackProcess</code> will always be calculated on the client. </p><br><p>  There is an alternative to all the listed ‚Äúcrutches‚Äù in EF - this is writing your own provider.  Then you can support any types and necessary instance functions.  But from the point of view of support, synchronization with the original provider, which is actively developing, this architectural solution looks weak.  Therefore, we will hope for a good dynamic of the new branch of the EF development. </p><br><h1>  Conclusion </h1><br><p>  We considered a possible use case and implementation of support for multilingual attributes.  At the same time, for some simple scenarios of using multilingual attributes, it is enough to essentially declare only a string attribute, and to switch between localizations, it is enough to introduce special methods of the form <code>static String InLocale(this String mcs, CultureInfo culture, ...)</code> . </p><br><p>       ‚Äî  ,           . </p><br><p>             ORM   ,      .    ,     . </p></div><p>Source: <a href="https://habr.com/ru/post/313690/">https://habr.com/ru/post/313690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313680/index.html">We control the standard Sailfish OS player using voice commands</a></li>
<li><a href="../313682/index.html">As I wrote the game for the contest, or the wonderful transformation of "Lines" into "Sea battle"</a></li>
<li><a href="../313684/index.html">Selection of useful materials on DevOps</a></li>
<li><a href="../313686/index.html">Comparison of logging libraries</a></li>
<li><a href="../313688/index.html">Two-factor authentication and open doors</a></li>
<li><a href="../313692/index.html">Connecting the ADC to the FPGA. Features, complexity, implementation</a></li>
<li><a href="../313694/index.html">History of programming languages: C # - ahead of the rest</a></li>
<li><a href="../313696/index.html">[Bookmark] Zoo neural network architectures. Part 1</a></li>
<li><a href="../313698/index.html">Pro information systems and old sewer pipes</a></li>
<li><a href="../313700/index.html">Twelve commandments of software localization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>