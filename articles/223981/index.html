<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>os.urandom, CPython, Linux and rake</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to tell an instructive history of errors in the implementation of the urandom function from the os module in CPython on UNIX-like operating sys...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>os.urandom, CPython, Linux and rake</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/fa4/8d9/968/fa48d996844b0dd89817c8642351a091.png"><br><br>  I want to tell an instructive history of errors in the implementation of the urandom function from the os module in CPython on UNIX-like operating systems (Linux, Mac OS X, etc.). <br><br>  Quote from the <a href="https://docs.python.org/3.4/library/os.html">documentation for the top three</a> : <br><blockquote>  Return a string of random order bytes suitable for cryptographic use. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This function returns a random bytes from an OS-specific randomness source.  It should not be necessary for the cryptographic applications, however, it depends on the OS implementation.  It will use CryptGenRandom () on the Unix-like system. </blockquote>  <a href="https://docs.python.org/2.7/library/os.html">Documentation for the pair</a> adds: <br><blockquote>  New in version 2.4. </blockquote>  In other words, for example, under Linux, urandom reads and returns bytes from the system device / dev / urandom.  Let me remind you that in this OS there are two typical entropy source devices: / dev / random and / dev / urandom.  <a href="http://en.wikipedia.org/wiki//dev/random">As is known</a> , the first device is ‚Äúslow‚Äù and blocking, and the second is ‚Äúfast‚Äù, and contrary to popular belief, <a href="http://www.2uo.de/myths-about-urandom/">both of them are crypto-resistant sources of (pseudo-) random numbers</a> .  I‚Äôll say right away that KDPV has nothing to do with the article and it‚Äôs not about cryptography, security, <s>or OpenSSL with Heartbleed</s> . <br><br>  It would seem, how can you make a mistake in the implementation of such a simple routine?  As it often happens, they were optimized ... <br><a name="habracut"></a><br><h5>  2.4 </h5><br>  Let's come back to the end of 2004, the <s>Half-Life 2</s> CPython 2.4 comes out, <a href="http://www.python.org/doc/2.4/whatsnew/whatsnew24.html">adding</a> such familiar features as function decorators, sets (set), reverse order traversal (reversed) and list comprehensions, which are referred to as generator expressions by reference.  How could people without them develop software on Python at all ?! <br><br>  Above it was already written that they added os.urandom, implemented on Python itself.  Let's fantasize how urandom could be written: <br><blockquote>  <font color="#ff7700">def</font> urandom <font>(</font> n <font>)</font> : <br>  <font color="#ff7700">with</font> <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / urandom'</font> <font color="#66cc66">,</font> <font color="#483d8b">'rb'</font> <font>)</font> <font color="#ff7700">as</font> rnd: <br>  <font color="#ff7700">return</font> rnd.  <font>read</font> <font>(</font> n <font>)</font> </blockquote>  So, three lines.  Moreover, this is an absolutely correct implementation without errors, except for exception handling and other details in order to comply with the specification of the function of the function on the docks.  And then someone's bright head offers to speed up this code.  How is this possible, you ask.  Having cached a file object, the bright head responds. <br><blockquote>  rnd <font color="#66cc66">=</font> <font color="#008000">None</font> <br><br>  <font color="#ff7700">def</font> urandom <font>(</font> n <font>)</font> : <br>  <font color="#ff7700">if</font> rnd <font color="#ff7700">is</font> <font color="#008000">None</font> : <br>  rnd <font color="#66cc66">=</font> <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / urandom'</font> <font color="#66cc66">,</font> <font color="#483d8b">'rb'</font> <font>)</font> <br>  <font color="#ff7700">return</font> rnd.  <font>read</font> <font>(</font> n <font>)</font> </blockquote>  What problems appear with this implementation?  Scripts that become demons fall on the first invocation of urandom after the death of the parent. <br><br><h5>  fork () </h5><br>  Many people know that the <a href="http://en.wikipedia.org/wiki/Fork_(system_call)">fork ()</a> system function, which is part of the POSIX 2001 standard and appeared in the very first version of Unix, is designed to spawn new processes using the ‚Äúforking‚Äù method, when a twin appears in the system with an identical environment, but a separate address space, and it starts working exactly from the very place in the code where the fork () call was.  As a rule, forks use the copy-on-write mechanism, thanks to which the memory is not physically copied when creating a twin process (‚Äúchild‚Äù).  Instead, the pages in which the twin writes as they work are copied from the memory of the parent.  These are all lyrics, and we are interested in the following quote from man fork: <br><blockquote>  Copy of the open file descriptors.  Each file descriptor (see open (2)) as the corresponding file descriptor in the parent.  I / O attributes and signal-driven I / O attributes </blockquote>  In other words, the file descriptors belonging to the Python file object, after the fork, are interconnected and refer to the same file.  However, if in one process the file is closed, it will <b>not</b> be automatically closed in the other. <br><br>  Well, fork and fork, you say.  Python here and?  And despite the fact that <br><ol><li>  multiprocessing * works on top of it </li><li>  <b>through it comes demonization</b> </li></ol>  * with correction <a href="http://bugs.python.org/issue8713"># 8713</a> <a href="https://docs.python.org/3/whatsnew/3.4.html">is not always</a> <br><br>  Thanks to fork-in multiprocessing, children are initially in a state that was in the main process before reproduction.  As for the demonization process (turning into a service in Windows terms) - see <a href="http://legacy.python.org/dev/peps/pep-3143/">PEP 3143</a> .  Somewhere in full swing there is a fork () call.  And if, according to the best traditions, to close all file descriptors directly in the newly-created daemon, not through close () (for example, so: <font color="#dc143c">os</font> . <font>Closerange</font> <font>(</font> <font color="#ff4500">3</font> <font color="#66cc66">,</font> <font color="#ff4500">256</font> <font>)</font> ), then os.urandom () collapses. <br><br>  Approximately these words were <a href="http://marc.info/%3Fl%3Dpython-bugs-list%26m%3D124984793756728%26w%3D2">explained</a> by CPython users in early 2005 to its developers a mistake.  However, Guido first tried to <s>build a fool out of himself to excuse himself</s> : <br><blockquote>  I recommend to close this as invalid.  The daemonization code is clearly broken. </blockquote>  Fortunately, people were able to convince the king of the opposite, and, finally, in July <a href="http://hg.python.org/cpython/rev/c5888413412b">caching / dev / urandom was removed</a> - more than six months passed.  I draw attention to how it was done: the code does not contain a reference to the bug number, no indication of the reasons for the patch, or, in the end, just an explanatory comment.  It works, and well. <br><br><h5>  3.4 </h5><br>  It takes 9 years.  In March 2014 <a href="https://docs.python.org/3/whatsnew/3.4.html">,</a> CPython 3.4 is released.  He adds such necessary features as ... wait, oh shi <br><blockquote>  No new syntax features were added in Python 3.4. </blockquote>  Okay, well, seriously, great progress: a bunch of libraries were taken, for example, asyncio, which has already been written a lot on Habr√©, improved security, cleared the release of objects - not for me to talk about it.  The main thing is that before the release there were people who thought that the implementation of / dev / urandom on Python is hellishly slow, and true performance can only be ensured by the good old C. In general, the function was rewritten ... and again they <a href="http://bugs.python.org/issue21207">stepped on the same rake</a> .  And no <a href="http://legacy.python.org/dev/peps/pep-0446/">PEP 446</a> helped them.  The patch <a href="http://hg.python.org/cpython/rev/d3e8db93dc18">was released on April 24</a> and this time already contained abundant comments, a link to the bug and even regression tests. <br><br><h5>  What do I care? </h5><br>  As a bonus to the article, I will tell you how I stumbled over this error.  I have a working system of Ubuntu 14.04 LTS, and, unfortunately, on it <br><blockquote>  <font color="#ff7700">import</font> <font color="#dc143c">platform</font> <br>  <font color="#dc143c">platform</font> .  <font>python_build</font> <font>(</font> <font>)</font> <br>  <font>(</font> <font color="#483d8b">'default'</font> <font color="#66cc66">,</font> <font color="#483d8b">'Apr 11 2014 13:05:11'</font> <font>)</font> </blockquote>  I had a daemon code that closed all the file descriptors.  And that's because the trouble <br><blockquote>  <font color="#ff7700">import</font> <font color="#dc143c">os</font> <br>  <font color="#ff7700">print</font> <font>(</font> <font color="#dc143c">os</font> . <font>listdir</font> <font>(</font> <font color="#483d8b">'/ proc / self / fd'</font> <font>)</font> <font>)</font> <br>  <font color="#ff7700">import</font> <font color="#dc143c">random</font> <br>  <font color="#ff7700">print</font> <font>(</font> <font color="#dc143c">os</font> . <font>listdir</font> <font>(</font> <font color="#483d8b">'/ proc / self / fd'</font> <font>)</font> <font>)</font> </blockquote>  prints <br><blockquote><code>['0', '1', '2', '3']</code> <br> <code>['0', '1', '2', '3', '4']</code> </blockquote>  The experiment is not entirely clean, because  os.listdir creates its descriptor in both cases under the last number.  After importing the random number 3 opened. Which file does it correspond to? <br><blockquote>  <font color="#ff7700">print</font> <font>(</font> <font color="#dc143c">os</font> . <font>readlink</font> <font>(</font> <font color="#483d8b">'/ proc / self / fd / 3'</font> <font>)</font> <font>)</font> </blockquote><blockquote> <code>/dev/urandom</code> </blockquote>  Ta-dam!  I always had a bad attitude to work when importing modules ... In this case, I give the ending random.py: <br><blockquote>  <font color="#ff7700">from</font> <font color="#dc143c">os</font> <font color="#ff7700">import</font> urandom <font color="#ff7700">as</font> _urandom <br><br>  <font color="#ff7700">class</font> Random <font>(</font> _random. <font>Random</font> <font>)</font> : <br>  <font color="#808080"># ...</font> <br>  <font color="#ff7700">def</font> <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> <font color="#66cc66">,</font> x <font color="#66cc66">=</font> <font color="#008000">None</font> <font>)</font> : <br>  <font color="#808080"># ...</font> <br>  <font color="#008000">self</font> .  <font>seed</font> <font>(</font> x <font>)</font> <br>  <font color="#008000">self</font> .  <font>gauss_next</font> <font color="#66cc66">=</font> <font color="#008000">None</font> <br><br>  <font color="#ff7700">def</font> seed <font>(</font> <font color="#008000">self</font> <font color="#66cc66">,</font> a <font color="#66cc66">=</font> <font color="#008000">None</font> <font color="#66cc66">,</font> version <font color="#66cc66">=</font> <font color="#ff4500">2</font> <font>)</font> : <br>  <font color="#808080"># ...</font> <br>  <font color="#ff7700">if</font> a <font color="#ff7700">is</font> <font color="#008000">None</font> : <br>  <font color="#ff7700">try</font> : <br>  a <font color="#66cc66">=</font> <font color="#008000">int</font> .  <font>from_bytes</font> <font>(</font> _urandom <font>(</font> <font color="#ff4500">32</font> <font>)</font> <font color="#66cc66">,</font> <font color="#483d8b">'big'</font> <font>)</font> <br>  <font color="#ff7700">except</font> <font color="#008000">NotImplementedError</font> : <br>  <font color="#808080"># ...</font> </blockquote>  It remains to be noted that import random do Tornado, Twisted, uuid, and a whole bunch of other libraries, standard and not very. <br><br>  It should be noted that at first I did not quite understand the essence of the problem, unreasonably deciding that the file descriptors of the child and the parent are closed at the same time.  Thanks to <a href="https://habrahabr.ru/users/kekekeks/" class="user_link">kekekeks</a> for <a href="http://habrahabr.ru/post/223981/">restoring the full picture of this bug</a> . <br><br><h5>  findings </h5><br>  You should always think about the perennial problems of fork () when developing libraries, always comment on the bug fixes in the code and carefully read the messages about users' problems (at least if they are programmers). </div><p>Source: <a href="https://habr.com/ru/post/223981/">https://habr.com/ru/post/223981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223971/index.html">Dynamic Adding Properties in the Java Language</a></li>
<li><a href="../223973/index.html">Hacking the D-Link DSP-W215 Smart Plug. Again</a></li>
<li><a href="../223975/index.html">Statistics of sales of applications in the Windows Store</a></li>
<li><a href="../223977/index.html">Indie cindy</a></li>
<li><a href="../223979/index.html">Systemicus Part 2: GUI</a></li>
<li><a href="../223985/index.html">‚ÄúHello, vote for my photo‚Äù at the state level, or ‚Äúhow do you feel about Internet voting‚Äù</a></li>
<li><a href="../223987/index.html">Is it possible to create strong artificial intelligence without copying the human brain?</a></li>
<li><a href="../223991/index.html">Hacking the D-Link DSP-W215 Smart Plug. Again and again</a></li>
<li><a href="../223993/index.html">In Dubai, for the mark of people in photos on Facebook you can go to jail</a></li>
<li><a href="../223995/index.html">Analysis of the new version of Miniduke</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>