<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization through VKontakte, Mail.ru and others for the most beginners - 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© and other resources there are tutorials, but in each of them there‚Äôs some insignificant moment missed, questions on which can be seen in vari...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization through VKontakte, Mail.ru and others for the most beginners - 1</h1><div class="post__text post__text-html js-mediator-article">  On Habr√© and other resources there are tutorials, but in each of them there‚Äôs some insignificant moment missed, questions on which can be seen in various forums.  Since I recently faced the task of making friends with one site with Kontaktik and Mail.ru, I decided, while the memory is fresh, to make my own small blackjack manual, so to speak, using the native widgets of these social networks. <a name="habracut"></a><br>  So let's start with VKontakte.  We go to the <a href="http://vkontakte.ru/editapp%3Fact%3Dcreate%26site%3D1">site connection page</a> , in the future the settings of the connected site will be available to you on the <a href="http://vkontakte.ru/apps%3Fact%3Dsettings">application management</a> page, there we will know the application ID and the secret key, which naturally cannot be disclosed to anyone. <br>  On the page where the ‚ÄúLogin with VKontakte‚Äù button is supposed to be added to the head of the page <br><blockquote><code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">script</font> <font color="#ff0000">type</font> <font color="#0000ff">="text/javascript"</font> <font color="#ff0000">src</font> <font color="#0000ff">="http://userapi.com/js/api/openapi.js?34"</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">script</font> <font color="#0000ff">&gt;</font></font> <br></code> </blockquote><br>  And initialize the application: <br><blockquote> <code><font color="black">VK.init({apiId: __APP_ID___});</font> <br></code> </blockquote><br>  Now you need to show the user a button through a call to the widget.  As parameters, Auth takes the id of the element to which the widget needs to be displayed, the width and the address of the page to which we will be redirected after the access attempt. <br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">div</font> <font color="#ff0000">id</font> <font color="#0000ff">="vk_auth"</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">div</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">script</font> <font color="#ff0000">type</font> <font color="#0000ff">="text/javascript"</font> <font color="#0000ff">&gt;</font> <br> VK.Widgets.Auth( <font color="#A31515">"vk_auth"</font> , {width: <font color="#A31515">"300px"</font> , authUrl: <font color="#A31515">'/vklogin.php?'</font> }); <br> <font color="#0000ff">&lt;/</font> <font color="#800000">script</font> <font color="#0000ff">&gt;</font></font> <br></code> </blockquote><br>  What the user will see: <br><br><img src="https://habrastorage.org/storage1/20bbbb49/afa44c97/de12c457/de6c5392.png"><br><br>  After clicking on ‚ÄúSign in via VKontakte‚Äù, the user throws it on a page like <a href="http://vkontakte.ru/widget_auth.php%3Fact%3Da_auth_user%26app%3D__APP_ID__%26hash%3Dd2d47b3c85d1a091a8">vkontakte.ru/widget_auth.php?act=a_auth_user&amp;app=__APP_ID__&amp;hash=d2d47b3c85d1a091a8</a> , then on the url you specified in the AuthUrl parameter when calling the widget.  Throws with the following GET parameters: <br>  first_name (name), hash (used to check whether the request actually came from the contact, and not the hacker Vasya is trying to log in under someone else's data), last_name (last name), photo (large avatar, 119 pixels wide), photo_rec (small avatar, 50x50 ), uid (user id).  <b>After filtering, I saved the parameters</b> to us <b>with the same names in the global scope</b> . <br>  Now we need to make a vklogin.php script in which we will check the correctness of the incoming data and either authorize the user if he already exists in our database, or create a new account for the user who has come to us for the first time. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">if</font> ($_REQUEST[ <font color="#A31515">'hash'</font> ]==md5( <font color="#A31515">'2445355'</font> .$uid. <font color="#A31515">'__SECRET_KEY__'</font> )) { <br> <font color="#008000">// ,   ,     </font> <br> <font color="#008000">//         vk-********</font> <br> $result = mysql_query( <font color="#A31515">"SELECT id, random, password FROM tracker_users WHERE username = 'vk-$uid'"</font> ); <br> setcookie( <font color="#A31515">'uid'</font> , <font color="#A31515">''</font> ); <br> setcookie( <font color="#A31515">'pass'</font> , <font color="#A31515">''</font> ); <br> <font color="#0000ff">if</font> (mysql_num_rows($result)) { <br> <font color="#008000">// ,   </font> <br> $user = mysql_fetch_assoc($result); <br> mysql_query( <font color="#A31515">"UPDATE tracker_users SET name = '$name' WHERE username = 'vk-$uid' LIMIT 1"</font> ); <br> setcookie( <font color="#A31515">'pass'</font> ,md5($user[ <font color="#A31515">'random'</font> ].$user[ <font color="#A31515">'password'</font> ].$user[ <font color="#A31515">'random'</font> ])); <br> setcookie( <font color="#A31515">'uid'</font> ,$user[ <font color="#A31515">'id'</font> ]); <br> } <font color="#0000ff">else</font> { <br> <font color="#008000">//    </font> <br> $random = mt_rand(100000,999999); <br> $pwd = $uid . <font color="#A31515">'verysecretlonglongword-'</font> ; <br> $pid=md5(uniqid(rand(), <font color="#0000ff">true</font> )); <br> mysql_query( <font color="#A31515">"INSERT INTO tracker_users <br> (username, name, password, random, id_level, email, style, language, flag, joined, lastconnect, pid, time_offset) VALUES <br> ('vk-$uid', '$name', '"</font> . md5($pwd) . <font color="#A31515">"', $random, 3, '', 5, 7, 0, NOW(), NOW(),'$pid', '0')"</font> ); <br> <font color="#008000">// ,        </font> <br> setcookie( <font color="#A31515">'pass'</font> ,md5($random.md5($pwd).$random)); <br> setcookie( <font color="#A31515">'uid'</font> ,mysql_insert_id()); <br> } <br> header( <font color="#A31515">"Location: /index.php"</font> ); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  On the site where I needed to make authorization in cookies, the user id and the hash of the salt and password hash are stored.  The solution, of course, is not perfect, but to completely change the entire engine was not in my plans.  If we already have a user, we will authorize it by creating a cookie, if it is the first time, we add it to the database.  Also, at each entry, we update the data about the names, because the user could change it, and we want relevance. <br>  In addition, before using such an authorization, you need to make sure that there are no users in the database with logins like vk- (or with those that you want to use).  It is also necessary to prohibit registration through the usual registration of the engine used with logins of the type vk- and prohibit users from the social network to change their password and, optionally, an avatar with the displayed name.  For sites where the use of registered users' email is critical, you will also need to familiarize your engine with the fact that these users do not have email. <br>  Optionally, it is possible to separate out near each output of the username on the site that he has logged in through a social network: <br><img src="https://habrastorage.org/storage1/2dffd0dd/e06c708f/2159b1bd/3f3eece2.png"><br>  If the level and subject of the article is interesting to users, then I will continue with mail.ru, facebook and twitter. <br>  <a href="http://habrahabr.ru/blogs/webdev_for_dummies/126872/">The second part of.</a>  <a href="http://habrahabr.ru/blogs/webdev_for_dummies/126872/">Mail.ru</a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/126717/">https://habr.com/ru/post/126717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126710/index.html">About modern methods of near-earth astronomy</a></li>
<li><a href="../126711/index.html">Mi-one new smartphone Xiaomi</a></li>
<li><a href="../126714/index.html">Bootstrap toolkit for creating web applications</a></li>
<li><a href="../126715/index.html">Visa. Insurance case of the return of stolen money</a></li>
<li><a href="../126716/index.html">VKontakte page deletion became available</a></li>
<li><a href="../126718/index.html">Websites face a fine of 50 thousand euros for installing the Facebook Like button</a></li>
<li><a href="../126720/index.html">Hacking Dendy Games. On the example of Road Fighter</a></li>
<li><a href="../126722/index.html">ReactOS Digest # 2</a></li>
<li><a href="../126723/index.html">Two contests from ASUS</a></li>
<li><a href="../126725/index.html">Wikimedia Referendum 2011</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>