<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Autostart and auto power off VM in VmWare ESXi 5.0 Update 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to start implementing virtualization in one government institution. My first choice was Citrix XenServer, because it was possible to organiz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Autostart and auto power off VM in VmWare ESXi 5.0 Update 1</h1><div class="post__text post__text-html js-mediator-article"> I decided to start implementing virtualization in one government institution.  My first choice was Citrix XenServer, because  it was possible to organize a software RAID1 in it (since due to the lack of a budget, a hardware RAID controller was not installed in the server), but, poking with it, I still knocked out money for a hardware RAID controller and switched to VmWare ESXi 5.0.  What is good, both are free. <br><br>  Everything was fine, the necessary tasks were virtualized, the virtual machines worked fine, but there was Update 1 for ESXi 5.0.  After the update, the autorun and auto off functions of virtual machines stopped working.  It would seem a trifle, but the food we left much to be desired, and from time to time the question arose with the automatic start of the virtual machines after the server was rebooted.  Well, sometimes the server also has to be turned off, and for this it was necessary to connect the VMware vSphere Client to the hypervisor and one by one to extinguish the virtuals, which was very lazy. <br><a name="habracut"></a><br>  Having rummaged through the network, a <a href="http://greendail.ru/node/495">way</a> was found <a href="http://greendail.ru/node/495">to</a> turn on the VM when starting the server by writing a script and calling it from <code>/etc/rc.local</code> . <br><br>  But I wanted to, that the shutdown would work correctly, the edits in <code>/etc/inittab</code> did not help.  Editing files like <code>/sbin/shutdown.sh</code> and <code>/sbin/vmware-autostart.sh</code> did not bring <code>/sbin/vmware-autostart.sh</code> benefit, since  It turned out that the entire environment of the hypervisor is loaded into the RAM from the images and lives there. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was decided to make changes to the very image of the hypervisor. <br><br>  Especially for these purposes, autorun and auto-shutdown scripts were written, which take information about automatically started and shut down machines from the hypervisor itself, i.e.  having made changes in the configuration in the ‚ÄúVirtual Machines Startup / Shutdown‚Äù section, the scripts will correctly process them (unless the order is not observed, that is, it works on the principle of ‚ÄúAny Order‚Äù). <br><br>  1) autostart.sh: <br><br> <code>#!/bin/sh <br> <br> sleep_time=`/bin/vim-cmd hostsvc/autostartmanager/get_defaults | grep startDelay | sed "s/ //g" | sed "s/,//g" | awk 'FS="=" {print $2}'` <br> <br> for i in `/bin/vim-cmd hostsvc/autostartmanager/get_autostartseq | grep vim.VirtualMachine | sed "s/',//g" | awk 'FS=":" {print $2}'`; do <br> state=`/bin/vim-cmd vmsvc/power.getstate $i | grep Power` <br> if [ "$state" = "Powered off" ]; then <br> /bin/vim-cmd vmsvc/power.on $i <br> j=0 <br> while [ $j -le 3 ]; do <br> sleep $((sleep_time)) <br> state=`/bin/vim-cmd vmsvc/get.guestheartbeatStatus $i` <br> if [ "$state" = "green" ]; then <br> break <br> fi <br> j=$((j+1)) <br> done <br> fi <br> done</code> <br> <br>  2) autostop.sh: <br><br> <code>#!/bin/sh <br> <br> sleep_time=`/bin/vim-cmd hostsvc/autostartmanager/get_defaults | grep stopDelay | sed "s/ //g" | sed "s/,//g" | awk 'FS="=" {print $2}'` <br> <br> for i in `/bin/vim-cmd hostsvc/autostartmanager/get_autostartseq | grep vim.VirtualMachine | sed "s/',//g" | awk 'FS=":" {print $2}'`; do <br> state=`/bin/vim-cmd vmsvc/power.getstate $i | grep Power` <br> if [ "$state" = "Powered on" ]; then <br> /bin/vim-cmd vmsvc/power.shutdown $i <br> j=0 <br> while [ $j -le 3 ]; do <br> sleep $((sleep_time)) <br> state=`/bin/vim-cmd vmsvc/power.getstate $i | grep Power` <br> if [ "$state" = "Powered off" ]; then <br> break <br> fi <br> j=$((j+1)) <br> done <br> fi <br> done</code> <br> <br>  <b>!!!</b>  <b>All changes are made at your own risk, the author does not bear any responsibility for the consequences !!!</b> <br><br>  Initially, we will unpack gunzip the image file to the main storage: <br> <code>~ # gunzip &lt; /bootbank/s.v00 &gt; /vmfs/volumes/MainStorage/temp/tmp.vmtar</code> <br>  Let's go to the main repository and unpack once again what we got with the help of VmWare tar: <br> <code>~ # cd /vmfs/volumes/MainStorage/temp/ <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # vmtar -x tmp.vmtar -o tmp.tar</code> <br>  And only now just unpack tar'om (that's such a tricky nested doll): <br> <code>/vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # tar -xf tmp.tar</code> <br>  Delete the extra archives and see what happened: <br> <code>/vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # rm -f tmp.tar tmp.vmtar <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # ls -l <br> drwxr-xr-x 1 201 201 7280 Jun 5 16:18 bin <br> drwxr-xr-x 1 201 201 280 Apr 30 03:16 dev <br> drwxr-xr-x 1 201 201 6580 Jun 5 16:18 etc <br> drwxr-xr-x 1 201 201 17080 Jun 5 16:15 lib <br> drwxr-xr-x 1 201 201 420 Jun 5 16:15 lib32 <br> drwxr-xr-x 1 201 201 4900 Jun 5 16:15 lib64 <br> drwxr-xr-x 1 201 201 420 Jun 5 16:15 opt <br> drwxr-xr-x 1 201 201 280 Apr 30 03:21 proc <br> lrwxrwxrwx 1 201 201 23 Jun 5 16:15 productLocker -&gt; /locker/packages/5.0.0/ <br> drwxr-xr-x 1 201 201 19040 Jun 5 16:18 sbin <br> drwxrwxrwt 1 201 201 280 Apr 30 03:33 tmp <br> drwxr-xr-x 1 201 201 980 Jun 5 16:16 usr <br> drwxr-xr-x 1 201 201 1400 Jun 5 16:18 var <br> drwxr-xr-x 1 201 201 560 Jun 5 16:18 vmfs <br> drwxr-xr-x 1 201 201 560 Jun 5 16:18 vmimages <br> lrwxrwxrwx 1 201 201 18 Jun 5 16:18 vmupgrade -&gt; /locker/vmupgrade/</code> <br>  We are very interested in the contents of the sbin directory, go into it and copy the files for autorun and auto shutdown VM, change the owner and access rights like everyone else (like we are local): <br> <code>/vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # cd sbin/ <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # cp ../../autostart.sh . <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # cp ../../autostop.sh . <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # chown 201:201 autostart.sh autostop.sh <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # chmod a=rx autostart.sh autostop.sh</code> <br>  Let us change the vmware-autostart.sh file, add the autorun script call to the vmware_autostart_vms function end and add the auto-shutdown script call to the beginning of the vmware_autostop_vms function: <br> <code>/vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # chmod a+w vmware-autostart.sh <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # vi vmware-autostart.sh <br> # AutoStart vms if any ( Execute the subshell in the background ) <br> vmware_autostart_vms() { <br> ( <br> logger -t 'VMware[startup]' " Starting VMs" <br> -----8&lt;------------------------------------------------------------------------ <br> done # wait to start <br> ) &amp; <br> <br> <b>/sbin/autostart.sh</b> <br> <br> } <br> # AutoStop vms if any <br> vmware_autostop_vms() { <br> logger -t 'VMware[shutdown]' " Stopping VMs" <br> <br> <b>/sbin/autostop.sh</b> <br> <br> val=$("$VIMSH" -U $ROOT_USER $AUTOSTOP_CMD 2&gt;&amp;1 &gt; /dev/null) <br> -----8&lt;------------------------------------------------------------------------ <br> fi <br> }</code> <br>  Then we will return the rights back and pack the matryoshka back: <br> <code>/vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # chmod aw vmware-autostart.sh <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp/sbin # cd .. <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # tar -cf ../tmp.tar * <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed/temp # cd .. <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed # vmtar -c tmp.tar -o tmp.vmtar <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed # gzip &lt; tmp.vmtar &gt; s.v00</code> <br>  Change the access rights as they were and replace the existing file with ours, without forgetting to make backup beforehand: <br> <code>/vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed # chmod 700 s.v00 <br> /vmfs/volumes/4f72a981-4f940db0-18e9-001517ecc0ed # cp -f s.v00 /bootbank/s.v00</code> <br>  That's all, reboot, check and work. </div><p>Source: <a href="https://habr.com/ru/post/145428/">https://habr.com/ru/post/145428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145422/index.html">New versions of Windows Azure tools released, Python support added</a></li>
<li><a href="../145423/index.html">M2M Control Center</a></li>
<li><a href="../145424/index.html">Triple Play: how do telephone, TV and Internet get along in a single IP environment?</a></li>
<li><a href="../145425/index.html">ANSI Tattoo Girl</a></li>
<li><a href="../145427/index.html">An example of working with getUserMedia and <canvas> in the Zen Framework based on the ‚ÄúHTML5 Exploding Camera Demo‚Äù</a></li>
<li><a href="../145430/index.html">ActiveCloud cloud launched in Europe!</a></li>
<li><a href="../145431/index.html">100 programs on a smartphone or operating system logic?</a></li>
<li><a href="../145432/index.html">Free soup will no longer be</a></li>
<li><a href="../145435/index.html">Electric gearshift for bicycle</a></li>
<li><a href="../145436/index.html">How to send all tcp-traffic from the Windows guest system via Tor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>