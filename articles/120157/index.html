<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multithreading server in C # in 15 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C # is a fairly simple and flexible language. With .NET comes quite a few ready-made classes, which makes it even easier. So much so that it is quite ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multithreading server in C # in 15 minutes</h1><div class="post__text post__text-html js-mediator-article">  C # is a fairly simple and flexible language.  With .NET comes quite a few ready-made classes, which makes it even easier.  So much so that it is quite possible to write a simple multi-threaded HTTP server to render static content in just 15 minutes.  It would be possible to use the ready-made <a href="httplistener.aspx">HttpListener</a> class and manage it even faster, but the goal of this article is to show how you can do something similar in C #. <br><a name="habracut"></a><br>  First, create a new console project: <br><blockquote><code><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> <font color="black">Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> <ol> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li></li><li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li></li><li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/21794/s"></a> <a href="http://s-c.me/21794/h"></a> Copy Source | Copy HTML <font color="#0000ff">using</font> System; <font color="#0000ff">using</font> System.Collections.Generic; <font color="#0000ff">using</font> System.Text; <font color="#0000ff">namespace</font> HTTPServer { <font color="#0000ff">class</font> <font color="#2b91af">Server</font> { <font color="#0000ff">static void</font> Main( <font color="#0000ff">string</font> [] args) { } } }</font></code> </li> <li></li></ol></blockquote><br>  In .NET, you can very easily create a TCP server using the TcpListener class, which we will use: <br><blockquote> <code><a href="http://s-c.me/21796/s"></a> <a href="http://s-c.me/21796/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#2b91af">server</font> </li><li>  { </li><li>  <font color="#2b91af">TcpListener</font> Listener;  <font color="#008000">// Object accepting TCP clients</font> </li><li></li><li>  <font color="#008000">// Start the server</font> </li><li>  <font color="#0000ff">public</font> <font color="#2b91af">Server</font> ( <font color="#0000ff">int</font> Port) </li><li>  { </li><li>  <font color="#008000">// Create a "listener" for the specified port</font> </li><li>  Listener = <font color="#0000ff">new</font> <font color="#2b91af">TcpListener</font> (IPAddress.Any, Port); </li><li>  Listener.Start ();  <font color="#008000">// Run it</font> </li><li></li><li>  <font color="#008000">// In an infinite loop</font> </li><li>  <font color="#0000ff">while</font> ( <font color="#0000ff">true</font> ) </li><li>  { </li><li>  <font color="#008000">// Accept new customers</font> </li><li>  Listener.AcceptTcpClient (); </li><li>  } </li><li>  } </li><li></li><li>  <font color="#008000">// Stop Server</font> </li><li>  ~ <font color="#2b91af">Server</font> () </li><li>  { </li><li>  <font color="#008000">// If the "listener" was created</font> </li><li>  <font color="#0000ff">if</font> (Listener! = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  <font color="#008000">// stop it</font> </li><li>  Listener.Stop (); </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">static void</font> Main ( <font color="#0000ff">string</font> [] args) </li><li>  { </li><li>  <font color="#008000">// Create a new server on port 80</font> </li><li>  <font color="#0000ff">new</font> <font color="#2b91af">Server</font> ( <font color="#A31515">80</font> ); </li><li>  } </li><li>  } </li></ol></blockquote><br>  If you start the application now, you can already connect to port 80 and ... everything.  The connection will only be idle for nothing, since its handler is missing and it does not close on the server side. <br>  Let's write the easiest handler: <br><blockquote> <code><a href="http://s-c.me/21797/s"></a> <a href="http://s-c.me/21797/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// class handler client</font> </li><li>  <font color="#0000ff">class</font> <font color="#2b91af">Client</font> </li><li>  { </li><li>  <font color="#008000">// Constructor class.</font>  <font color="#008000">He needs to transfer the received client from TcpListener</font> </li><li>  <font color="#0000ff">public</font> <font color="#2b91af">Client</font> (TcpClient <font color="#2b91af">Client</font> ) </li><li>  { </li><li>  <font color="#008000">// Simple HTML Page Code</font> </li><li>  <font color="#0000ff">string</font> Html = <font color="#A31515">"&lt;html&gt; &lt;body&gt; &lt;h1&gt; It works! &lt;/ h1&gt; &lt;/ body&gt; &lt;/ html&gt;"</font> ; </li><li>  <font color="#008000">// Required headers: server response, content type and length.</font>  <font color="#008000">After two blank lines - the content itself</font> </li><li>  <font color="#0000ff">string</font> Str = <font color="#A31515">"HTTP / 1.1 200 OK \ nContent-type: text / html \ nContent-Length:"</font> + Html.Length.ToString () + <font color="#A31515">"\ n \ n"</font> + Html; </li><li>  <font color="#008000">// Let's bring the string to the form of the byte array</font> </li><li>  <font color="#0000ff">byte</font> [] <font color="#2b91af">Buffer</font> = Encoding.ASCII.GetBytes (Str); </li><li>  <font color="#008000">// Send it to the client</font> </li><li>  <font color="#2b91af">Client</font> .GetStream (). Write ( <font color="#2b91af">Buffer</font> , <font color="#A31515">0</font> , <font color="#2b91af">Buffer</font> .Length); </li><li>  <font color="#008000">// Close the connection</font> </li><li>  <font color="#2b91af">Client</font> .Close (); </li><li>  } </li><li>  } </li></ol></blockquote><br>  To transfer a client to it, you need to change one line in the Server class: <br><blockquote> <code><a href="http://s-c.me/21798/s"></a> <a href="http://s-c.me/21798/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Accept new clients and pass them on to the new instance of the Client class.</font> </li><li>  <font color="#0000ff">new</font> <font color="#2b91af">Client</font> (Listener.AcceptTcpClient ()); </li></ol></blockquote><br>  Now you can run the program, open <a href="http://127.0.0.1/">127.0.0.1</a> in the browser and see in capital letters ‚ÄúIt works!‚Äù <br>  Before we start writing the HTTP request parser, let's make our server multithreaded.  There are two ways to do this: manually create a new thread for each client or use a <a href="http://habrahabr.ru/blogs/net/109705/">thread pool</a> .  Both methods have their advantages and disadvantages.  If you create a stream for each client, then the server can not withstand high loads, but you can work with an almost unlimited number of clients at the same time.  If you use a thread pool, the number of threads that are simultaneously running will be limited, but you cannot create a new thread until the old ones are completed.  Which method is more suitable for you, I do not know, so I‚Äôll give an example of both. <br>  Let's write a simple flow procedure that will only create a new instance of the Client class: <br><blockquote> <code><a href="http://s-c.me/21800/s"></a> <a href="http://s-c.me/21800/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">static void</font> ClientThread ( <font color="#2b91af">Object</font> StateInfo) </li><li>  { </li><li>  <font color="#0000ff">new</font> <font color="#2b91af">Client</font> ((TcpClient) StateInfo); </li><li>  } </li></ol></blockquote><br>  To use the first method, you need to replace only the contents of our endless customer reception cycle: <br><blockquote> <code><a href="http://s-c.me/21806/s"></a> <a href="http://s-c.me/21806/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Accept new customer</font> </li><li>  TcpClient Client = Listener.AcceptTcpClient (); </li><li>  <font color="#008000">// Create a stream</font> </li><li>  <font color="#2b91af">Thread Thread</font> = <font color="#0000ff">new</font> <font color="#2b91af">Thread</font> ( <font color="#0000ff">new</font> <font color="#2b91af">ParameterizedThreadStart</font> (ClientThread)); </li><li>  <font color="#008000">// And launch this stream, passing it the received client</font> </li><li>  <font color="#2b91af">Thread</font> .Start (Client); </li></ol></blockquote><br>  For the second method you need to do the same: <br><blockquote> <code><a href="http://s-c.me/21805/s"></a> <a href="http://s-c.me/21805/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Accept new customers.</font>  <font color="#008000">After the client has been accepted, it is transferred to the new thread (ClientThread)</font> </li><li>  <font color="#008000">// using the thread pool.</font> </li><li>  ThreadPool.QueueUserWorkItem ( <font color="#0000ff">new</font> <font color="#2b91af">WaitCallback</font> (ClientThread), Listener.AcceptTcpClient ()); </li></ol></blockquote><br>  Plus it is necessary to set the maximum and minimum number of simultaneously running threads.  We do this in the Main procedure: <br><blockquote> <code><a href="http://s-c.me/21808/s"></a> <a href="http://s-c.me/21808/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Determine the desired maximum number of threads</font> </li><li>  <font color="#008000">// Let it be 4 per processor</font> </li><li>  <font color="#0000ff">int</font> MaxThreadsCount = <font color="#2b91af">Environment</font> .ProcessorCount * <font color="#A31515">4</font> ; </li><li>  <font color="#008000">// Set the maximum number of worker threads</font> </li><li>  ThreadPool.SetMaxThreads (MaxThreadsCount, MaxThreadsCount); </li><li>  <font color="#008000">// Set the minimum number of worker threads</font> </li><li>  ThreadPool.SetMinThreads ( <font color="#A31515">2</font> , <font color="#A31515">2</font> ); </li></ol></blockquote><br>  The maximum number of threads must be at least two, since this number includes the main thread.  If you set the unit, then client processing will be possible only when the main thread has suspended work (for example, it is waiting for a new client or the Sleep procedure has been called). <br>  So, now let's switch entirely to the Client class and start processing the HTTP request.  Get the request text from the client: <br><blockquote> <code><a href="http://s-c.me/21810/s"></a> <a href="http://s-c.me/21810/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Declare a line in which the client request will be stored</font> </li><li>  <font color="#0000ff">string</font> Request = <font color="#A31515">""</font> ; </li><li>  <font color="#008000">// Buffer for storing data received from the client</font> </li><li>  <font color="#0000ff">byte</font> [] <font color="#2b91af">Buffer</font> = <font color="#0000ff">new byte</font> [ <font color="#A31515">1024</font> ]; </li><li>  <font color="#008000">// Variable to store the number of bytes received from the client</font> </li><li>  <font color="#0000ff">int</font> Count; </li><li>  <font color="#008000">// Read from the client's stream until data from it is received</font> </li><li>  <font color="#0000ff">while</font> ((Count = Client.GetStream (). Read ( <font color="#2b91af">Buffer</font> , <font color="#A31515">0</font> , <font color="#2b91af">Buffer</font> .Length))&gt; <font color="#A31515">0</font> ) </li><li>  { </li><li>  <font color="#008000">// Convert this data to a string and add it to the Request variable</font> </li><li>  Request + = Encoding.ASCII.GetString ( <font color="#2b91af">Buffer</font> , <font color="#A31515">0</font> , Count); </li><li>  <font color="#008000">// The request must be terminated by the sequence \ r \ n \ r \ n</font> </li><li>  <font color="#008000">// Either stop receiving the data themselves if the length of the Request string exceeds 4 kilobytes</font> </li><li>  <font color="#008000">// We do not need to receive data from a POST request (and so on), but a regular request</font> </li><li>  <font color="#008000">// in theory should not be more than 4 kilobytes</font> </li><li>  <font color="#0000ff">if</font> (Request.IndexOf ( <font color="#A31515">"\ r \ n \ r \ n"</font> )&gt; = <font color="#A31515">0</font> || Request.Length&gt; <font color="#A31515">4096</font> ) </li><li>  { </li><li>  <font color="#0000ff">break</font> ; </li><li>  } </li><li>  } </li></ol></blockquote><br>  Next, we carry out the parsing of the data: <blockquote> <code><a href="http://s-c.me/21814/s"></a> <a href="http://s-c.me/21814/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Parsing the query string using regular expressions</font> </li><li>  <font color="#008000">// At the same time cut off all the variables of the GET request</font> </li><li>  <font color="#2b91af">Match</font> ReqMatch = <font color="#2b91af">Regex</font> .  <font color="#2b91af">Match</font> (Request, <font color="#A31515">@ "^ \ w + \ s + ([^ \ s \?] +) [^ \ S] * \ s + HTTP /.* |"</font> ); </li><li></li><li>  <font color="#008000">// If the request failed</font> </li><li>  <font color="#0000ff">if</font> (ReqMatch == <font color="#2b91af">Match</font> .Empty) </li><li>  { </li><li>  <font color="#008000">// Pass error 400 to the client - invalid request</font> </li><li>  SendError (Client, <font color="#A31515">400</font> ); </li><li>  <font color="#0000ff">return</font> ; </li><li>  } </li><li></li><li>  <font color="#008000">// Get the query string</font> </li><li>  <font color="#0000ff">string</font> RequestUri = ReqMatch.Groups [ <font color="#A31515">1</font> ] .Value; </li><li></li><li>  <font color="#008000">// Bring it to its original form, converting escaped characters</font> </li><li>  <font color="#008000">// For example, "% 20" -&gt; ""</font> </li><li>  RequestUri = <font color="#2b91af">Uri</font> .UnescapeDataString (RequestUri); </li><li></li><li>  <font color="#008000">// If the line contains a colon, pass error 400</font> </li><li>  <font color="#008000">// This is needed to protect against URLs like http://example.com/../../file.txt</font> </li><li>  <font color="#0000ff">if</font> (RequestUri.IndexOf ( <font color="#A31515">".."</font> )&gt; = <font color="#A31515">0</font> ) </li><li>  { </li><li>  SendError (Client, <font color="#A31515">400</font> ); </li><li>  <font color="#0000ff">return</font> ; </li><li>  } </li><li></li><li>  <font color="#008000">// If the query string ends in "/", then add to it index.html</font> </li><li>  <font color="#0000ff">if</font> (RequestUri.EndsWith ( <font color="#A31515">"/"</font> )) </li><li>  { </li><li>  RequestUri + = <font color="#A31515">"index.html"</font> ; </li><li>  } </li></ol></blockquote><br>  Finally, let's work with the files: check if there is a necessary file, determine its content type and transfer it to the client. <br><blockquote> <code><a href="http://s-c.me/21818/s"></a> <a href="http://s-c.me/21818/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">string</font> FilePath = <font color="#A31515">"www /"</font> + RequestUri; </li><li></li><li>  <font color="#008000">// If this file does not exist in the www folder, send a 404 error</font> </li><li>  <font color="#0000ff">if</font> (! <font color="#2b91af">File</font> .Exists (FilePath)) </li><li>  { </li><li>  SendError (Client, <font color="#A31515">404</font> ); </li><li>  <font color="#0000ff">return</font> ; </li><li>  } </li><li></li><li>  <font color="#008000">// Get the file extension from the query string</font> </li><li>  <font color="#0000ff">string</font> Extension = RequestUri.Substring (RequestUri.LastIndexOf ( <font color="#A31515">'.'</font> )); </li><li></li><li>  <font color="#008000">// Content type</font> </li><li>  <font color="#0000ff">string</font> ContentType = <font color="#A31515">""</font> ; </li><li></li><li>  <font color="#008000">// Trying to determine the content type by file extension</font> </li><li>  <font color="#0000ff">switch</font> (Extension) </li><li>  { </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".htm"</font> : </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".html"</font> : </li><li>  ContentType = <font color="#A31515">"text / html"</font> ; </li><li>  <font color="#0000ff">break</font> ; </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".css"</font> : </li><li>  ContentType = <font color="#A31515">"text / stylesheet"</font> ; </li><li>  <font color="#0000ff">break</font> ; </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".js"</font> : </li><li>  ContentType = <font color="#A31515">"text / javascript"</font> ; </li><li>  <font color="#0000ff">break</font> ; </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".jpg"</font> : </li><li>  ContentType = <font color="#A31515">"image / jpeg"</font> ; </li><li>  <font color="#0000ff">break</font> ; </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".jpeg"</font> : </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".png"</font> : </li><li>  <font color="#0000ff">case</font> <font color="#A31515">".gif"</font> : </li><li>  ContentType = <font color="#A31515">"image /"</font> + Extension.Substring ( <font color="#A31515">1</font> ); </li><li>  <font color="#0000ff">break</font> ; </li><li>  <font color="#0000ff">default</font> : </li><li>  <font color="#0000ff">if</font> (Extension.Length&gt; <font color="#A31515">1</font> ) </li><li>  { </li><li>  ContentType = <font color="#A31515">"application /"</font> + Extension.Substring ( <font color="#A31515">1</font> ); </li><li>  } </li><li>  <font color="#0000ff">else</font> </li><li>  { </li><li>  ContentType = <font color="#A31515">"application / unknown"</font> ; </li><li>  } </li><li>  <font color="#0000ff">break</font> ; </li><li>  } </li><li></li><li>  <font color="#008000">// Open the file, insuring against errors</font> </li><li>  <font color="#2b91af">FileStream</font> FS; </li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  FS = <font color="#0000ff">new</font> <font color="#2b91af">FileStream</font> (FilePath, FileMode.Open, FileAccess.Read, FileShare.Read); </li><li>  } </li><li>  <font color="#0000ff">catch</font> ( <font color="#2b91af">Exception</font> ) </li><li>  { </li><li>  <font color="#008000">// If an error occurs, send error 500 to the client</font> </li><li>  SendError (Client, <font color="#A31515">500</font> ); </li><li>  <font color="#0000ff">return</font> ; </li><li>  } </li><li></li><li>  <font color="#008000">// Send Headers</font> </li><li>  <font color="#0000ff">string</font> Headers = <font color="#A31515">"HTTP / 1.1 200 OK \ nContent-Type:"</font> + ContentType + <font color="#A31515">"\ nContent-Length:"</font> + FS.Length + <font color="#A31515">"\ n \ n"</font> ; </li><li>  <font color="#0000ff">byte</font> [] HeadersBuffer = Encoding.ASCII.GetBytes (Headers); </li><li>  Client.GetStream (). Write (HeadersBuffer, <font color="#A31515">0</font> , HeadersBuffer.Length); </li><li></li><li>  <font color="#008000">// Until the end of the file is reached</font> </li><li>  <font color="#0000ff">while</font> (FS.Position &lt;FS.Length) </li><li>  { </li><li>  <font color="#008000">// Read data from file</font> </li><li>  Count = FS.Read ( <font color="#2b91af">Buffer</font> , <font color="#A31515">0</font> , <font color="#2b91af">Buffer</font> .Length); </li><li>  <font color="#008000">// And pass them on to the client.</font> </li><li>  Client.GetStream (). Write ( <font color="#2b91af">Buffer</font> , <font color="#A31515">0</font> , Count); </li><li>  } </li><li></li><li>  <font color="#008000">// Close The File And Connection</font> </li><li>  FS.Close (); </li><li>  Client.Close (); </li></ol></blockquote><br>  Also in the code, the not yet described procedure SendError was mentioned.  We will write it too: <br><blockquote> <code><a href="http://s-c.me/21817/s"></a> <a href="http://s-c.me/21817/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#008000">// Send the page with an error</font> </li><li>  <font color="#0000ff">private void</font> SendError ( <font color="#2b91af">TcpClient</font> Client, <font color="#0000ff">int</font> Code) </li><li>  { </li><li>  <font color="#008000">// Get a string like "200 OK"</font> </li><li>  <font color="#008000">// HttpStatusCode stores all HTTP / 1.1 status codes</font> </li><li>  <font color="#0000ff">string</font> CodeStr = Code.ToString () + <font color="#A31515">""</font> + ((HttpStatusCode) Code) .ToString (); </li><li>  <font color="#008000">// Simple HTML Page Code</font> </li><li>  <font color="#0000ff">string</font> Html = <font color="#A31515">"&lt;html&gt; &lt;body&gt; &lt;h1&gt;"</font> + CodeStr + <font color="#A31515">"&lt;/ h1&gt; &lt;/ body&gt; &lt;/ html&gt;"</font> ; </li><li>  <font color="#008000">// Required headers: server response, content type and length.</font>  <font color="#008000">After two blank lines - the content itself</font> </li><li>  <font color="#0000ff">string</font> Str = <font color="#A31515">"HTTP / 1.1"</font> + CodeStr + <font color="#A31515">"\ nContent-type: text / html \ nContent-Length:"</font> + Html.Length.ToString () + <font color="#A31515">"\ n \ n"</font> + Html; </li><li>  <font color="#008000">// Let's bring the string to the form of the byte array</font> </li><li>  <font color="#0000ff">byte</font> [] <font color="#2b91af">Buffer</font> = Encoding.ASCII.GetBytes (Str); </li><li>  <font color="#008000">// Send it to the client</font> </li><li>  Client.GetStream (). Write ( <font color="#2b91af">Buffer</font> , <font color="#A31515">0</font> , <font color="#2b91af">Buffer</font> .Length); </li><li>  <font color="#008000">// Close the connection</font> </li><li>  Client.Close (); </li><li>  } </li></ol></blockquote><br>  This is the end of writing a simple HTTP server.  It works in several threads, gives statics, has a simple protection against bad requests and swears at the missing files.  Additional gadgets can be added to all of this: configurable, domain processing, changing addresses like mod_rewrite, even CGI support.  But it will be a completely different story :-) <br><br>  <a href="httpserver/source.html">Source (via ThreadPool)</a> <br>  <a href="httpserver/source2.html">Source (via Thread)</a> <br>  <a href="http://test.nizarium.com/">The archive with the source (via ThreadPool, the option via Thread is commented out)</a> <br>  <a href="http://test.nizarium.com/">Archive with compiled version (via ThreadPool)</a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/120157/">https://habr.com/ru/post/120157/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120152/index.html">HTML5 placeholder styling with CSS</a></li>
<li><a href="../120153/index.html">Competition. Wrote an article - get a year of free VPN (+ news)</a></li>
<li><a href="../120154/index.html">How to programmatically find out the hardware characteristics of the device on Windows Phone 7.1. Mango</a></li>
<li><a href="../120155/index.html">Kenko Extension Tubes</a></li>
<li><a href="../120156/index.html">Vogue-Tec News # 2</a></li>
<li><a href="../120158/index.html">From ship to ball / The ReactOS project is actively involved in the struggle for public investment</a></li>
<li><a href="../120159/index.html">Recognition of handwritten mathematical expressions</a></li>
<li><a href="../120160/index.html">Mouse. Inside view</a></li>
<li><a href="../120161/index.html">Google closed Google Translate API</a></li>
<li><a href="../120162/index.html">Idea Success Analyzer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>