<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributed cluster of two Fortigate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently completed a project with a client to build a fault-tolerant network infrastructure. While the memories are alive - and the documentation is a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributed cluster of two Fortigate</h1><div class="post__text post__text-html js-mediator-article">  Recently completed a project with a client to build a fault-tolerant network infrastructure.  While the memories are alive - and the documentation is at hand, I want to share a unique know-how.  What is unique?  The fact that such a configuration is not mentioned anywhere in official documents Fortinet is not recommended and does not officially exist at all.  Also, no mention of this configuration was found on the Internet. <br><br>  <strong>So, what we have available:</strong> <br>  Two spaced sites, office and data center (DC).  Each site has independent access to the Internet and local subnet.  Between sites there is a dedicated connection with the ability to create your own VLANs.  From the equipment, there are two Fortigate 100D and four Cisco Catalyst 2960XR managed switches with a Stacking Module.  Those.  two switches and one fortigge to the site. <br><br>  <strong>Task:</strong> <br>  Provide fault tolerance and continuity of communication <br>  1) in case of failure of any one piece of iron. <br>  2) in the case of the fall of any of the communication channels. <br>  3) in case of failure of any one port on any of the glands 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If we had 2 forgates per site - there would be no problem at all - we set up a standard cluster of two forgates at each site, dynamic routing and enjoying life.  However, with the equipment we have what we have, so we have to get bogged down. <br><br>  At the beginning of the equipment, there was even less - one switch and one fortigate per platform, but in this article I will describe the final configuration. <br><br>  So let's start: <br><a name="habracut"></a><br>  Let's designate SW1 and FG1 as the stack of switches in the office and fortigate in the office.  SW2 and FG2 are similar glands in the datacenter. <br><br>  For the correct configuration of all we need 5 logical ports on each forgate (5 logical = 10 physical).  Denote them as: <br><br><ul><li>  Office_Internet </li><li>  DC_Internet </li><li>  Office_Lan </li><li>  DC_Lan </li><li>  Interconnect </li></ul><br>  We also use both HA ports to ensure cluster synchronization, which adds another 2 ports to those used on the switch.  In total, 6 ports on each physical switch (or 12 ports on a stack of switches) will be used only to connect forgates. <br><br>  <b>Layer1 configuration (physical connections):</b> <br>  I assume that the stack of switches is already assembled, since  no difficulty there. <br>  We connect fortigates to switches according to the following scheme: <br><br>  For DC_Internet <br><br><pre><code class="hljs">FG1-WAN1 - SW1-1/0/1 FG1-WAN2 - SW1-2/0/1</code> </pre> <br>  For Office_Internet <br><br><pre> <code class="hljs">FG1-DMZ - SW1-1/0/2 FG1-Port1 - SW1-2/0/2</code> </pre> <br>  For Office_Lan <br><br><pre> <code class="hljs">FG1-DMZ - SW1-1/0/3 FG1-Port1 - SW1-2/0/3</code> </pre> <br>  For DC_Lan <br><br><pre> <code class="hljs">FG1-Port2 - SW1-1/0/4 FG1-Port3 - SW1-2/0/4</code> </pre> <br>  For interconnect <br><br><pre> <code class="hljs">FG1-Port4 - SW1-1/0/5 FG1-Port5 - SW1-2/0/5</code> </pre> <br>  For HA1 and HA2 <br><br><pre> <code class="hljs">FG1-HA1 - SW1-1/0/6 FG1-HA2 - SW1-2/0/6</code> </pre> <br>  Repeat the operation similarly for FG2 and SW2. <br><br>  Now you need to plug in switches links coming from the provider.  In my case, these are 2 connections to the Internet and the channel between the DC and the office, respectively, the configuration will be slightly different between the two sites.  Again, in my particular case, the providers provided two links to the Internet and 2 links for interconnect on each side. <br><br>  If you can‚Äôt get 2 links to each channel - then one of the requirements will remain partially unfulfilled - in case of a port exit on the switch where the link from the provider is connected, there will be a loss of communication. <br><br>  Here we will connect downlinkas to Access switches in the office and DC. <br><br>  We connect in the office: <br><br><pre> <code class="hljs">SW1-1/0/22 -   Office_LAN  1 SW1-2/0/22 -   Office_LAN  2 SW1-1/0/23 -       1 SW1-2/0/23 -       2 SW1-1/0/24 -  -  1 SW1-2/0/24 -  -  2</code> </pre> <br>  We connect to DC: <br><br><pre> <code class="hljs">SW1-1/0/22 -   DC_LAN  1 SW1-2/0/22 -   DC_LAN  2 SW2-1/0/23 -       1 SW2-2/0/23 -       2 SW2-1/0/24 -  -  1 SW2-2/0/24 -  -  2</code> </pre> <br>  With Layer 1 finished, you can navigate to the Port Aggregation and VLAN configuration. <br><br>  <b>Layer 2</b> <br>  At this stage, you need to configure a pair of ports on switches and fortigets, and assign a VLAN to limit traffic. <br><br>  - Create the necessary VLANs on the switches and assign ports in them: <br><br>  on switches in configuration mode we create the necessary VLANs <br><br><pre> <code class="hljs pgsql">vlan <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> DC_Internet vlan <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> Office_Internet vlan <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> Office_Lan vlan <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> DC_LAN vlan <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> Interconnect vlan <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> HA</code> </pre> <br>  In the same place on the switches we create a port-channel and assign ports in them: <br><br>  For DC_Internet: <br><br><pre> <code class="hljs vhdl">Interface <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>-channel1 switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">10</span></span> # VLAN <span class="hljs-number"><span class="hljs-number">10</span></span> = DC_Internet switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> mode passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> mode passive</code> </pre><br>  Repeat for the above pairs of ports and get the port-channel 2-4 <br><br>  For Interconnect: <br><br><pre> <code class="hljs vhdl">Interface <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>-channel5 switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">50</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">50</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> mode passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">50</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> mode passive</code> </pre><br>  Slightly different configuration for HA1 and HA2  there is no port aggregation <br>  For HA1 <br><br><pre> <code class="hljs pgsql">Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">60</span></span> # Vlan <span class="hljs-number"><span class="hljs-number">60</span></span> = HA switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span></code> </pre><br>  For HA2 <br><br><pre> <code class="hljs pgsql">Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">60</span></span> # Vlan <span class="hljs-number"><span class="hljs-number">60</span></span> = HA switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span></code> </pre><br>  For the Office-DC Channel: <br><br><pre> <code class="hljs dos">Interface port-channel6 switchport <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> trunk # <span class="hljs-variable"><span class="hljs-variable">!!!</span></span> Trunk Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> switchport <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> trunk channel-group <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> switchport <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> trunk channel-group <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> passive</code> </pre><br>  The above configuration for Layer2 is the same for the office and DC, below are the different parts of the config. <br><br>  <b>In the office:</b> <br><br><pre> <code class="hljs vhdl">Interface <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>-channel7 switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">30</span></span> # VLAN <span class="hljs-number"><span class="hljs-number">30</span></span> = Office_Lan switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">22</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">30</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> mode passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">22</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">30</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> mode passive Interface <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>-channel8 switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">20</span></span> # VLAN <span class="hljs-number"><span class="hljs-number">20</span></span> = Office_Internet switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">20</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> mode passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">20</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> mode passive</code> </pre><br>  <b>In DC:</b> <br><br><pre> <code class="hljs vhdl">Interface <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>-channel7 switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">40</span></span> # VLAN <span class="hljs-number"><span class="hljs-number">40</span></span> = DC_Lan switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">22</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">40</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> mode passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">22</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">40</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> mode passive Interface <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>-channel8 switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">10</span></span> # VLAN <span class="hljs-number"><span class="hljs-number">10</span></span> = DC_Internet switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> Interface GigabitEthernet1/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> mode passive Interface GigabitEthernet2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> switchport <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport mode <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> channel-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> mode passive</code> </pre><br>  From the side of forgates: <br><br>  1. Turn on VDOM support <br>  2. Configure Virtual Cluster Support <br>  3. Scatter ports - each in its own VDOM <br>  4. Create Port Aggregation 802.3ad Port Pairs <br><br>  This is how the code looks like: <br><br><div class="spoiler">  <b class="spoiler_title">Lot of code</b> <div class="spoiler_text"><pre> <code class="hljs sql">config system interface edit "wan1" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"dmz"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"wan2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"ha1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"root"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"ha2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"root"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> down <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port3"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port4"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port5"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port6"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port7"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port8"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> down <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port9"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> down <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"port10"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"root"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> down <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"lan"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"root"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> down <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> hard-<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"DC_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.224</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allowaccess ping https ssh <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">member</span></span> <span class="hljs-string"><span class="hljs-string">"wan1"</span></span> <span class="hljs-string"><span class="hljs-string">"wan2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"Office_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.248</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allowaccess ping https <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">member</span></span> <span class="hljs-string"><span class="hljs-string">"port5"</span></span> <span class="hljs-string"><span class="hljs-string">"dmz"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"Office-LAN"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dhcp-relay-service <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allowaccess ping https ssh <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">member</span></span> <span class="hljs-string"><span class="hljs-string">"port6"</span></span> <span class="hljs-string"><span class="hljs-string">"port1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"DC-LAN"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allowaccess ping https ssh <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">member</span></span> <span class="hljs-string"><span class="hljs-string">"port7"</span></span> <span class="hljs-string"><span class="hljs-string">"port2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"Intercon-Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allowaccess ping <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">member</span></span> <span class="hljs-string"><span class="hljs-string">"port8"</span></span> <span class="hljs-string"><span class="hljs-string">"port3"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"Intercon-DC"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> allowaccess ping <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">member</span></span> <span class="hljs-string"><span class="hljs-string">"port9"</span></span> <span class="hljs-string"><span class="hljs-string">"port4"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> ha <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">"aaa.com"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span> ap <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> ENC xxx <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> hbdev <span class="hljs-string"><span class="hljs-string">"ha1"</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> arps <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> arps-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>-pickup <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">failed</span></span>-signal <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ha-mgmt-<span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ha-mgmt-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-string"><span class="hljs-string">"mgmt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vcluster2 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> override <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> monitor <span class="hljs-string"><span class="hljs-string">"Office_internet"</span></span> <span class="hljs-string"><span class="hljs-string">"Office_LAN"</span></span> <span class="hljs-string"><span class="hljs-string">"Intercon_Office"</span></span> config secondary-vcluster <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> override <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-number"><span class="hljs-number">250</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> monitor <span class="hljs-string"><span class="hljs-string">"DC_Internet"</span></span> <span class="hljs-string"><span class="hljs-string">"DC_LAN"</span></span> <span class="hljs-string"><span class="hljs-string">"Intercon_DC"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vdom <span class="hljs-string"><span class="hljs-string">"DataCenter"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br>  This is all for Layer 2, go to <b>Layer 3+</b> .  Here we need: <br><br>  - enable marshurt <br>  - configure routing monitoring <br>  - configure firewall rules <br>  - set up VPN in case the channel falls between the office and the DC <br><br>  On the switches do not need anything.  On fortigeit (after setting up the cluster, we manage one piece of iron): <br><br><div class="spoiler">  <b class="spoiler_title">Routing and Routing Monitoring</b> <div class="spoiler_text"><pre> <code class="hljs sql">config vdom edit DataCenter config router static edit 1 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> device <span class="hljs-string"><span class="hljs-string">"DC_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dst <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> device <span class="hljs-string"><span class="hljs-string">"Intercon-DC"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> distance <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> device <span class="hljs-string"><span class="hljs-string">"Intercon-DC"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-monitor edit <span class="hljs-string"><span class="hljs-string">"DC-Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcintf <span class="hljs-string"><span class="hljs-string">"DC_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-string"><span class="hljs-string">"2.2.2.3"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway-ip <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"Interconnect"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcintf <span class="hljs-string"><span class="hljs-string">"Intercon-DC"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.150.1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway-ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config vdom edit Office config router <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> edit <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> distance <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> device <span class="hljs-string"><span class="hljs-string">"Office_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dst <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> device <span class="hljs-string"><span class="hljs-string">"Intercon-Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> distance <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> device <span class="hljs-string"><span class="hljs-string">"Intercon-Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-monitor edit <span class="hljs-string"><span class="hljs-string">"Office-Internet-Check"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcintf <span class="hljs-string"><span class="hljs-string">"Office_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-string"><span class="hljs-string">"1.1.1.2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway-ip <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> edit <span class="hljs-string"><span class="hljs-string">"Interconnect"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcintf <span class="hljs-string"><span class="hljs-string">"Intercon-Office"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.150.2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gateway-ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre></div></div><br>  Now, if any Internet channel falls, the static route to the Internet will be deleted and the route will be activated through the official channel, if the channel is restored, everything will return as it was. <br><br>  It remains to create firewall rules (I hope this will be mastered by yourself).  You just need to remember that the same traffic can come from different interfaces (Internet or interconnect). <br><br>  And also create a VPN connection for connecting sites in the event of a DC channel falling - office. <br><br><div class="spoiler">  <b class="spoiler_title">VPN configuration</b> <div class="spoiler_text"><pre> <code class="hljs sql">config vdom edit DataCenter config vpn ipsec phase1 edit "site-to-site" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-string"><span class="hljs-string">"DC_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nattraversal <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> proposal aes256-sha256 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dhgrp <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> remote-gw <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> psksecret ENC xxx <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config vpn ipsec phase2 edit <span class="hljs-string"><span class="hljs-string">"p2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> phase1name <span class="hljs-string"><span class="hljs-string">"site-to-site"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> proposal aes256-sha256 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> pfs <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> replay <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>-negotiate <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> src-addr-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dst-addr-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> src-<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.200.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dst-<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.100.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config vdom edit Office config vpn ipsec phase1 edit <span class="hljs-string"><span class="hljs-string">"site-to-site"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-string"><span class="hljs-string">"Office_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nattraversal <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> proposal aes256-sha256 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dhgrp <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> remote-gw <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> psksecret ENC xxx <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config vpn ipsec phase2 edit <span class="hljs-string"><span class="hljs-string">"p2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> phase1name <span class="hljs-string"><span class="hljs-string">"site-to-site"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> proposal aes256-sha256 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> pfs <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> replay <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> keepalive <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>-negotiate <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> src-addr-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dst-addr-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> src-<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.100.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dst-<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.200.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br>  And the corresponding firewall rules: <br><div class="spoiler">  <b class="spoiler_title">Firewall rules</b> <div class="spoiler_text"><pre> <code class="hljs sql">config vdom edit Office config firewall policy edit 20 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcintf <span class="hljs-string"><span class="hljs-string">"Office-LAN"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dstintf <span class="hljs-string"><span class="hljs-string">"Office_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcaddr <span class="hljs-string"><span class="hljs-string">"192.168.100.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dstaddr <span class="hljs-string"><span class="hljs-string">"192.168.200.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> ipsec <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> schedule <span class="hljs-string"><span class="hljs-string">"always"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> service <span class="hljs-string"><span class="hljs-string">"ALL"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> inbound <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> outbound <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vpntunnel <span class="hljs-string"><span class="hljs-string">"site-to-site"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> config vdom edit DataCenter edit <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcintf <span class="hljs-string"><span class="hljs-string">"DC-LAN"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dstintf <span class="hljs-string"><span class="hljs-string">"DC_Internet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> srcaddr <span class="hljs-string"><span class="hljs-string">"192.168.200.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dstaddr <span class="hljs-string"><span class="hljs-string">"192.168.100.x"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> ipsec <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> schedule <span class="hljs-string"><span class="hljs-string">"always"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> service <span class="hljs-string"><span class="hljs-string">"ALL"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> inbound <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> outbound <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vpntunnel <span class="hljs-string"><span class="hljs-string">"site-to-site"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span></code> </pre></div></div><br>  As a result, VPN will rise only in the event of a fall in the office-dts channel. <br><br>  What we got in the end: <br><br>  <strong>1.</strong> Aggregation of ports protects us from the fall of either one port or the entire switch (with the exception of channels with one wire from the provider). <br><br>  <strong>2.</strong> A virtual cluster of fortigets will work as a router for the network, and in a normal situation, the fortigate in the office will always redirect packets for its network zone, and the forgigate to the DC for its own.  In the event of a fall of one of the forgates, all traffic will be routed by the second forgate. <br><br>  <strong>3.</strong> In the case of the fall of one of the Internet channels - all traffic will go through another channel, and come back as soon as the channel rises to the Internet. <br><br>  <strong>4.</strong> In the case of the fall of the office-dz channel, the traffic will go through the automatically rising VPN and will follow it until the channel is restored. <br><br>  It turned out a lot and probably at first sight difficult - but if you have questions, I am ready to answer them. </div><p>Source: <a href="https://habr.com/ru/post/308460/">https://habr.com/ru/post/308460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308448/index.html">Neural networks for curious programmers (with an example in c #)</a></li>
<li><a href="../308450/index.html">History of programming languages: from Objective C to Swift</a></li>
<li><a href="../308452/index.html">7 days left to buy Early Bird tickets for MBLTdev 16</a></li>
<li><a href="../308454/index.html">From Babylon to Europe</a></li>
<li><a href="../308458/index.html">How the media survive in a crisis: the experience of world media</a></li>
<li><a href="../308462/index.html">Heisenbag, or how the Moon spoils the code</a></li>
<li><a href="../308464/index.html">Initial rakes in working with Service Bus for Windows Server</a></li>
<li><a href="../308466/index.html">More than 25 million accounts of mail.ru gaming forums have been stolen by intruders</a></li>
<li><a href="../308468/index.html">Keyboard switch according to OS X</a></li>
<li><a href="../308470/index.html">Linux is 25 years old</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>