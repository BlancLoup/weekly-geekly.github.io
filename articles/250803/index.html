<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized logs for applications using heka + elasticsearch + kibana</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article describes how to set up central logging for various types of applications (Python, Java (java.util.logging), Go, bash) using a fairly new ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized logs for applications using heka + elasticsearch + kibana</h1><div class="post__text post__text-html js-mediator-article">  The article describes how to set up central logging for various types of applications (Python, Java (java.util.logging), Go, bash) using a fairly new Heka project. <br><br>  Heka is developed in Mozilla and written in Go.  That is why I use it instead of logstash, which has similar capabilities. <br><a name="habracut"></a><br>  Heka is based on plugins that are of five types: <br><ol><li>  Input - somehow receive data (listens to ports, read files, etc.); </li><li>  Decoders - process incoming requests and translate them into internal structures for messages; </li><li>  Filters - make any actions with messages; </li><li>  Encoders (it is not clear how to translate) - encode internal messages into formats that are sent via output plugins; </li><li>  Weekend - send somewhere data. </li></ol><br>  For example, in the case of Java applications, the input plugin is LogstreamerInput, which looks for changes in the log file.  New lines in the log are processed by the PayloadRegexDecoder decoder (according to a specified format) and then sent to elasticsearch via the output plugin ElasticSearchOutput.  The output plug-in, in turn, encodes the message from the internal structure to the elasticsearch format via ESJsonEncoder. <br><br><h2>  Heka installation </h2><br>  All installation methods are described on the website ( <a href="http://hekad.readthedocs.org/en/v0.8.2/installing.html">http://hekad.readthedocs.org/en/v0.8.2/installing.html#binaries</a> ).  But the easiest way to download a ready-made binary package for your system is from <a href="https://github.com/mozilla-services/heka/releases">https://github.com/mozilla-services/heka/releases</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since I use servers under ubuntu, the description will be for this system.  In this case, the installation is reduced to installing the deb package itself, setting up the /etc/hekad.toml configuration file and adding it to the upstart services. <br><br>  The basic configuration of /etc/hekad.toml includes setting up the number of processes (I set equal to the number of cores), the dashboard (where you can see which plugins are included), and the udp server on port 5565, which is waiting for messages using the google protobuf protocol (used for python and go applications): <br><br><pre><code class="hljs scala">maxprocs = <span class="hljs-number"><span class="hljs-number">4</span></span> [<span class="hljs-type"><span class="hljs-type">Dashboard</span></span>] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-string"><span class="hljs-string">"DashboardOutput"</span></span> address = <span class="hljs-string"><span class="hljs-string">":4352"</span></span> ticker_interval = <span class="hljs-number"><span class="hljs-number">15</span></span> [<span class="hljs-type"><span class="hljs-type">UdpInput</span></span>] address = <span class="hljs-string"><span class="hljs-string">"127.0.0.1:5565"</span></span> parser_type = <span class="hljs-string"><span class="hljs-string">"message.proto"</span></span> decoder = <span class="hljs-string"><span class="hljs-string">"ProtobufDecoder"</span></span></code> </pre> <br>  Configuration for upstart /etc/init/hekad.conf: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> runlevel [<span class="hljs-number"><span class="hljs-number">2345</span></span>] respawn exec /usr/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/hekad -config=/etc/hekad.toml</code> </pre><br><br><h2>  Logging Python applications </h2><br>  It uses the <a href="https://github.com/kalail/heka-py">https://github.com/kalail/heka-py</a> library and a special handler for the logging module.  Code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traceback <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> format_exception <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> heka HEKA_LEVELS = { logging.CRITICAL: heka.severity.CRITICAL, logging.ERROR: heka.severity.ERROR, logging.WARNING: heka.severity.WARNING, logging.INFO: heka.severity.INFORMATIONAL, logging.DEBUG: heka.severity.DEBUG, logging.NOTSET: heka.severity.NOTICE, } <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ImportError: heka = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HekaHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(logging.Handler)</span></span></span><span class="hljs-class">:</span></span> _notified = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> host = <span class="hljs-string"><span class="hljs-string">'127.0.0.1:5565'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, host=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> host <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.host = host self.name = name super(HekaHandler, self).__init__() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, record)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> heka <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fields = { <span class="hljs-string"><span class="hljs-string">'Message'</span></span>: record.getMessage(), <span class="hljs-string"><span class="hljs-string">'LineNo'</span></span>: record.lineno, <span class="hljs-string"><span class="hljs-string">'Filename'</span></span>: record.filename, <span class="hljs-string"><span class="hljs-string">'Logger'</span></span>: record.name, <span class="hljs-string"><span class="hljs-string">'Pid'</span></span>: record.process, <span class="hljs-string"><span class="hljs-string">'Exception'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'Traceback'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> record.exc_info: trace = format_exception(*record.exc_info) fields[<span class="hljs-string"><span class="hljs-string">'Exception'</span></span>] = trace[<span class="hljs-number"><span class="hljs-number">-1</span></span>].strip() fields[<span class="hljs-string"><span class="hljs-string">'Traceback'</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span>.join(trace[:<span class="hljs-number"><span class="hljs-number">-1</span></span>]).strip() msg = heka.Message( type=self.name, severity=HEKA_LEVELS[record.levelno], fields=fields, ) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conn <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.__class__.conn = heka.HekaConnection(self.host) self.conn.send_message(msg) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.__class__._notified <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Sending HEKA message failed"</span></span> self.__class__._notified = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br>  By default, the handler expects Heka to listen on port 5565. <br><br><h2>  Logging Go Applications </h2><br>  For logging, I forked the logging library at <a href="https://github.com/ivpusic/golog">https://github.com/ivpusic/golog</a> and added the ability to send messages directly to Heka.  The result is located here: <a href="https://github.com/ildus/golog">https://github.com/ildus/golog</a> <br><br>  Using: <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/ildus/golog"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/ildus/golog/appenders"</span></span> ... logger := golog.Default logger.Enable(appenders.Heka(golog.Conf{ <span class="hljs-string"><span class="hljs-string">"addr"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"proto"</span></span>: <span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-string"><span class="hljs-string">"env_version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"message_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"myserver.log"</span></span>, })) ... logger.Debug(<span class="hljs-string"><span class="hljs-string">"some message"</span></span>)</code> </pre><br><br><h2>  Java application logging </h2><br>  For Java applications, an input plugin of type LogstreamerInput with a special regexp decoder is used.  It reads application logs from files that must be written in a specific format. <br><br>  Configuration for heka, responsible for reading and decoding logs: <br><br><pre> <code class="java hljs">[JLogs] type = <span class="hljs-string"><span class="hljs-string">"LogstreamerInput"</span></span> log_directory = <span class="hljs-string"><span class="hljs-string">"/some/path/to/logs"</span></span> file_match = <span class="hljs-string"><span class="hljs-string">'app_(?P&lt;Seq&gt;\d+\.\d+)\.log'</span></span> decoder = <span class="hljs-string"><span class="hljs-string">"JDecoder"</span></span> priority = [<span class="hljs-string"><span class="hljs-string">"Seq"</span></span>] [JDecoder] type = <span class="hljs-string"><span class="hljs-string">"PayloadRegexDecoder"</span></span> #Parses com.asdf[INFO|main|<span class="hljs-number"><span class="hljs-number">2014</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>]: Server started match_regex = <span class="hljs-string"><span class="hljs-string">'^(?P&lt;LoggerName&gt;[\w\.]+)\[(?P&lt;Severity&gt;[AZ]+)\|(?P&lt;Thread&gt;[\w\d\-]+)\|(?P&lt;Timestamp&gt;[\d\-\s:]+)\]: (?P&lt;Message&gt;.*)'</span></span> timestamp_layout = <span class="hljs-string"><span class="hljs-string">"2006-01-02 15:04:05"</span></span> timestamp_location = <span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span> [JDecoder.severity_map] SEVERE = <span class="hljs-number"><span class="hljs-number">3</span></span> WARNING = <span class="hljs-number"><span class="hljs-number">4</span></span> INFO = <span class="hljs-number"><span class="hljs-number">6</span></span> CONFIG = <span class="hljs-number"><span class="hljs-number">6</span></span> FINE = <span class="hljs-number"><span class="hljs-number">6</span></span> FINER = <span class="hljs-number"><span class="hljs-number">7</span></span> FINEST = <span class="hljs-number"><span class="hljs-number">7</span></span> [JDecoder.message_fields] Type = <span class="hljs-string"><span class="hljs-string">"myserver.log"</span></span> Message = <span class="hljs-string"><span class="hljs-string">"%Message%"</span></span> Logger = <span class="hljs-string"><span class="hljs-string">"%LoggerName%"</span></span> Thread = <span class="hljs-string"><span class="hljs-string">"%Thread%"</span></span> Payload = <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre><br><br>  In the application, you must change the Formatter through logging.properties.  Example logging.properties: <br><br><pre> <code class="hljs pgsql">handlers= java.util.logging.FileHandler java.util.logging.ConsoleHandler java.util.logging.FileHandler.<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span> java.util.logging.FileHandler.pattern = logs/app_%g.%u.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> java.util.logging.FileHandler.<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> = <span class="hljs-number"><span class="hljs-number">1024000</span></span> java.util.logging.FileHandler.formatter = com.asdf.BriefLogFormatter java.util.logging.FileHandler.append=tru java.util.logging.ConsoleHandler.<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span> java.util.logging.ConsoleHandler.formatter=com.asdf.BriefLogFormatter</code> </pre><br><br>  BriefLogFormatter code: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.asdf; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.text.DateFormat; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.text.SimpleDateFormat; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Date; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.logging.Formatter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.logging.LogRecord; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BriefLogFormatter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Formatter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DateFormat format = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String lineSep = System.getProperty(<span class="hljs-string"><span class="hljs-string">"line.separator"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * A Custom format implementation that is designed for brevity. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LogRecord record)</span></span></span><span class="hljs-function"> </span></span>{ String loggerName = record.getLoggerName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(loggerName == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { loggerName = <span class="hljs-string"><span class="hljs-string">"root"</span></span>; } StringBuilder output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder() .append(loggerName) .append(<span class="hljs-string"><span class="hljs-string">"["</span></span>) .append(record.getLevel()).append(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) .append(Thread.currentThread().getName()).append(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) .append(format.format(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(record.getMillis()))) .append(<span class="hljs-string"><span class="hljs-string">"]: "</span></span>) .append(record.getMessage()).append(<span class="hljs-string"><span class="hljs-string">' '</span></span>) .append(lineSep); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> output.toString(); } }</code> </pre><br><br><h2>  Script Logging (bash) </h2><br>  For bash, the input filter TcpInput (which listens on a specific port) and PayloadRegexDecoder to decode messages are added to heka.  Configuration in hekad.toml: <br><br><pre> <code class="hljs haskell">[<span class="hljs-type"><span class="hljs-type">TcpInput</span></span>] address = <span class="hljs-string"><span class="hljs-string">"127.0.0.1:5566"</span></span> parser_type = <span class="hljs-string"><span class="hljs-string">"regexp"</span></span> decoder = <span class="hljs-string"><span class="hljs-string">"TcpPayloadDecoder"</span></span> [<span class="hljs-type"><span class="hljs-type">TcpPayloadDecoder</span></span>] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PayloadRegexDecoder</span></span></span><span class="hljs-class">" #</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parses</span></span></span><span class="hljs-class"> space_checker[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INFO</span></span></span><span class="hljs-class">|2014-01-01 3:08:06]: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Need</span></span></span><span class="hljs-class"> more space on disk /dev/sda6 match_regex = '^(?</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoggerName</span></span></span><span class="hljs-class">&gt;[\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">w</span></span></span><span class="hljs-class">\.\-]+)\[(?</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Hostname</span></span></span><span class="hljs-class">&gt;[^\|]+)\|(?</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Severity</span></span></span><span class="hljs-class">&gt;[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AZ</span></span></span><span class="hljs-class">]+)\|(?</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Timestamp</span></span></span><span class="hljs-class">&gt;[\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">\-\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">:]+)\]: (?</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">&gt;.*)' timestamp_layout = "2006-01-02 15:04:05" timestamp_location = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Europe</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Moscow</span></span></span><span class="hljs-class">" [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TcpPayloadDecoder</span></span></span><span class="hljs-class">.severity_map] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ERROR</span></span></span><span class="hljs-class"> = 3 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WARNING</span></span></span><span class="hljs-class"> = 4 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INFO</span></span></span><span class="hljs-class"> = 6 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ALERT</span></span></span><span class="hljs-class"> = 1 [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TcpPayloadDecoder</span></span></span><span class="hljs-class">.message_fields] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> = "scripts" </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class"> = "%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">%" </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class"> = "%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoggerName</span></span></span><span class="hljs-class">%" </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Hostname</span></span></span><span class="hljs-class"> = "%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Hostname</span></span></span><span class="hljs-class">%" </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Payload</span></span></span><span class="hljs-class"> = "[%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Hostname</span></span></span><span class="hljs-class">%|%</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoggerName</span></span></span><span class="hljs-class">%] %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">%"</span></span></code> </pre><br>  For logging, a function has been written that sends messages to the TCP port in the specified format: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"app1[`hostname`|INFO|`date '+%Y-%m-%d %H:%M:%S'`]: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> | nc 127.0.0.1 5566 || <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> }</code> </pre><br>  Sending an INFO message with an app1 type: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-string"><span class="hljs-string">"test test test"</span></span></code> </pre><br><br><h2>  Sending entries in elasticsearch </h2><br>  The following configuration is added to hekad.conf: <br><br><pre> <code class="hljs pgsql">[ESJsonEncoder] <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = "heka-%{Type}-%{2006.01.02}" es_index_from_timestamp = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> type_name = "%{Type}" [ElasticSearchOutput] message_matcher = "Type == 'myserver.log' || Type=='scripts' || Type=='nginx.access' || Type=='nginx.error'" <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = "http://&lt;elasticsearch_ip&gt;:9200" flush_interval = <span class="hljs-number"><span class="hljs-number">5000</span></span> flush_count = <span class="hljs-number"><span class="hljs-number">10</span></span> encoder = "ESJsonEncoder"</code> </pre><br>  Here we indicate where elasticsearch is located, how indexes should be formed and what types of messages should be sent there. <br><br><h2>  View logs </h2><br>  Kibana 4 is used to view logs. It is still in beta, but already quite working.  To install, you need to download the archive from the page <a href="http://www.elasticsearch.org/overview/kibana/installation/">http://www.elasticsearch.org/overview/kibana/installation/</a> , unpack it to any folder on the server and specify the server elasticsearch location in the file config / kibana.yml (parameter elasticsearch_url). <br><br>  When you first start you will need to add indexes in the Settings tab.  To be able to add an index template and define fields correctly, you need to send a test message from each application.  Then you can add an index template like heka - * (which will show all messages) or heka-scripts- *, thereby separating the applications from each other.  Then you can go to the Discover tab and see the records themselves. <br><br><h2>  Conclusion </h2><br>  I showed only a part of what can be logged with Heka. <br>  If anyone is interested, I can show the part of Ansible configuration, which automatically installs heka on all servers, and on selected elasticsearch with kibana. </div><p>Source: <a href="https://habr.com/ru/post/250803/">https://habr.com/ru/post/250803/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250789/index.html">Live webcast IT Conference: Cloud in Russia - February 18 at 10:00 (MSK)</a></li>
<li><a href="../250791/index.html">Help: "nanoCAD sees not everything that is created in AutoCAD"</a></li>
<li><a href="../250793/index.html">PHDays V: encryption of the future, M & A in Yandex, chemical attack and the father of cyberpunk</a></li>
<li><a href="../250797/index.html">Android for developers</a></li>
<li><a href="../250799/index.html">Ask Lenovo</a></li>
<li><a href="../250807/index.html">Visual brute force on the example of solving a 3D puzzle</a></li>
<li><a href="../250809/index.html">Using an alternative memory allocator in a C / C ++ project</a></li>
<li><a href="../250811/index.html">Apache Spark Introduction</a></li>
<li><a href="../250813/index.html">Spatial positioning system for aviation (using FPGA)</a></li>
<li><a href="../250815/index.html">Lock-free data structures. Concurrent maps: skip list</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>