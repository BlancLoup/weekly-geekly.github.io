<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pictures from external resources - good or evil?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most multi-visited sites allow you to host images from external resources. This is a very convenient and useful feature not only for ordinary users, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pictures from external resources - good or evil?</h1><div class="post__text post__text-html js-mediator-article">  Most multi-visited sites allow you to host images from external resources.  This is a very convenient and useful feature not only for ordinary users, but also for people collecting information about you. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/45b/bc6/78b/45bbc678bf90fe624962c3ae696e5a26.png" alt="Big brother is watching you"><br><br>  Do you want to know more information about the most effective methods?  Are you interested in how to determine the screen resolution, local time and change a couple of passwords using a small picture?  Welcome under the cut! <a name="habracut"></a><h6>  Content: </h6><br><ul><li>  Pictures from external resources - good or evil? <br><ul><li>  <a href="http://habrahabr.ru/post/196984/"><b>Part I - Theory</b></a> </li></ul><br></li></ul><br><h5>  What we will use </h5><br><ul><li>  Passive methods - transparent for the user recording of incoming information </li><li>  Active methods - returning unique content to each request. </li></ul><br>  Active methods are detectable, but they can give us the desired result. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/ce9/023/dd8/ce9023dd82a8e5ca6c8d37942a3d3a36.jpg" alt="Statistics"><h3>  Passive methods </h3><br>  We need to get all the information that allows us to separate each user from the main mass, and then begin to follow them.  At the lowest level, this is the <a href="https://ru.wikipedia.org/wiki/IP">IP protocol</a> , then <a href="https://ru.wikipedia.org/wiki/TCP">TCP</a> , possibly <a href="https://ru.wikipedia.org/wiki/SSL">SSL</a> / <a href="https://ru.wikipedia.org/wiki/TLS">TLS</a> , and then <a href="https://ru.wikipedia.org/wiki/HTTP">HTTP</a> . <br><br>  Traditionally, this area uses traffic analysis. <table><tbody><tr><td>  Mozilla Firefox (EN) </td><td>  Google Chrome (RU) </td></tr><tr><td><pre><code class="html hljs xml">GET /image.png HTTP/1.1 Host: habrahabr.ru User-Agent: Mozilla/5.0 Accept: image/png,image/*;q=0.8,*/*;q=0.5 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://habrahabr.ru/ Connection: keep-alive : \r\n</code> </pre> <br></td><td><pre> <code class="html hljs xml">GET /image.png HTTP/1.1 Host: habrahabr.ru Connection: keep-alive User-Agent: Mozilla/5.0 Accept: */* Referer: http://habrahabr.ru/ Accept-Encoding: gzip,deflate,sdch Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4 Accept-Charset: windows-1251,utf-8;q=0.7,*;q=0.3 : \r\n</code> </pre> <br></td></tr></tbody></table>  These are two requests, from the same page, to the same image, but from different browsers.  As you can see, it is not only the contents of the headers that differ, but also their order.  Different versions of browsers will also have differences, so we can assume that the <b>User-Agent is</b> localized and deliberately changed. <br><br>  In the case of a large file, reading the timestamps can determine the speed of information transfer.  By speed and IP-address you can find out the provider and the tariff that will help apply social engineering to the person. <br><br><h5>  Bots </h5>  Most bots that emulate the browsing of a site and are not based on browser engines do not result in a lower case host header ‚Äî this tag will help to quickly detect villains without the help of the administration: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://HABRAhabr.ru/image.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h3>  Active methods </h3><br>  Now we are moving to the most interesting, why don't we squeeze all the maximum possible from this technique? <br><br><h5>  Cookie </h5><br>  You must have heard about this data transfer technology between the server and the client, it was already supported by IE version 2.  Recently, Mozilla Firefox 22 came up, in which the <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D818340">installation of cookies</a> from third-party domains was <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D818340">blocked</a> by default, but everyone who uses other browsers will get a big surprise.  Usage vectors: <br><br><ul><li>  Comparison of client outputs from different IP </li><li>  Tracking different browser sessions </li><li>  Browser definition based on data limits </li><li>  Determination of local time accurate to second </li></ul><br>  With the first paragraph, everything is clear - we set a cookie with a long validity period, we write a unique identifier into it, and then we read everything. <br><br>  The second item is just as simple as the first one ‚Äî if we do not set the expiration date, the cookie will be valid until the first browser is closed, so a request will come only with the first cookie. <br><br>  Data from <a href="https://ru.wikipedia.org/wiki/HTTP_cookie">Wikipedia</a> says that each browser sets a limit on the amount of data, moreover, it sometimes changes from version to version, thereby publishing another image from another domain can increase the likelihood of a correct definition. <br><br>  The implementation of the fourth paragraph requires some effort: <br><br><pre> <code class="html hljs xml">Set-Cookie: name=VALUE[; expires=DATE][; path=PATH][; domain=DOMAIN_NAME][; secure][; HttpOnly]; Cookie: name=VALUE;</code> </pre><br>  The server sets a <b>cookie</b> using <b>Set-Cookie</b> , sets the necessary parameters and sends everything to the browser.  The browser saves the parameters and only the data comes back - elegantly and simply. <br><br>  The most interesting thing here is in the date field, it <a href="https://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25B3%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B8_HTTP">is set</a> in the format <b>Wdy, DD Mon YYYY HH: MM: SS GMT</b> , that is, one regardless of location, but if the system time is not synchronized or a different time zone appears, there will be differences. <br><br>  Note: <em>all this will work only when the server has not transmitted the <b>Date</b> header with its time - the browser needs to somehow get out.</em> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ff/a32/66c/3ffa3266c88eb2fdfdbb4403ea0bbb0c.jpg"><br><br>  Let's set the control and 12 more different versions of cookies with a difference of 2 hours and see the next user response by redirecting through the <b>Location</b> .  Then narrowing or extending (If the time is changed by more than a day), if necessary, the range is reached to the second marks, after which you can determine the relationship between server and client time and identify the person next time. <br><br><h4>  Cache </h4><br>  The browser's cache allows you to do exactly the same thing when cookies are disabled: <br><br><h5>  Etag </h5>  When the image is returned, an Etag header with a unique hash string is given: <br><pre> <code class="html hljs xml">Etag: 1aa69b6c6273a8</code> </pre><br>  Subsequent request to the server will look like this: <br><pre> <code class="html hljs xml">If-None-Match: 1aa69b6c6273a8</code> </pre><br>  Now the server has the right to give the status of <b>304 Not Modified</b> without transferring the picture itself - the browser will take it from the cache. <br><br><h5>  Last-Modified </h5>  An older analog of Etag can also be used for tracking.  Indicates the date the document was last modified. <br><pre> <code class="html hljs xml">Server =&gt; Last-Modified: Fri, 02 Jan 1970 10:17:36 GMT Client =&gt; If-Modified-Since: Fri, 02 Jan 1970 10:17:36 GMT Server =&gt; HTTP/1.1 304 Not Modified</code> </pre><br><h5>  Expires </h5>  Indicates the date of the possible expiration of the document.  Longer analogue of determining time. <br><br><pre> <code class="html hljs xml">Expires: Fri, 02 Jan 1970 10:17:36 GMT Cache-Control: must-revalidate</code> </pre><br>  Details about the title painted <a href="http-expire/">here</a> . <br><br><h4>  Title Link </h4><br>  The HTTP Link Header is equivalent to the &lt;link&gt; tag.  You can specify a link to the rss-tape, style sheet, etc. directly in the headers - this is a chance, because <b>HTML</b> can not be included in the picture ( <a href="http://www.cyberguru.ru/web/web-programming/image-xss.html">Except for old versions of Internet Explorer</a> ). <br><br><pre> <code class="html hljs xml">Link: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">.</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style.css</span></span></span><span class="hljs-tag">&gt;</span></span>; rel=stylesheet</code> </pre> <br>  Using modern features of <b>CSS 3</b> - <a href="http://htmlbook.ru/css/value/media">media queries</a> - you can load data through conditions, for example, by screen resolution: <br><pre> <code class="css hljs">@<span class="hljs-keyword"><span class="hljs-keyword">media</span></span> all and (device-width: <span class="hljs-number"><span class="hljs-number">1024px</span></span>) { <span class="hljs-selector-tag"><span class="hljs-selector-tag">html</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(<span class="hljs-string"><span class="hljs-string">"./w1024.jpg"</span></span>); } } @<span class="hljs-keyword"><span class="hljs-keyword">media</span></span> all and (device-height: <span class="hljs-number"><span class="hljs-number">768px</span></span>) { <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(<span class="hljs-string"><span class="hljs-string">"./h768.jpg"</span></span>); } }</code> </pre><br>  This method will not always work - images are loaded only if there are corresponding tags, there is no support for <b>WebKit</b> , the syntax is limited in conditions.  But with some configurations it works! <br><br><h4>  Infinite gif </h4><br><blockquote>  The idea is that in the format of an animated GIF, the number of frames is not indicated, so after displaying the picture, the browser waits for new frames from the server until it receives signal bits about the end of the file.  In other words, the server can push messages to the browser over an open channel in the GIF. <br><br>  (c) <a href="http://habrahabr.ru/users/alizar/" class="user_link">alizar</a> </blockquote><br>  See <a href="http://habrahabr.ru/post/151538/">habrahabr.ru/post/151538</a> and <a href="http://habrahabr.ru/post/180877/">habrahabr.ru/post/180877</a> <br><br>  In addition, the infinite gif can be used to track the user's time on the page ‚Äî the socket will be closed when the tab is closed or hang after changing the network settings, switching proxy servers, VPN servers ... <br><br><h4>  Refresh header </h4><br>  This title (unlike <b>Link</b> ) is not set by standards, however, it is supported almost everywhere. <br><br><pre> <code class="html hljs xml">Refresh: 15; url=http://habrahabr.ru/images/bg-multilogo.png</code> </pre><br>  It allows redirection after a certain period of time - if the user loads the page, and then, without closing the tabs, he will disable the VPN and proxy - his IP will be in our pocket. <br><br><h4>  Basic-authentication </h4><br>  The method is very old, I do not argue, it also works on the headers and is still relevant.  And if you give out the form only to the right people to find an ambush where no one will look for it, it becomes an impossible task. <br><br>  Materials: <a href="http://habrahabr.ru/post/140054/">habrahabr.ru/post/140054</a> <br><br><h4>  CSRF attacks </h4><br><blockquote>  CSRF is a type of attack on website visitors that uses the disadvantages of the HTTP protocol.  If the victim enters the site created by the attacker, a request is secretly sent to another server (for example, to the server of the payment system), performing some kind of malicious operation (for example, transferring money to the attacker's account).  In order to carry out this attack, the victim must be authorized on the server to which the request is sent, and this request must not require any confirmation from the user, which cannot be ignored or forged by the attacking script. <br><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25B4%25D0%25B4%25D0%25B5%25D0%25BB%25D0%25BA%25D0%25B0_%25D0%25BC%25D0%25B5%25D0%25B6%25D1%2581%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2%25D1%258B%25D1%2585_%25D0%25B7%25D0%25B0%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D0%25BE%25D0%25B2">https://ru.wikipedia.org/wiki/Feintime_retail_query falsification</a> <br></blockquote><br><br>  If the <b>URL is</b> rigidly filtered does not mean that it is impossible to conduct such an attack.  Through the same <b>Location</b> header, you can send a malicious link to change passwords, send messages or something else: <br><br><pre> <code class="html hljs xml">Location: http://www.ru/panel/password?newpass=qwerty&amp;newpass2=qwerty&amp;submit=ok</code> </pre><br><br>  It is possible to use only the GET method, such vulnerabilities are widespread today.  Often there are safe, but unpleasant CSRF on razloginivanie, you can disable the site for a while. <br><br><h3>  Low-level, erroneous and other methods </h3><br><br><h4>  Gray IP (Internal Network) Detection </h4><br>  Internal networks are widely used in <b>OpenVPN</b> technology, there were thoughts to determine their presence by measuring the <a href="https://ru.wikipedia.org/wiki/Time_to_live">TTL that</a> comes to the server and the minimum possible value when delivering a packet. <br><br>  The method was quickly refuted - the path to the resource and from the resource may not coincide ( <a href="http://habrahabr.ru/post/186282/">material</a> ) and the method will give more failures than correct answers. <br><br>  However, the application is still there, <a href="https://ru.wikipedia.org/wiki/Time_to_live">the default</a> <b>TTL</b> in Linux is 64, in Windows it is 128. These large differences will help determine the OS of the remote host in some cases. <br><br><h4>  Determining the use of a firewall (For Win) </h4><br>  The method is very simple, however, it is suitable only for <b>Win</b> systems where products like <i>Kaspersky Internet Security</i> are widely used.  Placing the virus code in the picture to track its blocking is not difficult - the resource can be blocked for a long time, the picture will never fall into the cache. <br><br><h4>  Host scan </h4><br>  This may be necessary, but here you have to be as careful as possible - when such activity is detected, nothing good shines. <br><br><h3>  Conclusion </h3><br>  If you have a website, think, and you need so many problems because of one feature? <br><br>  <b>UPD1:</b> <br>  <a href="http://habrahabr.ru/users/baadf00d/" class="user_link">baadf00d</a> in the <a href="https://habr.com/ru/post/196984/">comments</a> reminded about DNS leaks (they allow you to determine which DNS server to use, sometimes it‚Äôs a provider). <br><br>  Google's public servers: <br><pre> <code class="html hljs xml">8.8.8.8 8.8.4.4</code> </pre>  Firefox Settings (about: config): <pre> <code class="html hljs xml">network.proxy.socks_remote_dns = 1</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/196984/">https://habr.com/ru/post/196984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196974/index.html">I can not believe that you throw away the book!</a></li>
<li><a href="../196976/index.html">Samsung announced the world's first smartphone with a curved screen - GALAXY Round</a></li>
<li><a href="../196978/index.html">Integrating Money Online into ActiveMerchant</a></li>
<li><a href="../196980/index.html">Introduction to data analysis with Pandas</a></li>
<li><a href="../196982/index.html">Tizen - a view from the inside</a></li>
<li><a href="../196986/index.html">About domain and FSKN</a></li>
<li><a href="../196988/index.html">Mobile Technology Section at Russian Internet Week 2013</a></li>
<li><a href="../196990/index.html">Open the doors remotely</a></li>
<li><a href="../196992/index.html">Monitoring code coverage during unit testing in Windows Phone</a></li>
<li><a href="../196998/index.html">Facebook, Steve Ballmer and Al Gore - everyone tried to buy Twitter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>