<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker: Harmless Tips</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to my Docker article : bad advice there were many requests to explain why the Dockerfile described in it was so terrible. 


 Summary ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker: Harmless Tips</h1><div class="post__text post__text-html js-mediator-article"><p>  In the comments to my <a href="https://habr.com/ru/company/southbridge/blog/449944/">Docker</a> article <a href="https://habr.com/ru/company/southbridge/blog/449944/">: bad advice</a> there were many requests to explain why the Dockerfile described in it was so terrible. </p><br><p>  <em>Summary of the previous series</em> : two developers on a hard deadline make up the Dockerfile.  In the process Ops Igor Ivanovich comes to them.  The final Dockerfile is so bad that the AI ‚Äã‚Äãis on the verge of a heart attack. </p><br><p><img src="https://habrastorage.org/webt/nl/uj/xm/nlujxmo7chgsgo7dti72jckbk04.jpeg"></p><br><p>  Now let's see what is wrong with this Dockerfile. </p><br><p>  So, a week has passed. </p><a name="habracut"></a><br><p>  Dev Petya meets in the canteen over a cup of coffee with Ops Igor Ivanovich. </p><br><p>  P: Igor Ivanovich, are you very busy?  I would like to find out where we screwed up. </p><br><p>  AI: It's good, you don‚Äôt often meet developers who are interested in exploitation. <br>  First, let's agree on some things: </p><br><ol><li>  Ideology Docker: one container - one process. </li><li>  The smaller the container, the better. </li><li>  The more taken from the cache, the better. </li></ol><br><p>  P: Why should there be one process in one container? </p><br><p>  AI: Docker, when the container starts, monitors the status of the process with pid 1. If the process dies, the Docker tries to restart the container.  Suppose you have several applications running in a container or the main application is not running with pid 1. If the process dies, the Docker will not know about it. </p><br><p>  If there are no more questions, show your Dockerfile. </p><br><p>  And Peter showed: </p><br><pre><code class="plaintext hljs">FROM ubuntu:latest #    COPY ./ /app WORKDIR /app #    RUN apt-get update #   RUN apt-get upgrade #    RUN apt-get -y install libpq-dev imagemagick gsfonts ruby-full ssh supervisor #  bundler RUN gem install bundler #  nodejs     RUN curl -sL https://deb.nodesource.com/setup_9.x | sudo bash - RUN apt-get install -y nodejs #   RUN bundle install --without development test --path vendor/bundle #     RUN rm -rf /usr/local/bundle/cache/*.gem RUN apt-get clean RUN rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* RUN rake assets:precompile #  ,   ,    . CMD ["/app/init.sh"]</code> </pre> <br><p>  AI: Oh, let's sort it out in order.  Let's start with the first line: </p><br><pre> <code class="plaintext hljs">FROM ubuntu:latest</code> </pre> <br><p>  You take the <code>latest</code> tag.  Using the <code>latest</code> tag leads to unpredictable consequences.  Imagine, the image maintainer collects a new version of the image with a different list of software; this image receives the latest tag.  And your container stops gathering at best, and at worst you catch bugs that were not there before. </p><br><p>  You take an image with a full OS with a lot of unnecessary software that inflates the volume of the container.  And the more software, the more holes and vulnerabilities. </p><br><p>  In addition, the larger the image, the more it takes up space on the host and in the registry (do you store images somewhere)? </p><br><p>  P: Yes, of course, we have a registry, and you set it up. </p><br><p>  AI: So, what am I talking about? .. Oh, yes, volumes ... The load on the network is also growing.  For a single image it is imperceptible, but when there is a continuous assembly, tests and a warm, it is noticeable.  And if you do not have God's mode on AWS, you will also receive a space account. </p><br><p>  Therefore, you need to choose the most suitable image, with the exact version and minimum software.  For example, take: <code>FROM ruby:2.5.5-stretch</code> </p><br><p>  P: Oh, I see.  And how and where to see the available images?  How to understand what I need? </p><br><p>  AI: Usually, images are taken from <a href="https://hub.docker.com/">dokhaba</a> , do not confuse with pornjab :).  There are usually several assemblies for an image: <br>  <strong>Alpine</strong> : images are collected on a minimalist image of Linux, only 5 MB.  Its minus: it is compiled with its own libc implementation, standard packages do not work in it.  Finding and installing the right package will take a lot of time. <br>  <strong>Scratch</strong> : base image, not used to build other images.  It is intended solely for running binary, prepared data.  Ideal for running binary applications that include everything you need, such as go-applications. <br>  Based on any OS, for example, Ubuntu or Debian.  Well here, I think, it is not necessary to explain. </p><br><p>  AI: Now we need to put all the extras.  packages and clean up caches.  And immediately you can throw <em>apt-get upgrade</em> .  Otherwise, with each assembly, despite the fixed tag of the basic image, different images will be obtained.  Updating packages in an image is a task of the maintainer, it is accompanied by a change in the tag. </p><br><p>  P: Yes, I tried to do it, I did this: </p><br><pre> <code class="plaintext hljs">WORKDIR /app COPY ./ /app RUN curl -sL https://deb.nodesource.com/setup_9.x | bash - \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts ruby-full ssh supervisor nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle RUN rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  AI: Not bad, but here, too, there is something to work on.  Look, here is this command: </p><br><pre> <code class="plaintext hljs">RUN rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  ... does not remove data from the final image, but only creates an additional layer without this data.  Correctly: </p><br><pre> <code class="plaintext hljs">RUN curl -sL https://deb.nodesource.com/setup_9.x | bash - \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  But that is not all.  What have you got there, Ruby?  Then you do not need to copy the entire project at the beginning.  It is enough to copy Gemfile and Gemfile.lock. </p><br><p>  With this approach, bundle install will not be executed for every source change, but only if Gemfile or Gemfile.lock has changed. </p><br><p>  The same methods work for other languages ‚Äã‚Äãwith a dependency manager, such as npm, pip, composer, and other dependency-list-based files. </p><br><p>  Finally, remember, at the beginning I spoke about the Docker ideology ‚Äúone container - one process‚Äù?  This means that supervisor is not needed.  You should also not install systemd for the same reasons.  In essence, the Docker is itself a supervisor.  And when you try to run multiple processes in it, it‚Äôs like running multiple applications in one supervisor process. <br>  When assembling, you will make a single image, and then run the required number of containers so that each process runs one process. </p><br><p>  But more about that later. </p><br><p>  P: It seems to understand.  See what happens: </p><br><pre> <code class="plaintext hljs">FROM ruby:2.5.5-stretch WORKDIR /app COPY Gemfile* /app RUN curl -sL https://deb.nodesource.com/setup_9.x | bash - \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* COPY . /app RUN rake assets:precompile CMD ["bundle‚Äù, ‚Äúexec‚Äù, ‚Äúpassenger‚Äù, ‚Äústart"]</code> </pre> <br><p>  And we will redefine start of demons at start of the container? </p><br><p>  AI: Yes, that's right.  By the way, you can use both CMD and ENTRYPOINT.  And to figure out what the difference is, this is your homework.  There is a good <a href="https://habr.com/ru/company/southbridge/blog/329138/">article</a> on this topic on Habr√©. </p><br><p>  So, come on.  You download the file to install the node, but there is no guarantee that it will be what you need.  It is necessary to add validation.  For example: </p><br><pre> <code class="plaintext hljs">RUN curl -sL https://deb.nodesource.com/setup_9.x &gt; setup_9.x \ &amp;&amp; echo "958c9a95c4974c918dca773edf6d18b1d1a41434 setup_9.x" | sha1sum -c - \ &amp;&amp; bash setup_9.x \ &amp;&amp; rm -rf setup_9.x \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  By checksum, you can verify that you have downloaded the correct file. </p><br><p>  P: But if the file changes, the build will fail. </p><br><p>  II: Yes, and oddly enough, this is also a plus.  You will know that the file has changed, and you can see what has been changed there.  You never know, they added, say, a script that deletes everything it reaches, or makes a backdoor. </p><br><p>  P: Thank you.  It turns out, the final Dockerfile will look like this: </p><br><pre> <code class="plaintext hljs">FROM ruby:2.5.5-stretch WORKDIR /app COPY Gemfile* /app RUN curl -sL https://deb.nodesource.com/setup_9.x &gt; setup_9.x \ &amp;&amp; echo "958c9a95c4974c918dca773edf6d18b1d1a41434 setup_9.x" | sha1sum -c - \ &amp;&amp; bash setup_9.x \ &amp;&amp; rm -rf setup_9.x \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* COPY . /app RUN rake assets:precompile CMD ["bundle‚Äù, ‚Äúexec‚Äù, ‚Äúpassenger‚Äù, ‚Äústart"]</code> </pre> <br><p>  P: Igor Ivanovich, thanks for the help.  I have to run, I need to make 10 more commits today. </p><br><p>  Igor Ivanovich, with his gaze stopping his hurried colleague, takes a sip of strong coffee.  After thinking a few seconds about the SLA 99.9% and the code without bugs, he asks a question. </p><br><p>  II: Where do you keep logs? </p><br><p>  P: Of course, in production.log.  By the way, yes, and how do we get access to them without ssh? </p><br><p>  AI: If you leave them in files, a solution for you has already been invented.  The docker exec command allows you to execute any command in a container.  For example, you can make cat for logs.  And using the <em>-it</em> switch and running bash (if installed in the container), you will get interactive access to the container. </p><br><p>  But storing logs in files is not worth it.  At a minimum, this leads to uncontrolled growth of the container, but no one rotates the logs.  All logs need to be thrown in stdout.  There they can already be viewed using the <em>docker logs command</em> . </p><br><p>  P: Igor Ivanovich, and can put out the logs in a mounted directory, on a physical node, as user data? </p><br><p>  II: It's good that you didn't forget to transfer the data loaded on the node disk.  With logs, it is also possible, just do not forget to configure rooting. <br>  Everything, you can run. </p><br><p>  P: Igor Ivanovich, and advise what to read? </p><br><p>  AI: To start, read the <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">recommendations from the Docker developers</a> , hardly anyone knows Docker better than them. </p><br><p>  And if you want to do an internship, go to <a href="https://habr.com/ru/company/southbridge/blog/443384/">intensive</a> .  After all, theory without practice is dead. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/452108/">https://habr.com/ru/post/452108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452090/index.html">Creating a procedural puzzle generator</a></li>
<li><a href="../452092/index.html">In-App Updates: we accelerate the process of updating the application on Android</a></li>
<li><a href="../452098/index.html">Logs frontend developer Habr: refactor and reflex</a></li>
<li><a href="../4521/index.html">How are the meetings at google</a></li>
<li><a href="../452106/index.html">We invite speakers to the summer DIY-mitap June 16, 2019</a></li>
<li><a href="../452112/index.html">CRM ++</a></li>
<li><a href="../452118/index.html">The scientist breaks the code of the mysterious manuscript of Voinich</a></li>
<li><a href="../45212/index.html">Fashion Your Firefox</a></li>
<li><a href="../452122/index.html">"Demon Pill" in Motion</a></li>
<li><a href="../452124/index.html">‚ÄúWe need people hungry for knowledge and achievements‚Äù - what is it like to be a tester in Alfa-Bank</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>