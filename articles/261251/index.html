<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL + octopus setup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to show how to configure MySQL for further use of gem octopus, which is used for sharding and replication in Rails appli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL + octopus setup</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/204/3c5/c43/2043c5c43e46428c825547e7a813f003.png"><br><br>  In this article, I would like to show how to configure MySQL for further use of gem octopus, which is used for sharding and replication in Rails applications. <br>  So, let's imagine that we are faced with the task of deploying three servers (the first one is Rails, the application is needed, the second is needed for Master, the third will act as Slave), set up replication between servers and make octopus work. <br><a name="habracut"></a><br>  <b>Step One - Pre-Tuning Servers</b> <br>  The actions described in this step need to be done both on the Master machine and on the Slave. <br><br>  Install MySQL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">sudo apt-get install mysql-server</code> </pre> <br>  Now let's go to the MySQL console: <br><pre> <code class="bash hljs">mysql -u root -p</code> </pre> <br>  Create a database, as well as a user who will have all rights to work with this database: <br><pre> <code class="bash hljs">create database rails_myapp; GRANT ALL ON rails_myapp.* TO <span class="hljs-string"><span class="hljs-string">'rails_myapp_user'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; GRANT ALL ON rails_myapp.* TO <span class="hljs-string"><span class="hljs-string">'rails_myapp_user'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span>; FLUSH PRIVILEGES; EXIT;</code> </pre> <br>  <b>Step Two - Set Up Master</b> <br>  Open the MySQL configuration file on the Master server. <br><br><pre> <code class="bash hljs">sudo nano /etc/mysql/my.cnf</code> </pre> <br>  Inside this file we will make a few changes.  First, we find the following line: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-address = 127.0.0.1</code> </pre> <br>  Let's replace the standard IP address with 0.0.0.0, so that the Rails application can reach the server: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-address = 0.0.0.0</code> </pre> <br>  Our next step is to change the server-id value, look for the server-id in the [mysqld] section of the config file.  You can choose any number as a server-id, but for simplicity, it is better to specify 1, just remember that this number should be unique for the group of servers that will participate in replication. <br><br>  Once again, make sure that this line is commented out. <br><br><pre> <code class="bash hljs">server-id = 1</code> </pre> <br>  Now go to the line with the value log_bin.  The slave will copy all changes that will be logged in the log.  Again, it is better to just comment out the line with log_bin: <br><br><pre> <code class="bash hljs">log_bin = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/mysql/mysql-bin.log</code> </pre> <br>  At the end, you must specify the name of the database to be replicated by the slave server.  You can specify several bases by repeating this line for all bases that you want to replicate. <br><br><pre> <code class="bash hljs">binlog_do_db = rails_myapp</code> </pre> <br>  All changes are made!  You can save and close the file. <br><br>  Restart MySQL. <br><br><pre> <code class="bash hljs">sudo service mysql restart</code> </pre> <br>  Open MySQL - shell. <br><br><pre> <code class="bash hljs">mysql -u root -p</code> </pre> <br>  You must grant privileges to Slave.  To do this, use the following command: <br><br><pre> <code class="bash hljs">GRANT REPLICATION SLAVE ON *.* TO <span class="hljs-string"><span class="hljs-string">'slave_user'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> IDENTIFIED BY <span class="hljs-string"><span class="hljs-string">'password'</span></span>; FLUSH PRIVILEGES;</code> </pre> <br>  Next you must switch to your base: <br><br><pre> <code class="bash hljs">USE rails_myapp;</code> </pre> <br>  We lock the database to view the data that will be useful to us in the following steps: <br><br><pre> <code class="bash hljs">FLUSH TABLES WITH READ LOCK;</code> </pre> <br>  Next, we type: <br><br><pre> <code class="bash hljs">SHOW MASTER STATUS;</code> </pre> <br>  You will see something like this if you type the following command: <br><br><pre> <code class="bash hljs">mysql&gt; SHOW MASTER STATUS;</code> </pre> <br><table><tbody><tr><th>  File </th><th>  Position </th><th>  Binlog_Do_DB </th></tr><tr><td>  mysql-bin.000001 </td><td>  107 </td><td>  rails_myapp </td></tr></tbody></table><br>  1 row in set (0.00 sec) <br><br>  Important!  Write down or remember the file name and position number, these values ‚Äã‚Äãwill be used later. <br>  While your databases are locked, you need to export the rails_myapp database.  Open the second terminal in a new window, make sure you type this command in bash shell, and not in the MySQL console. <br><br><pre> <code class="bash hljs">mysqldump -u root -p --opt rails_myapp &gt; rails_myapp.sql</code> </pre> <br>  Go back to the MySQL console, unlock the database (allow recording). <br><br><pre> <code class="bash hljs">UNLOCK TABLES; QUIT;</code> </pre> <br>  Everything!  We have finished setting up the Master. <br><br>  <b>Step three - set up the Slave.</b> <br>  Go to the MySQL server, open MySQL and create a database (the name is exactly the same as on the wizard): <br><br><pre> <code class="bash hljs">CREATE DATABASE rails_myapp; EXIT;</code> </pre> <br>  Transfer the file with SQL - commands that you exported to the wizard and import. <br><br><pre> <code class="bash hljs">mysql -u root -p rails_myapp&lt; /path/to/rails_myapp.sql</code> </pre> <br>  Then you need to slightly correct the MySQL configuration file: <br><br><pre> <code class="bash hljs">sudo nano /etc/mysql/my.cnf</code> </pre> <br>  The first thing to change is server-id.  As you remember, the number should be unique within the group (we indicated 1 in the Master config). <br><br><pre> <code class="bash hljs">server-id = 2</code> </pre> <br>  Now we will add (or comment out) the following three lines: <br><br><pre> <code class="bash hljs">relay-log = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/mysql/mysql-relay-bin.log log_bin = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/mysql/mysql-bin.log binlog_do_db = newdatabase</code> </pre> <br>  Set the new bind-address value: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-address = 0.0.0.0</code> </pre> <br>  Restart MySQL: <br><br><pre> <code class="bash hljs">sudo service mysql restart</code> </pre> <br>  The next step is to start replication directly.  Remember!  Instead of MASTER_LOG_FILE and MASTER_LOG_POS, you must enter the values ‚Äã‚Äãyou wrote down before. <br><br><pre> <code class="bash hljs">CHANGE MASTER TO MASTER_HOST=<span class="hljs-string"><span class="hljs-string">'12.34.56.789'</span></span>,MASTER_USER=<span class="hljs-string"><span class="hljs-string">'slave_user'</span></span>, MASTER_PASSWORD=<span class="hljs-string"><span class="hljs-string">'password'</span></span>, MASTER_LOG_FILE=<span class="hljs-string"><span class="hljs-string">'mysql-bin.000001'</span></span>, MASTER_LOG_POS= 107; START SLAVE;</code> </pre><br>  How to check if Slave has successfully launched?  You need to enter the command described below and view the log: <br><br><pre> <code class="bash hljs">SHOW SLAVE STATUS\G</code> </pre> <br><br>  <b>Step four - configure octopus.</b> <br>  In the Rails application, you need to add the following line to the Gemfile: <br><br><pre> <code class="bash hljs">gem <span class="hljs-string"><span class="hljs-string">'ar-octopus'</span></span></code> </pre> <br>  Inside the config / directory, you need to create a shards.yml file that will be responsible for configuring the Slave server.  Remember!  The database.yml file is responsible for the configuration of the Master, and the newly created shards.yml for the configuration of the Slave, do not forget that spaces and tabs in YML are important. <br><br>  The file shards.yml, after filling should look something like this: <br><br><pre> <code class="bash hljs"> octopus: replicated: <span class="hljs-literal"><span class="hljs-literal">true</span></span> fully_replicated: <span class="hljs-literal"><span class="hljs-literal">true</span></span> environments: - development - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> development: slave: adapter: mysql2 encoding: utf8 database: rails_myapp username: rails_myapp_user password: qwerty host: 130.111.11.111 port: 3306 pool: 10 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: slave: adapter: mysql2 encoding: utf8 database: rails_myapp username: rails_myapp_user password: qwerty host: 130.111.111.111 port: 3306 pool: 10</code> </pre> <br>  Everything!  It remains to register in your models that they are replicated_model (), and run the Rails application.  Having sent a POST request, you should see something like the following in the console: <br><br><pre> <code class="bash hljs"> [Shard: slave] OurModel Load (1.0ms) SELECT `model`.* FROM `model` WHERE `chats`.`id` = <span class="hljs-string"><span class="hljs-string">'gkjhgfhd'</span></span> LIMIT 1</code> </pre> <br>  <b>Successful setting!</b> </div><p>Source: <a href="https://habr.com/ru/post/261251/">https://habr.com/ru/post/261251/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261243/index.html">World OpenStack Summit and other news</a></li>
<li><a href="../261245/index.html">Lecture by Dmitry Vetrov on big data math: tensors, neural networks, Bayesian inference</a></li>
<li><a href="../261247/index.html">Anatomy of virtual telephony. Familiarity with the interface. Part 2</a></li>
<li><a href="../261249/index.html">Library patterns: Why frameworks are evil</a></li>
<li><a href="../26125/index.html">Password Manager in Firefox. Sync on multiple computers</a></li>
<li><a href="../261253/index.html">"Programming a mouse" for microcontrollers</a></li>
<li><a href="../261255/index.html">Sberbank Security Online</a></li>
<li><a href="../261257/index.html">220 Volt AC Voltage Regulator</a></li>
<li><a href="../261259/index.html">Yandex-Transfer in the terminal via Java</a></li>
<li><a href="../26126/index.html">Rose of Paracelsus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>