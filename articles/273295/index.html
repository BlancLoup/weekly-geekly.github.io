<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to create software for a microtomograph for 5233 man-hours</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to tell in more detail about the interesting project of the Edison company . The developers were given the task of writing software for the mic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to create software for a microtomograph for 5233 man-hours</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/96f/5ef/9ab/96f5ef9ab16a49449217844fa566f41f.png"><br><br>  I want to tell in more detail about the interesting <a href="http://www.edsd.com/software-for-new-tomography-device">project of the Edison company</a> .  The developers were given the task of writing software for the microtomograph, they did an excellent job with it, and then they stuffed seeds, bolts, capacitors and a mole into this tomograph.  Serious uncles need this tomograph to check diamonds and not buy full of holes. <br><br><img src="https://habrastorage.org/files/b34/d19/e92/b34d19e92b6b43db876b4b297aff9a72.jpg" align="right">  And today is December 16, the birthday of <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B4%25D0%25BE%25D0%25BD,_%25D0%2598%25D0%25BE%25D0%25B3%25D0%25B0%25D0%25BD%25D0%25BD">Johann Radon</a> , Austrian mathematician, rector of the University of Vienna, who in 1917 introduced the integral transformation of a function of many variables, akin to the Fourier transform used today in all tomographs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Johann Radon was a professor at 6 universities (and in one of them, even without a department), was president of the Austrian Mathematical Society.  In Austria, the Institute of Computational and Applied Mathematics and the medal were named after him. <br><br>  About how the development of software for the tomograph and what tasks were solved in the process - under the cut. <br><a name="habracut"></a><br><br><h4>  <b>Microtomograph</b> </h4><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/OimWr_ukg28" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Scientists from Tomsk State University have created a microtomograph.  It allows you to learn about the internal structure of various materials with micron accuracy.  For example, diamonds. <br><br><img src="https://habrastorage.org/files/3a4/101/bb1/3a4101bb1e9f4ac897c289cb7a0209f0.png"><br>  <i>Fig.</i>  <i>Diamond quality</i> <br><br>  The tomograph can enlighten the material with a resolution of up to microns.  It is 100 times thinner than a human hair.  After scanning, the program creates a 3D model, where you can look not only at the outer side of the part, but also find out what's inside. <br><br><div class="spoiler">  <b class="spoiler_title">Tomograph device</b> <div class="spoiler_text">  List of the main technical characteristics of the device. <br><br>  ‚Ä¢ Number of detector permitting elements: 2048 x 2018 cells with a size of one element of not more than 13.3 x 13.3 Œºm. <br>  ‚Ä¢ Resolution: 13 microns. <br>  ‚Ä¢ Overall dimensions: 504 x 992.5 x 1504 mm. <br>  ‚Ä¢ Weight: 450 kg. <br>  ‚Ä¢ Field of view: 1 mm. <br>  ‚Ä¢ Operating wavelength range: 0.3‚Äì2.3 A. <br>  ‚Ä¢ Accuracy of positioning of electromechanical motion modules in the PMT positioning system: ¬± 1 ¬µm. <br>  ‚Ä¢ Compliance with safety requirements: GOST 12.1.030-81. <br>  ‚Ä¢ X-ray protection: 1‚Äì3 ¬µSv / h. <br><br><img src="https://habrastorage.org/files/837/b4f/6c1/837b4f6c11e6422e889f9eafc69707ff.png"><br>  <i>Fig.</i>  <i>Appearance</i> <br><br><img src="https://habrastorage.org/files/a95/e01/a84/a95e01a84f824e118eb106943a0c8d2a.jpg"><br>  <i>Fig.</i>  <i>The principle of operation of the electro-mechanical part</i> <br><br><img src="https://habrastorage.org/files/59a/a0e/5ea/59aa0e5ea49f486d820dc1eb749ed341.png"><br>  <i>Fig.</i>  <i>X-ray source</i> <br><br>  ‚Ä¢ Voltage: 20‚Äì160 kV. <br>  ‚Ä¢ Current: 0‚Äì250 ŒºA. <br>  ‚Ä¢ Power: 10 watts. <br>  ‚Ä¢ Diameter of focal spot: 1‚Äì5 microns. <br><br><img src="https://habrastorage.org/files/4d3/dd9/aa2/4d3dd9aa25da40fb9ebb1ea53aec7294.png"><br>  <i>Fig.</i>  <i>Positioning</i> <br><br>  ‚Ä¢ Rotor stroke: SAMD - 360 ¬∞, LEMD - 100 mm. <br>  ‚Ä¢ Positioning accuracy, not less: ¬± 0.5 ¬µm. <br>  ‚Ä¢ The speed of the rotor: from 0.01 to 20 mm / s. <br>  ‚Ä¢ Power: 0.7 kW at 70 V. <br><br><img src="https://habrastorage.org/files/721/41e/971/72141e9716b648d3adf97e97ba391b24.png"><br>  <i>Fig.</i>  <i>X-ray detector based on CCD</i> <br><br>  ‚Ä¢ Sensitive area of ‚Äã‚Äãthe CCD: 2048 x 2048 pixels. <br>  ‚Ä¢ Geometrical pixel size: 13 x 13 microns. <br>  ‚Ä¢ Geometrical size of the sensitive area of ‚Äã‚Äãthe CCD: 26.6 x27.6 mm. <br>  ‚Ä¢ Built-in two-speed ADC: 16 bit, 100 kHz and 16 bit 2 MHz. <br></div></div><br><br><img src="https://habrastorage.org/files/8ef/64b/591/8ef64b5911e84728888eb7543047356b.jpg"><br>  <i>Fig.</i>  <i>Illustration of digitization and reconstruction</i> <br><br>  Used math algorithms. <br><ul><li>  Inverse Radon transform. </li><li>  Marching / Walking Cubes. </li><li>  Gauss filter. </li><li>  Filtering / convolution, normalization of projections. </li></ul><br>  Implementation and technology. <br><ul><li>  C ++ / Qt. </li><li>  Ubuntu, Windows. </li><li>  CUDA. </li><li>  Volumetric-voxel model rendering. </li><li>  Own format for storing images with grayscale depth of 12 bits. </li><li>  Separation of reconstruction on the client-server. </li><li>  Saving bulk data in the form of "Oktoderev". </li></ul><br>  Labor costs: 5233 man-hours. <br>  Debugging was performed on raw data (projection images) obtained from a tomograph. <br><br><h4>  <b>Algorithms</b> </h4><br>  First of all, it was necessary to choose the mathematical apparatus for solving the problem.  The main algorithm - the inverse <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25A0%25D0%25B0%25D0%25B4%25D0%25BE%25D0%25BD%25D0%25B0">Radon transform</a> - was laid in the formulation of the problem, <br><img src="https://habrastorage.org/files/871/500/2c5/8715002c55ee4f69ae50f2d8ac7cb806.jpg"><br>  however, it was necessary to adapt it to the peculiarities of our work and use several additional, auxiliary algorithms.  For example, in view of the fact that the object was illuminated by one ‚Äúlight bulb,‚Äù the formulas for the inverse Radon transform had to be adapted to conical, rather than direct, projections.  The standard algorithm assumes that the object is illuminated by a beam of parallel x-rays coming from an infinitely distant source.  In reality, the source of the rays is a point source, therefore the beam of rays has the shape of a cone.  In this regard, the algorithm of the inverse Radon transform required a coordinate transformation from a conical system to a rectangular one. <br><br>  At the first stage of calculations, preliminary filtering / convolution, normalization of projections is performed.  This is necessary in order to mute the noise on the projections, and the density to more clearly distinguish. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cae/eec/732/caeeec732384a5d54610170df24b2b43.png" align="right"><br>  To build 3D-models of surfaces of objects in a standard format for viewing in 3D-editors Compass, SolidWork, 3D Max Studio, the ‚Äú <a href="https://ru.wikipedia.org/wiki/Marching_cubes">Marching (Walking) Cubes</a> ‚Äù algorithm was used.  The essence of the algorithm is that it runs through a scalar field, at each iteration it looks at 8 neighboring positions (cube vertices parallel to the coordinate axes) and determines the polygons needed to represent the part of the isosurface passing through the cube.  Further, polygons forming a given isosurface are displayed on the screen. <br><br>  The Gauss filter in the project is understood as matrix image processing filters using a convolution matrix.  The convolution matrix is ‚Äã‚Äãa matrix of coefficients that is ‚Äúmultiplied‚Äù by the pixel value of the image to obtain the desired result.  The filter is used to smooth voxel data and slice projections, which, in turn, improves the quality of the generated 3D models ( <a href="http://habrahabr.ru/post/142818/">Habrapost 1</a> , <a href="http://habrahabr.ru/post/62738/">Habrapost 2</a> ). <br><br><h4>  <b>Implementation and technology</b> </h4><br>  During the work, a number of specialized technical solutions were also created: a library for volume-voxel rendering of the model;  video recording when performing operations with the model;  12-bit deep gray image storage;  saving bulk data in the form of Oktoderev'ev;  polygonization algorithms 3D-model. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/175/380/9e1/1753809e18b1f38637e8461db0394ee0.png" alt="image" align="right"><br>  Volumetric-voxel model rendering in the project was used to view the model with the ability to rotate and scale in real time.  <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BE%25D0%25BA%25D1%2581%25D0%25B5%25D0%25BB">A voxel</a> is a three-dimensional pixel.  Also, using voxel rendering, the operator is provided with convenient tools for determining the viewing area with an automatic increase in the level of detail and the ability to position the section plane at any angle in two clicks.  On the basis of the cutting plane, you can later obtain a slice image with maximum resolution. <br clear="right"><img src="https://habrastorage.org/getpro/habr/post_images/f1f/a3b/b90/f1fa3bb90a532171123237fcc7a9ded8.png" alt="image" align="right">  <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25BA%25D1%2582%25D0%25BE%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">Oct</a> tree (octant tree, octal tree, English octree) is a type of tree data structure in which each internal node has exactly eight ‚Äúdescendants‚Äù.  Octal trees are most often used to divide three-dimensional space, recursively dividing it into eight cells.  In the project, an octree tree allows you to display data in preview mode when there is no need for data that is not visible to the user.  For example, volumetric rendering receives a dataset for display with detail depending on the selected area using an octree, which provides a high FPS when the entire model is visible, and at the same time an increase in detail if some smaller part of the model is selected. <br><br><h4>  <b>Debugging</b> </h4><br>  Next was the optimization stage.  For one object, the tomograph produces 360 images, each with a resolution of up to 8000 * 8000.  Since the volume of data processed is large, the solution of the problem ‚Äúhead on‚Äù would be completely unsatisfactory.  This was taken into account at the design stage, but after receiving the first version, the algorithms had to be optimized and adapted several times.  The task required that the time for creating a three-dimensional model of the microstructure did not exceed 2 hours, therefore the optimization stage was laid initially.  During the testing of the first version, we faced the fact that the use of a standard format for storing projection images is not suitable for a project.  The input data contains <a href="https://en.wikipedia.org/wiki/Tagged_Image_File_Format">TIFF</a> images with 16-bit coding for grayscale.  Such a depth of color for calculations is redundant, and disk space, network channel, RAM and processor time processing of such images requires a lot.  On the other hand, the standard 8-bit color depth was not enough for us to maintain the accuracy of the reconstruction.  Therefore, an image storage format with a 12-bit color depth was developed. <br><br>  In the technical project was laid horizontal scaling calculations.  The reconstruction of the 3D model, that is, the main computing task, was divided into small task packages, which the central software module distributed over the network of servers in the cluster.  The servers used <a href="https://ru.wikipedia.org/wiki/CUDA">CUDA</a> technology, which allows to use the computing power of graphics processors for calculations.  The time required to calculate a single model is reduced in proportion to the number of servers in a cluster, since computing tasks are perfectly parallelized, and all servers are 100% loaded. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2bd/1c8/64f/2bd1c864fdc632fe1d73dd366daee9d2.png" alt="image"><br><br>  The CUDA architecture is applicable not only for high-performance graphics computing, but also for various scientific computing using nVidia graphics cards.  Scientists and researchers make extensive use of CUDA in various fields, including astrophysics, computational biology and chemistry, fluid dynamics modeling, electromagnetic interactions, computed tomography, seismic analysis, and much more.  CUDA has the ability to connect to applications using OpenGL and Direct3D.  CUDA is cross-platform software for operating systems such as Linux, Mac OS X and Windows. <br><br>  In our project, CUDA is used for the main process - reconstruction of volumetric data from projections.  Since GPUs have a specialized instruction set, the reconstruction calculations fit well on graphics cards through CUDA technology.  On a CPU, this task is solved longer, both at the development stage and at the execution stage. <br><br><img src="https://habrastorage.org/files/081/173/a41/081173a417f84376ae29d046fc434759.jpg"><br>  Cards supported by our software: <br><ul><li>  <a href="http://amzn.com/B00Q7O7PQA">Nvidia Tesla K80 24GB</a> (scientific); </li><li>  <a href="http://amzn.com/B00UVN21RQ">EVGA GeForce GTX TITAN X 12GB</a> (gaming). </li></ul><br><br>  The task stipulated that the software should work in the environment of Microsoft Windows XP / Vista / 7, Linux.  In this regard, the cross-platform solution was laid initially.  C ++ / Qt was chosen as the development language, which allowed us to have a single source code and build software for different operating systems. <br><br><img src="https://habrastorage.org/files/f3a/f66/810/f3af66810b3a4fb487f41c78d071b9ac.png"><br><br><img src="https://habrastorage.org/files/ae2/bc8/00a/ae2bc800aac34e7d9c744ec9f173c97f.jpg"><br><br><h4>  <b>Video</b> </h4><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6b2YZreJ8iE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/onWNZIA11v8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ZLFdAtw_kWQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zJTsMkDBtcM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/l3X9vHLbTnM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3a8ZHHgITDU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/onO5AeiKNOQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/1jsI45BF5YA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/diQGQEhnGLE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br> <a href="http://www.edsd.com/"><img src="https://habrastorage.org/files/398/998/a96/398998a96bd342d18422b1dbb66a271e.jpg" width="400"></a> <br><br>  More projects: <br>  <a href="https://habrahabr.ru/company/edison/blog/273295/">How to create software for a microtomograph for 5233 man-hours</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/282804/">SDK for the introduction of support for e-books in FB2 format</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/232033/">Control access to electronic documents.</a>  <a href="https://habrahabr.ru/company/edison/blog/232033/">From DefView to Vivaldi</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/317290/">Integrating two video surveillance systems: Axxon Next and SureView</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/282848/">Read more about the development of x-ray tomograph software</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/281765/">Sphere: how to monitor billions of kilowatt-hours</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/256789/">Developing a simple plugin for JIRA to work with a database</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/280550/">To help DevOps: a firmware builder for network devices on Debian for 1008 hours</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/270777/">Windows Service Auto Update for Poor AWS</a> </div><p>Source: <a href="https://habr.com/ru/post/273295/">https://habr.com/ru/post/273295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273281/index.html">Creating a business process in BPEL using the Serena Business Manager platform</a></li>
<li><a href="../273283/index.html">Open source application architecture: How nginx works</a></li>
<li><a href="../273289/index.html">Intel RealSense SDK and Oculus Rift DK2</a></li>
<li><a href="../273291/index.html">Look in both or a little about infographics.</a></li>
<li><a href="../273293/index.html">Castanedovskiy warrior risk management</a></li>
<li><a href="../273299/index.html">Unity's demo project The Blacksmith</a></li>
<li><a href="../273301/index.html">War, peace and ABBYY Compreno: the continuation of our affair with Tolstoy</a></li>
<li><a href="../273305/index.html">Evolution of data structures in Yandex. Metric</a></li>
<li><a href="../273307/index.html">Digital Data Layer - the heart of your tag-management system</a></li>
<li><a href="../273311/index.html">NW + Edge.js + Fiddler or a tale about the dockability of the untangible</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>