<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Back up configuration switches, or fasten a little automation to GLPI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes, in our work, there is a need to account for all network equipment: types, models, addresses, firmware, wiring diagrams, and so on. And now,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Back up configuration switches, or fasten a little automation to GLPI</h1><div class="post__text post__text-html js-mediator-article">  Sometimes, in our work, there is a need to account for all network equipment: types, models, addresses, firmware, wiring diagrams, and so on.  And now, after reviewing several software options, the choice fell on the open draft <a href="http://glpi-project.org/">GLPI</a> .  The functionality of the system is rich, specifically in our case, used to account for "hardware" and, most importantly, to account for the connection diagrams (which port of which switch is connected to where).  As part of the organization‚Äôs core business (providing access to the Internet), a need arose (of course, not suddenly, but strictly according to plan) to back up the configuration of switches, why and why this operation is necessary ‚Äî everyone should know this.  And how to implement this, in conjunction with the GLPI will be this article. <br><a name="habracut"></a><br>  To implement our plans, you need a list of addresses of equipment and a list of manufacturers, all this data is in the GLPI database, of course, if you have previously brought them there.  IP addresses are needed to connect over the network, and why do we need to know the manufacturer?  The fact is that each manufacturer of network equipment, for various reasons, introduces its own ‚Äúoriginal‚Äù ideas there and, therefore, the commands for controlling the hardware are different.  In our particular case, there are only two manufacturers, but nothing prevents the list from expanding. <br>  We will perform the copying operation of the config through a telnet connection, the same can be done via SNMP, but in this case, the entire SNMP hardware for recording (command execution) is closed. <br><br>  The implementation language was PERL.  Why so?  Well, at that time I was sawing, on it, still some software (RDR assembler and disassembler, web snout to it) and, according to this, pearl.  As the OS - GNU / Linux. <br><br>  Let's start the code: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We connect the necessary modules: <br><br><pre><code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use Net::Telnet (); use IO::File; use Getopt::Long; use DBI;</span></span></code> </pre> <br>  The function of removing spaces is implemented independently, why and why, I do not remember, but let it be: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#     sub trim { my($string)=@_; for ($string) { s/^\s+//; s/\s+$//; } return $string; }</span></span></code> </pre> <br>  In order not to get up two times, archiving, copying and deleting old files is simultaneously implemented in the script.  System commands are used whenever possible: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#   $date = `/bin/date "+%Y%m%d"`; $date = trim($date); $arch = "tar -czvf /var/srv/backup/conf/conf-".$date.".tgz /var/lib/tftpboot/"; my $result = `$arch`; #      $del = '/bin/find /var/srv/backup/conf/ -ctime +7 -name conf-*.tgz -exec rm {} \; -print &gt; /var/log/switch-conf_backup.log'; my $delResult = `$del`;</span></span></code> </pre> <br>  Connect to the database: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#   GLPI  my $dsn = 'DBI:mysql:glpi:192.168.123.222'; my $db_user_name = 'user'; my $db_password = 'password'; my ($id, $password); my $dbh = DBI-&gt;connect($dsn, $db_user_name, $db_password);</span></span></code> </pre> <br>  We select the necessary addresses of the switches of the desired manufacturer and, accordingly, ‚Äúpull‚Äù the procedures we need (which will be described below): <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $sth = $dbh-&gt;prepare(<span class="hljs-string"><span class="hljs-string">qq{SELECT ip FROM glpi_networkequipments WHERE manufacturers_id=1 AND states_id=1}</span></span>); $sth-&gt;execute(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($ip) = $sth-&gt;fetchrow_array()) { <span class="hljs-comment"><span class="hljs-comment"># print "$ip\n"; if ($ip eq "" || $ip =~ /^#+/) { #   .  ,  :) } else { #    connectSwitchEdgeCore("$ip"); } } $sth-&gt;finish(); #   D-Link   "" my $sth = $dbh-&gt;prepare(qq{SELECT ip FROM glpi_networkequipments WHERE manufacturers_id=3 AND states_id=1}); $sth-&gt;execute(); while (my ($ip) = $sth-&gt;fetchrow_array()) { if ($ip eq "" || $ip =~ /^#+/) { } else { connectSwitchDlink("$ip"); } } $sth-&gt;finish(); $dbh-&gt;disconnect();</span></span></code> </pre> <br>  It is worth noting that the values ‚Äã‚Äãof <i>manufacturers_id</i> and <i>states_id</i> (the first is the manufacturer‚Äôs code, the second is the status of the equipment (‚Äúput into operation‚Äù, ‚Äúin the project‚Äù, etc.)) and, most likely, will differ, because  they are created automatically when adding positions to the database.  In this case, the manufacturer ‚Äú1‚Äù is EdgeCore (‚Äú3‚Äù - D-Link) and the status ‚Äú1‚Äù is ‚ÄúEnabled‚Äù i.e.  commissioned.  Tracking status is necessary in order to exclude attempts to connect with inactive, for various reasons, hardware. <br><br>  Then there are two, almost identical, procedures that implement the dialogue between the script and the switchboard on the topic ‚Äúand copy your current config to the tftp server‚Äù: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment"># telnet-        tftp  #     EdgeCore sub connectSwitchEdgeCore { $hostname = "$_[0]"; $username = "user"; $passwd = "password"; $date = `/bin/date "+%Y%m%d"`; $str_fn=$hostname; print $str_fn; $tftpserver="20.20.20.20"; $conn = new Net::Telnet ( Timeout=&gt;3, Errmode=&gt;'return', Prompt =&gt; '/\#.?$/i'); $conn-&gt;open(Host =&gt; $hostname); $conn-&gt;waitfor('/ame[: ]*$/'); $conn-&gt;print($username); $conn-&gt;waitfor('/ord[: ]*$/'); $conn-&gt;print($passwd); $conn-&gt;print("copy running-config tftp"); $conn-&gt;waitfor('/ess[: ]*$/'); $conn-&gt;print($tftpserver); $conn-&gt;waitfor('/ame[: ]*$/'); $conn-&gt;print($str_fn); $conn-&gt;print("exit"); $conn-&gt;print("logout"); } #     D-Link sub connectSwitchDlink { $hostname = "$_[0]"; $username = "user"; $passwd = "password"; $date = `/bin/date "+%Y%m%d"`; $str_fn=$hostname; print "$str_fn\n"; $tftpserver="20.20.20.20"; $conn = new Net::Telnet ( Timeout=&gt;3, Errmode=&gt;'return', Prompt =&gt; '/\#.?$/i'); $conn-&gt;open(Host =&gt; $hostname); $conn-&gt;waitfor('/ame[: ]*$/'); $conn-&gt;print($username); $conn-&gt;waitfor('/ord[: ]*$/'); $conn-&gt;print($passwd); $conn-&gt;print("upload cfg_toTFTP $tftpserver dest_file $hostname"); $conn-&gt;waitfor('/Success/'); $conn-&gt;print("logout"); }</span></span></code> </pre> <br>  The server address and connection parameters with the database, it was more logical to put it in a separate file, but due to the location of the celestial bodies at that moment, it was left so.  The <i>print</i> commands are left for logging.  The script is run on cron-time. <br><br>  That is how simple and easy the routine operation was automated.  Traditionally, source code is available <a href="https://bitbucket.org/svk28/utils">here</a> . <br><br>  PS I thought what stream to place the article, tossed between "Administration" and "Development", eventually settled on the first option. </div><p>Source: <a href="https://habr.com/ru/post/336850/">https://habr.com/ru/post/336850/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336840/index.html">How (and why) we ported Shenzhen Solitaire under MS-DOS</a></li>
<li><a href="../336842/index.html">We bypass the commercial protection using the black box method and write packet hack for lineage 2</a></li>
<li><a href="../336844/index.html">One method for solving different tasks: the percentage distribution of calls</a></li>
<li><a href="../336846/index.html">Richard Hamming: "I often compare creativity with sex"</a></li>
<li><a href="../336848/index.html">Transfer mail from Exchange to Zimbra</a></li>
<li><a href="../336852/index.html">Optimize the launch time of iOS applications</a></li>
<li><a href="../336854/index.html">Multithreading in C ++ and SObjectizer with CSP channels, but without any actors ...</a></li>
<li><a href="../336858/index.html">Entertaining math with colored cubes</a></li>
<li><a href="../336860/index.html">How to hash passwords in high-load services. Yandex experience</a></li>
<li><a href="../336864/index.html">Getting ready for Java 9. Review of the most interesting improvements.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>