<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bleed TinyMCE 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, my name is Konstantin, I work as a front-end developer on an infotainment portal, the main content of which is news and articles. And, of cours...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bleed TinyMCE 4</h1><div class="post__text post__text-html js-mediator-article">  Hello, my name is Konstantin, I work as a front-end developer on an infotainment portal, the main content of which is news and articles.  And, of course, it was extremely important for us to organize comfortable work with the portal for our editors.  About how much progress we have achieved in this field, and there will be this article. <br><a name="habracut"></a><br>  We use the TinyMCE version 4.2.4 WYSIWYG editor on our portal for editing news and articles.  He showed himself from the best side among all WYSIWYG editors both in terms of stability of work, and in terms of the quality of the generated HTML markup.  In addition, it was the easiest to learn for people accustomed to working with office applications. <br><br>  But some of its basic capabilities are not enough to fulfill all the editorial needs.  I will not describe the process of configuring TinyMCE: firstly, everyone has different needs, and secondly, this point is very well covered in the <a href="https://www.tinymce.com/docs/configure/">documentation</a> .  But I will talk about solutions that may be useful to many and which are not so easy to find on the Internet. <br><br>  And today we are talking about: <br><ul><li>  <a href="https://habr.com/ru/post/266337/">working with images</a> ; </li><li>  <a href="https://habr.com/ru/post/266337/">formatting HTML markup when pasting text from external sources</a> ; </li><li>  <a href="https://habr.com/ru/post/266337/">typography</a> . </li></ul><br><h2><a name="images"></a>  Work with images </h2><br>  Recently, the number of illustrations in our articles has increased markedly.  And therefore, one of the most important tasks for us was the implementation of a simple and convenient mechanism for working with images. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here are the most important points that we have defined for ourselves: <br><ul><li>  simple loading of images; </li><li>  simple insertion of images in the text; </li><li>  resize images to the size specified in the text; </li><li>  simple link creation to an enlarged image. </li></ul><br>  There are quite a few TinyMCE plug-ins for working with graphics (including its native, paid <a href="http://www.moxiemanager.com/">MoxieManager</a> plugin) that mimic file managers.  However, as practice has shown, all these rich possibilities ‚Äúa la‚Äù Windows Explorer are completely unnecessary for editors.  And so we decided to abandon this concept and simplify the loading of illustrations and adding them to the article as much as possible. <br><br>  To do this, we placed an additional panel under the TinyMCE window specifically for working with images.  We decided that when someone rules a certain text, he should only see those images that are directly related to this article.  There won't be so many of them, and you won't have to catalog the images.  Also, just in case, we added a second tab to the panel - to work with global illustrations, which can be available in all articles (but it has not yet been used). <br><br><img src="https://habrastorage.org/files/def/994/393/def9943934ed4dd0a8c415b726b05e6e.png"><br><br>  To download images, we used the <a href="http://www.dropzonejs.com/">Dropzone.js</a> plugin.  It has the following features: <br><ul><li>  Drag'n'Drop support; </li><li>  multi-boot via Ajax; </li><li>  simple customization; </li><li>  and no dependencies - only vanilla JS. </li></ul><br>  Its configuration, as well as the TinyMCE configuration, is well described in the documentation.  I am sure that you can easily sharpen his work for yourself, and therefore I will not focus on it.  You can also use any other similar plugin, since there are quite a lot of them now. <br><br>  Thanks to this approach, we were able to store images on the server as we like, and simplified the process of loading them.  But our ultimate goal is still adding images to the text of the article. <br><br>  So, we have a certain panel on which the list of all images available for an article is displayed, and we need to insert them into the text when clicking on these images.  The TinyMCE <a href="https://www.tinymce.com/docs/api/class/tinymce/">execCommand</a> editor will help us achieve <a href="https://www.tinymce.com/docs/api/class/tinymce/">this</a> : <br><br><pre><code class="javascript hljs">tinymce.activeEditor.execCommand(<span class="hljs-string"><span class="hljs-string">'mceInsertContent'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, img);</code> </pre> <br>  But this is far from everything - here the most interesting part begins.  By acting in this way, we get rich control over the added elements. <br><br>  For example, on our portal, the width of the content area for the article is strictly limited.  And if the loaded image is much wider - it will be reduced to the required size and inserted along with a link to the original.  At the same time, rather large images are inserted in our wrappers, which stretch to the full width of the article and filled in along the edges with average color using a <a href="https://github.com/bashkos/jquery.fillcolor">jQuery plugin</a> . <br><br>  The definition of appropriate behavior occurs at the stage of adding illustrations to the text.  But what if users will edit images with standard TinyMCE controls?  In order not to lose control over the elements, add an event handler for the NodeChange event for the editor (we do this at the time of configuring TinyMCE): <br><br><pre> <code class="javascript hljs">tinymce.init({ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> setup: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">editor</span></span></span><span class="hljs-function">) </span></span>{ editor.on(<span class="hljs-string"><span class="hljs-string">'NodeChange'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.element.nodeName === <span class="hljs-string"><span class="hljs-string">'IMG'</span></span> &amp;&amp; e.element.classList.contains(<span class="hljs-string"><span class="hljs-string">'mce-object'</span></span>) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> } }); } });</code> </pre><br>  Since the various embedded elements (iframe, embedded) in TinyMCE are replaced with a stub image, we perform an additional test for the absence of the mce-object class in order to distinguish them from the usual illustrations. <br><br>  Having caught the event of an element change and having determined that this element is an image, we regain control over it.  We can check if its dimensions have not gone out (the specified sizes will be transferred in the event object: e.width, e.height) beyond permissible limits, whether proportions are not violated (and this has happened), etc. ... I recommend to keep the original image sizes in data- * attribute elements. <br><br>  You can argue by saying that in order to capture the resize of images in the editor, it is enough to use the <a href="https://www.tinymce.com/docs/api/class/tinymce.editor/">ObjectResizeStart and ObjectResized events</a> .  However, these events will not work if the dimensions of the illustration are changed using the image insertion / editing tool. <br><br>  Another trick is to prevent the image from stretching beyond the specified limits (this can be either the limitations of the content area or the maximum dimensions of the image itself), set its max-width and max-height properties in the style attribute when inserting. <br><br>  Thus, we solved several points of our initial task, but we are still concerned about the resizing of images to the size specified in the article on the server side, so that portal visitors do not have to upload large (heavy) illustrations that would only visually decrease. <br><br>  This problem is solved quite simply, if you use bb codes to edit text - you simply resize the images at the time of processing the command to insert them into the text.  In the case of WYSIWYG editors, you have two options: to parse the generated HTML or use special links.  We chose the second. <br><br>  Regardless of what your backend is written on, you can make sure that, according to certain parameters, a suitable image is formed in the link and placed in the cache.  When you insert an element into the editor, it is quite simple to generate the corresponding link, and when you edit the image, the NodeChange event handler will come to your rescue.  The main thing to remember is that when the src attribute of an element changes, the data-mce-src attribute will also need to be changed. <br><br>  This handler is used here (jQuery is used here for working with DOM): <br><br><pre> <code class="javascript hljs">resizeImage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$image, width, height</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> originalWidth = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>($image.data(<span class="hljs-string"><span class="hljs-string">'originalWidth'</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), originalHeight = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>($image.data(<span class="hljs-string"><span class="hljs-string">'originalHeight'</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), ratio, defaultWidth, defaultHeight, link = $image.attr(<span class="hljs-string"><span class="hljs-string">'src'</span></span>), linkParams; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> width === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span> || width === <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { width = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>($image.attr(<span class="hljs-string"><span class="hljs-string">'width'</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> height === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span> || height === <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { height = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>($image.attr(<span class="hljs-string"><span class="hljs-string">'height'</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>); } defaultWidth = width; defaultHeight = height; <span class="hljs-comment"><span class="hljs-comment">/*   ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(originalWidth) || originalWidth === <span class="hljs-number"><span class="hljs-number">0</span></span> || <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(originalHeight) || originalHeight === <span class="hljs-number"><span class="hljs-number">0</span></span>) { $image .attr({ <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }) .css({ <span class="hljs-attr"><span class="hljs-attr">maxWidth</span></span>: <span class="hljs-string"><span class="hljs-string">'none'</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxHeight</span></span>: <span class="hljs-string"><span class="hljs-string">'none'</span></span> }); originalWidth = $image.width(); originalHeight = $image.height(); ratio = originalWidth / originalHeight; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> maxWidth = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.min(originalWidth, pageWidth), maxHeight = (maxWidth === originalWidth ? originalHeight : <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(maxWidth / ratio)); $image .attr({ <span class="hljs-attr"><span class="hljs-attr">width</span></span>: width, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: height, <span class="hljs-string"><span class="hljs-string">'data-original-width'</span></span>: originalWidth, <span class="hljs-string"><span class="hljs-string">'data-original-height'</span></span>: originalHeight }) .css({ <span class="hljs-attr"><span class="hljs-attr">maxWidth</span></span>: maxWidth, <span class="hljs-attr"><span class="hljs-attr">maxHeight</span></span>: maxHeight }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ratio = originalWidth / originalHeight; } width = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.min(originalWidth, pageWidth, width); height = (width === originalWidth ? originalHeight : <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(width / ratio)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (link.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>) === <span class="hljs-string"><span class="hljs-string">'http://'</span></span>) { linkParams = link.substr(<span class="hljs-number"><span class="hljs-number">7</span></span>).split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { linkParams = link.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/*     ,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (linkParams.length === <span class="hljs-number"><span class="hljs-number">6</span></span> &amp;&amp; linkParams[<span class="hljs-number"><span class="hljs-number">0</span></span>] === <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.host &amp;&amp; (linkParams[<span class="hljs-number"><span class="hljs-number">1</span></span>] === <span class="hljs-string"><span class="hljs-string">'r'</span></span> || linkParams[<span class="hljs-number"><span class="hljs-number">1</span></span>] === <span class="hljs-string"><span class="hljs-string">'c'</span></span>) &amp;&amp; isDecimal(linkParams[<span class="hljs-number"><span class="hljs-number">2</span></span>]) &amp;&amp; isDecimal(linkParams[<span class="hljs-number"><span class="hljs-number">3</span></span>])) { link = <span class="hljs-string"><span class="hljs-string">'http://'</span></span> + linkParams[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + linkParams[<span class="hljs-number"><span class="hljs-number">1</span></span>] + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + width + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + height + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + linkParams[<span class="hljs-number"><span class="hljs-number">4</span></span>] + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + linkParams[<span class="hljs-number"><span class="hljs-number">5</span></span>]; $image.attr({ <span class="hljs-attr"><span class="hljs-attr">src</span></span>: link, <span class="hljs-string"><span class="hljs-string">'data-mce-src'</span></span>: link }); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (width !== defaultWidth || height !== defaultHeight) { $image.attr({ <span class="hljs-attr"><span class="hljs-attr">width</span></span>: width, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: height }); } } tinymce.init({ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> setup: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">editor</span></span></span><span class="hljs-function">) </span></span>{ editor.on(<span class="hljs-string"><span class="hljs-string">'NodeChange'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.element.nodeName === <span class="hljs-string"><span class="hljs-string">'IMG'</span></span> &amp;&amp; e.element.classList.contains(<span class="hljs-string"><span class="hljs-string">'mce-object'</span></span>) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { resizeImage($(e.element), e.width, e.height); } }); } });</code> </pre><br>  As you can see, even if the original dimensions of the image are not indicated in the data- * attributes, the function tries to calculate them independently and perform all the necessary checks.  This approach allows to ensure compatibility with previously accumulated material on the portal. <br><br><h2><a name="html-formatting"></a>  Formatting HTML Markup </h2><br>  It is this task that caused us the most difficulties. <br><br>  After a thorough study of the TinyMCE documentation, it was found that there is no way to configure the editor to clean the HTML markup from various garbage when pasting text from Word or from other sites, and would not cut down the functionality of users.  We also did not find ready-made solutions that satisfy our needs on the Internet. <br><br>  I had to do it on my own, and that‚Äôs what we did with <a href="https://github.com/WEACOMRU/html-formatting">github.com/WEACOMRU/html-formatting</a> . <br><br>  The function presented in the repository checks the compliance of the contents of the container passed to it with certain rules and gets rid of all the excess.  It is written in pure JS and does not require any dependencies and is distributed under the MIT license. <br><br>  To format the markup when pasting text into TinyMCE, you need to set a paste_postprocess event handler: <br><br><pre> <code class="javascript hljs">tinymce.init({ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> paste_postprocess: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">plugin, args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> valid_elements = { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> }; htmlFormatting(args.node, valid_elements); } });</code> </pre><br>  You can familiarize yourself with the principles of configuring rules on a githaba, but I will talk about how this function works. <br><br>  If you look at a ready-made solution, everything turns out to be quite elementary: in the cycle we iterate through all the child elements of the HTML container and for each we start a separate processing.  We perform the function recursively until we reach the deepest level of nesting. <br><br><pre> <code class="javascript hljs">process = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, valid_elements</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> taskSet = [], i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length; i++) { processNode(node.childNodes[i], valid_elements, taskSet); } doTasks(taskSet); }</code> </pre><br>  In the process of processing an individual element, we first of all check whether we are dealing with an HTML element or text. <br><br><pre> <code class="javascript hljs">processNode = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, valid_elements, taskSet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rule; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType === <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* HTML- */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType === <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> } }</code> </pre><br>  Text elements are processed in their own way - all non-breaking spaces are removed from them. <br><br><pre> <code class="javascript hljs">processText = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function">) </span></span>{ node.nodeValue = node.nodeValue.replace(<span class="hljs-regexp"><span class="hljs-regexp">/\xa0/g</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>); }</code> </pre><br>  This is due to the fact that our editors experienced difficulties due to lingering inseparable spaces in the copied text, which broke the hyphenation in the article.  This procedure solves this problem, but it may turn out to be undesirable for you, if this is the case - correct the source code of the function to your needs. <br><br>  HTML elements are processed in accordance with the specified rules. <br><br><pre> <code class="javascript hljs">getRule = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, valid_elements</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> re = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">'(?:^|,)'</span></span> + node.tagName.toLowerCase() + <span class="hljs-string"><span class="hljs-string">'(?:,|$)'</span></span>), rules = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(valid_elements), rule = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; rules.length &amp;&amp; !rule; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (re.test(rules[i])) { rule = valid_elements[rules[i]]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rule; } ... processNode = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, valid_elements, taskSet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rule; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType === <span class="hljs-number"><span class="hljs-number">1</span></span>) { rule = getRule(node, valid_elements); ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.nodeType === <span class="hljs-number"><span class="hljs-number">3</span></span>) { processText(node); } }</code> </pre><br>  If the rule for this element is not found, it is unpacked, i.e.  all its child elements are moved to a higher level and replace this element. <br><br><pre> <code class="javascript hljs">unpack = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parent = node.parentNode; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (node.childNodes.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { parent.insertBefore(node.childNodes[<span class="hljs-number"><span class="hljs-number">0</span></span>], node); } } ... if (rule) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> rule.valid_elements === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { process(node, valid_elements); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { process(node, rule.valid_elements) } ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { process(node, valid_elements); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.hasChildNodes()) { taskSet.push({ <span class="hljs-attr"><span class="hljs-attr">task</span></span>: <span class="hljs-string"><span class="hljs-string">'unpack'</span></span>, <span class="hljs-attr"><span class="hljs-attr">node</span></span>: node }); } taskSet.push({ <span class="hljs-attr"><span class="hljs-attr">task</span></span>: <span class="hljs-string"><span class="hljs-string">'remove'</span></span>, <span class="hljs-attr"><span class="hljs-attr">node</span></span>: node }) }</code> </pre><br>  If there is a corresponding rule, the element is preserved if it is not empty (a container containing at least one text element at any nesting level, consisting not only of spaces, is considered empty) or there is no setting in the rule to delete empty elements (no_empty). <br><br><pre> <code class="javascript hljs">isEmpty = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, re = <span class="hljs-regexp"><span class="hljs-regexp">/^\s*$/</span></span>, i, child; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.hasChildNodes()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; node.childNodes.length &amp;&amp; result; i++) { child = node.childNodes[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child.nodeType === <span class="hljs-number"><span class="hljs-number">1</span></span>) { result = isEmpty(child); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child.nodeType === <span class="hljs-number"><span class="hljs-number">3</span></span> &amp;&amp; !re.test(child.nodeValue)) { result = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } ... if (rule.no_empty &amp;&amp; isEmpty(node)) { taskSet.push({ <span class="hljs-attr"><span class="hljs-attr">task</span></span>: <span class="hljs-string"><span class="hljs-string">'remove'</span></span>, <span class="hljs-attr"><span class="hljs-attr">node</span></span>: node }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ... }</code> </pre><br>  Depending on the configuration of the rule, styles and element classes are checked. <br><br><pre> <code class="javascript hljs">checkStyles = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, valid_styles</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, re; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> valid_styles === <span class="hljs-string"><span class="hljs-string">'string'</span></span> &amp;&amp; node.style.length) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = node.style.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { re = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">'(?:^|,)'</span></span> + node.style[i] + <span class="hljs-string"><span class="hljs-string">'(?:,|$)'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!re.test(valid_styles)) { node.style[node.style[i]] = <span class="hljs-string"><span class="hljs-string">''</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!node.style.cssText) { node.removeAttribute(<span class="hljs-string"><span class="hljs-string">'style'</span></span>); } } } checkClasses = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, valid_classes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, re; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> valid_classes === <span class="hljs-string"><span class="hljs-string">'string'</span></span> &amp;&amp; node.classList.length) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = node.classList.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { re = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">'(?:^|\\s)'</span></span> + node.classList[i] + <span class="hljs-string"><span class="hljs-string">'(?:\\s|$)'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!re.test(valid_classes)) { node.classList.remove(node.classList[i]); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!node.className) { node.removeAttribute(<span class="hljs-string"><span class="hljs-string">'class'</span></span>); } } } ... checkStyles(node, rule.valid_styles); checkClasses(node, rule.valid_classes);</code> </pre><br>  The need for conversion and its additional processing is immediately checked and the identifier is deleted. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rule.convert_to) { taskSet.push({ <span class="hljs-attr"><span class="hljs-attr">task</span></span>: <span class="hljs-string"><span class="hljs-string">'convert'</span></span>, <span class="hljs-attr"><span class="hljs-attr">node</span></span>: node, <span class="hljs-attr"><span class="hljs-attr">convert_to</span></span>: rule.convert_to }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.id) { node.removeAttribute(<span class="hljs-string"><span class="hljs-string">'id'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> rule.process === <span class="hljs-string"><span class="hljs-string">'function'</span></span>) { taskSet.push({ <span class="hljs-attr"><span class="hljs-attr">task</span></span>: <span class="hljs-string"><span class="hljs-string">'process'</span></span>, <span class="hljs-attr"><span class="hljs-attr">node</span></span>: node, <span class="hljs-attr"><span class="hljs-attr">process</span></span>: rule.process }); }</code> </pre><br>  It should be noted that when converting, a new element is created, into which all child elements of the current container are placed, also, if available, styles and classes are transferred, after which the container is replaced with this new element. <br><br><pre> <code class="javascript hljs">convert = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node, convert_to</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parent = node.parentNode, converted = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(convert_to); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.style.cssText) { converted.style.cssText = node.style.cssText; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.className) { converted.className = node.className; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (node.childNodes.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { converted.appendChild(node.childNodes[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } parent.replaceChild(converted, node); }</code> </pre><br>  As you have probably noticed, all the manipulations with the DOM are queued and executed at the end of the current loop on the elements, so as not to violate it. <br><br><pre> <code class="javascript hljs">doTasks = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">taskSet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; taskSet.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (taskSet[i].task) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'remove'</span></span>: taskSet[i].node.parentNode.removeChild(taskSet[i].node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'convert'</span></span>: convert(taskSet[i].node, taskSet[i].convert_to); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'process'</span></span>: taskSet[i].process(taskSet[i].node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'unpack'</span></span>: unpack(taskSet[i].node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  You can find demo of the function in the repository  I hope that this description will help you modify the function to suit your specific needs, if in its pure form it does not satisfy you, or at least serves as an ideological inspiration. <br><br><h2><a name="typograf"></a>  Typography </h2><br>  And finally, the simplest thing remains - the introduction of the printer.  We used the wonderful script of Denis Seleznev <a href="https://habrahabr.ru/users/hcodes/" class="user_link">hcodes</a> <a href="https://github.com/typograf/typograf/">github.com/typograf/typograf</a> . <br><br>  All you need to do is write a small TinyMCE plugin: <br><br><pre> <code class="javascript hljs">tinymce.PluginManager.add(<span class="hljs-string"><span class="hljs-string">'typograf'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">editor, url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-string"><span class="hljs-string">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scriptLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> tinymce.dom.ScriptLoader(), tp, typo = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tp) { editor.setContent(tp.execute(editor.getContent())); editor.undoManager.add(); } }; scriptLoader.add(url + <span class="hljs-string"><span class="hljs-string">'/typograf.min.js'</span></span>); scriptLoader.loadQueue(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ tp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Typograf({ <span class="hljs-attr"><span class="hljs-attr">lang</span></span>: <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> }); }); editor.addButton(<span class="hljs-string"><span class="hljs-string">'typograf'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: <span class="hljs-string"><span class="hljs-string">'blockquote'</span></span>, <span class="hljs-attr"><span class="hljs-attr">onclick</span></span>: typo }); editor.addMenuItem(<span class="hljs-string"><span class="hljs-string">'typograf'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">context</span></span>: <span class="hljs-string"><span class="hljs-string">'format'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: <span class="hljs-string"><span class="hljs-string">'blockquote'</span></span>, <span class="hljs-attr"><span class="hljs-attr">onclick</span></span>: typo }); });</code> </pre><br>  As you can see, the typographer's script is placed in the folder with the plugin and loaded asynchronously using the tools of the editor <a href="https://www.tinymce.com/docs/api/class/tinymce.dom.scriptloader/">https://www.tinymce.com/docs/api/class/tinymce.dom.scriptloader/</a> .  You can download the script separately from TinyMCE, if you plan to use the printer and other functions. <br><br>  When the script is loaded, the tp variable is initialized.  The content of the editor is accessed using the <a href="https://www.tinymce.com/docs/api/class/tinymce.editor/">getContent ()</a> and <a href="https://www.tinymce.com/docs/api/class/tinymce.editor/">setContent ()</a> methods.  And, of course, after applying typography, you need to add another level of rollback changes using <a href="https://www.tinymce.com/docs/api/class/tinymce.undomanager/">undoManager</a> . <br><br>  As an icon for the button and menu item, we used the font icon of the editor for quotes.  You can see the list of available icons in TinyMCE in the skin.css file - (.mce-i- * classes). <br><br>  That's all, we hope our experience will help you in the implementation of your own ideas and reduce the time for finding solutions. </div><p>Source: <a href="https://habr.com/ru/post/266337/">https://habr.com/ru/post/266337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266325/index.html">Hidden bug (feature?) Switch ZyXEL ES-2108-G</a></li>
<li><a href="../266327/index.html">Installing Zabbix 2.4 on RedHat Openshift</a></li>
<li><a href="../266329/index.html">RailsClub 2015: Interview with Cyrus Shatrov</a></li>
<li><a href="../266331/index.html">Launch of RAD Studio 10 Seattle in Moscow and Almaty</a></li>
<li><a href="../266335/index.html">Examples of classic code that has become open source</a></li>
<li><a href="../266339/index.html">How I tried to make friends with Google API with CodeIgniter A3M and what came of it</a></li>
<li><a href="../266341/index.html">The course "Basics of effective work with Wolfram technologies". Lesson 2.1: Introduction to the Wolfram Language, its features. The main difficulties of novice users. Work with the Mathematica interface and its capabilities</a></li>
<li><a href="../266343/index.html">Handling cloud traffic. Who needs network function virtualization (NFV)?</a></li>
<li><a href="../266345/index.html">A practical guide to hacking (and protecting) games on Unity</a></li>
<li><a href="../266347/index.html">Overview of segmentation algorithms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>