<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Event-oriented Python backtesting step by step. Part 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles, we talked about what an event-oriented backtesting system was, dismantled the class hierarchy necessary for its functioning, dis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Event-oriented Python backtesting step by step. Part 4</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/itinvest/blog/268929/"><img src="https://habrastorage.org/files/af3/3ff/d49/af33ffd497c1458cac21a2724bd2cb76.jpg"></a> <br><br>  In previous articles, we talked about what an event-oriented backtesting system was, dismantled the <a href="http://habrahabr.ru/company/itinvest/blog/263097/">class hierarchy</a> necessary for its functioning, discussed how such systems <a href="http://habrahabr.ru/company/itinvest/blog/264141/">use market data</a> , and also track positions and generate purchase orders. <br><br>  Today we will talk about the execution of orders by creating a class hierarchy that will represent a simulated order processing mechanism associated with a brokerage system or another market access interface.  We will also look at metrics for evaluating the performance of the strategy being tested. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Class hierarchy for order processing </h4><br>  The <code>ExecutionHandler</code> component, which will be described in this part of the article, is redundantly simple, since it only executes orders at the current market price.  This is an absolutely unrealistic scenario, but it serves as a good initial point for subsequent improvements and complications. <br><br>  As with the previously used hierarchies of abstract base classes, you need to import the necessary entities and decorators from the abc library.  You also need to import <code>FillEvent</code> and <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <h4> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </h4> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <h4> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </h4> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> <pre> <code class="hljs pgsql"><code><code class="python">OrderEvent: <br> <br> # execution.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExecutionHandler(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-string"><span class="hljs-string">'ORDER'</span></span>: fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, <span class="hljs-string"><span class="hljs-string">'ARCA'</span></span>, event.quantity, event.direction, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       <span class="hljs-number"><span class="hljs-number">252</span></span> ‚Äî     . ,        ,      ,      .       : <span class="hljs-number"><span class="hljs-number">252</span></span> ‚àó <span class="hljs-number"><span class="hljs-number">6.5</span></span> = <span class="hljs-number"><span class="hljs-number">1638</span></span> (      ).      ,       <span class="hljs-number"><span class="hljs-number">60</span></span>: <span class="hljs-number"><span class="hljs-number">252</span></span>‚àó<span class="hljs-number"><span class="hljs-number">6.5</span></span>‚àó<span class="hljs-number"><span class="hljs-number">60</span></span> = <span class="hljs-number"><span class="hljs-number">98280.</span></span> <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code><span class="hljs-keyword"><span class="hljs-keyword">returns</span></span></code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>, periods=<span class="hljs-number"><span class="hljs-number">252</span></span>): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.sqrt(periods) * (np.mean(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)) / np.std(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [<span class="hljs-number"><span class="hljs-number">0</span></span>] eq_idx = equity_curve.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> drawdown = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) duration = pd.Series(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = eq_idx) #       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(eq_idx)): cur_hwm = max(hwm[t<span class="hljs-number"><span class="hljs-number">-1</span></span>], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> drawdown[t] == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> duration[t<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> performance <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NaivePortfolio(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>][<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'returns'</span></span>] pnl = self.equity_curve[<span class="hljs-string"><span class="hljs-string">'equity_curve'</span></span>] sharpe_ratio = create_sharpe_ratio(<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * <span class="hljs-number"><span class="hljs-number">100.0</span></span>)), ("Drawdown Duration", "%d" % dd_duration)] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </pre> <code><code><code class="python">OrderEvent: <br> <br> # execution.py import datetime import Queue from abc import ABCMeta, abstractmethod from event import FillEvent, OrderEvent</code> <br> <code>ExecutionHandler</code>           <a href="https://en.wikipedia.org/wiki/Virtual_function">  </a> <code>execute_order</code> : <br> <br> <code class="python"># execution.py class ExecutionHandler(object): """   ExecutionHandler      ,  Portfolio     Fill,    .             .           . """ __metaclass__ = ABCMeta @abstractmethod def execute_order(self, event): """   Order   ,   Fill,     Events. : event -   Event     """ raise NotImplementedError("Should implement execute_order()")</code> <br>        .     ,             ,   .  ,    ,      ,     ,      . <br> <br> ,   <code>FillEvent</code>   <code>fill_cost</code>  <code>None</code> (.    <code>execute_order</code> ),          <code>NaivePortfolio</code> ( <a href="http://habrahabr.ru/company/itinvest/blog/266623/"></a>   ).           ‚Äúvalue‚Äù,     . <br> <br>        ARCA.         . <br> <br> <code class="python"># execution.py class SimulatedExecutionHandler(ExecutionHandler): """           Fill,    ,   ..              . """ def __init__(self, events): """  ,    . : events -   Event. """ self.events = events def execute_order(self, event): """     Order   Fill,     ,      ,   /   . : event -   Event    . """ if event.type == 'ORDER': fill_event = FillEvent(datetime.datetime.utcnow(), event.symbol, 'ARCA', event.quantity, event.direction, None) self.events.put(fill_event)</code> <br>          .    ,       . <br> <br>   <br>    <a href="http://www.quantstart.com/articles/Sharpe-Ratio-for-Algorithmic-Trading-Performance-Measurement"></a>  -     .      : <br> <br> <img src="https://habrastorage.org/files/872/368/1aa/8723681aa02a42e5b9b54517e4ebf01d.png"> <br> <br>  R <sub>a</sub>     ,  R <sub>b</sub> ‚Äî  ,     . <br> <br>      ‚Äî   ,       .         ,      ,      . <br> <br>              . <br> <br>   Python <br>      <code>performance.py</code> ,           .       ,    ,   NumPy  Pandas: <br> <br> <code class="python"># performance.py import numpy as np import pandas as pd</code> <br>    ,    ‚Äî     .    ,              . <br> <br>       252 ‚Äî     . ,        ,      ,      .       : 252 ‚àó 6.5 = 1638 (      ).      ,       60: 252‚àó6.5‚àó60 = 98280. <br> <br>  <code>create_sharpe_ratio</code>    Pandas Series   <code>returns</code>                    . <br> <br> <code class="python"># performance.py def create_sharpe_ratio(returns, periods=252): """     ,     (    ). : returns - Series  Pandas      -  (252),  (252*6.5),  (252*6.5*60)  ... """ return np.sqrt(periods) * (np.mean(returns)) / np.std(returns)</code> <br>   ,    (    )      ,            . <br> <br>  <code>create_drawdowns</code> ,  ,    ‚Äî      .       ‚Äî         ¬´¬ª,    . <br> <br>        pandas Series,        .     HWM (high water mark) ‚Äî  ,      . <br> <br>       HWM   .   ,      ,    ,    HWM.        : <br> <br> <code class="python"># performance.py def create_drawdowns(equity_curve): """         PnL   .   pnl_returns   pandas Series. : pnl - pandas Series,     . : drawdown, duration -      """ #    #   High Water Mark #        hwm = [0] eq_idx = equity_curve.index drawdown = pd.Series(index = eq_idx) duration = pd.Series(index = eq_idx) #       for t in range(1, len(eq_idx)): cur_hwm = max(hwm[t-1], equity_curve[t]) hwm.append(cur_hwm) drawdown[t]= hwm[t] - equity_curve[t] duration[t]= 0 if drawdown[t] == 0 else duration[t-1] + 1 return drawdown.max(), duration.max()</code> <br>  ,     ,         .         . ,       ,          <code>Portfolio</code> ,      . <br> <br>     <code>portfolio.py</code>    : <br> <br> <code class="python"># portfolio.py .. #    from performance import create_sharpe_ratio, create_drawdowns</code> <br>  <code>Portfolio</code> ‚Äî    ,          .     <code>NaivePortfolio</code> .        <code>output_summary_stats</code> ‚Äî                . <br> <br>   .               pandas,        : <br> <br> <code class="python"># portfolio.py .. .. class NaivePortfolio(object): .. .. def output_summary_stats(self): """       ‚Äî      . """ total_return = self.equity_curve['equity_curve'][-1] returns = self.equity_curve['returns'] pnl = self.equity_curve['equity_curve'] sharpe_ratio = create_sharpe_ratio(returns) max_dd, dd_duration = create_drawdowns(pnl) stats = [("Total Return", "%0.2f%%" % ((total_return - 1.0) * 100.0)), ("Sharpe Ratio", "%0.2f" % sharpe_ratio), ("Max Drawdown", "%0.2f%%" % (max_dd * 100.0)), ("Drawdown Duration", "%d" % dd_duration)] return stats</code> <br>      .              .           <code>performance.py</code>      <code>output_summary_stats</code> . <br> <br> <i> ‚Ä¶</i> <br> <br> PS         <a href="http://habrahabr.ru/company/itinvest/blog/224353/"></a>     . <a href="http://www.itinvest.ru/promo/adv/">ITinvest</a>     <a href="http://www.itinvest.ru/education/schedule/">-   </a> .</code></code> </div><p>Source: <a href="https://habr.com/ru/post/268929/">https://habr.com/ru/post/268929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268915/index.html">Accordion about architecture and localization</a></li>
<li><a href="../268917/index.html">Visualization of static and dynamic networks on R, part 6</a></li>
<li><a href="../268921/index.html">Steam Files. Part 2 - BLOB, CDR, VDF, PAK, VPK</a></li>
<li><a href="../268923/index.html">Modifying the Vanilla Music Player for Android</a></li>
<li><a href="../268925/index.html">From participating in the hackathon to winning the Imagine Cup</a></li>
<li><a href="../268931/index.html">5 internships for programmers abroad</a></li>
<li><a href="../268933/index.html">Megahakaton IoT Russia from Intel and Microsoft</a></li>
<li><a href="../268935/index.html">Programming Philosophy 10 - AI</a></li>
<li><a href="../268939/index.html">Cybercriminals use Win32 / Brolux.A banking trojan to compromise users in Japan</a></li>
<li><a href="../268941/index.html">Mail Productivity: How Evernote was created for Outlook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>