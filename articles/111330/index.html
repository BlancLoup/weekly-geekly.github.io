<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Removing .NET programs from registration using the example of BEM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I decided to study, and at the same time try to fix one library, freeing the program working on this library from the license. 

 It ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Removing .NET programs from registration using the example of BEM</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, I decided to study, and at the same time try to fix one library, freeing the program working on this library from the license. <br><br>  It all started with the fact that somehow I got into the hands of a program for financial statements, a kind of budget option 1C.  As the developers of this program assured that it is almost the most secure and resistant to hacking.  It was this boasting that pushed to refute the overconfidence of the developers. <br><a name="habracut"></a><br>  Having rummaged in the program through <a href="http://reflector.red-gate.com/">Reflector</a> , I found out that all the main libraries of the program were written by a third-party company, moreover, they were written not for a specific project, but were a whole Framework.  The framework was written just for accounting programs.  For this kind of focus of the Framework, an unusually large amount of unnecessary functionality was pushed into it (for example, working with FTP).  An incredible number of system namespaces have been redefined. <br><br>  As well as in one of the libraries of this Framework, a namespace was defined, the classes of which were responsible for checking the correctness of the license.  In this regard, I decided to google to search for information and documentation for this Framework.  After a couple of minutes of searching, it became clear that this Framework is closed.  Why closed?  - yes, because it is distributed according to unknown criteria, at least I have not found information on this subject on <a href="http://netdec.uz/index.php">the</a> developer‚Äôs <a href="http://netdec.uz/index.php">website</a> .  Also on the developer‚Äôs site it was not possible to find reference information on this Framework.  I was looking for all this information on the fact that as mentioned above, it was this Framework that was responsible for licensing the program, a part of the soul naively thought to find the keygen for this Framework, because the license system for all programs based on this Framework is uniform.  This meant that someone for one of the programs on this Framework made a keygen.  But, alas, the searches were not crowned with success. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://netdec.uz/index.php">By the</a> way the name <a href="http://netdec.uz/index.php">NetDec</a> Framework. <br><br>  Also, an analysis of the library in which the classes responsible for checking the license were located showed that part of the classes were obfuscated, including the entire namespace responsible for the license.  There was no desire to bother with deobfuscation and subsequent recompilation, especially since the goal was to write a license generator or patcher. <br><br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/8d/76/8d76958dce96b0c2aec7a9e4aef2828e.png"></a> <br><br>  The method responsible for checking the license was found very quickly, it was necessary only to track the handler for clicking the OK button in the license input form. <br><br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/85/26/8526cf84d25ff28c7f35389820982ae4.png"></a> <br><br>  For the convenience of analyzing the code, I still had to look for an analogue of the Reflector with only a deobfuscator on board.  That was <a href="http://www.netdecompiler.com/">DisSharp</a> . <br><br>  As you can see the license in the program is a digital signature on the <a href="http://ru.wikipedia.org/wiki/DSA">DSA</a> algorithm.  To create a digital signature, the so-called computer code is taken (as they called it, it did not go into the generation of this code), the computer code is connected to the serial number, and in the DSACryptoServiceProvider :: VerifyData method are verified with a digital signature. <br><br>  An XML string is passed to the method in text1 to restore the DSA object.  After a little digging, an XML file was found, in which was the object to restore the DSA.  The first thing was a look at the search for a private key (well, what the hell is not joking), alas, of course, the developers got rid of it.  The XML file itself was embedded in the library resources.  First of all, attempts were made to generate your DSA object and insert the resulting XML into the library resources, replacing the old one. <br><br>  I didn‚Äôt have to deal with anything like this before, so the search for a program for replacing resources did not produce results.  Yes, and I wanted to make a fully automated solution to activate the program.  Of course, it was possible to patch this for such programs with similar programs, and then just replace the standard one with a patcher, but somehow it is not aesthetically pleasing.  I wanted to make a fully automated solution in order to send it for evaluation to the developers of this product. <br><br>  The search for replacing resources programmatically with an adequate solution was not given.  Hands like that let go.  Although in principle I have already proved that it is possible to bypass a license by stitching your DSA object into a library, and to make a license generator on the same object. <br>  At the time, I had to throw the whole thing in a distant box, and take up work.  After some time, someone told me again about this program and its security.  Again took up the analysis. <br><br>  After sitting for a while thinking about it, remembering that the IL compiler does not compile strings, an idea came up to my mind (which would seem to many very primitive and stupid) to look at the insides of the library through a simple notebook.  Yes, build a notepad.  Searching for the keyword DSAKeyValue immediately brought me an XML data DSA object.  An idea immediately occurred to the head on the regular expression of programmatically replacing this object with its own.  I started coding, having realized my plans, faced with the fact that the library refused to work at all.  Expecting a similar result, before a complete replacement, I tried a partial replacement of the object, after which the library worked fine, but did not even eat the official license. <br><br>  Previously, I checked the length of the official DSA object in the XML file and mine (by length is meant the number of characters), the dimensions are completely the same. <br><br>  Then I simply programmatically read the entire library into an array of bytes, fixed the first and last entry in xml of the dsa object when reading it, replaced these bytes with my own, and saved it back to a file. <br>  I forgot to say that the DSA object was generated on the fly, and when it is generated in the xml line, you can specify whether to add a private key to the data or not, I set this value to false, because it does not exist in the original signature.  Immediately when the DSA object was initialized, a digital signature with a serial number was created, which was saved to a license file. <br><br>  Having done the above steps, my xml DSA object should have been reflected in the reflector.  It only remained to try to run the program.  Squared and tried to run the program.  As expected, the program was launched without any license issues. <br><br>  After some time, I found <a href="http://habrahabr.ru/blogs/net/108947/">an article</a> in Habr√©, about MSIL code injections into third-party assemblies using the <a href="http://www.go-mono.com/mono-downloads/download.html">Mono.Cecil</a> library.  After a couple of minutes, a code was made that adds a simple return to the beginning of the license verification method, thereby confirming the license successfully! <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Injector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> assembly = AssemblyDefinition.ReadAssembly (path); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeDef <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> assembly.MainModule.Types) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> method <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> typeDef.Methods) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> mp = <span class="hljs-string"><span class="hljs-string">"("</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; method.Parameters.Count; i++) { mp += method.Parameters[i].ParameterType+<span class="hljs-string"><span class="hljs-string">","</span></span>; } mp = mp.Trim(<span class="hljs-string"><span class="hljs-string">' '</span></span>); mp = mp.Trim(<span class="hljs-string"><span class="hljs-string">','</span></span>); mp += <span class="hljs-string"><span class="hljs-string">")"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mp == <span class="hljs-string"><span class="hljs-string">"(System.Byte[],System.String,System.String)"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ilProc = method.Body.GetILProcessor(); Instruction badInstruction = Instruction.Create (OpCodes.No); Instruction firstInstruction = ilProc.Body.Instructions [<span class="hljs-number"><span class="hljs-number">0</span></span>]; ilProc.InsertBefore (firstInstruction, Instruction.Create (OpCodes.Ret, firstInstruction)); ilProc.InsertBefore (firstInstruction, badInstruction); } } } assembly.Write(path); }</code> </pre> <br><br>  This method works because the principle of license verification in this Framework is incredibly simple.  In the method that calls the method of checking the license, an exception handler is installed, if an exception occurs in the license checking method, then the license is incorrect or not at all, if there are no exceptions, everything can be started. <br><br>  Since all methods are obfuscated, it does not make sense to look for a method by name via Mono.Cecil.  Looking in the reflector, I noticed that in this library there is no one with the same arguments, with the same type and sequence.  Therefore, it was decided to distinguish the method by arguments: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mp == <span class="hljs-string"><span class="hljs-string">"(System.Byte[],System.String,System.String)"</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ }</span></span></code> </pre><br><br>  That's basically it. <br><br>  PS This article was not intended in any way for cracking aids or the like.  You do not need to be a guru in programming in order to understand that the actions performed above are primitive, and sometimes even ridiculous in their implementation. </div><p>Source: <a href="https://habr.com/ru/post/111330/">https://habr.com/ru/post/111330/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111324/index.html">Using, configuring and testing distcc and ccache</a></li>
<li><a href="../111325/index.html">Angry Birds - now for Windows</a></li>
<li><a href="../111327/index.html">Electronic documentation in schools (ACS RNO)</a></li>
<li><a href="../111328/index.html">Two beauties</a></li>
<li><a href="../111329/index.html">Computer in the car "cheap" or CarPC "Siberian"</a></li>
<li><a href="../111331/index.html">Rake tutorial</a></li>
<li><a href="../111332/index.html">The emulator of the game "life" in the GLSL language</a></li>
<li><a href="../111333/index.html">Electronic forms via Microsoft InfoPath</a></li>
<li><a href="../111336/index.html">Anti-interference coding using various codes</a></li>
<li><a href="../111338/index.html">Online cinema</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>