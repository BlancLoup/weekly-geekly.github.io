<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part X: Email Support (Edition 2018)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Miguel grinberg 



 There 


 This is the tenth part of the Mask-Tutorial Flask series, in which I will tell you how the application can send emails ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part X: Email Support (Edition 2018)</h1><div class="post__text post__text-html js-mediator-article"><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/347926/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  This is the tenth part of the Mask-Tutorial Flask series, in which I will tell you how the application can send emails to your users and how to create a password recovery function with the support of an email address. </p><a name="habracut"></a><br><p>  Under the spoiler is a list of articles in this series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> (This article) </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  Chapter 21: User Notifications (Available April 24, 2018) </li><li>  Chapter 22: Reference Tasks (Available May 1, 2018) </li><li>  Chapter 23: Application Programming Interfaces (APIs) (Available May 8, 2018) </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work, or simply do not have the patience to wait for the article for a week, I (Miguel Greenberg) offer the full version of this manual (in English) in the form of an electronic book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  As a result, after not long torments, after 9 lessons we got an application that works tolerably well with the database, so in this chapter I want to get away from this topic and add another important part that most web applications need, but exactly - sending email. </p><br><p>  Why should an application e-mail something to its users?  There are many reasons, but one of them is solving the problems associated with authentication.  In this chapter, I'm going to add a password reset feature for users who constantly forget their password.  When a user requests a password reset, the application sends an email with a specially created link.  The user then needs to click this link to access the form in which you can set a new password. </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h2 id="vvedenie-v-flask-mail">  Introduction to Flask-Mail </h2><br><p>  As for sending email, Flask has an extension called <a href="https://pythonhosted.org/Flask-Mail/">Flask-Mail</a> for this purpose, which will help make this task very simple.  As always, it (this extension) is installed using pip: </p><br><pre><code class="hljs sql">(venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> flask-mail</code> </pre> <br><p>  References to a password reset should contain a secure token.  To generate these tokens, I'm going to use <a href="https://jwt.io/">JSON Web Tokens</a> , which also has a popular Python package: </p><br><pre> <code class="hljs sql">(venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> pyjwt</code> </pre> <br><p>  The Flask-Mail extension is configured from the <code>app.config</code> object.  Remember when in <a href="https://habrahabr.ru/post/346880/">Chapter 7</a> I added an email configuration to send email every time an error occurred in production?  Then I did not tell you about it, but my choice of configuration variables was modeled after Flask-Mail requirements, so there is no need for any additional work, the configuration variables are already in the application. </p><br><p>  As with most Flask extensions, you need to create an instance immediately after creating the Flask application.  In this case, it is an object of the <code>Mail</code> class: </p><br><pre> <code class="hljs swift"># ... from flask_mail <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mail app = Flask(__name__) # ... mail = Mail(app)</code> </pre> <br><blockquote>  <em>Note</em>  <em>translator:</em> It is very important that the string <code>mail = Mail(app)</code> located after <code>app.config.from_object(Config)</code> . </blockquote><p>  In order to test sending emails, you have the same two options that I mentioned in <a href="https://habrahabr.ru/post/346880/">Chapter 7</a> .  If you want to use an emulated mail server, then Python provides an option to run in the second terminal with the following command: </p><br><pre> <code class="hljs swift">(venv) $ python -m smtpd -n -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-type"><span class="hljs-type">DebuggingServer</span></span> localhost:<span class="hljs-number"><span class="hljs-number">8025</span></span></code> </pre> <br><p>  To configure this server, you need to set two environment variables: </p><br><pre> <code class="hljs objectivec">(venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_SERVER=localhost (venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_PORT=<span class="hljs-number"><span class="hljs-number">8025</span></span></code> </pre> <br><p>  If you prefer to send emails "adult", you need to use a real mail server.  If you have one, you just need to set the environment variables <code>MAIL_SERVER</code> , <code>MAIL_PORT</code> , <code>MAIL_USE_TLS</code> , <code>MAIL_USERNAME</code> and <code>MAIL_PASSWORD</code> .  For particularly lazy, I remind you how to use your <em>Gmail account</em> to send email with the following settings: </p><br><pre> <code class="hljs objectivec">(venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_SERVER=smtp.googlemail.com (venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_PORT=<span class="hljs-number"><span class="hljs-number">587</span></span> (venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_USE_TLS=<span class="hljs-number"><span class="hljs-number">1</span></span> (venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_USERNAME=&lt;your-gmail-username&gt; (venv) $ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> MAIL_PASSWORD=&lt;your-gmail-password&gt;</code> </pre> <br><p>  If you are using <em>Microsoft Windows</em> , you need to replace the <code>export</code> with the <code>set</code> in each of the above <code>export</code> instructions. </p><br><p>  Remember that the security settings of your Gmail account may prevent an application from sending email through it unless you explicitly allow ‚Äúless secure applications‚Äù access to your Gmail account.  You can read about it <a href="https://support.google.com/accounts/answer/6010255%3Fhl%3Den">here</a> , and if you are concerned about the security of your account, you can create a secondary account that you set up to check emails only, or you can temporarily enable the option to allow ‚Äúless secure applications‚Äù access to run your tests and then go back to a safer default. </p><br><h2 id="ispolzovanie-flask-mail">  Using Flask-Mail </h2><br><p>  To demonstrate how Flask-Mail works, I'll show you how to send an email from the Python shell.  To do this, start Python with the flask shell, and then run the following commands: </p><br><pre> <code class="hljs markdown">&gt;&gt;&gt; from flask_mail import Message &gt;&gt;&gt; from app import mail &gt;&gt;&gt; msg = Message('test subject', sender=app.config[<span class="hljs-string"><span class="hljs-string">'ADMINS'</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>], ... recipients=['your-email@example.com']) &gt;&gt;&gt; msg.body = 'text body' &gt;&gt;&gt; msg.html = '<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>HTML body<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>' &gt;&gt;&gt; mail.send(msg)</code> </pre> <br><p>  The code snippet above will send an email to the list of email addresses you specified in the <code>recipients</code> argument.  As sender (sender) I use the administrator setting (I added a variable in the <code>ADMINS</code> config <code>ADMINS</code> see <a href="https://habrahabr.ru/post/346880/">chapter 7</a> ).  The letter will have plain text in the HTML version, so depending on how your email client is configured, you can see one or the other option. </p><br><p>  In short, it's pretty simple.  Now let's integrate emails into the app. </p><br><h2 id="prostoy-email-framework">  Simple Email Framework </h2><br><p>  Let's start by writing a helper function that sends an email.  In general, it repeats the flask shell exercise from the previous section.  I will put this feature in a new module called <code>app/email.py</code> : </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask_mail <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Message <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mail <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span></span></span><span class="hljs-function">:</span></span> msg = Message(subject, sender=sender, recipients=recipients) msg.body = text_body msg.html = html_body mail.send(msg)</code> </pre> <br><p>  Flask-Mail supports some interesting features that I do not use here.  Such as lists <code>Cc</code> and <code>Bcc</code> .  Be sure to read the <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-x-email-support">Flask-Mail documentation</a> if you are interested in these parameters. </p><br><h2 id="zapros-sbrosa-parolya">  Password reset request </h2><br><p>  Let me remind you that the problem we are solving is to provide the user with the opportunity to reset his password.  For this, I'm going to add a link to the login page: </p><br><pre> <code class="hljs django"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> Forgot Your Password? </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('reset_password_request') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Click to Reset It</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  When the user clicks on the <em>Click to Reset It</em> link, a new web form will appear that requests the user's email address as a way to initiate the password reset process.  Here is the form class: </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResetPasswordRequestForm</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FlaskForm</span></span></span><span class="hljs-class">): email = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">StringField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Email</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validators</span></span></span><span class="hljs-class">=[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRequired</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Email</span></span></span><span class="hljs-class">()]) submit = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SubmitField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Request</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Password</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Reset</span></span></span><span class="hljs-class">')</span></span></code> </pre> <br><p>  And here is the corresponding HTML template: </p><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Reset Password</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">form</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">""</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.hidden_tag() }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.email.label }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.email(size=64) }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> error </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> form.email.errors %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"color: red;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">[</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ error }}</span></span><span class="xml"><span class="xml">]</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.submit() }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">form</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  You also need the view function to handle this form: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.forms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ResetPasswordRequestForm <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.email <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> send_password_reset_email @app.route(<span class="hljs-string"><span class="hljs-string">'/reset_password_request'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) def reset_password_request(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.is_authenticated: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'index'</span></span>)) form = ResetPasswordRequestForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.validate_on_submit(): <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.query.filter_by(email=form.email.data).first() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: send_password_reset_email(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) flash(<span class="hljs-string"><span class="hljs-string">'Check your email for the instructions to reset your password'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'login'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'reset_password_request.html'</span></span>, title=<span class="hljs-string"><span class="hljs-string">'Reset Password'</span></span>, form=form)</code> </pre> <br><p>  This view function looks a lot like the others that process the form.  We start with the fact that the user is not logged in.  If the user is logged in, it makes no sense to use the password reset function, but you should redirect the output to the index page. </p><br><p>  When the form is submitted and valid, I search for the user via the email provided by the user in the form.  If the user is found, send an email with a password reset.  For this, the helper function <code>send_password_reset_email()</code> .  I will show you this feature below. </p><br><p>  After sending the e-mail, I sent a message prompting the user to check the e-mail in his inbox, where he should find the message with instructions and redirection back to the login page.  You may notice that this message is displayed anyway.  This means that customers cannot use this form to find out if this user is registered or not. </p><br><h2 id="tokeny-sbrosa-parolya">  Password reset tokens </h2><br><p>  Before implementing the <code>send_password_reset_email()</code> function, I need to think of a way to create a link to request a password.  This will be the link that will be emailed to the user.  When clicking on the link, the user is presented with a page where a new password can be set.  The hard part of this plan is to make sure that only valid reset links can be used to reset the account password. </p><br><p>  Links will be provided with a token, and this token will be checked before allowing a password change, as proof that the user who requested the email has access to the email address in the account.  A very popular token standard for this type of process is JSON Web Token, or JWT.  The best part of JWT is that they are self-sufficient.  You can email the token to the user, and when the user clicks on the link that returns the token back to the application, you can check it yourself. </p><br><p>  To figure out how JWT works?  Nothing better than to figure out how to experience this in a Python shell session: </p><br><pre> <code class="hljs pgsql">&gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jwt &gt;&gt;&gt; token = jwt.encode({<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-string"><span class="hljs-string">'b'</span></span>}, <span class="hljs-string"><span class="hljs-string">'my-secret'</span></span>, algorithm=<span class="hljs-string"><span class="hljs-string">'HS256'</span></span>) &gt;&gt;&gt; token b<span class="hljs-string"><span class="hljs-string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhIjoiYiJ9.dvOo58OBDHiuSHD4uW88nfJikhYAXc_sfUHq1mDi4G0'</span></span> &gt;&gt;&gt; jwt.decode(token, <span class="hljs-string"><span class="hljs-string">'my-secret'</span></span>, algorithms=[<span class="hljs-string"><span class="hljs-string">'HS256'</span></span>]) {<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-string"><span class="hljs-string">'b'</span></span>}</code> </pre> <br><p>  The dictionary <code>{'a': 'b'}</code> is an example of the payload that will be written to the token.  To make the token secure, you must provide a secret key to use when creating a cryptographic signature.  In this example, I used the string <code>my-secret</code> , but with the application I'm going to use <code>SECRET_KEY</code> from the configuration.  The <code>algorithm</code> argument specifies how the token should be generated.  The most widely used algorithm is the <code>HS256</code> . </p><br><p>  As you can see, the final token is a long sequence of characters.  But do not think that this is an encrypted token.  The contents of the token, including the payload, can be easily decoded by any user (don't believe me? Copy the above token, and then enter it in <a href="https://jwt.io/">the JWT debugger</a> to view its contents).  What makes the token safe is that the payload is signed.  If someone tried to fake or manipulate the payload in the token, then the signature will be invalidated, and a secret key is needed to create a new signature.  When the token is verified, the contents of the payload are decoded and sent back to the caller.  If the token's signature has been confirmed, then the payload can be trusted as authentic. </p><br><p>  The payload that I will use for password reset tokens will be in the format <code>{'reset_password': user_id, 'exp': token_expiration}</code> .  The <code>exp</code> field is standard for JWT, and if it is present, this indicates the time at which the token expires.  If the token has a valid signature, but it has exceeded the expiration time mark, then the signature will be considered invalid.  For the password reset function, I'm going to give these tokens 10 minutes of life. </p><br><p>  When a user clicks on a link in an email received, the token will be sent back to the application as part of the URL, and first of all the browsing function that processes this URL will check it.  If the signature is valid, the user may be identified by an identifier stored in the payload.  Further, as soon as the user identification is verified, the application can request a new password and set it in the user account. </p><br><p>  Since these tokens belong to users, I am going to write token generation and validation functions as methods in the <code>User</code> model: </p><br><pre> <code class="hljs scala">from time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jwt from app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UserMixin</span></span></span></span><span class="hljs-class"><span class="hljs-params">, db.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Model</span></span></span></span></span><span class="hljs-class">)</span></span>: # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_reset_password_token</span></span></span></span>(self, expires_in=<span class="hljs-number"><span class="hljs-number">600</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jwt.encode( {<span class="hljs-symbol"><span class="hljs-symbol">'reset_passwor</span></span>d': self.id, <span class="hljs-symbol"><span class="hljs-symbol">'ex</span></span>p': time() + expires_in}, app.config[<span class="hljs-symbol"><span class="hljs-symbol">'SECRET_KE</span></span>Y'], algorithm=<span class="hljs-symbol"><span class="hljs-symbol">'HS25</span></span>6').decode(<span class="hljs-symbol"><span class="hljs-symbol">'utf</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span>') <span class="hljs-meta"><span class="hljs-meta">@staticmethod</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify_reset_password_token</span></span></span></span>(token): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: id = jwt.decode(token, app.config[<span class="hljs-symbol"><span class="hljs-symbol">'SECRET_KE</span></span>Y'], algorithms=[<span class="hljs-symbol"><span class="hljs-symbol">'HS25</span></span>6'])[<span class="hljs-symbol"><span class="hljs-symbol">'reset_passwor</span></span>d'] except: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">User</span></span>.query.get(id)</code> </pre> <br><p>  The <code>get_reset_password_token()</code> function generates a JWT token as a string.  Note that <code>decode('utf-8')</code> required because the <code>jwt.encode()</code> function returns a token as a sequence of bytes, but in an application it is more convenient to have the token as a string. </p><br><p>  The <code>verify_reset_password_token()</code> check function is a static method, which means that it can be called directly from a class.  A static method is similar to a class method, with the only difference that static methods do not require creating an instance of a class.  If simpler, then there is no first argument self.  This method takes a token and tries to decode it by calling the <code>jwt.decode()</code> function PyJWT.  If the token cannot be verified or expired, an exception will be thrown, in which case I will intercept it to prevent the consequences of the error, and then return <code>None</code> .  If the token is valid, then the <code>reset_password</code> key <code>reset_password</code> from the token payload is the user ID, so I can load the user and return it to the page. </p><br><h2 id="otpravka-elektronnoy-pochty-dlya-sbrosa-parolya">  Sending email to reset your password </h2><br><p>  Now that I have tokens, I can generate emails to reset my password.  The <code>send_password_reset_email()</code> function depends on the <code>send_email()</code> function that I wrote above. </p><br><pre> <code class="hljs markdown">from flask import render<span class="hljs-emphasis"><span class="hljs-emphasis">_template from app import app # ... def send_</span></span>password<span class="hljs-emphasis"><span class="hljs-emphasis">_reset_</span></span>email(user): token = user.get<span class="hljs-emphasis"><span class="hljs-emphasis">_reset_</span></span>password<span class="hljs-emphasis"><span class="hljs-emphasis">_token() send_</span></span>email('[<span class="hljs-string"><span class="hljs-string">Microblog</span></span>] Reset Your Password', sender=app.config[<span class="hljs-string"><span class="hljs-string">'ADMINS'</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>], recipients=[user.email], text<span class="hljs-emphasis"><span class="hljs-emphasis">_body=render_</span></span>template('email/reset<span class="hljs-emphasis"><span class="hljs-emphasis">_password.txt', user=user, token=token), html_</span></span>body=render<span class="hljs-emphasis"><span class="hljs-emphasis">_template('email/reset_</span></span>password.html', user=user, token=token))</code> </pre> <br><p>  An interesting part of this function is that the text and HTML content for emails are generated from templates using the familiar <code>render_template()</code> function.  Templates take a user and a token as arguments, so a personalized email message can be generated.  Here is a text template for resetting the password: </p><br><pre> <code class="hljs 1c">  {{ user.username }},   ?  , <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  . !   ,    : {{ url_for('reset_password', token=token, _external=True) }} <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   ,     .  ,  Microblog</code> </pre> <br><p>  Or like this, decently, in the HTML version of almost the same letter with more decent text: </p><br><pre> <code class="hljs django"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.username }}</span></span><span class="xml"><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">    </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('reset_password', token=token, _external=True) }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">    </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ,         :</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('reset_password', token=token, _external=True) }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">     ,    .</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> Microblog</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  Note that the <code>reset_password</code> route referenced by the <code>url_for()</code> call in these two email templates does not exist yet, it will be added in the next section. </p><br><h2 id="sbros-parolya-polzovatelya">  Reset user password </h2><br><p>  When a user clicks on an email link, the second route associated with this feature will work.  Here is the function of viewing the password request: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.forms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ResetPasswordForm @app.route(<span class="hljs-string"><span class="hljs-string">'/reset_password/&lt;token&gt;'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) def reset_password(token): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.is_authenticated: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'index'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.verify_reset_password_token(token) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'index'</span></span>)) form = ResetPasswordForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.validate_on_submit(): <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.set_password(form.<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>.data) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() flash(<span class="hljs-string"><span class="hljs-string">'Your password has been reset.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'login'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'reset_password.html'</span></span>, form=form)</code> </pre> <br><p>  In this view function, I first make sure that the user is not logged in, and then I determine who the user is by calling the token verification method in the <code>User</code> class.  This method returns the user if the token is valid, or <code>None</code> if not.  If the token is not valid, I am redirected to the <em>index</em> home page. </p><br><p>  If the token is valid, then I submit to the user a second form in which a new password is requested.  This form is processed in the same way as the previous forms, and as a result of successfully submitting the form, I call the <code>set_password()</code> method <code>set_password()</code> to change the password and then redirect to the login page where the user can now log in. </p><br><p>  Here is the <code>ResetPasswordForm</code> class: </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResetPasswordForm</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FlaskForm</span></span></span><span class="hljs-class">): password = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PasswordField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Password</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validators</span></span></span><span class="hljs-class">=[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRequired</span></span></span><span class="hljs-class">()]) password2 = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PasswordField</span></span></span><span class="hljs-class">( '</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Repeat</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Password</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validators</span></span></span><span class="hljs-class">=[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRequired</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EqualTo</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password'</span></span></span><span class="hljs-class">)]) submit = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SubmitField</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Request</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Password</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Reset</span></span></span><span class="hljs-class">')</span></span></code> </pre> <br><p>  And this is the corresponding HTML template: </p><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Reset Your Password</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">form</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">""</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.hidden_tag() }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.password.label }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.password(size=32) }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> error </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> form.password.errors %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"color: red;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">[</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ error }}</span></span><span class="xml"><span class="xml">]</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.password2.label }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.password2(size=32) }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> error </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> form.password2.errors %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"color: red;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">[</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ error }}</span></span><span class="xml"><span class="xml">]</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form.submit() }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">form</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  Now the password reset function is complete.  Give it a try. </p><br><h2 id="asinhronnye-soobscheniya">  Asynchronous messages </h2><br><p>  If you are using a simulated email server that Python provides, you may not have noticed, but sending email slows down the application significantly.  All interactions that must occur when sending email make the task slow, it usually takes a few seconds to receive the email, and perhaps more if the addressee‚Äôs email server is slow or if there are several recipients. </p><br><p>  I would like the <code>send_email()</code> function to be asynchronous.  What does it mean?  This means that when you call this function, the email sending task is scheduled in the background, freeing <code>send_email()</code> to return immediately, so that the application can continue to work simultaneously with the email being sent. </p><br><p>  Python has support for running asynchronous tasks, in fact in more than one way.  <code>threading</code> and <code>multiprocessing</code> modules can be executed.  Starting a background thread for a sent message is much less resource-intensive than starting a completely new process, so I'm going to go that way: </p><br><pre> <code class="hljs scala">from threading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Thread</span></span> # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_async_email</span></span></span></span>(app, msg): <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> app.app_context(): mail.send(msg) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_email</span></span></span></span>(subject, sender, recipients, text_body, html_body): msg = <span class="hljs-type"><span class="hljs-type">Message</span></span>(subject, sender=sender, recipients=recipients) msg.body = text_body msg.html = html_body <span class="hljs-type"><span class="hljs-type">Thread</span></span>(target=send_async_email, args=(app, msg)).start()</code> </pre> <br><p>  The <code>send_async_email</code> function now works in a background thread, because it is called via the <code>Thread()</code> class in the last line of <code>send_email()</code> .  Sending by e-mail will now be performed in a separate thread, and when the process is completed, the flow is completed and cleared.  If you set up and use a real mail server, you will definitely notice an improvement in speed when you click the ‚ÄúSend‚Äù button in the password reset request form. </p><br><p>  You probably expected that only the <code>msg</code> argument would be sent to the stream, but as you can see in the code, I also send an instance of the <code>app</code> .  When working with streams, there is an important aspect of Flask design that needs to be kept in mind.  Flask uses <em>contexts</em> to avoid having to pass arguments through functions.  I am not going to dwell on this in detail, but I know that there are two types of contexts, the <em>application context</em> and the <em>request context</em> ( <em>application context</em> and <em>request context</em> ).  In most cases, these contexts are automatically managed by the infrastructure, but when the application starts user threads, the contexts for these threads may require manual input. </p><br><p>  There are many extensions that require the application context to work, because it allows them to find an instance of the Flask application without passing it as an argument.  The reason many extensions need to know the application instance is that they have the configuration stored in the <code>app.config</code> object.  This is exactly the situation with Flask-Mail.  The <code>mail.send()</code> method must access the configuration values ‚Äã‚Äãfor the mail server, and this can be done only by knowing what an app is.  An application context created with a call <code>with app.app_context()</code> makes an instance of the application accessible via the <code>current_app</code> variable from Flask. </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/347926/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348566/">https://habr.com/ru/post/348566/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348554/index.html">Welcome to Cradle: Rave. And no, this is not a disco</a></li>
<li><a href="../348558/index.html">The fundamental HTML vulnerability when embedding scripts</a></li>
<li><a href="../348560/index.html">Relationship functionality</a></li>
<li><a href="../348562/index.html">BI & Blockchain is a collective intelligence based solution. Part 2</a></li>
<li><a href="../348564/index.html">We write scalable and supported servers on Node.js and TypeScript</a></li>
<li><a href="../348570/index.html">7 Free Data Science Courses for Beginners</a></li>
<li><a href="../348572/index.html">Security week 3: a thief from a bitcoin thief stole, your trojan could be here, ten days without computers</a></li>
<li><a href="../348574/index.html">From regular office to fully distant work: how we built an effective corporate culture</a></li>
<li><a href="../348578/index.html">Serverless application with AWS and Bitbucket Pipelines CI / CD implementation</a></li>
<li><a href="../348582/index.html">Some interesting data drawn from the ‚ÄúMy Circle‚Äù autocompletion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>