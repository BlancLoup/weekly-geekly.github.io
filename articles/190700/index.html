<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>YAMD: another bike to describe modules in JS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I began to write a lot on JS, now I am working on a complex application and a rather large library (~ 5K SLoC). Of course, I ran into the pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>YAMD: another bike to describe modules in JS</h1><div class="post__text post__text-html js-mediator-article">  Recently, I began to write a lot on JS, now I am working on a complex application and a rather large library (~ 5K SLoC).  Of course, I ran into the problem of modularity. <br><br>  <a href="http://requirejs.org/">AMD was</a> perfect for the application - you specify in the library dependencies, add the linking code, logic ... and the application is ready.  But when developing the library, I ran into the problem of managing internal dependencies with AMD or <a href="http://en.wikipedia.org/wiki/CommonJS">CommonJS</a> ‚Äî there are <u>too many</u> connections (boilerplate), especially when <u>parts of the library are interdependent</u> .  Therefore, I have highlighted another approach to the definition of modules in JS - <a href="https://github.com/rystsov/yamd">YAMD</a> . <br><br>  <i>Attention!</i>  <i>This is not a replacement for AMD or CommonJS, I still use AMD to build the application, just one of the libraries that I connect is compiled using YAMD.</i>  <i>Thus, YAMD is an approach to decomposing a complex library without external dependencies into parts and separate files, and a tool for assembling these files together.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the article I will describe the approach.  You want to know from the comments that you use for the same tasks. <a name="habracut"></a><br><br><h3>  Yamd </h3><br>  Another approach to define modules for javascript.  Unlike CommonJS and AMD: <br><ul><li>  allows to write less bindings (boilerplate code) </li><li>  well supports mutually recursive modules </li><li>  repeats (as far as possible) the modularity of Java / C # </li><li>  created to create libraries, not application layouts </li></ul><br>  YAMD is an approach to building a library through decomposing its functionality into separate files and then assembling these files together.  The output file can be designed as IIFE, introducing one name (library name) into the global scope, as a CommonJS or AMD wrapper. <br><br>  I adhered to the principle that using YAMD in library development should not impose restrictions or obligations on the library user. <br><br>  Applying YAMD makes sense when: <br><ul><li>  you create a relatively complex library </li><li>  the library has no external dependencies </li></ul><br>  It is easier for me to understand something when an analogy is made with what I already know, so the description of YAMD will be given through a cross-comparison with AMD and CommonJS. <br><br><h3>  Comparing YAMD, AMD and CommonJS </h3><br>  Let's compare on a simple example YAMD, AMD and CommonJS.  Imagine that we are writing a math library. <br><br>  Select the library functions into separate files, so the source directory for all approaches will be the same: <br><pre><code class="bash hljs">&gt; find . ./math ./math/multiply.js ./math/add.js</code> </pre> <br>  Let's look at the source: <br><table><tbody><tr><td>  AMD </td><td>  Commonjs </td><td>  Yamd </td></tr><tr><td colspan="3">  ./math/add.js <br></td></tr><tr><td><pre> <code class="javascript hljs">define([], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }; });</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = add;</code> </pre> </td><td><pre> <code class="javascript hljs">expose(add); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> </td></tr><tr><td colspan="3">  ./math/multiply.js <br></td></tr><tr><td><pre> <code class="javascript hljs">define( [<span class="hljs-string"><span class="hljs-string">"math/adding"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adding</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;a;i++) { result = adding(result, b); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; });</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> add = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./add'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;a;i++) { result = add(result, b); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = multiply;</code> </pre> </td><td><pre> <code class="javascript hljs">expose(multiply); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;a;i++) { result = root.add(result, b); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> </td></tr><tr><td colspan="3">  USAGE (assuming all dependencies are included) <br></td></tr><tr><td><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( [<span class="hljs-string"><span class="hljs-string">"math/add"</span></span>, <span class="hljs-string"><span class="hljs-string">"math/multiply"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">add, multiply</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(add(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(multiply(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>)); });</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> multiply = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"./math/multiply"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> add = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"./math/add"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(add(<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(multiply(<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>));</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(math.add(<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(math.multiply(<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>));</code> </pre> </td></tr></tbody></table><br>  The AMD approach turned out quite verbose, CommonJS reduces the number of straps due to the implicit wrapping of each file in the function, and YAMD takes another step forward by entering the root of the root library through which you can access any part of it without explicit import. <br><br><h3>  Work with YAMD </h3><br>  To build a YAMD-style library, you need to run <code>python yamd.py path/to/library</code> - as a result, the file <code>nameOfTheLibrary.js</code> will appear in the current directory.  The name of the library is specified by the name of the source directory, in addition, this name is used to add the library to the global scope (unless, of course, the assembly is specified in the CommonJS or AMD module). <br><br>  The directory name, as well as the names of all subdirectories and js-files (up to ".js") should be valid in terms of restrictions for variable names in JS. <br><br>  The directory hierarchy defines the hierarchy of modules, and js-files fill these modules with functions (constructors) - something is obtained like packages and classes in Java or namespaces and classes in C #. <br><br>  To add a function to a module, you need to create a js file in the directory corresponding to this module (the file name before .js specifies the name of the function), define a function with any name, for example, <code>add</code> , and call `expose` before it a function, for example, `expose (add);`.  All other file content will be private and only the exported function will be visible. <br><br>  It may seem strange that the function is used before the declaration - <code>expose(add);</code>  , but this is not YAMD magic, but legal behavior for JS is <a href="http://www.adequatelygood.com/JavaScript-Scoping-and-Hoisting.html">hoisting</a> .  But nevertheless, there is a requirement for <code>expose</code> go at the beginning of the file, to occur only once, and before it was called, there was not a single call to <code>root</code> . <br><br>  The previous example (mathematical library) after assembly will be approximately equivalent to the following code: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> math = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> root = { <span class="hljs-attr"><span class="hljs-attr">add</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }, <span class="hljs-attr"><span class="hljs-attr">multiply</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;a;i++) { result = root.add(result, b); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> root; })();</code> </pre> <br>  Suppose we decided to complicate our library and add distributions from theorove to it.  It is logical to place them in a separate module (directory), after the changes, the source directory looks like this: <br><pre> <code class="bash hljs">&gt; find . ./math ./math/multiply.js ./math/add.js ./math/distributions ./math/distributions/normal.js ./math/distributions/bernoulli.js</code> </pre> <br>  Then after the assembly, we get about the following code <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> math = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> root = { <span class="hljs-attr"><span class="hljs-attr">add</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }, <span class="hljs-attr"><span class="hljs-attr">multiply</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;a;i++) { result = root.add(result, b); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }, <span class="hljs-attr"><span class="hljs-attr">distributions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">normal</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"TODO"</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">bernoulli</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"TODO"</span></span>); } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> root; })();</code> </pre> <br>  Returning to `expose`, in addition to the function, it can of course export lines, numbers or objects to the module.  It turns out that we can rewrite the previous example by placing all distributions in one file in the root of the library, rather than creating a separate directory: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// FILE ./math/distributions.js expose({normal: normal, bernoulli: bernoulli}); function normal() { throw new Error("TODO"); } function bernoulli() { throw new Error("TODO"); }</span></span></code> </pre> <br>  After assembling the library will be fully equivalent. <br><br><h3>  Mutually Recursive Modules </h3><br>  In YAMD, it is possible to add to the module a function that uses the function of another module, and that of the first.  However, in the case of CommonJS and AMD this is also possible, the difference is only in the amount of code.  For example, let's write a function that calculates the number of steps in <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B8%25D0%25BF%25D0%25BE%25D1%2582%25D0%25B5%25D0%25B7%25D0%25B0_%25D0%259A%25D0%25BE%25D0%25BB%25D0%25BB%25D0%25B0%25D1%2582%25D1%2586%25D0%25B0">the Collatz process</a> .  As in the first example, the directory structure will not change in the case of AMD, CommonJS and YAMD: <br><pre> <code class="bash hljs">&gt; find math/collatz math/collatz math/collatz/steps.js math/collatz/inc.js math/collatz/dec.js</code> </pre> <br>  And now the code: <br><table><tbody><tr><td>  AMD </td><td>  Commonjs </td><td>  Yamd </td></tr><tr><td colspan="3">  ./math/collatz/steps.js <br></td></tr><tr><td><pre> <code class="javascript hljs">define( [<span class="hljs-string"><span class="hljs-string">"require"</span></span>, <span class="hljs-string"><span class="hljs-string">"math/collatz/inc"</span></span>, <span class="hljs-string"><span class="hljs-string">"math/collatz/dec"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require, inc, dec</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"math/collatz/dec"</span></span>)(n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"math/collatz/inc"</span></span>)(n); }; });</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">steps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./dec'</span></span>)(n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./inc'</span></span>)(n); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = steps;</code> </pre> </td><td><pre> <code class="javascript hljs">expose(steps); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">steps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n==<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> root.collatz.dec(n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> root.collatz.inc(n); }</code> </pre> </td></tr><tr><td colspan="3">  ./math/collatz/inc.js <br></td></tr><tr><td><pre> <code class="javascript hljs">define( [<span class="hljs-string"><span class="hljs-string">"require"</span></span>, <span class="hljs-string"><span class="hljs-string">"math/collatz/steps"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require, steps</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"math/collatz/steps"</span></span>)(<span class="hljs-number"><span class="hljs-number">3</span></span>*n+<span class="hljs-number"><span class="hljs-number">1</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>; }; });</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./steps'</span></span>)(<span class="hljs-number"><span class="hljs-number">3</span></span>*n+<span class="hljs-number"><span class="hljs-number">1</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = inc;</code> </pre> </td><td><pre> <code class="javascript hljs">expose(inc) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> root.collatz.steps(<span class="hljs-number"><span class="hljs-number">3</span></span>*n+<span class="hljs-number"><span class="hljs-number">1</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> </td></tr><tr><td colspan="3">  ./math/collatz/dec.js <br></td></tr><tr><td><pre> <code class="javascript hljs">define( [<span class="hljs-string"><span class="hljs-string">"require"</span></span>, <span class="hljs-string"><span class="hljs-string">"math/collatz/steps"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require, steps</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"math/collatz/steps"</span></span>)(n/<span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>; }; });</code> </pre> </td><td><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./steps'</span></span>)(n/<span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = dec;</code> </pre> </td><td><pre> <code class="javascript hljs">expose(dec) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> root.collatz.steps(n/<span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> </td></tr></tbody></table><br>  Mutual dependencies in the case of AMD were described according to <a href="http://requirejs.org/docs/api.html">this document</a> - we had to add a dependency on require and use it to explicitly import dependencies inside functions. <br><br>  All three approaches coped with this example, but it is relatively simple - the recursive nature crawls out only when the user calls the library functions, and by that time the library is already loaded.  The problem with mutual recursion occurs when the library itself needs to use the functions of the library itself.  This problem is well dealt with in Tom's <a href="https://groups.google.com/forum/">message</a> . <br><br>  To combat it, a deferred initialization was added to <code>expose</code> : in the <code>expose</code> second argument can be passed to the function (module constructor), for which it is guaranteed that it will be called after all the modules are loaded. <br><br>  Let's return to our example, let's say we decided to speed up the work of <code>steps</code> and for some <code>n</code> calculate the number of steps when loading the library.  Suppose we have defined a <code>tableLookup</code> decorator. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableLookup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">table, f</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> table) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> table[n]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f(n); } }</code> </pre> <br>  Then we just need to change the steps.js file in the YAMD approach as follows: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// FILE ./math/collatz/steps.js var table = {}; expose(tableLookup(table, steps), ctor); function ctor() { table[3] = steps(3); } function steps(n) { if (n==1) return 0; if (n%2==0) return root.collatz.dec(n); if (n%2==1) return root.collatz.inc(n); }</span></span></code> </pre> <br>  When using CommonJS / AMD, we have two ways to implement the same thing: <br><ul><li>  add an explicit initialization method to the library </li><li>  defer initialization of the table until the first call </li></ul><br>  It turns out badly - in CommonJS to solve this problem we must either change the API, or break the single responsibility principle and add laziness control to the steps: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// FILE ./math/collatz/steps.js var table = {}; var inited = false; function ctor() { table[3] = steps(3); } function steps(n) { if (!inited) { ctor(); inited = true } if (n==1) return 0; if (n%2==0) return require('./dec')(n); if (n%2==1) return require('./inc')(n); } module.exports = tableLookup(table, steps)</span></span></code> </pre> <br>  If you turn a blind eye to SRP violation in CommonJS and consider heavy initialization processes, then both options are bad with brakes, in the case of YAMD, brakes when the library is connected, and in the case of CommonJS, brakes when you first call <code>steps</code> .  But initialization is not always difficult, and if it is still the same, then using YAMD you can try to bring it into the WebWorker processes launched from the ctor and hope that by the first launch of `steps` it will be over.  We cannot use CommonJS either, since we only get the chance to start initialization at the first request, therefore this request will not have time to be predicted and is guaranteed to slow down. <br><br>  Thanks for attention.  And do not forget to write in the comments how you develop complex JS libraries. </div><p>Source: <a href="https://habr.com/ru/post/190700/">https://habr.com/ru/post/190700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190680/index.html">Airi - the cloud for the site</a></li>
<li><a href="../190682/index.html">Deobfuscation of one malicious code</a></li>
<li><a href="../190690/index.html">Checklist for overcoming the CAP-theorem</a></li>
<li><a href="../190692/index.html">Microsoft integrates Skype with Outlook.com</a></li>
<li><a href="../190694/index.html">Ways to present dictionaries for automatic text processing</a></li>
<li><a href="../190706/index.html">HTC Desire 600 dual sim - double bet</a></li>
<li><a href="../190708/index.html">FlexPod Express (aka ExpressPod)</a></li>
<li><a href="../190710/index.html">Android stores unencrypted Wi-Fi passwords on Google servers.</a></li>
<li><a href="../190712/index.html">Protection of IT solutions in Russia</a></li>
<li><a href="../190714/index.html">Using your own MS Windows Server licenses in the cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>