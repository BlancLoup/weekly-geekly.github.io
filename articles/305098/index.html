<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web authorization of the domain user through nginx and HTTP Negotiate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day there was a task - to provide transparent authorization of domain users in CRM, Microsoft itself had long ago developed the Negotiate HT...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web authorization of the domain user through nginx and HTTP Negotiate</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/files/0da/6ba/c19/0da6bac19cb74a0da571b2fdc2a763f5.png">  The other day there was a task - to provide transparent authorization of domain users in CRM, Microsoft itself had long ago developed the Negotiate HTTP authentication method for this purpose, it all works fine on IIS and Windows Server, and we have Samba4 as Primary Domain Controller and proxy web server nginx.  How to be? <br><br>  The network has a lot of information on the organization of such a scheme for Apache2 &amp; AD based on Windows, but nginx users have to collect everything bit by bit, the cat cried out.  In the basic delivery of Nginx there is no such functionality.  Fortunately, people didn‚Äôt lose heart and the story began in the <a href="http://mailman.nginx.org/pipermail/nginx/2009-April/011829.html">nginx mailings in 2009</a> , where one American friend from Ohio hired a developer on RentACoder to download a module with similar functionality.  The guys forked a similar module for Apache, screwed it to nginx and posted the results of the work on github, where the module was occasionally doped by different people and eventually took on a robotic look.  The latest version <a href="http-auth-nginx-module">is available on github</a> . <br><br><hr>  In this tutorial, I‚Äôll show you how to make nginx work with the SPNEGO module and samba4. <br><hr><a name="habracut"></a><br>  The first thing you need is to build nginx with the module we need.  Ubuntu 16.04 will be used as an example. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For a start we put nginx <br><pre><code class="bash hljs">apt-get install nginx -V</code> </pre> <br>  Next, download the latest version of the <a href="http://nginx.org/en/download.html">source code</a> from the official site. <br><pre> <code class="bash hljs">wget http://nginx.org/download/nginx-1.11.2.tar.gz</code> </pre><br>  Ok, unzip the source folder and put our spnego-http-auth-nginx-module in it <br><pre> <code class="bash hljs">tar xvzf nginx-1.11.2.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.11.2 git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/stnoonan/spnego-http-auth-nginx-module</code> </pre><br>  We look with what options we have now assembled nginx from the basic delivery and get a footwoman <br><pre> <code class="bash hljs">root@dc1:~<span class="hljs-comment"><span class="hljs-comment"># nginx -V nginx version: nginx/1.11.1 built by gcc 5.3.1 20160413 (Ubuntu 5.3.1-14ubuntu2.1) built with OpenSSL 1.0.2g-fips 1 Mar 2016 TLS SNI support enabled configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_perl_module=dynamic --with-threads --with-stream --with-stream_ssl_module --with-http_slice_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-debug --with-cc-opt='-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,--as-needed'</span></span></code> </pre><br>  We copy a footwoman in a notebook and add it somewhere <br><pre> <code class="bash hljs">--add-module=spnego-http-auth-nginx-module</code> </pre><br>  We start the assembly with the necessary parameters <br><pre> <code class="bash hljs">./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_perl_module=dynamic --with-threads --with-stream --with-stream_ssl_module --add-module=spnego-http-auth-nginx-module --with-http_slice_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-debug --with-cc-opt=<span class="hljs-string"><span class="hljs-string">'-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2'</span></span> --with-ld-opt=<span class="hljs-string"><span class="hljs-string">'-Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,--as-needed'</span></span></code> </pre><br>  Naturally, utilities for building should be installed on the system, and nginx should be extinguished. <br><pre> <code class="bash hljs">make make install</code> </pre><br>  After the procedure, we now end up with a working self-assembled nginx with the module we need.  You can also check this - nginx -V and see the presence of the module in the parameters. <br><br><hr>  For example, use the url for authorization test.intranet.com, domain intranet.com <br><hr><br>  It's time to work a bit with samba, add a user to whom we hang the service principal name (spn) for authorization via Kerberos <br><pre> <code class="bash hljs">samba-tool user add HTTP samba-tool user setexpiry HTTP --noexpiry samba-tool spn add HTTP/test.intranet.com HTTP samba-tool spn add host/test.intranet.com HTTP</code> </pre><br>  Create a Kerberos keytab file for nginx <br><pre> <code class="bash hljs">samba-tool domain exportkeytab /etc/http.keytab --principal=HTTP/test.intranet.com samba-tool domain exportkeytab /etc/http.keytab --principal=host/test.intranet.com</code> </pre><br>  Check the generated keytab <br><pre> <code class="bash hljs">klist -ke /etc/http.keytab Keytab name: FILE:/etc/http.keytab KVNO Principal ---- -------------------------------------------------------------------------- 1 host/test.intranet.com@INTRANET.COM (des-cbc-crc) 1 host/test.intranet.com@INTRANET.COM (des-cbc-md5) 1 host/test.intranet.com@INTRANET.COM (arcfour-hmac) 1 HTTP/test.intranet.com@INTRANET.COM (des-cbc-crc) 1 HTTP/test.intranet.com@INTRANET.COM (des-cbc-md5) 1 HTTP/test.intranet.com@INTRANET.COM (arcfour-hmac)</code> </pre><br>  Log in to the domain controller via kerberos <br><pre> <code class="bash hljs">kinit administrator Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> administrator@INTRANET.COM: Warning: Your password will expire <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 39 days on  30  2016 11:23:11</code> </pre><br>  We check domain authorization by spn using the keytab file: <br><pre> <code class="bash hljs">kinit -V -k -t /etc/http.keytab HTTP/test.intranet.com@INTRANET.COM Using default cache: /tmp/krb5cc_0 Using principal: HTTP/test.intranet.com@INTRANET.COM Using keytab: /etc/http.keytab Authenticated to Kerberos v5</code> </pre><br>  I had a problem at this stage, the authentication did not want to go through.  Mistake: <br><blockquote>  kinit: Client not found in Kerberos database while getting initial credentials </blockquote><img align="right" src="https://habrastorage.org/files/6b9/896/1dc/6b98961dc453469ca2edba3b0c577949.png">  I rummaged through the Internet, in the end there was a solution, it turned out that samba-tool does not work out the way Microsoft intended it, unexpectedly, right? <br>  To solve the problem, go to the Windows machine and use the administrative console ‚ÄúActive Directory Users and Computers‚Äù to rule our HTTP user, namely, we edit the user login field on HTTP / test.intranet.com <br>  After this procedure, everything works. <br><br>  It's time to go to the nginx configuration, look at my virtual host config <br><pre> <code class="bash hljs"> server { listen *:443 ssl; server_name test.intranet.com; <span class="hljs-comment"><span class="hljs-comment"># error_log /var/log/nginx/debug.log debug; ssl_certificate /etc/nginx/ssl/nginx.crt; ssl_certificate_key /etc/nginx/ssl/nginx.key; location / { proxy_pass http://********/$request_uri; proxy_set_header X-Real-IP $remote_addr; proxy_set_header Host $http_host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; auth_gss on; auth_gss_realm INTRANET.COM; auth_gss_keytab /etc/http.keytab; auth_gss_service_name HTTP/test.intranet.com; # auth_gss_allow_basic_fallback off; } }</span></span></code> </pre><br><br>  Parameter auth_gss_allow_basic_fallback off;  allows you to turn off the request for basic authorization if something went wrong, let's say the user is not in the domain. <br><br><hr>  For a transparent authorization to work, certain conditions must be met: <br><ul><li>  Client machine is in a Windows 2003 or higher domain level </li><li>  User logged into the domain </li><li>  Access to the host is via HTTPS (according to my tests it works with http) </li><li>  Host is in Intranet security zone in IE </li><li>  Host name is in DNS under A record </li><li>  The host name lies in the domain zone (for example, xxxx.intranet.com) </li><li>  You have correctly created the Service Principal Names (SPNs) in Active Directory, and also zamapili on the service account (in our case HTTP) </li></ul><hr><br>  It remains to be on the machine to bring our URL - test.intranet.com into the Intranet security zone in IE and try to access our link.  If everything is configured correctly, then nginx should transparently skip the user to the site.  On the server side, where we actually proxy the connection, the following information can be found in the packet headers. <br><blockquote>  [PHP_AUTH_USER] =&gt; Administrator [PHP_AUTH_PW] =&gt; bogus_auth_gss_passwd </blockquote>  It remains to finish the web application for transparent authentication a little, but that‚Äôs already a web programmer‚Äôs ... <br><br>  In other browsers, this mechanism also works with minor modifications. <br><ul><li>  In Firefox, we enter "about: config" looking for parameters with "negotiate" <br>  Add our site to the parameter "network.negotiate-auth.trusted-uris" for example <pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"http://test.intranet.com"</span></span></code> </pre>  The "network.negotiate-auth.using-native-gsslib" parameter must be true. </li><li>  For Chrome to work, you need to run it with the parameter: <br><pre> <code class="bash hljs">google-chrome --auth-server-whitelist=<span class="hljs-string"><span class="hljs-string">"http://test.intranet.com"</span></span> --auth-negotiate-delegate-whitelist=<span class="hljs-string"><span class="hljs-string">"http://test.intranet.com"</span></span></code> </pre></li></ul><br><br>  Actually, this is the whole setup process, I killed a couple of days for it, I decided to share it with the public.  This mechanism allows you to save users in the office from entering a login \ password when accessing an internal web application. </div><p>Source: <a href="https://habr.com/ru/post/305098/">https://habr.com/ru/post/305098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305058/index.html">Experience finding a job and moving to Dubai</a></li>
<li><a href="../305072/index.html">How do universities teach future security guards?</a></li>
<li><a href="../305074/index.html">Redux-Redents is (yet) one module for working with server data from React-Redux applications.</a></li>
<li><a href="../305076/index.html">How big data changes the media advertising market</a></li>
<li><a href="../305096/index.html">To the birthday of the Dalai Lama</a></li>
<li><a href="../305108/index.html">CodingFuture + Puppet. Part V: Databases (cfdb)</a></li>
<li><a href="../305120/index.html">Sailfish OS - Summer School at Innopolis University for mobile developers and Linux enthusiasts</a></li>
<li><a href="../305126/index.html">Is it going Running? Going upstairs? Intel Edison knows the answer.</a></li>
<li><a href="../305128/index.html">Accelerate stencil computing: building and running YASK on Intel processors</a></li>
<li><a href="../305144/index.html">Double speed and half memory: PHP 7 optimization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>