<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google Cloud Messaging - write backend in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As part of the tutorial, we will write a full-fledged class for sending messages to the GCM server, which: 



- receives as input a data array to sen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google Cloud Messaging - write backend in PHP</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/176/56f/784/17656f784103fd14c54558f2124c1bc7.jpg" alt="image">  As part of the tutorial, we will write a full-fledged class for sending messages to the GCM server, which: <br><br><ul><li>  receives as input a data array to send </li><li>  forms packages for sending up to 4096kb each. </li><li>  sends packets in parallel requests. </li><li>  analyzes the answer and knows: <br><ul><li>  whether the message was successfully delivered </li><li>  type of error </li></ul><br></li></ul><br><a name="habracut"></a><br><h4>  Google Cloud Messaging - short and clear </h4><br>  GCM is an instant messaging service.  An alternative to standard polling and long polling, but not exclusive, but complementary to them.  Guarantees that the message will be delivered Google does not give (although the reliability and speed of delivery was just space compared to the ancestor of C2DM).  If the Internet is turned off on the phone, the message will be stored on the GCM server for up to 4 weeks.  Ie if the user turned off the phone, went on vacation, then on arrival he may not receive a message.  Therefore, GCM should only work together with reliable delivery methods such as, for example, elementary polling - sending http requests to the server every N minutes. <br><br>  Any android application can register itself as a recipient of messages from GCM.  When the Internet is turned on, registration occurs in seconds.  As soon as this happened, the application receives from the GCM server RegistrationId, which must be sent to its server.  As a result, in the server database, we have, for example, a Devices table that stores information about devices, including their RegistrationId. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for devices to start receiving messages, the server code must send POST requests to the GCM server in json format (you can send regular keys =&gt; value, but it is json that is recommended).  The server response also contains json, after analyzing which we will be able to understand whether the message was delivered, and if not - what errors occurred. <br><br><h4>  Let's get started </h4><br>  Create two GcmPayload and GcmSender classes. <br><br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GcmPayload</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($regId, $jsons)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $regId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $jsons; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GcmSender</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($payloads)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPackages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isReadyToFlush</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($items, $json)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($response, $info, RollingCurlRequest $request)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br></div></div><br><br>  In terminology, GCM payload is the data you want to send to the recipient.  This data must be stored in the data key and have a limit of 4096 bytes.  <a href="http://developer.android.com/google/gcm/gcm.html">More about the format of the request</a> . <br><br>  GcmPayload is a data model for one recipient and, accordingly, one RegistrationId.  The $ jsons field must be initialized with an array of json's in the form of strings containing the data that needs to be sent to this recipient.  To simplify the tutorial, we assume that this is done outside our class, for example, like this: <br><br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="php hljs">$recipients = $messagesRepository-&gt;getRecipientsWithNewMessages(); $payloads = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($recipients <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $recipient) { $jsons = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($recipient-&gt;messages <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $message) { $jsons[] = json_encode($message); } $payloads[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GcmPayload($recipient[<span class="hljs-string"><span class="hljs-string">'regId'</span></span>], $jsons); } $gcm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GcmSender(); $gcm-&gt;send($payloads);</code> </pre><br></div></div><br><br><h4>  GcmSender </h4><br><h5>  Constants and class members </h5><br>  const GCM_API_KEY = 'your api key';  // Need to get on the Google APIs Console page <br>  const CURL_TIMEOUT = 10;  // Connection timeout in Google server in seconds <br>  const GCM_MAX_DATA_SIZE = 4096;  // Limit on the sent data in bytes <br>  const GCM_SERVER_URL = 'https://android.googleapis.com/gcm/send';  // GCM server address <br>  const GCM_MAX_CONNECTIONS = 10;  // number of parallel queries <br><br>  const KEY_REG_IDS = 'registration_ids';  // recipient key in json request <br>  const KEY_DATA = 'data';  // key with data in json request <br>  const KEY_ITEMS = 'items';  // key in the data object containing our data array <br>  const REGID_PLACEHOLDER = '_REGID_';  // placeholder for RegistrationId in json request template <br>  const ITEMS_PLACEHOLDER = '_ITEMS_';  // placeholder for our data array in json request template <br><br>  const GCM_ERROR_NOTR Vector = 'NotRegistered';  // constant for error if user deleted the application <br><br>  protected $ _template;  // json query template <br>  protected $ _baseDataSize;  // initial data size, which includes the items key, parenthesis quotes, etc. <br><h5>  constructor </h5><br>  The constructor creates a query template that will be used in the getPackages method.  Please note that in order not to potentially exceed the limit of 4096 bytes per data, you must also remember and take into account the size of the initial data in the template: {‚Äúitems‚Äù: []} <br><br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $dataObj = <span class="hljs-string"><span class="hljs-string">'{"'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::KEY_ITEMS.<span class="hljs-string"><span class="hljs-string">'": ['</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ITEMS_PLACEHOLDER.<span class="hljs-string"><span class="hljs-string">']}'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_template = <span class="hljs-string"><span class="hljs-string">'{ "'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::KEY_REG_IDS.<span class="hljs-string"><span class="hljs-string">'": ["'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::REGID_PLACEHOLDER.<span class="hljs-string"><span class="hljs-string">'"], "'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::KEY_DATA.<span class="hljs-string"><span class="hljs-string">'": '</span></span>.$dataObj.<span class="hljs-string"><span class="hljs-string">' }'</span></span>; $baseDataJson = str_replace(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ITEMS_PLACEHOLDER, <span class="hljs-string"><span class="hljs-string">''</span></span>, $dataObj); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_baseDataSize = strlen($baseDataJson); }</code> </pre><br></div></div><br><br><h5>  Send method </h5><br>  This public method should be called to directly send data to the GCM server.  The method accepts data for sending, which by the getPackages method will be converted into data packets ‚Äî prepared post data in json format (one packet - one request) and guaranteed not to exceed 4096 bytes.  The rest of the method is the initialization of the wonderful <a href="http://code.google.com/p/rolling-curl/">RollingCurl</a> library, which encapsulates the work with curl_multi_exec and allows you to send requests in parallel and write transparent code.  RollingCurl is initialized by our callback method onResponse, in which we will analyze the result of sending.  Next comes the actual sending data itself. <br><br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> GcmPayload[] $payloads */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($payloads)</span></span></span><span class="hljs-function"> </span></span>{ $packages = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::getPackages($payloads); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$packages || count($packages) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $rc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RollingCurl(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'onResponse'</span></span>)); $headers = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'Authorization: key='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::GCM_API_KEY, <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>); $rc-&gt;__set(<span class="hljs-string"><span class="hljs-string">'headers'</span></span>, $headers); $rc-&gt;options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( CURLOPT_SSL_VERIFYPEER =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   CURLOPT_RETURNTRANSFER =&gt; true, //,        CURLOPT_CONNECTTIMEOUT =&gt; self::CURL_TIMEOUT, //      CURLOPT_TIMEOUT =&gt; self::CURL_TIMEOUT); //     curl foreach ($packages as $package) { $rc-&gt;request(self::GCM_SERVER_URL, 'POST', $package); } $rc-&gt;execute(self::GCM_MAX_CONNECTIONS); }</span></span></code> </pre><br></div></div><br><br><h5>  GetPackages method </h5><br>  In this method, an array of payloads transferred to the class is enumerated and the template created in the constructor is gradually filled until the packet exceeds the limit of 4096 bytes or the data for the recipient does not run out.  By the way, in our example, we consider that one packet is one receiver.  What does it mean?  For example, this convention is valid when a text message is addressed to only one person.  But in group conversations, the same message can be sent to several people, and GCM allows you to specify several RegistrationId values ‚Äã‚Äãin the value of the registration_ids key.  But again, in this example, in order to avoid unnecessary complications, this case is not considered. <br><br>  Let's go back to the getPackages method.  In fact, the interest is isReadyToFlush, which determines whether adding a new json to the package will go beyond the limit of 4096 bytes.  If so, then the package ends immediately and we add this json to the new package. <br><br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> GcmPayload[] $payloads * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPackages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($payloads)</span></span></span><span class="hljs-function"> </span></span>{ $packages = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($payloads <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $payload) { $template = str_replace(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::REGID_PLACEHOLDER, $payload-&gt;regId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_template); $items = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($payload-&gt;jsons <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $json) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isReadyToFlush($items, $json)) { $package = str_replace(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ITEMS_PLACEHOLDER, $items, $template); $packages[] = $package; $items = <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($items) $items .= <span class="hljs-string"><span class="hljs-string">','</span></span>.$json; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $items = $json; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($items) { <span class="hljs-comment"><span class="hljs-comment">//        $package = str_replace(self::ITEMS_PLACEHOLDER, $items, $template); $packages[] = $package; } } return $packages; }</span></span></code> </pre><br></div></div><br><br><h5>  OnResponse method </h5><br>  It is important not only to send a message, but also to understand whether it was delivered, and if not, for what reason.  onResponse is the one with which we initialized RollingCurl in the send method.  Kolbek takes three parameters: <br><ol><li>  $ response - response as a string </li><li>  $ info is the result of the curl_getinfo <a href="http://php.net/manual/en/function.curl-getinfo.php">php.net/manual/en/function.curl-getinfo.php</a> function and returns an array of data transfer data, starting from the http response code and ending with download / download speeds.  But in this tutorial only the http response code is interesting. </li><li>  RollingCurlRequest $ request - information about the request.  We are interested in $ request-&gt; post_data </li></ol><br><br>  Comments in the listing function will be more eloquent: <br><br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $info * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \RollingCurl\RollingCurlRequest $request */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($response, $info, RollingCurlRequest $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       $success = true; // json,     post $post = json_decode($request-&gt;post_data, true); if (json_last_error() != JSON_ERROR_NONE) { // json ,     . return; } // RegistratonId     $regId = $post[self::KEY_REG_IDS][0]; $items = $post[self::KEY_DATA][self::KEY_ITEMS]; //   $code = $info != null &amp;&amp; isset($info['http_code']) ? $info['http_code'] : 0; //  : 2, 3, 4, 5 $codeGroup = (int)($code / 100); if ($codeGroup == 5) { //  5xx,  ,  GCM   ,    //TODO    Retry-After $success = false; } if ($code !== 200) { // http  ,    //           http://developer.android.com/google/gcm/gcm.html#response $success = false; } if (!$response || strlen(trim($response)) == null) { // ,  -   ,     . $success = false; } // ,    http://developer.android.com/google/gcm/gcm.html#success if ($response) { $json = json_decode($response, true); if (json_last_error() != JSON_ERROR_NONE) { //  json ,         $success = false; $json = array(); } } else { $json = array(); $success = false; } // failure     (    ,  failure    0  1) $failure = isset($json['failure']) ? $json['failure'] : null; // canonical_ids   ,     RegistrationId (     failure -   0  1). $canonicalIds = isset($json['canonical_ids']) ? $json['canonical_ids'] : null; //    ,      .   $success=true       if ($failure || $canonicalIds) { //results   .      ,      (     RegistrationId) $results = isset($json['results']) ? $json['results'] : array(); foreach($results as $result) { $newRegId = isset($result['registration_id']) ? $result['registration_id'] : null; $error = isset($result['error']) ? $result['error'] : null; if ($newRegId) { // $regId  $newRegId; //  ,  Update 1 } else if ($error) { if ($error == self::GCM_ERROR_NOTREGISTERED) { // $regId  ; } else { //  ,   //   ,       http://developer.android.com/google/gcm/gcm.html#error_codes } $success = false; } } } //  ,        . }</span></span></code> </pre><br></div></div><br><br>  <b>Update 1</b> <br>  <a href="https://habrahabr.ru/users/jcrow/" class="user_link">jcrow</a> tells in the <a href="http://habrahabr.ru/post/161305/">comments</a> about the <a href="https://habrahabr.ru/users/jcrow/" class="user_link">pitfall</a> , which can wait when updating the RegistrationId.  Situation: the user uninstalled the application and reinstalled =&gt; re-registered and received a new RegistrationId.  Our database already has two entries for the same user.  And one entry with the old RegistrationId, and the other with the new one.  If we send messages to both RegistrationId, then the new RegistrationId will come for the old one.  As a result, we have two entries for the same user with the same RegistrationId. <br><br>  As a result: If a unique index is placed across the RegistrationId field in our database, we get an error.  If there is no index, the application user receives two identical messages each time. <br><br>  Solution: Once we have received a new RegistrationId in onResponse, we need to check for its existence in the database.  And in a positive case, either delete one of the records or merge both records and the data associated with them from other tables. <br><br><h5>  What to do next? </h5><br><br>  For example, you can put a status in your database that the message has been delivered.  But it must be remembered that the successful sending to the GCM server does not mean the actual receipt of the message by the user's smartphone.  Moreover, having remembered the holiday example, it becomes clear that it is impossible to affix the status to onResponse.  Then where?  I have only one option - to put statuses when receiving data by polling.  Unfortunately, in most cases this means that the recipient will receive the same data twice.  At the application level, you can determine whether this data has already been received and, if so, to ignore it.  The main advantage of this approach is reliability, data will always be delivered.  Cons - increased consumption of traffic and batteries. <br><br>  If you have not read the official documentation, I recommend it <a href="http://developer.android.com/guide/google/gcm/index.html">to read</a> . <br><br><h4>  Afterword </h4><br>  I hope this tutorial will not just be for someone a starting point, but also help reduce the time to develop the backend of your android-application. </div><p>Source: <a href="https://habr.com/ru/post/161305/">https://habr.com/ru/post/161305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161285/index.html">Rating Mail.Ru learned to watch Smart TV</a></li>
<li><a href="../161289/index.html">How to work with Openflow controller NOX</a></li>
<li><a href="../161291/index.html">New Year's surprises from ‚ÄúSimple Business‚Äù: get a 30% discount, a free subscription to a business magazine and gifts!</a></li>
<li><a href="../161297/index.html">Vice.com declassified John McAfee‚Äôs location via EXIF ‚Äã‚Äãmetadata</a></li>
<li><a href="../161301/index.html">We forge your signature with the help of a hinge mechanism. Kempe theorem</a></li>
<li><a href="../161307/index.html">If you decide to implement an ERP system</a></li>
<li><a href="../161311/index.html">Autographer</a></li>
<li><a href="../161315/index.html">AWS Insight: How Placement Groups Work</a></li>
<li><a href="../161317/index.html">Backup (RK) of data of IBM SAP HANA by means of IBM Tivoli Storage Manager</a></li>
<li><a href="../161319/index.html">Petersburg students - champions of Russia in programming in 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>