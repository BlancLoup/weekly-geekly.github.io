<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenSCG's HA failover solution ‚ÄúPGHA‚Äù. Master-Slave Solution for PostgreSQL 9.3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Below will be described the experience of setting up a Master-Slave fault-tolerant system using PostgresSQL's own resources, Asynchronous Replication ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenSCG's HA failover solution ‚ÄúPGHA‚Äù. Master-Slave Solution for PostgreSQL 9.3</h1><div class="post__text post__text-html js-mediator-article">  Below will be described the experience of setting up a Master-Slave fault-tolerant system using PostgresSQL's own resources, Asynchronous Replication + pgBouncer + PGHA, in a free translation format with comments from <a href="http://www.rummandba.com/2013/12/pgha-postgresqlpgbouncer-high.html">one post</a> and <a href="https://bitbucket.org/openscg/pgha/src/95ab4749b33dafb36e9632bb509ee6c4deb43b14/doc/%3Fat%3Dmaster">installation</a> guide. <br><br><h5>  pgHA </h5><br>  <a href="http://www.openscg.com/postgresql-ha-automatic-failover/">pgHA</a> is a program written in Perl, the code of which is presented in the file failoverd.pl, which is the basis of the tool.  Uses pgbouncer and PostgresSQL own replication in its work;  monitors the leading database and in case of its inaccessibility opens the auxiliary database for recording, stopping replication.  At least since version 9.3 is installed along with PostgresSQL, you can download it <a href="https://bitbucket.org/openscg/pgha/downloads">here</a> .  The installation process is described in the <a href="https://bitbucket.org/openscg/pgha/src/95ab4749b33dafb36e9632bb509ee6c4deb43b14/doc/%3Fat%3Dmaster">README file</a> , which is in ./9.3/pgha/doc/. <br><br><a name="habracut"></a>  On habrahabr, apparently, the most popular tool for the organization of resiliency is pgpool.  Unfortunately, the existing individual experience does not allow to compare these two tools. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Customization </h5><br>  This system requires three machines: a master server (master), an auxiliary (slave) and a scaling node.  You can do without the latter. <br><br><h6>  1. Configure replication </h6><br>  About setting up native replication has already been written in very many articles, under this pretext I just refer to some: <br><ul><li>  <a href="http://www.rummandba.com/2013/08/postgresql-92-streaming-replication.html">www.rummandba.com/2013/08/postgresql-92-streaming-replication.html</a> </li><li>  <a href="http://habrahabr.ru/post/106872/">habrahabr.ru/post/106872</a> </li><li>  <a href="http://habrahabr.ru/post/188096/">habrahabr.ru/post/188096</a> </li></ul><br><h6>  2. Configure pgBouncer </h6><br>  <a href="http://wiki.postgresql.org/wiki/PgBouncer">pgBouncer</a> is an easy puller, connection manager for PostgreSQL.  It is used as an input access point that redirects requests to the main database or auxiliary depending on the settings file.  Installs with PostgresSQL 9.3. <br><br><ol><li>  You need to start the configuration by creating a bouncer user and a password to it on the server ‚Äî the scaling node, or on any other machine that will monitor the status of the master server. <br><br></li><li>  Next, prepare 2 files pgbouncer.ini.orig and pgbouncer.ini.failover.  These are the pgbouncer configuration files and, in fact, differ only in the IP hosts of the database: the IP file and the port of the master database are specified in the .orig file, and the secondary one in the .failover file.  Examples can be found <a href="https://bitbucket.org/openscg/pgha/src/95ab4749b33d/support/pgBouncer/cfg/%3Fat%3Dmaster">here</a> . <br>  - you need to create an empty log file and specify the path to it <br>  - still need to create a userlist.txt file with users under which requests will be made via pgbouncer and do not forget to specify the path to it (the auth_file field), an example can be found in ./9.3/share/doc/pgbouncer or <a href="https://bitbucket.org/openscg/pgha/src/95ab4749b33d/support/pgBouncer/cfg/%3Fat%3Dmaster">here</a> <br>  - select from created users who will have admin rights in relation to the pgbouncer and specify them in the admin_users field <br>  - you also need to specify the port on which pgbouncer (listen_port) will be located and further, after having familiarized yourself with other filled fields and having made any changes you want, you can refer to pgbouncer as usual DB ... after launch. <br><br></li><li>  Create a pgbouncer.ini file and copy the contents of the pgbouncer.ini.orig file into it.  This is a working file and pgbouncer.ini.orig or pgbouncer.ini.failover files will be copied to it later, depending on the situation.  Create an empty pgbouncer.ini_old file, it will be used by pgha. <br><br></li><li> Run pgbouncer on behalf of bouncer: <br> <code>pgbouncer -d //pgbouncer.ini</code> <br> </li></ol><br><h6>  3. Configure pgHA </h6><br><ol><li>  pgHA uses some Perl modules that need to be pre-installed.  Before that, you need to install CPAN: <br><pre> <code class="bash hljs">yum install perl-CPAN perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install Module::Build::Compat'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install Config::IniFiles'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install DBI'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install DBD::Pg'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install Log::Log4perl'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install Proc::Daemon'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install Net::Ping'</span></span> perl -MCPAN -e <span class="hljs-string"><span class="hljs-string">'install Nagios::Plugin'</span></span></code> </pre> <br>  A harmless error may occur: yaml 'not installed persistent state.  If annoying, you can do: <br><pre> <code class="bash hljs">cpan install Bundle::CPAN reload cpan <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br></li><li>  Next, you should prepare a configuration file for pgHA, examples of which can be found in the folder ./9.3/pgHA/cfg/ or <a href="https://bitbucket.org/openscg/pgha/src/95ab4749b33dafb36e9632bb509ee6c4deb43b14/cfg/%3Fat%3Dmaster">here</a> : the example.conf and scottmVm.conf files, it is better to focus on the second: <br>  - pidFile can lie anywhere, you need to make sure that the selected path is available. <br>  - logConfig is located in ./9.3/pgHA/cfg/log4perl.conf and contains logging settings <br>  - for triggerFile, you need to specify the file specified in the recovery.conf <br>  - the [failover] section is better to remove, just below it will be mentioned about it <br>  - the [app01] section contains the pgbouncer settings, including the commands at the end of the file that, in case the master database fails, delete all connections to it and then restart the pgbouncer to work with the new main database: <br><pre> <code class="hljs vhdl"># Which databases should be part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> failover fence_lock_dbs=postgres # pgBouncer command <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> pause / fence the db<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> fence_lock_command=kill # pgBouncer command <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> reload the config <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> fence_move_command=reload # pgBouncer command <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> unlock the db<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> fence_unlock_command=resume dbcheck=<span class="hljs-string"><span class="hljs-string">"select 1"</span></span></code> </pre> <br>  - in the [app01] section in the pgbouncer_db_user field there should be one of the admin_users specified in pgbouncer.ini <br>  - should be familiar with the other parameters <br><br></li><li>  Then create an empty log file pgHA.log in the / opt / pgHA / log / folder.  This is the path that pgHA uses by default. <br><br></li><li>  On the master server, create the table described in the file ./9.3/pgha/cfg/status_table.sql, or <a href="">here</a> in the database specified in the dbname field in the [master] section. <br><br></li><li>  Generate ssh user key on behalf of which pgHA will be launched and send it to bouncer user: <br>  - <code>ssh-keygen -t rsa</code> (create an empty password) <br>  - copy the contents of ~ / .ssh / id_rsa.pub <br>  - on the machine with the bouncer user, on its behalf, execute the commands: <br> <code>mkdir ~/.ssh</code> <br> <code>chmod 0700 .ssh</code> <br>  <code>vi authorized_keys</code> (paste previously copied contents of id_rsa.pub, close with saving) <br> <code>chmod 0600 .ssh/authorized_keys</code> <br> <br></li><li>  Run pgHA. <br> <code>./failoverd.pl -c //PgHA.conf --auto</code> <br>  The failoverd.pl file is in the ./9.3/pgHA/bin folder. <br><br></li><li>  If step 6 passed without errors, stop pgHA <br> <code>./failoverd.pl -c //PgHA.conf --stop</code> <br>  In this state, the pgHA fails automatically.  You need to open the file failoverd.pl, comment out the line 443 and comment out the 442 according to the code presented <a href="https://bitbucket.org/openscg/pgha/src/95ab4749b33dafb36e9632bb509ee6c4deb43b14/bin/failoverd.pl%3Fat%3Dmaster">here</a> .  It should work: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment"># Start the failoverd monitoring process elsif ( $startWorker ) { print "\n\tInitializing... \n"; . . . # Once we have verified that the system is online, we need # to set the failover 'spring'. $logger-&gt;info("==Startup==: Arming Failover mechanism"); print "\t === Arming Failover mechanism === \n"; if ( SetSpring(%Config,$logger) != 1 ) # if ( 0 ) { $logger-&gt;info("Cannot set failover configuration, exiting..."); print "Cannot set failover configuration, exiting...\n"; exit(1); } . . .</span></span></code> </pre> <br>  Now, if the master database fails, pgHA stops replication, opens the auxiliary database for writing, restarts pgbouncer with settings for robots with the new main database and completes its work.  To return the system to its original state is required manually. <br><br></li><li>  Run pgHA.  To test. </li></ol><br><h5>  PS </h5><br>  The [failover] section indicates the commands that are executed during the failover.  Thus, it is possible, for example, not to change the code in failoverd.pl, but to create a script - which changes the pgbouncer settings file and reloads it - and point to it. <br><br>  This solution does not reduce the speed of the programs using the database, and with good tuning, the pgbouncer can increase it.  I also consider the openness of the pgHA code a plus - it can be supplemented to teach, for example, attempts to reload the master database before failover, resume replication, change the font in the terminal, etc. <br><br>  The postgres 8.4 solution is presented in the aforementioned <a href="http://www.rummandba.com/2013/12/pgha-postgresqlpgbouncer-high.html">blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/223825/">https://habr.com/ru/post/223825/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223811/index.html">PiCore: 25 MB Linux distribution for Raspberry Pi</a></li>
<li><a href="../223813/index.html">From September of this year, robotic cars will be able to drive on general purpose roads in California.</a></li>
<li><a href="../223815/index.html">HHVM (hip-hop): Comparative testing and tuning</a></li>
<li><a href="../223821/index.html">Exceptions in Java, Part I (try-catch-finally)</a></li>
<li><a href="../223823/index.html">AZ Sutra. Hybrid forum and blog. Attempt once</a></li>
<li><a href="../223827/index.html">How I "twisted" behavioral factors</a></li>
<li><a href="../223829/index.html">Weather station: from idea to implementation</a></li>
<li><a href="../223831/index.html">Test automation. The beginning of the way</a></li>
<li><a href="../223833/index.html">Classification of types of testing</a></li>
<li><a href="../223837/index.html">AndroidSocialNetworks - convenient work with social networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>