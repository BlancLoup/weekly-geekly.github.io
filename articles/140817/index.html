<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CentOS6 Migration from raid1 to raid10</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 
 There is a server with CentOS6 and high% iowait. It is necessary without downtime, or a maximum of 10 minutes, preferably at night, to tra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CentOS6 Migration from raid1 to raid10</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br>  There is a server with CentOS6 and high% iowait.  It is necessary without downtime, or a maximum of 10 minutes, preferably at night, to transfer the system from md raid1 to md raid10.  In my case, it's really possible to keep within 10 minutes, or even less, because the server has hot-swap baskets, but the engineers of the data center where the server is rented, initially connected the disks to the second and third baskets, and not the first and second.  Because of this, we had to turn off the server, switch the old disks and change the new two. <a name="habracut"></a><br><br>  Before starting, I will mention one detail; without it, it is impossible to migrate by following this topic.  The entire system, except / boot, must be installed on LVM.  The / boot mount point is on the md0 partition, because  grub 0.97 does not know how to boot from LVM. <br><br>  So, the server is loaded and it has four disks.  The / dev / md0 partition is / boot, the / dev / md1 partition is an LVM Physical device and there is a system on it. <br><pre> # ls -l / dev / vd *
 brw-rw ----.  1 root disk 252, 0 Mar 23 22:34 / dev / vda
 brw-rw ----.  1 root disk 252, 1 Mar 23 22:34 / dev / vda1
 brw-rw ----.  1 root disk 252, 2 Mar 23 22:34 / dev / vda2
 brw-rw ----.  1 root disk 252, 16 Mar 23 22:34 / dev / vdb
 brw-rw ----.  1 root disk 252, 17 Mar 23 22:34 / dev / vdb1
 brw-rw ----.  1 root disk 252, 18 Mar 23 22:34 / dev / vdb2
 brw-rw ----.  1 root disk 252, 32 Mar 23 22:34 / dev / vdc
 brw-rw ----.  1 root disk 252, 48 Mar 23 22:34 / dev / vdd

 #cat / proc / mdstat
 Personalities: [raid1]
 md0: active raid1 vda1 [0] vdb1 [1]
       204788 blocks super 1.0 [2/2] [UU]

 md1: active raid1 vdb2 [1] vda2 [0]
       5937144 blocks super 1.1 [2/2] [UU]
       bitmap: 1/1 pages [4KB], 65536KB chunk

 # df -h
 Filesystem Size Used Avail Use% Mounted on
 / dev / mapper / vg_vmraid10-root 2.0G 591M 1.3G 32% /
 tmpfs 376M 0 376M 0% / dev / shm
 / dev / md0 194M 33M 151M 18% / boot
 / dev / mapper / vg_vmraid10-part 1008M 34M 924M 4% / mnt / part </pre><br>  In the example, the disks appear as / dev / vdX, because  For example, we used a virtual machine using para-virtualized VirtIO disk drivers. <br>  First, extract / dev / vdb2 from / dev / md1 <br><pre>  # mdadm / dev / md1 -f / dev / vdb2
 mdadm: set / dev / vdb2 faulty in / dev / md1
 # mdadm / dev / md1 -r / dev / vdb2
 mdadm: hot removed / dev / vdb2 from / dev / md1 </pre><br>  Next, we need to wipe the super block of the section and score with zeros a small part of the section,  if this is not done, then the data on / dev / md1 and the partition with raid10, as I understand it, will be consistents because of this there will be problems with creating a partition with raid10 (mdadm will swear that the / dev / vdb2 partition is already used in / dev / md1, despite the fact that we removed it earlier) and after rebooting, the system will try to boot not from / dev / md1, but c / dev / md2 and it will end on kernel panic. <br><pre>  # dd if = / dev / zero of = / dev / vdb2 bs = 512 count = 1
 # dd if = / dev / zero of = / dev / vdb2 bs = 1M count = 100 </pre><br>  I know that you can do only the second team, but initially I started to do so, so I did not dare to experiment on a real machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next we need to copy the partition table from / dev / vdb to / dev / vdc and / dev / vdd.  Let's use the sfdisk utility.  sfdisk will swear and say that I will not do anything because  the partition does not start at the boundary of the cylinder; add the -f switch to it. <br><pre>  # sfdisk -d / dev / vdb |  sfdisk -f / dev / vdc
 # sfdisk -d / dev / vdb |  sfdisk -f / dev / vdd </pre><br>  Sections are ready, it's time to create a new raid10 in degraded mode.  I specify my uuid also for insurance, since  during the experiments there were problems. <br><pre>  # mdadm --create / dev / md2 --uuid = 3846bee5: d9317441: f8fb6391: 4c024445 --level = 10 --raid-devices = 4 --chunk = 2048 missing / dev / vd [bcd] 2
 mdadm: Defaulting to version 1.2 metadata
 mdadm: array / dev / md2 started. </pre><br>  Add a line with a new section to /etc/mdadm.conf <br><pre>  # cat /etc/mdadm.conf 
 # mdadm.conf written out by anaconda
 MAILADDR root
 AUTO + imsm + 1.x-all
 ARRAY / dev / md0 level = raid1 num-devices = 2 UUID = 7872830a: c480f8c4: ac316f53: c6ea2b52
 ARRAY / dev / md1 level = raid1 num-devices = 2 UUID = 3846bee5: d9317441: f8fb6391: c4024454
 ARRAY / dev / md2 level = raid10 num-devices = 4 UUID = 3846bee5: d9317441: f8fb6391: 4c024445 </pre><br>  Reboot, when loading we see that the / dev / md2 partition is loaded in degraded mode <br><pre>  md / raid10: md2: active with 3 out of 4 devices </pre><br>  We create a physical volume from the newly created section, and also indicate my uuid to avoid duplicate uuid. <br><pre>  # pvcreate --uuid I0OAVm-27U4-KFWZ-4lMB-F3r9-X2kx-LnWADB --norestorefile / dev / md2
   Writing physical volume data to disk "/ dev / md2"
   Physical volume "/ dev / md2" successfully created </pre><br>  Now we increase the volume group vg_vmraid10 <br><pre>  # vgextend vg_vmraid10 / dev / md2
   Volume group "vg_vmraid10" successfully extended </pre><br>  In LVM on Physical volume data is stored in blocks called PhysicalExtent (PE), these PE's can be moved between Physical volume, which is what we need to do now. <br><pre>  # pvmove / dev / md1 / dev / md2
 ...
   / dev / md1: Moved: 100.0% </pre><br>  Now we need to open the /boot/grub/menu.lst file and correct the rd_MD_UUID parameter on the uuid of the / dev / md2 partition in my case, this is 3846bee5: d9317441: f8fb6391: 4c024445 in the kernel command line, if the system does not, then the system will try to find The root partition on / dev / md1, and that is already empty.  Also in this line, it is desirable to add the useful, when working remotely, parameter panic = 10, which means when kernel panic to do auto-search after 10 seconds.  Next we need to restart the server. <br><pre>  # reboot </pre><br>  And here we are waiting for one gift, so far I have not figured out why this happens.  After a reboot, the / dev / md2 partition is renamed to the / dev / md127 partition, but the system loads normally by uuid.  As far as I know, this refers to the new version of mdadm - 3.0 and higher, where you can create a partitionable array in which you can name the md partitions.  If anyone knows why this happens, then please write in the comments.  In the meantime, I just have to fix the partition number in the /etc/mdadm.conf file and delete the line responsible for / dev / md1. <br>  Remove from Physical group / dev / md1 and remove it from the Physical device list.  Stop / dev / md1, overwrite the super block at / dev / vda2 and add to / dev / md127 <br><br><pre>  # vgreduce vg_vmraid10 / dev / md1
   Removed "/ dev / md1" from volume group "vg_vmraid10"
 # pvremove / dev / md1
   Labels on physical volume "/ dev / md1" successfully wiped
 # mdadm -S / dev / md1
 mdadm: stopped / dev / md1
 # dd if = / dev / zero of = / dev / vda2 bs = 512 count = 1
 # mdadm / dev / md127 -a / dev / vda2
 mdadm: added / dev / vda2
 # cat / proc / mdstat
 Personalities: [raid10] [raid1]
 md0: active raid1 vda1 [0] vdb1 [1]
       204788 blocks super 1.0 [2/2] [UU]

 md127: active raid10 vda2 [4] vdb2 [1] vdc2 [2] vdd2 [3]
       11870208 blocks super 1.2 2048K chunks 2 near-copies [4/3] [_UUU]
       [&gt; ....................] recovery = 1.1% (68352/5935104) finish = 2.8min speed = 34176K / sec </pre><br>  Everything, the system is migrated to raid10. <br>  This should work and on CentOS5 only there you will not have to change the uuid in menu.lst, since  there is no such parameter.  In debian squeezy, the difference will be only in grub, because  there is grub2. <br>  In conclusion, I concluded for myself that it is always better to use LVM, since  working with disks becomes easier at times.  I can enlarge partitions, transfer data from one physical disk to another in transparent mode, I can make snapshots, etc. <br>  My first article, perhaps it turned out too long, I wanted to describe everything in detail so that it was clear. <br>  Thank you if you have read to the end. </div><p>Source: <a href="https://habr.com/ru/post/140817/">https://habr.com/ru/post/140817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140812/index.html">We refund money for the application in the App Store</a></li>
<li><a href="../140813/index.html">‚ÄúUltrabook. An autopsy showed "or" make your life easier "</a></li>
<li><a href="../140814/index.html">MegaFon call center in Penza</a></li>
<li><a href="../140815/index.html">Computer Aided Design (CAD). Who will win?</a></li>
<li><a href="../140816/index.html">Login form and registration using HTML5 and CSS3</a></li>
<li><a href="../140818/index.html">Jquery slideshow do it yourself</a></li>
<li><a href="../140820/index.html">Vizhenera cipher. Python parsing algorithm</a></li>
<li><a href="../140821/index.html">Home agent</a></li>
<li><a href="../140822/index.html">Psychology and digital reality</a></li>
<li><a href="../140824/index.html">Pirate party passed to the parliament of another German land</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>