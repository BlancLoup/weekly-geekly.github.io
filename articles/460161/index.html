<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FusionPBX and ACL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My article is not a complete description of the product, but only a small clarification of a good publication ‚ÄúFusionPBX, or, again, great, FreeSWITCH...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FusionPBX and ACL</h1><div class="post__text post__text-html js-mediator-article">  My article is not a complete description of the product, but only a small clarification of a good publication ‚ÄúFusionPBX, or, again, great, FreeSWITCH‚Äù.  It seems to me that the topic of ACL in FusionPBX is not well disclosed.  I will try to fill this gap, based on my own experience with FreeSWITCH / FusionPBX. <br><a name="habracut"></a><br>  And so, we have established FusionPBX with registered internal number 1010 in the domain.local domain and configured route for external calls to the city.  ACL is used to protect our telephony system from unauthorized calls that will take our money.  Those.  only from the networks described in the ACL allow outgoing calls.  And here you need a completely clear understanding of how the ACL in FusionPBX, its features, logic, and its point of reference. <br><br>  Like the distinguished author of the above article, I also stepped on all the rakes related to the ACL. <br><br>  I'll start with <b>SipProfiles</b> . <br>  Both profiles (I will call them that), and internal, and external are in the context of Public, and this is not accidental.  Registration of numbers takes place in the internal profile, and pay attention to it.  In the internal profile, the domains ACL list is assigned as apply-inbound-acl.  This line is responsible for the work of the ACL at the profile level.  While with all the profiles. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Context </h3><br>  The context, among other things, is used in call routing.  All incoming routes are bound to the Public context. <br><br>  Outgoing (to the city, cellular, long-distance, international, and any other) routes are (by default) in the context of the domain name (let's call it domain.local). <br><br><h3>  ACL </h3><br>  Now let's deal with the ACL.  By default, there are two ACL lists in the newly installed FusionPBX: <br><br>  domains default action: deny - this sheet is bound to the internal profile <br>  lan default action: allow <br><br>  We register the network in the ACL list of domains (well, for example, 192.168.0.0/24), we allow this network to allow it, we use reloadacl. <br><br>  Then we register the phone from this network, and everything seems to be good both according to the instructions and logical. <br>  We start testing, we make a call to an external number and ... we get a donut, or rather a donut hole.  Suddenly! <br><br>  We start analyzing the log in the console or through the Log Viewer FusioPBX. <br><br>  We see our challenge: <br><br><pre><code class="plaintext hljs">switch_channel.c:1104 New Channel sofia/internal/1010@domain.local</code> </pre> <br>  We see a triggered ACL: <br><br><pre> <code class="plaintext hljs">sofia.c:10208 IP 192.168.0.150 Approved by acl "domains[]". Access Granted.</code> </pre> <br>  And further: <br><br><pre> <code class="plaintext hljs">mod_dialplan_xml.c:637 Processing 1010 &lt;1010&gt;-&gt;98343379xxxx in context public switch_core_state_machine.c:311 No Route, Aborting switch_core_state_machine.c:312 Hangup sofia/internal/1010@domain.local [CS_ROUTING] [NO_ROUTE_DESTINATION]</code> </pre> <br>  No route!  Although the route is honestly registered with us. <br><br>  The answer is really simple. <br><br>  The call came.  ACL missed it.  And since the ACL is attached to the internal profile, and this profile is in the public context, FreeSWITCH honestly looks at the routing in the public context.  But in the context of public only incoming routing, and the system honestly tells us that there are no routes to the city. <br><br>  From the current situation there are at least two ways out. <br><br><ol><li>  Do not attach this ACL to the profile, but to the internal number itself.  This may be the most correct way to solve, because  ACL is best tied as close as possible to the Extension for more fine-tuning.  Those.  You can register a specific address / network address of the phone from which he can make an outgoing call.  The disadvantage of this option is that in each Extension will have to do it. </li><li>  Correct the ACL so that it works correctly at the profile level.  I chose this option, because it seemed to me easier to add the network to the ACL once, than to register it in each Extension.  But this is specifically for my task.  For other tasks, you may need a different decision logic. </li></ol><br>  So.  We will correct ACL domains as follows: <br><br>  domains default action: allow <br><br>  In the ACL list of domains, we register the network: <br><br>  deny 192.168.0.0/24 <br><br>  Apply, reloadacl. <br>  We are testing: we are dialing again the number 98343379xxxxx and ... there is a CPV ... ALLO.  Everything is working. <br>  See what happened in FreeSWITCH: <br>  The challenge begins: <br><br><pre> <code class="plaintext hljs">switch_channel.c:1104 New Channel sofia/internal/1010@domain.local</code> </pre> <br>  ACL did not miss: <br><br><pre> <code class="plaintext hljs">[DEBUG] sofia.c:10263 IP 192.168.0.150 Rejected by acl "domains". Falling back to Digest auth.</code> </pre> <br>  and further: <br><br><pre> <code class="plaintext hljs">mod_dialplan_xml.c:637 Processing 1010 &lt;1010&gt;-&gt;98343379xxxx in context domain.local sofia/internal/1010@domain.local Regex (PASS) [Sity] destination_number(98343379xxxx) =~ /^9(8343[23]\d{6})$/ break=on-false</code> </pre> <br>  Routing has passed, and then a connection is established that goes beyond the topic. <br><br>  If we change the network address in the ACL, but we get the picture from the first test, i.e.  The ACL will skip the call and the routing will say NO_ROUTE_DESTINATION. <br><br>  That's probably all that I wanted to add on ACL FusionPBX. <br><br>  I hope someone will come in handy. </div><p>Source: <a href="https://habr.com/ru/post/460161/">https://habr.com/ru/post/460161/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460149/index.html">Proper typing: the underestimated aspect of clean code</a></li>
<li><a href="../460153/index.html">The adventures of electronic signature in Russia</a></li>
<li><a href="../460155/index.html">ReactiveX Redux</a></li>
<li><a href="../460157/index.html">How ‚Äúcorrect‚Äù answers of respondents can distort the results of the survey beyond recognition</a></li>
<li><a href="../460159/index.html">Method of monitoring the current state of Russian highways with users' smartphones</a></li>
<li><a href="../460163/index.html">It seemed</a></li>
<li><a href="../460165/index.html">Background: quantum cryptography on the fingers</a></li>
<li><a href="../460169/index.html">A Guide to R recently, the most cited non-academic publication in academic papers</a></li>
<li><a href="../460173/index.html">Development for Docker. Local environment. Part 2 - Nginx + PHP + MySql + phpMyAdmin</a></li>
<li><a href="../460175/index.html">Semiotics in marketing: what does it mean for your brand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>