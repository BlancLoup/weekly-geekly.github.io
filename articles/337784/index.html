<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing OpenId Connect in ASP.NET Core using IdentityServer4 and oidc-client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I needed to figure out how authentication is done on OpenId Connect on an ASP.NET Core. I started with examples, it quickly became clear tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing OpenId Connect in ASP.NET Core using IdentityServer4 and oidc-client</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habr.com/ru/post/337784/"><img src="https://habrastorage.org/web/4f5/56f/c6c/4f556fc6c8b14038a78fc7874c5053cd.png"></a> </p><br><p>  Recently, I needed to figure out how authentication is done on OpenId Connect on an ASP.NET Core.  I started with examples, it quickly became clear that reading the specification could not be avoided, then I had to move on to reading source codes and articles of developers.  As a result, there was a desire to gather in one place everything that is needed in order to understand how to make a working implementation of OpenId Connect Implicit Flow on an ASP.NET Core platform, while <a href="http://catb.org/jargon/html/koans.html">understanding</a> what you are doing. </p><a name="habracut"></a><br><p>  The article is about the specifics of implementation, therefore I recommend to reproduce the decision on the code proposed in the article, otherwise it will be difficult to grasp the context.  Most of the relevant comments in the comments and in the text of the article contain links to sources.  Some terms have no generally accepted translations into Russian, I left them in English. </p><br><h3 id="nemnogo-ob-openid-connect">  A bit about OpenId Connect </h3><br><p>  If you understand OpenId Connect, you can start reading from the next section. </p><br><p>  OpenId Connect (not to be confused with OpenId) is an authentication protocol built on the basis of the OAuth2.0 authorization protocol.  The point is that the OAuth2 task involves only user authorization, not authentication.  OpenID Connect also sets a standard way to get and present user profiles as a set of values ‚Äã‚Äãcalled claims.  OpenId Connect describes a UserInfo endpoint that returns this information.  It also allows client applications to receive user information in the form of signed JSON Web Token ( <a href="https://jwt.io/">JWT</a> ), which allows you to send fewer requests to the server. </p><br><p>  It makes sense to begin acquaintance with the protocol from the <a href="https://openid.net/connect/">official site</a> , then it is useful to read the sites of commercial cloud authentication solutions providers like <a href="https://connect2id.com/learn/openid-connect">Connect2id</a> , <a href="https://auth0.com/docs/protocols/oidc">Auth0</a> and <a href="https://stormpath.com/blog/openid-connect-user-authentication-in-asp-net-core">Stormpath</a> .  I do not quote a description of all the necessary terms, firstly, it would be a wall of text, and secondly, everything you need is on these links. </p><br><p>  If you are not familiar with Identity Server, I recommend starting with reading its excellent <a href="https://identityserver4.readthedocs.io/en/release/">documentation</a> , as well as excellent examples like <a href="https://www.scottbrady91.com/Identity-Server/Getting-Started-with-IdentityServer-4">this</a> . </p><br><h3 id="chto-my-hotim-poluchit-v-itoge">  What we want to get in the end </h3><br><p>  We implement OpenId Connect Implicit Flow, which is recommended for JavaScript applications, in the browser, including for the SPA.  In the process, we will go a little deeper than is usually done in walkthroughs; we will discuss different meaningful settings.  Then we will look at how our implementation works from the point of view of the OpenId Connect protocol, and also learn how implementation is related to the protocol. </p><br><h3 id="instrumenty">  Instruments </h3><br><ul><li>  On the server side, we use <strong>IdentityServer4</strong> </li><li>  On the client side, we will use the <strong>oidc-client</strong> library </li></ul><br><p>  The main authors of both libraries are <a href="https://brockallen.com/">Brock Allen</a> and <a href="https://leastprivilege.com/">Dominic Brier</a> . </p><br><h3 id="scenarii-vzaimodeystviya">  Interaction scenarios </h3><br><p>  We will have 3 projects: </p><br><ol><li>  <strong>IdentityServer</strong> is our OpenId Connect authentication server. </li><li>  <strong>Api</strong> is our test web service. </li><li>  <strong>Client</strong> is our JavaScript client application, based on <a href="https://github.com/IdentityServer/IdentityServer4.Samples/tree/release/Quickstarts/7_JavaScriptClient">JavaScriptClient</a> code. </li></ol><br><p>  The interaction scenario is as follows: the Client client application is authorized using the <strong>IdentityServer</strong> authentication server and gets access_token (JWT), which it then uses as a Bearer token to call the web service on the <strong>Api</strong> server. </p><br><p>  The OpenId Connect standard describes various options for authenticating.  These options in the standard language are called Flow. <br>  Implicit Flow, which we are considering in this article, includes <a href="http://openid.net/specs/openid-connect-core-1_0.html">such steps</a> : </p><br><ol><li>  The client prepares <em>an authentication request</em> containing the desired request parameters. </li><li>  <em>The client</em> sends <em>an authentication request to the authorization</em> <em>server</em> . </li><li>  <em>The authorization server</em> authenticates the <em>end user</em> . </li><li>  <em>The authorization server</em> receives <em>confirmation</em> from the <em>end user</em> . </li><li>  <em>The authorization server</em> sends the <em>end user</em> back to the <em>client</em> with id_token and, if required, access_token. </li><li>  <em>The client</em> validates the id_token and gets the <em>end-user</em> <em>Subject Identifier</em> . </li></ol><br><p><img src="https://habrastorage.org/web/706/daa/662/706daa66261d4b0fab6b7ccbd3a6a401.png" alt="Implicit flow"></p><br><h3 id="implementaciya">  Implementation </h3><br><p>  In order to save a lot on writing pages related to login and logout, we will use the <a href="">official Quickstart code</a> . </p><br><p> I recommend <code>dotnet run</code> <strong>Api</strong> and <strong>IdentityServer</strong> during this exercise through the <code>dotnet run</code> - <strong>IdentityServer</strong> writes a lot of useful diagnostic information in the course of its work, this information will be immediately visible in the console. </p><br><p>  For simplicity, it is assumed that all projects are running on the same computer on which the user's browser is running. </p><br><p>  Let's get down to implementation.  For definiteness, we will assume that you are using Visual Studio 2017 (15.3).  You can see the complete solution code <a href="https://github.com/ntaranov/OpenIdConnectSample">here.</a> <br>  Create an empty solution <strong>OpenIdConnectSample</strong> . </p><br><p>  Most of the code is based on <a href="https://github.com/IdentityServer/IdentityServer4.Samples">examples</a> from the <strong>IdentityServer</strong> documentation, but the code in this article is supplemented by what, in my opinion, is missing in the official documentation, and annotated. </p><br><p>  I recommend to get acquainted with all the official examples, we‚Äôll take a deeper look at Implicit Flow. </p><br><h4 id="1-identityserver">  1. IdentityServer </h4><br><p>  Create a solution with an empty project, choose ASP.NET Core 1.1 as the platform. </p><br><p>  Install these NuGet packages </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Mvc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.StaticFiles</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IdentityServer4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span></code> </pre> <br><p>  Package versions are significant here, because  <code>Install-Package</code> installs the latest versions by default.  Although the authors have already made an <strong>IdentityServer</strong> port on Asp.NET Core 2.0 in the dev branch, at the time of this writing, they have not yet ported the Quickstart UI.  The differences in the code of our example for .NET Core 1.1 and 2.0 are small. </p><br><p>  Change the <code>Main</code> <strong>Program.cs</strong> method to look like this. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Console.Title = <span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore2x var host = new WebHostBuilder() .UseKestrel() //  ,     Kestrel   .UseUrls("http://localhost:5000") //    UI - .UseContentRoot(Directory.GetCurrentDirectory()) .UseIISIntegration() .UseStartup&lt;Startup&gt;() .Build(); host.Run(); }</span></span></code> </pre> <br><p>  Then in <strong>Startup.cs</strong> </p><br><ol><li>  Add namespaces <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Claims; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityServer4; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityServer4.<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityServer4.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityServer4.Test;</code> </pre> </li><li>  Add a few helper methods that contain the <strong>IdentityServer</strong> settings, note the comments.  These methods will be further called in <code>ConfigureServices</code> .  I recommend reading the text of the methods before adding them to the project - on the one hand, this will allow you to immediately have a complete picture of what is happening, on the other hand there is not much there. </li></ol><br><p>  Information Settings for Client Applications </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IEnumerable&lt;IdentityResource&gt; GetIdentityResources() { // ,  scopes   IdentityServer <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;IdentityResource&gt; { // "sub" claim <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IdentityResources.OpenId(), //  claims    profile scope // http://openid.net/specs/openid-<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>-core<span class="hljs-number"><span class="hljs-number">-1</span></span>_0.html#ScopeClaims <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IdentityResources.Profile(), }; }</code> </pre> <br><p>  These settings add support for claim <code>sub</code> , which is the minimum requirement for our OpenId Connect token to meet, as well as the claim scope <code>profile</code> including the OpenId Connect profile fields like name, gender, date of birth, and the like. </p><br><p>  These are similar to the previous settings, but the information is intended for the API. </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IEnumerable&lt;ApiResource&gt; GetApiResources() { // claims  scopes    access_token <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;ApiResource&gt; { //  scope "api1"  IdentityServer <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ApiResource("api1", "API 1", //  claims   scope api1 <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] {"name", "role" }) }; }</code> </pre> <br><p>  The client applications themselves, you need to let the server know about them. </p><br><pre> <code class="hljs ruby">public static IEnumerable&lt;Client&gt; GetClients() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new List&lt;Client&gt; { new Client { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,   client_id     ClientId = <span class="hljs-string"><span class="hljs-string">"js"</span></span>, ClientName = <span class="hljs-string"><span class="hljs-string">"JavaScript Client"</span></span>, AllowedGrantTypes = GrantTypes.Implicit, AllowAccessTokensViaBrowser = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-literal"><span class="hljs-literal">false</span></span>      UserInfo endpoint AlwaysIncludeUserClaimsInIdToken = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>          /<span class="hljs-regexp"><span class="hljs-regexp">/  User Agent,    RedirectUris = { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     "http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost:5003/callback</span></span>.html<span class="hljs-string"><span class="hljs-string">", //      access_token  iframe "</span></span><span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:5003/callback</span></span>-silent.html<span class="hljs-string"><span class="hljs-string">" }, PostLogoutRedirectUris = { "</span></span><span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:5003/index</span></span>.html<span class="hljs-string"><span class="hljs-string">" }, //   ,     CORS- AllowedCorsOrigins = { "</span></span><span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:5003" }, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  scopes,       AllowedScopes = { IdentityServerConstants.StandardScopes.OpenId, IdentityServerConstants.StandardScopes.Profile, "api1" }, AccessTokenLifetime = 300, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ,     IdentityTokenLifetime = 3600, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ,     /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    refresh-   scope offline_access AllowOfflineAccess = false, } }; }</span></span></code> </pre> <br><p>  Test users, note that <strong>bob is</strong> our admin </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;TestUser&gt; GetUsers() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;TestUser&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestUser { SubjectId = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Username = <span class="hljs-string"><span class="hljs-string">"alice"</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"password"</span></span>, Claims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;Claim&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Alice"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"website"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://alice.com"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"role"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>), } }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestUser { SubjectId = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Username = <span class="hljs-string"><span class="hljs-string">"bob"</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"password"</span></span>, Claims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;Claim&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bob"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"website"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://bob.com"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"role"</span></span>, <span class="hljs-string"><span class="hljs-string">"admin"</span></span>), } } }; }</code> </pre> <br><ol><li>  Modify the <code>ConfigureServices</code> method so </li></ol><br><pre> <code class="hljs ruby">public void ConfigureServices(IServiceCollection services) { services.AddMvc(); services.AddIdentityServer(options =&gt; { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/docs.identityserver.io/en</span></span><span class="hljs-regexp"><span class="hljs-regexp">/release/reference</span></span><span class="hljs-regexp"><span class="hljs-regexp">/options.html#refoptions options.Endpoints = new EndpointsOptions { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  Implicit Flow     EnableAuthorizeEndpoint = true, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     EnableCheckSessionEndpoint = true, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      EnableEndSessionEndpoint = true, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   claims   /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openid.net/specs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openid-connect-core-1_0.html#UserInfo EnableUserInfoEndpoint = true, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  OpenId Connect    EnableDiscoveryEndpoint = true, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     ,    EnableIntrospectionEndpoint = false, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ..  Implicit Flow access_token   authorization_endpoint EnableTokenEndpoint = false, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    refresh  reference tokens /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docs.identityserver.io/en</span></span><span class="hljs-regexp"><span class="hljs-regexp">/release/topics</span></span><span class="hljs-regexp"><span class="hljs-regexp">/reference_tokens.html EnableTokenRevocationEndpoint = false }; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ IdentitySever  cookie     options.Authentication = new IdentityServer4.Configuration.AuthenticationOptions { CookieLifetime = TimeSpan.FromDays(1) }; }) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  x509-, IdentityServer  RS256   JWT .AddDeveloperSigningCredential() /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    id_token .AddInMemoryIdentityResources(GetIdentityResources()) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    access_token .AddInMemoryApiResources(GetApiResources()) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    .AddInMemoryClients(GetClients()) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   .AddTestUsers(GetUsers()); }</span></span></code> </pre> <br><p>  In this method, we specify the <strong>IdentityServer</strong> settings, in particular, the certificates used to sign tokens, the <code>scope</code> settings in the sense of OpenId Connect and OAuth2.0, the settings of the client applications, and the user settings. </p><br><p>  Now a little more.  <code>AddIdentityServer</code> registers the <strong>IdentityServer</strong> service in the ASP.NET Core dependency resolution mechanism, this needs to be done in order to be able to add it as middleware in <code>Configure</code> . </p><br><ul><li>  <strong>IdentityServer</strong> signs tokens using RSA SHA 256, so a private-public key pair is required.  <code>AddDeveloperSigningCredential</code> adds test keys for signing JWT tokens, namely <strong>id_token</strong> , <strong>access_token</strong> in our case.  In production, you need to replace these keys, you can do this, for example, by <a href="https://brockallen.com/2015/06/01/makecert-and-creating-ssl-or-signing-certificates/">generating a self-signed certificate</a> . </li><li>  <code>AddInMemoryIdentityResources</code> .  You can read about what is meant by resources <a href="http://docs.identityserver.io/en/release/topics/resources.html%3Fhighlight%3Didentityresource">here</a> , and why they are needed - <a href="https://leastprivilege.com/2016/12/01/new-in-identityserver4-resource-based-configuration/">here</a> . </li></ul><br><p>  The <code>Configure</code> method should look like this. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span></span></span><span class="hljs-function">)</span></span> { loggerFactory.AddConsole(LogLevel.Debug); app.UseDeveloperExceptionPage(); <span class="hljs-comment"><span class="hljs-comment">//  middleware IdentityServer app.UseIdentityServer(); //  2  ,      app.UseStaticFiles(); app.UseMvcWithDefaultRoute(); }</span></span></code> </pre><br><p>  Download Starter UI for <strong>IdentityServer</strong> from the <a href="">official repository</a> , then copy the files into the project folder so that the folders match the structure, for example wwwroot with wwwroot. </p><br><p>  Check that the project is compiled. </p><br><h4 id="2-api">  2. Api </h4><br><p>  This project is a toy API server with limited access. </p><br><p>  Add another empty <strong>Api</strong> project to the solution, choose ASP.NET Core 1.1 as the platform.  Since  we are not going to create a full-fledged web application in this project, but only a lightweight web service that provides JSON, we confine ourselves to the MvcCore middleware instead of the full Mvc. </p><br><p>  Add the packages you need by running these commands in the Package Manager Console </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Mvc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Core</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Mvc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Formatters</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Json</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Cors</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IdentityServer4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AccessTokenValidation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> <br><p>  Let's start by adding the necessary Kestrel settings to <strong>Program.cs</strong> </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Console.Title = <span class="hljs-string"><span class="hljs-string">"API"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebHostBuilder() .UseKestrel() .UseUrls(<span class="hljs-string"><span class="hljs-string">"http://localhost:5001"</span></span>) .UseContentRoot(Directory.GetCurrentDirectory()) .UseIISIntegration() .UseStartup&lt;Startup&gt;() .Build(); host.Run(); }</code> </pre> <br><p>  <strong>Startup.cs</strong> will require a few less changes. <br>  For <code>ConfigureServices</code> </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> ConfigureServices(IServiceCollection services) { services.AddCors(<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>=&gt; { //   CORS,          API <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.AddPolicy("default", <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>.WithOrigins("http://localhost:5003") .AllowAnyHeader() .AllowAnyMethod(); }); }); //   MVC Core   Razor, DataAnnotations  ,   Asp.NET <span class="hljs-number"><span class="hljs-number">4.5</span></span> WebApi services.AddMvcCore() //  ,      Authorize .AddAuthorization(<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> =&gt; //      Roles magic strings,      <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.AddPolicy("AdminsOnly", policyUser =&gt; { policyUser.RequireClaim("role", "admin"); }) ) //  AddMVC,   AddMvcCore,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> .AddJsonFormatters(); }</code> </pre> <br><p>  This is what <code>Configure</code> should look like. </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory) { loggerFactory.AddConsole(LogLevel.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>); //  middleware  CORS app.UseCors("default"); //  middleware      OpenId <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> JWT- app.UseIdentityServerAuthentication(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IdentityServerAuthenticationOptions { //  IdentityServer Authority = "http://localhost:5000", // ,     HTTPS    IdentityServer,   <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>   // https://docs.microsoft.com/en-us/aspnet/core/api/microsoft.aspnetcore.builder.openidconnectoptions RequireHttpsMetadata = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, //        aud  access_token JWT ApiName = "api1", //   ,      api   scopes      scope // AllowedScopes = { "api1.read", "api1.write" } //  JWT-   claims   HttpContext.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>      Authorize  ,   AutomaticAuthenticate = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, //   middleware     authentication challenge AutomaticChallenge = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, //   [Authorize],  IdentityServerAuthenticationOptions -    RoleClaimType = "role", }); app.UseMvc(); }</code> </pre> <br><p>  It remains to add our controller, it returns the current Claims user, which is convenient in order to understand how the <strong>IdentityServer</strong> middleware authentication decrypted <code>access_token</code> . <br>  Add a single <code>IdentityController</code> controller to the project. <br>  The content of the file should be like this. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.<span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span>; namespace Api.Controllers { [Authorize] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> IdentityController : ControllerBase { [HttpGet] [Route("identity")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IActionResult <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JsonResult(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.Claims <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> { c.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>, c.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> }); } [HttpGet] [Route("superpowers")] [Authorize(<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> = "AdminsOnly")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IActionResult Superpowers() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JsonResult("Superpowers!"); } } }</code> </pre> <br><p>  Make sure the project is compiled. </p><br><h4 id="3-client">  3. Client </h4><br><p>  This project actually does not contain significant server part.  All server code is simply Kestrel's web server settings, so that it gives out static client files. </p><br><p>  Just like the last 2 times, add an empty project to the solution, name it <strong>Client</strong> . </p><br><p>  Install the package to work with static files. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.StaticFiles</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Version</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span></code> </pre> <br><p>  Modify the <strong>Program.cs</strong> file </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebHostBuilder() .UseKestrel() .UseUrls(<span class="hljs-string"><span class="hljs-string">"http://localhost:5003"</span></span>) .UseContentRoot(Directory.GetCurrentDirectory()) .UseIISIntegration() .UseStartup&lt;Startup&gt;() .Build(); host.Run(); }</code> </pre> <br><p>  The <code>Startup</code> class must contain this code. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.UseDefaultFiles(); app.UseStaticFiles(); }</code> </pre> <br><p>  The client code in JavaScript, on the other hand, contains all the logic of the authentication and Api calls. </p><br><p>  We will add the following files to the wwwroot folder of the project one by one. </p><br><ul><li>  <code>index.html</code> is a simple HTML file with buttons for various actions and a link to the JavaScript application file <code>app.js</code> and <code>oidc-client.js</code> . </li><li>  <code>oidc-client.js</code> - client library that implements OpenId Connect </li><li>  <code>app.js</code> - <strong>oidc-client</strong> settings and button event handlers </li><li>  <code>callback.html</code> - the page to which the authentication server redirects the client application, passing the parameters necessary to complete the login procedure. </li><li>  <code>callback-silent.html</code> is a page similar to <code>callback.html</code> , however, it is for the case when there is a "background" repeated login through the iframe.  This is necessary to extend user access to resources without using <code>refresh_token</code> . </li></ul><br><p>  <strong>index.html</strong> <br>  Add a new HTML file with this name to the wwwroot folder of the project. </p><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"login"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"getUser"</span></span></span><span class="hljs-tag">&gt;</span></span>Get User<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"getSuperpowers"</span></span></span><span class="hljs-tag">&gt;</span></span>Get Superpowers!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"api"</span></span></span><span class="hljs-tag">&gt;</span></span>Call API<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logout"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"results"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"oidc-client.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <strong>oidc-client.js</strong> <br>  Download this file <a href="">from here</a> (1.3.0) and add to the project. </p><br><p>  <strong>app.js</strong> <br>  Add a new javascript file with this name to the project's wwwroot folder. </p><br><p>  Add a </p><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;reference path="oidc-client.js" /&gt;</span></span></span></span></code> </pre> <br><p>  at the beginning of the file to support IntelliSense. </p><br><p>  Paste this code to the top of <code>app.js</code> </p><br><pre> <code class="hljs pgsql">Oidc.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.logger = console; Oidc.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre> <br><p>  In the first line, using the compatibility of the called methods, we set the standard browser console as the standard logger for <strong>oidc-client</strong> .  The second line, please display all messages.  This will allow us to see more details when we move on to the second part of the article, and we will look at how our implementation works. </p><br><p>  Now let's in parts add the rest of the code to this file. </p><br><p>  This part of the code is the longest, and perhaps the most interesting.  It contains the library settings for the main <code>UserManager</code> object of the <a href="https://github.com/IdentityModel/oidc-client-js"><strong>oidc-client</strong></a> library and its creation.  I recommend to get acquainted with the settings themselves and comments to them. </p><br><pre> <code class="hljs pgsql">var config = { authority: "http://localhost:5000", //   IdentityServer client_id: "js", //      IdentityServer //  ,          //      -     OpenId <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> redirect_uri: "http://localhost:5003/callback.html", // Response <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>   ,   <span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span> Endpoint //   ,    Implicit Flow // http://openid.net/specs/openid-<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>-core<span class="hljs-number"><span class="hljs-number">-1</span></span>_0.html#Authentication response_type: "id_token token", //  subject id ,      id_token,    access_token    api1 (. c IdentityServer) scope: "openid profile api1", // ,           post_logout_redirect_uri: "http://localhost:5003/index.html", //      IdentityServer,   <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> monitorSession: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, //   ,       ,   <span class="hljs-number"><span class="hljs-number">2000</span></span> checkSessionInterval: <span class="hljs-number"><span class="hljs-number">30000</span></span>, //  access_token     https://tools.ietf.org/html/rfc7009 revokeAccessTokenOnSignout: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, //       ,    ,   <span class="hljs-number"><span class="hljs-number">300</span></span> // https://github.com/IdentityModel/oidc-client-js/blob/<span class="hljs-number"><span class="hljs-number">1.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/src/JoseUtil.js#L95 clockSkew: <span class="hljs-number"><span class="hljs-number">300</span></span>, //     UserInfo endpoint  ,       loadUserInfo: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, }; var mgr = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Oidc.UserManager(config);</code> </pre> <br><p>  Let's now add handlers for the buttons and subscribe to them. </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //   mgr.signinRedirect(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">displayUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { mgr.getUser().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user) { <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"User logged in"</span></span>, user.profile); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"User not logged in"</span></span>); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //   claims  requestUrl(mgr, <span class="hljs-string"><span class="hljs-string">"http://localhost:5001/identity"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSuperpowers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //  endpoint    requestUrl(mgr, <span class="hljs-string"><span class="hljs-string">"http://localhost:5001/superpowers"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //   mgr.signoutRedirect(); } document.getElementById(<span class="hljs-string"><span class="hljs-string">"login"</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, login, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); document.getElementById(<span class="hljs-string"><span class="hljs-string">"api"</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, api, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); document.getElementById(<span class="hljs-string"><span class="hljs-string">"getSuperpowers"</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, getSuperpowers, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); document.getElementById(<span class="hljs-string"><span class="hljs-string">"logout"</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, logout, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); document.getElementById(<span class="hljs-string"><span class="hljs-string">"getUser"</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, displayUser, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); //       displayUser();</code> </pre> <br><p>  It remains to add a couple of utilities </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mgr, url)</span></span></span></span> { mgr.getUser().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user)</span></span></span></span> { var xhr = new XMLHttpRequest(); xhr.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, url); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(xhr.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span> == xhr.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> ? JSON.parse(xhr.responseText) : <span class="hljs-string"><span class="hljs-string">"An error has occured."</span></span>); } //   Authorization  access_token   Bearer - . xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span> + user.access_token); xhr.send(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { document.getElementById(<span class="hljs-string"><span class="hljs-string">'results'</span></span>).innerText = <span class="hljs-string"><span class="hljs-string">''</span></span>; Array.prototype.forEach.call(arguments, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg instanceof Error) { msg = <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> + msg.message; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typeof msg !== <span class="hljs-string"><span class="hljs-string">'string'</span></span>) { msg = JSON.stringify(msg, null, <span class="hljs-number"><span class="hljs-number">2</span></span>); } document.getElementById(<span class="hljs-string"><span class="hljs-string">'results'</span></span>).innerHTML += msg + <span class="hljs-string"><span class="hljs-string">'\r\n'</span></span>; }); }</code> </pre> <br><p>  In principle, this could be the end, but you need to add two more pages that are needed to complete the login procedure.  Add pages with this code in <code>wwwroot</code> . </p><br><p>  <strong>callback.html</strong> </p><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"oidc-client.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> Oidc.UserManager().signinRedirectCallback().then(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.location = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"index.html"</span></span></span><span class="javascript">; }).catch(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">e</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.error(e); }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <strong>callback-silent.html</strong> </p><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'oidc-client.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">new</span></span></span><span class="actionscript"> Oidc.UserManager().signinSilentCallback(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Done! </p><br><h3 id="kak-eto-rabotaet">  How it works </h3><br><p>  I recommend running projects like this: start the console, go to the project folder, execute the <code>dotnet run</code> command.  This will allow you to see that <strong>IdentityServer</strong> and other applications are logging into the console. </p><br><p>  First start <strong>IdentityServer</strong> and <strong>Api</strong> , and then <strong>Client</strong> . </p><br><p>  Open the <code>http://localhost:5003/index.html</code> <strong>Client</strong> page. <br>  At this point, you may want to clear the console with <code>clear()</code> . </p><br><p>  Now let's configure the console to actually see all the interesting information. <br>  For example, for Chrome 60, the console settings should look like this. </p><br><p><img src="https://habrastorage.org/web/7cd/eed/832/7cdeed8327c24145b420c03e6124acf9.png"></p><br><p>  In the <strong>Network</strong> tab of the developer tools you may want to tick the <strong>Preserve log</strong> box so that redirects do not interfere with further checking the values ‚Äã‚Äãof various parameters. </p><br><p>  Refresh your page with <strong>CTRL + F5</strong> . </p><br><h3 id="happy-path">  Happy path </h3><br><p>  Let's see which actions correspond to the first two steps of the specification. <br>  <strong>1. <em>The client</em> prepares <em>an authentication request</em> containing the necessary request parameters.</strong> <br>  <strong>2. <em>The client</em> sends <em>an authentication request to the authorization</em> <em>server</em> .</strong> <br>  Click the Login button. </p><br><p>  Interaction with the authorization server begins with a GET request to the address <br> <code>http://localhost:5000/.well-known/openid-configuration</code> <br>  With this request, <strong>oidc-client</strong> receives the <a href="https://openid.net/specs/openid-connect-discovery-1_0.html">metadata of</a> our provider OpenId Connect (I recommend opening this address in another tab), including <code>authorization_endpoint</code> <br> <code>http://localhost:5000/connect/authorize</code> </p> <br><p>  Please note that WebStorage is used to store user data.  <strong>oidc-client</strong> allows you to specify which object will be used, the default is <code>sessionStorage</code> . </p><br><p>  At this point, <a href="http://openid.net/specs/openid-connect-core-1_0.html">an authentication request</a> will be sent to <code>authorization_endpoint</code> with such query string parameters </p><br><table><thead><tr><th>  <strong>Name</strong> </th><th>  <strong>Value</strong> </th></tr></thead><tbody><tr><td>  <strong>client_id</strong> </td><td>  js </td></tr><tr><td>  <strong>redirect_uri</strong> </td><td>  <a href="http://localhost:5003/callback.html">http: // localhost: 5003 / callback.html</a> </td></tr><tr><td>  <strong>response_type</strong> </td><td>  id_token token </td></tr><tr><td>  <strong>scope</strong> </td><td>  openid profile api1 </td></tr><tr><td>  <strong>state</strong> </td><td>  <em>some hard-to-predict value</em> </td></tr><tr><td>  <strong>nonce</strong> </td><td>  <em>some hard-to-predict value</em> </td></tr></tbody></table><br><p>  Please note that <strong>redirect_uri</strong> corresponds to the address that we specified for our client with <code>client_id</code> js in the <strong>IdentityServer</strong> settings. </p><br><p>  Since  the user <a href="http://openid.net/specs/openid-connect-core-1_0.html">is not authenticated yet</a> , <strong>IdentityServer will</strong> send a <a href="https://identityserver4.readthedocs.io/en/release/topics/signin.html">redirect to the login form</a> as an answer. </p><br><p>  Then the browser is redirected to <code>http://localhost:5000/account/login</code> . </p><br><p>  <strong>3. <em>The authorization server</em> authenticates the <em>end user</em> .</strong> <br>  <strong>4. <em>The authorization server</em> receives <em>confirmation</em> from the <em>end user</em> .</strong> <br>  <strong>5. <em>The authorization server</em> sends the <em>end user</em> back to the <em>client</em> with an id token and, if required, an access token.</strong> </p><br><p>  Enter <strong>bob</strong> as a login and <strong>password</strong> as a password, send the form. <br>  We are first redirected again to <code>authorization_endpoint</code> , and from there to <a href="http://identityserver4test.readthedocs.io/en/latest/topics/consent.html">the confirmation page</a> in accordance with <a href="http://openid.net/specs/openid-connect-core-1_0.html">OpenId Connect</a> permission to get the relying party (in this case, our js-client) access to various scopes. </p><br><p>  We agree with everything, we send the form.  Similar to the authentication form, in response to the form submission, we are redirected to <code>authorization_endpoint</code> , the data to <code>authorization_endpoint</code> transmitted using a cookie. </p><br><p>  From there, the browser is redirected to the address that was specified as <code>redirect_uri</code> in the original authentication request. </p><br><p>  When using Implicit Flow, <a href="http://openid.net/specs/openid-connect-core-1_0.html"><code>   #</code></a> .  This is necessary to ensure that these values ‚Äã‚Äãare available to our application in JavaScript, but are not sent to the web server. </p><br><table><thead><tr><th>  <strong>Name</strong> </th><th>  <strong>Value</strong> </th></tr></thead><tbody><tr><td>  <strong>id_token</strong> </td><td>  Client User Token </td></tr><tr><td>  <strong>access_token</strong> </td><td>  Token with the necessary data to access the API </td></tr><tr><td>  <strong>token_type</strong> </td><td>  Type <code>access_token</code> , in our case <strong>Bearer</strong> </td></tr><tr><td>  <strong>expires_in</strong> </td><td>   <code>access_token</code> </td></tr><tr><td> <strong>scope</strong> </td><td> scopes        </td></tr></tbody></table><br><p> <strong>6. <em></em>  id token   <em>Subject Identifier</em> <em> </em> .</strong> </p><br><p> <strong>oidc-client</strong> <a href=""></a>      state,   nonce    <code>id_token</code> .   ,       (,     <code>sub</code> claim  <code>id_token</code> ).        <code>id_token</code>      <strong>oidc-client</strong>   . </p><br><p>     <code>id_token</code> (      <strong>Network</strong>  ),  ,  payload  -  </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"nbf"</span></span>: <span class="hljs-number"><span class="hljs-number">1505143180</span></span>, <span class="hljs-string"><span class="hljs-string">"exp"</span></span>: <span class="hljs-number"><span class="hljs-number">1505146780</span></span>, <span class="hljs-string"><span class="hljs-string">"iss"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:5000"</span></span>, <span class="hljs-string"><span class="hljs-string">"aud"</span></span>: <span class="hljs-string"><span class="hljs-string">"js"</span></span>, <span class="hljs-string"><span class="hljs-string">"nonce"</span></span>: <span class="hljs-string"><span class="hljs-string">"2bd3ed0b260e407e8edd0d03a32f150c"</span></span>, <span class="hljs-string"><span class="hljs-string">"iat"</span></span>: <span class="hljs-number"><span class="hljs-number">1505143180</span></span>, <span class="hljs-string"><span class="hljs-string">"at_hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"UAeZEg7xr23ToH2R2aUGOA"</span></span>, <span class="hljs-string"><span class="hljs-string">"sid"</span></span>: <span class="hljs-string"><span class="hljs-string">"053b5d83fd8d3ce3b13d3b175d5317f2"</span></span>, <span class="hljs-string"><span class="hljs-string">"sub"</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"auth_time"</span></span>: <span class="hljs-number"><span class="hljs-number">1505143180</span></span>, <span class="hljs-string"><span class="hljs-string">"idp"</span></span>: <span class="hljs-string"><span class="hljs-string">"local"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"website"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://bob.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"amr"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"pwd"</span></span> ] }</code> </pre> <br><p> <code>at_hash</code> ,   <a href=""></a>      <a href="http://openid.net/specs/openid-connect-core-1_0.html"></a> . </p><br><p>  <code>access_token</code>    payload  ,       ,  . </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"nbf"</span></span>: <span class="hljs-number"><span class="hljs-number">1505143180</span></span>, <span class="hljs-string"><span class="hljs-string">"exp"</span></span>: <span class="hljs-number"><span class="hljs-number">1505143480</span></span>, <span class="hljs-string"><span class="hljs-string">"iss"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:5000"</span></span>, <span class="hljs-string"><span class="hljs-string">"aud"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"http://localhost:5000/resources"</span></span>, <span class="hljs-string"><span class="hljs-string">"api1"</span></span> ], <span class="hljs-string"><span class="hljs-string">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"js"</span></span>, <span class="hljs-string"><span class="hljs-string">"sub"</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"auth_time"</span></span>: <span class="hljs-number"><span class="hljs-number">1505143180</span></span>, <span class="hljs-string"><span class="hljs-string">"idp"</span></span>: <span class="hljs-string"><span class="hljs-string">"local"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"role"</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-string"><span class="hljs-string">"scope"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"openid"</span></span>, <span class="hljs-string"><span class="hljs-string">"profile"</span></span>, <span class="hljs-string"><span class="hljs-string">"api1"</span></span> ], <span class="hljs-string"><span class="hljs-string">"amr"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"pwd"</span></span> ] }</code> </pre> <br><p>          ,  ‚Äî     .   <a href="http://www.thread-safe.com/2011/11/openid-connect-tale-of-two-tokens.html"></a> ,       <strong>IdentityServer</strong> . </p><br><p>      ,  <a href=""></a> claims  <code>id_token</code>      . </p><br><p> ,      <code>loadUserInfo</code> ,    <strong>UserInfo Endpoint</strong> .     <strong>UserInfo Endpoint</strong>   claims     <strong>Authorization</strong>   <strong>Bearer</strong> -  <code>access_token</code> ,   claims    JavaScript-    . </p><br><p> <code>loadUserInfo</code>         <code>access_token</code> ,      HTTP-,       . </p><br><h4 id="vyzyvaem-metod-api">   API </h4><br><p>   "Call API". <br>  ajax-   <code>http://localhost:5001/identity</code> . <br>  ,   OPTIONS-   <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS</a> ..          ,     "" ( <code>Authorization</code> , ). </p><br><p>   , ,  <strong>GET</strong> -.  ,     <strong>Authorization</strong>    <strong>Bearer &lt; access_token&gt;</strong> . </p><br><p> <strong>IdentityServer</strong> middleware     .   <strong>IdentityServer</strong> middleware      Asp.Net Core <a href="">JwtBearerMiddleware</a> . </p><br><p>    ,        200. </p><br><h4 id="logout">  Logout </h4><br><p>  GET-  <a href="http://openid.net/specs/openid-connect-session-1_0-17.html"><code>end_session_endpoint</code></a> </p><br><table><thead><tr><th>  <strong>Name</strong> </th><th>  <strong>Value</strong> </th></tr></thead><tbody><tr><td> <strong>id_token_hint</strong> </td><td>   <code>id_token</code> </td></tr><tr><td> <strong>post_logout_redirect_uri</strong> </td><td> URI,    ,    </td></tr></tbody></table><br><p>      ,      . </p><br><h4 id="proveryaem-rabotu-roley">    </h4><br><p>          ,         .        ,    -   ,  -       . </p><br><p>      <strong>alice</strong>    <strong>Get Superpowers!</strong> ,     <strong>bob</strong>     . </p><br><h3 id="drugie-varianty-razvitiya-sobytiy">     </h3><br><h4 id="polzovatel-zhmyot-do-not-allow">   do not allow </h4><br><p>  <strong>Logout</strong>    ,      <br> Username: alice <br> Password: password </p><br><p>    <code>http://localhost:5000/consent</code>  <strong>No, Do Not Allow</strong> . </p><br><p>         <code>http://localhost:5003/callback.html</code> . <br>   ,       URL <code>#error=access_denied</code> ,  <code>signinRedirectCallback</code>    ,     <a href="">   rejected</a> . </p><br><p>   <code>callback.html</code>     catch-,      . </p><br><h4 id="polzovatel-ne-dayot-razresheniya-na-profil">       </h4><br><p>   <code>id_token</code>    URL   <a href="http://jwt.io/"></a> ,       claims,     scope profile. </p><br><p> Claims,     scope profile   <a href="http://openid.net/specs/openid-connect-core-1_0.html"></a> . </p><br><p>    API . </p><br><h4 id="polzovatel-na-dayot-razreshenie-na-api1">      api1 </h4><br><p>     claim api1 </p><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"scope"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"openid"</span></span>, <span class="hljs-string"><span class="hljs-string">"profile"</span></span> ],</code> </pre> <br><p>    Api    401 (Unathorized). </p><br><h4 id="access_token-ustarevaet"> access_token  </h4><br><p>   <code>access_token</code> ,   <strong>Call API</strong> . </p><br><p> API  !   ,  <strong>IdentityServer</strong>  middleware Asp.Net Core,    ClockSkew.    ,                , ,     ,        . <a href=""></a> ClockSkew   5 . </p><br><p>   5   ,   API   401 (Unathorized). </p><br><p> <strong></strong>            401,    <code>access_token</code> . </p><br><h4 id="access_token-obnovlyaetsya"> access_token  </h4><br><p>     <code>app.js</code>   <code>config</code> ,    </p><br><pre> <code class="hljs lua">var <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = { // ... //  <span class="hljs-literal"><span class="hljs-literal">true</span></span>,    access_token   ,   <span class="hljs-literal"><span class="hljs-literal">false</span></span> automaticSilentRenew: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, //     <span class="hljs-string"><span class="hljs-string">""</span></span>     iframe silent_redirect_uri: <span class="hljs-string"><span class="hljs-string">'http://localhost:5003/callback-silent.html'</span></span>, //      oidc-client   access_token accessTokenExpiringNotificationTime: <span class="hljs-number"><span class="hljs-number">60</span></span>, // ... }</code> </pre> <br><p>           <code>access_token</code> .   <strong>Call API</strong>  ,   . </p><br><h4 id="id_token-ustarevaet"> id_token  </h4><br><p>  <code>access_token</code>    API      ,       ,    ,  <code>id_token</code>      .        js-.   <a href="https://stackoverflow.com/a/33443593"></a> . </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>    ,    : </p><br><ol><li>      OpenId Connect Implicit Flow   <strong>IdentityServer</strong>  <strong>oidc-client</strong>   ASP.NET Core 1.1. </li><li>    ,       . </li><li> , ,  ,     ,   ,    . </li></ol><br><h3 id="poleznye-ssylki">  useful links </h3><br><ol><li>  <a href="https://www.scottbrady91.com/Identity-Server/Getting-Started-with-IdentityServer-4"></a> . </li><li>   <a href="https://github.com/IdentityServer/IdentityServer4.Samples">IdentityServer4</a> </li><li>   <a href="https://github.com/IdentityModel/oidc-client-js/tree/dev/sample/public">oidc-client</a> . </li><li> <a href="https://damienbod.com/2016/02/14/authorization-policies-and-data-protection-with-identityserver4-in-asp-net-core/"></a>       ASP.NET Core.     <a href="https://leastprivilege.com/2016/08/21/why-does-my-authorize-attribute-not-work/"></a> . </li><li> <a href="https://leastprivilege.com/2016/08/21/why-does-my-authorize-attribute-not-work/">  </a>     <strong>Authorize</strong>      IdentityServer. </li><li> <a href="http://www.thread-safe.com/2011/11/openid-connect-tale-of-two-tokens.html"></a>     OpenId Connect 2  ‚Äî <code>id_token</code>  <code>access_token</code>  . </li><li>       <a href="https://andrewlock.net/an-introduction-to-openid-connect-in-asp-net-core/"> </a>   OpenId Connect  ASP.NET Core. </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/337784/">https://habr.com/ru/post/337784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337774/index.html">Easy work with lists - RendererRecyclerViewAdapter (part 2)</a></li>
<li><a href="../337776/index.html">Professional penetration testing: the fate of real geeks, fans of the command line or not?</a></li>
<li><a href="../337778/index.html">To root and features were</a></li>
<li><a href="../337780/index.html">BlueBorne's Bluetooth vulnerability affects billions of devices</a></li>
<li><a href="../337782/index.html">BlueBorne exploit on Android, iOS, Linux and Windows: more than 8 billion devices are critically vulnerable</a></li>
<li><a href="../337786/index.html">VMworld 2017 Europe Conference. Day 0</a></li>
<li><a href="../337800/index.html">Two-factor authentication for VPN connections</a></li>
<li><a href="../337802/index.html">The practice of forming requirements in IT projects from A to Z. Part 7. Transfer of requirements into production. Conclusion</a></li>
<li><a href="../337804/index.html">Investigation of information leaks from the carrier‚Äôs corporate database</a></li>
<li><a href="../337806/index.html">Selection: 10 useful tools for an internet marketer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>