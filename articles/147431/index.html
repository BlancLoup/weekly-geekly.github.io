<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Goblin Wars II.NET - the story of creating a network game on C # from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear habrovchane. I present to you my small project - a network 2D shooter on C #. Despite the fact that the visual component is very ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Goblin Wars II.NET - the story of creating a network game on C # from scratch</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear habrovchane.  I present to you my small project - a network 2D shooter on C #.  Despite the fact that the visual component is very simple - in this century you will not be interested in anyone with 2D games, some architectural solutions may interest people who are going to write their own game.  In the article I will talk about options for implementing the key points of the game. <br><a name="habracut"></a><br><h4>  Prehistory </h4><br><br>  Long before I became an electronics engineer, I developed purely software projects.  From the very moment I wrote my first line of code (in the second class, on Turbo Basic, in the ‚ÄúPalace of Pioneers‚Äù), I had no desire to write a game.  I think that almost everyone who started learning to program faced this.  Of course, then there was not enough knowledge for something large-scale, there were only simple text games on the same Turbo Basic and then on Quick Basic.  Sometimes I used scanty BASIC graphics output capabilities ‚Äî for example, there was a game where you had to control a green pixel, running away from red and setting traps in the form of white pixels.  However, as time went on, I learned more and more, and as a result, in the eighth class I decided to write a 2D shooter for two people.  Why for two?  Because the networks were not so common then, and the most accessible multiplayer game mode was Hot-Seat.  At that time, we often fought with friends in Worms and Heroes in this way, but we wanted to drive real-time.  So I decided to write a game where I could run, shoot from various weapons, pick up boxes with supplies, etc. in real time.  - but at the same time, it would be possible to play together.  One player stood out the alphabetic part of the keyboard, the other - the numeric.  Since the mouse was one, it was not used to not give advantages to one of the players.  And since  the monitor was one, the fighting was limited to an unrolled multiple. <br>  So there was Goblin Wars. <br><br><img src="https://habrastorage.org/storage2/0d1/a20/d5a/0d1a20d5a0a52fef269f6f203e76ccb8.jpg"><br>  <i>Game process</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/279/a4b/159/279a4b159eb6c2d9581e46b851c56b55.jpg"><br>  <i>The same</i> <br><br>  The game was written - let Von Neumann have mercy on me - in Visual Basic and used BitBlt to display graphics.  I drew all the graphics myself, to the best of my skills, in 3D Max, including tilesets.  We voiced the game with friends.  The game even had a prehistory, which, briefly, was that goblins used to live on the earth, then people came who began to destroy them, and the goblins had to go underground.  Since then, goblin cities have existed under the major cities of the people.  Goblins collect all kinds of technological rubbish, such as old idle televisions, which were thrown out by people, and construct from them their robots and similar handicrafts.  And since there are few of them left, it was decided to resolve conflicts between cities not by bloody wars, but by special tournaments to which each city sent the best fighter.  These tournaments were called Goblin Wars. <br>  There were quite a few types of weapons in the game - bombs, grenades, a pistol, a machine gun, rockets, distance bombs, mines, a phase gun (teleportator) and - the main feature of the game is phosphoric louse + weapon against it - ABO. <br>  After the goblin launched a phosphoric louse, control switched to it.  It was impossible to stop it, just change the direction of motion.  Crashing into a wall or another goblin, it exploded, causing great damage to the epicenter.  The funniest thing was that if the goblin, her manager, was killed or got into the louse from the ABO, she became ‚Äúwild‚Äù - her speed doubled and she started running around the map uncontrollably, with a distinctive sound rushing to the players who were close and trying to get to them.  In addition, in boxes sometimes a ‚Äúbonus‚Äù fell out, throwing wild lice at once onto the card, which also added a drive.  After the match, stats with ranks were issued: <br><img src="https://habrastorage.org/storage2/2cc/532/488/2cc53248876f12d1152f002a817fb058.png"><br>  <i>Can you become a legendary magician?</i> <br><br>  We very often played Goblins with friends, and also distributed them at school - in the computer science class, people from our and parallel class played goblins leading the teacher with shouts from the ‚ÄúDo you like lice?‚Äù Columns published by goblins.  In general, this game has captured us with something, so even many years later, in the intervals between StarCraft 2, we played no-no-no and played a match-other in goblins to recall the old times.  More than ten years have passed since the first release of Goblin Wars. <br><br><h4>  Goblin Wars II.Net </h4><br><br>  I had the idea to write the second version a long time ago, since now a fast network connection is no longer a problem, I wanted to be able to play with friends over the network, not just 1x1 using a single keyboard.  When I finally matured for writing, I started writing GWII in C ++.  Brought to the state of the alpha version, and something enthusiasm faded.  Not so long ago, the enthusiasm returned again, and I, having chosen, this time C #, decided to implement my plans.  Initially, the plans were more ambitious - at least to replace the top view with isometry.  But since I had very little time (work, other projects), and I still didn‚Äôt observe an artist, in the end I decided to do this: I should take the graphics to the maximum from the old ones, redrawn, except what looked at all disgustingly (for example, the tiles in the new version of steel were 64x64 and they just needed to be redrawn somehow), leave the view from above, but implement a network game, remove unused weapons (such as bombs and grenades in old ones), etc. <br>  Immediately present a screenshot of what happened: <br><img src="https://habrastorage.org/storage2/f78/f6b/348/f78f6b348ecae7989836038b02eef57d.png"><br>  <i>In a new light</i> <br><br>  And below, at the request of readers - a gameplay video, a test three-minute match with a friend. <br>  Unfortunately, the rest of the friends are now out of reach, so I had to play 1x1. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ALwSUeieUxM%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhiuthFl0eYjVyvCuoDzZg4MnCwzzg" frameborder="0" allowfullscreen=""></iframe><br><br>  So what are Goblin WarsII? <br>  The game is built on the principle of client-server, all calculations are conducted on the server side, the client is designed exclusively for rendering.  Drawing is done using OpenGL, sound is output through OpenAL, images are loaded by DevIL.  Network Library - Lindgren network.  OpenGL, OpenAL and DevIL are connected to sharpe through the Tao Framework wrapper. <br>  No ready-made engines were used - yes, I know, it would probably be possible to take a ready-made 3D engine and get the best result, but I just wanted to write everything myself from the very beginning, from scratch, enjoy my ‚Äúbicycle‚Äù. <br>  The architecture of this bike, and I will present in the next chapters of the article. <br><br><h4>  Game architecture: general overview </h4><br><br>  What I would like to mention first of all is modular game.  Very modular.  In the sense that all subsystems of the game are separate dll-ki, most of which are in no way connected with each other, and those that are connected know only about the interfaces.  This makes it easy to throw out one part of the system and replace it with another.  Do not like the network on UDP, lindgren network?  Please take one dll, Network.dll, and write your own, not forgetting the implementation of interfaces INetworkClient, INetworkServer.  For example, to implement a single player, the so-called Zero-network was implemented, which is simply a connection for the client and the server without any networks ‚Äî a pure invocation of interface methods.  At the same time, the client and server do not care at all whether they work with Zero-Network or with a real network. <br>  The same can be said with respect to, for example, graphics.  The architecture allows you to rewrite Graphics.dll, replacing OpenGL output with anything - even WinAPI, even D3D.  Also replacing one dlki, in principle, you can replace the top view on the isometry, if such a desire arises. <br>  Below is the dependency harf at the build level: <br><br><img src="https://habrastorage.org/storage2/aa4/51d/c02/aa451dc02a8b54e98721490a14840e51.jpg"><br>  <i>Game architecture</i> <br><br>  GoblinWarsII.exe and Server.exe are actually executable files.  They contain only a few lines, because  All logic is in dlki.  For example, all server code looks like this: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> game = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Game(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> networkServer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UDPGameServer(game, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(args[<span class="hljs-number"><span class="hljs-number">2</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> matchParameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatchParameters {Difficulty = DifficultyLevel.Easy, FragLimit=<span class="hljs-number"><span class="hljs-number">0</span></span>, TimeLimit = <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>.Parse(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]), MapName=args[<span class="hljs-number"><span class="hljs-number">1</span></span>]}; game.StartMatch(matchParameters); networkServer.Start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Console.ReadKey().KeyChar != <span class="hljs-string"><span class="hljs-string">'q'</span></span>); game.Halt(); networkServer.Stop(); } }</code> </pre> <br><br>  Common.dll contains common declarations and helper classes, such as a special timer.  Basically, there is a description of data structures, for example - enum types of items that are needed by both the server and the client: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ItemType { PistolBullet, AKBullet, ShotgunBullet, Rocket, Louse, AVOBullet, PhaseBullet, Trapped, StronglyTrapped, WildLouse, LouslyTrapped, PoisonTrapped, FirstAid, MegaHealth, AVOModifier, Boost, LousePack, Equipment, GunabadianHello, LouseHunterEquipment }</code> </pre><br><br>  Network.dll, of course, contains the network logic, the connecting client and server together. <br>  ServerLogic.dll is used only by the server and contains all the game logic, this is where all the calculations for game objects take place. <br>  Media.dll is used only by the client and contains the logic of displaying server objects on the client (I will focus on this in more detail later). <br>  And finally, Graphics.dll contains the code for directly drawing objects. <br>  Almost every dll starts its own processing thread and does not stop others - ServerLogic - the thread of calculating game logic, Network - the reception-transfer threads, Media - the processing thread of media objects (representing server objects on the client), Graphics - the render thread. <br>  We turn to the consideration of a specific implementation, and we begin with the implementation of the server. <br><br><h4>  Game architecture: server </h4><br><br>  So, as was already clear from the above code, the main in the server is the Game class, an instance of which is created in the Server.exe binary: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> game = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Game();</code> </pre><br><br>  All other systems can only see the server logic interface, which looks like this: <br><br><img src="https://habrastorage.org/storage2/cdf/20c/08b/cdf20c08b53f105971b2e287b2a13be6.jpg"><br>  <i>Server architecture</i> <br><br>  Thus, from the outside you can start the game, add or remove players, get various information about the match, and, most importantly, get all the states of the game objects. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IList&lt;GameObjectState&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllObjectStates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span></code> </pre>  - One of the most important functions of the game. <br>  It is she who returns a snapshot of the world through which it can be fully drawn.  Thus, the network system in its thread of transmission simply periodically requests Game from the Game world, in order to further serialize it, compress it and transfer it to clients. <br>  Interaction with a game object that represents, in fact, a player (for example, transferring actions from a client to it) also takes place not directly, but through the IPlayerDescriptor interface: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPlayerDescriptor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PerformAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PlayerAction action</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">Tuple&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function">, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLookCoords</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLoginTime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br>  As a result, we obtain what was described above - the subsystem with the game logic completely separated from the rest.  Let us now consider how, in fact, it works inside. <br>  "Top layer" looks pretty standard thread safe Dictionary &lt;ID_Object, Object&gt; - <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>, GameObject&gt; gameObjects;</code> </pre><br><br>  and the processing cycle that is caused by a specified number of times per second and counting the time elapsed since the last miscalculation: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectProcessingTaskRoutine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { quantTimer.Tick(); Statistics.TimeQuantPassed(quantTimer.QuantValue); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMatchParameters.TimeLimit &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; Statistics.MatchTime &gt; currentMatchParameters.TimeLimit) EndMatch(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gameObject <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gameObjects) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!gameObject.Value.Destroyed()) gameObject.Value.Process(quantTimer.QuantValue); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gameContext.RemoveObject(gameObject.Key); } }</code> </pre><br><br>  GameContext is a class whose link to the instance is passed to the designer of all game objects created, it contains all the necessary information about the game, such as a link to the game map, a list of players, and methods for adding a new object to the game so that you do not need to pass the link on myself <br><pre> <code class="cs hljs">ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>, GameObject&gt; gameObjects;</code> </pre><br>  All fields of the GameContext are immutable, readonly, which excludes the ‚Äúcorruption‚Äù of the context by game objects. <br><br>  But the implementation of game objects is more interesting.  Initially, I intended to do quite trivially, creating a basic GameObject and inheriting concrete implementations from it, such as Player, Bomb, etc.  But this approach is not without flaw.  When there are a lot of classes, and especially when there are many <i>subclasses</i> , such as ‚Äúteleport objects‚Äù, ‚Äúobjects with health‚Äù - the whole architecture becomes cumbersome and inconvenient. <br>  The slightest change makes it redraw from the very beginning.  Therefore, I turned to the experience of the creator of the game Dungeon Siege, which I learned from his presentation. <br>  In short, the essence is as follows: all game objects are only containers for game components and do not contain logic and data, except for the message exchange logic.  Components are complete blocks containing the necessary logic and data for some fixed task.  The interaction between objects occurs through the exchange of messages that are routed to components. <br><br>  What does this give us?  This provides a very, very flexible and convenient way to implement game logic.  What an object will become in the game world is now determined only by the set of its components and their design parameters.  Once you have implemented a component with some part of the logic, you can shove it into any game object without confusing methods of decomposing into classes, unlike the traditional approach. <br>  Moreover, now all objects can be made of one class, GameObject, and the list of components can be loaded from some config on the go. <br><br>  In this case, I have not yet taken advantage of the last item - I left the download from the config to ‚Äúlater‚Äù and did different classes of objects, but don't let that bother you - this was done only to not load the configuration from external files, other differences between the classes Player, Bomb, Bullet, etc.  does not exist, and as soon as my hands reach this, they will all be replaced by a single GameObject. <br>  Let's now take a closer look at how this is all implemented.  So, IGameObject is at the core of everything: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IGameObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ComponentMessageBase msg</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">GameObjectState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-function">IComponent[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetComponents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ushort</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-function">GameObjectType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGOType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-function">IGameObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetParent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroyed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br>  A game object can only get such an interface of another object, which provides additional protection from misuse - a third-party object can neither add components to an object, nor interact with them in any way, just check for the presence of one or another component, for which IComponent is present [ ] GetComponents (); <br><br>  The interface implementation, GameObject, contains the logic of exchanging messages and receiving state (which is used when getting a snapshot of the world): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ComponentMessageBase msg</span></span></span><span class="hljs-function">)</span></span> { messageQueue.Enqueue(msg); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GameObjectState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> states = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ComponentState&gt;(components.Count); <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (lockObj) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Destroyed()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> component <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> components) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state = component.GetState(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) states.Add(state); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObjectState(Id, type, states); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> quantValue</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Destroyed()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (lockObj) { SendMessage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MsgTimeQuantPassed(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, quantValue)); <span class="hljs-comment"><span class="hljs-comment">//    ,     while (messageQueue.Count &gt; 0) { ComponentMessageBase msg; messageQueue.TryDequeue(out msg); foreach (var component in components) component.ProcessMessage(msg); } } }</span></span></code> </pre><br><br>  The blocking object is necessary in order to ensure that the state of the object remains unchanged at the time of the network request. <br><br>  Messages add up to a queue view <br>  private readonly ConcurrentQueue messageQueue; <br><br>  List <pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;Component&gt; components;</code> </pre>  contains, of course, all the components of the object. <br><br><h4>  Game architecture: components </h4><br><br>  The base component class contains, above all, three main functions: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ComponentMessageBase msg</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ComponentState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Probe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><br>  ProcessMessage must be redefined as a successor, since it is she who is responsible for the logic implemented by the component. <br>  GetState, the only function available through the IComponent interface to external systems, returns the shared state of the object, if any - for example, health or coordinates.  If the object does not have a shared state, then it can be not overridden. <br>  The Probe function checks component dependencies.  If the component does not depend on anything, then you can not touch it.  If there is a dependency - like, for example, the Collector component is dependent on the Inventory component, then it should be checked in this function.  It is used not only for checking, but also for caching references to corresponding dependencies, in order not to look for them again each time. <br>  Now the above may look foggy, but let's look at examples, and everything should become clear. <br>  How, for example, in such an architecture to make a bullet?  Rocket? <br><br>  So, the first implemented component was SolidBody.  This component is responsible for the physical embodiment of the object in the game world - that is, for its coordinates, interaction with the map and dimensions. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SolidBody</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameObject owner, GameContext gameContext, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sizeX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sizeY, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> angle = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> semisolid = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span></code> </pre><br><br>  Like all components, the Owner is the owner object and the gameContext is the game context from which, in this case, it takes a link to the GameMap. <br>  The rest is already specific for SolidBody ‚Äî the coordinates of the object, its physical dimensions, the angle of rotation, and a pair of flags ‚Äî to optimize calculations, objects that should not collide with each other are called semisolid ‚Äî collisions are calculated only for solid-solid and solid-semisolid, two semisolid do not collide.  These include, for example, bullets that cannot collide with each other. <br><br>  The bullet will certainly be SolidBody, because  has coordinates and dimensions.  Moreover, it will be semisolid, since we do not need useless miscalculations of collisions of bullets with each other, this must be remembered. <br><br>  I will omit the implementation of SolidBody at the moment, since it is quite large. <br>  I will only note that in order to speed up the calculations, a list of objects that relate to it is attached to each map tile.  When you move an object around the map, these lists are updated.  Thus, when calculating collisions, we do not need to count the distances from each object to each, but rather quickly select the tiles in the radius of interest and only calculate the distances for the objects that touch them. <br><br>  Next, we will implement a component that is the concentration of logic for all bullets, rockets and other projectiles ‚Äî it will be responsible for a simple, uniform, straight-line flight. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Projectile</span></span> : <span class="hljs-title"><span class="hljs-title">Component</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SolidBody solidBody; <span class="hljs-comment"><span class="hljs-comment">//  ,    SolidBody! private readonly double speed; //  ‚Äì   public Projectile(GameObject owner, double speed) : base(owner) { this.speed = speed; } public override void ProcessMessage(ComponentMessageBase msg) { //    ‚Äì   ,        . if (msg.MessageType == MessageTypes.TimeQuantPassed) ProcessTimeQuantPassed(msg as MsgTimeQuantPassed); } //   .      ,      ,   ,     private void ProcessTimeQuantPassed(MsgTimeQuantPassed msg) { double dT = msg.MillisecondsPassed; var solidState = (SolidBodyState)solidBody.GetState(); byte angle = solidState.Angle; double dX = SpecMath.Cos(angle) * speed * dT, dY = SpecMath.Sin(angle) * speed * dT; // ,        ‚Äì      ,        .         ‚Äì     . solidBody.AppendCoords(dX, dY, angle); } //  ,    . GetOwnerComponent,    ,     .    ,   ,      .   . public override bool Probe() { solidBody = GetOwnerComponent&lt;SolidBody&gt;(); return solidBody != null; } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it should become more clear. </font><font style="vertical-align: inherit;">To make it completely clear, I will demonstrate another component, very simple, and without dependencies - DieOnTTL. </font><font style="vertical-align: inherit;">As the name suggests, the component is responsible for the death of an object after a specified period of time:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DieOnTTL</span></span> : <span class="hljs-title"><span class="hljs-title">Component</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> ttl; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> lifetime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DieOnTTL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameObject owner, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ttl</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">owner</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ttl = ttl; lifetime = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ComponentMessageBase msg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.MessageType == MessageTypes.TimeQuantPassed) ProcessTimeQuantPassed(msg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MsgTimeQuantPassed); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessTimeQuantPassed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MsgTimeQuantPassed msg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dT = msg.MillisecondsPassed; lifetime += dT; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lifetime &gt;= ttl) <span class="hljs-comment"><span class="hljs-comment">//     Owner.SendMessage(new MsgDeath(Owner)); } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How, then, will our bullets look like? </font></font> Very simple.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here, for example, a pistol bullet: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PistolBullet</span></span> : <span class="hljs-title"><span class="hljs-title">GameObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PistolBullet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameContext context, IGameObject parent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> angle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> speed, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ttl</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context, GameObjectType.PistolBullet, parent</span></span></span><span class="hljs-function">)</span></span> { AddComponents( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SolidBody(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, context.GameMap, x, y, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, angle, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DieOnTTL(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, ttl), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Projectile(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, speed), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DieOnCollide(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObjectType[]{GameObjectType.Player, GameObjectType.WildLouse}, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>[]{parent.GetId()}), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DecayOnDeath(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I have already said, a separate class was created only because it has not yet reached its hands before loading the config from the outside. What does this code do? First of all, it transfers GameObjectType.PistolBullet to the basic GameObject constructor, the GameObjectType.PistolBullet type </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the client will go, this is what the various components that are important for collisions with the bullet and similar interactions will check. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All that remains is to add components that will make a bullet a bullet. In this case, the parameters are transmitted from the outside, to the constructor of the object itself, and from there to the constructors of the components. But no one bothers to hard-write them right here in the code, or download along with a list of components from some XML.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all - SolidBody, because the bullet is quite a physical object, having coordinates and colliding with others. Do not forget to specify true in the semisolid parameter - we don‚Äôt need extra calculations. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bullets must disappear after a certain flight time, even if they do not encounter anything. So let's add the DieOnTTL object that we have already created with the lifetime parameter. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The bullet must fly forward. We implemented this in Projectile, we add it with the appropriate speed.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The bullet must die from the collision. Add DieOnCollide. I omitted its implementation, but it is quite trivial - MsgCollide sends messages to SolidBody, so we don‚Äôt need to re-implement anything, just check MsgCollide.CollidedObject for who we are all the same. The parameters here indicate that the collide with whom we should not ignore, said the collider with the walls and the object ID that we need to ignore is specified - the ID of the bullet that created this bullet, the parent, is transferred so that the bullets do not hurt themselves. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And finally, the last thing we need to do is to somehow react to the messages that we have died - DecayOnDeath will just silently kill the object when receiving the message MsgDeath. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, what if we want a rocket? There is nothing easier:</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Rocket</span></span> : <span class="hljs-title"><span class="hljs-title">GameObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rocket</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameContext context, IGameObject parrent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> angle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> speed, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ttl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radius</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context, GameObjectType.Rocket, parrent</span></span></span><span class="hljs-function">)</span></span> { AddComponents( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SolidBody(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, context.GameMap, x, y, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, angle, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DieOnTTL(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, ttl), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Projectile(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, speed), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DieOnCollide(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[]{GameObjectType.Player, GameObjectType.WildLouse}, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>[]{parrent.GetId()}), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExplodeOnDeath(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,context, radius) ); } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We do the same, except that the rocket is a little bigger than the bullet (the geometric dimensions of SolidBody are larger), and the rockets no longer collide with objects like WildLouse, which, as you probably noticed, were on the list of colliding objects. in the designer of DieOnCollide in a bullet, and most importantly - the rocket does not quietly die at death, but explodes loudly, so instead of DecayOnDeath we add ExplodeOnDeath with the parameter of the radius of destruction.</font></font> Everything!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We made a rocket on almost the same components - no rewriting of the existing code. All we needed was to make another component responsible for the explosion at death (it behaves just like DecayOnDeath, but creates a new object at the point of death, the Explosion), which no doubt will be useful elsewhere. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, also do not forget to specify the appropriate type of object - GameObjectType.Rocket. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A teleport bullet, for example, differs only in the presence of the Teleporter component:</font></font><br><br><pre> <code class="cs hljs"> AddComponents( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SolidBody(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, context.GameMap, x, y, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, angle,<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DieOnTTL(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, ttl), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Projectile(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, speed), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Teleporter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, context), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DieOnCollide(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObjectType[] {}, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>[] { parrent.GetId() }), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhaseOnDeath(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, context, radius) );</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He is responsible for teleporting objects containing the Teleportable component. </font><font style="vertical-align: inherit;">To make an object teleported you simply add Teleportable to it in the list of components. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The vast majority of components do not even require any additional inheritance, which makes the whole architecture very flexible and transparent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will give a list of components used in the game:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AOE - is responsible for the area of ‚Äã‚Äãeffect exposure. </font><font style="vertical-align: inherit;">Objects within the radius of action are sent a MsgAOE message with an Effect field that shows how strong the effect is (it is calculated depending on the distance to the epicenter; an impact profile can be passed to the component designer to customize how the effect will change with distance). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Used by a teleportation bullet.</font></font></li><li> BaseModifierManager ‚Äì ,   .      ¬´ ¬ª, ¬´¬ª   ¬´¬ª,       -     .   ,   ,       : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessModifier</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ItemType itemType, ModifierDescriptor modifier, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> quantValue</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Äì  ,     ( , ) <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModifierAcquired</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ItemType itemType, ModifierDescriptor modifier</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Äì      <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModifierLost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ItemType itemType, ModifierDescriptor modifier</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Äì ,     </li><li> BaseWeapon ‚Äì   ,   .        ,    ,   ‚Äì     WeaponDescriptor',      .     <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Shoot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WeaponDescriptor weaponDescriptor, SolidBody solidBody</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Äì   ,    ,    <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OutOfAmmo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WeaponDescriptor weaponDescriptor, SolidBody solidBody</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Äì    <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cooldowning</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WeaponDescriptor weaponDescriptor</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Äì   </li><li> Collectable ‚Äì ,        Collector  MsgItemsAvailable,  ¬´ ,  ¬ª </li><li> Collector ‚Äì , ,  MsgItemsAvailable    . </li><li>  DecayOn‚Ä¶  DieOn‚Ä¶    . </li><li> Healthy ‚Äì       .   MsgDeath     0. </li><li> Inventory ‚Äì -,        .  ,    ‚Äì , Weapon  .. </li><li> Projectile ‚Äì  . </li><li> SolidBody ‚Äì   ,   ‚Äì , .      FindPath     . </li><li> Walker ‚Äì  Projectile,   ¬´¬ª  ‚Äì    ,    MsgWalk.    MsgWalk     Direction.Stop </li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is an almost complete list of the main components of the game, not tied to the implementation. This is part of the engine. I also implemented several components that are directly related to GoblinWars - these include implementations of the heirs of BaseWeapon and BaseModidierManager, which implement already specific processing, WildLouseLogic is the component responsible for the behavior of wild lice, etc. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External systems, or rather the network, interacts with the player, as already mentioned, with the same messages. To do this, the network jerks the corresponding PlayerDescriptor for the PerformAction () method; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation of this method is the usual creation of messages and sending them to PlayerRescriptor.PlayerObject.SendMeddage () depending on the desired Action.</font></font><br><br><h4>  Conclusion </h4><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, in principle, everything that forms the basis of ServerLogic.dll. In the next article I will talk about the network part of the server and the client and its interaction with other subsystems. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I am not going to post the full source code yet, but if someone has any questions about the implementation, I'm ready to answer. The game itself on the test lay out at the end of the last article, if anyone is interested. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there are artists who are ready to redraw graphics purely for their own pleasure, I will be very grateful. All the graphics here are simple two-dimensional sprites, you need to draw goblin in 8 directions, phosphoric louse in 8 directions and, most importantly, tiles, but now they are sorely lacking.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, in principle, interested in porting the client to other platforms, but I don‚Äôt want to do this alone. </font><font style="vertical-align: inherit;">If anyone wants to try porting to a mobile system or to the web, on some HTML5, this is also discussed.</font></font><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/147431/">https://habr.com/ru/post/147431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147423/index.html">135 launches of space shuttles in one video</a></li>
<li><a href="../147424/index.html">Photo album</a></li>
<li><a href="../147427/index.html">The quantum computer is two seconds closer to reality.</a></li>
<li><a href="../147428/index.html">Atomic shadow photography</a></li>
<li><a href="../147429/index.html">Survarium development video diary</a></li>
<li><a href="../147432/index.html">Sequential saving of settings using AJAX and jQuery queues</a></li>
<li><a href="../147434/index.html">Windows 8 Contracts and Extensions</a></li>
<li><a href="../147435/index.html">Integration of Robokassa into ActiveMerchant</a></li>
<li><a href="../147436/index.html">One bit - one molecule</a></li>
<li><a href="../147437/index.html">Ukrainian students have created sign-to-speech gloves</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>