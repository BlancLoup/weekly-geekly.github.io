<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Type casting on Go</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I share a simple library that I constantly use. Go works well with JSON, but often there is a lack of a set of functions to cast an interface {} to so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Type casting on Go</h1><div class="post__text post__text-html js-mediator-article">  I share a simple library that I constantly use.  Go works well with JSON, but often there is a lack of a set of functions to cast an interface {} to some type.  Even defining a canonical structure for marshaling JSON, over time you have to define an additional field, calling it Extra interface {}.  That's about what we have in practice. <br><a name="habracut"></a><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Message <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { store <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Type <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"type"`</span></span> Session <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"session,omitempty"`</span></span> Data <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"data,omitempty"`</span></span> Text <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"text,omitempty"`</span></span> Name <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name,omitempty"`</span></span> Time <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`json:"time,omitempty,string"`</span></span> ServerId <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`json:"serverId,omitempty,string"`</span></span> Extra <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} <span class="hljs-string"><span class="hljs-string">`json:"extra,omitempty"`</span></span> }</code> </pre> <br><br>  Why the canonical approach does not work well.  The main source of JSON is JavaScript from a web browser.  JavaScript represents all numbers as double.  JavaScript may round int64, for example <br><br><pre> <code class="go hljs"> fmt.Println(time.Now().UnixNano())</code> </pre><br>  will issue 1428308621182823638 <br><pre> <code class="javascript hljs">javascript:alert(<span class="hljs-number"><span class="hljs-number">1428308621182823638</span></span>)</code> </pre><br>  and this is already <br><img src="https://habrastorage.org/files/4c5/32b/994/4c532b99464c4daea5521d43349f3f77.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      therefore, some numbers can be defined as strings using the `json:", string "` tag, but this will not work if the user does not put quotes around the number. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> X <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Time <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`json:"time,omitempty,string"`</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m1 <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} e := json.Unmarshal([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">`{"x":1,"y":{}}`</span></span>), &amp;m1) fmt.Println(e, m1) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x X e = json.Unmarshal([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">`{"time":1}`</span></span>), &amp;x) fmt.Println(e, x) e = json.Unmarshal([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">`{"time":"1"}`</span></span>), &amp;x) fmt.Println(e, x) }</code> </pre><br>  <a href="http://play.golang.org/p/2rqL7pyQ7Y">Playground</a> <br><br>  {"Time": 1} - did not work <br><br>  It‚Äôs hard to imagine how much effort the caliper of the web service spends, even when writing in bold italics in the documentation that the numbers need to be passed in quotes, people will still pass them on anyway. <br><br>  The opposite situation is also possible, if you need numbers in JSON, then users can pass a number as a string, because (in PCP works) the &lt;input /&gt; tag returns the entered numbers as strings, which means strings can get into the JSON web service instead of numbers. <br><br>  Often easier to write faster <br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m1 <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} e := json.Unmarshal([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">`{"x":1,"y":{}}`</span></span>), &amp;m1) fmt.Println(e, m1)</code> </pre><br><br>  and there are not enough laconic functions to bring the interface {} to a string or [] interface {}, so I defined them in my <a href="https://github.com/CossackPyra/pyraconv">pyraconv</a> package. <br><br>  My functions do not return nil.  For example, pyraconv.ToStringArray () always returns [] string {} instead of nil, pyraconv.ToInt64 () - always returns one int64 parameter without an error, which means you can write int (pyraconv.ToInt64 (x)) <br><br>  I do not pretend that this way I should parse any JSON anytime, anywhere, but I find this code very useful. <br><br>  List of features: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToBool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span></code> </pre> <br>  ToBool converts interface {} to bool <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToInt64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int64</span></span></span></span></code> </pre> <br>  ToInt64 converts interface {} to int64 <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToInterfaceArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> []</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interface</span></span></span></span>{}</code> </pre> <br>  ToInterfaceArray converts interface {} to [] interface {} and does not return nil <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToInterfaceMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function">]</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interface</span></span></span></span>{}</code> </pre> <br>  ToInterfaceMap converts interface {} to map [string] interface {} and does not return nil <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span></code> </pre> <br>  ToString converts interface {} to string <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToStringArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> []</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span></code> </pre> <br>  ToStringArray converts interface {} to [] string and does not return nil <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToStringMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function">]</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span></code> </pre> <br>  ToStringMap converts interface {} to map [string] string and does not return nil <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloneObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span></code> </pre> <br>  CloneObject creates a copy of the object using serialization from the gob package.  It can be more efficient to transfer a copy of an object to a gorutin for parallel processing than to use a locking mechanism. <br><br>  An example of a web service handler using pyraconv when processing JSON. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_ctrl_channel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> r.Method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span> { b, e := ioutil.ReadAll(r.Body) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">`{ "error": true, "no":1 }`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m1 <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} e = json.Unmarshal(b, &amp;m1) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">`{ "error": true, "no":2 }`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } cmd := m1[<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cmd == <span class="hljs-string"><span class="hljs-string">"add"</span></span> { id := pyraconv.ToString(m1[<span class="hljs-string"><span class="hljs-string">"id"</span></span>]) url := pyraconv.ToStringArray(m1[<span class="hljs-string"><span class="hljs-string">"urls"</span></span>]) service.UpdateStream(url, id) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cmd == <span class="hljs-string"><span class="hljs-string">"delete"</span></span> { id := pyraconv.ToString(m1[<span class="hljs-string"><span class="hljs-string">"id"</span></span>]) service.DelStream(id) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } } }</code> </pre><br><br>  Fork <a href="https://github.com/CossackPyra/pyraconv">pyraconv</a> on health.  Enjoy your meal. <br><br><pre> <code class="bash hljs">go get github.com/CossackPyra/pyraconv</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/255043/">https://habr.com/ru/post/255043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255027/index.html">DevCon 2015: announcement of the speakers - representatives of the community</a></li>
<li><a href="../255029/index.html">Creation of microservices</a></li>
<li><a href="../255033/index.html">What is under the hood of a dynamic magnetic strip?</a></li>
<li><a href="../255037/index.html">We start CloudLITE.ru cloud resource store</a></li>
<li><a href="../255039/index.html">Payler: PCI DSS Certification Update Updated to Version 3.0 - DONE</a></li>
<li><a href="../255045/index.html">.NET development: switching between DEV and PROD environments. Part one</a></li>
<li><a href="../255047/index.html">We collect your own smartphone</a></li>
<li><a href="../255049/index.html">Life hacking: How to combine two different commands in the Slack messenger</a></li>
<li><a href="../255051/index.html">Search for images in Android using Flickr</a></li>
<li><a href="../255053/index.html">MOOC Video Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>