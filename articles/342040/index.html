<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What should be the size of a thread pool?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our article Stream API & ForkJoinPool, we already talked about the possibility of changing the size of the thread pool, which we can use in paralle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What should be the size of a thread pool?</h1><div class="post__text post__text-html js-mediator-article">  In our <a href="https://habrahabr.ru/company/otus/blog/338770/">article Stream API &amp; ForkJoinPool,</a> we already talked about the possibility of changing the size of the thread pool, which we can use in parallel handlers using the Stream API or Fork Join.  I hope this information came in handy when, when you were in the position of Senior Java Developer, you were able to increase the performance of the system you developed by changing the default pool size.  Since our <a href="https://otus.pw/82dr/">courses</a> , in general, are sharpened on the transition a step above from junior and middle above, a part of the program is based on the basic questions asked during interviews.  One of which is: ‚ÄúYou have an application.  And there is a task using the Stream API or Fork Join, which can be parallelized.  Under what conditions can you find it reasonable to change the default size of the thread pool?  What size will you offer in this case? ‚Äù <br><br>  You can try to answer this question yourself before reading further to test your own readiness for such an interview at the moment. <br><br>  To back up the theoretical reasoning with real numbers, we suggest driving a small benchmark for the standard Arrays.parallelSort () method, which implements a kind of merge sort algorithm, and executed on ForkJoinPool.commonPool ().  Run this algorithm on the same large array with different commonPool sizes and analyze the results. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/kn/ax/ri/knaxribo_ca7iynax6dyiazkdds.jpeg"><br><a name="habracut"></a><br>  The machine on which the benchmark was running has 4 cores and the Windows operating system that is not the most suitable for server applications, overloaded with background services, so the results show quite a significant variation, which nevertheless does not hurt to see the essence of things. <br><br>  The benchmark is written using <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> and looks like this: <br><br><pre><code class="java hljs">``` <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.klimakov; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.openjdk.jmh.annotations.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.TimeUnit; <span class="hljs-meta"><span class="hljs-meta">@Fork</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Warmup</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Measurement</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.AverageTime ) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.MICROSECONDS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyBenchmark</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Benchmark) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BenchmarkState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SEED = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ARRAY_LENGTH = <span class="hljs-number"><span class="hljs-number">1_000_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BOUND = <span class="hljs-number"><span class="hljs-number">100_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] array; <span class="hljs-meta"><span class="hljs-meta">@Setup</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(SEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.array = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[ARRAY_LENGTH]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.array.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.array[i] = random.nextInt(BOUND); } } } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] defaultParallelSort(BenchmarkState state) { Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] twoThreadsParallelSort(BenchmarkState state) { System.setProperty( <span class="hljs-string"><span class="hljs-string">"java.util.concurrent.ForkJoinPool.common.parallelism"</span></span>, <span class="hljs-string"><span class="hljs-string">"2"</span></span>); Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] threeThreadsParallelSort(BenchmarkState state) { System.setProperty( <span class="hljs-string"><span class="hljs-string">"java.util.concurrent.ForkJoinPool.common.parallelism"</span></span>, <span class="hljs-string"><span class="hljs-string">"3"</span></span>); Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] fourThreadsParallelSort(BenchmarkState state) { System.setProperty( <span class="hljs-string"><span class="hljs-string">"java.util.concurrent.ForkJoinPool.common.parallelism"</span></span>, <span class="hljs-string"><span class="hljs-string">"4"</span></span>); Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] fiveThreadsParallelSort(BenchmarkState state) { System.setProperty( <span class="hljs-string"><span class="hljs-string">"java.util.concurrent.ForkJoinPool.common.parallelism"</span></span>, <span class="hljs-string"><span class="hljs-string">"5"</span></span>); Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] tooLargePoolParallelSort(BenchmarkState state) { System.setProperty( <span class="hljs-string"><span class="hljs-string">"java.util.concurrent.ForkJoinPool.common.parallelism"</span></span>, <span class="hljs-string"><span class="hljs-string">"128"</span></span>); Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] singleThreadParallelSort(BenchmarkState state) { System.setProperty( <span class="hljs-string"><span class="hljs-string">"java.util.concurrent.ForkJoinPool.common.parallelism"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>); Arrays.parallelSort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] serialSort(BenchmarkState state) { Arrays.sort(state.array); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.array; } } ```</code> </pre> <br>  Having executed this code, we got the following final results (in fact, several runs were performed, the numbers were slightly different, but the overall picture remained unchanged): <br><br><img src="https://habrastorage.org/webt/bg/dj/gw/bgdjgwo-s5fn3d_f2nycpjwegps.png"><br><br>  So, the winner was fourThreadsParallelSort.  In this test, we set the size of the pool equal to the number of cores on my machine, and therefore one more than the default pool.  Nevertheless, the fact of winning this micro benchmark does not mean that you should determine in your application the size of commonPool equal to the number of cores, and not use less for one worker, as JDK developers suggest.  We would suggest accepting their point of view and for most applications never changing the size of commonPool, however, if we want to squeeze the maximum out of the machine and are ready to prove that the game is worth the more common CPU utilization with more general macro benchmarks, setting commonPool equal to the number of cores.  Do not forget that system threads, such as the Garbage Collector, will compete with your pool for CPU time and the operating system scheduler will interrupt your threads by making context switches. <br><br>  defaultParallelSort - was in second place.  Pool size - 3 threads.  During execution, a CPU load of about 70% was observed, in contrast to 90% in the previous case.  Consequently, the reasoning that the main program thread from which we call parallel sorting becomes a full-fledged worker of the join join problem turned out to be wrong. <br><br>  fiveThreadsParallelSort showed us how we begin to lose efficiency by setting the size of the pool only one more than the number of cores.  This test lost a little to the default, while the utilization of the CPU was about 95%. <br><br>  tooLargePoolParallelSort - showed that if we continue to increase the size of the pool (in this case, up to 128 threads), we will continue to lose efficiency and utilize the processor even more closely (about 100%). <br><br>  twoThreadsParallelSort - turned out to be in the last place in the rating, and demonstrated that if we simply without any reasons leave one of the cores out of work, then the result will be mediocre. <br><br>  You may ask, but what about serialSort and singleThreadParallelSort?  And nothing.  They simply cannot be compared with the other options, so there‚Äôs no merge sort inside at all, but a completely different algorithm, DualPivotQuickSort, and on different input data can show results both inferior to the tested algorithm and superior to them.  We can say more, on most random arrays that were considered, DualPivotQuickSort significantly overtook Arrays.parallelSort, and it was just lucky to generate this time an array in which the parallelSort showed the best results.  Therefore, we decided to include this particular array in the benchmarks so that you would not think that parallelSort never makes sense to use at all.  Sometimes it has, but do not forget to check it and prove it with good tests. <br><br>  Finally, let's try to answer the question: ‚ÄúIn what cases can it be reasonable to change the size of a commonPool?‚Äù.  We have already considered one case: if we want to dispose of CPUs more densely, then it may make sense to set the size of commonPool equal to the number of cores, and not one less than the default value.  Another case may be the situation when others are running simultaneously with our application, and we want to manually divide the processor cores between applications (although it seems that a docker for these purposes would be more appropriate).  And finally, it may turn out that the tasks that we really want to place in the Fork Join Pool are not clean enough.  If these tasks allow themselves not only to calculate and read / write to RAM, but also to sleep, wait, or read / write to a blocking input / output source.  In this case, it is not recommended to put such tasks in commonPool, because they will occupy the precious flow from the pool, the flow will go to standby mode, and the kernel which according to the idea would have to be disposed of by this flow will become idle.  Therefore, for such a little sleepy tasks, it is better to create a separate, custom ForkJoinPool. <br><br>  THE END <br><br>  Questions and suggestions, as always, are welcome here and at <a href="https://otus.pw/Rzjx/">the open door</a> .  We are waiting, sir. </div><p>Source: <a href="https://habr.com/ru/post/342040/">https://habr.com/ru/post/342040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342028/index.html">Space photography of the Earth</a></li>
<li><a href="../342030/index.html">Work with API KOMPAS-3D ‚Üí Lesson 5 ‚Üí Graphic primitives</a></li>
<li><a href="../342032/index.html">Using the KOMPAS-3D API ‚Üí Lesson 6 ‚Üí Construction of a circular arc</a></li>
<li><a href="../342036/index.html">How to build a community. Translation of the book "Social Architecture": Chapter 6. Living Systems</a></li>
<li><a href="../342038/index.html">Detecting dependencies of Android components</a></li>
<li><a href="../342042/index.html">Single channel splitter voices: on the way to the product (preview)</a></li>
<li><a href="../342044/index.html">Python code generation with Hy</a></li>
<li><a href="../342046/index.html">How to get a DUNS number for free</a></li>
<li><a href="../342048/index.html">Automated workshop - 1. Example ‚ÄúDisplay‚Äù, development of OA and UA</a></li>
<li><a href="../342052/index.html">Normal reset</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>