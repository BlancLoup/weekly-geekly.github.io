<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WiFi Led Controller Device Study</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, for inspection, a device designed to make our life easier is presented. 
 This device is designed to control the lighting. When you connect RGB...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WiFi Led Controller Device Study</h1><div class="post__text post__text-html js-mediator-article">  Today, for inspection, a device designed to make our life easier is presented. <br>  This device is designed to control the lighting.  When you connect RGB diodes, you can control the color and brightness, and when you connect monochrome diode lamps only brightness.  In the latter case, 3 color channels can be used separately.  In addition, the device has several modes that set either constant lighting or flashing.  Power supply from 5 to 24 volts.  The same voltage device outputs to the channels.  Specifications are as follows: <br>  Max load: 288 W <br>  Remote control: 50M <br>  Model: WIFI100 wifi controller <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cb3/5fe/f9e/cb35fef9e375c74c8f544391b50782f3.jpg" alt="image"><br><br>  However, with the inclusion of my life did not become easier.  On the contrary, complicated.  The reason for this was the application MagicColor v1.0, included in the package.  Despite the fact that this program worked on HTC and LG phones, it did not work on my Samsung Galaxy Note 10.1 and Galaxy Nexus devices, which made her prepare a little bit, and with it the wonderful device itself. <a name="habracut"></a>  The first thing that was established, which was not mentioned in the instructions, was that the device had a WEB interface with login: admin and password of 1234, which of course made me happy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As you can see from the default screenshots, the device works in Ad hoc mode with unprotected access to the network.  The default protocol is TCP and port 5000. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c0/62c/1c1/8c062c1c15464e286c1fedffdea5f2fa.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/10a/416/9fa/10a4169fa8901dc23d26717f5f0fed2a.png" alt="image"><br><br>  I must say that this situation did not suit me at all.  First of all, this is security, it is simply not there.  Anyone can access this device.  Secondly, I would like to see this device in my home network, which already has its own DHCP server, and protection from external attacks.  Unfortunately, MagicColor does not have the ability to change the device‚Äôs IP address.  In addition, as it turned out later, there is an ssid network name check in the program. <br><br>  Now let's deal with the program.  To unpack the MagicColor.apk file, I used APK Manager v.4.9.  To do this, simply copy the .apk to the ‚Äúplace-apk-here-for-modding‚Äù folder and run the Script.bat script.  After these manipulations, the folder ‚Äúprojects‚Äù appears in the root folder of the program, and in it the folder with the same name as the .apk file.  Now you need to get the .jar file from the classes.dex file, for which the dex2jar script was used.  Just drag and drop the .dex file onto dex2jar.bat and we get what we want. <br><br>  The next step is to decompile the received classes_dex2jar.jar file.  First, I tried the JD-gui decompiler.  But, he did not live up to expectations, having given out a wrong code.  But the next decompiler AndroChef completely coped with the task. <br><br>  We will understand with the source code.  For disassembly, I used the Eclipse Standart version of Kepler, with the ADT Plugin plug-in installed on it.  You can install it from the Eclipse shell by calling the ‚ÄúHelp‚Äù - ‚ÄúInstall New Software ...‚Äù menu.  then click the ‚ÄúAdd‚Äù button and in the ‚ÄúName‚Äù field enter the ADT Plugin ‚Äù, and in the‚Äú Location: ‚Äù <a href="https://dl-ssl.google.com/android/eclipse/">field dl-ssl.google.com/android/eclipse</a> .  Select all components and click ‚ÄúFinish‚Äù. <br><br>  First, I created an empty Android Application Project project.  Where installed the Application Name: Color, Project Name: MagicColor2, Package Name: com.android.color.  Then I removed the checkmarks from the items ‚ÄúCreate custom launcher icon‚Äù and ‚ÄúCreate activity‚Äù. <br><br>  In the src folder I placed the ‚Äúcn‚Äù and ‚Äúcom‚Äù folders obtained during decompilation.  From ‚Äúcom / android / color‚Äù the R.java file is transferred with replacement into the folder ‚Äúgen / com / android / color‚Äù. <br><br>  Do not forget to transfer all the files from the ‚Äúres‚Äù folder to the project folder of the same name.  And AndroidManifest.xml.  Which I received using the apktool script with java -jar apktool.jar d MagicColor.apk out.  After the script is created, an ‚Äúout‚Äù folder is created in which the ‚Äúres‚Äù folder and AndroidManifest.xml are present <br><br>  You can begin to analyze the program code.  The Eclipse program finds several errors that need to be fixed.  How I did it can be viewed in the source code that I attached to the article below. <br><br>  In StaticClass.java, we see the default program settings.  Some of these parameters will come in handy later.  In the Protocol.java file, an algorithm for forming a command for the device is described, the basis of which is the getAll () function, in which the command is formed. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getAll() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.frameHead[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.frameHead[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mode; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.keyNumber; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.keyValue; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.colorRGB[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.colorRGB[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.colorRGB[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.checkValue; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.all; }</code> </pre> <br><br>  Based on this data, we see that the first two bytes are always the same, and equal to -86 and 85, which in binary form 10101010 and 1010101 form a sequence of bits that allow to determine the authenticity and correctness of the command.  Also to determine the correctness of the command included a checksum, which is located at the very end, 9 byte commands.  It is calculated by <i>getCurCheckValue (int paramInt1, int paramInt2, int paramInt3, int paramInt4, int paramInt5) using the</i> following original method: <b>Key_Num + (blue + (green + (red + (bar_No + 255))) + mode)% 255</b> <br>  <i>Where: paramint1 - StaticClass.bar_No, paramint2 - StaticClass.red, paramint3 - StaticClass.green, paramint4 - StaticClass.blue, paramint5 - StaticClass.Key_Num</i> <br><br>  As you have already guessed, the red, green and blue fields are from 1 to 255 for the 1.2.3 channel, respectively.  When RGB lighting is connected, the color changes, and when conventional diode lamps are connected, the brightness changes.  The Key_Num field defines the device operation mode.  The modes are as follows: 1 - turning off the lights, 2 - turning on the lights, 3 sequential switching of the built-in modes of the device, from frequent blinking to constant light.  Having at my disposal only one channel with a lamp, I could not get acquainted with the whole variety of modes.  Field mode = 1, the bar_No field is always 50. <br><br>  Before sending, the command is changed by the <i>exchangeBytes</i> and <i>exchangeInt</i> functions apparently in order to slightly encrypt the transfer protocol.  The idea of ‚Äã‚Äãthese functions is that parts of the center bytes that are extreme symmetrical with respect to the center are interchanged, for example, if we have the initial AB CD message, then after the conversion we get AC BD, and if 12 34 56 78 we get 17 35 46 28. That's so tricky !! ! <br><br>  Now about the problem that did not allow to use the program for my Samsung devices.  As it turned out when debugging an application, the network's SSID is enclosed in quotes and its length increases by 2 characters, which the program does not expect, and checking the length of the SSID expects to receive 5 instead of 7. The verification functions that are in the ColorActivity.java file are discussed below.  There are two of them: <i>private void getWifiInfo ()</i> and <i>protected void isWifiInfo</i> ().  In both functions, the code is present: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ssid != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ssid.length() != <span class="hljs-number"><span class="hljs-number">5</span></span>) { StaticClass.wifi_correct = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ssid.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>).equals(<span class="hljs-string"><span class="hljs-string">"LN"</span></span>)) { StaticClass.wifi_correct = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br><br>  In bold I singled out those samwe checks.  Why check the length of the SSID and the first two characters of the name SSID, but they are always the same, I do not know.  In the SSID, only the last 3 characters differ, and they depend on the position of the SSID switch on the device.  Position 0 on the switch corresponds to the SSID ‚ÄúLN001‚Äù.  In order for the program to work on my phone, it was enough to remove these checks. <br><br>  Then I managed to add an additional field to the program settings page in which you can enter the IP address of the device.  Now it became possible to switch the device from ‚Äúad hoc‚Äù to ‚Äúinfrastructure‚Äù mode, configure security and connect it from your home network, leaving the ability to control the lighting from your mobile device. <br><br>  The finished project and the work program in the ‚Äúbin‚Äù folder with the device‚Äôs IP address field added to the settings can be found here: <a href="http://qclk.ru/k9/nUm21">Magic Color 2 project.</a> </div><p>Source: <a href="https://habr.com/ru/post/220531/">https://habr.com/ru/post/220531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220521/index.html">About Stalin, Durov, cookies and parameter EncryptedPasswd</a></li>
<li><a href="../220523/index.html">Using microrobots to perform complex teamwork: a new project with DARPA financing (video)</a></li>
<li><a href="../220525/index.html">The path to intelligence. Step one. Overall picture</a></li>
<li><a href="../220527/index.html">Patch for the hypervisor of consciousness</a></li>
<li><a href="../220529/index.html">How to DPAA driver</a></li>
<li><a href="../220533/index.html">Samsung Galaxy S5: the flagship created in a hurry</a></li>
<li><a href="../220537/index.html">Installing Tizen 3.0 on RD-PQ</a></li>
<li><a href="../220539/index.html">How does the program "Search for IT vulnerabilities" PrivatBank</a></li>
<li><a href="../220541/index.html">HP ProLiant Workshop with 65% discount - May 6-7 in Kiev</a></li>
<li><a href="../220543/index.html">Search VPS - second update: auctions, a place for backups, licenses and reviews about hosts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>