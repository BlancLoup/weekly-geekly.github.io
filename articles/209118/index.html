<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using XenServer and other free / opensource in manual testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about how XenServer got accustomed in our testing department, as well as a little about the other free / opensource used (DRBL + Clonez...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using XenServer and other free / opensource in manual testing</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about how XenServer got accustomed in our testing department, as well as a little about the other free / opensource used (DRBL + Clonezilla, Tape redirector, MHVTL).  The choice has stopped on these products not for ideological, but purely practical reasons - they are convenient and scalable.  But there are a number of problems that I will also focus on in this article. <br>  Under the cut a lot of text and images. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/746/b89/06e/746b8906ee7aa0e1cb674ff5e9fdfd39.jpg"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="https://habr.com/ru/company/acronis/blog/209118/">Hardware configuration</a> </li><li>  <a href="https://habr.com/ru/company/acronis/blog/209118/">ZFS</a> </li><li>  <a href="https://habr.com/ru/company/acronis/blog/209118/">DRBL and friends</a> </li><li>  <a href="https://habr.com/ru/company/acronis/blog/209118/">XenServer API</a> </li></ul><br><br>  I work in the Acronis testing team in the user support department, reproducing user problems.  Starting with imitation of disk environment and hardware, and ending with software and its specific settings.  The task was to ensure the operation of the test bench with the help of two workstations.  ESXi, Hyper-V, Proxmox, and others were tried, but still stopped at using XenServer.  And that's what came out of it. <br><br><a name="hardware"></a><br><h4>  Hardware </h4><br>  Initially, there was one disk on which XenServer 4.2 was installed.  At first, the speed suited.  A little later, the server was already used by two people, a heavy environment appeared (for example, Exchange 2003 with a 300GB database, which constantly worked under load) and it immediately became clear that the current performance was not enough for comfortable work.  Virtual machines were loaded for a long time (and at the same time it runs an average of 20 pieces on one server), IO Wait often reached several seconds.  We had to do something. <br><a name="zfs"></a><br>  The first thing that came to mind was RAID, but this was not implemented quickly, and a solution was needed yesterday.  Just then, ZFS was added to the Debian repository and it was decided to try it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/58b/cd1/5d6/58bcd15d638f9ed1f7613f0537c8d8d1.png"><br><br>  Each of the two workstations has a motherboard with 4 SATA2 ports, 16GB of RAM and gigabit network cards. <br>  The first machine was allocated to the hypervisor and is loaded from a USB flash drive. <br>  On the second machine was installed server Ubuntu 11.04, all the necessary packages for ZFS.  Installed 4 disk 1 TB each.  RAID 10 was chosen. Since there are only 4 SATA ports on the motherboard, the OS is also installed on a USB flash drive. <br>  The hypervisor itself is connected to ZFS via a gigabit switch. <br>  Experiments were carried out, articles were read, as a result, support for GZIP compression was enabled on ZFS, check-out checking was turned off, and deduplication was also refused.  This turned out to be the most optimal solution, all 8 cores are very rarely loaded at 100%, and there is enough memory.  Unfortunately, the cache on the SSD could not be tested :) <br><br>  The file system itself is exported out through NFS, natively supported by ZFS itself.  And XenServer, and ESX work with NFS storages.  This made it possible to use the same storage at the same time for 2 XenServers and 3 ESXi.  Hyper-V, which with an enviable persistence in Server 2012 refuses to work with NFS, is knocked out of this series, but this is on MS‚Äôs conscience. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c9/672/1d6/7c96721d6999f0c7e18f9fa8a62be760.png"><br><br>  A configured ZFS looks like this: <br><pre><code class="bash hljs">root@xenzfs:~<span class="hljs-comment"><span class="hljs-comment"># zpool status pool: xen state: ONLINE config: NAME STATE READ WRITE CKSUM xen ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 sda ONLINE 0 0 0 sdb ONLINE 0 0 0 mirror-1 ONLINE 0 0 0 sdc ONLINE 0 0 0 sdd ONLINE 0 0 0 errors: No known data errors</span></span></code> </pre> <br><pre> <code class="bash hljs">root@xenzfs:~<span class="hljs-comment"><span class="hljs-comment"># zpool list xen NAME SIZE ALLOC FREE CAP DEDUP HEALTH ALTROOT xen 1.81T 1.57T 245G 86% 1.00x ONLINE -</span></span></code> </pre><br><br>  The speed of writing to a disc roughly corresponds to twice the speed of an individual disc. <br><br>  Currently, up to 40 virtual machines run simultaneously without any performance problems, whereas previously 20 machines led to IOW sags for up to 5 seconds.  Now, after a year and a half from the launch of ZFS, the solution can be considered reliable, fast and extremely budget.  Raised NFS and CIFS servers on storage allow it to be used for other purposes as well: <br>  XenServer allows you to create ISO repositories on CIFS network drives.  Products before release testing are assembled into an ISO image (installers for Windows and Linux of different localizations), which, in turn, are uploaded to a network drive in the internal gigabit network.  As a result, with one mouse movement (subjectively, XenCenter is much more convenient and faster in such work than vSphere) or a script, we insert this ISO into a virtual CDROM (dozens of machines are possible at the same time) and set the product directly from disk, which saves time on copy large (2GB +) files.  Of course, such a linear reading sags the network, especially if the installation goes straight from 5+ machines, but it is still very convenient. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9a/114/b4d/a9a114b4deecaa36aa3b2e9e759bfc8c.png"><br><br>  The gigabit network through which the storage is connected is also available for virtual machines.  Thus, you can use CIFS for any other tests.  For convenience, a ZFS server was also raised on the ZFS machine. <br><br><a name="drbl"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/595/73f/ebf/59573febf60bde81159a1fc71910b7d4.jpg"><br><br>  In addition to virtual machines, it is necessary to test on ordinary workstations.  This testing and with tape drives and all sorts of REV, RDX discs, etc.  You need to constantly and quickly deploy different environments on the machines.  Whether it‚Äôs an ESX hypervisor or Windows 2008R2 with Hyper-V or SLES with a raised iSCSI multipath.  <a href="http://drbl.sourceforge.net/">DRBL is</a> used for this purpose <a href="http://drbl.sourceforge.net/">.</a> <br><br>  DRBL in combination with Clonezilla allows you to quickly deploy images of PXE with flexible scripts, and also serves as a NAT server for already deployed machines. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bb8/d45/e2a/bb8d45e2a9200a1796d31a3afadeb27a.png"><br><br>  Machines on the internal network have access via NAT to the external network, and they themselves access via RDP via iptables. <br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3390 -j DNAT --to 192.168.1.50:3389 iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3391 -j DNAT --to 192.168.1.51:3389 iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3392 -j DNAT --to 192.168.1.52:3389</code> </pre><br><br>  A set of different tape drives is connected to one machine that uses the free <a href="http://www.starwindsoftware.com/download-starwind-tape-redirector">Tape Redirector</a> , so any virtual machine can use them via iSCSI.  There is also a separate virtual machine with a raised MHVTL, but hardware drives are also needed - not all problems appear on the VTL. <br><br>  Deployment / cloning is done in two clicks using a utility written in Perl + GTK.  It works quite simply - a team of blocks is built and executed via SSH.  Who cares, the repository here.  The code is raw, but it works <a href="https://github.com/Pugnator/GTKdrbl">github.com/Pugnator/GTKdrbl</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f0/5d3/1f6/0f05d31f6f85aca80eba8607cec9d718.png"><br><br><a name="gui"></a><br><h4>  Interface </h4><br><br>  Subjectively, the user-friendly interface is represented only by Citrix - XenCenter, but, unfortunately, it is only for Windows.  In addition, for some reason, important and useful features were not brought to the interface, for example, the ability to pause a virtual machine or, unfortunately, often the necessary XAPI reboot option, when a virtual machine hangs tightly <br><img src="https://habrastorage.org/getpro/habr/comment_images/a51/676/203/a5167620384ffe89d0c1aec156a9d0a3.jpg" alt="image"><br><br>  There are other options, such as <a href="http://sourceforge.net/projects/openxenmanager/">sourceforge.net/projects/openxenmanager</a> , but they were not stable enough. <br><br>  There is a VNC web proxy <a href="http://www.xvpsource.org/">www.xvpsource.org</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/88b/030/4b3/88b0304b3500b8514aadc74f15390c34.png" alt="image"><br><br>  Convenient, but requires Java, included in the browser (there are problems), well, first of all it is VNC, you can not work with a full interface. <br><br>  As a result, a client for Linux was written to GTK3, which can also be used on the web.  GTK Broadway allows you to get such a tool via HTML5 + WebSockets in your browser <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f4/9de/b80/1f49deb80ef9d264427cc9476526c386.png" alt="image"><br><br>  This technology does not allow using it for multiple users at the same time, but with the help of it you can fully work both on Linux and via the web, only by changing the launch parameters (for example, bring in two icons). <br><br>  When using HTML5 frontend, many restrictions are imposed on the application itself, and these restrictions are for some reason undocumented.  An example of a limitation is the inability to use icons in the tray, relative positioning of the window, and so on.  The consequences are from unstable work to falls. <br>  The documentation is all bad, at the moment the study of broadway is the reading of the GTK3 source codes, since there is nothing but a description page and news from 3 years ago on the broadway. <br><br><a name="api"></a><br><h4>  API </h4><br><br>  <a href="">The API</a> exists for C, C #, Java, Python, and Powershell.  For C, the build is only for Linux, but the method of minor refinement of the source code (at that time there was no implementation of some function in mingw) everything was successfully assembled under Windows (MinGW).  The API works via HTTP (S).  The API also provides fairly low-level access to virtual machines. <br><br><h4>  Discs </h4><br>  I wanted a lot, from quickly viewing the MBR by clicking the mouse, before retrieving a file from a virtual machine or downloading it back while the virtual machine is turned off. <br>  This may be necessary, for example, in the case of BSOD - extract the registry (and / or edit it and upload it back, for example, turning off any driver), or edit the bootloader options (enable debug through the serial port) and much more.  For such purposes, you have to resort to using a boot disk. <br>  But it is possible and otherwise, <a href="http://wiki.xensource.com/wiki/Disk_import/export">it is possible to export</a> a <a href="http://wiki.xensource.com/wiki/Disk_import/export">virtual machine</a> via HTTP GET in the XVA format, which is a TAR archive, inside which there are disk blocks. <br><br><pre> $ tar -tvf test.xva
 ---------- 0/0 17391 1970-01-01 01:00 ova.xml
 ---------- 0/0 1048576 1970-01-01 01:00 Ref: 946/00000000
 ---------- 0/0 40 1970-01-01 01:00 Ref: 946 / 00000000.checksum
 ---------- 0/0 1048576 1970-01-01 01:00 Ref: 946/00000007
 ---------- 0/0 40 1970-01-01 01:00 Ref: 946 / 00000007.checksum
 ---------- 0/0 1048576 1970-01-01 01:00 Ref: 949/00000000
 ---------- 0/0 40 1970-01-01 01:00 Ref: 949 / 00000000.checksum
 ---------- 0/0 1048576 1970-01-01 01:00 Ref: 949/00000003
 ---------- 0/0 40 1970-01-01 01:00 Ref: 949 / 00000003.checksum
</pre><br><br>  If you read this archive on the fly, you can easily get the required MBR, and having learned the offsets and types of partitions, read the files.  But at the moment only MBR extraction is implemented.  Starting with version XenServer 6.2, it is possible to export a RAW disk.  In future versions, XenServer promises to introduce the ability to export only disk delta from an arbitrary offset, which opens up new possibilities. <br><br><h4>  Network </h4><br>  You can control the work with the virtual machine network in different ways.  This is usually wireshark / tcpdump installed in the virtual machine.  The necessary dump is collected and transferred to another place for study.  <a href="http://support.citrix.com/article/CTX120869">But there is a better way</a> - each running virtual machine has its own dom-id, in accordance with it there is also a VIF device of the vifDOMID.0 type, accessible from the hypervisor.  Having connected via SSH to the hypervisor, you can easily get a dump for any arbitrary enabled virtual machine (of course, having added network cards), which makes testing cleaner and more convenient (no need to install PCAP drivers).  Further, <a href="http://ask.wireshark.org/questions/23609/remote-capture-via-ssh-and-pipe">according to the advice of Q &amp; A, the</a> program makes a <a href="http://wiki.wireshark.org/CaptureSetup/Pipes">pipe</a> and starts Wireshark.  And in real time we receive / filter traffic. <br><br><h4>  Guest tools and serial port </h4><br>  The API does not provide any means similar to guest operation in vix vmWare, for example, <a href="https://www.vmware.com/support/developer/vix-api/vix18_reference/lang/c/functions/VixVM_CopyFileFromHostToGuest.html">copying files</a> . <br>  And if with the installation of the main software, the problem is solved with the use of ISO on the gigabit network, then with the transfer of commands / logging, viewing the data is not so smooth.  It is necessary to use intermediate network drives, and this is not always possible (test conditions, isolated network).  In any case, it is time consuming and inconvenient. <br><br>  The very first idea that came to mind is to use a virtual serial port.  You can activate the virtual com-port, which means XenServer broadcast over TCP.  Now, if the connection is open at the corresponding address, we can send / receive messages at the speed of 115200. On the virtual machine, the background program ‚Äúserial port-CLI proxy‚Äù is running, which performs the translation of commands from the serial port and returns the results. <br>  It was not without pitfalls: <br>  1) Transmission is terminated when 65535 bytes are reached, if the client (virtual machine) has not transmitted at least one byte during this time. <br>  2) Turning on the port only works after restart.  That is, it is necessary to turn on either on the virtual machine turned off, or restart it. <br>  3) If, for any reason, the connection fails, it is not possible to restore it before rebooting. <br>  4) Well, the worst - if the TCP server does not respond - the virtual machine will freeze at the start. <br><br>  For these reasons, other methods were searched in parallel, for example, through the <a href="http://wiki.xen.org/wiki/XenStore">xenstore</a> .  This is a repository available for different domains.  Including virtual machines.  There is a buffer of about two megabytes, and quite fast recording.  But reading is slower than 115200, xen tools are required (which is not always possible) and the code needs to be thoroughly tested.  For example, if you write more than <i>XENSTORE_PAYLOAD_MAX</i> , judging by the comments in the source code for the drivers, this will have fatal consequences. <br><br>  At the moment, I am thinking about using the paravirtual serial port of the virtual machine through the ssh tunnel on the hypervisor, by analogy with the method mentioned above about network cards.  Apparently, this is the safest and fastest method.  At the moment, only verified that this is feasible. <br><br>  In exactly the same way, you can debug the Windows / Linux kernel by sending a serial port over TCP / SSH, and WinDbg, for example, is already connected locally via the pipe.  For such purposes, a separate virtual machine was created with a <a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463028">set of characters for all available versions of Windows</a> . <br><br><h4>  Conclusion </h4><br><br>  Working with the XenServer API and studying it, I experienced many pros and cons of the opensource.  Opportunities run into weak documentation.  If the VIX is described in great detail, then with the same xenserver api - 3 examples, 4 test files and comments in the source headers.  The code is understandable, but how to connect individual functions is understandable either to developers or to those who deeply know the Xen architecture.  For example, such a task as finding out the size of a disk is not described anywhere.  And without knowing the architecture - not too easy to guess.  Of course, over time, penetrating and delving into the structure of Xen, much has become clearer.  But I didn‚Äôt get an answer to many questions, and no one answers in the IRC chat rooms on weekends - single visitors write that ‚Äútoday is the resurrection‚Äù :). <br>  But there is progress, wiki, articles, examples with the demonstration of new features have been added over the year.  I really hope that in the future XenServer will be able to become a strong player in the market with a good set of third party software </div><p>Source: <a href="https://habr.com/ru/post/209118/">https://habr.com/ru/post/209118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209106/index.html">Kepler equation</a></li>
<li><a href="../209108/index.html">Angular Light. We manage declarative data binding in HTML</a></li>
<li><a href="../209110/index.html">Analysis of Suspicious PDF Files</a></li>
<li><a href="../209112/index.html">Simple battle model on Modelica</a></li>
<li><a href="../209116/index.html">Electronic money in Russia will limit</a></li>
<li><a href="../209122/index.html">Training course "Data Visualization"</a></li>
<li><a href="../209126/index.html">MathML or Latex - how we implemented a changing salary in calculating salary using MathJax</a></li>
<li><a href="../209128/index.html">But how does multithreading work? Part II: memory ordering</a></li>
<li><a href="../209130/index.html">Terminal multiplexer overview: tmux and dvtm</a></li>
<li><a href="../209132/index.html">How did the authors of the book and application developers find each other?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>