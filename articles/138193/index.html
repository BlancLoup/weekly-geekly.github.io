<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One is not a warrior in the field: how to create a failover cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It often happens that after the launch of an ambitious Internet project and its successful PR in the media, the company expects a large influx of visi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One is not a warrior in the field: how to create a failover cluster</h1><div class="post__text post__text-html js-mediator-article">  It often happens that after the launch of an ambitious Internet project and its successful PR in the media, the company expects a large influx of visitors.  Unfortunately, our world is not perfect and it so happens that the site does not cope with such a flow of visitors, called in our circles "habraeffektom", and begins to slow down.  Accordingly, the company loses money and reputation.  In such cases, programmers usually lay the blame on admins, and admins on programmers.  It turns out a vicious circle. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/412/0f3/f95/4120f3f951f658aaf6831b4f03538958.png" alt="image" align="left">  What to do if your application began to slow down?  One way is to translate it into a <a href="http://habrahabr.ru/company/jelastic/blog/136996/">cluster architecture</a> .  Unfortunately, there are not many instructions and articles that will tell you how to do this.  Therefore, we decided to publish a small example of how you can create a failover cluster based on <a href="http://glassfish.java.net/">GlassFish</a> .  This process and much more is automated in <a href="http://jelastic.com/">Jelastic</a> , but if you for some reason cannot switch to cloud hosting, then this article is for you. <a name="habracut"></a><br>  Let's start in order: <br><br><h5>  Training </h5><br>  To create a failover cluster, we need: two machines n1 and n2 for GlassFish servers (one of them will have DAS installed and 2 GF servers);  lb1 load balancing machine;  db1 machine for DBMS.  Make sure all the machines ‚Äúsee‚Äù each other (ping). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All software will run on Linux.  We will use a pre-prepared image of a virtual machine with CentOS.  GlassFish uses to manage remote SSH nodes, so we will need an installed SSH server on each of the cluster machines.  Also, to work on SSH, we will need a separate account in each OS.  I propose to call it a uniform for all machines: glassfish. <br> <code># adduser glassfish <br> # passwd glassfish</code> <br>  GlassFish uses non-standard ports and in order to be able to work with it using the admin console in the browser, you must either set the appropriate rules in the firewall or disable it altogether.  I propose to do the last: <br> <code># service iptables save <br> # service iptables stop <br> # chkconfig iptables off</code> <br>  Well and, of course, we cannot do without JVM. <br>  I warn you right away that you will have to tinker decently, since a large number of settings are required. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/47d/247/cb0/47d247cb0aa6dc2ce6e4ecfaf98498e7.png" alt="image"></div><br><br><h5>  Cluster configuration </h5><br>  We will conduct the cluster configuration mainly from the command line using the utility from the delivery of GlassFish <b>asadmin</b> <br><ol><li>  Downloading the GlassFish distribution <br> <code>wget download.java.net/glassfish/3.1.1/release/glassfish-3.1.1.zip</code> <br>  and unpack it. </li><li>  We start an instance of the administrative domain (domain1): <br> <code>./asadmin start-domain domain1</code> <br>  GlassFish by default prohibits remote connections to the administrative domain.  And all the cluster nodes (Node Agents), except for the node on which the DAS stands, will not be able to interact with it. <br>  <b>Typical error:</b> <br> <code>Failed to rendezvous with DAS on n1:4848. Please check if this server is running, that the host and port are correct, and that this server is configured to allow remote access.</code> <br>  To get around this we perform: <br> <code>./asadmin enable-secure-admin</code> <br>  and restart the administrative domain. <br>  Create the cluster itself: <br>  <code>./asadmin create-cluster c1</code> . <br>  Create two instances of the application server located on the same physical machine: <br> <code>./asadmin create-local-instance --cluster c1 i1</code> <br> <code>./asadmin create-local-instance --cluster c1 i2</code> <br> </li><li>  Run the cluster: <br> <code>./asadmin start-cluster c1</code> </li> <li>  Add new instances that are on machine n2 (commands are physically executed on n2): <br>  . <code>/asadmin ‚Äìhost n1 ‚Äìport 4848 create-local-instance ‚Äìcluster c1 i3 <br> ./asadmin ‚Äìhost n1 ‚Äìport 4848 create-local-instance ‚Äìcluster c1 i4</code> </li> <li>  In the admin console, we find the newly created instance, change its type to SSH, change the value of the Node Host field to n2.  At the same time, we need to specify the username and password for SSH access to the n2 machine.  Start the cluster.  We see that all instances work. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/998/94e/c45/99894ec45088a4351a253e9bffa7eb79.png" alt="image"></div><br><h5>  Load balancing and HA </h5><br>  Now, in fact, everything is ready to put the application in a cluster, but for us this is not enough, because  load balancing and HA are not provided. <br>  We need to install and configure a load balancer to make it convenient for users to work with the application: <br><ul><li>  addressed only one urla; </li><li>  their requests were distributed evenly across all instances of the cluster servers; </li><li>  in case of failure of a certain number of instances, users would be able to continue working with the application in the normal mode; </li><li>  and did not know about the internal "kitchen" of the cluster. </li></ul><br>  In general, GlassFish ‚Äúcontains‚Äù a balancing plugin for ‚Äúpopular‚Äù http servers.  The words "contains" and "popular" are not in vain taken in quotes, because  This plug-in is not contained in the Open Source version of GF, besides, Oracle iPlanet Web Server, Oracle HTTP Server, Apache HTTP Server, Microsoft IIS are supported.  We all know that Apache was once good, but now there are more effective solutions. <br>  Among the candidates: NGINX, HAProxy, lighthttpd. <br>  We will support the domestic manufacturer and choose <a href="http://nginx.org/">NGINX</a> , which also more and more captures the market. <br><ol><li>  Install NGINX: <br> <code>#yum install nginx <br> #nano /etc/nginx/nginx.conf</code> </li> <li>  We configure NGINX to balance round-robbin requests for 4 servers of the same weights with support for sticky sessions (below is a part of the config and the server is started). <br> <code>upstream backend { <br> ip_hash; <br> server 192.168.0.1:28080 max_fails=5 fail_timeout=15s; <br> server 192.168.0.1:28081 max_fails=5 fail_timeout=5s; <br> server 192.168.0.2:28082 max_fails=5 fail_timeout=5s; <br> server 192.168.0.2:28083 max_fails=5 fail_timeout=5s; <br> }</code> <br>  It is worth noting that this is the easiest config that fixes user sessions to a specific server using the ip_hash method </li><li>  In order for HA to work, it is necessary for hosts n1 and n2 to have a common parent domain.  For example, cluster.com.  To do this, you need to modify the / etc / hosts files on both machines as follows: <br>  n1: <br> <code>127.0.0.1 localhost <br> 127.0.1.1 n1.cluster.com <br> 127.0.0.1 n1.cluster.com <br> 192.168.0.2 n2.cluster.com</code> <br>  n2: <br> <code>127.0.0.1 localhost <br> 127.0.1.1 n2.cluster.com <br> 127.0.0.1 n2.cluster.com <br> 192.168.0.1 n1.cluster.com</code> </li> <li>  To test the operation of multicast on each physical machine of the cluster we perform: <br> <code>./asadmin validate-multicast</code> </li> <li>  In the administrative console DAS GlassFish, you must change the reference n2 to n2.cluster.com </li><li>  In order for GlassFish to replicate Http sessions between cluster instances, it is necessary for the application's web descriptor to contain the appropriate instruction (&lt;distributable /&gt; tag) and set the Avalaibility flag when the application is deployed. </li></ol><br><h5>  Install and configure the database </h5><br>  In this example, we will use <a href="http://www.postgresql.org/">PostgreSQL</a> . <br>  Install the DBMS and create a new user and database. <br> <code># yum install postgresql-8.4 <br> # service postgresql initdb <br> # service postgresql start</code> <br>  In PostgreSQL, only local connections are allowed by default.  In order to fix this, you need to correct the configuration file /var/lib/pgsql/data/pg_hba.conf, in which you need to specify the allowed subnets: <i>host all all 192.168.0.0/24 md5</i> <br><br>  Well that's all!  Now we can finally deploy the application (for example, we use jforum). <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/937/57e/6e6/93757e6e6bdf005cc8aa694debadf47b.png" alt="image"></div><br><br>  Frankly speaking, after all these settings, my brain almost ‚Äúboiled over‚Äù.  We had to ‚Äúwork hard‚Äù to automate the whole process described above in Jelastic and turn it into a few mouse clicks. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c1/0ae/ec4/4c10aeec442d22f1f369a794a7226624.png" alt="image"></div><br>  You can try what came of it on <a href="http://jelastic.com/">jelastic.com</a> and share your opinion in the comments to the post. </div><p>Source: <a href="https://habr.com/ru/post/138193/">https://habr.com/ru/post/138193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138188/index.html">Hard drive prices will stay high for a couple more years.</a></li>
<li><a href="../138189/index.html">Shuffle rubric: review of the PocketBook 611 reader and dual-card Gigabyte Gsmart G1345 smartphone</a></li>
<li><a href="../138190/index.html">Moscow GTUG - hackathon on Android February 18-19, 2012</a></li>
<li><a href="../138191/index.html">Support attribute "form" for older browsers</a></li>
<li><a href="../138192/index.html">Concept designer Bethesda has passed away</a></li>
<li><a href="../138196/index.html">Interesting future: Cotton microprocessor!</a></li>
<li><a href="../138197/index.html">Kotlin is now open source</a></li>
<li><a href="../138198/index.html">MIT Launches First Fully Automated Online Course</a></li>
<li><a href="../138200/index.html">Android Hackathon in St. Petersburg</a></li>
<li><a href="../138201/index.html">Restlook - so small and so virtual Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>