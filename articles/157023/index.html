<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Puppet under load</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Puppet is a fairly convenient configuration management tool. In fact, this is a system that allows you to automate the configuration and management of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Puppet under load</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/badoo/blog/157023/"><img src="https://habrastorage.org/storage2/fdf/d79/ddd/fdfd79ddde3ad58cfab4db18a6235556.jpg" align="left"></a>  Puppet is a fairly convenient configuration management tool.  In fact, this is a system that allows you to automate the configuration and management of a large fleet of machines and services. <br><br>  There is a lot of basic information about the system itself, including on Habr√©: <a href="http://habrahabr.ru/post/67471/">here</a> , <a href="http://habrahabr.ru/post/68532/">here</a> and <a href="http://habrahabr.ru/post/126487/">here</a> .  We tried to collect in one article several ‚Äúrecipes‚Äù of using Puppet under really large loads - in the ‚Äúcombat conditions‚Äù of Badoo. <br><br>  What will be discussed: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Puppet: educational program; </li><li>  clustering, scaling; </li><li>  asynchronous Storeconfigs; </li><li>  collection of reports; </li><li>  data analysis. </li></ul><br><a name="habracut"></a><br>  Immediately make a reservation that the article is written in the wake of the report of Anton Turetsky at the <a href="http://highload.ru/">HighLoad ++ 2012</a> conference.  Over the course of a few days, our ‚Äúrecipes‚Äù are overgrown with additional details and examples. <br><br>  <b>Returning to the loads, it should be noted that in Badoo they are really high:</b> <br><ul><li>  more than 2000 servers; </li><li>  more than 30,000 lines in manifests (English <i>manifest</i> , in this case - the configuration file for the management server); </li><li>  more than 200 servers accessing puppet master every 3 minutes; </li><li>  over 200 servers sending reports in the same time period. </li></ul><br><br><h4>  How it works </h4><br><br><img src="https://habrastorage.org/storage2/76a/1e3/c64/76a1e3c64e63cd91744971147fab485a.png"><br><br>  By itself, the Puppet application is client-server.  In the case of Puppet, the initiator of the connection is the client;  in this case, this is the node (English <i>node</i> ) on which you want to deploy the configuration. <br><br><h5>  Step 1: facts in exchange for configuration </h5><br><br><img src="https://habrastorage.org/storage2/f5d/a43/17b/f5da4317b7434f5c4acfecb35c30dacd.png"><br><br>  The client collects facts about himself with the help of the <b>facter</b> utility, an essential dependency of the Puppet application, then sends them with a regular HTTP POST request to the server and waits for his response. <br><br><h5>  Step 2: processing and response </h5><br><br><img src="https://habrastorage.org/storage2/8d8/edb/7cd/8d8edb7cd71d7d59ab3d948fbdddda37.png"><br><br>  The server receives a dump with facts from the client and compiles the directory.  At the same time, it proceeds from the information in the manifests available on the server, but also takes into account the facts received from the client.  The catalog is sent to the client. <br><br><h5>  Step 3: apply the catalog and report the results </h5><br><br><img src="https://habrastorage.org/storage2/16b/49e/c53/16b49ec537f3053c289edbf02eaa6caa.png"><br><br>  Having received the catalog from the server, the client makes changes in the system.  Reports the results of the execution to the server using an HTTP POST request. <br><br><h5>  Step 4: collecting and storing reports </h5><br><br><img src="https://habrastorage.org/storage2/ec0/a49/8b5/ec0a498b597b874ff3adb6a85e40ecaa.png"><br><br>  After the client has completed all the rules, the report should be saved.  Puppet proposes to use both their own groundwork and third-party collectors for this.  We try! <br><br>  Install the base package and get the following picture: <br><br><img src="https://habrastorage.org/storage2/3d1/49c/f5e/3d149cf5e36ab5f1ad1c9779646f9c18.png"><br><br>  At first glance, everything is fine - set and work.  However, over time, the picture becomes less joyful.  The number of clients is increasing, system administrators are writing manifests, which increase the time spent on compiling code and processing each client. <br><br><img src="https://habrastorage.org/storage2/3e9/a77/88c/3e9a7788cec706733052793b1b5e8c39.png"><br><br>  And at a certain point the picture becomes very sad. <br><br><img src="https://habrastorage.org/storage2/0cc/662/8b6/0cc6628b630083f602c0f940401c3ffb.png"><br><br>  The first thing that comes to mind is to increase the number of puppet master processes on the server.  Yes, precisely because Puppet does not know how to do this in the basic delivery, and it is not ‚Äúsmeared‚Äù by the cores. <br><br>  Are there any solutions offered by the manufacturer?  Of course, but for various reasons they turned out to be inapplicable in our conditions. <br><br>  Why not Apache + mod_passenger?  For some reason, our company does not use the Apache web server at all. <br><br>  Why not nginx + passenger?  To avoid the need for an additional module in the nginx build that we use. <br><br>  What then? <br><br><h4>  Meet Unicorn </h4><br><br><img src="https://habrastorage.org/storage2/380/451/3dc/3804513dc90c527f426ab97d9fd1a713.png"><br><br>  Why <a href="http://unicorn.bogomips.org/">Unicorn</a> ? <br><br>  Here, in our opinion, its advantages: <br><ul><li>  Linux kernel level balancing </li><li>  running all processes in your environment; </li><li>  update without losing the ‚Äúnginx-style‚Äù connections; </li><li>  the ability to listen on multiple interfaces; </li><li>  similar to PHP-FPM, but for Ruby. </li></ul><br>  Another reason for choosing Unicorn was the simplicity of its installation and configuration. <br><br><pre><code class="ruby hljs">worker_processes <span class="hljs-number"><span class="hljs-number">12</span></span> working_directory <span class="hljs-string"><span class="hljs-string">"/etc/puppet"</span></span> listen <span class="hljs-string"><span class="hljs-string">'0.0.0.0:3000'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:backlog</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">512</span></span> preload_app <span class="hljs-literal"><span class="hljs-literal">true</span></span> timeout <span class="hljs-number"><span class="hljs-number">120</span></span> pid <span class="hljs-string"><span class="hljs-string">"/var/run/puppet/puppetmaster_unicorn.pid"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GC.respond_to?(<span class="hljs-symbol"><span class="hljs-symbol">:copy_on_write_friendly=</span></span>) GC.copy_on_write_friendly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> before_fork <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|server, worker|</span></span> old_pid = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{server.config[</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:pid</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">.oldbin"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> File.exists?(old_pid) &amp;&amp; server.pid != old_pid <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Process.kill(<span class="hljs-string"><span class="hljs-string">"QUIT"</span></span>, File.read(old_pid).to_i) <span class="hljs-keyword"><span class="hljs-keyword">rescue</span></span> Errno::ENOENT, Errno::ESRCH <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  So, the good news: we have the ability to run multiple processes.  But there is also a bad one: managing processes has become much more difficult.  Not scary - for this situation, there is a "recipe". <br><br><h4>  "In God We Trust" </h4><br><br><img src="https://habrastorage.org/storage2/ba7/cbc/f87/ba7cbcf87b082d61bf2f4d823c07f306.png"><br><br>  God is a process monitoring framework.  It is easy to set up and written in Ruby, like Puppet itself. <br><br>  In our case, God manages various instances of puppet master processes: <br><ul><li>  production environment; </li><li>  testing environment; </li><li>  Puppet CA. </li></ul><br>  With the setting of special problems also does not arise.  It is enough to create a configuration file in the / etc / god / directory to process * .god files. <br><br><pre> <code class="ruby hljs">God.watch <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|w|</span></span> w.name = <span class="hljs-string"><span class="hljs-string">"puppetmaster"</span></span> w.interval = <span class="hljs-number"><span class="hljs-number">30</span></span>.seconds w.pid_file = <span class="hljs-string"><span class="hljs-string">"/var/run/puppet/puppetmaster_unicorn.pid"</span></span> w.start = <span class="hljs-string"><span class="hljs-string">"cd /etc/puppet &amp;&amp; /usr/bin/unicorn -c /etc/puppet/unicorn.conf -D"</span></span> w.stop = <span class="hljs-string"><span class="hljs-string">"kill -QUIT `cat </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{w.pid_file}</span></span></span><span class="hljs-string">`"</span></span> w.restart = <span class="hljs-string"><span class="hljs-string">"kill -USR2 `cat </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{w.pid_file}</span></span></span><span class="hljs-string">`"</span></span> w.start_grace = <span class="hljs-number"><span class="hljs-number">10</span></span>.seconds w.restart_grace = <span class="hljs-number"><span class="hljs-number">10</span></span>.seconds w.uid = <span class="hljs-string"><span class="hljs-string">"puppet"</span></span> w.gid = <span class="hljs-string"><span class="hljs-string">"puppet"</span></span> w.behavior(<span class="hljs-symbol"><span class="hljs-symbol">:clean_pid_file</span></span>) w.start_if <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|start|</span></span> start.condition(<span class="hljs-symbol"><span class="hljs-symbol">:process_running</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|c|</span></span> c.interval = <span class="hljs-number"><span class="hljs-number">5</span></span>.seconds c.running = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Please note that we have allocated Puppet CA to a separate instance.  This was done specifically so that all customers use a single source to verify and obtain their certificates.  A little later we will tell how to achieve this. <br><br><h4>  Balancing </h4><br>  As already mentioned, the entire process of exchanging information between the client and the server occurs via HTTP, which means that nothing prevents us from setting up a simple http balancing using the help of nginx. <br><br><img src="https://habrastorage.org/storage2/834/2b5/ea9/8342b5ea9da0860889698d6f802c47bd.png"><br><br><ol><li>  Create upstream: <br><br><pre> <code class="ruby hljs">upstream puppetmaster_unicorn { server <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; server <span class="hljs-symbol"><span class="hljs-symbol">server2:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">#    puppet master ( , production-) upstream puppetca { server 127.0.0.1:3000 fail_timeout=0; } #  Puppet CA</span></span></code> </pre><br></li><li>  We redirect requests to recipients: <br><br><ul><li>  Puppet ca <br><br><pre> <code class="ruby hljs">location ^~ <span class="hljs-regexp"><span class="hljs-regexp">/production/certificate</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ca { proxy_pass http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/puppetca; } location ^~ /production</span></span><span class="hljs-regexp"><span class="hljs-regexp">/certificate { proxy_pass http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/puppetca; } location ^~ /production</span></span><span class="hljs-regexp"><span class="hljs-regexp">/certificate_revocation_list/ca</span></span> { proxy_pass <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/puppetca; }</span></span></code> </pre><br></li><li>  Puppet master <br><br><pre> <code class="ruby hljs">location / { proxy_pass <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/puppetmaster_unicorn; proxy_redirect off; }</span></span></code> </pre><br></li></ul><br></li></ol><br>  Let's sum up the intermediate results.  So, the above actions allow us to: <br><ol><li>  run multiple processes; </li><li>  manage the launch processes; </li><li>  balance the load. </li></ol><br>  And scaling? <br><br>  The technical capabilities of the puppet master server are not limitless, and if the loads on it become the maximum permissible, then the question of scaling arises. <br><br>  This problem is solved as follows: <br><ul><li>  The RPM package for our puppet server is stored in our repository; </li><li>  all manifestos, as well as configurations for God and Unicorn are in our Git repository. </li></ul><br>  To start another server is enough for us: <br><ol><li>  put the base system; </li><li>  install puppet-server, Unicorn, God; </li><li>  clone git repository; </li><li>  add car upstream. </li></ol><br>  At this, our "tuning" does not end, so let us return to the theory again. <br><br><h4>  Storeconfigs: what and why? </h4><br><br><img src="https://habrastorage.org/storage2/06b/7d9/163/06b7d9163062536500b3fdc69dded2d1.png"><br><br>  If a client sends us a report and facts about himself, then why not keep this information? <br><br>  This will help us Storeconfigs - option puppet-server, which allows you to store current customer information in the database.  The system compares the latest data from the client with the existing ones.  Storeconfigs supports the following storages: SQLite, MySQL, PostgreSQL.  We use MySQL. <br><br>  In our case, many clients pick up the configuration every three minutes, about the same send reports.  As a result, we already get large queues to write to MySQL.  But we still have to take data from the database. <br><br>  This problem received the following solution: <br><br><img src="https://habrastorage.org/storage2/57e/c96/485/57ec96485293b0f45ccd1a006c3cdd20.png"><br><br>  Using Apache ActiveMQ allowed us to send messages from clients not immediately to the database, but to pass them through the message queue. <br><br>  As a result, we have: <br><ul><li>  faster execution of the puppet process on the client, because when you try to send a report to the server, it immediately receives an ‚ÄúOK‚Äù (it is easier to put a message in the queue than to write it to the database); </li><li>  reducing the load on MySQL (the puppet queue process writes data to the database asynchronously). </li></ul><br>  To configure puppet-server, it was necessary to add the following lines to the configuration: <br><br><pre> <code class="ruby hljs">[main] async_storeconfigs = <span class="hljs-literal"><span class="hljs-literal">true</span></span> queue_type = stomp queue_source = <span class="hljs-symbol"><span class="hljs-symbol">stomp:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/ACTIVEMQ_address:61613 dbadapter = mysql dbuser = secretuser dbpassword = secretpassword dbserver = mysql-server</span></span></code> </pre><br>  And let's not forget about starting the puppet queue process. <br><br>  Thanks to the described settings, Puppet works on the server smartly and well, but it would be good to regularly monitor its activity.  It is time to remember about Puppet Reports. <br><br><h4>  Non-standard reporting </h4><br>  What is offered to us by default: <br><ul><li>  http; </li><li>  tagmai; </li><li>  log; </li><li>  rrdgraph; </li><li>  store. </li></ul><br>  Alas, none of the options completely satisfied us for one reason - the lack of a high-quality visual component.  Unfortunately, and perhaps fortunately, the standard Puppet Dashboard at that moment seemed too boring to us. <br><br>  Therefore, we opted for <a href="http://theforeman.org/">Foreman</a> , which pleased us with cute charts with the most necessary. <br><br><img src="https://habrastorage.org/storage2/922/218/d8f/922218d8f4b217593b141784375f0bda.jpg"><br><br><img src="https://habrastorage.org/storage2/1e9/c19/334/1e9c193346ea8b28b90305e30adc55cb.png"><br><br>  In the picture on the left we see how much time is spent on the use of each type of resources.  For 360 degrees, the total execution time on the client is taken. <br><br>  The picture on the right displays the number of events with the status.  In this example, only one service was launched, more than 10 events were missed due to the fact that their current state fully corresponds to the reference one. <br><br>  And the last recommendation: upgrade to version 3.0.0 <br><br><img src="https://habrastorage.org/storage2/fac/5ef/76d/fac5ef76d08801a550c655e81825c422.png"><br><br>  The graph clearly shows the time gain after the update.  True, productivity has grown not by 50%, as the developers promised, but the increase turned out to be quite tangible.  After editing the manifestos (see the <a href="http://projects.puppetlabs.com/issues/7285">message</a> ), we still achieved the promised 50%, so our efforts were fully justified. <br><br>  In conclusion, with proper configuration, Puppet is able to cope with serious workloads and configuration management for 2000 servers is well within its reach. <br><br>  <i>Anton [ <a href="https://habrahabr.ru/users/banuchka/" class="user_link">banuchka</a> ] Turkish, system administrator</i> <i><br></i>  <i>Badoo</i> </div><p>Source: <a href="https://habr.com/ru/post/157023/">https://habr.com/ru/post/157023/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157011/index.html">Version 1.0.0 of cross-browser framework for creating Kango extensions released</a></li>
<li><a href="../157013/index.html">New star</a></li>
<li><a href="../157017/index.html">Read only</a></li>
<li><a href="../157019/index.html">Samba4, Radius and PPTP using MS-CHAP v2</a></li>
<li><a href="../157021/index.html">Universal interface for image / video synchronization across devices.</a></li>
<li><a href="../157025/index.html">Book web programmer. Secrets of professional website development</a></li>
<li><a href="../157029/index.html">GlusterFS, the experience of the new version</a></li>
<li><a href="../157031/index.html">Bitcoin received official recognition</a></li>
<li><a href="../157033/index.html">Blacklist sites can benefit the Internet</a></li>
<li><a href="../157035/index.html">Patent trolling - now blamed Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>