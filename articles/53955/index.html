<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic access restriction through web authorization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often there is a need to provide access to a segment of the guest user network for a limited time. 

 I will tell a little about the task. 
 We have a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic access restriction through web authorization</h1><div class="post__text post__text-html js-mediator-article"> Often there is a need to provide access to a segment of the guest user network for a limited time. <br><br>  I will tell a little about the task. <br>  We have a wifi network or LAN in an Internet cafe where we need to provide time-based access to the Internet.  It is desirable that the management of the system be - set and forget, give the operator a generic password with the printer and hand the cash register to receive money. <br><a name="habracut"></a><br>  Many people come up with authorization schemes, scripts that change the firewall system tables from time to time according to the necessary tasks, and no one has written a fully dynamic system.  Therefore, I propose a prototype that any sysadmin adapts to his tasks. <br><br>  I think Linux system administrators will be able to implement this mechanism based on their favorite firewall, but we will use pf. <br>  Why pf you ask? <br>  Because it has a wonderful thing called dynamic tables. <br>  In the pf configuration file, the tables are described as: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>table &lt;wifiallow&gt; persist</code> <br> <br>  Table contents can be dynamically changed using the command line, as well as the <a href="http://www.wolfermann.org/pftabled.html">pftabled</a> utility.  The utility is a udp server that accepts commands for managing table contents. <br>  Using the command line, managing tables is very simple: <br> <code>pfctl -t tablename -T show -    <br> pfctl -t tablename -T expire 3600 -     1  <br> pfctl -t tablename -T add 10.10.10.10 -     <br> pfctl -t tablename -T delete 10.10.10.10 -     <br> pfctl -t tablename -T flush -   <br></code> <br>  pftabled allows you to add, delete, and flush operations using udp packages.  In the latest release of pftabled 1.07, there is a perl client for managing pftabled.  Naturally, all operations are performed only from authorized hosts with the same key as the listening server. <br><br>  So what do we need? <br>  apache with mod_rewrite module and the desire to implement this scheme. <br><br>  The basic principle of the scheme is simple.  If the host address is trying to access the Internet host is not in the table of permissions, then you need to transfer it to the web with a request to enter a username and password.  If the host is present in the table, it must be released to the Internet. <br>  in pf this is solved as follows <br> <code>$int_if = "xl0"; <br> $ext_if = "xl1"; <br> rdr on $int_if proto tcp from !&lt;wifiallow&gt; to any port 80 -&gt; $int_if port 8081 #      apache   <br> nat on $ext_if proto tcp from &lt;wifiallow&gt; to any -&gt; ($ext_if) # nat      <br></code> <br>  In the apache config, we create a virtual host and set rewrite rules for all incoming requests to our script. <br><br> <code>&lt;Directory "/usr/local/www/wifi-redir"&gt; <br> Options Indexes ExecCGI FollowSymLinks <br> Allow from all <br> RewriteEngine on <br> RewriteRule ^(.*)$ redirect.cgi?url=$1 [L] <br> RewriteRule ^redirect\.cgi$ - [L] <br> &lt;/Directory&gt; <br></code> <br>  The script accepts the request and issues an authorization form.  As the url parameter, the address requested by the user will be passed.  After submit and incorrectly entered login password inside the form, it is necessary to redirect to the referrer from which the form was filled.  If you skip this operation, the form will enter an infinite loop. <br>  If the login and password are correct, that using a piece from the perl client you immediately online simply add an entry to the wifiallow table and somewhere in your journal that the login and password is already used (to avoid abuse). Redirect to the url that the user originally requested.  The table of logins and passwords can be maintained in mysql or in any form convenient for you.  After the form has earned you add the line to crontab <br><br> <code>* * * * * /sbin/pfctl -t wifiallow -T expire 3600 &gt; /dev/null <br></code> <br>  which will every minute remove from the table IP addresses with a creation time of more than 1 hour.  The only problem that may arise is the support for pf connections already established.  The solution is simple.  We write a small script on shell + awk + grep, which will do pfctl -k hostip every one / five minutes (removal of keepstate connections) for hosts that are not in the table of allowed addresses. <br><br>  This scheme has been tested and works in our company.  I think it makes no sense to lay out the contents of the scripts and the current firewall settings, because each admin has his own situation with the distribution of dhcp addresses, a name resolution, etc.  The basic idea of ‚Äã‚Äãimplementation is described above. <br><br>  Good luck to you in the implementation and operation of this solution. </div><p>Source: <a href="https://habr.com/ru/post/53955/">https://habr.com/ru/post/53955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../53946/index.html">‚Äú1001 comments‚Äù - winning is never easier</a></li>
<li><a href="../53948/index.html">Choosing a strategy for starting and developing a project</a></li>
<li><a href="../53949/index.html">Idea: purchase and exchange service of used subscriptions for a fitness club / gym / pool</a></li>
<li><a href="../53950/index.html">Perfect "Web development" or the path from idea to finished project</a></li>
<li><a href="../53951/index.html">Information about Jabber servers in a convenient table</a></li>
<li><a href="../53958/index.html">Who needs SLA?</a></li>
<li><a href="../53960/index.html">Ruby will catch up with PHP in 4 years</a></li>
<li><a href="../53965/index.html">Silvermel - beautiful theme for Thunderbird and Firefox</a></li>
<li><a href="../53966/index.html">Bluetooth on Linux</a></li>
<li><a href="../53967/index.html">Timeline for the release of Diablo III</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>