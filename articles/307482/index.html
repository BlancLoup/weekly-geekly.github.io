<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telepathy on steroids in js / node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The stage of product support takes a lot of energy and nerves. The path from ‚ÄúI press and it does not work‚Äù to solve the problem, even with a first-cl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telepathy on steroids in js / node.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7a4/8f2/3ac/7a48f23ac12f4d859602e82eb8d0c630.jpg" alt="image" align="left">  The stage of product support takes a lot of energy and nerves.  The path from ‚ÄúI press and it does not work‚Äù to solve the problem, even with a first-class telepath, can take a lot of time.  The time during which the client / boss will be angry and unhappy. <br><br>  To reduce the time to solve a problem, you need to quickly find out about errors, to have as precise information as possible about what led to it and, preferably, to put everything together. <br><br>  I also will tell about the decision under a cat. <br clear="all"><a name="habracut"></a><br><h1>  1. Tasks </h1><br>  After discussion, it was decided to create a mechanism that collects error information from the client and server, and allows data to be transmitted or processed for subsequent response.  The mechanism should provide an opportunity in the future to add ways to work with data without unnecessary rewriting of the code and to allow changing the way of working, order, etc. from the config. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Key points: <br><ul><li>  Catching errors on both the frontend and the backend </li><li>  Ability to add multiple error handlers including  in future </li><li>  Large amount of debug information </li><li>  Flexible configuration for each project </li><li>  High reliability </li></ul><br><h1>  2. Decision </h1><br>  It was decided at the server start to load special error handlers - drivers, the order and priority of which will be loaded from the config.  Errors on the frontend will be sent to the server, where they will be processed along with the rest. <br><br>  The basic idea is that when an error occurs, and as the stack rolls back to the global area, debugging information will be added to the error class using distributed collectors.  When falling into the global area, the error will be intercepted and processed using the error driver. <br><br><h3>  2.1 Error class </h3><br>  The class of an error inherited from standard was written.  With a constructor accepting an error, the ability to specify an ‚Äúalarm level‚Äù and the addition of debug data.  The class is located in a single file for the front- and backend file of tools. <br><br>  <i>Hereinafter, the code uses the co, socket.io, and sugar.js libraries.</i> <br><div class="spoiler">  <b class="spoiler_title">Full class code</b> <div class="spoiler_text"><pre><code class="javascript hljs">app.Error = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error,lastFn</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(error &amp;&amp; error.name &amp;&amp; error.message &amp;&amp; error.stack){ ,       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name=error.name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.message=error.message; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stack=error.stack; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.clueData=error.clueData||[]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._alarmLvl=error._alarmLvl||<span class="hljs-string"><span class="hljs-string">'trivial'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._side=error._side || (<span class="hljs-built_in"><span class="hljs-built_in">module</span></span> ? <span class="hljs-string"><span class="hljs-string">"backend"</span></span> : <span class="hljs-string"><span class="hljs-string">"frontend"</span></span>);<span class="hljs-comment"><span class="hljs-comment">//  return; } if(!app.isString(error)) error='unknown error'; this.name='Error'; this.message=error; this._alarmLvl='trivial'; this._side=module ? "backend" : "frontend"; this.clueData=[]; if (Error.captureStackTrace) { Error.captureStackTrace(this, app.isFunction(lastFn)? lastFn : this.constructor); } else { this.stack = (new Error()).stack.split('\n').removeAt(1).join();//       } }; app.Error.prototype = Object.create(Error.prototype); app.Error.prototype.constructor = app.Error; app.Error.prototype.setFatal = function () {//getter/setters    this._alarmLvl='fatal'; return this; }; app.Error.prototype.setTrivial = function () { this._alarmLvl='trivial'; return this; }; app.Error.prototype.setWarning = function () { this._alarmLvl='warning'; return this; }; app.Error.prototype.getAlarmLevel = function () { return this._alarmLvl; }; app.Error.prototype.addClueData = function(name,data){//   var dataObj={}; dataObj[name]=data; this.clueData.push(dataObj); return this; };</span></span></code> </pre> <br></div></div><br>  And immediately use example for promise: <br><br><pre> <code class="javascript hljs">socket.on(fullName, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values</span></span></span><span class="hljs-function">) </span></span>{ &lt;...&gt; method(values)<span class="hljs-comment"><span class="hljs-comment">//  api .then(&lt;...&gt;) .catch(function (error) {//  throw new app.Error(error)//         .setFatal()// " " .addClueData('api', {//   fullName, values, handshake: socket.handshake }) }); });</span></span></code> </pre> <br>  For try-catch, we do the same. <br><br><h3>  2.2 Frontend </h3><br>  For the frontend, the snag is that an error can occur even before the transport library loads (socket.io in this case). <br><br>  We go around this problem by collecting errors in a temporary variable.  To intercept errors from the global scope, use window.onerror: <br><br><pre> <code class="javascript hljs">app.errorForSending=[]; app.sendError = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-comment"><span class="hljs-comment">//     app.io.emit('server error send', new app.Error(error)); }; window.onerror = function (message, source, lineno, colno, error) {//     app.errorForSending.push(//    . new app.Error(error) .setFatal());//    ,       }; app.events.on('socket.io ready', ()=&gt; {//    window.onerror = function (message, source, lineno, colno, error) {//  app.sendError(new app.Error(error).setFatal()); }; app.errorForSending.forEach((error)=&gt; {//  ,   app.sendError(error); }); delete app.errorForSending; }); app.events.on('client ready', ()=&gt; {//      window.onerror = function (message, source, lineno, colno, error) { app.sendError(error); }; });</span></span></code> </pre><br>  The problem remains that some libraries like not to throw out errors, but simply print them to the console.  Overwrite console functions to intercept data. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapConsole</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>[<span class="hljs-string"><span class="hljs-string">'$'</span></span> + name] = <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>[name];<span class="hljs-comment"><span class="hljs-comment">//   console[name] = function () { console['$' + name](...arguments);//   app.sendError( new app.Error(`From console.${name}: ` + [].join.call(arguments, '' ),//      console[name])//     (     v8) .addClueData('console', {//        consoleMethod: name, arg : Array.create(arguments) })[action]());//    }; } wrapConsole('error', 'setTrivial'); wrapConsole('warn', 'setWarning'); wrapConsole('info', 'setWarning');</span></span></code> </pre> <br><h3>  2.3 Server </h3><br>  We are left with the most interesting, for all who read up to this point and did not die of fatigue.  After all, it remains to implement not just the initialization and execution of drivers that receive errors, <br><ul><li>  Everything should work as quickly as possible, even if each driver in the process of initialization / error handling, you need to "talk heart to heart" with another server or calculate the answer to the main question of the universe of life and all that; </li><li>  A flexible system of spare and duplicate drivers; </li><li>  Dynamically run spare drivers, in case of failure of the previous ones; </li><li>  Exceptions that occur while drivers are running should be sent to working drivers; </li><li>  Catch and handle errors with frontend, as well as node.js falling into the global area. </li></ul><br>  All the code can be viewed on the githaba (link below), and now let's go through the main tasks: <br><br><ol><li>  <i>Parallel start</i> for speed <br>  For these purposes, we use yield [...] (or Promise.all (...)) given that each function from the array <i>should not throw an error</i> otherwise, if there are several functions with errors, we will not be able to process them all </li><li>  <i>Flexible configuration</i> <br>  All drivers are in the "driver package", which are located in the array by priority.  The error is sent immediately to the entire driver package, if the entire package does not work, the system proceeds to the next, etc. </li><li>  <i>Dynamic start</i> <br>  During initialization, we mark all drivers as ‚Äúnot started‚Äù. <br>  When starting the first driver package, we mark either as ‚Äústarted‚Äù or ‚Äúbad‚Äù. <br>  When sending, in the current package, skip ‚Äúbad‚Äù, send to ‚Äústarted‚Äù and start ‚Äúnot started‚Äù.  Drivers that throw out an error, mark as bad and go on.  If all drivers in the current package are marked as bad go to the next package. </li><li>  <i>Sending driver errors to still live drivers</i> <br>  If errors occur in the error drivers themselves (a bit of tautology), we write them into a special array.  After finding the first live driver, we send driver errors through it and the error itself (if the drivers fell while sending an error) and driver errors. </li><li>  <i>We catch errors with front / backend</i> <br>  Create a special api for frontend and catch the node.js exceptions via process.on ('uncaughtException', fn) and process.on ('unhandledRejection', fn) </li></ol><br><h1>  3. Conclusion </h1><br>  The outlined mechanism for collecting and sending error messages will allow you to instantly respond to errors, even before the end user, and do without questioning the end user for the last buttons pressed. <br><br>  If you think about the development, in the future you can add some useful features: <br><ul><li>  Change Disable Driver Disabling Policy <br>  For example, add the ability to re-check the driver for performance after some time. </li><li>  Ability to insert driver code on frontend <br>  Can be used to collect additional information. </li><li>  Logging preset <br>  <abbr title="don't repeat yourself">DRY</abbr> for repetitive functions of collecting general information (last downloaded pages, last used api) </li></ul><br><br>  A working example can be seen on the <a href="https://github.com/KotDaVinchi/DemoERSforHabr">githaba</a> .  For architecture, please do not scold, an example was made by the method remove-from-project-all-unnecessary. <br><br>  I would welcome comments. </div><p>Source: <a href="https://habr.com/ru/post/307482/">https://habr.com/ru/post/307482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307468/index.html">Why I love working with the web. Remy Sharp</a></li>
<li><a href="../307470/index.html">Mirantis Unlocked validation program. Part 2: Hard and Soft</a></li>
<li><a href="../307474/index.html">Minimally viable UX: SaaS (service application) design</a></li>
<li><a href="../307478/index.html">Identifying a region by phone number in Asterisk without using a database</a></li>
<li><a href="../307480/index.html">Why do problems arise with accounting solutions 1C? Typical automation session and full exposure</a></li>
<li><a href="../307484/index.html">"The effect of the cloud": ERP-systems go into the lead</a></li>
<li><a href="../307486/index.html">"Not a single processor": Virtual GPU</a></li>
<li><a href="../307488/index.html">"Memory Features": What does the processor cache and office clerk have in common?</a></li>
<li><a href="../307490/index.html">What is the reliability of the IaaS provider?</a></li>
<li><a href="../307492/index.html">The book "Logo and corporate identity. Designer's guide. 2nd ed. "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>