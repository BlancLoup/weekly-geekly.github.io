<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Postsharp: authorization and authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most popular applications of aspect-oriented programming is the removal of the serving infrastructure code, which is often repeated in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Postsharp: authorization and authentication</h1><div class="post__text post__text-html js-mediator-article">  One of the most popular applications of aspect-oriented programming is the removal of the serving infrastructure code, which is often repeated in the system, into a separate class.  Which, in turn, is a manifestation of the Single Responsibility Principle (SRP).  Very often, authorization and authentication tasks are scattered throughout the code, checking user access rights.  The consequence of this is the large labor-intensiveness of changes in this important part of logic, as well as its general verification.  The principle of common responsibility suggests that there should be only one reason for changing the class, so that everything that relates to authorization and authentication is simply requested in separate classes. <br><br>  Basic authentication methods are usually not what is used throughout the application.  For example, in web applications, data entry for authentication and authentication itself takes place on one page, after which information about the user is stored in a token with an expiration date.  Thanks to this, the user can automatically log in to the system during the token‚Äôs lifetime.  Thus, the only code that runs through all the pages of the application will be to verify that the user is still on the system.  Of course, you can use PostSharp for this check, but this is not the best way to apply, in my opinion. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Authorization, by contrast, is a good example of using PostSharp.  Too often, you can see how the logic of resolving actions based on user roles is horribly blurred throughout an application.  Just in these situations, PostSharp can be used to remove ‚Äúdirt‚Äù and leave only meaningful code.  In addition, sometimes role-based security is too extensive and a subtle tool is needed to regulate access.  For example, restrict data editing to everyone except the creator.  So let's take a look at a simple application that is very similar to the one I worked with as a consultant and see how PostSharp can help. <br><br>  Let the test application help people fill in some requests to state services.  It may be a web application, but we will use the WinForms application for simplicity.  Any user can fill out a request form, in our case it will be the only text field.  The system administrator can delete any requests, a simple user can only create them and view existing ones. <br><br>  I will not give here the full code of the program, I limit myself to the service class that provides basic functionality for the specified actions.  It will use the static collection as a repository, but in this application, of course, databases, services, etc. will be used. <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GovtFormService</span></span> : <span class="hljs-title"><span class="hljs-title">IGovtFormService</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IList _govtFormsDatabase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GovtFormService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// build up some initial entries of the static list } public void SubmitForm(GovtForm form) { _govtFormsDatabase.Add(form); } public IEnumerable GetAllForms() { return _govtFormsDatabase; } public GovtForm GetFormById(Guid guid) { return _govtFormsDatabase.FirstOrDefault(form =&gt; form.FormId == guid); } }</span></span></code> </pre> <br>  Here we simply associate the form with the service and assign methods from the service to button presses in order to finally get the basic application.  However, the requirements clearly indicate that the user should only be able to view their requests.  GetFormById currently does not make any checks.  You can add several conditions, but it‚Äôs better to create an aspect right away that can be used everywhere. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AuthorizeReturnValueAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">OnMethodBoundaryAspect</span></span>{    [NonSerialized] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IAuth Auth;    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RuntimeInitialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Reflection.MethodBase method</span></span></span><span class="hljs-function">)</span></span> {        Auth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthService();    }    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSuccess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodExecutionArgs args</span></span></span><span class="hljs-function">)</span></span> {        <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> singleForm = args.ReturnValue <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GovtForm;        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (singleForm != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) {            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Auth.CurrentUserHasPermission(singleForm, Permission.Read)) {                MessageBox.Show(                 <span class="hljs-string"><span class="hljs-string">"You are not authorized to view the details of that form"</span></span>,                 <span class="hljs-string"><span class="hljs-string">"Authorization Denied!"</span></span>);                args.ReturnValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span>;            }            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;        }    } }</code> </pre> <br>  One way to implement this is to check whether the intercepted method returns a type of GovtForm.  If yes, then check if the given request form belongs to the user.  Notice that the <strong>Auth</strong> type <strong>I</strong> field is marked as not serializable, and that it is initialized in the overridden RuntimeInitialize method.  In this case, the hardcode was used, but you can use the IoC container as a service locator (see the translation about Dependency Injection). <br><br>  Add some more code to the aspect so that you can work with the methods that return the GovtForm collection and filter the available request forms for the current user. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> formCollection = args.ReturnValue <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IEnumerable; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (formCollection != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) {    args.ReturnValue = formCollection            .Where(f =&gt; Auth.CurrentUserHasPermission(f, Permission.Read));    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  The GovtForm class is unremarkable except that it implements the UserName property.  You can add an ISecurable interface to each business object that you want to process according to the proposed approach.  Then the CurrentUserHasPermission method can be rewritten to take an argument of type ISecurable.  After this, it remains only to add the AuthorizedRecordsOnly attribute to all services and repositories that return a single business object or their collection so that the user can only see his or her request forms.  With this approach, you will not have to significantly change the code for the UI or services. <br><br>  Now that you are familiar with some useful aspects, it is time to consider a more comprehensive example.  Imagine that you have both the caching aspect and the authorization aspect for a particular method.  It is logical to assume that caching should go after authorization, otherwise access to the cached data can be obtained without access rights.  So how to make the authorization aspect work before caching? <br><br>  Here's how to do it: <br><ol><li>  Apply the ProvideAspectRoleAttribute attribute to the aspects of interest.  The role can be a string or you can use the StandardRoles enumeration from the PostSharp space. </li><li>  Apply the AspectRoleDependencyAttribute attribute to the aspects of interest to indicate the type of dependency and the role they depend on. </li></ol><br>  To solve the problem mentioned above, you need to apply attributes to the aspects like this: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] [AspectRoleDependency(AspectDependencyAction.Order,    AspectDependencyPosition.Before, StandardRoles.Caching)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AuthorizeReturnValueAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">OnMethodBoundaryAspect</span></span>{ } [Serializable] [ProvideAspectRole(StandardRoles.Caching)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CachingAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">OnMethodBoundaryAspect</span></span> {    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnEntry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodExecutionArgs args</span></span></span><span class="hljs-function">)</span></span> {        <span class="hljs-comment"><span class="hljs-comment">// do caching stuff    }    public override void OnSuccess(MethodExecutionArgs args) {        // do caching stuff    } }</span></span></code> </pre> <br>  With this code, we told PostSharp that the caching aspect is created with the Caching role and we also explicitly stated that the authorization aspect must be applied before any other aspect with the Caching role takes effect. <br><br>  And this is how the code of the GetAllForms method will look after both aspects are applied (obtained with the help of the Reflector program): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllForms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{    MethodExecutionArgs CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodExecutionArgs(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);    &lt;&gt;z__Aspects.a1.OnEntry(CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs);    IEnumerable CS$<span class="hljs-number"><span class="hljs-number">1</span></span>$<span class="hljs-number"><span class="hljs-number">1</span></span>__returnValue = _govtFormsDatabase;    &lt;&gt;z__Aspects.a1.OnSuccess(CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs);    CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs.ReturnValue = CS$<span class="hljs-number"><span class="hljs-number">1</span></span>$<span class="hljs-number"><span class="hljs-number">1</span></span>__returnValue;    &lt;&gt;z__Aspects.a0.OnSuccess(CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs);    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IEnumerable) CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs.ReturnValue; }</code> </pre> <br>  And for comparison, the code, if you specify everything correctly and change AspectDependencyPosition to Before: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllForms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{    &lt;&gt;z__Aspects.a1.OnEntry(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);    MethodExecutionArgs CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodExecutionArgs(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);    IEnumerable CS$<span class="hljs-number"><span class="hljs-number">1</span></span>$<span class="hljs-number"><span class="hljs-number">1</span></span>__returnValue = _govtFormsDatabase;    CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs.ReturnValue = CS$<span class="hljs-number"><span class="hljs-number">1</span></span>$<span class="hljs-number"><span class="hljs-number">1</span></span>__returnValue;    &lt;&gt;z__Aspects.a0.OnSuccess(CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs);    CS$<span class="hljs-number"><span class="hljs-number">1</span></span>$<span class="hljs-number"><span class="hljs-number">1</span></span>__returnValue = (IEnumerable) CS$<span class="hljs-number"><span class="hljs-number">0</span></span>$<span class="hljs-number"><span class="hljs-number">2</span></span>__aspectArgs.ReturnValue;    &lt;&gt;z__Aspects.a1.OnSuccess(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CS$<span class="hljs-number"><span class="hljs-number">1</span></span>$<span class="hljs-number"><span class="hljs-number">1</span></span>__returnValue; }</code> </pre> <br>  Notice that a1 (caching) and a0 (authorization) are swapped. <br><br>  PostSharp provides ample opportunities for setting aspect dependencies.  You have 5 actions to resolve dependencies: Commute, Conflict, Order, Require, and None.  In addition, you can create an infinite number of roles, if they are not enough in the StandardRoles enumeration.  Fortunately, you don‚Äôt often need these features, but it‚Äôs good to know about them to use when the time comes.  The most pleasant thing about this is that you can relax, knowing that even the newest member of the team will not issue data to the UI that needs authorization, since it will not matter in what order it applies aspects to the code. <br><br>  <em>Matthew</em> <em>D.</em>  <em>Groves software development engineer in</em> <em>&nbsp;</em>  <a href="http://telligent.com/"><em>Telligent</em></a> <em>.</em>  <em>His blog is</em> <a href="http://mgroves.com/"><em>mgroves</em> <em>.</em></a>  <a href="http://mgroves.com/"><em>com</em></a> <em>.</em> <br><br>  <a href="http://www.sharpcrafters.com/">PostSharp</a> : <a href="http://www.sharpcrafters.com/">Logging</a> <a href="http://habrahabr.ru/blogs/net/124860/">and auditing</a> , <a href="http://habrahabr.ru/blogs/net/123480/">caching</a> , <a href="http://habrahabr.ru/blogs/net/125098/">delayed dependency loading</a> . </div><p>Source: <a href="https://habr.com/ru/post/125319/">https://habr.com/ru/post/125319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125311/index.html">Twitter text advertising</a></li>
<li><a href="../125315/index.html">Foxconn to supply 1 million robots</a></li>
<li><a href="../125316/index.html">Facebook will pay for found bugs for $ 500</a></li>
<li><a href="../125317/index.html">Overview of free tools for pentest web-resources and not only v2</a></li>
<li><a href="../125318/index.html">New to the transition from iOS to Android</a></li>
<li><a href="../125321/index.html">New features of Firebug 1.8</a></li>
<li><a href="../125322/index.html">Alpha version of the computer Raspberry Pi for $ 25 went into production</a></li>
<li><a href="../125323/index.html">Unemployment in Silicon Valley vs. rest of America or is grass really greener on the other side?</a></li>
<li><a href="../125325/index.html">YouTube Hangouts Live on Google+ Hangouts</a></li>
<li><a href="../125326/index.html">Nintendo has sales problems with Nintendo 3DS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>