<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Large-scale migration of records in the database: how it does Stripe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translator's note : We at Latera are engaged in creating billing for telecom operators . We will write about the features of the system and the detail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Large-scale migration of records in the database: how it does Stripe</h1><div class="post__text post__text-html js-mediator-article">  <b>Translator's note</b> : <i>We at Latera are engaged in creating <a href="http://www.hydra-billing.ru/">billing for telecom operators</a> .</i>  <i>We will write about the features of the system and the details of its development in our blog on Habr√©, but you can learn something interesting from the experience of other companies.</i>  <i>Today we bring to your attention an adapted translation of a <a href="http://robertheaton.com/2015/08/31/migrating-bajillions-of-database-records-at-stripe/">note by an</a> engineer of financial startup Stripe about how his team migrated a huge number of records in the database.</i> <br><br> <a href="http://habrahabr.ru/company/latera/blog/266111/"><img src="https://habrastorage.org/files/b28/e81/91f/b28e8191f9ca4241ac5cb37d170be750.jpg"></a> <br><br>  Stripe for receiving payment uses a huge number of sellers, and recently the project team completed a project called ‚ÄúA very large migration of large amounts of data between several databases without loss, work stoppages and errors in the system responsible for the daily transfer of a huge amount of finance‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As Stripe engineer Robert Heaton described the project: ‚ÄúConceptually everything is simple here, but the devil (and the ability to sleep at night) is in the details.‚Äù <a name="habracut"></a><br><br><h4>  0. Principle </h4><br>  In Stripe, there is a table of Merchants and AccountApplication account applications.  Each merchant has a AccountApplicaion, and previously these tables contained all the information about the seller, including such trivial data as email_font_color and self_estimated_yearly_turnover (annual turnover by own estimation) and much more important (required by law so-called know your customer, KYC) business_name and tax_id_number. <br><br>  To launch the <a href="https://stripe.com/connect">Stripe Connect</a> project, it was necessary to create a system that tells Connect Applications what important information is required for each of the connected vendors.  Requirements may vary by country, type of business and other factors.  To make the system simple and convenient, it was necessary to extract all the KYC data and put them into one LegalEntity table. <br><br>  As Khaton says: ‚ÄúIf we could stop our system for a short time, and if we were robots who never make a hint of a mistake, then we would simply tell the sellers not to sell anything for a while, transferred all the data, and then launched the system. "  However, in reality it was impossible to do so, of course. <br><br>  During the migration of a huge amount of data, the system will continue to be used by a whole bunch of vendors who need to write and read new information.  In such a situation, it is very easy to make a mistake, which will lead to the reading of old information and the failure to record a new one. <br><br>  In addition, such migration is a large-scale project that cannot be done in one fell swoop and then pray that everything will work.  Instead, it was decided to move in small steps and track all changes in the system. <br><br>  Simplified, the migration scheme looks like a change in the data reading scheme with this: <br><br><img src="https://habrastorage.org/files/305/b4d/6c2/305b4d6c26cc4795b62b4b1f00f58b4b.jpg"><br><br>  on this: <br><br><img src="https://habrastorage.org/files/528/8e0/1d4/5288e01d444349388be5a1dc484d3826.jpg"><br><br>  And data records with this: <br><br><img src="https://habrastorage.org/files/90f/353/b7d/90f353b7d82346739212ab927b8fddba.jpg"><br><br>  on this: <br><br><img src="https://habrastorage.org/files/c9a/807/e0b/c9a807e0b2ce424ebeeb5a21f459518e.jpg"><br><br>  All this happened in four stages. <br><br><h4>  1. Data Migration </h4><br>  It all started with creating a LegalEntity model in ORM Stripe and a related table in the database.  After creation, it did not contain any data on which no action was taken. <br><br><pre><code class="bash hljs">class LegalEntity end</code> </pre> <br>  Then it was necessary to duplicate the records of the corresponding Merchant and AccountApplication entities into the equivalent of LegalEntity.  That is, when writing occurred in <code>Merchant#owner_first_name</code> , then the data were simultaneously recorded in <code>LegalEntity#first_name</code> .  At this point, the old data in LegalEntity has not yet been migrated, so the Merchant and AccountApplication tables remained the ‚Äúsource of truth‚Äù. <br><br>  Here is the code used here: <br><br><pre> <code class="sql hljs">class Merchant <span class="hljs-comment"><span class="hljs-comment"># Each Merchant has a LegalEntity prop :legal_entity, foreign: LegalEntity def self.legal_entity_proxy(merchant_prop_name, legal_entity_prop_name) # Redefine the Merchant setter method to also write to the LegalEntity merchant_prop_name_set = :"#{merchant_prop_name}=" original_merchant_prop_name_set = :"original_#{merchant_prop_name_set}" alias_method original_merchant_prop_name_set, merchant_prop_name_set if method_defined?(merchant_prop_name_set) define_method(merchant_prop_name_set) do |val| self.public_send(original_merchant_prop_name_set, val) self.legal_entity.public_send(:"#{legal_entity_prop_name}=", val) end end legal_entity_proxy :owner_first_name, :first_name before_save do # Make sure that we actually save our LegalEntity double-write. # This "multi-save" can cause confusion and unnecessary database calls, # but is a necessary evil and will be unwound later self.legal_entity.save end end merchant.owner_first_name = 'Barry' merchant.save merchant.legal_entity.first_name # =&gt; Also 'Barry'</span></span></code> </pre><br>  All this was launched in production for a couple of days to see possible errors.  As a result, the threads were updated as follows.  Reading: <br><br><img src="https://habrastorage.org/files/305/b4d/6c2/305b4d6c26cc4795b62b4b1f00f58b4b.jpg"><br><br>  Record: <br><br><img src="https://habrastorage.org/files/434/f9d/b6e/434f9db6e2e54270afd25f8576b37d70.jpg"><br><br>  Then, a passage through all the records of Merchant and AccountApplication was performed with the subsequent migration of the necessary data to LegalEntity.  Duplication of the record allows you to ensure that during the migration process, even data that is added to the initial tables after it has been transferred is transferred. <br><br><h4>  2. Start reading from LegalEntity </h4><br>  Thus, the synchronization of the LegalEntity table with the Merchant and AccountApplication tables was guaranteed.  Then Stripe engineers redirected all eg calls.  merchant.owner_first_name to read data from the new LegalEntity table.  Data continued to be recorded in the two original tables.  Proxy was implemented using a special flag that was set in the system interface.  When problems were detected, you could switch to reading from the Merchant table to find the error. <br><br><pre> <code class="sql hljs">class Merchant prop :legal_entity, foreign: LegalEntity def self.legal_entity_proxy(merchant_prop_name, legal_entity_prop_name) <span class="hljs-comment"><span class="hljs-comment"># # UPDATED: Now we also redefine the Merchant getter method to read from the LegalEntity # alias_method :"original_#{merchant_prop_name}", merchant_prop_name if method_defined?(merchant_prop_name) define_method(merchant_prop_name) do self.legal_entity.public_send(legal_entity_prop_name) end # We continue to write to both tables for safety merchant_prop_name_set = :"#{merchant_prop_name}=" original_merchant_prop_name_set = :"original_#{merchant_prop_name_set}" alias_method original_merchant_prop_name_set, merchant_prop_name_set if method_defined?(merchant_prop_name_set) define_method(merchant_prop_name_set) do |val| self.public_send(original_merchant_prop_name_set, val) self.legal_entity.public_send(:"#{legal_entity_prop_name}=", val) end end legal_entity_proxy :owner_first_name, :first_name before_save do self.legal_entity.save end end merchant.owner_first_name # =&gt; calls legal_entity.first_name, which should be the same as Merchant#owner_first_name anyway</span></span></code> </pre><br>  Now the streams have undergone regular changes.  Reading: <br><br><img src="https://habrastorage.org/files/e2a/70d/567/e2a70d56708a42909efe3d59fbd203fd.jpg"><br><br>  Record: <br><br><img src="https://habrastorage.org/files/434/f9d/b6e/434f9db6e2e54270afd25f8576b37d70.jpg"><br><br>  After the testing of the new code was completed successfully, it is time to disable the data recording in both the old tables and the new LegalEntity.  To do this, in the old tables the corresponding fields and columns were deleted, which stopped writing to them.  Now <code>merchant.owner_first_name</code> written and read only to and from the LegalEntity table, and there is no longer an <code>owner_first_name</code> entity in the Merchant table. <br><br>  Now the reading process looks like this: <br><br><img src="https://habrastorage.org/files/e2a/70d/567/e2a70d56708a42909efe3d59fbd203fd.jpg"><br><br>  A record - so: <br><br><img src="https://habrastorage.org/files/21a/842/12b/21a84212b4a54e4cb06f60699a20f611.jpg"><br><br>  Data migration is complete, but optimization remains.  When saving objects, numerous requests to the database are still performed, and the whole process depends on several pieces of code and a proxy created on the knee.  The code definitely needed to be cleaned up. <br><br><h4>  3. Reading and writing directly to the LegalEntity table </h4><br>  For each Merchant and AccountApplication entity that is proxied to LegalEntity, grep selects the code for reading and writing and replaces it with one that indicates direct operation with LegalEntity.  For example, the code: <br><br> <code>merchant.owner_first_name = 'Barry' <br></code> <br><br>  would look like this: <br><br> <code>legal_entity.first_name = 'Barry' <br></code> <br><br>  As a result, data streams once again change.  Reading: <br><br><img src="https://habrastorage.org/files/528/8e0/1d4/5288e01d444349388be5a1dc484d3826.jpg"><br><br>  Record: <br><br><img src="https://habrastorage.org/files/c9a/807/e0b/c9a807e0b2ce424ebeeb5a21f459518e.jpg"><br><br>  It may also be that someone adds calls to the fields that engineers are trying to remove.  There is nothing wrong with that, since these calls will be proxied to the corresponding LegalEntity entities. <br><br>  However, as a result, proxying will be disabled, and at this point you need to log all obsolete fields and add code that makes requests to these fields not work, but no errors are issued: <br><br><pre> <code class="sql hljs">class Merchant prop :legal_entity, foreign: LegalEntity def self.legal_entity_proxy(merchant_prop_name, legal_entity_prop_name) alias_method :"original_<span class="hljs-comment"><span class="hljs-comment">#{merchant_prop_name}", merchant_prop_name if method_defined?(merchant_prop_name) define_method(merchant_prop_name) do # # UPDATED: We add in logging # log.info('Deprecated method called') self.legal_entity.public_send(legal_entity_prop_name) end merchant_prop_name_set = :"#{merchant_prop_name}=" original_merchant_prop_name_set = :"original_#{merchant_prop_name_set}" alias_method original_merchant_prop_name_set, merchant_prop_name_set if method_defined?(merchant_prop_name_set) define_method(merchant_prop_name_set) do |val| # # UPDATED: We add in logging # log.info('Deprecated method called') self.legal_entity.public_send(:"#{legal_entity_prop_name}=", val) end end end</span></span></code> </pre><br>  When requests to obsolete fields in the database cease to appear in the logs (according to the plan, this should take from 2-7 days), proxying is permanently deleted, since it is no longer necessary. <br><br><pre> <code class="sql hljs">class Merchant prop :legal_entity, foreign: LegalEntity <span class="hljs-comment"><span class="hljs-comment"># REMOVED # # def self.legal_entity_proxy(merchant_prop_name, legal_entity_prop_name) # # etc # end # # legal_entity_proxy :owner_first_name, :first_name before_save do self.legal_entity.save end end</span></span></code> </pre><br><h4>  4. Disable multisaving </h4><br>  All data is now read and written directly to LegalEntity.  However, the saving process is still duplicated - Merchant still saves LegalEntity data.  You often see such lines: <br><br><pre> <code class="sql hljs">legal_entity.first_name = 'Barry' merchant.save</code> </pre><br>  In principle, it works, but not as beautiful as it could be.  To remove confusing elements, but at the same time save everything you need, you can write to the logs all the places where <code>merchant.save</code> (or similar things) somehow affect the change of fields in legal_entity, and change the <code>before_save</code> sections as follows: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Merchant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prop</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">legal_entity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LegalEntity</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_save</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> # </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Our</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ORM</span></span></span><span class="hljs-class">'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dirty</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fields</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">legal_entity</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">updated_fields</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">empty</span></span></span><span class="hljs-class">? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">legal_entity</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">save</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">log</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">info</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Multi</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">saved</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">an</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">updated</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  It was also decided to implement a flag to enable the multistore option.  If necessary (if someone is too nervous), it can always be easily activated. <br><br>  Over the next few days, the Stripe team studied the logs for the presence of the phrase <code>'Multi-saved an updated model'</code> in order to find out all the places where saving Merchant and AccountApplicaion also affects saving New Data to LegalEntity.  This table is saved before changes are saved in another model, which leads to setting an empty value in the field <code>legal_entity.updated_fields</code> - in such a situation nothing will appear in the logs.  And here is the code: <br><br><pre> <code class="sql hljs">legal_entity.first_name = 'Barry' merchant.business_url = 'http://foobar.com' merchant.save</code> </pre><br>  activates logging, as merchant.save will also save the new <code>LegalEntity#owner_name</code> .  It needs to be changed to: <br><br><pre> <code class="java hljs">legal_entity.first_name = <span class="hljs-string"><span class="hljs-string">'Barry'</span></span> legal_entity.save merchant.business_url = <span class="hljs-string"><span class="hljs-string">'http://foobar.com'</span></span> merchant.save</code> </pre><br>  Here <code>legal_entity</code> save itself previously. <br><br>  After the logs were empty and all such flaws were cleared, the multi-save was removed.  Now all the data is where it is supposed to be, there are no crutches in the form of proxying queries and no meta-programming is used. <br><br><pre> <code class="sql hljs">class Merchant prop :legal_entity, foreign: LegalEntity <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h4>  5. Conclusion </h4><br>  Throughout the migration, the Stripe team did not make a single change without subsequent empirical verification of the fact that it did not cause errors in the operation of the system.  All updates were carried out gradually, step by step, which made it possible to minimize the risk of serious damage to the system.  The approach with the use of duplicate records in the old and new source, with the subsequent gradual shutdown of the first - is a safe way to make such transfers. <br><br>  As Stripe engineer Robert Heaton says: <br><br><blockquote>  If you ever want to write one huge pull request to migrate a huge amount of anything, think twice about whether there is any possibility to make the whole process not so terribly dependent on luck.  If the answer is ‚Äúno‚Äù, before starting the process, you should take care of false documents and credit history, which will help you to leave the country (and most likely you will have to do it soon) and start a new life in Brazil. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/266111/">https://habr.com/ru/post/266111/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266101/index.html">Color Deconvolution at Wolfram Mathematica</a></li>
<li><a href="../266103/index.html">Akka, actors and reactive programming</a></li>
<li><a href="../266105/index.html">Autumn Rambler.iOS Meeting</a></li>
<li><a href="../266107/index.html">3CX API - what are they and what to do with them? Third Party Plugins (Part 2)</a></li>
<li><a href="../266109/index.html">GPS service ViaLatM - scripting language</a></li>
<li><a href="../266113/index.html">Vertical padding between columns using Sass using the bootstrap grid example</a></li>
<li><a href="../266115/index.html">Development of trading robots: search for market inefficiencies. Part 2</a></li>
<li><a href="../266117/index.html">Playing pure Java from beginner, for beginners</a></li>
<li><a href="../266119/index.html">Security Week 36: jailbreak-robbery, farewell to RC4, porosity of routers</a></li>
<li><a href="../266121/index.html">Setting the overall balance of games three in a row</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>