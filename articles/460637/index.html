<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Light control on ZigBee</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello friends! Today I want to tell you about an interesting development of a remote lighting control system. 



 A modern house is a huge amount of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Light control on ZigBee</h1><div class="post__text post__text-html js-mediator-article">  Hello friends!  Today I want to tell you about an interesting development of a remote lighting control system. <br><br><img src="https://habrastorage.org/webt/ro/yx/l6/royxl62-z2oqpfn6hwt5izou3_y.jpeg" alt="image"><br><br>  A modern house is a huge amount of wires to at least somehow reduce and streamline their number comes to the rescue of the radio.  In fact, such a system is not new, but in conditions of limited budget it has fully justified itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Looking ahead, I want to immediately show the functional diagram of the control system. <br><br><img src="https://habrastorage.org/webt/fh/ey/gj/fheygj8s-fn_phg3oqnva6ajrye.jpeg" alt="image"><br>  <i>Fig.</i>  <i>one</i> <br><br>  Anyone interested under the cat. <br><a name="habracut"></a><br>  The logical question is why is all this necessary?  The use of a wireless light control system gives: <br><br><ul><li>  Reducing the number of wires from each switch to the junction box in the room. </li><li>  The possibility of implementing pass-through switches. </li><li>  Flexibility to control any load from any switch as well as the use of normally closed normally open buttons. </li><li>  The ability to implement any temporary shutter speeds on / off. </li></ul><br>  The technical task, at the beginning was just in words and looked very dull and incomprehensible.  The point is that in a two-story cottage with an area of ‚Äã‚Äã208m.kv, it is necessary to control the on / off of the internal lighting, the system should be powered from 220v to switch 21-23pcs.  loads (lamps) with a power not exceeding 200W.  At the time of the first inspection of the object, everything looked like this <br><br><img src="https://habrastorage.org/webt/cz/bi/_b/czbi_bdenvipzshelqjbmh0himq.jpeg"><br>  <i>Fig.</i>  <i>2. The main part of communications is laid in the floor then it is all poured with a concrete tie</i> <br><br><img src="https://habrastorage.org/webt/sh/h-/7m/shh-7mxsspyefbi-nlti3wisn8m.jpeg"><br>  <i>Fig.</i>  <i>3. Place to install the control cabinet on the second floor</i> <br><br>  A strong recommendation was to use as few wires as possible.  Ideally, only those that are already laid in the floor, walls and ceiling, they go from the installation site of the switchboard to each light bulb.  For electromagnetic compatibility of all devices in the house, it was not recommended to use conventional wi-fi.  There are countless such devices and the customer has a point in his head that the devices in the house will begin to live their life and the multivarka included will affect the light in the bathroom or toilet.  The first thing I did was sketched a structural scheme, as I imagine the solution to this problem.  In fig_4 this option. <br><br><img src="https://habrastorage.org/webt/80/wk/x2/80wkx2kcoelxunryvcivzi8n7e8.jpeg"><br>  <i>Fig.</i>  <i>4. Functional scheme of lighting control.</i> <br><br>  The basis was taken from the Texas Instruments CC2530 radio module which supports ZiegBee technology and is quite simply programmed in C ++ with the help of IAR-studio 5.5.  Directly switching loads is performed using relay modules WB-MR6 (wirenboard) I chose this element, because in a compact package on a din-rail, six relays with non-dependent channels are installed, the 16A control takes into account all the features of switching general-purpose power loads in tons. h  with large starting currents: control of LED lights, incandescent lamps, pulsed power supplies.  Plus, each relay contact is surge protected by a varistor.  It was necessary to install six of such modules in order to calmly manage the specified number of loads.  All WB-MR6 are connected via ModBus interface into a single network.  Each relay module is set to the address corresponding to the wiring diagram and the whole system with input pads, fuses, circuit breakers is rather tightly mounted in two distribution boxes ShchMP2-1 500x400x150.  For the compact placement of 46 input cables 3x1.5 (single-core copper) had to change the traditional position of the din-rails on the vertical. <br><br><img src="https://habrastorage.org/webt/xv/fx/mn/xvfxmnadqjpt8l0wy8jtzxmaopo.jpeg"><br>  <i>Fig.</i>  <i>5. Switchboard with the placement of lighting control devices.</i> <br><br>  It should be noted that the incredibly useful function of the WB-MR6 was the ability to control the relay outputs by simply connecting normally open buttons to the bottom terminal block, for a temporary wiring diagram, this is what you need.  T.K.  control by ModBus appeared five months later, after the assembly and installation of switchboards.  During this time, all cables going to each load were completely checked and numbered.  And a detailed switching scheme was drawn up, with the switch control logic - a light bulb in fig_6. <br><br><img src="https://habrastorage.org/webt/59/ca/lj/59caljsa6bx9fv1bkzm6x9cgz2g.jpeg"><br>  <i>Fig.</i>  <i>6. Scheme of lighting control and placement of loads and survey modules.</i> <br><br>  According to the survey modules, I can say the following: the functional diagram shown in fig_7 turned out to be quite efficient.  Almost nothing had to be redone, the radio frequency module ss2530 allows you to assign any inputs to any outputs.  The only exception is UART (pin20-Tx, pin21-Rx). Most of the list of items was bought on ‚ÄúAli.‚Äù Printed circuit boards were ordered in ‚Äúresonate‚Äù. They soldered all twenty pieces with their hands, but it was hard, it took a week to complete, not everything at once turned out need to.  But gained invaluable experience mounting SMD components. <br><br><img src="https://habrastorage.org/webt/vv/a3/d6/vva3d686ixu6dxa3rh-fxmemqig.jpeg"><br>  <i>Fig.</i>  <i>7. Functional diagram of the button poll module</i> <br><br>  The process of debugging the system and bringing it into a fully operational state took a little more than three months.  The first steps after assembling the boards of fig_8, checking on the power supply and connecting to the programmer, were writing a program for polling the buttons and generating control commands for the WB-MR6 relay modules via the ModBus bus. <br><br><img src="https://habrastorage.org/webt/zj/qq/cg/zjqqcgo-dewjpy6dpqvydmmjpu4.jpeg"><br>  <i>Fig.</i>  <i>8. Button polling module</i> <br><br>  It was pretty quick and easy.  One relay button module without a network interface is connected to one relay module via RS485.  Immediately managed to apply the resulting success on the object Fig_9, twisted pair UTP, from the buttons located in the bedroom, was laid in advance.  With the mounting of the modules, he didn‚Äôt particularly wisely, the self-adhesive platforms and plastic clamps help a lot. <br><br><img src="https://habrastorage.org/webt/qq/2m/f2/qq2mf2-bsvhphquu_bb_bikcajw.jpeg"><br>  <i>Fig.</i>  <i>9. Fastening modules for polling buttons.</i> <br><br>  Next, programmatically added an address to each module that was set using the dip switch and the corresponding switching card for the master / slave mode of operation and transmission of commands via radio.  The step in front was serious and therefore there were a lot of difficulties in debugging.  The most serious is the transfer of information about the pressed button to the master module connected to the Modbus bus as soon as the zig-bee data transfer protocol was activated, everything turned out to be several times more complicated.  For those who read up here, I can say that the problem was that the timers in the processor core work unpredictably, more precisely in the IAR compiler, you need to constantly specify its settings when you call the time counting procedure.  To find a way to solve this problem, the functions of monitoring and control of data transmitted by radio were added.  The control of the button press in the service mode was instantly displayed in the hyper-terminal of the computer that is connected via the RS485-USB adapter to the polling module.  Another serious problem with the organization of the lighting control network was the insufficient range of the radio interface.  More or less, surely everything was switched only within the table on which the model was assembled.  This is a consequence of the features of the energy-saving mode of the CC2530, its default function is to reduce the radiation power, after the formation of the link, I don‚Äôt know why, but it was found through jtag in the step-by-step debugging mode.  After turning off this mode, the network began to work within only one floor in the cottage; in fact, the commands for turning on / off the lights were processed by the server, only from the polling modules located within 12-14m.  Provided that there were no walls.  To solve this problem, the replacement path of the CC2530 module with a planar antenna was chosen to the module with an external antenna (with the IPEX connector), all the more so as we managed to successfully buy three modules in the E18-MSI-IPX plus version of the antenna and cable in one of the St. Petersburg online stores.  All this was quickly soldered, the angles for fixing the antennas were made and screwed to the transition plates Fig_10. <br><br><img src="https://habrastorage.org/webt/es/20/je/es20jewxb7gxff5iefdsr9uzmbu.jpeg"><br>  <i>Fig.</i>  <i>10. Using an external antenna</i> <br><br>  The result of such an obgreyda rather puzzled me - because the range has not changed much, I would even say that it has slightly decreased.  I began to look for a way out of this situation in optimizing the algorithms of the program, the initial settings of the CC2530 had to be re-read the car of the datasheets and forums on this topic.  The goal was to make each module on the network work as a repeater, especially since this feature is enabled by default and is supported by any device using the Zig-Bee protocol.  But in my case it was not obvious.  As a result, I decided to introduce an additional module into the system, which would have a unique firmware activated by raising only pin_6 on the dip switch.  He had to, was on the ceiling of the first floor and simply broadcast the accepted commands, i.e.  be a signal booster. <br><br>  I have to say, it was a dead end.  But during the implementation of this idea, I accidentally measured the parameters of the ‚Äúblack‚Äù antenna, which I was sold in an online store with a CC2530 and a cable.  The network analyzer showed a CWS 1.9 at a frequency of 2.4 GHz - comments are unnecessary, you need to make your antenna.  A request to the search engine immediately gives the correct answer, the antenna "Clover" and detailed instructions for manufacturing. <br><br><img src="https://habrastorage.org/webt/8f/fo/2s/8ffo2soyaf4iikrhcw75ymoxwwi.jpeg"><br>  <i>Fig.</i>  <i>11. Antenna and device for its manufacture.</i> <br><br>  Literally in the evening I made three pieces of these antennas, checked them with a CWS of no worse than 1.2.  I can not say about the other characteristics, radiation pattern and gain.  But the fact is that the range of confident reception and sending commands has doubled.  Pic_12 <br><br><img src="https://habrastorage.org/webt/ye/ba/bd/yebabdzcf80hy4yoaoilnapxxz4.jpeg"><br>  <i>Fig.</i>  <i>12. Measurement of antenna parameters</i> <br><br>  As a result, it was possible to achieve a normal reception of the server signal on all 12 polling modules installed in the cottage.  So  the requirement of the TZ is completely fulfilled in time; I almost met the set deadlines.  Customer satisfied. </div><p>Source: <a href="https://habr.com/ru/post/460637/">https://habr.com/ru/post/460637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460629/index.html">The probability that 2 miners have the same world</a></li>
<li><a href="../46063/index.html">‚ÄúAttention Profile‚Äù and ‚ÄúFavorite Authors‚Äù</a></li>
<li><a href="../460631/index.html">Around the badge for 80 days: on the other side OFFZONE</a></li>
<li><a href="../460633/index.html">Details of the implementation of RSTP and proprietary Extended Ring Redundancy</a></li>
<li><a href="../460635/index.html">CLRium # 6: Concurrency</a></li>
<li><a href="../46064/index.html">The British encroached on the "Classmates"</a></li>
<li><a href="../460641/index.html">YouTokenToMe: tool for quick tokenization of text from the VKontakte Team</a></li>
<li><a href="../460645/index.html">Doing well, doing badly: writing ‚Äúevil‚Äù code with Go, part 1</a></li>
<li><a href="../460647/index.html">The solution to the task with pwnable.kr 05 - passcode. Rewriting the procedure link table via format string vulnerability</a></li>
<li><a href="../460651/index.html">Meeting of the Society of Anonymous Testers: TMS, monitoring monitoring, search quality assessment and native iOS tests</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>