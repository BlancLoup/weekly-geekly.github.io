<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using a synthesizer as a computer keyboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently a thought occurred to me: is it possible, having connected a synthesizer to a computer, to type text on it? I tried to implement it, and I di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using a synthesizer as a computer keyboard</h1><div class="post__text post__text-html js-mediator-article">  Recently a thought occurred to me: is it possible, having connected a synthesizer to a computer, to type text on it?  I tried to implement it, and I did it.  My program reads the keystrokes of the synthesizer and emulates the keystrokes of a conventional keyboard.  In this article I will tell how to implement it.  We will write under Linux on C ++ using Qt. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/u64tWZl-x1g%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhhNs-wlBNakVwCx7M0okpv9f_A9fg" frameborder="0" allowfullscreen=""></iframe><br><br><a name="habracut"></a><br><h3>  Reading data from a synthesizer </h3><br>  So, there is a laptop with Linux and a synthesizer Yamaha DGX-200.  We connect the synthesizer through the USB connector to the laptop and see that the device is recognized: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/6e6/6f2/25e/6e66f225e748dbb152b798c989b0635f.png"><br><br>  From the device comes a constant stream of questions, among which other characters appear when you press the keys of the synthesizer.  By the way, an interesting fact: if you write this output to a file, and then read from the file and write back to / dev / midi2, then the synthesizer through its columns reproduces those notes that were pressed during recording, but without pauses. <br><br>  The next task is the analysis of this stream.  After a long search in google, I decided to use the <a href="http://portmedia.sourceforge.net/portmidi/">portmidi</a> library.  The documentation for it is rather scant, I haven‚Äôt found any working examples at all.  Well, now will be one more example.  Get the list of devices: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = Pm_CountDevices(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PmDeviceInfo* info = Pm_GetDeviceInfo(i); qDebug() &lt;&lt; i &lt;&lt; <span class="hljs-string"><span class="hljs-string">": "</span></span> &lt;&lt; info-&gt;name &lt;&lt; <span class="hljs-string"><span class="hljs-string">" input: "</span></span> &lt;&lt; info-&gt;input &lt;&lt; <span class="hljs-string"><span class="hljs-string">" output: "</span></span> &lt;&lt; info-&gt;output; }</code> </pre> <br>  I got this result: <br><pre> <code class="hljs lua"><span class="hljs-number"><span class="hljs-number">0</span></span>: Midi Through Port<span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: Midi Through Port<span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: YAMAHA Portable G MIDI <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: YAMAHA Portable G MIDI <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  For further work with the device, we need to know only the id, which is listed at the beginning of the line.  Device 3 is suitable for us - input (input = 1) stream from our synthesizer.  Open the desired stream: <br><pre> <code class="cpp hljs">PortMidiStream* stream = <span class="hljs-number"><span class="hljs-number">0</span></span>; PmError e = Pm_OpenInput(&amp;stream, good_id, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e != pmNoError) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Can't open input, error: "</span></span> &lt;&lt; e &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre><br>  After that, we periodically read the data.  I used a Qt-slot with a periodic timer call, but the usual while (true) and sleep is also suitable. <br><pre> <code class="cpp hljs">PmEvent event; <span class="hljs-comment"><span class="hljs-comment">// ,       int c = Pm_Read(stream, &amp;event, 1); //      if (c &gt; 0 &amp;&amp; Pm_MessageStatus(event.message) == 144) { unsigned int note = Pm_MessageData1(event.message), volume = Pm_MessageData2(event.message); //   note  volume }</span></span></code> </pre><br>  To clarify what these magic numbers are, I will tell you how the MIDI commands are arranged. <br><br><h3>  MIDI commands </h3><br>  Each message (also known as a MIDI command) consists of three integers, which are called status, data1, data2 in portmidi.  A table with possible statuses can be found <a href="http://computermusicresource.com/MIDI.Commands.html">here</a> .  We are only interested in the status of 144 - the change in the state of the note on the first channel.  In data1, the note number is transmitted, and in data2, its volume.  For example, when you press the ‚Äúbefore‚Äù key of the first octave on the synthesizer, the command <b>144 60 95</b> comes, and when you release - <b>144 60 0</b> . <br><br>  The volume varies from 0 to 127 and depends on the strength of the impact on the key.  Theoretically, you can display capital letters instead of lowercase letters when the user hits the keyboard hard.  Well, the note number is just a sequence number, the correspondence of the notes to the numbers can be seen in this picture: <br><img src="http://habrastorage.org/storage2/48f/8e4/2af/48f8e42afade8816ae240dcbcefcbc15.gif"><br><h3>  The designation of notes and chords </h3><br>  I decided to designate the note as ‚Äú3C‚Äù or ‚Äú3C #‚Äù, where 3 is the number of the octave (and the octave starts with ‚ÄúA‚Äù, it's easier), C is the note designation (‚Äúbefore‚Äù), and if necessary, a sharp is added.  Here is how it is implemented: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Note</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Note(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> midi_number); <span class="hljs-function"><span class="hljs-function">QString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tone, octave; }; Note::Note(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> midi_number) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = midi_number - <span class="hljs-number"><span class="hljs-number">21</span></span>; octave = n / <span class="hljs-number"><span class="hljs-number">12</span></span>; tone = (n - octave * <span class="hljs-number"><span class="hljs-number">12</span></span>); } QString Note::to_string() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QObject::tr(<span class="hljs-string"><span class="hljs-string">"%1%2"</span></span>).arg(octave).arg( tone == <span class="hljs-number"><span class="hljs-number">0</span></span>? <span class="hljs-string"><span class="hljs-string">"A"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-string"><span class="hljs-string">"A#"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">2</span></span>? <span class="hljs-string"><span class="hljs-string">"B"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">3</span></span>? <span class="hljs-string"><span class="hljs-string">"C"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">4</span></span>? <span class="hljs-string"><span class="hljs-string">"C#"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">5</span></span>? <span class="hljs-string"><span class="hljs-string">"D"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">6</span></span>? <span class="hljs-string"><span class="hljs-string">"D#"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">7</span></span>? <span class="hljs-string"><span class="hljs-string">"E"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">8</span></span>? <span class="hljs-string"><span class="hljs-string">"F"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">9</span></span>? <span class="hljs-string"><span class="hljs-string">"F#"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">10</span></span>? <span class="hljs-string"><span class="hljs-string">"G"</span></span>: tone == <span class="hljs-number"><span class="hljs-number">11</span></span>? <span class="hljs-string"><span class="hljs-string">"G#"</span></span>: <span class="hljs-string"><span class="hljs-string">"??"</span></span> ); }</code> </pre><br>  If the user presses a chord (several notes simultaneously), then several messages come almost immediately.  We can programmatically monitor this situation and distinguish single clicks from chords.  In my program you can put different chords in correspondence with different letters.  To get the chord designation, we combine the plus designations of the keys included in it: ‚Äú3C # + 3E + 3G #‚Äù.  When the user presses a note or chord, the program looks for a string in the layout that matches this designation, and emulates pressing the corresponding key.  When the key on the synthesizer is released, the release of the key is emulated.  Modifiers (Shift, Ctrl, etc.) are no different from other keys.  All combinations work as expected. <br><br><h3>  Keystroke Emulation </h3><br>  Hooray, we can determine when notes are pressed and released.  Now we learn to emulate keystrokes.  We will use the solution I found on <a href="http://stackoverflow.com/a/1262539/344347">Stack Overflow</a> . <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;X11/Xlib.h&gt; #include &lt;X11/keysym.h&gt; #include &lt;X11/extensions/XTest.h&gt; Display* display = XOpenDisplay(0); void emulate_key(QString key, bool pressed) { KeySym sym = XStringToKeysym(key.toAscii()); if (sym == NoSymbol) { qWarning() &lt;&lt; "Failed to emulate key: " &lt;&lt; key; return; } XTestFakeKeyEvent(display, XKeysymToKeycode(display, sym), pressed, 0); XFlush(display); }</span></span></span></span></code> </pre><br>  I added the use of the XStringToKeysym function to emulate a key by its name, which we will take from the configuration file.  A list of valid keys can be found in the header file /usr/include/X11/keysymdef.h. <br><br>  The layout will be stored in the layout.ini file of the following form: <br><pre> <code class="hljs vbscript">; letters X = <span class="hljs-number"><span class="hljs-number">3</span></span>C#+<span class="hljs-number"><span class="hljs-number">3</span></span>G# Y = <span class="hljs-number"><span class="hljs-number">3</span></span>D#+<span class="hljs-number"><span class="hljs-number">3</span></span>G# Z = <span class="hljs-number"><span class="hljs-number">3E+3</span></span>G# ; navigation <span class="hljs-built_in"><span class="hljs-built_in">Space</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>E Return = <span class="hljs-number"><span class="hljs-number">1</span></span>A+<span class="hljs-number"><span class="hljs-number">2</span></span>A BackSpace = <span class="hljs-number"><span class="hljs-number">4</span></span>C# Delete = <span class="hljs-number"><span class="hljs-number">4</span></span>D# <span class="hljs-built_in"><span class="hljs-built_in">Left</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>A <span class="hljs-built_in"><span class="hljs-built_in">Right</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>C</code> </pre><br><h3>  Layout </h3><br>  There remains the last task - to come up with a layout.  A simple option - each letter on the key - turned out to be inconvenient.  The keys are enough, but end-to-end, besides, you often have to carry hands because of the large dimensions of the synthesizer.  Fortunately, we can use keyboard shortcuts, and it is much more convenient to press them on a synthesizer than on a computer keyboard. <br><br>  Let's try to fit on 26 keys (from A to G #) 26 Latin letters.  The choice of letters for the seven white keys is obvious - these are letters from A to G, which are the generally accepted notation for the corresponding notes.  Then I wrote out the remaining letters in decreasing order of frequency and tried to make a word from the letters that are closer to the top of the list.  I got the word HINTS, and I gave these five letters to the black keys.  For the rest of the keys, I assigned the major and minor third in the same octave in alphabetical order.  There are still a lot of options for placing other letters (for example, Russian). <br><br>  The rest of the keys, too, found a place on the keyboard.  I got this layout: <br><br><img src="http://habrastorage.org/storage2/9d3/901/f3e/9d3901f3ed30b866e8ad412ed97e3d16.png"><br><br>  A music score editor, MuseScore, was used. <br><br>  The video attached to the post shows a set of the Hello world program and its compilation using a synthesizer instead of a keyboard. <br><br>  The program code is laid out on <a href="https://github.com/Riateche/piano-keyboard">Github</a> . </div><p>Source: <a href="https://habr.com/ru/post/143893/">https://habr.com/ru/post/143893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143887/index.html">Infinite scrolling, as a dubious interface improvement</a></li>
<li><a href="../143888/index.html">Recover dead pixels by freezing</a></li>
<li><a href="../143890/index.html">Scala Conference in St. Petersburg in 4 days</a></li>
<li><a href="../143891/index.html">Create a cloud for software testing</a></li>
<li><a href="../143892/index.html">Gamification diet</a></li>
<li><a href="../143894/index.html">What applications are you testing?</a></li>
<li><a href="../143895/index.html">The average identifier length in popular JavaScript libraries is 8.27 characters.</a></li>
<li><a href="../143896/index.html">We are waiting for everyone on the bright side of power!</a></li>
<li><a href="../143898/index.html">Entertaining geodesy</a></li>
<li><a href="../143899/index.html">VLC Anniversary - One Billion Downloads</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>