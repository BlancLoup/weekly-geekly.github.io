<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we designed and implemented a new network on Huawei in the Moscow office, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous series: "Jet" switched to a new network based on a well-known vendor. How did the process of auditing the systems, collecting the hote...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we designed and implemented a new network on Huawei in the Moscow office, part 2</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://en.wikipedia.org/wiki/Banksy"><img src="https://habrastorage.org/webt/ep/l9/eo/epl9eo1kpw7j0_9u4wpibn2fsqa.jpeg"></a> <br><br>  In the previous series: "Jet" switched to a new network based on a well-known vendor.  How did the process of auditing the systems, collecting the hotelok and taming the ‚Äúmutant reserve‚Äù take place in the <a href="https://habr.com/ru/company/jetinfosystems/blog/455397/">first part</a> ? <br><br>  This time I will talk about the process of migration of users (more than 1600 people) from the old network to the new one.  I invite all interested in under cat. <br><a name="habracut"></a><br>  So, the existing network of the company as of last summer: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  the simplest topology ‚Äúcollapsed backbone‚Äù - the core of the network (it‚Äôs also the distribution level) is formed by two network-level switches integrated into a VSS cluster; </li><li>  the access level is represented by switches and stacks of data link switches installed in the cross and sometimes directly in the corridors and even in the working premises; </li><li>  part of the access switches is included in the chain, that is, the switch is connected to another switch, and the latter is already in the core; </li><li>  Fault tolerance of connecting access switches to the core is provided mainly through LACP, sometimes it is not provided at all; </li><li>  access control - via VLAN, VLAN routing - on the core; </li><li>  access switches from three manufacturers and four generations are used, users connect at speeds from 100 Mbps to 1 Gbps; </li><li>  some users still use analog phones, some - IP phones connected via PoE injectors, and a minority have IP phones that receive PoE power from access switches. </li></ul><br>  Task: <br><br><ul><li>  bring the network into a decent view; </li><li>  not to disrupt the work of employees during the modernization; </li><li>  fix the maximum possible number of problems that have accumulated over the previous 15 years of operation. </li></ul><br><h2>  Old life </h2><br>  Previously, the system of operating and expanding the network in the office was as follows: Suppose that we need to organize jobs for new employees.  Additional space was rented in the business center, repairs were made, SCS was laid, and then a computer and telephone network was deployed. <br><br>  At one workplace accounted for, depending on the needs of the unit, from 2 to 4 outlets RJ-45.  One of the sockets was assigned by telephone (received green markings), the rest (from one to three) were assigned by computer (received blue markings). <br><br><img src="https://habrastorage.org/webt/v0/zv/in/v0zvin26ha7a5gtzwjspbi2wtpo.jpeg"><br>  <i>Outlets on a typical workplace</i> <br><br>  At the construction stage of the network, each computer outlet was connected to a separate port of the access switch, each telephone socket was connected to the analog port of the telephone exchange (in old premises) or to the access switch port pre-configured for VoIP data transmission (in new premises). <br><br>  Such a scheme was convenient for service operation.  Users moved to a new building, connected a computer to any free computer outlet, a telephone to any free telephone outlet. <br><br>  After that, the technical support staff, focusing on the MAC addresses of the connected equipment, prescribed the necessary VLANs and other parameters on the ports of the access switches. <br><br>  But the approach had a flaw - it was uneconomical, up to half of the ports remained unused.  Such a reserve is useful if, over time, additional workplaces are organized indoors, but we have not been able to use the reserve of 50% even once. <br><br><h2>  Preparing for migration </h2><br>  At the first stage, we decided to replace all access switches.  The model of the <a href="https://e.huawei.com/ru/products/enterprise-networking/switches/campus-switches/s5720-si-model">Huawei S5720</a> family, specifically the S5720-52X-PWR-SI-AC, was chosen as the standard.  Its characteristics: <br><br><ul><li>  connects to the trunk at a speed of 10 Gbit / s; </li><li>  stacked on conventional 10G interfaces; </li><li>  Allows connection to all user ports at a speed of 1 Gb / s; </li><li>  provides PoE-powered on all user ports. </li></ul><br>  Thus, a computer, an IP phone, a computer via an IP phone, wireless access points, a surveillance camera, and other devices can be connected to any port. <br>  We had to find out which sockets in the rooms are actually used and what is connected to them.  We had: <br><br><ul><li>  data of old and not very old projects laying of SCS; </li><li>  "Not quite relevant" cable magazines for all company premises; </li><li>  MAC address tables on existing access switches that we received using the built-in network hardware; </li><li>  tables of correspondence of MAC addresses of telephone sets and internal numbers of subscribers - from a telephone exchange. </li></ul><br>  Next, we wrote a small script that, on the basis of this data, made up the switching and migration tables (a separate table for each next stage of work).  They contained the following information: <br><br><ul><li>  room; </li><li>  port marking at the workplace; </li><li>  marking of the outlet on the patch panel in the cross; </li><li>  the name (hostname) of the old switch (stack); </li><li>  port number on the old switch; </li><li>  VLAN ID; </li><li>  MAC address of the connected device (or several); </li><li>  the type of the connected device (determined by the MAC address); </li><li>  the name (hostname) of the new switch (stack); </li><li>  port number on the new switch. </li></ul><br><img src="https://habrastorage.org/webt/nw/aw/6-/nwaw6-oll4db0lducpx63za8bae.png"><br>  <i>Script results</i> <br><br>  From such a table, it was immediately obvious what exactly is connected to a specific port - a computer, a phone, a computer through a phone (if there are two MAC addresses), or something more complicated. <br>  On the basis of the tables, design engineers developed new cable journals, and implementation engineers pre-configured new switches, which at the next migration stage were installed in cross-over ones. <br><br><img src="https://habrastorage.org/webt/h3/fc/qc/h3fcqcnl0nlwi_02uhno0l_rkm8.png"><br>  <i>Fragment of a new cross magazine</i> <br><br><img src="https://habrastorage.org/webt/ei/8b/zk/ei8bzktczslzi3jmp4pcqxm2s8g.png"><br>  <i>Access Port Settings</i> <br><br>  Thus, the work was as follows: <br><br><ul><li>  disable old access switches, remove patch cords; </li><li>  install new access switches, connect power; </li><li>  perform switching on the cross log; </li><li>  bypass work areas, make sure that phones and computers work normally. </li></ul><br>  It looks simple, but ... <br><br><h2>  The first stage is the replacement of access switches: <s>three months of work without holidays</s> </h2><br>  From the middle of 2018, we spent three months replacing access switches every weekend and re-switching workplaces according to our migration tables (about 3,500 ports in total). <br>  The first migration took us more than 12 hours; during this time we managed to replace one access stack of five switches and rewire approximately 200 ports connected to it. <br>  It took me most of the time ... to prepare patch cords.  Each patch cord had to be removed from the package and pasted on both sides of the tag with the number.  Only after this patch cord could be used for switching. <br><br>  During the next migrations, we optimized the process and prepared patch cords in advance.  Therefore, the last migration took the same 12 hours, and during this time we managed to replace five access stacks, from 3 to 5 switches in each, and rewired more than 1000 ports. <br><br>  What did we get in the end? <br><br>  First, the updated cross magazine, which we shared with the maintenance service.  The service has developed its own web application to maintain the current state of switching - it is now always possible to familiarize yourself with it on the internal resource. <br><br>  Secondly, jobs connected to new modern access switches.  In parallel, we finally got rid of analog phones and separate power supplies for IP phones, updated and unified the firmware in IP phones so that the phone and the switch correctly identify each other using the LLDP protocol.  This is necessary in order for the phone to understand in which VLAN-e it should transmit voice frames, and in which - frames of equipment connected via the phone.  In this way, the telephone can access the telephone exchange servers, and users can connect computers at workplaces either directly to the outlet or via the telephone. <br><br>  Third, we turned off all unused ports of active equipment and set up the port security function.  In parallel, we formulated, agreed and approved the regulations on connections, now there are no connections "past the cashier". <br><br>  Thus, we: <br><br><ul><li>  put in order and documented all the office equipment connections; </li><li>  got rid of old switches, PoE-injectors, analog phones; </li><li>  reduced energy consumption of equipment (for individual cross-over and work premises - up to 30%); </li><li>  improved user experience and kept a reasonable reserve of active equipment ports (at the cost of some increase in the workload of technical support specialists, especially when moving employees to new premises). </li></ul><br><h2>  Migrating at the height - switching to a new highway </h2><br>  After the completion of the first stage, the situation with user connections returned to normal, but nothing changed with the trunk.  As mentioned above, before the upgrade it was arranged quite simply.  There were about 100 VLANs that were routed on the central switch, or rather, on two switches, clustered using VSS technology. <br><br>  In parallel with the first stage of migration, we built and tested a new highway in accordance with the principles outlined in the <a href="https://habr.com/ru/company/jetinfosystems/blog/455397/">first article</a> : <br><br><ul><li>  installed core switches Huawei CE8850; </li><li>  installed Huawei CE6870 distribution switches; </li><li>  paved additional fiber optic; </li><li>  completed all connections; </li><li>  configured the overlay and underlay routing protocols (but until the first stage was completed, the switches were idle and the air warmed up). </li></ul><br>  Then the next stage of migration began.  Not very long, but the most difficult. <br><br>  To begin with, we developed and agreed a new IP addressing plan that takes into account our current and future needs.  In the new plan, separate ranges were allocated for all planned L3VPNs - for ordinary users and users of the technical center, for telephony systems, video conferencing, video surveillance cameras, demonstration stands of various types and other needs. <br><br>  Then we connected the entire old network to one pair of distribution switches as a single access stack.  After that, we started switching stacks to a new trunk with changing VLAN numbers and, accordingly, changing the IP addresses of connected users to new ranges. <br><br>  We planned to work so that at a time to switch a large enough group of access switches.  Worked either at night or on weekends, depending on the specifics of the work of the switching units. <br><br>  Before starting work, we performed the following operations in advance: <br><br><ol><li>  set up a corporate DHCP server so that it issues IP addresses from the new range for the users to be switched; </li><li>  set up ports on distribution switches in which it was planned to include access switches during migration; </li><li>  With the help of another specially developed script, modified configurations for switchable switches were prepared. </li></ol><br>  Worked in the following order: <br><br><ol><li>  switched access switches from the old trunk to the new; </li><li>  make sure that the switches are accessible via the control interface; </li><li>  flooded the switched switches with a previously prepared configuration for changing VLAN numbers. </li></ol><br>  Before performing the above work, the VLAN containing the control interfaces of all access switches was ‚Äústretched‚Äù between the old and the new backbone, so step 2 usually took a minimum of time.  In the simplest case, user workstations (as well as telephones, printers and other devices) immediately received IP addresses from the new range from the DHCP server and continued to work without changes. <br><br><img src="https://habrastorage.org/webt/bo/nr/jz/bonrjz1h2qz30l0nrglsotacjbe.png"><br><br><h2>  Where are no problems? </h2><br>  On this way we encountered several difficulties. <br>  First, many users have stopped working printers.  At the workstations of some users, access to the printers was configured at a specific IP address.  After switching printers to a new range, they received new addresses, and users lost access to them.  To solve the problem, the next day after the migration, we allocated one support specialist for half a working day so that it went around the users who had migrated and reconfigured the printers to use not DNS addresses, but DNS names. <br><br>  During the migration of the very first group of users, we had to solve some problems with the correct configuration of firewalls, so that they allowed the moved users to the necessary corporate resources.  And with all subsequent migrations, we already knew in advance what needs to be configured. <br><br>  Last but not least, we moved the service center, namely the staff on duty shift.  The duty shift should work continuously and around the clock, always have access to the resources needed for work, and to the information systems of customers.  For these people, we organized temporary jobs at pre-agreed time and in separate rooms.  One officer on duty shift went into this room, making sure that he can get access to all the necessary systems.  After that, the rest went into this room. <br><br>  Then we migrated the relevant unit, invited one of the staff members on duty to return to their place and check the availability of all necessary resources.  Promptly eliminated problems, if any.  There were few problems.  After that, the shift on duty again moved from the "temporary shelter" to the normal mode of operation in their workplaces with the entire set of information systems they needed. <br><br>  At some point we found that in the old network there was not a single user workstation!  <s>And opened the champagne.</s>  Next, we started to migrate the server segment.  Another scheme was applied to it, since the server usually cannot be stopped even for 15 minutes.  I will tell you about this separately in the next article. <br><br>  <i>Maxim Klochkov</i> <i><br></i>  <i>Senior Consultant, Network Audit and Complex Projects Group</i> <i><br></i>  <i>Network Solution Center</i> <i><br></i>  <i>Jet Infosystems</i> </div><p>Source: <a href="https://habr.com/ru/post/459118/">https://habr.com/ru/post/459118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459104/index.html">C # or Java? TypeScript or JavaScript? Classification of machine learning based programming languages</a></li>
<li><a href="../459108/index.html">Tesla is going to present several surprises at once in the second half of this year.</a></li>
<li><a href="../45911/index.html">Twiddler2</a></li>
<li><a href="../459110/index.html">Writing a bot for fishing in the game Albion Online in Python</a></li>
<li><a href="../459116/index.html">One step closer to restoring the thymus</a></li>
<li><a href="../45912/index.html">Setting up backup in Ubuntu</a></li>
<li><a href="../459120/index.html">Modular Embedded Computers UNO-1000/2000 Series</a></li>
<li><a href="../459128/index.html">Japanese interfaces in the real world</a></li>
<li><a href="../45913/index.html">Live cook book: our culinary and software hobby</a></li>
<li><a href="../459130/index.html">Careful error handling in microservices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>