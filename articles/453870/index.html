<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write Reverse socks5 proxy on powershell. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story of research and development in 3 parts. Part 1 - research. 
 There are many beeches - there is even more benefit. 

 Formulation of the prob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write Reverse socks5 proxy on powershell. Part 1</h1><div class="post__text post__text-html js-mediator-article">  The story of research and development in 3 parts.  Part 1 - research. <br>  There are many beeches - there is even more benefit. <br><br><h3>  Formulation of the problem </h3><br>  In the course of pentesting and RedTeam campaigns, it is not always possible to use Customer‚Äôs standard tools, such as VPN, RDP, Citrix, etc.  as a fixation for entering the internal network.  Somewhere a regular VPN works on MFA and the iron token is used as the second factor, somewhere it is monitored severely and our VPN input immediately becomes visible, as they say - with all the consequences, but somewhere there is simply no such means. <br><br>  In such cases, we constantly have to do so-called ‚Äúreverse tunnels‚Äù - connections from the internal network to an external resource or a server controlled by us.  Inside such a tunnel, we can already work with the internal resources of the Customers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are several variations of such reverse tunnels.  The most famous of them, of course, is the Meterpreter.  Also in great demand among the popular hacker masses are SSH tunnels with reverse forwarding of ports.  There are a lot of means for the implementation of reverse tunneling and many of them are well studied and described. <br><br>  Of course, for their part, the developers of security solutions do not stand aside and actively detect such actions. <br><br>  For example, MSF-sessions are successfully detected by modern IPS from Cisco or Positive Tech, and a reverse SSH-tunnel can be detected by almost any normal normal firewall. <br><br>  Therefore, in order to remain unnoticed in a good RedTeam campaign, we need to build a reverse tunnel with non-standard means and as closely as possible adjust to the real network operation mode. <br><br>  Let's try to find or invent something similar. <br><a name="habracut"></a><br>  Before you invent something you need to understand what result we want to achieve, what functions our development should perform.  What are the requirements for the tunnel so that we can work in the mode of maximum secrecy? <br><br>  It is clear that for each case such requirements may vary greatly, but according to work experience, we can single out the main ones: <br><br><ul><li>  work on Windows 7-7.  Since most corporate networks use Windows; </li><li>  the client connects to the server via SSL to prevent ips from stupid listening by means of ips; </li><li>  when connecting, the client must support work through a proxy server with authorization, since  In many companies, access to the Internet occurs through a proxy.  In fact, the client machine may not even know about it, and the proxy is used in a transparent mode.  But such a functionality, we must lay; </li><li>  the client part must be concise and portable; <br>  It is clear that to work within the Customer‚Äôs network, you can install OpenVPN on a client machine and raise a full-fledged tunnel to your server (since openvpn clients can work through a proxy).  But, firstly, it does not always work out, since we may not be local administrators there, and secondly, it will cause so much noise that a decent SIEM or HIPS will immediately ‚Äútrick it on us‚Äù on us.  Ideally, our client should be the so-called inline command, as many bash shells are implemented for example, and run via the command line, for example, when executing commands from a word macro. </li><li>  our tunnel must be multi-threaded and support multiple connections simultaneously; </li><li>  the client-server connection must have any authorization so that the tunnel is established only for our client, and not for everyone who comes to our server at the specified address and port.  Ideally, for "third-party users", a landing page should be opened with cats or professionally related to the source domain. <br>  For example, if the Customer is a medical organization, then the information security administrator, who decided to check the resource that the clinic employee addressed, should open a page with pharmaceutical products, Wikipedia describing the diagnosis or Dr. Komarovsky‚Äôs blog, etc. </li></ul><br><h3>  Analysis of existing tools </h3><br>  Before reinventing your bike, you need to make an analysis of existing bikes and see if we really need it and, probably, not only we thought about the need for such a functional bike. <br><br>  Googling on the Internet (we google it seems to be normal), as well as a search on the github for the keyword "reverse socks" did not give very many results.  Basically, it all comes down to building ssh-tunnels with reverse port forwarding and everything connected with it.  In addition to SSH tunnels, there are several solutions: <br><br>  <b><a href="https://github.com/klsecservices/rpivot">github.com/klsecservices/rpivot</a></b> <br>  Old implementation of the reverse tunnel from the guys from Kaspersky Lab.  By name it is clear what this script is for.  Implemented in Python 2.7, the tunnel works in cleartext mode (as it is fashionable to say now, hello RKN) <br><br>  <b><a href="https://github.com/tonyseek/rsocks">github.com/tonyseek/rsocks</a></b> <br>  Another implementation on python, also in cleartext, but more features.  It is written as a module and there is an API for integrating the solution into your projects. <br><br>  <b><a href="https://github.com/llkat/rsockstun">github.com/llkat/rsockstun</a></b> <br>  <b><a href="https://github.com/mis-team/rsockstun">github.com/mis-team/rsockstun</a></b> <br>  The first link is the original version of the implementation of the socks reverse on the goal (not supported by the developer). <br><br>  The second link is our refinement with additional chips, also on the goal.  In our version, we implemented SSL, working through a proxy with NTLM authorization, authorization on the client, landing page with the wrong password (or rather, redirecting to the landing page), multi-threaded mode (ie, several people can work with the tunnel at the same time) , the client's ping system for whether it is live or not. <br><br>  <b><a href="https://github.com/jun7th/tsocks">github.com/jun7th/tsocks</a></b> <br>  The implementation of reverse socks from our "Chinese friends" on python.  In the same place for the lazy and "immortal" is already ready binary (exe), assembled by the Chinese and ready for use.  Here only one Chinese god knows that in this binary there may be more than the main functionality, so use at your own risk. <br><br>  <b><a href="https://github.com/securesocketfunneling/ssf">github.com/securesocketfunneling/ssf</a></b> <br>  Quite an interesting C ++ project for the implementation of reverse socks and more.  In addition to the reverse tunnel, it can do port forwarding, create a command shell, etc. <br><br>  <b>MSF meterpreter</b> <br>  Here, as they say, no comment.  All more or less educated hackers are well aware of this thing and understand how easy it is to find the means of protection. <br><br>  All the above tools work on a similar technology: on a machine inside the network, a previously prepared executable binary module is launched that establishes a connection with an external server.  The server runs SOCKS4 / 5 server, which accepts connections and transmits them to the client. <br><br>  The disadvantage of all of the above tools is that either Python or Golang is installed on the client machine (have you often seen installed Python on machines, for example, a company director or office workers?), Or you need to drag a pre-assembled binary into this machine (in fact, python and the script in one bottle) and run this binary is already there.  And loading an exe with its subsequent launch is still that signature for a local antivirus or HIPS. <br><br>  In general, the conclusion suggests itself - we need a solution for powershell.  Now tomatoes will fly into us - they say powershell - this is all beaten, it is monitored, blocked, etc.  etc.  In fact - not everywhere.  Responsibly declare.  By the way, there are a lot of ways to bypass the blocking (here again a fashionable phrase about hello RKN :)), starting from the blunt renaming of powershell.exe -&gt; cmdd.exe and ending with powerdll, etc. <br><br><h3>  We start to invent </h3><br>  It is clear that at first we will look in Google and ... we will not find anything on this topic (if someone found it - throw links in the comments).  There is only the <a href="https://github.com/p3nt4/Invoke-SocksProxy">implementation of</a> Socks5 on powershell, but this is the usual "direct" socks, which has some of its drawbacks (we will talk about them later).  You can, of course, turn it into a reverse movement with a slight movement of your hand, but this will be just a single-flow socks, which is not exactly what is necessary for us. <br><br>  So, we did not find anything ready, so we still have to reinvent our bicycle.  For the basis of our bike, we take <a href="https://github.com/mis-team/rsockstun">our development of</a> reverse socks on the goal, and implement the client to it with powershell. <br><br>  <b>RSocksTun</b> <br><br>  So how does rsockstun work? <br><br>  The basis of RsocksTun (hereinafter referred to as rs) is based on two software components - Yamux and Socks5 server.  Socks5 server is the usual local socks5, it runs on the client.  And the multiplexing of connections to it (remember about multithreading?) Is provided by using yamux ( <a href="https://github.com/hashicorp/yamux/">yet another multiplexer</a> ).  This scheme allows you to run several client socks5 servers and distribute external connections to them, forwarding them through a single TCP connection (almost as in meterpreter) from client to server, thereby implementing a multi-threaded mode, without which we simply cannot work fully in the internal network. <br><br>  The essence of yamux's work is that it introduces an additional network layer of the streams, implementing it in the form of a 12-byte header for each packet.  (Here we intentionally use the word ‚Äústream‚Äù, not the stream, so as not to confuse the reader with the program thread ‚Äúthread‚Äù - we will also use this concept in this article).  Inside the yamux header contains the stream number, flags for installing / terminating the stream, the number of bytes transmitted, the size of the transmission window. <br><br><img src="https://habrastorage.org/webt/ga/go/we/gagowe129appe4mb67fwca2rumi.jpeg"><br><br>  In addition to installing / terminating a stream, yamux implements a keepalive mechanism that allows you to monitor the performance of an established communication channel.  The mechanism of the keeplive-messages is configured when creating a Yamux session.  Actually, from the settings there are only two parameters: enable / disable and the frequency of sending packets in seconds.  Keepalive messages can be sent by the yamux server, so the yamux client.  When a keepalive message is received, the remote side is obliged to respond to it by sending the exact same message identifier (actually a number) that it accepted.  In general, keepalive is the same ping, only for yamux. <br><br>  In detail, the whole multiplexer operation technique: package types, installation flags and connection terminations, the data transfer mechanism is described in <a href="">the</a> yamux <a href="">specification</a> . <br><br><h3>  Conclusion to the first part </h3><br>  So, in the first part of the article we met with some tools for organizing reverse tunnels, looked at their advantages and disadvantages, studied the mechanism of operation of the Yamux multiplexer and described the main requirements for the newly created powershell module.  In the next part, we will develop the module itself, practically from scratch.  To be continued.  Do not switch :) </div><p>Source: <a href="https://habr.com/ru/post/453870/">https://habr.com/ru/post/453870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453860/index.html">AMD has introduced its new custom 7 nm processors Ryzen third generation</a></li>
<li><a href="../453862/index.html">Why you should use pathlib</a></li>
<li><a href="../453864/index.html">Using a mouse and keyboard on consoles is cheating?</a></li>
<li><a href="../453866/index.html">API Request with React Hooks, HOC or Render Prop</a></li>
<li><a href="../453868/index.html">Touch mini switch co with glass panel on nRF52832</a></li>
<li><a href="../453872/index.html">We restore photos using neural networks</a></li>
<li><a href="../453874/index.html">From Russian Roulette to secure LOTO: how to protect data center personnel</a></li>
<li><a href="../453876/index.html">How Yandex.Practicum won the front-end desync: acrobatic number with Redux-Saga, postMessage and Jupyter</a></li>
<li><a href="../45388/index.html">Flower router</a></li>
<li><a href="../453882/index.html">Big guide to the profession of decision architect (+ list of useful links)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>