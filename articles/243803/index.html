<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Statically verifiable references to Java bean properties</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When you use a tool for a long time and seriously, inevitably there are complaints about it - inconveniences that you put up with first, but at some p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Statically verifiable references to Java bean properties</h1><div class="post__text post__text-html js-mediator-article">  When you use a tool for a long time and seriously, inevitably there are complaints about it - inconveniences that you put up with first, but at some point you realize that it is easier to fix it once than to suffer all the time.  Good is the tool that allows you to "finish" yourself. <br><br>  Java is a good tool, so one such inconvenience and how we corrected it will be discussed. <br><a name="habracut"></a><br><h2>  So inconvenience </h2><br>  There is no syntax in Java to refer to the bean property.  It is easier to explain with an example.  Suppose there is an <code>Account</code> that has a <code>customer</code> property of type <code>Customer</code> , which, in turn, has a <code>name</code> property.  In other words: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Customer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCustomer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Customer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre><br>  And there is a <code>TableBuilder</code> that can create labels on the interface to display the list of bins, you just need to tell it which properties (possibly nested) we want to display, and it will already do all the routine work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How to say that we want to show the <code>name customer</code> 'and <code>Account</code> ' eh?  Usually use string literals: <br><br><pre> <code class="java hljs">TableBuilder&lt;Account&gt; tableBuilder = TableBuilder.of(Account.class); ... tableBuilder.addColumn(<span class="hljs-string"><span class="hljs-string">"customer.name"</span></span>);</code> </pre><br>  The disadvantage of this method is that the compiler does not know that it is not just a string, and cannot verify its correctness, which means that all typos will turn into errors only during execution.  For the same reason, the development environment will not be able to tell us what properties <code>Customer</code> .  And even if we check and debug everything, the first refactoring will destroy our efforts. <br><br>  There is one more less obvious inconvenience: the typing <code>addColumn(String)</code> does not tell us that this method expects not just any string, but a chain of properties.  I want the compiler to check everything, the environment prompts, but the refactoring does not break.  This is not so much, considering that all the necessary information for this is already there. <br><br><h2>  Towards a solution </h2><br>  It would seem that the task is unsolvable: in Java, there is really no syntactic construct to refer to a class member without reference to it.  However, this does not prevent mock frameworks from gracefully and strictly expressing ‚Äúwhen the method will be called ...‚Äù, as, for example, Mockito can: <br><br><pre> <code class="java hljs">Account account = mock(Account.class); when(account.getCustomer()).thenReturn(...);</code> </pre><br>  The <code>mock()</code> method creates and returns a proxy that looks like an <code>Account</code> , but behaves quite differently: it stores the information about the called method in a ThreadLocal variable, which it then extracts, and uses <code>when()</code> .  You can use the same trick to solve our problem: <br><br><pre> <code class="java hljs">Account account = root(Account.class); tableBuilder.addColumn( $( account.gertCustomer().getName() ) );</code> </pre><br>  <code>root()</code> returns a proxy that stores the called methods into a ThreadLocal variable and returns the next proxy, allowing you to write call chains that turn into a property chain. <br><br>  <code>$()</code> does not return a string, but an object of type <code>BeanPath</code> , which represents a chain of properties in an object-oriented form.  You can navigate through the individual elements of this chain (for each element, the name and type is saved) or convert to a string already familiar to us: <br><br><pre> <code class="java hljs">$( account.gertCustomer().getName() ).toDotDelimitedString() =&gt; <span class="hljs-string"><span class="hljs-string">"customer.name"</span></span></code> </pre> <br>  <code>$()</code> , in addition to its main function, captures the type of chain (the last property in the chain), which means it allows you to add another drop of typing in the <code>TableBuilder</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">ColumnBuilder&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addColumn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BeanPath&lt;T&gt; path)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre> <br>  Here we wrote such a small framework in CUSTIS, we use it ourselves, and now we‚Äôve <a href="https://github.com/CUSTIS-public/beanpath">posted it on GitHub</a> . <br><br><h2>  Usage Aspects </h2><br>  Implementation through dynamic proxying imposes the following restrictions.  First, the ‚Äúroot‚Äù and non-closing properties in a chain cannot be final-classes (including <code>enum</code> , string, <code>jlInteger</code> , etc.).  The framework cannot proxy them and returns <code>null</code> : <br><br><pre> <code class="java hljs">$( account.getCustomer().getName().length() ) <span class="hljs-comment"><span class="hljs-comment">// =&gt; NPX!</span></span></code> </pre><br>  Nevertheless, a property of any type can close a chain: both a final-class and a primitive (which is meaningless and impossible in the middle of the chain). <br><br>  Secondly, getters should be visible for the framework, that is, should not be <code>private</code> or <code>package-local</code> .  But the default constructor and the public constructor in general may not be - the proxy is instantiated bypassing the constructor.  Since it cannot be done legally, the <code>sun.misc.Unsafe.allocateObject()</code> proprietary for HotSpot JVM is used, which makes the framework non-portable to other JVMs.  ‚ÄúRuths‚Äù can and should be reused, they do not contain the state: <br><br><pre> <code class="java hljs">Account account = root(Account.class); tableBuilder.addColumn( $( account.getCustomer().getName() ) ); tableBuilder.addColumn( $( account.getNumber() ) ); tableBuilder.addColumn( $( account.getOpenDate() ) );</code> </pre><br>  The <code>root()</code> and <code>$()</code> methods can be aliased, since these are just static methods: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeanPathMagicAlias</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">BeanPath&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T callChain)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BeanPathMagic.$(callChain); } }</code> </pre><br>  You can use this to rename methods to suit your taste or to create a useful shortcut.  In particular, one such has already been declared in the <code>beanpath</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String $$(Object callChain) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $(callChain).toDotDelimitedString(); }</code> </pre><br>  It is useful to use the beanpath in code that expects string literals.  An instance of a <code>BeanPath</code> can <code>BeanPath</code> be designed manually ‚Äî its behavior is completely determined by the state that is set during construction.  So: <br><br><pre> <code class="java hljs">BeanPath&lt;String&gt; bp1 = $( account.getCustomer().getName()); BeanPath&lt;String&gt; bp2 = BeanPath.root(Account.class) .append(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>, Customer.class) .append(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, String.class); bp1.equals(bp2) <span class="hljs-comment"><span class="hljs-comment">// =&gt; true</span></span></code> </pre><br>  This can be useful to circumvent the limitations mentioned above (if there is a final class in the chain or no public getters).  In this case, the correctness of the chain remains on the developer‚Äôs conscience. <br><br><h2>  Future plans </h2><br>  The beanpath is currently available only in source code.  Therefore, first of all I want to establish its full-fledged assembly and deploy in Maven Central.  Then replace the use of <code>sun.misc.Unsafe</code> with Objnesis to make the beanpath portable.  Well, quite for the future - to approach the solution of the problem from the other side: use static code generation √† la JPA static metamodel. <br>  This option has a number of advantages: <br><br><ol><li>  Zero overhead in runtime. </li><li>  The ability to capture the typing "root" of the chain. </li><li>  In the generated classes API, you can filter out extra methods (which are not related to properties). </li></ol><br>  PS Similar functionality is in <a href="http://www.querydsl.com/static/querydsl/3.6.0/reference/html/ch02s08.html">Querydsl</a> , and it is implemented in the same way, but it is strongly tied to the Querydsl infrastructure. </div><p>Source: <a href="https://habr.com/ru/post/243803/">https://habr.com/ru/post/243803/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243787/index.html">Room weather station with a network interface on the Tibbo Project System</a></li>
<li><a href="../243791/index.html">How rooms in Socket.io work</a></li>
<li><a href="../243797/index.html">Google plans in Asia</a></li>
<li><a href="../243799/index.html">Espruino Pico: a miniature developer board with javascript helps you quickly get started in the electronics world</a></li>
<li><a href="../243801/index.html">FLProg.ru - the face of the FLProg program on the Internet</a></li>
<li><a href="../243805/index.html">Mobile only: English from LinguaLeo for gadget</a></li>
<li><a href="../243809/index.html">We make automated calls for notifications or polls.</a></li>
<li><a href="../243811/index.html">Preparatory work to help you conquer Kickstar [a few forgotten common truths]</a></li>
<li><a href="../243813/index.html">Interactive voice editing of text with the help of new speech technologies from Yandex</a></li>
<li><a href="../243815/index.html">Expressive JavaScript: Document Object Model (Document Object Model)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>