<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization through VKontakte, Mail.ru and others for the most beginners - 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last part, we looked at authorization through VKontakte, today we‚Äôll stop at mail.ru and use avatars from both social networks. 
 To begin with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization through VKontakte, Mail.ru and others for the most beginners - 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/webdev_for_dummies/126717/">last part,</a> we looked at authorization through VKontakte, today we‚Äôll stop at mail.ru and use avatars from both social networks. <br>  To begin with, as always, we need to <a href="http://api.mail.ru/sites/my/add/">register</a> our application in the social network (in Mile, there is a clear separation between applications and websites, but I‚Äôm out of habit to say ‚Äúapplication‚Äù).  By the way, during the registration process you will see from three to five js errors, someday mail.ru will fix them.  After registration, you have access to the application ID, private key (nothing private, used for js-api calls, visible to everyone) and secret key (used for server-server interaction, do not tell anyone and do not forget in the comments). <a name="habracut"></a><br>  On the application settings page, we see another interesting parameter ‚ÄúAddress of the page receiver.html‚Äù.  If it does not aim to find out what it is for, then the only thing that we learn from the reference: <br><blockquote>  For site API to work correctly, you need to place the receiver.html file on your domain. <br></blockquote><br>  If you do not plan to use the JS API, then you do not need this file.  We will place a button on the authorization / registration page.  The PR department of Mile strictly forbids changing anything in the logo, so we use it in the strict form it is provided to us. <br><img src="http://p2p.ktv-sk.com/images/mail-connect.png"><br>  The link on the picture will be either this: <br><blockquote><code><a href="http"></a> <font color="black">connect.mail.ru/oauth/authorize?client_id=APP_ID&amp;response_type=token&amp;redirect_uri=_REDIRECT_URI&amp;host=http://HOST.com</font> <br></code> </blockquote><br>  where you need to specify your application number, your domain in the host parameter and the URI for redirection in the redirect_uri parameter. <br>  The second option is to make an intermediate page using the JS API, below the native example of Mail with one-space killing indents. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;script type= <font color="#A31515">"text/javascript"</font> src= <font color="#A31515">"http://cdn.connect.mail.ru/js/loader.js"</font> &gt;&lt;/script&gt; <br> &lt;script type= <font color="#A31515">"text/javascript"</font> &gt; <br> <br> mailru.loader.require( <font color="#A31515">'api'</font> , <font color="#0000ff">function</font> () { <br> mailru.connect.init( <font color="#A31515">'_APP_ID_'</font> , <font color="#A31515">'__PRIVATE_KEY__'</font> ); <br> mailru.events.listen(mailru.connect.events.login, <font color="#0000ff">function</font> (session){ <br> window.location.reload(); <br> }); <br> mailru.events.listen(mailru.connect.events.logout, <font color="#0000ff">function</font> (){ <br> window.location.reload(); <br> }); <br> mailru.connect.getLoginStatus( <font color="#0000ff">function</font> (result) { <br> <font color="#0000ff">if</font> (result.is_app_user != 1) { <br> mailru.connect.initButton(); <br> } <font color="#0000ff">else</font> { <br> mailru.common.users.getInfo( <font color="#0000ff">function</font> (result){console.log(result[0].uid)}); <br> location.href= <font color="#A31515">'/mail.login.php'</font> ; <br> } <br> }); <br> }); <br> <br> &lt;/script&gt; <br> &lt;a <font color="#0000ff">class</font> = <font color="#A31515">"mrc__connectButton"</font> &gt;@mail.ru&lt;/a&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Why might need the second option?  As life has shown, if a user clicks on a link from the first option and goes to a page with a username and password (if he is not authorized in Mile at the moment), then at least in the https address line, and the mail.ru domain, but panic and think that they are trying to steal his login and password.  It is not clear why, but if you show these fields in a pop-up window (apparently more familiar and more commonly used), then there are fewer panicked users. <br>  So, regardless of which option we have chosen, in any case, as a result, the user will be transferred to the page mail.login.php or another one you specified.  In case of successful authorization of the user on the mail.ru side on your domain, he creates a cookie called mrc, which can be parsed as follows: <br> <code>parse_str(urldecode($_COOKIE['mrc']),$array);</code> <br>  And here it turns out not very pleasant moments: for the signature / verification of the signature, the API uses the md5 comparison (a list of all request parameters sorted alphabetically without the &amp; signs) and the sig parameter from the mail.ru cookie.  Therefore, we need two small functions offered to us by the Mile team: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">function</font> sign_client_server(array $request_params, $uid, $private_key) { <br> ksort($request_params); <br> $ <font color="#0000ff">params</font> = <font color="#A31515">''</font> ; <br> <font color="#0000ff">foreach</font> ($request_params <font color="#0000ff">as</font> $key =&gt; $value) { <br> $ <font color="#0000ff">params</font> .= <font color="#A31515">"$key=$value"</font> ; <br> } <br> <font color="#0000ff">return</font> md5($uid . $ <font color="#0000ff">params</font> . $private_key); <br> } <br> <br> <font color="#0000ff">function</font> sign_server_server(array $request_params, $secret_key) { <br> ksort($request_params); <br> $ <font color="#0000ff">params</font> = <font color="#A31515">''</font> ; <br> <font color="#0000ff">foreach</font> ($request_params <font color="#0000ff">as</font> $key =&gt; $value) { <br> <font color="#0000ff">if</font> ($key!= <font color="#A31515">'sig'</font> ) { <br> $ <font color="#0000ff">params</font> .= <font color="#A31515">"$key=$value"</font> ; <br> } <br> } <br> <font color="#0000ff">return</font> md5($ <font color="#0000ff">params</font> . $secret_key); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  I have slightly corrected the sign_server_server function by adding a check that the key of the array element is not equal to 'sig'.  This is done in order to avoid deleting an element from an array or copying an array to another for verification before each check. <br>  To begin with, let's check whether the answer came from the social network (in the $ array array we have information from a mailrush cookie): <br><blockquote> <code><font color="black"><font color="#0000ff">if</font> (sign_server_server($array,$secretkey)==$array[ <font color="#A31515">'sig'</font> ]) {</font> <br></code> </blockquote><br>  What is surprising if we used the ‚Äúnative‚Äù function to verify the signature without removing the sig element from the array, the comparison would return false.  Since the initial information from Mile is rather scarce (only identifiers and the expiration of the user's session on Mile, which we don‚Äôt actually need), we need to get the name, surname <s>and credit</s> card <s>number</s> using the users.getInfo method.  This is done like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//  </font> <br> $ <font color="#0000ff">params</font> = array( <br> <font color="#A31515">"method"</font> =&gt; <font color="#A31515">"users.getInfo"</font> , <br> <font color="#A31515">"app_id"</font> =&gt; <font color="#A31515">"640345"</font> , <br> <font color="#A31515">"session_key"</font> =&gt;$array[ <font color="#A31515">'session_key'</font> ], <br> <font color="#A31515">"uids"</font> =&gt;$array[ <font color="#A31515">'vid'</font> ], <br> <font color="#A31515">"secure"</font> =&gt; <font color="#A31515">"1"</font> <br> ); <br> <br> $url = <font color="#A31515">"http://www.appsmail.ru/platform/api?"</font> .http_build_query($ <font color="#0000ff">params</font> ). <font color="#A31515">"&amp;sig="</font> .sign_server_server($ <font color="#0000ff">params</font> ,$secretkey); <br> $response = json_decode(file_get_contents($url));</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  There is no need to reinvent the bicycle in order to form a request, there is a built-in function http_build_query.  $ response returns us an array of user objects (in our case there is 1 element in the array), from which we get the first name, last name, nickname, identifier and avatar.  We do this before querying the database, because in any case, we will need this data (we will update the first name, last name and avatar). <br>  After we received the data from the social network, it's time to work on our side.  Taking criticism and a little abstracting from the type of database used: <br><blockquote> <code><font color="black">$stmt = $dbh-&gt;prepare( <font color="#A31515">"SELECT id FROM tracker_users WHERE username = :username"</font> ); <br> $stmt-&gt;bindParam( <font color="#A31515">":username"</font> , <font color="#A31515">"mm-{$array['</font> vid <font color="#A31515">']}"</font> , PDO::PARAM_STR, 23); <br> $stmt-&gt;execute();</font> <br></code> </blockquote><br>  For users from the social network MoiMir, I decided to select logins like ‚Äúmm-20 numbers‚Äù.  Yes, it is precisely the 20-digit number as an idish, for parking, do not make the conversion to a normal integer.  After that, if the user is already in our database, we simply update his data, create our cookies for him and transfer to the main page, if not, then we will create an entry in the table and perform actions from the previous item. <br><blockquote> <code><font color="black"><font color="#0000ff">if</font> ($stmt -&gt;fetchColumn() &gt; 0) { <br> <font color="#008000">//  </font> <br> } <font color="#0000ff">else</font> { <br> <font color="#008000">//  </font> <br> }</font> <br></code> </blockquote><br>  No one has any interest in the full presentation of all requests and trifles, as it turned out from the previous article, so we‚Äôll stop at the next stage of integration - avatars from social networks.  A small picture (ideally for display near comments) is in $ response [0] -&gt; pic_small, and the VKontakte avatar from the previous article can be obtained from the GET parameters $ _GET ['photo_rec'].  It should be noted that Mailovsky avatars have a size of 45 by 45, while from VKontakte it is 50 by 50. I am glad that both options are square and can be reduced to the same size.  If you want to bring to 50 to 50, then from the mail it is better to take the increased avatar 90 by 90. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/126872/">https://habr.com/ru/post/126872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126860/index.html">Distance Education at LSE</a></li>
<li><a href="../126862/index.html">HP TouchPad Became Bestseller on Amazon</a></li>
<li><a href="../126863/index.html">Sizing with vw and vh units</a></li>
<li><a href="../126865/index.html">Version 1.5.3 released</a></li>
<li><a href="../126869/index.html">Kosh on the complex plane</a></li>
<li><a href="../126874/index.html">Windows Phone SDK 7.1 Release Candidate and Marketplace opening for Mango applications</a></li>
<li><a href="../126875/index.html">Open source or love story</a></li>
<li><a href="../126877/index.html">Content editable in HTML5</a></li>
<li><a href="../126879/index.html">Mobile payment terminal from PrivatBank</a></li>
<li><a href="../126881/index.html">Wireless network on Dingoo A320</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>