<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring MongoDB ShardedCluster with X.509 Authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! Recently, life has thrown the author into an exciting job of deploying a MongoDB cluster with setting up replication and sharding, as...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring MongoDB ShardedCluster with X.509 Authentication</h1><div class="post__text post__text-html js-mediator-article">  Good day to all!  Recently, life has thrown the author into an exciting job of deploying a MongoDB cluster with setting up replication and sharding, as well as authentication using x.509 certificates.  In this article, I first of all would like to state my thoughts and share the gained experience.  Since some things were not trivial and could not be done the first time, I think my step-by-step instructions can be useful for covering the issue for those who are just familiar with sharding data and working with MongoDB as a whole. <br>  Also, I will be very happy to see recommendations on adding / changing the cluster configuration and just questions or criticism on the article itself or on the substance of the issue. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  The project within which the cluster was implemented is a service for collecting statistics on client devices and aggregated presentation on the site or via the Rest-API.  The project has been stable for a long time under low load and as a result, the MongoDB server installed as is out of the box (without sharding and data replication) coped well with its goal, and good sleep provided daily backups of the krone base.  Thunder struck as usual at one point after the arrival of several large customers with a large number of devices, data and requests.  The result was unacceptably long execution of queries to the grown database, and the culmination was the disruption of the server when we almost lost data. <br><br>  Thus, overnight, there was a need to perform work on improving fault tolerance, data integrity, performance with the possibility of future scaling.  It was decided to use the existing potential of MongoDB to eliminate the problems that have arisen, namely, to organize a shardirovany cluster with replication and migrate available data to it. <br><br><h3>  Some theory </h3><br>  For a start, let's take a quick look at ShardedCluster MongoDB and its main components.  <b>Sharding</b> as such is a method of <b>horizontal scaling of</b> computing systems that store and provide access to data.  Unlike <b>vertical scaling</b> , when system performance can be increased by improving the performance of an individual server, for example, by switching to a more powerful CPU, adding the amount of available RAM or disk space, sharding works by distributing the data set and the load among several servers and adding new servers as needed (this is our case). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The advantage of such scaling is its almost infinite potential for expansion while the vertically scalable system is deliberately limited, for example, by the available hardware of the hosting provider. <br><br>  What is expected to get from switching to a shard MongoDB cluster?  First of all, it is necessary to obtain load distribution of read / write operations between cluster shards, and secondly, to achieve high fault tolerance (constant data availability) and data integrity due to redundant copying (replication). <br><br>  In the case of MongoDB, sharding of data takes place at the collection level, which means that we can explicitly specify the data of which collection needs to be distributed among the existing cluster shards.  It also means that the entire collection of documents from the charding collection will be divided into equal parts by size - chunks, which later will be almost equally divided between the cluster charades by the monga balancer. <br><br>  Sharding for all databases and collections is disabled by default, and we cannot shard cluster system databases, such as <b>admin</b> and <b>config</b> .  When we try to do this, we will get an unambiguous refusal from Mongi: <br><br><pre><code class="javascript hljs">mongos&gt; sh.enableSharding(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>) { <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"errmsg"</span></span> : <span class="hljs-string"><span class="hljs-string">"can't shard admin database"</span></span> }</code> </pre> <br>  A shardirovanny MongoDB cluster imposes three mandatory conditions on us: actually, there are <b>shards</b> in it, all communication between the cluster and its clients should be carried out exclusively via <b>mongos</b> routers and a cluster <b>server</b> must be present (based on the additional mongod instance, or as recommended on the basis of the Replica Set). <br><br>  The mongodb official documentation says <i>‚ÄúIn production, all shards should be replica sets.‚Äù</i> .  Being a replica ( <a href="https://docs.mongodb.com/manual/replication/">Replica Set</a> ) each shard at the expense of multiple copying of data increases its fault tolerance (in terms of data availability on any instance of the replica) well, of course, ensures their best preservation. <br><br>  Replica <b>(Replica Set)</b> is the union of several running mongod instances that store copies of the same data set.  In the case of a shard replica, this will be a set of chunks given to this shard by the balancer of the monga. <br><br>  One of the copies of the replica is assigned to the main one ( <a href="https://docs.mongodb.com/manual/core/replica-set-primary/">PRIMARY</a> ) and accepts all data write operations (supporting and reading at the same time), the other mongods in this case are announced by <b><a href="https://docs.mongodb.com/manual/core/replica-set-secondary/">SECONDARY</a></b> and update their copy of the data set in asynchronous communication with PRIMARY.  They are also available for reading data.  As soon as PRIMARY becomes inaccessible for some reason, ceasing to interact with the other participants of the replica, a <a href="https://docs.mongodb.com/manual/core/replica-set-elections/">vote</a> on the role of the new PRIMARY is announced among all the available participants of the replica.  In fact, besides PRIMARY and SECONDARY in the Replica Set there may be a third kind of participant - this is the arbiter ( <a href="https://docs.mongodb.com/manual/core/replica-set-arbiter/">ARBITER</a> ). <br><br>  The arbitrator in the replica does not play the role of copying the data set; instead, it accomplishes the important task of voting and is designed to shield the remark from the dead-end outcome of voting.  Imagine a situation where there is an even number of participants in a cue and they vote for two candidates with the same total number of votes, and so endlessly ... Adding an arbitrator to this ‚Äúeven‚Äù comment of an arbitrator, he will decide the outcome of the vote by giving his vote to one or another candidate position ‚ÄùPRIMARY, without requiring resources to service another copy of the data set. <br><br>  I note that Replica Set is the union of mongod instances, that is, nothing prevents you from collecting a replica on a single server, specifying folders on different physical media as data repositories, and achieving some data security, but still ideal. This is the organization of the replica with the launch of mongod on different servers.  In general, in this respect, the MongoDB system is very flexible, and allows us to assemble the configuration we need based on our needs and capabilities, without setting any hard limits.  Replica Set as such, outside the context of Sharded Cluster, is one of the typical MongoDB server organization schemes, which gives a high degree of fault tolerance and data protection.  In this case, each member of the replica stores a complete copy of the entire database dataset, and not its part defined by the shard chunk set. <br><br><h3>  Infrastructure </h3><br>  The following cluster configuration is built on three virtual containers (VBO) OpenVZ.  Each of the virtualok is located on a separate dedicated server. <br><br>  Two virtual machines (hereinafter <b>server1.cluster.com</b> and <b>server2.cluster.com</b> ) have more resources - they will be responsible for replication, sharding and providing data to customers.  The third machine ( <b>server3.cluster.com</b> ) has a weaker configuration ‚Äî its purpose is to ensure the operation of the mongod arbiters. <br><br>  In the constructed cluster, we now have three charades.  In our scheme, we withstood the recommendation of building shards based on a replica of sets, but with some assumption.  Each shard replica of our cluster has its own PRIMARY, SECONDARY and ARBITER, running on three different servers.  There is also a config server built also using data replication. <br><br>  However, we have only three servers, one of which does not perform the functions of data replication (only in the case of a config replica) and therefore all three shards are actually located on two servers. <br><br>  On the diagrams from the Mongi documentation, the Mongos are depicted on the application servers.  I decided to break this rule and place the Mongos (we will have two) on the data servers: server1.cluster.com and server2.cluster.com, getting rid of the additional mongodb configuration on the application server and due to certain restrictions associated with the application servers.  Application servers have the ability to connect to any of the two Mongos, so in case of problems with one of them, they will reconnect to the other after a short timeout.  Application servers, in turn, sit at the DNS ohm on which Round Robin is configured.  It alternately issues one of two addresses, providing a primitive balancing of connections (client requests).  There are plans to replace it with some ‚Äúsmart‚Äù DNS (maybe someone will tell a good solution in the comments, I will be grateful!) For issuing the necessary server by geolocation of the client. <br><br>  For clarity, I present the general scheme of the formed cluster with the names of the servers and the applications running on them.  Colons indicate the designated application ports. <br><br><img src="https://habrastorage.org/files/c94/de1/0a8/c94de10a8d01443ebd3a972ea2647444.png"><br><br><h3>  Primary setup </h3><br>  Go to server1.cluster.com and install the latest version of the MongoDB Community Edition package from the official repository.  At the time of cluster assembly, it is version 3.2.8.  In my case, the Debian 8 operating system is installed on all the cluster machines, you can find detailed installation instructions for your OS in the official <a href="https://docs.mongodb.com/manual/administration/install-on-linux/">documentation</a> . <br>  We import the public key into the system, update the package lists and install the mongodb server with a set of utilities: <br><br><pre> <code class="bash hljs">server1.cluster.com:~<span class="hljs-comment"><span class="hljs-comment"># apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv EA312927 server1.cluster.com:~# echo "deb http://repo.mongodb.org/apt/debian wheezy/mongodb-org/3.2 main" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.2.list server1.cluster.com:~# apt-get update server1.cluster.com:~# apt-get install -y mongodb-org</span></span></code> </pre> <br>  Done!  As a result of the actions performed, we get a server on our MongoDB server that is already up and running.  For now, turn off mongod service (we‚Äôll return to it): <br><br><pre> <code class="bash hljs">server1.cluster.com:~<span class="hljs-comment"><span class="hljs-comment"># service mongod stop</span></span></code> </pre> <br>  Next, create a directory in which we will store all the data of our cluster, I have it located along the path ‚Äú/ root / mongodb‚Äù.  Inside we form the following directory structure: <br><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ cfg ‚îú‚îÄ‚îÄ data ‚îÇ ‚îú‚îÄ‚îÄ config ‚îÇ ‚îú‚îÄ‚îÄ rs0 ‚îÇ ‚îú‚îÄ‚îÄ rs1 ‚îÇ ‚îî‚îÄ‚îÄ rs2 ‚îú‚îÄ‚îÄ keys ‚îî‚îÄ‚îÄ logs</code> </pre> <br>  In the data subdirectory, we will store our replica data directly (including the config replica).  In cfg, we will create configuration files to launch the necessary mongo {d / s} instances.  In keys, we will copy the keys and certificates for x.509 authentication of cluster members.  The purpose of the logs folder, I think everyone understands. <br><br>  Similarly, the procedure with installation and directories must be repeated on the remaining two servers. <br><br>  Before proceeding with setting up and linking the components of our cluster, make sure that everything works as we need.  Run the mongod instance on port 27000, specifying the directory for the data in ‚Äú/ root / mongodb / data / rs0‚Äù: <br><br><pre> <code class="bash hljs">mongod --port 27000 --dbpath /root/mongodb/data/rs0</code> </pre> <br>  On the same server, open another terminal and connect to the running Mongo: <br><br><pre> <code class="bash hljs">mongo --port 27000</code> </pre> <br>  If everything went well, we will get into the shell mongodb and can execute a couple of commands.  By default, Monga will switch us to the test database, we can verify this by entering the command: <br><br><pre> <code class="javascript hljs">&gt; db.getName() test</code> </pre> <br>  Delete the database we don't need with the command: <br><br><pre> <code class="javascript hljs">&gt; db.dropDatabase() { <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  And we initialize a new database with which we will experiment by switching to it: <br><br><pre> <code class="javascript hljs">&gt; use analytics switched to db analytics</code> </pre> <br>  Now try to enter the data.  In order not to be unfounded, I propose to consider all further operations in the article using the example of a system for collecting certain statistics, where data from remote devices periodically come in and processed on the application servers and then stored in the database <br><br>  Add a couple of devices: <br><br><pre> <code class="javascript hljs">&gt; db.sensors.insert({<span class="hljs-string"><span class="hljs-string">'s'</span></span>:<span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'n'</span></span>: <span class="hljs-string"><span class="hljs-string">'Sensor1001'</span></span>, <span class="hljs-string"><span class="hljs-string">'o'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>: <span class="hljs-string"><span class="hljs-string">'192.168.88.20'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>: ISODate(<span class="hljs-string"><span class="hljs-string">'2016-07-20T20:34:16.001Z'</span></span>), <span class="hljs-string"><span class="hljs-string">'e'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}) WriteResult({ <span class="hljs-string"><span class="hljs-string">"nInserted"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }) &gt; db.sensors.insert({<span class="hljs-string"><span class="hljs-string">'s'</span></span>:<span class="hljs-number"><span class="hljs-number">1002</span></span>, <span class="hljs-string"><span class="hljs-string">'n'</span></span>: <span class="hljs-string"><span class="hljs-string">'Sensor1002'</span></span>, <span class="hljs-string"><span class="hljs-string">'o'</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>: <span class="hljs-string"><span class="hljs-string">'192.168.88.30'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>: ISODate(<span class="hljs-string"><span class="hljs-string">'2016-07-19T13:40:22.483Z'</span></span>), <span class="hljs-string"><span class="hljs-string">'e'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}) WriteResult({ <span class="hljs-string"><span class="hljs-string">"nInserted"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> })</code> </pre> <br>  Here, <br>  <b>s</b> is the sequence number of the sensor; <br>  <b>n</b> is its lower case identifier; <br>  <b>o</b> - current status (online / offline); <br>  <b>ip</b> - ip address of the sensor; <br>  <b>a</b> is the last activity time; <br>  <b>e</b> - sign of an error; <br><br>  And now several records of statistical data of the form: <br><br><pre> <code class="javascript hljs">&gt; db.statistics.insert({<span class="hljs-string"><span class="hljs-string">'s'</span></span>:<span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'ts'</span></span>: ISODate(<span class="hljs-string"><span class="hljs-string">'2016-08-04T20:34:16.001Z'</span></span>), <span class="hljs-string"><span class="hljs-string">'param1'</span></span>: <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-string"><span class="hljs-string">'param2'</span></span>: <span class="hljs-number"><span class="hljs-number">23.45</span></span>, <span class="hljs-string"><span class="hljs-string">'param3'</span></span>: ‚ÄúOK‚Äù, <span class="hljs-string"><span class="hljs-string">'param4'</span></span>: True, <span class="hljs-string"><span class="hljs-string">'param5'</span></span>: <span class="hljs-string"><span class="hljs-string">'-1000'</span></span>, <span class="hljs-string"><span class="hljs-string">'param6'</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>]) WriteResult({ <span class="hljs-string"><span class="hljs-string">"nInserted"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> })</code> </pre> <br>  <b>s</b> - sensor number; <br>  <b><b>ts</b> - TimeStamp;</b> <b><br></b>  <b>param1..param6</b> - some statistics. <br><br>  Clients of the statistical analytics service often perform aggregated queries in order to obtain some representative data on statistics collected from their devices.  Almost all requests involved ‚Äúthe ordinal number of the sensor‚Äù (field s).  Sorts and grouping are often applied to it, so for optimization (and also for sharding) we add an index to the statistics collection: <br><br><pre> <code class="javascript hljs">mongos&gt; db.statistics.ensureIndex({<span class="hljs-string"><span class="hljs-string">"s"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br>  The choice and creation of the necessary indices is a topic for a separate discussion, but for the time being I will limit myself to this. <br><br><h3>  Authentication using x.509 certificates </h3><br>  To understand the task, let's go ahead and present mongod instances running on different servers that need to be combined into a replica, connect mongos to them and provide the ability for clients to safely connect to the formed cluster.  Of course, the participants in the data exchange must be authenticated during the connection (to be trusted), and it is desirable that the data channel is also protected.  In this case, MongoDB has support for TSL / SSL, as well as several authentication mechanisms.  One of the options for establishing a trust relationship between the participants of data exchange in a cluster is the use of keys and certificates.  Regarding the choice of the mechanism that uses this option in the Mongi documentation, there is a recommendation: <br><br>  <i>‚ÄúKeyfiles are recommended for testing or development environments.</i>  <i>For production environments we recommend using <a href="https://docs.mongodb.com/manual/core/security-x.509/">x.509 certificates</a> . ‚Äù</i> <br><br>  X.509 is an ITU-T standard for public key infrastructure and privilege management.  This standard defines the format and how public keys are distributed using signed digital certificates.  The certificate associates the public key with a certain subject - the certificate user.  The reliability of this connection is achieved through a digital signature that is performed by a trusted certificate authority. <br><br>  (In addition to x.509 in MongoDB, there are also highly reliable Enterprise-level methods - this is <a href="https://docs.mongodb.com/manual/core/authentication-mechanisms-enterprise/">Kerberos Authentication</a> and <a href="https://docs.mongodb.com/manual/core/authentication-mechanisms-enterprise/">LDAP Proxy Authority Authentication</a> ), but this is not our case, and it will be considered how to configure x.509 authentication. <br><br>  The authentication mechanism using x.509 certificates requires a secure TSL / SSL connection to the cluster, which is enabled by the corresponding mongod launch argument <b>--sslMode</b> , or by the <b>net.ssl.mode</b> parameter in the configuration file.  Authentication of the client connecting to the server in this case comes down to authenticating the certificate, and not the login and password. <br><br>  In the context of this mechanism, the generated certificates will be divided into two types: <b>certificates of cluster members</b> ‚Äî tied to a specific server, intended for internal authentication of mongod instances on different machines, and <b>client certificates</b> ‚Äî tied to a separate user, intended to authenticate external cluster clients. <br><br>  To fulfill the conditions of x.509 we need a single key - the so-called ‚Äú <b>Certificate Authority</b> ‚Äù <b>Certificate Authority (CA)</b> .  On its basis, both client and cluster member certificates will be issued, so first of all we will create a secret key for our CA.  It will be correct to perform all the following actions and store the secret keys on a separate machine, but in this article I will perform all the actions on the first server (server1.cluster.com): <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl genrsa -out mongodb-private.key -aes256 Generating RSA private key, 2048 bit long modulus .....................+++ ........................................................+++ e is 65537 (0x10001) Enter pass phrase for mongodb-private.key: Verifying - Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br>  On the suggestion to enter a secret phrase, we enter and confirm some reliable combination, for example, <b>‚Äútemporis $ filia $ veritas‚Äù</b> (you will certainly have something of your own and more complicated).  The phrase must be remembered, we will need it to sign each new certificate. <br><br>  Next, we create a CA certificate (immediately after launching the command, we will be asked to enter a secret phrase from the key that we specified (in the ‚Äúkey‚Äù parameter): <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -x509 -new -extensions v3_ca -key mongodb-private.key -days 36500 -out mongodb-CA-cert.crt</span></span></code> </pre> <br>  Let me draw your attention to the <b>days</b> parameter - it is responsible for the duration of the certificate.  I‚Äôm not sure who will be involved in the project that I‚Äôm working on at the moment, so in order to eliminate unpleasant surprises, we give the certificate 36,500 days of life, which is 100 years old (very optimistic, isn't it?). <br>  After checking the phrase, we will be asked to enter information about the organization that owns the certificate.  Imagine that our large organization is called ‚ÄúSomeSysyems‚Äù and is located in the city of Moscow (the entered information follows after the colon): <br><br><pre> <code class="bash hljs">Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: Statistics Common Name (eg server FQDN or YOUR name) []: CaServer Email Address []: info@SomeSystems.com</code> </pre> <br>  Fine!  CA is ready and we can use it to sign client certificates and certificates of cluster members.  I will add that the validity of the entered data does not affect the functionality of the CA certificate itself, however, the signed certificates will now depend on the entered values, which will be discussed later. <br><br>  The procedure for creating certificates for cluster members (certificates for external clients will be discussed separately) is as follows: <br><br><ol><li>  We generate a private key (* .key - file) and a ‚Äúcertificate request‚Äù (csr file).  A CSR (Certificate Signing Request) is a text file that contains, in coded form, information about the organization that issued the certificate and the public key. <br><br></li><li>  Using the private key and public certificate of our Certification Authority, we sign the certificate for the current server. <br><br></li><li>  From the new key and certificate of the cluster member we form a PEM file that we use to connect to the cluster. </li></ol><br>  We create a private key and certificate request for our first server (server1.cluster.com).  I will pay attention to an important detail, when filling in all the fields remain the same as for the root certificate, except for CN (Common Name).  It must be made unique for each certificate.  In our case, the full domain name - <b>FQDN (Fully Qualified Domain Name) of the</b> specific server will be specified as the value: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout server1.key -out server1.csr Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: Statistics Common Name (eg server FQDN or YOUR name) []: server1.cluster.com Email Address []: info@SomeSystems.com Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br>  I left the extra fields empty.  If you decide to specify an additional password (A challenge password [] :), then in the mongod configuration you will need to specify a password for this certificate for which the <b>net.ssl.PEMKeyPassword</b> and <b>net.ssl.clusterPassword</b> parameters <b>correspond</b> .  (Details on these parameters in the documentation <a href="https://docs.mongodb.com/manual/reference/configuration-options/">here</a> ). <br><br>  Next, we will sign the CSR file with our CA certificate and get a public certificate (* .crt file): <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in server1.csr -out server1.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=Statistics/CN=server1.cluster.com/emailAddress=info@SomeSystems.com Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br>  Now we need to make a PEM file: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat server1.key server1.crt &gt; server1.pem</span></span></code> </pre> <br>  We will use the PEM file directly when running mongod instances, and specify it in the configuration. <br>  Now you need to repeat the certificate creation procedure for the remaining servers.  For a complete understanding, I cite all the commands: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout server2.key -out server2.csr Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: Statistics Common Name (eg server FQDN or YOUR name) []: server2.cluster.com Email Address []: info@SomeSystems.com Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br>  (extra-fields were not filled) <br><br>  We sign the CSR file with our CA certificate to get the public certificate (* .crt file) of the second server: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in server2.csr -out server2.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=Statistics/CN=server2.cluster.com/emailAddress=info@SomeSystems.com Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br>  Now we need to make a PEM file: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat server2.key server2.crt &gt; server2.pem</span></span></code> </pre> <br>  And similarly for the third server certificate: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout server3.key -out server3.csr Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: Statistics Common Name (eg server FQDN or YOUR name) []: server3.cluster.com Email Address []: info@SomeSystems.com Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br>  (extra-fields were not filled) <br><br>  We sign the CSR file with our CA certificate to get the public certificate (* .crt file) of the third server: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in server3.csr -out server3.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=Statistics/CN=server3.cluster.com/emailAddress=info@SomeSystems.com Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br>  Create a PEM file: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat server3.key server3.crt &gt; server3.pem</span></span></code> </pre> <br>  I repeat that all the keys and certificates were created by me on the first server and then, if necessary, moved to the appropriate server.  Thus, each of the three servers should have a public CA certificate (mongodb-CA-cert.crt) and a PEM file of this server (server &lt;$ N&gt; .pem). <br><br><h3>  Mongod instance configuration </h3><br>  For correct start we need to transfer a number of parameters to mongod instances.  To do this, you can use the configuration file, or you can pass all the necessary values ‚Äã‚Äãas arguments to the terminal command.  Almost all configuration parameters are reflected in the corresponding command line arguments.   -     ,         ,     ,         ‚Äì  -: <br><br><pre> <code class="bash hljs">mongod --config &lt;path-to-config-file&gt;</code> </pre> <br> ,      mongod  - (rs0)   : <br><br><pre> <code class="hljs pgsql"># # /root/mongodb/cfg/mongod-rs0.conf # <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: replSetName: "rs0" #   net: port: <span class="hljs-number"><span class="hljs-number">27000</span></span> ssl: mode: requireSSL #    PEMKeyFile: /root/mongodb/keys/server1.pem clusterFile: /root/mongodb/keys/server1.pem CAFile: /root/mongodb/keys/mongodb-CA-cert.crt weakCertificateValidation: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #     allowInvalidCertificates: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #      <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: enabled #    clusterAuthMode: x509 #   - MONGODB-X509 <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath : /root/mongodb/data/rs0 #     systemLog: destination: file #      <span class="hljs-type"><span class="hljs-type">path</span></span>: /root/mongodb/logs/mongod-rs0.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> #   - logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #  -   </code> </pre> <br>      - (rs1),   ,  ,      : <br><br><pre> <code class="hljs pgsql"># # /root/mongodb/cfg/mongod-rs1.conf # <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: replSetName: "rs1" net: port: <span class="hljs-number"><span class="hljs-number">27001</span></span> ssl: mode: requireSSL PEMKeyFile: /root/mongodb/keys/server1.pem clusterFile: /root/mongodb/keys/server1.pem CAFile: /root/mongodb/keys/mongodb-CA-cert.crt weakCertificateValidation: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> allowInvalidCertificates: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: enabled clusterAuthMode: x509 <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath : /root/mongodb/data/rs1 systemLog: destination: file <span class="hljs-type"><span class="hljs-type">path</span></span>: /root/mongodb/logs/mongod-rs1.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br>       (rs2): <br><br><pre> <code class="hljs pgsql"># # /root/mongodb/cfg/mongod-rs2.conf # <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: replSetName: "rs2" net: port: <span class="hljs-number"><span class="hljs-number">27002</span></span> ssl: mode: requireSSL PEMKeyFile: /root/mongodb/keys/server1.pem clusterFile: /root/mongodb/keys/server1.pem CAFile: /root/mongodb/keys/mongodb-CA-cert.crt weakCertificateValidation: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> allowInvalidCertificates: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: enabled clusterAuthMode: x509 <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath : /root/mongodb/data/rs2 systemLog: destination: file <span class="hljs-type"><span class="hljs-type">path</span></span>: /root/mongodb/logs/mongod-rs2.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br>  ,   -         ,       (rscfg). <br><br>  ,   -     mongod (      ),         -    Replica Set. <br><br> -         ‚Äúsharding.clusterRole‚Äù    mongod   : <br><br><pre> <code class="hljs pgsql"># # /root/mongodb/cfg/mongod-rscfg.conf # sharding: clusterRole: configsvr #     -   <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: replSetName: "rscfg" #   net: port: <span class="hljs-number"><span class="hljs-number">27888</span></span> ssl: mode: requireSSL PEMKeyFile: /root/mongodb/keys/server1.pem clusterFile: /root/mongodb/keys/server1.pem CAFile: /root/mongodb/keys/mongodb-CA-cert.crt weakCertificateValidation: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> allowInvalidCertificates: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: enabled clusterAuthMode: x509 <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath : /root/mongodb/data/config systemLog: destination: file <span class="hljs-type"><span class="hljs-type">path</span></span>: /root/mongodb/logs/mongod-rscfg.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br>           .         <b>net.ssl.PEMKeyFile</b>  <b>net.ssl.clusterFile</b>         (server2.pem, server3.pem). <br><br><h3>  Replica Set </h3><br>     mongod   27000,   ‚Äú‚Äù   ‚Äì     .        mongod                 ,      : <br><br><pre> <code class="bash hljs">mongod --port 27000 --dbpath /root/mongodb/data/rs0</code> </pre> <br>            ,     ,   ,    -,       ,      .     x.509          (     ).          ,   x.509      ,     .    ,  ,    ,     .           . <br><br>                  ‚Äúx.509 ‚Äù.     ,        ( mongod  ),    .  ,    .       ( root)     (rs0).    MongoDB,    <a href="https://docs.mongodb.com/manual/core/security-built-in-roles/"></a>   . <br><br>      CA .          : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout rsroot.key -out rsroot.csr Generating a 2048 bit RSA private key ........................................................................+++ .........................+++ writing new private key to 'rsroot.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: StatisticsClient Common Name (eg server FQDN or YOUR name) []: rsroot Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br>   (     A ): <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in rsroot.csr -out rsroot.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=StatisticsClient/CN=rsroot Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br>  PEM-: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat rsroot.key rsroot.crt &gt; rsroot.pem</span></span></code> </pre> <br>      Organisation Unit Name (OU),    ,                   .        ,  subject ( )  OU  ,       ,      : <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"errmsg"</span></span> : <span class="hljs-string"><span class="hljs-string">"Cannot create an x.509 user with a subjectname that would be recognized as an internal cluster member."</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }</code> </pre> <br>      x.509    ,        ,   (subject)    .  subject   PEM-  : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -in rsroot.pem -inform PEM -subject -nameopt RFC2253 subject= CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU -----BEGIN CERTIFICATE-----</span></span></code> </pre> <br>         ‚Äúsubject=‚Äù (  ‚Äúsubject=‚Äù  ).      : <br><br><pre> <code class="bash hljs">mongo --port 27000</code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({<span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}] })</code> </pre> <br> <b>$external</b> ‚Äì         ,      MongoDB, ,     (     ). <br><br>        mongod,   c   .          .            (rs0). <br>          (rsroot)   ,      ‚Äî subject : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># mongo admin --ssl --sslCAFile /root/mongodb/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb/keys/rsroot.pem --host server1.cluster.com --port 27000</span></span></code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).auth({ <span class="hljs-attr"><span class="hljs-attr">mechanism</span></span>:<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span> })</code> </pre> <br>   : <br><br><pre> <code class="javascript hljs">rs.initiate( { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"rs0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">members</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server1.cluster.com:27000"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server2.cluster.com:27000"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server3.cluster.com:27000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">arbiterOnly</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, ] } )</code> </pre> <br>     <b>arbiterOnly</b>   ,        ‚Äú ‚Äù. <br><br>   ,   ‚Äúrs0‚Äù    ,      : <br> rs0:PRIMARY (       SECONDARY). <br><br>         . <br><br> <b>1.</b>        (    ): <br><br><pre> <code class="bash hljs">mongod --port 27001 --dbpath /root/mongodb/data/rs1</code> </pre> <br> <b>2.</b>         (rs1).           ,  subject       : <br><br><pre> <code class="bash hljs">mongo --port 27001</code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({<span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}] })</code> </pre> <br> <b>3.</b>  mongod   ,   .            : <br><br><pre> <code class="bash hljs">root@server1.cluster.com<span class="hljs-comment"><span class="hljs-comment"># mongod --config /root/mongodb/cfg/mongod-rs1.conf root@server2.cluster.com# mongod --config /root/mongodb/cfg/mongod-rs1.conf root@server3.cluster.com# mongod --config /root/mongodb/cfg/mongod-rs1.conf</span></span></code> </pre> <br> <b>4.</b>      ,      rs1: <br><br><pre> <code class="bash hljs">root@server1.cluster.com<span class="hljs-comment"><span class="hljs-comment"># mongo admin --ssl --sslCAFile /root/mongodb/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb/keys/rsroot.pem --host server1.cluster.com --port 27001</span></span></code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).auth({ <span class="hljs-attr"><span class="hljs-attr">mechanism</span></span>:<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span> }) &gt; rs.initiate( { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"rs1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">members</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server1.cluster.com:27001"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server2.cluster.com:27001"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server3.cluster.com:27001"</span></span>, <span class="hljs-attr"><span class="hljs-attr">arbiterOnly</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, ] } )</code> </pre> <br>      (rs2). <br><br> <b>1.</b>        (      ): <br><br><pre> <code class="bash hljs">mongod --port 27002 --dbpath /root/mongodb/data/rs2</code> </pre> <br> <b>2.</b>        (rs2): <br><br><pre> <code class="bash hljs">mongo --port 27002</code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({<span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}] })</code> </pre> <br> <b>3.</b>         .            : <br><br><pre> <code class="bash hljs">root@server1.cluster.com<span class="hljs-comment"><span class="hljs-comment"># mongod --config /root/mongodb/cfg/mongod-rs2.conf root@server2.cluster.com# mongod --config /root/mongodb/cfg/mongod-rs2.conf root@server3.cluster.com# mongod --config /root/mongodb/cfg/mongod-rs2.conf</span></span></code> </pre> <br> <b>4.</b>      ,      rs2: <br><br><pre> <code class="bash hljs">root@server1.cluster.com<span class="hljs-comment"><span class="hljs-comment"># mongo admin --ssl --sslCAFile /root/mongodb/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb/keys/rsroot.pem --host server1.cluster.com --port 27002</span></span></code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).auth({ <span class="hljs-attr"><span class="hljs-attr">mechanism</span></span>:<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=rsroot,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span> }) &gt; rs.initiate( { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"rs2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">members</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server1.cluster.com:27002"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server2.cluster.com:27002"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server3.cluster.com:27002"</span></span>, <span class="hljs-attr"><span class="hljs-attr">arbiterOnly</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, ] } )</code> </pre> <br><h3> - </h3><br>              ,     . -,               ,       ,    . -,       - .         : <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"errmsg"</span></span> : <span class="hljs-string"><span class="hljs-string">"Arbiters are not allowed in replica set configurations being used for config servers"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span> : <span class="hljs-number"><span class="hljs-number">93</span></span> }</code> </pre> <br>        SECONDARY-/  -.       rscfg,            . <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout rootuser.key -out rootuser.csr Generating a 2048 bit RSA private key ......................+++ .........................................+++ writing new private key to 'rootuser.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: StatisticsClient Common Name (eg server FQDN or YOUR name) []: root Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in rootuser.csr -out rootuser.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=StatisticsClient/CN=root Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat rootuser.key rootuser.crt &gt; rootuser.pem</span></span></code> </pre> <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -in rootuser.pem -inform PEM -subject -nameopt RFC2253 subject= CN=root,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU -----BEGIN CERTIFICATE-----</span></span></code> </pre> <br> <b>1.</b>       : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># mongod --port 27888 --dbpath /root/mongodb/data/config</span></span></code> </pre> <br> <b>2.</b>        (rscfg).: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># mongo --port 27888</span></span></code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({<span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=root,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}] })</code> </pre> <br> <b>3.</b>  mongod      -.             : <br><br><pre> <code class="bash hljs">root@server1.cluster.com<span class="hljs-comment"><span class="hljs-comment"># mongod --config /root/mongodb/cfg/mongod-rscfg.conf root@server2.cluster.com# mongod --config /root/mongodb/cfg/mongod-rscfg.conf root@server3.cluster.com# mongod --config /root/mongodb/cfg/mongod-rscfg.conf</span></span></code> </pre> <br> <b>4.</b>      ,     - (rscfg): <br><br><pre> <code class="bash hljs">root@server1.cluster.com<span class="hljs-comment"><span class="hljs-comment"># mongo admin --ssl --sslCAFile /root/mongodb/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb/keys/rootuser.pem --host server1.cluster.com --port 27888</span></span></code> </pre> <br><pre> <code class="javascript hljs">&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).auth({ <span class="hljs-attr"><span class="hljs-attr">mechanism</span></span>:<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=root,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span> }) &gt; rs.initiate( { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"rscfg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">members</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server1.cluster.com:27888"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server2.cluster.com:27888"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">"server3.cluster.com:27888"</span></span> } ] } )</code> </pre> <br>  -     .      mongos    . <br><br><h3>    mongos </h3><br>          (         mongos).     MongoDB      .         mongos,      server1.cluster.com  server2.cluster.com. <br><br>   ,    mongod,    ,       . <br><br>    mongos  mongod  ,      ,     ,    .             config -.       -     sharding.configDB.     -     ,        :   ,          .         ‚Äî 27017. <br><br><pre> <code class="hljs pgsql"># # /root/mongodb/cfg/mongos.conf # sharding: configDB: "rscfg/server1.cluster.com:27888,server2.cluster.com:27888,server3.cluster.com:27888" net: port: <span class="hljs-number"><span class="hljs-number">27017</span></span> ssl: mode: requireSSL PEMKeyFile: /root/mongodb/keys/server1.pem clusterFile: /root/mongodb/keys/server1.pem CAFile: /root/mongodb/keys/mongodb-CA-cert.crt weakCertificateValidation: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> allowInvalidCertificates: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: clusterAuthMode: x509 systemLog: destination: file <span class="hljs-type"><span class="hljs-type">path</span></span>: /root/mongodb/logs/mongos.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br>       (  PEM-)    : <br><br><pre> <code class="bash hljs">mongos --config /root/mongodb/cfg/mongos.conf</code> </pre> <br>     ‚Äì   mongos       root,     - (,   - ‚Äì   ). <br><br><pre> <code class="bash hljs">mongo admin --ssl --sslCAFile /root/mongodb/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb/keys/rootuser.pem --host server1.cluster.com --port 27017</code> </pre> <br>   ‚Äúmongos&gt; ‚Äù     ,   OK. <br><br><pre> <code class="javascript hljs">mongos&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).auth({ <span class="hljs-attr"><span class="hljs-attr">mechanism</span></span>:<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=root,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span> })</code> </pre> <br> (   ‚Äú1‚Äù  ) <br><br>   ‚Äú ‚Äú       root        ,        .           (   )    <b>userAdminAnyDatabase</b> .           . <br><br>           .         <b>analytics</b> ,            . <br><br> ,                   ,    <b>analyticsuser</b> : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout analyticsuser.key -out analyticsuser.csr Generating a 2048 bit RSA private key ......................+++ .........................................+++ writing new private key to 'analyticsuser.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: StatisticsClient Common Name (eg server FQDN or YOUR name) []: analyticsuser Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br>  : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in analyticsuser.csr -out analyticsuser.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=StatisticsClient/CN=analyticsuser Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br>  PEM-: <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat analyticsuser.key analyticsuser.crt &gt; analyticsuser.pem</span></span></code> </pre> <br>   subject   : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -in rootuser.pem -inform PEM -subject -nameopt RFC2253 subject= CN=analyticsuser,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU -----BEGIN CERTIFICATE-----</span></span></code> </pre> <br>    ()          : <br><br><pre> <code class="javascript hljs">mongos&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({<span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=analyticsuser,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"readWrite"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"analytics"</span></span>}] })</code> </pre> <br>      analyticsuser           analytics.      (  )          analytics    . <br><br><h3>  </h3><br>        statistics    ‚Äì   <b>(Shard key)</b>   ,    .             <b>n</b> ,   <b>(Chunks)</b> .                    ,        ,     <b>chunksize</b>      -  <b>64 Mb</b> .          ,          , ..          . <br><br>               .      ,    ( <b>authenticationMechanism</b> ),        ( <b>authenticationDatabase</b> )       ( <b>u</b> ).    (root)  ¬´+‚Äù   : <br><br><pre> <code class="bash hljs">mongo --ssl --sslCAFile /root/mongodb1/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb1/keys/rootuser.pem --host server1.cluster.com --port 27017 --authenticationMechanism <span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span> --authenticationDatabase <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$external</span></span></span><span class="hljs-string">"</span></span> -u ‚ÄúCN=root,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU‚Äù</code> </pre> <br>      config    : <br><br><pre> <code class="javascript hljs">mongos&gt; use config mongos&gt; db.settings.save({<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"chunksize"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: NumberLong(<span class="hljs-number"><span class="hljs-number">32</span></span>)}) WriteResult({ <span class="hljs-string"><span class="hljs-string">"nMatched"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"nUpserted"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"nModified"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> })</code> </pre> <br>        32 Mb.       : <br><br><pre> <code class="javascript hljs">mongos&gt; db.settings.find({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:<span class="hljs-string"><span class="hljs-string">"chunksize"</span></span> }) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"chunksize"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : NumberLong(<span class="hljs-number"><span class="hljs-number">32</span></span>) }</code> </pre> <br>      (   ),         <b>clusterAdmin</b> .     : <br><br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -nodes -newkey rsa:2048 -keyout clusterAdmin.key -out aclusterAdmin.csr Generating a 2048 bit RSA private key ................+++ .......................................+++ writing new private key to 'clusterAdmin.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: RU State or Province Name (full name) [Some-State]: MoscowRegion Locality Name (eg, city) []: Moscow Organization Name (eg, company) [Internet Widgits Pty Ltd]: SomeSystems Organizational Unit Name (eg, section) []: Statistics Common Name (eg server FQDN or YOUR name) []: clusteradmin Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []:</span></span></code> </pre> <br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -CA mongodb-CA-cert.crt -CAkey mongodb-private.key -CAcreateserial -req -days 36500 -in clusterAdmin.csr -out clusterAdmin.crt Signature ok subject=/C=RU/ST=MoscowRegion/L=Moscow/O=SomeSystems/OU=Statistics/CN=clusteradmin Getting CA Private Key Enter pass phrase for mongodb-private.key:</span></span></code> </pre> <br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># cat clusterAdmin.key clusterAdmin.crt &gt; clusterAdmin.pem</span></span></code> </pre> <br><pre> <code class="bash hljs">server1.cluster.com:~/mongodb/keys<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -in clusterAdmin.pem -inform PEM -subject -nameopt RFC2253 subject= CN=clusteradmin,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU -----BEGIN CERTIFICATE-----</span></span></code> </pre> <br>    ,     <b>OU</b>   <b>OU</b>    . <br><br>           root,     ‚Äì  : <br><br><pre> <code class="javascript hljs">mongos&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({ <span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=clusteradmin,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"clusterAdmin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}] })</code> </pre> <br>   mongos    (    ): <br><br><pre> <code class="bash hljs">mongo --ssl --sslCAFile /root/mongodb1/keys/mongodb-CA-cert.crt --sslPEMKeyFile /root/mongodb1/keys/clusterAdmin.pem --host server1.cluster.com --port 27017 --authenticationMechanism <span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span> --authenticationDatabase <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$external</span></span></span><span class="hljs-string">"</span></span> -u ‚ÄúCN=clusteradmin,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU‚Äù</code> </pre> <br>  ,      ,  -: <br><br><pre> <code class="javascript hljs">mongos&gt; sh.addShard(<span class="hljs-string"><span class="hljs-string">"rs0/server1.cluster.com:27000,server2.cluster.com:27000"</span></span>) mongos&gt; sh.addShard(<span class="hljs-string"><span class="hljs-string">"rs1/server1.cluster.com:27001,server2.cluster.com:27001"</span></span>) mongos&gt; sh.addShard(<span class="hljs-string"><span class="hljs-string">"rs2/server1.cluster.com:27002,server2.cluster.com:27002"</span></span>)</code> </pre> <br>       ,      : <br><br><pre> <code class="javascript hljs">mongos&gt; sh.status() --- Sharding Status --- sharding version: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"minCompatibleVersion"</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"currentVersion"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"clusterId"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"5795284cd589624d4e36b7d4"</span></span>) } shards: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs0"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs0/server1.cluster.com:27100,server2.cluster.com:27200"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs1"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs1/server1.cluster.com:27101,server2.cluster.com:27201"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2/server1.cluster.com:27102,server2.cluster.com:27202"</span></span> } active mongoses: <span class="hljs-string"><span class="hljs-string">"3.2.8"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> balancer: Currently enabled: yes Currently running: no Failed balancer rounds <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">5</span></span> attempts: <span class="hljs-number"><span class="hljs-number">0</span></span> Migration Results <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the last <span class="hljs-number"><span class="hljs-number">24</span></span> hours: No recent migrations databases:</code> </pre> <br>    ,    ‚Äì  ,                    .       ‚Äúdatabases‚Äù.      ,  -        .     : <br><br><h6>  1.     .     analyitcs: </h6><br><pre> <code class="javascript hljs">mongos&gt; sh.enableSharding(<span class="hljs-string"><span class="hljs-string">"statistics"</span></span>)</code> </pre> <br>  Check the result: <br><br><pre> <code class="javascript hljs">mongos&gt; sh.status() --- Sharding Status --- sharding version: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"minCompatibleVersion"</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"currentVersion"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"clusterId"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"5795284cd589624d4e36b7d4"</span></span>) } shards: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs0"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs0/server1.cluster.com:27000,server2.cluster.com:27000"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs1"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs1/server1.cluster.com:27001,server2.cluster.com:27001"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2/server1.cluster.com:27002,server2.cluster.com:27002"</span></span> } active mongoses: <span class="hljs-string"><span class="hljs-string">"3.2.8"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> balancer: Currently enabled: yes Currently running: no Failed balancer rounds <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">5</span></span> attempts: <span class="hljs-number"><span class="hljs-number">0</span></span> Migration Results <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the last <span class="hljs-number"><span class="hljs-number">24</span></span> hours: No recent migrations databases: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"analytics"</span></span>, <span class="hljs-string"><span class="hljs-string">"primary"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"partitioned"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br>        analytics,   ,  Primary- (   PRIMARY  )        ‚Äûrs2‚Äú.  ,             Primary- (rs2). <br><br><h6>  2.    . </h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As mentioned earlier, for partitioning the entire set of documents of the chardable collection into chunks, the monge needs a key index ‚Äî the sharding key. His choice is a very responsible task, which must be approached wisely, guided by the requirements of your implementation and common sense. The index by which the collection will be divided into chunks is selected from existing indices, or it is intentionally added to the collection. Anyway, at the time of sharding, the key-corresponding index must exist in the collection. The sharding key does not impose special restrictions on the corresponding index. If necessary, it can be made composite, for example, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{‚Äús‚Äù: 1, ‚Äúts‚Äù: -1}</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br>   ,              statistics    analytics.          statistics,    ‚Äì  <b>s</b> .          ,     : <br><br><pre> <code class="javascript hljs">mongos&gt; use analytics mongos&gt; db.statistics.ensureIndex({<span class="hljs-string"><span class="hljs-string">"s"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br>        : <br><br><pre> <code class="javascript hljs">mongos&gt; sh.shardCollection(<span class="hljs-string"><span class="hljs-string">"analytics.statistics"</span></span>, {<span class="hljs-string"><span class="hljs-string">"s"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br>             .     ,      (        ),      PRIMARY-,      ()     .        .      3       . <br><br>   ,     sh.status()  ,  : <br><br><pre> <code class="javascript hljs">mongos&gt; sh.status() --- Sharding Status --- sharding version: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"minCompatibleVersion"</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"currentVersion"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"clusterId"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"5773899ee3456024f8ef4895"</span></span>) } shards: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs0"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs0/server1.cluster.com:27000,server2.cluster.com:27000"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs1"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs1/server1.cluster.com:27001,server2.cluster.com:27001"</span></span> } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2/server1.cluster.com:27002,server2.cluster.com:27002"</span></span> } active mongoses: <span class="hljs-string"><span class="hljs-string">"3.2.8"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> balancer: Currently enabled: yes Currently running: yes Balancer lock taken at Sun Jul <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> GMT+<span class="hljs-number"><span class="hljs-number">0000</span></span> (UTC) by MongoDB:<span class="hljs-number"><span class="hljs-number">27017</span></span>:<span class="hljs-number"><span class="hljs-number">1468508127</span></span>:<span class="hljs-number"><span class="hljs-number">-1574651753</span></span>:Balancer Collections <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> active migrations: statistic.statistic started at Sun Jul <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> GMT+<span class="hljs-number"><span class="hljs-number">0000</span></span> (UTC) Failed balancer rounds <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">5</span></span> attempts: <span class="hljs-number"><span class="hljs-number">0</span></span> Migration Results <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the last <span class="hljs-number"><span class="hljs-number">24</span></span> hours: <span class="hljs-number"><span class="hljs-number">3</span></span> : Success <span class="hljs-number"><span class="hljs-number">2</span></span> : Failed <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> error <span class="hljs-string"><span class="hljs-string">'aborted'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rs2 to rs0 databases: { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"analytics"</span></span>, <span class="hljs-string"><span class="hljs-string">"primary"</span></span> : <span class="hljs-string"><span class="hljs-string">"rs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"partitioned"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> } analytics.statistics shard key: { <span class="hljs-string"><span class="hljs-string">"s"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } unique: <span class="hljs-literal"><span class="hljs-literal">false</span></span> balancing: <span class="hljs-literal"><span class="hljs-literal">true</span></span> chunks: rs0 <span class="hljs-number"><span class="hljs-number">1</span></span> rs1 <span class="hljs-number"><span class="hljs-number">2</span></span> rs2 <span class="hljs-number"><span class="hljs-number">21</span></span> too many chunks to print, use verbose <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you want to force print</code> </pre> <br>   analytics         statistics        shard key.                  ,        .    balancer        ,      . <br><br><h3> Supervisor </h3><br>     MongoDB Community      mongodb  ‚Äú‚Äù  .    -   MongoDB. <br><br>        : /etc/init.d/mongod.     ,         mongod    mongos    server1.cluster.com  server2.cluster.com. <br><br>          /etc/init.d/mongod,            supervisor. <br><br> Supervisor               mongo{d/s}' : <br><br><pre> <code class="bash hljs">supervisorctl start all supervisorctl stop all</code> </pre> <br> (           ‚Äî    ). <br>   supervisor      linux   ,    (Debian 8)   : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install supervisor</span></span></code> </pre> <br>                 ,      . <br><br>    mongod   rs0: <br><br><pre> <code class="hljs cpp"># # /etc/supervisor/conf.d/mongod-rs0.conf # [program:mongod-rs0] command=mongod --config /root/mongodb/cfg/rs0.conf user=root stdout_logfile=/root/mongodb/logs/supervisor/mongod-rs0-<span class="hljs-built_in"><span class="hljs-built_in">stdout</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> redirect_stderr=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stopwaitsecs=<span class="hljs-number"><span class="hljs-number">60</span></span></code> </pre> <br>       ,       .  <b>command</b>   ,     ‚Äì mongod   .         .  <b>stdout_logfile</b> ‚Äì          supervisor.     -   ,   ,     . <br><br> <b>redirect_stderr</b>              .     <b>autostart</b>  <b>autorestart</b>         . <br><br>      <b>stopwaitsecs</b>          . -       TERM,   10 .            KILL,             .        . <br><br>         ,     linux ‚Äì  <i>/etc/supervisor/conf.d/</i> . <br><br>         : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># supervisorctl reload</span></span></code> </pre> <br><br> ,         : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># supervisorctl stop mongod-rs0 # supervisorctl start mongod-rs0 # supervisorctl status mongod-rs0</span></span></code> </pre> <br>     supervisor       mongodb,     27017, (   )     mongos.       /etc/init.d/mongod. <br><br><h3>  Useful information </h3><br><h5>      </h5><br>            3M           ( sh.shardCollection() ),  .          100M  .     sh.shardCollection()       ‚Äútimeout‚Äù.        : <br><br> <b> 1.</b>      ; <br> <b> 2.</b>           ‚Äú‚Äù , : <br><br><pre> <code class="bash hljs">mongoexport --db analytics --collection statistics --out statistics.json</code> </pre> <br> <b> 3.</b>    ‚Äú‚Äù : <br><br><pre> <code class="javascript hljs">&gt; use analytics &gt; db.statistics.drop()</code> </pre> <br> <b> 4.</b>   ‚Äú‚Äù      ,    : <br><br><pre> <code class="javascript hljs">&gt; db.analytics.ensureIndex({<span class="hljs-string"><span class="hljs-string">"s"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br> <b> 5.</b>       : <br><br><pre> <code class="javascript hljs">&gt; sh.shardCollection(<span class="hljs-string"><span class="hljs-string">"analytics.statistics"</span></span>, {<span class="hljs-string"><span class="hljs-string">"s"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br> <b> 6.</b>     : <br><br><pre> <code class="bash hljs">mongoimport --db analytics --collection statistics --file statistics.json</code> </pre> <br>     ,   ,  /     json   . <br><br><h5>      </h5><br>          ,  ,       (        ),  SECONDARY-        .            <a href="https://docs.mongodb.com/manual/tutorial/backup-sharded-cluster-with-database-dumps/"></a> . <br><br>       ,       .        . <br><br>    <b>analytics</b>       mongodump      MongoDB Community. <br><br>  MongoDB     backup,         .               x.509 .        ,     ,  ,       subject: <br><br><pre> <code class="bash hljs">CN=backuper,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU</code> </pre> <br>        backuper  built-in  backup: <br><br><pre> <code class="javascript hljs">mongos&gt; db.getSiblingDB(<span class="hljs-string"><span class="hljs-string">"$external"</span></span>).runCommand({ <span class="hljs-attr"><span class="hljs-attr">createUser</span></span>: <span class="hljs-string"><span class="hljs-string">"CN=backuper,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">roles</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-string"><span class="hljs-string">"backup"</span></span>, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}] })</code> </pre> <br>           analytics.     <b>mongodump</b>    ,      ( <b>--db</b> ),     ( <b>-o</b> ),    <b>--gzip</b> ,      : <br><br><pre> <code class="bash hljs">mongodump --ssl --sslCAFile ‚Äú/root/mongodb/keys/mongodb-CA-cert.crt‚Äù --sslPEMKeyFile ‚Äú/root/mongodb/keys/backuper.pem‚Äù -u <span class="hljs-string"><span class="hljs-string">"CN=backuper,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span> --host server1.cluster.com --port 27017 --authenticationMechanism <span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span> --authenticationDatabase <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$external</span></span></span><span class="hljs-string">"</span></span> --db analytics --gzip -o <span class="hljs-string"><span class="hljs-string">"/path/to/backup/"</span></span></code> </pre> <br><h3>   ... </h3><br>         ,      .              ++  Python,        . <br><br> ,     C++.         MongoDB <i>mongodb-cxx-driver-legacy-1.1.1</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;mongo/client/dbclient.h&gt; #include &lt;mongo/client/options.h&gt; ... mongo::DBClientConnection client(true); //   try { //    SSL  mongo::client::Options options; options.setSSLMode(mongo::client::Options::SSLModes::kSSLRequired); options.setSSLCAFile("/path_to_certs/mongodb-CA-cert.crt"); options.setSSLPEMKeyFile("/path_to_certs/analyticsuser.PEM"); mongo::Status status = mongo::client::initialize(options); mongo::massertStatusOK(status); // ,     client.connect("www.server1.cluster.com:27017"); //        mongos //  : , ,  mongo::BSONObjBuilder auth_params; auth_params.append("db", "$external"); auth_params.append("user", "CN=username,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"); auth_params.append("mechanism", "MONGODB-X509"); client.auth(auth_params.obj()); //   } catch (const mongo::DBException &amp;e) { std::cout &lt;&lt; "DBException : " &lt;&lt; e.toString() &lt;&lt; std::endl; } ...</span></span></span></span></code> </pre> <br>         ,    ,  <b>mongo::client::Options</b> ,    SSL <b>(kSSLRequired)</b> ,   CA <b>(mongodb-CA-cert.crt)</b> ,  PEM-     (   ‚Äî  analyticsuser,    ). <br><br>            .           ‚Äì ‚Äú$external‚Äù,     subject   ,     .  ,      ..  ,   ‚Äì    . <br><br>  - ,   Python   pymongo  ,        mongoengine. <br><br>     pymongo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ssl db_hosts=<span class="hljs-string"><span class="hljs-string">"server1.cluster.com:27017,server2.cluster.com:27017"</span></span> db_port=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span> client = MongoClient(db_hosts, db_port, read_preference=ReadPreference.NEAREST, ssl=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, ssl_certfile=<span class="hljs-string"><span class="hljs-string">"/path_to_certs/analyticsuser.PEM"</span></span>, ssl_cert_reqs=ssl.CERT_REQUIRED, ssl_ca_certs=<span class="hljs-string"><span class="hljs-string">"/path_to_certs/mongodb-CA-cert.crt"</span></span>) db = client[db_name] db.authenticate(name=db_user, source=<span class="hljs-string"><span class="hljs-string">"$external"</span></span>, mechanism=<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>)</code> </pre> <br>    ‚Äî     CA    PEM-.     db_hosts ‚Äì                .   (db_port),      ,     .  pymongo,        ,         .  ,             , ..     <i>server1.cluster.com:27017</i> . <br><br>      pymogo,  ,       pytmogo.errors.AutoReconnect.        ,   , ,      API-   : <br><br> from functools import wraps <br> from pymongo.errors import AutoReconnect <br>  import time <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pymongo_reconnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(attempts=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decorator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f)</span></span></span><span class="hljs-function">:</span></span> @wraps(f) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decorated_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> tries_reconnect = attempts <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tries_reconnect &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: tries_reconnect = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tries_reconnect: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f(*args, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> AutoReconnect <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ar: tries_reconnect -= <span class="hljs-number"><span class="hljs-number">1</span></span> print(<span class="hljs-string"><span class="hljs-string">"Caught AutoReconnect exception."</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tries_reconnect &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ar time.sleep(<span class="hljs-number"><span class="hljs-number">0.1</span></span>) print(<span class="hljs-string"><span class="hljs-string">"Attempt to reconnect (%d more)...\n"</span></span> % tries_reconnect) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decorated_function <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decorator</code> </pre> <br>        (   5)      . <br><br>        read_preference   . read_preference            (      PRIMARY,  ).    : <br><br> PRIMARY ‚Äî     primary-  ; PRIMARY_PREFERRED ‚Äî   primary-  ,       secondary; <br> SECONDARY ‚Äî    secondary-c ; <br> SECONDARY_PREFERRED ‚Äî     secondary ,     primary; <br> NEAREST ‚Äî     (    pymongo),  <a href="https://docs.mongodb.com/manual/reference/read-preference/"></a>    ,        ,        ‚Äî  ,      primary  secondary. <br><br>            PRIMARY-     ,         / , ..  SECONDARY-         PRIMARY (      ).               . <br><br>   ,       PRIMARY  SECONDARY pymongo    OperationFailure,         . <br><br>   mongoengine    .             mongoengine: <br><br><pre> <code class="python hljs">connect(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, host, port)</code> </pre> <br> OK,  : ‚Äú    mongoengine.connect       pymongo     ‚Äù.         mongoengine.connect       ‚Äî             : mongoengine.register_connection.                   MONGODB-X509.       ,   ‚Äû‚Äú    ,    ,      ,    ‚Äú‚Äù    mogoengine    pymongo (     mongoengine). <br><br> ,   github       <a href="https://github.com/MongoEngine/mongoengine/pull/905"></a> ,    ,       <a href="https://github.com/zeezdev/mongoengine"></a>    . <br><br>     x.509    : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ssl <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mongoengine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DEFAULT_CONNECTION_NAME, register_connection db_hosts=<span class="hljs-string"><span class="hljs-string">"server1.cluster.com:27017,server2.cluster.com:27017"</span></span> db_port=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span> ssl_config = { <span class="hljs-string"><span class="hljs-string">'ssl'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'ssl_certfile'</span></span>: <span class="hljs-string"><span class="hljs-string">"/path_to_certs/analyticsuser.PEM"</span></span>, <span class="hljs-string"><span class="hljs-string">'ssl_cert_reqs'</span></span>: ssl.CERT_REQUIRED, <span class="hljs-string"><span class="hljs-string">'ssl_ca_certs'</span></span>: <span class="hljs-string"><span class="hljs-string">"/path_to_certs/mongodb-CA-cert.crt"</span></span>, } register_connection(alias=DEFAULT_CONNECTION_NAME, name=<span class="hljs-string"><span class="hljs-string">"statistic"</span></span>, host=db_hosts, port=db_port, username=<span class="hljs-string"><span class="hljs-string">"CN=username,OU=StatisticsClient,O=SomeSystems,L=Moscow,ST=MoscowRegion,C=RU"</span></span>, password=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, read_preference=ReadPreference.NEAREST, authentication_source=<span class="hljs-string"><span class="hljs-string">"$external"</span></span>, authentication_mechanism=<span class="hljs-string"><span class="hljs-string">"MONGODB-X509"</span></span>, **ssl_config)</code> </pre> <br>            MongoEngine, ..   <a href="https://travis-ci.org/MongoEngine/mongoengine/builds/148585046"></a>    python/pymongo.   -          ,        ‚Äú‚Äù  . <br><br>      ,    ,     x.509     MongoEngine. <br><br>  <b>Update</b> <br>          mongoengine. </div><p>Source: <a href="https://habr.com/ru/post/308740/">https://habr.com/ru/post/308740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308728/index.html">‚ÄúMy life through the prism of technology ...‚Äù - Stephen Wolfram</a></li>
<li><a href="../308730/index.html">Digital Help: 14 useful business bots for Telegram</a></li>
<li><a href="../308732/index.html">Why shadow copies do not save most encryptors</a></li>
<li><a href="../308734/index.html">Rewriting Clojure test scripts in 24 hours</a></li>
<li><a href="../308738/index.html">Why do banks, regulators and payment systems have their own cryptocurrency</a></li>
<li><a href="../308742/index.html">Scalable solutions for EMV and mobile NFC payments in closed networks</a></li>
<li><a href="../308746/index.html">SWEET32 attack: Researchers have discovered a new way to crack the 3DES and Blowfish ciphers</a></li>
<li><a href="../308748/index.html">Published program Droidcon Moscow 2016</a></li>
<li><a href="../308750/index.html">Visual monitoring of the server infrastructure based on Nagios + Grafana</a></li>
<li><a href="../308752/index.html">Computer Science for Postgres Indexes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>