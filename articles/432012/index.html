<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to test smart contracts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The terms of a smart contract cannot be changed. Therefore, whenever you create a smart contract, you need to make sure that it works correctly. Testi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to test smart contracts</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/p5/xq/sj/p5xqsjbx3ydredj41fcohyg6jga.png" alt="image"><br><br>  The terms of a smart contract cannot be changed.  Therefore, whenever you create a smart contract, you need to make sure that it works correctly.  Testing is a safe way to test a contract in different situations.  In this tutorial, you will learn what steps to take to do this. <br><a name="habracut"></a><br>  I will tell: <br><br><ol><li>  How to prepare a test environment. </li><li>  How to write <b>JavaScript</b> tests and execute them in <b>Truffle</b> . </li></ol><br>  The tutorial is designed for beginners who have just begun to delve into the development and testing of smart contracts for Ethereum.  To understand this tutorial, you must have at least a basic level of knowledge of <b>JavaScript</b> and <b>Solidity</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1. How to prepare a test environment </h2><br>  There are many ways to test smart contracts, but <b><a href="https://truffleframework.com/docs/truffle/overview">Truffle</a></b> is the most popular tool for writing tests using <b>JavaScript</b> .  At <b>Truffle,</b> you can write unit tests as well as conduct comprehensive integration testing with real parameters from the production environment. <br><br>  First you need to install the latest version of Node.js from the <a href="https://nodejs.org/en/download/">official site</a> . <br>  Then open the terminal and install <b>Truffle</b> using the following command: <br><br><pre><code class="plaintext hljs">npm install -g truffle</code> </pre> <br>  After installing <b>Truffle</b> , without closing the terminal, create the <b>Funding</b> directory: <br><br><pre> <code class="plaintext hljs">mkdir Funding</code> </pre> <br>  Next, go to the directory with the command: <br><br><pre> <code class="plaintext hljs">cd Funding</code> </pre> <br>  To initialize the directory run the command: <br><br><pre> <code class="plaintext hljs">truffle init</code> </pre> <br>  After executing the command, the following folders and files will be created in the <b>Funding</b> directory: <br><br><img src="https://habrastorage.org/webt/lb/io/8k/lbio8kevpzbkkk45st2cj1xzmvw.png" alt="image"><br><br>  Next we will work with each directory.  For now, let's continue to prepare the test environment. <br><br>  To run the tests will need a Javascript library. <br><br>  <a href="https://mochajs.org/">Mocha</a> is a library that contains common functions for testing, including <b>describe</b> and <b>it</b> . <br><br>  <a href="https://www.chaijs.com/">Chai</a> is a library that supports various functions for checks.  There are different "styles" of checking the results, and Chai gives us this opportunity.  In the tutorial we will use <b>Should</b> . <br><br>  By default, Mocha is included in Truffle, we can use library functions without any problems.  Chai must be installed manually.  To do this, use the terminal and in the root directory of the project, run the command: <br><br><pre> <code class="plaintext hljs">npm install chai</code> </pre> <br>  I also installed the <b>chai-bignumber library</b> to compare numbers with arbitrary precision: <br><br><pre> <code class="plaintext hljs">npm install --save-dev chai-bignumber</code> </pre> <br>  At this test environment is ready.  Now you can start developing a smart contract and tests for it. <br><br><h2>  2. How to write JavaScript tests and execute them in Truffle </h2><br>  To develop tests need a smart contract.  We will develop a contract that allows you to collect donations, set a specific amount to achieve collection and withdraw funds.  If someone donates more, then the difference between the amount that was accumulated and the amount that needs to be collected will be returned to him. <br><br>  Go to the directory <b>Funding -&gt; contracts</b> .  In <b>Funding / contracts</b> we will create a <b>Funding.sol</b> file with the <b>.sol</b> extension - this will be a smart contract for testing. <br><br>  Add the following code to <b>Funding.sol</b> : <br><br><pre> <code class="javascript hljs">pragma solidity <span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>; contract Funding { uint public raised; uint public goal; address public owner; event Donated(uint donation); event Withdrew(uint amount); modifier onlyOwner() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(owner == msg.sender); _; } modifier isFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(isFunded()); _; } modifier notFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(!isFunded()); _; } <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span> (uint _goal) public { owner = msg.sender; goal = _goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFunded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> raised &gt;= goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">donate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payable</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notFinished</span></span></span><span class="hljs-function"> </span></span>{ uint refund; raised += msg.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (raised &gt; goal) { refund = raised - goal; raised -= refund; msg.sender.transfer(refund); } emit Donated(msg.value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withdraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFinished</span></span></span><span class="hljs-function"> </span></span>{ uint amount = address(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).balance; owner.transfer(amount); emit Withdrew(amount); } }</code> </pre><br>  The contract is ready.  We deploy a smart contract through migration. <br><br>  Migrations are <b>JavaScript</b> files that help you deploy contracts on Ethereum.  This is the main way to deploy contracts. <br><br>  Go to the directory <b>Funding -&gt; migrations</b> and create the file <b>2_funding.js</b> , adding the following code to it: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"./Funding.sol"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GOAL = <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">deployer</span></span></span><span class="hljs-function">) </span></span>{ deployer.deploy(Funding, GOAL); };</code> </pre> <br>  To run tests, you need to use the <b>truffle test</b> command.  In the terminal, go to the root directory <b>Funding</b> , which was created during the preparation of the test environment and enter: <br><br><pre> <code class="plaintext hljs">truffle test</code> </pre> <br>  If the following output appears in the terminal, then everything is done correctly: <br><br><img src="https://habrastorage.org/webt/yi/gn/wp/yignwpfhoay4uojgfxixff6twew.png" alt="image"><br><br>  Now let's start writing tests. <br><br><h3>  Owner check </h3><br><br>  Go to the directory <b>Funding -&gt; test</b> and create a file <b>test_funding.js</b> with the extension <b>.js</b> .  This is the file in which the tests will be written. <br><br>  The following code should be added to the <b>test_funding.js</b> file: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai"</span></span>).use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai-bignumber"</span></span>)(web3.BigNumber)).should(); contract(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[account, firstDonator, secondDonator]</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; it(<span class="hljs-string"><span class="hljs-string">"should check the owner is valid"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { fundingContract = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Funding.deployed(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> owner = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.owner.call() owner.should.be.bignumber.equal(account); });</code> </pre><br>  In the test, we verify that the <b>Funding</b> contract stores the address of the owner who has expanded the contract.  In our case, <b>account</b> is the first element of the array.  <b>Truffle</b> allows you to use up to ten addresses, in the tests we need only three addresses. <br><br><h3>  Acceptance of donations and verification of the end of the fundraising </h3><br>  In this section we will check: <br><br><ol><li>  Reception and amount of donations. </li><li>  Reached a certain amount of donations. </li><li>  What happens if you donate more than you need to collect. </li><li>  The total amount of donations. </li><li>  Is it possible to continue fundraising if the necessary amount is collected? </li></ol><br>  We write and analyze the tests: <br><br><pre> <code class="javascript hljs">. . . . . . . . . . . . . . . . . . . . . . const ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> txEvent; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">logs, eventName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> log <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> logs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.event === eventName) { result = log; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bFirstDonator= web3.eth.getBalance(firstDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bFirstDonator.sub(web3.eth.getBalance(firstDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); });</code> </pre><br>  Before analyzing the test, I want to note 2 points: <br><br><ol><li>  To find events (events) and check its arguments, a small <b>findEvent</b> function was written. </li><li>  For the convenience of testing and calculations, the own cost of gas was set (constant GAS_PRICE). </li></ol><br>  Now we analyze the test.  In the test, we checked: <br><br><ul><li>  that we can accept donations by calling the <b>donate ()</b> method; </li><li>  that the amount donated to us is correctly indicated; </li><li>  that the one who donated funds, the balance decreased by the donated amount. </li></ul><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if donation is not completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); isFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); });</code> </pre><br>  In this test, we checked that the fundraising was not over yet. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should not allow to withdraw the fund until the required amount has been collected"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre> <br>  In the test we checked that we could not withdraw funds until the amount we needed was collected. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bSecondDonator= web3.eth.getBalance(secondDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: secondDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bSecondDonator.sub(web3.eth.getBalance(secondDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">15</span></span> * ETHERS); });</code> </pre><br>  The test checked that if you donate a large amount, the <b>donate ()</b> method calculates and returns the funds to the person who donated more than you need.  This amount is equal to the difference between the amount that is accumulated and the amount you want to collect. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if the donation is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); notFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); it(<span class="hljs-string"><span class="hljs-string">"should check if donated amount of money is correct"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> raised = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call(); raised.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); }); it(<span class="hljs-string"><span class="hljs-string">"should not accept donations if the fundraising is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> * ETHERS }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre><br>  In these three tests, we checked: <br><br><ul><li>  that the fundraising is completed; </li><li>  that the donation amount is correct; </li><li>  that no one else can donate since the fundraising is completed. </li></ul><br><h3>  Withdrawal of funds </h3><br>  In the previous section of the tutorial, we collected the amount we need, now we can withdraw it: <br><br><pre> <code class="javascript hljs"> . . . . . . . . . . . . . . . . . . . . . . it(<span class="hljs-string"><span class="hljs-string">"should allow the owner to withdraw the fund"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bAccount = web3.eth.getBalance(account); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> withdraw = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(withdraw.logs, <span class="hljs-string"><span class="hljs-string">"Withdrew"</span></span>); txEvent.args.amount.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = web3.eth.getBalance(account).sub(bAccount); difference.should.be.bignumber.equal(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call() - withdraw.receipt.gasUsed * GAS_PRICE); });</code> </pre><br>  By calling the function <b>withdraw ()</b> , we withdraw the funds of the owner of the smart contract, in our case it is an <b>account</b> .  Then we checked that we really got the amount we needed.  For this, the <b>difference between the</b> balance before and after the withdrawal of funds was recorded in the <b>difference</b> constant.  The result was compared with the amount of donations minus the transaction fee.  As mentioned above, for the convenience of testing and calculations, I set my own price for <b>gas</b> . <br><br>  <b>Let's run the</b> written tests with the <b>truffle test</b> command.  If everything is done correctly, the result should be as follows: <br><br><img src="https://habrastorage.org/webt/3n/jp/jr/3njpjroqs-jqwzfuejzkqu4neuk.png" alt="image"><br><br><h3>  Result </h3><br>  I tried to describe the steps of testing smart contracts in a simple and understandable language: from preparing a test environment to writing the tests themselves. <br><br>  Now you can test any smart contract and make sure that it works correctly. </div><p>Source: <a href="https://habr.com/ru/post/432012/">https://habr.com/ru/post/432012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431998/index.html">We meet Yandex. Phone - now officially</a></li>
<li><a href="../432002/index.html">Microsoft is developing a browser based on Chromium, which will be supplied by default instead of Edge</a></li>
<li><a href="../432004/index.html">Introduction to reactive programming</a></li>
<li><a href="../432006/index.html">The tale of how I was brought to the topic of women's health</a></li>
<li><a href="../432008/index.html">In pursuit of web standards</a></li>
<li><a href="../432014/index.html">Kali Linux for beginners</a></li>
<li><a href="../432016/index.html">How music and drawing taught me how to program</a></li>
<li><a href="../432020/index.html">Chain replication: building efficient KV storage (part 2/2)</a></li>
<li><a href="../432022/index.html">Fork it: 8 projects on Go, in the source code of which it is interesting to dig</a></li>
<li><a href="../432024/index.html">Gradle 5.0 - what's new</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>