<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In the footsteps of Google I / O 2016 - the new Firebase: integration with Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! We continue the series of articles on technology presented at our annual Google I / O event. Today our guest is Alexander Denisov, and he wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In the footsteps of Google I / O 2016 - the new Firebase: integration with Android</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  We continue the series of articles on technology <a href="https://habrahabr.ru/company/google/blog/302482/">presented</a> at our annual Google I / O event.  Today our guest is Alexander Denisov, and he will tell about his acquaintance with the basic capabilities of the updated Firebase. <br><br><img src="https://habrastorage.org/files/853/992/c06/853992c06f2b40eea4d6f99c33f3b789.png"><br><a name="habracut"></a><br><img src="https://habrastorage.org/files/ec0/bfa/ab3/ec0bfaab3d9248acbf755f02efaf55f3.jpg" align="right">  Hi, I am Alexander Denisov, working at Netcracker as Senior Software Developer and heading the GDG of Nizhny Novgorod.  I have been following the technologies that Google is developing for a long time, and this time I just could not get past Firebase.  There are many changes, they are conceptual in themselves, and, finally, they turn Firebase itself into one big service for building a mobile backend. <br><br>  I was very impressed with the presentation, so I decided to personally try to work with new features and share with you how to take the first steps into this amazing world of convenient and fast development for Android. <br><br clear="all"><h2>  Prehistory </h2><br>  The joint history of Google and Firebase began back in 2014, when the entire Firebase team just went to Google and continued to work on their product, gaining access to the cloud capabilities of the Google Cloud Platform and other Google technologies.  At that time, Firebase was, in fact, a set of REST services for managing the cloud-based NoSQL database for storing and synchronizing data between several clients, and the associated authentication and hosting services.  It looked like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ec/ecf/5a4/5ececf5a41c2d79f28d40fdc5d9dfe94.png"></div><br><br>  In 2016, the anniversary, the tenth Google I / O, and the new features of Firebase are presented there.  He grew up, matured and grown up to a set of 15 products intended not only for development, but also to facilitate the promotion and monetization of applications.  These products can be used both individually and in any combination - depending on your needs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c39/ce7/401/c39ce740142ab1e035c064bbac06acaf.png"></div><br><br>  In a good way, each of these products should be dedicated to a separate article, with a lot of example and codes.  But it takes time, so for now we just try to create a small application based on Firebase, get acquainted with some (most interesting, in my opinion) possibilities, and just try to experience the ‚Äútaste‚Äù of the technology ... As an example, I will create a simple chat, message and information about the interlocutors who will be stored in the cloud.  You will not believe how easy it was to develop such things. <br><br><h2>  1. Firebase - first steps </h2><br><h4>  Preparatory work, registration and authorization </h4><br>  Let's create a simple project (let's call it com.google.simplefirebasechat) with empty markup.  A start, now you need to connect it with Firebase.  To do this, go to the main tool for managing Firebase - the <a href="https://console.firebase.google.com/">console</a> and click "Create a new project": <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2e0/437/de8/2e0437de8ccea6f57dcd7f77008b842b.png"></div><br><br>  Since we are going to work with an Android application, we need to select it from the options offered. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f12/0d2/1d8/f120d21d84bbdf90d7ba69af4a40f6d9.png"></div><br><br>  The system will offer us to specify the name of our application and the security key of the SHA1 format <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f4/895/ac1/1f4895ac1609783fa0ac6142a8e7076f.png"></div><br><br><hr><br>  <b>Note:</b> If you forgot your key, open the Windows console (Win + R, CMD, Enter) and extract it from debug.keystore.  To do this, enter the following commands: <br><br><pre><code class="hljs mel">keytool -exportcert -<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> androiddebugkey -keystore %USERPROFILE%/.android/debug.keystore -list -v</code> </pre> <br><br>  <i>And log in with the password from your debug repository, (the default is <b>"android"</b> )</i> <br><hr><br><br>  After you provide all the necessary data, the browser will automatically download the generated Firebase configuration json with the metadata necessary for the work.  The resulting file should be put in the app directory of our application.  Now you need to add a dependency on the corresponding library to the build.gradle of the project level. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">classpath</span></span> <span class="hljs-string"><span class="hljs-string">'com.google.gms:google-services:3.0.0'</span></span></code> </pre> <br><br>  You should also add the following line to the end of build.gradle in the app directory <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">apply</span></span> plugin: <span class="hljs-string"><span class="hljs-string">'com.google.gms.google-services'</span></span></code> </pre> <br><br>  which connects to the Google Services project a plugin necessary for processing configuration JSONa and connecting the main libraries com.google.gms: google-services. <br><br>  Voila!  Firebase is associated with an application that you can try to build! <br><br><h4>  We check the performance of Firebase </h4><br>  The next step is to check that everything is in order, and we really connected.  To do this, we will add a couple of records to the database, and then read them in the application. <br><br>  Open the Firebase console, look for the Database tab, and create a simple JSON in it to store messages.  The console interface easily allows you to do this. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c0/a83/c59/1c0a83c593402dc4eb13594c619df9cc.png"></div><br><br>  Now we will read the entered data, requesting them from our application ... To get access to them and be able to display them in our interface, we will add several corresponding dependencies to build.gradle <br><pre> <code class="java hljs">compile <span class="hljs-string"><span class="hljs-string">'com.google.firebase:firebase-database:9.0.0'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.firebaseui:firebase-ui-database:0.4.0'</span></span> compile <span class="hljs-string"><span class="hljs-string">'de.hdodenhof:circleimageview:1.3.0'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.github.bumptech.glide:glide:3.6.1'</span></span></code> </pre> <br><br>  We will also add a new <a href="">class</a> for the chat message and <a href="">markup</a> to display it.  With the necessary preparations completed, now let's do the display of content obtained from the database. <br>  To do this, we need to create a main activity and place interface elements on it that will help us test the operation of Firebase.  Add a field to enter a message, the Send button, the ProgressBar button at the time of loading data and RecyclerView to display data from the database, and add a couple of lines of code to the class itself. <br><br>  So, what we have: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.google.simplefirechat; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.SharedPreferences; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.preference.PreferenceManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.content.ContextCompat; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v7.app.AppCompatActivity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v7.widget.LinearLayoutManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v7.widget.RecyclerView; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.text.Editable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.text.InputFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.text.TextWatcher; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.View; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.Button; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.EditText; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.ProgressBar; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.TextView; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.android.gms.common.api.GoogleApiClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.firebase.database.DatabaseReference; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.firebase.ui.database.FirebaseRecyclerAdapter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.firebase.database.FirebaseDatabase; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> de.hdodenhof.circleimageview.CircleImageView; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.bumptech.glide.Glide; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DatabaseReference mSimpleFirechatDatabaseReference; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FirebaseRecyclerAdapter&lt;ChatMessage, FirechatMsgViewHolder&gt; mFirebaseAdapter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RecyclerView mMessageRecyclerView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LinearLayoutManager mLinearLayoutManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ProgressBar mProgressBar; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirechatMsgViewHolder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TextView msgTextView; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TextView userTextView; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CircleImageView userImageView; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FirechatMsgViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(v); msgTextView = (TextView) itemView.findViewById(R.id.msgTextView); userTextView = (TextView) itemView.findViewById(R.id.userTextView); userImageView = (CircleImageView) itemView.findViewById(R.id.userImageView); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); mProgressBar = (ProgressBar) findViewById(R.id.progressBar); mMessageRecyclerView = (RecyclerView) findViewById(R.id.messageRecyclerView); mLinearLayoutManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinearLayoutManager(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mLinearLayoutManager.setStackFromEnd(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); mMessageRecyclerView.setLayoutManager(mLinearLayoutManager); mSimpleFirechatDatabaseReference = FirebaseDatabase.getInstance().getReference(); mFirebaseAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FirebaseRecyclerAdapter&lt;ChatMessage, FirechatMsgViewHolder&gt;( ChatMessage.class, R.layout.chat_message, FirechatMsgViewHolder.class, mSimpleFirechatDatabaseReference.child(<span class="hljs-string"><span class="hljs-string">"messages"</span></span>)) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">populateViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FirechatMsgViewHolder viewHolder, ChatMessage friendlyMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position)</span></span></span><span class="hljs-function"> </span></span>{ mProgressBar.setVisibility(ProgressBar.INVISIBLE); viewHolder.msgTextView.setText(friendlyMessage.getText()); viewHolder.userTextView.setText(friendlyMessage.getName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (friendlyMessage.getPhotoUrl() == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { viewHolder.userImageView .setImageDrawable(ContextCompat .getDrawable(MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, R.drawable.ic_account_circle_black_36dp)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Glide.with(MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .load(friendlyMessage.getPhotoUrl()) .into(viewHolder.userImageView); } } }; mFirebaseAdapter.registerAdapterDataObserver(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RecyclerView.AdapterDataObserver() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onItemRangeInserted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> positionStart, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> itemCount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onItemRangeInserted(positionStart, itemCount); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> chatMessageCount = mFirebaseAdapter.getItemCount(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastVisiblePosition = mLinearLayoutManager.findLastCompletelyVisibleItemPosition(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastVisiblePosition == -<span class="hljs-number"><span class="hljs-number">1</span></span> || (positionStart &gt;= (chatMessageCount - <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp;&amp; lastVisiblePosition == (positionStart - <span class="hljs-number"><span class="hljs-number">1</span></span>))) { mMessageRecyclerView.scrollToPosition(positionStart); } } }); mMessageRecyclerView.setLayoutManager(mLinearLayoutManager); mMessageRecyclerView.setAdapter(mFirebaseAdapter); } }</code> </pre> <br><br>  At this stage, we did not add authorization tools to the application, so we‚Äôll just provide the right for unauthorized reading from the database in the Firebase console.  To do this, go to the "Rules" tab and change the settings in this way: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/478/5ee/d4f/4785eed4ffe5702e1dd225af82fd6db6.png"></div><br><br>  Well, it is time to check out what happened.  We start our application and this is what we see: the record from the database appeared as a previously sent message. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/318/b24/b5c/318b24b5c4a551be646e4d771661a7d2.png"></div><br><br>  Now we can check one more thing.  Try adding some more messages to the database.  If everything is done correctly, these messages will be displayed in real time in our chat.  Unfortunately, we cannot answer them from the application, so we end up having fun and proceed to refine the functionality of the application. <br><br><h2>  2. Writing to Firebase </h2><br>  Everything is simple here.  Add the Send button handler to MainActivity: <br><pre> <code class="java hljs">mSendButton = (Button) findViewById(R.id.sendButton); mSendButton.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ ChatMessage friendlyMessage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChatMessage(mMsgEditText.getText().toString(), mUsername, mPhotoUrl); mSimpleFirechatDatabaseReference.child(<span class="hljs-string"><span class="hljs-string">"messages"</span></span>) .push().setValue(friendlyMessage); mMsgEditText.setText(<span class="hljs-string"><span class="hljs-string">""</span></span>); } });</code> </pre> <br><br>  And it's all!  You can run the application again and mess around.  Write the text, click on the Send button, it is displayed in the chat, and the corresponding entry instantly appears in the database, which we can see through the Firebase console.  It remains to add the last necessary feature - user authorization. <br><br><h2>  3. Authorization in Firebase </h2><br>  First of all, we take access to the database from unauthorized users.  We included it only for tests.  Go to the console, in the "Rules" section and set everything up as it was: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c8f/64b/c06/c8f64bc061d66d42f65911141581c0b2.png"></div><br><br>  After that, go to the Auth tab and select the authorization method - in this case, through Google: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e2/ad7/da9/7e2ad7da9d515097491db8ec25d462d8.png"></div><br><br>  Update build.gradle again by adding dependencies on authorization libraries. <br><pre> <code class="java hljs">compile <span class="hljs-string"><span class="hljs-string">'com.google.firebase:firebase-auth:9.0.0'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.google.android.gms:play-services-auth:9.0.0'</span></span></code> </pre> <br><br>  We also need an additional Activity to enter the chat, with the appropriate markup ( <a href="">AuthorizationActivity.class</a> and <a href="">activiti_auth.xm</a> l).  Just do not forget to register it in the manifest.  It would also be nice to have a menu so that we have where to add the option to exit from your account ( <a href="">main_menu.xml</a> ).  Well, as a finishing touch, we will a little fix MainActivity. <br><br><h4>  We connect authorization </h4><br>  First, we need to inherit the Activity from the GoogleApiClient.OnConnectionFailedListener interface, and to implement this interface itself: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConnectionFailed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull ConnectionResult connectionResult)</span></span></span><span class="hljs-function"> </span></span>{ Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Google Play Services error."</span></span>, Toast.LENGTH_SHORT).show(); }</code> </pre><br>  Second, add entities to work with authorization: <br>  this interface: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GoogleApiClient mGoogleApiClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FirebaseAuth mFirebaseAuth; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FirebaseUser mFirechatUser;</code> </pre> <br><br>  And their initialization in onCreate: <br><pre> <code class="java hljs">mGoogleApiClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleApiClient.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .enableAutoManage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-comment"><span class="hljs-comment">/* FragmentActivity */</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-comment"><span class="hljs-comment">/* OnConnectionFailedListener */</span></span>) .addApi(Auth.GOOGLE_SIGN_IN_API) .build(); mFirebaseAuth = FirebaseAuth.getInstance(); mFirechatUser = mFirebaseAuth.getCurrentUser(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mFirechatUser == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { startActivity(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, AuthorizationActivity.class)); finish(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mUsername = mFirechatUser.getDisplayName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mFirechatUser.getPhotoUrl() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mPhotoUrl = mFirechatUser.getPhotoUrl().toString(); } }</code> </pre> <br><br>  Third, add a call from the menu so that the user can log out: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onOptionsItemSelected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MenuItem item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (item.getItemId()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> R.id.sign_out_menu: mFirebaseAuth.signOut(); Auth.GoogleSignInApi.signOut(mGoogleApiClient); mUsername = DEFAULT_NAME; startActivity(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, AuthorizationActivity.class)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onOptionsItemSelected(item); } }</code> </pre> <br><br>  Now you can run and test the application with authorization via Google account. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d6/d87/613/3d6d8761332f3f6263c3470704296ac2.gif"></div><br><div class="spoiler">  <b class="spoiler_title">Messages should have the following form:</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/65a/5ec/935/65a5ec935624f695ab53fc932d9ff68d.png"><br></div></div><br><br>  And in the Firebase console, in the Auth tab, you can see the users who have been authorized in our application: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f8a/280/912/f8a280912fbef01ee6b9aafd01b39e36.png"></div><br><br>  So, we have a simple application, the backend of which is completely made on Firebase.  These features were available before, now we just got acquainted with the tools of Firebase, now let's move on to more interesting things. <br><br><h2>  4. Notifications using Firebase Notifications </h2><br>  Firebase Notifications allows you to send notifications to user devices directly from the Firebase console.  Moreover, you can choose to send to all users, to a specific group (integration into the Firebase Audience tool also works here) or to users of specific devices in general.  But to work with these notifications, you need to teach the application to accept them, and for this you need to configure the appropriate service. <br><br><h4>  We connect Firebase Notifications </h4><br>  First, add the appropriate ... (build, command, whatever) to build.gradle <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">compile</span></span> <span class="hljs-string"><span class="hljs-string">'com.google.firebase:firebase-messaging:9.0.0'</span></span></code> </pre> <br><br>  Next, create a <i><a href="">SimpleFirechatMessagingService</a></i> service that we will use to manage incoming FCM messages (Firebase Clouds Messages).  It is enough for us to override the onMessageReceived method (RemoteMessage remoteMessage) in order to somehow handle the incoming notification. <br><br>  We also need to create the <i><a href="">SimpleFirechatInstanceIdService</a></i> service to manage FCM logic.  It is usually used to notify the application that a new token has been generated, as well as to receive this token.  Just override the onTokenRefresh () method <br><br>  All that is left for us is to register the services in the manifest, after which everything should work. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".SimpleFirechatMessagingService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.firebase.MESSAGING_EVENT"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".SimpleFirechatInstanceIdService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.firebase.INSTANCE_ID_EVENT"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h4>  We test notifications </h4><br>  Run the application, then go to the Firebase console, in the Notifications tab, and send a long-awaited message.  The result will instantly be displayed on the smartphone display or in the emulator: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c18/11b/439/c1811b439659eef92f9f1e8519fcb1d5.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73e/e3f/138/73ee3f138d45276126c96220b296218d.png"></div><br><br>  You can get acquainted with the results of sending notifications in the corresponding section of the Firebase console. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98b/aac/1a2/98baac1a285747d0c176c3910ae97898.png"></div><br><br><h2>  5. Firebase Remote Config - change application on the fly </h2><br>  Firebase Remote Config allows you to set a number of parameters in applications that you can update remotely from the server.  Thus, you can take your app's capabilities (design, for example, or translation) without updating the whole .apk and not waiting for it to be uploaded to the app store, and then also updated by the user on the device.  As an example, let's try to change the message on the message sending button using this feature. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9bb/0a4/4b8/9bb0a44b84c2957db134e45a7fd6c89a.png"></div><br><br><h4>  Add functionality </h4><br>  To get started, go to the Remote Config tab and create a variable button_name <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ea/637/dd7/1ea637dd706371600f94d48de0bcd95c.png"></div><br><br>  Now you need to configure the application. <br>  As in previous times, we start again by adding the corresponding dependency to build.gradle <br><pre> <code class="java hljs">compile <span class="hljs-string"><span class="hljs-string">'com.google.firebase:firebase-messaging:9.0.0'</span></span></code> </pre><br>  ... and add the fetchconfig method, in which we will retrieve the configuration from the server and apply it to the button name. <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> cacheExpiration = <span class="hljs-number"><span class="hljs-number">3600</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 hour in seconds // If developer mode is enabled reduce cacheExpiration to 0 so that // each fetch goes to the server. This should not be used in release // builds. if (mFirebaseRemoteConfig.getInfo().getConfigSettings() .isDeveloperModeEnabled()) { cacheExpiration = 0; } mFirebaseRemoteConfig.fetch(cacheExpiration) .addOnSuccessListener(new OnSuccessListener&lt;Void&gt;() { @Override public void onSuccess(Void aVoid) { // Make the fetched config available via // FirebaseRemoteConfig get&lt;type&gt; calls. mFirebaseRemoteConfig.activateFetched(); mSendButton.setText(mFirebaseRemoteConfig.getString("button_name")); } }) .addOnFailureListener(new OnFailureListener() { @Override public void onFailure(@NonNull Exception e) { mSendButton.setText(mFirebaseRemoteConfig.getString("button_name")); } }); }</span></span></code> </pre> <br><br>  We will call this method in onCreate and in the menu item created for this.  To do this, add the following lines to main_menu.xml: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/reconfig"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Reconfig"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:showAsAction</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"never"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><br>  OnCreate: <br><pre> <code class="java hljs">mFirebaseRemoteConfig = FirebaseRemoteConfig.getInstance(); FirebaseRemoteConfigSettings firebaseRemoteConfigSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FirebaseRemoteConfigSettings.Builder() .setDeveloperModeEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .build(); Map&lt;String, Object&gt; defaultConfigMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); defaultConfigMap.put(<span class="hljs-string"><span class="hljs-string">"button_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Send"</span></span>);</code> </pre> <br><br>  ... and in onOptionsItemSelected: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> R.id.reconfig: fetchConfig(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;</code> </pre><br><br><h4>  Check the result </h4><br>  The test algorithm is similar to the past.  Run the application, look at the text button, go to the Firebase console, change its value to the variable button_name., And call reconfig from the menu. <br><br>  So just in half an hour we created a chat with authorization, cloud notifications and remote configuration based on the capabilities of Firebase. <br>  PS: download the project and dig yourself into it yourself can be <a href="https://github.com/ShuregDenisovich/simplefirechat/tree/master/SimpleFirechat">here</a> . <br>  I think there is enough practice for today, time to take stock. <br><br><h2>  What we got as a result </h2><br>  <i>To store messages, we used <u>Realtime Database</u> -</i> services for managing the cloud-based NoSQL database.  They allow you to save and synchronize data with all connected devices in a matter of milliseconds.  In the updated version, the data is stored in memory or on the disk of the device so that the application remains operational when the connection to the network is lost, and, of course, the data is synchronized after the connection is restored. <br><br>  <i>For authorization, we used the <u>Authentication</u> service ‚Äî a</i> service for authenticating and managing users.  Supports authentication via a couple of e-mail and password, social networks (Facebook, Twitter, GitHub, Google+) and can be integrated with other existing authorization systems <br><br>  <i>To test notifications, we used <u>Notifications</u> , a</i> service that provides a new UI, accessible via the built-in console and based on Firebase Cloud Messaging.  He came to replace Google Cloud Messaging technology and send notifications to users without writing a single line of code.  Integration with Firebase Analytics allows you to send notifications to pre-configured user groups <br><br>  <i>Its technology is closely related to the project <u>Cloud Messaging</u> - a</i> service that combines Firebase with the most popular messaging service - Google Cloud Messaging.  Cloud Messaging is cross-platform and works on iOS, Android and web applications. <br><br>  And finally, for remote configuration, we used <i><u>Remote Config</u> , a</i> service that allows you to modify and update parts of applications without resorting to a full package upgrade and passing relatively long checks in application stores.  For security and ease of operation, you will need to think in advance that you want to update remotely and set the appropriate parameters in the video key - value.  Well, then you can make changes to the work and appearance of the application by replacing the values ‚Äã‚Äãof these parameters on the server side.  For example, you can update the design of the application for the holiday, and then return everything "as it was."  And no lengthy reviews.  Like many other elements of Firebase, Notifications are integrated into Firebase Analytics.  That is, you can select groups of different users (formed automatically by dozens and hundreds of parameters) and send updates to them ... <br><br>  In conclusion, I want to say that Firebase has evolved from a data storage service into a <b>universal</b> platform for mobile developers, with a convenient, user-friendly interface and the most simplified integration into applications (as you have seen, you can add it to your application in fact with a couple of clicks).  I think that it would be a big mistake not to pay attention to the output of such a useful and interesting tool.  Try it.  He is really very, very cool ... <br><br>  For today you have enough.  But we will definitely return to this topic and consider the remaining features of the new Firebase: data storage tools, application testing, monetization and advertising services, as well as nice handy buns such as invites or reliable links.  And, of course, the coolest thing ever - the most powerful analytics and grouping of users, which is closely integrated into all other possibilities. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a48/ffc/8ea/a48ffc8eaa875299525c8ed6688d866b.png"></div><br><br>  Thank you all for your attention!  The post turned out to be very big, we are all human, so if you find a typo or mistake - write in the LAN, we will promptly fix it.  And leave questions in the comments.  :) </div><p>Source: <a href="https://habr.com/ru/post/305308/">https://habr.com/ru/post/305308/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305296/index.html">MIPT launched an online magistracy in modern combinatorics</a></li>
<li><a href="../305298/index.html">Pass a technical interview (Level 2)</a></li>
<li><a href="../305300/index.html">Improving user interaction paths through page transitions</a></li>
<li><a href="../305304/index.html">Accidents on server farms</a></li>
<li><a href="../305306/index.html">Making a multi-channel full duplex walkie-talkie</a></li>
<li><a href="../305312/index.html">Review of physics in Sonic games. Parts 5 and 6: the loss of rings and being under water</a></li>
<li><a href="../305314/index.html">It seems that Github is again unavailable in Russia ... and other sites</a></li>
<li><a href="../305316/index.html">Facebook Messenger will receive end-to-end encryption</a></li>
<li><a href="../305318/index.html">Photos from Varlamov. Honest business or misunderstood law</a></li>
<li><a href="../305330/index.html">Writing an adaptive template for Emlog CMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>